# 原子尺度的动态演化：ABACUS 第一性原理分子动力学实战手册

## 前言

欢迎来到《原子尺度的动态演化：ABACUS 第一性原理分子动力学实战手册》。

在材料科学与凝聚态物理的研究中，静态的基态电子结构计算（Static Calculation）仅仅是揭开微观世界面纱的第一步。然而，真实世界的物质往往处于特定的温度和压力之下，经历着扩散、相变、化学反应等动态过程。分子动力学（Molecular Dynamics, MD）正是捕捉这些瞬态现象、连接微观原子运动与宏观热力学性质的桥梁。

**为什么选择 ABACUS 进行动力学模拟？**
ABACUS（原子算筹）不仅在第一性原理计算（DFT）领域表现出色，其分子动力学模块也具备极高的灵活性。它支持从标准的从头算分子动力学（AIMD/FPMD）到经典的 Lennard-Jones 势能模拟，更重要的是，它深度集成了机器学习势能（Deep Potential），通过与 DeePMD-kit 的联动，能够实现接近 AIMD 精度且具备经典 MD 效率的跨尺度模拟。虽然 AIMD 计算成本高昂，但 ABACUS 提供的多种热库算法与数值优化手段，为用户在精度与效率之间找到了极佳的平衡点。

**学习路线图**
本书旨在引导读者完成从“静态”到“动态”的思维跨越。我们将从第一章的 **AIMD 基础与输入框架** 入手，建立对 MD 参数的直观认知；在第二章通过 **NVE 系综** 学习如何利用能量守恒律检验模拟的物理可靠性；第三章将深入探讨 **NVT 系综** 及其多种热浴算法（如 Langevin、Anderson、Berendsen 等）的实战应用；第四章则针对 **进阶场景**，介绍包括温稠密物质模拟、冲击波压缩（MSST）等复杂物理过程的处理；最后，第五章将回归工程实践，讲解 **数据管理与断点续算**，确保您的计算资源得到最高效的利用。

**知识坐标与前置要求**
本教程位于 ABACUS 知识体系的中高级进阶阶段。在开始学习之前，我们假设您已经掌握了：
1.  **DFT 基础知识**：了解自洽场（SCF）计算、平面波或原子轨道基组的概念。
2.  **ABACUS 基本操作**：能够熟练配置 `INPUT`、`STRU` 和 `KPT` 文件进行结构优化。
3.  **统计物理基础**：对系综（Ensemble）、温度与能量的关系有初步理解。

让我们一同进入这个动感十足的微观世界，见证原子如何在算法的驱动下翩翩起舞。

---

# 第一章：AIMD 基础与 ABACUS 输入框架

欢迎进入 ABACUS 分子动力学（AIMD）的世界。

在之前的学习中，你可能已经熟悉了静态计算（Static Calculation），即求解体系在 0K 下的基态电子结构和几何结构优化。然而，真实世界是动态的、有温度的。分子动力学（Molecular Dynamics, MD）正是连接微观原子运动与宏观热力学性质（如扩散系数、粘度、相变温度）的桥梁。

本章的目标非常明确：**帮助你完成从“静态优化”到“动态演化”的思维转换**，并掌握 ABACUS 处理 MD 的核心输入框架。

---

## 1.1 第一性原理分子动力学 (AIMD) 概论

### 1.1.1 物理本质：在势能面上“滑行”
在几何结构优化（Relaxation）中，我们的目标是寻找势能面（PES）的**最低点**（受力为零）。而在分子动力学中，我们的目标是根据牛顿运动方程（$F=ma$），让原子在势能面上**滑行**。

所谓的 **AIMD (Ab Initio Molecular Dynamics)**，其核心特征在于：**原子受到的力 $F$ 是通过实时求解电子结构（通常是 DFT）获得的**。

*   **经典 MD (Force Field)**: 力来源于预先拟合好的经验函数（如弹簧模型）。速度极快，但难以处理化学键断裂、生成以及复杂的电子转移过程。
*   **AIMD (ABACUS)**: 力来源于量子力学计算。精度极高，能描述化学反应，但计算成本昂贵。

### 1.1.2 能量求解器：精度与效率的选择
在 ABACUS 的 `INPUT` 文件中，通过 `calculation` 参数开启 MD 模式，并通过 `esolver_type` 选择力的来源。

```bash
INPUT_parameters
# 开启分子动力学计算
calculation     md

# 选择能量求解器 (Energy Solver)
esolver_type    ksdft   # 默认值。基于 Kohn-Sham DFT
```

ABACUS 支持多种求解器，适应不同场景：

1.  **`ksdft` (Kohn-Sham DFT)**:
    *   **适用场景**: 绝大多数常规 AIMD 任务。
    *   **特点**: 精度标准，但随着原子数 $N$ 增加，计算量呈 $O(N^3)$ 增长。
2.  **`sdft` (Stochastic DFT)**:
    *   **适用场景**: **温稠密物质 (Warm Dense Matter)** 或超大体系高温模拟。
    *   **特点**: 引入随机算法，在高温下比 KS-DFT 更高效。*（注：如果你研究的是极端高温高压体系，请务必关注此选项以降低计算量。）*
3.  **`dp` (Deep Potential)**:
    *   **适用场景**: 使用深度学习势函数进行大规模 MD。
    *   **特点**: 结合了 AIMD 的精度和经典 MD 的速度，但需要预先训练模型（需配合 DeepModeling 相关工具）。
4.  **`lj` (Lennard-Jones)**:
    *   **适用场景**: 仅用于代码测试或教学演示。
    *   **特点**: 极简的经验势，不具备化学精度。

> **⚠️ 核心强调：精度与效率的平衡**
> AIMD 的计算成本极其昂贵。一个静态步可能需要几分钟，而一条有意义的 MD 轨迹通常需要数万步。因此，**不要盲目追求过高的平面波截断能（ecutwfc）或过密的 K 点网格**。在 MD 中，通常使用比静态计算略宽松的收敛标准，以换取可接受的时间成本。

---

## 1.2 结构文件与初始速度

在 MD 模拟中，`STRU` 文件不仅定义了原子的初始位置，还可以定义原子的**初始速度**。

### 1.2.1 `STRU` 文件的格式变化
对于静态计算，我们只关心位置。但在 MD 中，如果你需要通过“断点续算”来延续之前的轨迹，或者需要指定非随机的初始速度，就需要在这个文件中包含速度信息。

`STRU` 文件中原子坐标部分的格式如下：
```text
ATOMIC_POSITIONS
# 格式: 元素名 磁矩 数量
Si 0.0 2
# 格式: x y z move_x move_y move_z [v_x v_y v_z]
Direct
0.00 0.00 0.00 1 1 1 v 0.01 -0.02 0.00
0.25 0.25 0.25 1 1 1 v 0.00  0.03 0.01
```
*   **`v` 关键字**: 紧跟在移动约束（1 1 1）之后，标识后面三个数为速度分量。
*   **单位**: ABACUS 内部单位（通常与 Rydberg/Bohr 相关，具体换算请参考官方文档）。

### 1.2.2 控制参数：`init_vel`
在 `INPUT` 文件中，`init_vel` 参数决定了程序如何处理初始速度：

```bash
INPUT_parameters
# 初始速度控制
init_vel    0    # 默认值。自动生成随机速度。
                 # 0: 根据设定的温度（md_tfirst）生成麦克斯韦-玻尔兹曼分布的随机速度。
                 # 1: 从 STRU 文件中读取速度。通常用于续算（Restart）。
```

> **实战技巧**: 第一次运行 MD 时，通常设置 `init_vel 0` 并指定初始温度。当任务因时间限制中断后，需要将最后一步的 `STRU`（包含速度）复制为新的输入，并设置 `init_vel 1` 继续运行。

---

## 1.3 关键的时间参数

MD 的本质是对时间进行积分。理解“时间步长”是避免模拟失败的关键。

### 1.3.1 时间步长 (`md_dt`)
`md_dt` 定义了模拟中每一步的时间跨度，单位为 **飞秒 (fs)**。

```bash
INPUT_parameters
md_dt       1.0   # 时间步长，单位 fs
```

*   **物理意义**: 必须足够短，以捕捉原子最高频的振动（通常是 X-H 键的伸缩振动）。
*   **选择策略**:
    *   **含氢体系**: 推荐 **0.5 fs**。氢原子质量小、振动快，步长过大会导致积分误差，甚至原子“飞出”体系。
    *   **不含氢体系**: 通常 **1.0 - 2.0 fs**。
    *   **重原子体系**: 可适当增大，但需谨慎。
*   **风险提示**: 如果 `md_dt` 设置过大，体系能量会发生剧烈漂移（Energy Drift），甚至导致 SCF 不收敛或几何结构崩塌（“炸裂”）。

### 1.3.2 模拟时长 (`md_nstep`)
`md_nstep` 定义了总共跑多少步。

```bash
INPUT_parameters
md_nstep    1000  # 总步数
```

*   **总物理时间** = `md_dt` $\times$ `md_nstep`。
*   例如：`md_dt 1.0` 且 `md_nstep 1000` $\rightarrow$ 总时长 1000 fs = 1 ps。

---

## 1.4 系综与热力学控制 (风险提示)

在 MD 中，我们必须定义体系与环境的交换关系，即**系综 (Ensemble)**。这通过 `md_type` 参数控制。

### 1.4.1 常见系综
*   **NVE (微正则系综)**: 粒子数、体积、能量守恒。通常用于测试能量守恒性。
    *   设置: `md_type nve`
*   **NVT (正则系综)**: 粒子数、体积、**温度**恒定。最常用的 AIMD 系综。
    *   设置: `md_type nvt`
*   **NPT (等温等压系综)**: 粒子数、**压强**、温度恒定。用于相变或密度计算。
    *   设置: `md_type npt`

### 1.4.2 关键缺失参数警示
要实现 NVT 或 NPT，必须引入热浴（Thermostat）或压浴（Barostat）算法。

> **⚠️ 风险提示：请查阅官方手册**
> 
> 1.  **热浴算法**: 仅仅设置 `md_type nvt` 是不够的，你还需要选择具体的热浴算法（如 Anderson, Langevin, Nose-Hoover 等）并设置相应的阻尼参数。**当前资料库未包含这些具体参数的配置方法，请务必查阅 ABACUS 官方在线文档中关于 `md_thermostat` 及相关参数的说明。**
> 2.  **压强控制**: 对于 NPT 系综，除了温度，还需要设置目标压强。**当前资料库未包含 NPT 压强设置的具体参数（如目标压强值），请务必参考官方手册补充此部分。**

---

## 第一章小结：INPUT 文件模板

一个最基础的 AIMD `INPUT` 文件框架如下：

```bash
INPUT_parameters
# --- 基础计算设置 ---
calculation     md          # 开启 MD
esolver_type    ksdft       # 使用 KS-DFT 求解力
basis_type      pw          # 平面波基组 (示例)

# --- MD 核心参数 ---
md_type         nvt         # 系综选择 (需配合热浴参数，见官方文档)
md_nstep        2000        # 跑 2000 步
md_dt           1.0         # 步长 1.0 fs

# --- 初始状态 ---
init_vel        0           # 随机生成初始速度
md_tfirst       300         # 初始温度 300 K

# --- 输出控制 ---
md_dump_freq    10          # 每 10 步输出一次结构和能量
```

理解了这些参数，你就掌握了让原子“动起来”的钥匙。下一章，我们将深入探讨如何监控 MD 过程中的能量变化与稳定性。

# 第二章：微正则系综 (NVE) —— 能量守恒的试金石

在第一章完成了静态计算的入门后，我们将进入动力学模拟（Molecular Dynamics, MD）的广阔天地。在任何复杂的 MD 模拟（如 NVT 控温或 NPT 控压）之前，**微正则系综（NVE）** 是我们必须跨越的第一道门槛。

NVE 系综代表了一个与外界完全隔离的系统：粒子数（N）、体积（V）和总能量（E）保持恒定。因为它不依赖任何人为的热浴或压浴算法，NVE 是检验**时间步长（Time Step）设置是否合理**以及**电子步（SCF）收敛精度是否足够**的“试金石”。

> **核心观点**：如果你的系统在 NVE 下无法保持能量守恒（即出现显著的能量漂移），那么在 NVT 或 NPT 下的结果也是不可信的——热浴仅仅是掩盖了数值积分的错误，而非修正了它。

---

## 2.1 NVE 参数设置与运行

在 ABACUS 中，开启 NVE 模拟非常直接。我们将以金刚石结构硅（Diamond Si）为例，展示如何配置一个标准的 NVE 探测任务。

### 2.1.1 必备输入文件

除了标准的 `STRU`（结构文件）、`KPT`（K点文件）和赝势/轨道文件外，核心的控制参数位于 `INPUT` 文件中。

#### 示例：`INPUT` 文件配置
```bash
INPUT_PARAMETERS
# 1. 基础计算参数
suffix          md_nve_si
calculation     md           # 开启分子动力学计算
ntype           1
nbands          8

# 2. 电子结构精度 (关键!)
ecutwfc         50           # 平面波截断能 (Ry)，根据赝势调整
scf_thr         1.0e-6       # SCF 收敛阈值 (Ry)，MD 中需严格设置
basis_type      lcao         # 使用数值原子轨道基组 (或 pw)

# 3. MD 核心参数
md_type         nve          # 指定系综为微正则系综
md_dt           1.0          # 时间步长，单位：飞秒 (fs)
md_nstep        100          # MD 总步数

# 4. 输出控制
out_stru        1            # 每步都输出结构文件
```

### 2.1.2 关键参数详解

1.  **`calculation md`**: 告诉 ABACUS 内核，我们不再寻找势能面最小点（Relaxation），而是要根据牛顿运动定律演化原子位置。
2.  **`md_type nve`**:
    *   **物理含义**: 系统按照 Velocity Verlet 算法进行演化。
    *   **注意**: 此模式下没有恒温器（Thermostat）。系统的瞬时温度 $T(t)$ 会随着势能与动能的相互转化而剧烈波动，这是正常的物理现象，但**总能量**（动能+势能）应保持守恒。
    *   **特别提示**: 若需使用 NVT 系综（如 Anderson 或 Langevin 热浴），`md_type` 需设置为 `nvt`，但具体的控温参数（如阻尼系数等）请务必查阅 [ABACUS 在线文档](https://abacus.deepmodeling.com/en/latest/)，不同版本的参数名可能有所变化。
3.  **`md_dt` (时间步长)**:
    *   **单位**: 飞秒 (fs)。
    *   **策略**: AIMD（从头算分子动力学）极其昂贵。步长过小（如 0.1 fs）会浪费计算资源；步长过大（如 5.0 fs）会导致积分误差，破坏能量守恒，甚至导致系统“炸裂”。对于硅等共价体系，**1.0 fs** 通常是一个安全的起点；对于含有轻元素（如 H）的体系，可能需要降至 **0.5 fs**。
4.  **`md_nstep`**:
    *   建议在正式跑长轨迹（如 10 ps 以上）之前，先设置较小的步数（如 50-100 步）进行测试，确认守恒性后再延长。

---

## 2.2 守恒性分析与参数调优

运行结束后，我们的首要任务不是看结构跑到了哪里，而是检查**能量守恒性**。

### 2.2.1 检查能量漂移 (Energy Drift)

ABACUS 的标准输出文件（或 `running_md.log`）中会记录每一步的热力学量。重点关注 `Total Energy` 一列。

*   **理想情况**: 总能量应在一条水平线附近微小波动，无明显的上升或下降趋势。
*   **漂移量化**: 通常要求能量漂移率小于 $10^{-4} \sim 10^{-5}$ eV/atom/ps。如果发现总能量像下坡一样持续降低，或者像火箭一样持续上升，说明模拟参数设置有问题。

### 2.2.2 精度与效率的平衡：`scf_thr` 的影响

在 AIMD 中，原子核在 Born-Oppenheimer 势能面上运动。如果电子步（SCF）没有收敛到足够的精度，计算出的原子力（Hellmann-Feynman 力）就会包含巨大的噪音。这些噪音累积起来，会表现为系统的非物理加热或冷却。

*   **推荐设置**:
    *   **`scf_thr 1.0e-5` ~ `1.0e-6`**: 适用于大多数标准的 NVE/NVT 模拟。
    *   **`scf_thr 1.0e-4`**: 仅用于极粗糙的预平衡，**严禁**用于生产性数据采样，否则能量守恒性极差。
    *   **`scf_thr 1.0e-8`**: 精度极高，但会显著增加每一步 MD 的耗时。除非是做极高精度的能量传递分析，否则不推荐，性价比低。

### 2.2.3 常见问题排查清单

如果你在 NVE 测试中发现能量守恒很差（Drift 很大）：

1.  **检查 `md_dt`**: 尝试将时间步长减半（例如从 1.0 fs 降为 0.5 fs）。如果漂移显著改善，说明原步长过大。
2.  **检查 `scf_thr`**: 尝试加严收敛标准（例如从 1e-5 降为 1e-7）。
3.  **检查 `ecutwfc`**: 平面波截断能不足也会导致力计算不准，进而影响守恒。

---

## 2.3 进阶场景：温稠密物质与 SDFT

> **Pro Tip**: 当你处理大体系（>500 原子）且温度极高（如数万 K 的温稠密物质）时，传统的 KS-DFT 计算量会随着温度升高而急剧增加（因为需要计算大量的高能激发态能带）。

在这种极端场景下，ABACUS 提供了 **随机密度泛函理论 (Stochastic DFT)** 算法。

*   **启用方式**: 在 `INPUT` 中添加 `esolver_type sdft`。
*   **优势**: 计算复杂度随温度升高而降低，非常适合高温 MD 模拟。
*   **注意**: SDFT 引入了随机噪声，需要配合特定的 Langevin 热浴使用，具体请参考相关文献（如 *Phys. Rev. Lett. 111, 055002*）及 ABACUS 高级使用指南。

---

## 2.4 风险提示：关于 NPT 系综

虽然本章重点是 NVE，但许多用户在测试完 NVE 后会立即转向 NPT（恒温恒压）计算。

> **⚠️ 警告**：
> 目前的 ABACUS 资料库中，关于 NPT 系综的具体压强控制参数（如目标压强值 `md_p_ref` 或类似参数、压浴模量等）未包含在基础教程中。
>
> 在进行 NPT 模拟前，**请务必查阅 ABACUS 官方手册中关于 `md_type npt` 的完整参数列表**，以确保你正确设置了目标压强和恒压器参数。错误的设置可能导致晶胞体积无限膨胀或坍缩。

---

**下一章预告**：
通过 NVE 确认了模拟参数的健壮性后，我们将进入第三章，学习如何使用 **NVT 系综** 模拟真实温度下的材料行为，并讨论如何利用 Python 脚本批量处理 MD 轨迹。

# 第三章：正则系综 (NVT) —— 恒温模拟实战

在绝大多数材料模拟与实际应用场景中，我们关注的体系都处于恒定的温度条件下。无论是研究相变、扩散系数，还是模拟溶液环境，**正则系综 (Canonical Ensemble, NVT)** 都是最核心的模拟手段。

本章将深入讲解如何在 ABACUS 中设置 NVT 模拟，如何根据物理需求选择合适的热浴算法（Thermostat），以及如何在第一性原理分子动力学（AIMD）昂贵的计算成本下平衡精度与效率。

---

## 3.1 NVT 基础与温度初始化

NVT 系综意味着体系的粒子数 (N)、体积 (V) 和温度 (T) 保持恒定。在 AIMD 中，由于原子核遵循牛顿运动定律，体系天然处于 NVE（微正则）系综。为了实现 NVT，我们需要引入“热浴”机制，通过与外界交换能量来控制体系温度。

### 3.1.1 基础参数设置

在 `INPUT` 文件中，启动 NVT 模拟的核心参数如下：

```bash
INPUT_PARAMETERS
# 1. 基础计算类型
calculation     md          # 设置计算类型为分子动力学

# 2. 系综控制
md_type         nvt         # 设置系综为 NVT (恒温恒容)
# 或者使用特定算法的快捷方式，如 md_type langevin

# 3. 温度控制
md_tfirst       300.0       # 初始温度/目标温度，单位 Kelvin
# 注意：在某些热浴算法中，可能需要 md_tlast 来指定升温过程，
# 但在标准 NVT 平衡中，通常 md_tfirst 即为目标温度。

# 4. 时间步长与步数 (核心权衡)
md_dt           1.0         # 时间步长，单位 fs。
                            # 推荐值：0.5 - 1.0 fs (对于含氢体系建议 0.5 fs)
md_nstep        1000        # 总模拟步数
```

### 3.1.2 精度与效率的平衡（专家提示）

**AIMD 计算极其昂贵**。与经典力场 MD 动辄纳秒（ns）级的模拟不同，AIMD 每一步都需要进行电子结构的自洽迭代（SCF）。

*   **时间步长 (`md_dt`)**: 必须足够小以捕捉原子最高频的振动（通常是 C-H 或 O-H 键）。设置过大（如 > 2.0 fs）会导致能量漂移甚至模拟崩溃；设置过小则浪费计算资源。**1.0 fs 是大多数无氢体系的黄金标准**。
*   **模拟时长**: 1000 步（1 ps）通常仅够简单的热化。对于扩散系数或自由能计算，可能需要 5 ps - 50 ps 甚至更长。请务必在正式生产（Production Run）前进行充分的测试。

---

## 3.2 热浴算法详解 (Thermostats)

ABACUS 提供了多种热浴算法来控制温度。选择哪种算法取决于你的模拟目的：是为了快速达到平衡，还是为了采样精确的正则系综分布，亦或是为了研究动力学性质（如扩散）。

在 ABACUS 中，当 `md_type` 设置为 `nvt` 时，通过 **`md_thermostat`** 参数选择具体的热浴算法。

### 3.2.1 常见热浴算法概览

以下是 ABACUS 支持的主要热浴类型（需在 `INPUT` 中设置）：

| `md_thermostat` 参数值 | 算法名称 | 特点与适用场景 |
| :--- | :--- | :--- |
| **`nhc`** | **Nose-Hoover Chain** | **最推荐**。严格遵循正则系综分布。适合生产阶段（Production Run）和热力学性质计算。 |
| **`anderson`** | Anderson | 随机碰撞热浴。采样效率高，但会破坏粒子的运动相关性，**不适合计算扩散系数**。 |
| **`berendsen`** | Berendsen | 弱耦合热浴。效率极高，能快速将温度拉到目标值，但**不能生成严格的正则系综**。仅建议用于预平衡阶段。 |
| **`rescaling`** / **`rescale_v`** | Velocity Rescaling | 直接速度标度。最粗暴的控温方式，强制动能守恒。仅用于极粗略的初始化。 |

### 3.2.2 随机类热浴：Langevin 与 Anderson

这类算法通过引入随机力或随机碰撞来模拟溶剂效应或热浴耦合。

**1. Langevin 热浴**
ABACUS 提供了一个特殊的快捷方式直接调用 Langevin 动力学：
```bash
md_type         langevin    # 直接指定使用 Langevin 动力学进行 NVT 模拟
```
*   **物理意义**: 模拟粒子在粘滞流体中的布朗运动，包含摩擦项和随机力项。
*   **适用场景**: 模拟溶剂环境，或者需要非常快速的温度平衡。
*   **注意**: Langevin 会显著改变体系的动力学性质（如扩散速率），除非摩擦系数非常小。

**2. Anderson 热浴**
```bash
md_type         nvt
md_thermostat   anderson
```
*   **机制**: 粒子以一定概率与虚拟热浴发生“碰撞”，速度被重置为麦克斯韦-玻尔兹曼分布中的随机值。

### 3.2.3 确定性热浴：Nose-Hoover Chain (NHC)

这是 AIMD 中最常用的算法。

```bash
md_type         nvt
md_thermostat   nhc
```
*   **机制**: 在哈密顿量中引入额外的自由度（“热浴变量”）。
*   **优势**: 能够产生严格的正则系综分布，且对动力学性质的干扰相对较小（相比于随机类热浴）。
*   **劣势**: 如果体系初始结构离平衡态太远，NHC 可能会出现剧烈的震荡甚至导致体系崩溃。**建议先用 Berendsen 跑几百步预平衡，再切换到 NHC。**

### 3.2.4 关键控制参数（查阅文档提示）

**风险提示**：不同的热浴算法需要特定的控制参数来调节“耦合强度”（即热浴与体系交换能量的快慢）。
*   例如，Nose-Hoover 需要设置频率或质量；Langevin 需要设置摩擦系数或阻尼时间；Anderson 需要设置碰撞频率。
*   **当前资料库未包含这些具体参数的最新命名（如 `md_damp`, `tau_t` 等）**。
*   **行动指南**: 在撰写 `INPUT` 文件前，请务必访问 [ABACUS 在线文档](https://abacus.deepmodeling.com/en/latest/advanced/input_files/input-main.html#md-thermostat) 确认当前版本对应的控制参数名。设置不当（如耦合过强）会导致非物理的模拟结果。

---

## 3.3 高级实战技巧

### 3.3.1 温稠密物质与 SDFT
如果你正在模拟高温高压体系（如行星内部、温稠密物质），电子温度极高，传统的 KS-DFT 计算量会急剧增加。
此时，建议在 `INPUT` 中开启随机密度泛函理论（Stochastic DFT）选项：
```bash
esolver_type    sdft    # 启用 SDFT 求解器
```
这可以显著降低高温下大量空带计算带来的成本（参考资料 7）。

### 3.3.2 预平衡策略 (Equilibration Protocol)
一个稳健的 AIMD 模拟流程通常如下：
1.  **几何优化 (`calculation relax`)**: 先把原子结构优化到势能面极小值附近，避免 MD 初始受力过大导致“炸飞”。
2.  **预平衡 (NVT - Berendsen)**: 使用 `md_thermostat berendsen` 运行 500-1000 步，快速将温度稳定在目标值。
3.  **生产运行 (NVT - NHC)**: 切换为 `md_thermostat nhc`，运行 5000+ 步，用于数据采样。

### 3.3.3 关于 NPT 系综的说明
虽然本章聚焦于 NVT，但许多用户需要 NPT（恒温恒压）系综来获取平衡体积。
*   ABACUS 支持 `md_type npt`。
*   **注意**: NPT 模拟除了温度控制外，还涉及压强控制（Barostat）。当前资料库未包含设置目标压强（Target Pressure）的具体参数名。进行 NPT 模拟前，请务必查阅官方手册补充压强耦合相关的参数设置。

---

**下一章预告**：
在掌握了恒温模拟后，我们将进入第四章，探讨如何处理 AIMD 产生的轨迹文件，计算径向分布函数（RDF）与均方位移（MSD），提取真实的物理性质。

# 第四章：进阶应用与特殊场景

在掌握了基础的分子动力学（MD）跑通流程后，我们往往面临更复杂的物理需求：如何模拟材料在相变过程中的体积变化？如何处理温稠密物质（Warm Dense Matter）等极端高温体系？如何模拟冲击波压缩过程？

本章将深入探讨 ABACUS 在这些进阶场景下的解决方案。

> **⚠️ 核心提示：精度与效率的博弈**
> 
> 在进入进阶模拟前，必须再次强调：**AIMD（从头算分子动力学）极其昂贵**。
> *   **时间步长 (`md_dt`)**：过大导致积分发散，过小则浪费算力。通常建议在 0.5 fs ~ 2.0 fs 之间，取决于体系中最轻原子的振动频率。
> *   **总步数 (`md_nstep`)**：需根据物理过程的特征时间尺度设定。
> *   **系综选择**：`md_type` 参数直接决定了物理系综。不同的系综对应不同的守恒量和热浴/压浴算法，请务必根据研究目的谨慎选择。

---

## 4.1 等温等压系综 (NPT)

在 NVT（正则系综）中，晶格体积是固定的。然而，许多物理过程（如熔化、结晶、固-固相变）伴随着显著的体积或密度变化。如果强制固定体积，会导致体系内部产生非物理的压强。此时，我们需要使用 **NPT 系综**（粒子数 N、压强 P、温度 T 恒定），允许晶胞矢量发生变化以释放内应力。

### 4.1.1 核心参数设置

在 `INPUT` 文件中，启用 NPT 系综的关键是将 `md_type` 设置为 `npt`。

```bash
INPUT_PARAMETERS
# ... (基础自洽参数)

# --- MD Control ---
md_type     npt        # 开启等温等压系综
md_nstep    2000       # 模拟步数
md_dt       1.0        # 时间步长 (fs)
md_tfirst   300        # 初始温度 (K)
md_tlast    300        # 目标温度 (K)

# --- 注意：压强控制参数 ---
# ⚠️ 风险提示：
# NPT 模拟需要指定目标压强（Target Pressure）以及恒压器（Barostat）的耦合参数。
# 由于 ABACUS 版本迭代较快，具体的压强控制关键词（如 md_p_ref, md_p_coupling 等）
# 请务必查阅 ABACUS 官方在线文档的 "Input Keywords" 章节以获取最新准确写法。
```

### 4.1.2 应用场景与注意事项

1.  **密度弛豫**：当你搭建了一个新的非晶或液体模型，初始密度往往是不准确的。通过 NPT 模拟（通常设置 P=0 或 1 atm），可以让体系自动弛豫到平衡密度。
2.  **相变模拟**：在升温或降温过程中，NPT 允许晶胞“呼吸”，从而正确捕捉相变时的体积突变。
3.  **基组平面波截断**：由于晶胞体积在变化，如果使用平面波基组（PW），需要注意截断能（ecutwfc）对应的 G 矢量数量可能会随体积波动。在 ABACUS 的 LCAO 模式下，基组随原子移动，对体积变化的适应性相对较好，但仍需注意基组完备性。

---

## 4.2 高温模拟与 SDFT 加速

当模拟温度升高（例如 T > 10,000 K 的温稠密物质），传统的 KS-DFT 面临巨大挑战：
1.  **电子占据**：根据费米-狄拉克分布，高温导致大量高能级轨道被部分占据。
2.  **计算量爆炸**：为了包含这些部分占据态，必须计算成千上万条能带（Bands），计算量随能带数呈立方增长（$O(N^3)$）。

ABACUS 提供了 **随机 DFT (Stochastic DFT, SDFT)** 方法，利用随机向量迹估计技术，将计算复杂度降低，特别适合高温大体系。

### 4.2.1 SDFT 核心参数

使用 SDFT 需要改变电子求解器类型，并调整能带设置。

```bash
INPUT_PARAMETERS
# ... (基础参数)

# --- Electronic Solver ---
esolver_type    sdft       # 启用随机 DFT 求解器

# --- SDFT Specifics ---
nbands          0          # SDFT 模式下，传统能带数设为 0 或由程序自动接管
nbands_sto      128        # 随机波函数（Stochastic Orbitals）的数量
                           # 该值越大，随机误差越小，但计算量增加
                           
# --- Temperature ---
smearing_method fd         # 必须使用 Fermi-Dirac 展宽
smearing_sigma  0.1        # 电子温度 (Ry)，高温模拟中该值通常较大
```

### 4.2.2 精度与效率的权衡

*   **随机误差**：SDFT 的结果包含统计噪声。`nbands_sto` 类似于蒙特卡洛采样中的样本数。通常需要测试 `nbands_sto` 对总能量或力的收敛性。
*   **适用性**：SDFT 在低温下优势不明显，但在高温（电子分布弥散）时，它能以远少于传统 DFT 所需的能带数获得准确的物理性质（如态密度、径向分布函数）。

---

## 4.3 MSST 方法简介（冲击波模拟）

对于极端的冲击波物理研究，直接进行非平衡分子动力学（NEMD）模拟冲击波传播需要极大的模型尺寸。**多尺度冲击技术 (Multi-Scale Shock Technique, MSST)** 是一种高效的替代方案。

MSST 通过约束 MD 的运动方程，使体系始终演化在 Hugoniot 冲击绝热线上。这意味着你可以用较小的晶胞来模拟冲击波扫过后的状态。

### 4.3.1 启用方式

在 ABACUS 中，MSST 通常作为一种特殊的 MD 类型存在（具体实现依赖于版本）。

```bash
INPUT_PARAMETERS
# ... 
md_type     msst       # (需确认版本支持) 开启 MSST 模拟
# [PARAMETER_MISSING] 
# 触发 MSST 需要设定冲击波速度 (Shock Velocity) 或粒子速度等参数。
# 请在执行前查阅文档中关于 "Shock Compression" 或 "MSST" 的具体参数说明。
```

### 4.3.2 物理意义

MSST 模拟的是冲击波波后流体元素的拉格朗日演化过程。通过调整冲击速度参数，可以计算出材料的 Hugoniot 曲线（压力-密度关系），这对于研究材料在极端高压下的状态方程（EOS）至关重要。

---

**本章总结**：
从 NPT 的体积弛豫，到 SDFT 的高温加速，再到 MSST 的冲击波模拟，ABACUS 提供了丰富的工具箱来应对非标准环境下的材料模拟。使用这些功能时，**务必先进行小体系测试**，确认参数设置（特别是压强控制和随机采样数）符合物理预期后，再投入大规模生产性计算。

# 第五章：数据输出与断点续算

在前面的章节中，我们已经成功配置并运行了分子动力学（MD）任务。然而，第一性原理分子动力学（AIMD）计算极其昂贵——相比于静态的自洽场（SCF）计算，MD 的计算量通常呈千倍甚至万倍增长（取决于模拟步数）。

因此，**如何高效地管理输出数据**以及**如何处理意外中断（断点续算）**，是每一位 ABACUS 用户必须掌握的工程技能。本章将详细讲解如何平衡 I/O 开销与数据采样，以及如何确保宝贵的核时不被浪费。

---

## 5.1 轨迹文件与采样频率

MD 模拟的核心产物是原子随时间演化的轨迹（Trajectory）。ABACUS 主要通过 `md_dumpfreq` 参数控制输出频率。

### 5.1.1 关键参数设置

在 `INPUT` 文件中，以下参数直接决定了输出的数据量和磁盘占用：

```bash
INPUT_PARAMETERS
# ... (其他参数)
md_nstep        10000    # 总模拟步数
md_dt           1.0      # 时间步长 (单位: fs)

# 输出控制
md_dumpfreq     10       # 每隔 10 步输出一次轨迹和能量信息
cal_force       1        # 输出轨迹中包含受力信息 (1=开启)
cal_stress      1        # 输出轨迹中包含应力张量 (1=开启)
```

### 5.1.2 输出文件解析

当任务运行后，ABACUS 会在 `OUT.${suffix}/` 目录下生成以下关键文件：

1.  **MD_dump**:
    *   这是主要的轨迹文件，包含了每隔 `md_dumpfreq` 步的原子坐标、速度、受力（如果 `cal_force=1`）和晶格矢量。
    *   **用途**: 用于后续的可视化（如 OVITO）和后处理分析（如扩散系数、RDF 计算）。
2.  **STRU/ 文件夹**:
    *   路径: `OUT.${suffix}/STRU/`
    *   内容: 包含一系列名为 `STRU_MD_${istep}` 的文件。
    *   **用途**: 这些是标准的 ABACUS 结构文件格式，可直接用于后续的静态计算（如选取某一帧做电子结构分析）或作为断点续算的输入。

### 5.1.3 采样频率的权衡 (Best Practice)

*   **不要每步都输出**: 如果 `md_dumpfreq` 设为 1，不仅会产生巨大的磁盘 I/O 压力，导致计算变慢，生成的 `MD_dump` 文件也会大到难以处理。
*   **物理相关性**: 两次采样之间的时间间隔应小于体系的特征弛豫时间。
    *   通常建议采样间隔为 **10 ~ 100 fs**。
    *   如果 `md_dt = 1 fs`，推荐设置 `md_dumpfreq` 为 10 到 100 之间。

---

## 5.2 断点续算 (Restart)

在高性能计算集群（HPC）上，作业往往有运行时间限制（Walltime），或者可能因硬件故障意外中断。ABACUS 提供了完善的断点续算功能，允许用户从中断处继续计算，而无需从头开始。

### 5.2.1 续算机制

ABACUS 的续算依赖于两个关键要素：
1.  **Restart_md.dat**: 记录了当前 MD 步数、恒温器/恒压器内部状态等信息。
2.  **STRU_MD_${istep}**: 记录了对应步数的原子结构和速度。

### 5.2.2 步骤一：确保生成了重启文件

在**首次运行**（或上一轮运行）的 `INPUT` 文件中，必须设置合理的重启文件写入频率：

```bash
# 首次运行的 INPUT 设置
md_restartfreq  100      # 每隔 100 步更新一次重启信息
md_restart      0        # 0 表示这是一个新的计算 (默认值)
```

*   **注意**: `md_restartfreq` 不宜过小（避免 I/O 瓶颈），也不宜过大（避免中断时丢失太多进度）。通常建议设置为 100~1000 步，或者对应物理时间的 1 ps 左右。

### 5.2.3 步骤二：执行续算

假设计算在第 5500 步中断，我们需要从最近的保存点恢复。

1.  **准备文件**: 确保 `OUT.${suffix}/` 目录下存在 `Restart_md.dat` 和对应的 `STRU/` 文件夹。
2.  **修改 INPUT**: 将 `md_restart` 参数修改为 1。

```bash
# 续算时的 INPUT 设置
INPUT_PARAMETERS
# ... (保持原有物理参数如 md_type, md_dt, cutoff 等完全不变)

md_nstep        10000    # 总目标步数 (注意：这是累积步数，不是新增步数)
md_restart      1        # 开启续算模式
md_restartfreq  100      # 继续保持写入重启文件
```

3.  **提交任务**: 再次运行 ABACUS。程序会自动读取 `Restart_md.dat`，定位到最近保存的步数（例如第 5500 步），并从 `OUT.${suffix}/STRU/STRU_MD_5500` 读取结构和速度，继续计算直到达到 `md_nstep`。

> **专家提示**: 在续算时，**严禁**修改涉及物理系综的参数（如 `md_type`, `md_dt`, 温度设置等），除非你明确知道自己在做什么（例如分阶段变温模拟）。

---

## 附录：常见报错与避坑指南

### 1. 时间步长陷阱 (Time Step Trap)
AIMD 的计算稳定性高度依赖于 `md_dt`。
*   **现象**: 原子突然“飞出”盒子，总能量发生剧烈漂移，或者 SCF 突然无法收敛。
*   **原因**: `md_dt` 设置过大，导致原子在一个步长内移动距离过大，进入了势能面的非物理区域。
*   **建议**:
    *   轻元素（H, Li 等）：推荐 `md_dt` = 0.5 ~ 1.0 fs。
    *   重元素体系：可适当放宽至 1.0 ~ 2.0 fs。
    *   **精度与效率的平衡**: 虽然大步长能跑得更快，但为了保证能量守恒和物理正确性，保守的步长总是更安全的。

### 2. 系综选择与参数缺失风险
`md_type` 参数决定了物理系综（如 NVT, NPT, NVE）。
*   **风险提示**: 不同的热浴算法（如 Anderson, Langevin, Nose-Hoover）需要特定的控制参数（如阻尼系数、质量等）。
*   **现状**: 当前 ABACUS 的部分热浴参数（特别是 NPT 系综下的压强控制参数，如目标压强、压强耦合时间常数等）在不同版本中可能有所变化。
*   **行动指南**: 在使用 NPT (`md_type npt`) 或特定恒温器时，**请务必查阅 ABACUS 官方在线文档**以确认当前版本的具体参数名和单位，切勿凭经验猜测。

### 3. 大体系与温稠密物质 (SDFT)
如果你正在模拟高温（如 > 10000K）或大尺度金属体系，传统的 KS-DFT 计算量会非常巨大。
*   **优化方案**: 可以在 `INPUT` 中设置 `esolver_type sdft` (Stochastic DFT)。
*   **原理**: 随机 DFT 算法在高温下具有极高的效率优势，能够显著降低大体系 MD 的耗时。详情请参考相关文献或官方高级教程。

### 4. 资源估算
*   **估算公式**: 总核时 $\approx$ 单步 SCF 时间 $\times$ 平均 SCF 步数 $\times$ MD 总步数。
*   **经验**: MD 过程中的 SCF 收敛通常比静态计算快（因为利用了上一帧的波函数/电荷密度作为初猜），通常 3-10 步 SCF 即可收敛。如果发现每步 MD 都需要几十步 SCF，请检查 `md_dt` 是否过大或体系是否存在物理异常。

---

## 附录：进阶学习指南

完成本书的学习只是您探索分子动力学广阔天地的起点。为了进一步提升模拟的深度与广度，我们为您整理了以下进阶方向与调试建议。

### 1. 进阶主题推荐（Extended Reading）
-   **机器学习势能（DPMD）**：AIMD 虽然精确，但受限于体系规模（通常几百个原子）。建议查阅 ABACUS 与 **DeePMD-kit** 结合的使用教程。通过训练深度神经网络势能，您可以模拟包含数万甚至数百万原子的体系，同时保持第一性原理的精度。
-   **多尺度冲击压缩（MSST）**：在第四章提及的进阶场景基础上，深入研究 MSST 方法（`calculation md` 配合相关参数），这对于研究材料在极端动态载荷下的响应至关重要。
-   **稀有事件采样**：如果您关注的是化学反应或高能垒的相变，标准的 MD 往往难以在有限时间内观察到现象。建议探索元动力学（Metadynamics）或受限分子动力学等增强采样方法。
-   **输运性质计算**：利用 MD 轨迹，结合 Green-Kubo 公式，您可以计算体系的扩散系数、粘度以及热导率等关键输运性质。

### 2. 通用调试建议（Troubleshooting）
-   **能量不守恒？**：在 NVE 模拟中，如果总能量出现明显漂移，请首先检查时间步长（`md_dt`）是否过大（尤其是含氢体系），其次检查 SCF 收敛判据（`scf_thr`）是否足够严苛。
-   **温度震荡剧烈？**：在 NVT 模拟中，不同的热浴算法对温度的控制能力不同。Berendsen 方法虽然稳定但不能给出正确的正则分布，而 Nosé-Hoover（如适用）或 Langevin 则能提供更好的统计系综。根据您的物理需求选择合适的热库。
-   **计算意外中断？**：养成定期检查 `md_dump` 输出的习惯。利用第五章学到的断点续算技术，可以最大程度挽回因硬件故障或集群限时导致的进度损失。

### 3. 官方资源与社群
-   **官方文档**：请经常访问 [ABACUS User Guide](https://mcresearch.github.io/abacus-user-guide/) 以获取最新的参数说明与功能更新。
-   **开源社区**：在 GitHub 的 ABACUS 仓库中提交 Issue 或参与讨论，是解决疑难杂症最有效的途径。

**科学探索永无止境，祝愿您的每一条原子轨迹都能揭示自然的奥秘！**
