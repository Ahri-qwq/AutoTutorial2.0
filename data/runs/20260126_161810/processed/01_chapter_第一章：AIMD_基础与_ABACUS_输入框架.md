# 第一章：AIMD 基础与 ABACUS 输入框架

欢迎进入 ABACUS 分子动力学（AIMD）的世界。

在之前的学习中，你可能已经熟悉了静态计算（Static Calculation），即求解体系在 0K 下的基态电子结构和几何结构优化。然而，真实世界是动态的、有温度的。分子动力学（Molecular Dynamics, MD）正是连接微观原子运动与宏观热力学性质（如扩散系数、粘度、相变温度）的桥梁。

本章的目标非常明确：**帮助你完成从“静态优化”到“动态演化”的思维转换**，并掌握 ABACUS 处理 MD 的核心输入框架。

---

## 1.1 第一性原理分子动力学 (AIMD) 概论

### 1.1.1 物理本质：在势能面上“滑行”
在几何结构优化（Relaxation）中，我们的目标是寻找势能面（PES）的**最低点**（受力为零）。而在分子动力学中，我们的目标是根据牛顿运动方程（$F=ma$），让原子在势能面上**滑行**。

所谓的 **AIMD (Ab Initio Molecular Dynamics)**，其核心特征在于：**原子受到的力 $F$ 是通过实时求解电子结构（通常是 DFT）获得的**。

*   **经典 MD (Force Field)**: 力来源于预先拟合好的经验函数（如弹簧模型）。速度极快，但难以处理化学键断裂、生成以及复杂的电子转移过程。
*   **AIMD (ABACUS)**: 力来源于量子力学计算。精度极高，能描述化学反应，但计算成本昂贵。

### 1.1.2 能量求解器：精度与效率的选择
在 ABACUS 的 `INPUT` 文件中，通过 `calculation` 参数开启 MD 模式，并通过 `esolver_type` 选择力的来源。

```bash
INPUT_parameters
# 开启分子动力学计算
calculation     md

# 选择能量求解器 (Energy Solver)
esolver_type    ksdft   # 默认值。基于 Kohn-Sham DFT
```

ABACUS 支持多种求解器，适应不同场景：

1.  **`ksdft` (Kohn-Sham DFT)**:
    *   **适用场景**: 绝大多数常规 AIMD 任务。
    *   **特点**: 精度标准，但随着原子数 $N$ 增加，计算量呈 $O(N^3)$ 增长。
2.  **`sdft` (Stochastic DFT)**:
    *   **适用场景**: **温稠密物质 (Warm Dense Matter)** 或超大体系高温模拟。
    *   **特点**: 引入随机算法，在高温下比 KS-DFT 更高效。*（注：如果你研究的是极端高温高压体系，请务必关注此选项以降低计算量。）*
3.  **`dp` (Deep Potential)**:
    *   **适用场景**: 使用深度学习势函数进行大规模 MD。
    *   **特点**: 结合了 AIMD 的精度和经典 MD 的速度，但需要预先训练模型（需配合 DeepModeling 相关工具）。
4.  **`lj` (Lennard-Jones)**:
    *   **适用场景**: 仅用于代码测试或教学演示。
    *   **特点**: 极简的经验势，不具备化学精度。

> **⚠️ 核心强调：精度与效率的平衡**
> AIMD 的计算成本极其昂贵。一个静态步可能需要几分钟，而一条有意义的 MD 轨迹通常需要数万步。因此，**不要盲目追求过高的平面波截断能（ecutwfc）或过密的 K 点网格**。在 MD 中，通常使用比静态计算略宽松的收敛标准，以换取可接受的时间成本。

---

## 1.2 结构文件与初始速度

在 MD 模拟中，`STRU` 文件不仅定义了原子的初始位置，还可以定义原子的**初始速度**。

### 1.2.1 `STRU` 文件的格式变化
对于静态计算，我们只关心位置。但在 MD 中，如果你需要通过“断点续算”来延续之前的轨迹，或者需要指定非随机的初始速度，就需要在这个文件中包含速度信息。

`STRU` 文件中原子坐标部分的格式如下：
```text
ATOMIC_POSITIONS
# 格式: 元素名 磁矩 数量
Si 0.0 2
# 格式: x y z move_x move_y move_z [v_x v_y v_z]
Direct
0.00 0.00 0.00 1 1 1 v 0.01 -0.02 0.00
0.25 0.25 0.25 1 1 1 v 0.00  0.03 0.01
```
*   **`v` 关键字**: 紧跟在移动约束（1 1 1）之后，标识后面三个数为速度分量。
*   **单位**: ABACUS 内部单位（通常与 Rydberg/Bohr 相关，具体换算请参考官方文档）。

### 1.2.2 控制参数：`init_vel`
在 `INPUT` 文件中，`init_vel` 参数决定了程序如何处理初始速度：

```bash
INPUT_parameters
# 初始速度控制
init_vel    0    # 默认值。自动生成随机速度。
                 # 0: 根据设定的温度（md_tfirst）生成麦克斯韦-玻尔兹曼分布的随机速度。
                 # 1: 从 STRU 文件中读取速度。通常用于续算（Restart）。
```

> **实战技巧**: 第一次运行 MD 时，通常设置 `init_vel 0` 并指定初始温度。当任务因时间限制中断后，需要将最后一步的 `STRU`（包含速度）复制为新的输入，并设置 `init_vel 1` 继续运行。

---

## 1.3 关键的时间参数

MD 的本质是对时间进行积分。理解“时间步长”是避免模拟失败的关键。

### 1.3.1 时间步长 (`md_dt`)
`md_dt` 定义了模拟中每一步的时间跨度，单位为 **飞秒 (fs)**。

```bash
INPUT_parameters
md_dt       1.0   # 时间步长，单位 fs
```

*   **物理意义**: 必须足够短，以捕捉原子最高频的振动（通常是 X-H 键的伸缩振动）。
*   **选择策略**:
    *   **含氢体系**: 推荐 **0.5 fs**。氢原子质量小、振动快，步长过大会导致积分误差，甚至原子“飞出”体系。
    *   **不含氢体系**: 通常 **1.0 - 2.0 fs**。
    *   **重原子体系**: 可适当增大，但需谨慎。
*   **风险提示**: 如果 `md_dt` 设置过大，体系能量会发生剧烈漂移（Energy Drift），甚至导致 SCF 不收敛或几何结构崩塌（“炸裂”）。

### 1.3.2 模拟时长 (`md_nstep`)
`md_nstep` 定义了总共跑多少步。

```bash
INPUT_parameters
md_nstep    1000  # 总步数
```

*   **总物理时间** = `md_dt` $\times$ `md_nstep`。
*   例如：`md_dt 1.0` 且 `md_nstep 1000` $\rightarrow$ 总时长 1000 fs = 1 ps。

---

## 1.4 系综与热力学控制 (风险提示)

在 MD 中，我们必须定义体系与环境的交换关系，即**系综 (Ensemble)**。这通过 `md_type` 参数控制。

### 1.4.1 常见系综
*   **NVE (微正则系综)**: 粒子数、体积、能量守恒。通常用于测试能量守恒性。
    *   设置: `md_type nve`
*   **NVT (正则系综)**: 粒子数、体积、**温度**恒定。最常用的 AIMD 系综。
    *   设置: `md_type nvt`
*   **NPT (等温等压系综)**: 粒子数、**压强**、温度恒定。用于相变或密度计算。
    *   设置: `md_type npt`

### 1.4.2 关键缺失参数警示
要实现 NVT 或 NPT，必须引入热浴（Thermostat）或压浴（Barostat）算法。

> **⚠️ 风险提示：请查阅官方手册**
> 
> 1.  **热浴算法**: 仅仅设置 `md_type nvt` 是不够的，你还需要选择具体的热浴算法（如 Anderson, Langevin, Nose-Hoover 等）并设置相应的阻尼参数。**当前资料库未包含这些具体参数的配置方法，请务必查阅 ABACUS 官方在线文档中关于 `md_thermostat` 及相关参数的说明。**
> 2.  **压强控制**: 对于 NPT 系综，除了温度，还需要设置目标压强。**当前资料库未包含 NPT 压强设置的具体参数（如目标压强值），请务必参考官方手册补充此部分。**

---

## 第一章小结：INPUT 文件模板

一个最基础的 AIMD `INPUT` 文件框架如下：

```bash
INPUT_parameters
# --- 基础计算设置 ---
calculation     md          # 开启 MD
esolver_type    ksdft       # 使用 KS-DFT 求解力
basis_type      pw          # 平面波基组 (示例)

# --- MD 核心参数 ---
md_type         nvt         # 系综选择 (需配合热浴参数，见官方文档)
md_nstep        2000        # 跑 2000 步
md_dt           1.0         # 步长 1.0 fs

# --- 初始状态 ---
init_vel        0           # 随机生成初始速度
md_tfirst       300         # 初始温度 300 K

# --- 输出控制 ---
md_dump_freq    10          # 每 10 步输出一次结构和能量
```

理解了这些参数，你就掌握了让原子“动起来”的钥匙。下一章，我们将深入探讨如何监控 MD 过程中的能量变化与稳定性。