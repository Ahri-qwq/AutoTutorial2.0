# 第二章：微正则系综 (NVE) —— 能量守恒的试金石

在第一章完成了静态计算的入门后，我们将进入动力学模拟（Molecular Dynamics, MD）的广阔天地。在任何复杂的 MD 模拟（如 NVT 控温或 NPT 控压）之前，**微正则系综（NVE）** 是我们必须跨越的第一道门槛。

NVE 系综代表了一个与外界完全隔离的系统：粒子数（N）、体积（V）和总能量（E）保持恒定。因为它不依赖任何人为的热浴或压浴算法，NVE 是检验**时间步长（Time Step）设置是否合理**以及**电子步（SCF）收敛精度是否足够**的“试金石”。

> **核心观点**：如果你的系统在 NVE 下无法保持能量守恒（即出现显著的能量漂移），那么在 NVT 或 NPT 下的结果也是不可信的——热浴仅仅是掩盖了数值积分的错误，而非修正了它。

---

## 2.1 NVE 参数设置与运行

在 ABACUS 中，开启 NVE 模拟非常直接。我们将以金刚石结构硅（Diamond Si）为例，展示如何配置一个标准的 NVE 探测任务。

### 2.1.1 必备输入文件

除了标准的 `STRU`（结构文件）、`KPT`（K点文件）和赝势/轨道文件外，核心的控制参数位于 `INPUT` 文件中。

#### 示例：`INPUT` 文件配置
```bash
INPUT_PARAMETERS
# 1. 基础计算参数
suffix          md_nve_si
calculation     md           # 开启分子动力学计算
ntype           1
nbands          8

# 2. 电子结构精度 (关键!)
ecutwfc         50           # 平面波截断能 (Ry)，根据赝势调整
scf_thr         1.0e-6       # SCF 收敛阈值 (Ry)，MD 中需严格设置
basis_type      lcao         # 使用数值原子轨道基组 (或 pw)

# 3. MD 核心参数
md_type         nve          # 指定系综为微正则系综
md_dt           1.0          # 时间步长，单位：飞秒 (fs)
md_nstep        100          # MD 总步数

# 4. 输出控制
out_stru        1            # 每步都输出结构文件
```

### 2.1.2 关键参数详解

1.  **`calculation md`**: 告诉 ABACUS 内核，我们不再寻找势能面最小点（Relaxation），而是要根据牛顿运动定律演化原子位置。
2.  **`md_type nve`**:
    *   **物理含义**: 系统按照 Velocity Verlet 算法进行演化。
    *   **注意**: 此模式下没有恒温器（Thermostat）。系统的瞬时温度 $T(t)$ 会随着势能与动能的相互转化而剧烈波动，这是正常的物理现象，但**总能量**（动能+势能）应保持守恒。
    *   **特别提示**: 若需使用 NVT 系综（如 Anderson 或 Langevin 热浴），`md_type` 需设置为 `nvt`，但具体的控温参数（如阻尼系数等）请务必查阅 [ABACUS 在线文档](https://abacus.deepmodeling.com/en/latest/)，不同版本的参数名可能有所变化。
3.  **`md_dt` (时间步长)**:
    *   **单位**: 飞秒 (fs)。
    *   **策略**: AIMD（从头算分子动力学）极其昂贵。步长过小（如 0.1 fs）会浪费计算资源；步长过大（如 5.0 fs）会导致积分误差，破坏能量守恒，甚至导致系统“炸裂”。对于硅等共价体系，**1.0 fs** 通常是一个安全的起点；对于含有轻元素（如 H）的体系，可能需要降至 **0.5 fs**。
4.  **`md_nstep`**:
    *   建议在正式跑长轨迹（如 10 ps 以上）之前，先设置较小的步数（如 50-100 步）进行测试，确认守恒性后再延长。

---

## 2.2 守恒性分析与参数调优

运行结束后，我们的首要任务不是看结构跑到了哪里，而是检查**能量守恒性**。

### 2.2.1 检查能量漂移 (Energy Drift)

ABACUS 的标准输出文件（或 `running_md.log`）中会记录每一步的热力学量。重点关注 `Total Energy` 一列。

*   **理想情况**: 总能量应在一条水平线附近微小波动，无明显的上升或下降趋势。
*   **漂移量化**: 通常要求能量漂移率小于 $10^{-4} \sim 10^{-5}$ eV/atom/ps。如果发现总能量像下坡一样持续降低，或者像火箭一样持续上升，说明模拟参数设置有问题。

### 2.2.2 精度与效率的平衡：`scf_thr` 的影响

在 AIMD 中，原子核在 Born-Oppenheimer 势能面上运动。如果电子步（SCF）没有收敛到足够的精度，计算出的原子力（Hellmann-Feynman 力）就会包含巨大的噪音。这些噪音累积起来，会表现为系统的非物理加热或冷却。

*   **推荐设置**:
    *   **`scf_thr 1.0e-5` ~ `1.0e-6`**: 适用于大多数标准的 NVE/NVT 模拟。
    *   **`scf_thr 1.0e-4`**: 仅用于极粗糙的预平衡，**严禁**用于生产性数据采样，否则能量守恒性极差。
    *   **`scf_thr 1.0e-8`**: 精度极高，但会显著增加每一步 MD 的耗时。除非是做极高精度的能量传递分析，否则不推荐，性价比低。

### 2.2.3 常见问题排查清单

如果你在 NVE 测试中发现能量守恒很差（Drift 很大）：

1.  **检查 `md_dt`**: 尝试将时间步长减半（例如从 1.0 fs 降为 0.5 fs）。如果漂移显著改善，说明原步长过大。
2.  **检查 `scf_thr`**: 尝试加严收敛标准（例如从 1e-5 降为 1e-7）。
3.  **检查 `ecutwfc`**: 平面波截断能不足也会导致力计算不准，进而影响守恒。

---

## 2.3 进阶场景：温稠密物质与 SDFT

> **Pro Tip**: 当你处理大体系（>500 原子）且温度极高（如数万 K 的温稠密物质）时，传统的 KS-DFT 计算量会随着温度升高而急剧增加（因为需要计算大量的高能激发态能带）。

在这种极端场景下，ABACUS 提供了 **随机密度泛函理论 (Stochastic DFT)** 算法。

*   **启用方式**: 在 `INPUT` 中添加 `esolver_type sdft`。
*   **优势**: 计算复杂度随温度升高而降低，非常适合高温 MD 模拟。
*   **注意**: SDFT 引入了随机噪声，需要配合特定的 Langevin 热浴使用，具体请参考相关文献（如 *Phys. Rev. Lett. 111, 055002*）及 ABACUS 高级使用指南。

---

## 2.4 风险提示：关于 NPT 系综

虽然本章重点是 NVE，但许多用户在测试完 NVE 后会立即转向 NPT（恒温恒压）计算。

> **⚠️ 警告**：
> 目前的 ABACUS 资料库中，关于 NPT 系综的具体压强控制参数（如目标压强值 `md_p_ref` 或类似参数、压浴模量等）未包含在基础教程中。
>
> 在进行 NPT 模拟前，**请务必查阅 ABACUS 官方手册中关于 `md_type npt` 的完整参数列表**，以确保你正确设置了目标压强和恒压器参数。错误的设置可能导致晶胞体积无限膨胀或坍缩。

---

**下一章预告**：
通过 NVE 确认了模拟参数的健壮性后，我们将进入第三章，学习如何使用 **NVT 系综** 模拟真实温度下的材料行为，并讨论如何利用 Python 脚本批量处理 MD 轨迹。