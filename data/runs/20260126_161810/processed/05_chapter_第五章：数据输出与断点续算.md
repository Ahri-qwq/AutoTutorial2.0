# 第五章：数据输出与断点续算

在前面的章节中，我们已经成功配置并运行了分子动力学（MD）任务。然而，第一性原理分子动力学（AIMD）计算极其昂贵——相比于静态的自洽场（SCF）计算，MD 的计算量通常呈千倍甚至万倍增长（取决于模拟步数）。

因此，**如何高效地管理输出数据**以及**如何处理意外中断（断点续算）**，是每一位 ABACUS 用户必须掌握的工程技能。本章将详细讲解如何平衡 I/O 开销与数据采样，以及如何确保宝贵的核时不被浪费。

---

## 5.1 轨迹文件与采样频率

MD 模拟的核心产物是原子随时间演化的轨迹（Trajectory）。ABACUS 主要通过 `md_dumpfreq` 参数控制输出频率。

### 5.1.1 关键参数设置

在 `INPUT` 文件中，以下参数直接决定了输出的数据量和磁盘占用：

```bash
INPUT_PARAMETERS
# ... (其他参数)
md_nstep        10000    # 总模拟步数
md_dt           1.0      # 时间步长 (单位: fs)

# 输出控制
md_dumpfreq     10       # 每隔 10 步输出一次轨迹和能量信息
cal_force       1        # 输出轨迹中包含受力信息 (1=开启)
cal_stress      1        # 输出轨迹中包含应力张量 (1=开启)
```

### 5.1.2 输出文件解析

当任务运行后，ABACUS 会在 `OUT.${suffix}/` 目录下生成以下关键文件：

1.  **MD_dump**:
    *   这是主要的轨迹文件，包含了每隔 `md_dumpfreq` 步的原子坐标、速度、受力（如果 `cal_force=1`）和晶格矢量。
    *   **用途**: 用于后续的可视化（如 OVITO）和后处理分析（如扩散系数、RDF 计算）。
2.  **STRU/ 文件夹**:
    *   路径: `OUT.${suffix}/STRU/`
    *   内容: 包含一系列名为 `STRU_MD_${istep}` 的文件。
    *   **用途**: 这些是标准的 ABACUS 结构文件格式，可直接用于后续的静态计算（如选取某一帧做电子结构分析）或作为断点续算的输入。

### 5.1.3 采样频率的权衡 (Best Practice)

*   **不要每步都输出**: 如果 `md_dumpfreq` 设为 1，不仅会产生巨大的磁盘 I/O 压力，导致计算变慢，生成的 `MD_dump` 文件也会大到难以处理。
*   **物理相关性**: 两次采样之间的时间间隔应小于体系的特征弛豫时间。
    *   通常建议采样间隔为 **10 ~ 100 fs**。
    *   如果 `md_dt = 1 fs`，推荐设置 `md_dumpfreq` 为 10 到 100 之间。

---

## 5.2 断点续算 (Restart)

在高性能计算集群（HPC）上，作业往往有运行时间限制（Walltime），或者可能因硬件故障意外中断。ABACUS 提供了完善的断点续算功能，允许用户从中断处继续计算，而无需从头开始。

### 5.2.1 续算机制

ABACUS 的续算依赖于两个关键要素：
1.  **Restart_md.dat**: 记录了当前 MD 步数、恒温器/恒压器内部状态等信息。
2.  **STRU_MD_${istep}**: 记录了对应步数的原子结构和速度。

### 5.2.2 步骤一：确保生成了重启文件

在**首次运行**（或上一轮运行）的 `INPUT` 文件中，必须设置合理的重启文件写入频率：

```bash
# 首次运行的 INPUT 设置
md_restartfreq  100      # 每隔 100 步更新一次重启信息
md_restart      0        # 0 表示这是一个新的计算 (默认值)
```

*   **注意**: `md_restartfreq` 不宜过小（避免 I/O 瓶颈），也不宜过大（避免中断时丢失太多进度）。通常建议设置为 100~1000 步，或者对应物理时间的 1 ps 左右。

### 5.2.3 步骤二：执行续算

假设计算在第 5500 步中断，我们需要从最近的保存点恢复。

1.  **准备文件**: 确保 `OUT.${suffix}/` 目录下存在 `Restart_md.dat` 和对应的 `STRU/` 文件夹。
2.  **修改 INPUT**: 将 `md_restart` 参数修改为 1。

```bash
# 续算时的 INPUT 设置
INPUT_PARAMETERS
# ... (保持原有物理参数如 md_type, md_dt, cutoff 等完全不变)

md_nstep        10000    # 总目标步数 (注意：这是累积步数，不是新增步数)
md_restart      1        # 开启续算模式
md_restartfreq  100      # 继续保持写入重启文件
```

3.  **提交任务**: 再次运行 ABACUS。程序会自动读取 `Restart_md.dat`，定位到最近保存的步数（例如第 5500 步），并从 `OUT.${suffix}/STRU/STRU_MD_5500` 读取结构和速度，继续计算直到达到 `md_nstep`。

> **专家提示**: 在续算时，**严禁**修改涉及物理系综的参数（如 `md_type`, `md_dt`, 温度设置等），除非你明确知道自己在做什么（例如分阶段变温模拟）。

---

## 附录：常见报错与避坑指南

### 1. 时间步长陷阱 (Time Step Trap)
AIMD 的计算稳定性高度依赖于 `md_dt`。
*   **现象**: 原子突然“飞出”盒子，总能量发生剧烈漂移，或者 SCF 突然无法收敛。
*   **原因**: `md_dt` 设置过大，导致原子在一个步长内移动距离过大，进入了势能面的非物理区域。
*   **建议**:
    *   轻元素（H, Li 等）：推荐 `md_dt` = 0.5 ~ 1.0 fs。
    *   重元素体系：可适当放宽至 1.0 ~ 2.0 fs。
    *   **精度与效率的平衡**: 虽然大步长能跑得更快，但为了保证能量守恒和物理正确性，保守的步长总是更安全的。

### 2. 系综选择与参数缺失风险
`md_type` 参数决定了物理系综（如 NVT, NPT, NVE）。
*   **风险提示**: 不同的热浴算法（如 Anderson, Langevin, Nose-Hoover）需要特定的控制参数（如阻尼系数、质量等）。
*   **现状**: 当前 ABACUS 的部分热浴参数（特别是 NPT 系综下的压强控制参数，如目标压强、压强耦合时间常数等）在不同版本中可能有所变化。
*   **行动指南**: 在使用 NPT (`md_type npt`) 或特定恒温器时，**请务必查阅 ABACUS 官方在线文档**以确认当前版本的具体参数名和单位，切勿凭经验猜测。

### 3. 大体系与温稠密物质 (SDFT)
如果你正在模拟高温（如 > 10000K）或大尺度金属体系，传统的 KS-DFT 计算量会非常巨大。
*   **优化方案**: 可以在 `INPUT` 中设置 `esolver_type sdft` (Stochastic DFT)。
*   **原理**: 随机 DFT 算法在高温下具有极高的效率优势，能够显著降低大体系 MD 的耗时。详情请参考相关文献或官方高级教程。

### 4. 资源估算
*   **估算公式**: 总核时 $\approx$ 单步 SCF 时间 $\times$ 平均 SCF 步数 $\times$ MD 总步数。
*   **经验**: MD 过程中的 SCF 收敛通常比静态计算快（因为利用了上一帧的波函数/电荷密度作为初猜），通常 3-10 步 SCF 即可收敛。如果发现每步 MD 都需要几十步 SCF，请检查 `md_dt` 是否过大或体系是否存在物理异常。