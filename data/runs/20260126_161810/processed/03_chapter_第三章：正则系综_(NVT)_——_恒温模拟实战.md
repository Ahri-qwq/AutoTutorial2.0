# 第三章：正则系综 (NVT) —— 恒温模拟实战

在绝大多数材料模拟与实际应用场景中，我们关注的体系都处于恒定的温度条件下。无论是研究相变、扩散系数，还是模拟溶液环境，**正则系综 (Canonical Ensemble, NVT)** 都是最核心的模拟手段。

本章将深入讲解如何在 ABACUS 中设置 NVT 模拟，如何根据物理需求选择合适的热浴算法（Thermostat），以及如何在第一性原理分子动力学（AIMD）昂贵的计算成本下平衡精度与效率。

---

## 3.1 NVT 基础与温度初始化

NVT 系综意味着体系的粒子数 (N)、体积 (V) 和温度 (T) 保持恒定。在 AIMD 中，由于原子核遵循牛顿运动定律，体系天然处于 NVE（微正则）系综。为了实现 NVT，我们需要引入“热浴”机制，通过与外界交换能量来控制体系温度。

### 3.1.1 基础参数设置

在 `INPUT` 文件中，启动 NVT 模拟的核心参数如下：

```bash
INPUT_PARAMETERS
# 1. 基础计算类型
calculation     md          # 设置计算类型为分子动力学

# 2. 系综控制
md_type         nvt         # 设置系综为 NVT (恒温恒容)
# 或者使用特定算法的快捷方式，如 md_type langevin

# 3. 温度控制
md_tfirst       300.0       # 初始温度/目标温度，单位 Kelvin
# 注意：在某些热浴算法中，可能需要 md_tlast 来指定升温过程，
# 但在标准 NVT 平衡中，通常 md_tfirst 即为目标温度。

# 4. 时间步长与步数 (核心权衡)
md_dt           1.0         # 时间步长，单位 fs。
                            # 推荐值：0.5 - 1.0 fs (对于含氢体系建议 0.5 fs)
md_nstep        1000        # 总模拟步数
```

### 3.1.2 精度与效率的平衡（专家提示）

**AIMD 计算极其昂贵**。与经典力场 MD 动辄纳秒（ns）级的模拟不同，AIMD 每一步都需要进行电子结构的自洽迭代（SCF）。

*   **时间步长 (`md_dt`)**: 必须足够小以捕捉原子最高频的振动（通常是 C-H 或 O-H 键）。设置过大（如 > 2.0 fs）会导致能量漂移甚至模拟崩溃；设置过小则浪费计算资源。**1.0 fs 是大多数无氢体系的黄金标准**。
*   **模拟时长**: 1000 步（1 ps）通常仅够简单的热化。对于扩散系数或自由能计算，可能需要 5 ps - 50 ps 甚至更长。请务必在正式生产（Production Run）前进行充分的测试。

---

## 3.2 热浴算法详解 (Thermostats)

ABACUS 提供了多种热浴算法来控制温度。选择哪种算法取决于你的模拟目的：是为了快速达到平衡，还是为了采样精确的正则系综分布，亦或是为了研究动力学性质（如扩散）。

在 ABACUS 中，当 `md_type` 设置为 `nvt` 时，通过 **`md_thermostat`** 参数选择具体的热浴算法。

### 3.2.1 常见热浴算法概览

以下是 ABACUS 支持的主要热浴类型（需在 `INPUT` 中设置）：

| `md_thermostat` 参数值 | 算法名称 | 特点与适用场景 |
| :--- | :--- | :--- |
| **`nhc`** | **Nose-Hoover Chain** | **最推荐**。严格遵循正则系综分布。适合生产阶段（Production Run）和热力学性质计算。 |
| **`anderson`** | Anderson | 随机碰撞热浴。采样效率高，但会破坏粒子的运动相关性，**不适合计算扩散系数**。 |
| **`berendsen`** | Berendsen | 弱耦合热浴。效率极高，能快速将温度拉到目标值，但**不能生成严格的正则系综**。仅建议用于预平衡阶段。 |
| **`rescaling`** / **`rescale_v`** | Velocity Rescaling | 直接速度标度。最粗暴的控温方式，强制动能守恒。仅用于极粗略的初始化。 |

### 3.2.2 随机类热浴：Langevin 与 Anderson

这类算法通过引入随机力或随机碰撞来模拟溶剂效应或热浴耦合。

**1. Langevin 热浴**
ABACUS 提供了一个特殊的快捷方式直接调用 Langevin 动力学：
```bash
md_type         langevin    # 直接指定使用 Langevin 动力学进行 NVT 模拟
```
*   **物理意义**: 模拟粒子在粘滞流体中的布朗运动，包含摩擦项和随机力项。
*   **适用场景**: 模拟溶剂环境，或者需要非常快速的温度平衡。
*   **注意**: Langevin 会显著改变体系的动力学性质（如扩散速率），除非摩擦系数非常小。

**2. Anderson 热浴**
```bash
md_type         nvt
md_thermostat   anderson
```
*   **机制**: 粒子以一定概率与虚拟热浴发生“碰撞”，速度被重置为麦克斯韦-玻尔兹曼分布中的随机值。

### 3.2.3 确定性热浴：Nose-Hoover Chain (NHC)

这是 AIMD 中最常用的算法。

```bash
md_type         nvt
md_thermostat   nhc
```
*   **机制**: 在哈密顿量中引入额外的自由度（“热浴变量”）。
*   **优势**: 能够产生严格的正则系综分布，且对动力学性质的干扰相对较小（相比于随机类热浴）。
*   **劣势**: 如果体系初始结构离平衡态太远，NHC 可能会出现剧烈的震荡甚至导致体系崩溃。**建议先用 Berendsen 跑几百步预平衡，再切换到 NHC。**

### 3.2.4 关键控制参数（查阅文档提示）

**风险提示**：不同的热浴算法需要特定的控制参数来调节“耦合强度”（即热浴与体系交换能量的快慢）。
*   例如，Nose-Hoover 需要设置频率或质量；Langevin 需要设置摩擦系数或阻尼时间；Anderson 需要设置碰撞频率。
*   **当前资料库未包含这些具体参数的最新命名（如 `md_damp`, `tau_t` 等）**。
*   **行动指南**: 在撰写 `INPUT` 文件前，请务必访问 [ABACUS 在线文档](https://abacus.deepmodeling.com/en/latest/advanced/input_files/input-main.html#md-thermostat) 确认当前版本对应的控制参数名。设置不当（如耦合过强）会导致非物理的模拟结果。

---

## 3.3 高级实战技巧

### 3.3.1 温稠密物质与 SDFT
如果你正在模拟高温高压体系（如行星内部、温稠密物质），电子温度极高，传统的 KS-DFT 计算量会急剧增加。
此时，建议在 `INPUT` 中开启随机密度泛函理论（Stochastic DFT）选项：
```bash
esolver_type    sdft    # 启用 SDFT 求解器
```
这可以显著降低高温下大量空带计算带来的成本（参考资料 7）。

### 3.3.2 预平衡策略 (Equilibration Protocol)
一个稳健的 AIMD 模拟流程通常如下：
1.  **几何优化 (`calculation relax`)**: 先把原子结构优化到势能面极小值附近，避免 MD 初始受力过大导致“炸飞”。
2.  **预平衡 (NVT - Berendsen)**: 使用 `md_thermostat berendsen` 运行 500-1000 步，快速将温度稳定在目标值。
3.  **生产运行 (NVT - NHC)**: 切换为 `md_thermostat nhc`，运行 5000+ 步，用于数据采样。

### 3.3.3 关于 NPT 系综的说明
虽然本章聚焦于 NVT，但许多用户需要 NPT（恒温恒压）系综来获取平衡体积。
*   ABACUS 支持 `md_type npt`。
*   **注意**: NPT 模拟除了温度控制外，还涉及压强控制（Barostat）。当前资料库未包含设置目标压强（Target Pressure）的具体参数名。进行 NPT 模拟前，请务必查阅官方手册补充压强耦合相关的参数设置。

---

**下一章预告**：
在掌握了恒温模拟后，我们将进入第四章，探讨如何处理 AIMD 产生的轨迹文件，计算径向分布函数（RDF）与均方位移（MSD），提取真实的物理性质。