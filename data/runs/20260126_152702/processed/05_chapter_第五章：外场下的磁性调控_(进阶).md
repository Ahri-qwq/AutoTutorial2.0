# 第五章：外场下的磁性调控 (进阶)

在前面的章节中，我们已经掌握了基本的磁性计算（共线自旋 `nspin=2`）。然而，在实际的自旋电子学（Spintronics）研究中，仅仅得到基态磁性往往是不够的。我们更关注如何通过外部手段（如电场、应力）来**调控**材料的磁性或电子结构。

本章将重点介绍 ABACUS 的进阶功能：**在外加电场下研究磁性体系的能带响应**。我们将以经典的锯齿型石墨烯纳米带（Zigzag Graphene Nanoribbon, ZGNR）为例，展示如何通过电场诱导半导体-金属转变（Half-metallicity）。

---

## 5.1 外加电场设置

在周期性边界条件下施加电场是一个非平凡的问题。ABACUS 采用类似偶极修正（Dipole Correction）的方法，在真空层中引入一个锯齿状（Sawtooth）的电势来模拟恒定电场。

### 5.1.1 适用体系与物理图像
*   **适用体系**：必须是**带真空层的表面模型（Slab）**或一维体系。对于三维块体（Bulk）材料，由于周期性边界条件的限制，不能直接施加恒定电场。
*   **物理效应**：外加电场会破坏体系的空间反演对称性，导致能带发生斯塔克分裂（Stark Splitting）。在磁性体系中，这种分裂是自旋依赖的，可能导致自旋向上和向下的能带发生相对位移，从而实现从反铁磁半导体到半金属（Half-metal）的转变。

### 5.1.2 关键输入参数
在 `INPUT` 文件中，通过以下参数控制电场：

| 参数名 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| **`efield_amp`** | Real | 0.0 | **电场强度**。单位为 **a.u. (atomic units)**。注意这是一个标量，表示电场的幅度。 |
| **`efield_dir`** | Integer | 2 | **电场方向**。0: x方向, 1: y方向, 2: z方向。通常沿表面法线方向（即真空层方向）。 |

> **⚠️ 警告：单位陷阱**
> `efield_amp` 的单位是原子单位（Hartree/Bohr）。
> **1 a.u. $\approx$ 51.42 V/Å**。
> 这是一个非常巨大的电场！通常实验中可实现的电场在 $10^{-4}$ 到 $10^{-2}$ a.u. 量级。切勿直接设置为 `1.0`，否则会导致电子“逃逸”到真空中，计算发散。

### 5.1.3 实战案例：ZGNR 的电场调控
假设我们已经构建好了一个 ZGNR 的超胞，并设置了反铁磁基态（见下文 5.2 节）。现在我们施加一个垂直于纳米带轴向的横向电场。

**INPUT 文件示例**：
```bash
INPUT_PARAMETERS
# 基础自旋设置
nspin           2           # 开启自旋极化
ks_solver       genelpa     # 对角化方法

# 电场设置
efield_amp      0.005       # 施加约 0.25 V/A 的电场
efield_dir      1           # 假设纳米带位于 x-z 平面，真空层在 y 方向（根据实际结构调整）

# 迭代控制
scf_nmax        100
mixing_type     pulay
mixing_beta     0.4         # 磁性计算建议适当降低混合因子
```

**预期结果**：
在无电场时，反铁磁的 ZGNR 是有带隙的半导体，且自旋简并。施加电场后，你可以观察到自旋向上和向下的能带发生分裂，带隙减小，甚至在费米面附近出现单一自旋通道的导电态（半金属性）。

---

## 5.2 进阶磁性构建：反铁磁 (AFM) 与 磁矩约束

在研究电场效应前，必须正确构建磁性基态。对于像 ZGNR 这样的体系，基态通常是边缘反铁磁性（AFM），即一侧边缘自旋向上，另一侧向下。

### 5.2.1 反铁磁 (AFM) 的构建逻辑
ABACUS 计算 AFM 态时，必须满足以下两个条件：
1.  **超胞 (Supercell)**：如果原胞中只有一个磁性原子，必须扩胞（如 $2 \times 1 \times 1$），使得晶胞内至少包含两个磁性原子，以便容纳 $\uparrow$ 和 $\downarrow$ 的排列。
2.  **对称性破缺 (Symmetry Breaking)**：必须在初始时刻手动指定原子的磁矩方向。

**STRU 文件设置示例**：
在 `STRU` 文件中，我们可以为不同原子指定初始磁矩 `magmom`。

```bash
ATOMIC_POSITIONS
Direct
# 元素名  x  y  z  magmom
C         0.0  0.0  0.0   magmom  1.0   # 边缘A，自旋向上
C         0.5  0.0  0.0   magmom -1.0   # 边缘B，自旋向下
...(中间的非磁性碳原子可以设为 0)...
```
*(注：具体 `magmom` 的设置格式请以当前使用的 ABACUS 版本文档为准，部分版本可能在 `INPUT` 中通过列表指定)*

### 5.2.2 磁矩约束 (Constrained Magnetism)
有时电场会导致磁矩发生意想不到的翻转。为了稳定计算，或者研究特定磁矩下的能带，我们可以固定总磁矩。

*   **参数**: `nupdown`
*   **功能**: 强制固定体系的总磁矩差值 ($\Delta N = N_{\uparrow} - N_{\downarrow}$)。
*   **示例**:
    ```bash
    nspin      2
    nupdown    0.0    # 强制总磁矩为0（适用于反铁磁计算，防止漂移到铁磁态）
    ```

---

## 附录：常见问题与排错指南

在进行外场磁性计算时，初学者极易遇到以下陷阱，请务必仔细检查：

### Q1: 为什么我的计算结果显示没有磁性（磁矩为 0）？
**原因**：**对称性未破缺**。
DFT 的自洽迭代是一个寻找能量极小值的过程。如果你在 `INPUT` 或 `STRU` 中没有设置初始磁矩（默认全为 0），或者初始磁矩设置得太小，体系可能会陷入非磁性（NM）的局部极小值，无法自发演化到磁性基态。
**解决方案**：
*   **必须**设置初始磁矩（如 `magmom 1.0` 或更大），给体系一个“初始推动”。
*   对于反铁磁，务必确认正负磁矩的空间排列是否合理。

### Q2: 开启 `nspin=2` 后计算速度变慢了？
**原因**：**计算成本增加**。
这是正常的物理代价。当设置 `nspin=2` 后，Kohn-Sham 方程需要对 Spin Up 和 Spin Down 两个通道分别求解。
*   **时间成本**：大约是 `nspin=1` 的 **2倍**。
*   **内存成本**：波函数和电荷密度的存储需求也会相应增加。

### Q3: 后处理时文件太多，如何区分？
ABACUS 输出的磁性数据严格区分自旋通道：
*   **能带文件**：
    *   `BANDS_1`: 自旋向上 (Spin Up) 的能带数据。
    *   `BANDS_2`: 自旋向下 (Spin Down) 的能带数据。
*   **态密度 (DOS)**：
    *   `TDOS` / `PDOS` 文件中通常包含两列数据（或两个块）。
    *   **绘图技巧**：为了直观展示磁性，通常将 Spin 1 的 DOS 绘制在正半轴，将 Spin 2 的 DOS 绘制在**负半轴**（即乘以 -1），形成“镜像”图。如果上下完全对称，则为非磁或反铁磁（净磁矩为0）；如果不对称，则存在净磁矩。

### Q4: 电场加多大合适？
**建议**：
*   从极小值开始测试，例如 `0.001` a.u.。
*   逐步增加，观察能带带隙的变化趋势。
*   如果计算不收敛（SCF Oscillating），可能是电场过大导致真空层势垒被击穿，电子溢出。此时应检查真空层厚度是否足够，或减小电场。