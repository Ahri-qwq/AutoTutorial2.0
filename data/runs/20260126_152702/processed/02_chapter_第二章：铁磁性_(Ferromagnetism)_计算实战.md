# 第二章：铁磁性 (Ferromagnetism) 计算实战

在掌握了基本的非磁性计算后，我们将进入材料计算中极为重要的一环——磁性计算。本章将以最经典的 **bcc-Fe（体心立方铁）** 为例，带你完成从结构建模、参数设置到结果分析的完整流程。

这是所有自旋极化（Spin-polarized）计算的起点。无论你未来是研究反铁磁、亚铁磁，还是复杂的非共线磁性，本章的逻辑都是通用的基石。

---

## 2.1 结构文件与初始磁矩设置 (`STRU`)

在非磁性计算中，我们只关心原子的位置。但在磁性计算中，我们必须告诉 DFT 求解器：“这个原子是有磁性的”。这需要通过打破体系的自旋对称性来实现。

### 核心概念：对称性破缺
**这是新手最容易踩的坑**：如果你不显式地指定一个非零的初始磁矩，DFT 的自洽迭代（SCF）通常会从“零磁矩”开始猜测。由于数值稳定性，体系往往会陷入非磁性（Non-magnetic, NM）的局部极小值，导致你得到错误的结果（磁矩为 0）。

**必须手动设置初始磁矩，引导体系进入铁磁态。**

### `STRU` 文件编写
我们需要在 `ATOMIC_POSITIONS` 区块中，为 Fe 原子添加磁矩描述。

**文件名**: `STRU`

```abacus
ATOMIC_SPECIES
Fe 55.845 Fe_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
1.8897261258  // 1.8897 Bohr approx 1 Angstrom, check your scaling

LATTICE_VECTORS
-1.433   1.433  1.433
 1.433 -1.433  1.433
 1.433  1.433 -1.433

ATOMIC_POSITIONS
Direct

Fe
0.0
1
0.000000 0.000000 0.000000 m 0.0 0.0 3.0
```

### 语法详解
在 `ATOMIC_POSITIONS` 中，原子坐标后的 `m` 关键字用于设定初始磁矩（Initial Magnetic Moment）：

- **语法**: `x y z m start_mag_x start_mag_y start_mag_z`
- **参数解释**:
    - `m`: 标记关键字，表示后面紧跟的是磁矩设置。
    - `0.0 0.0 3.0`: 表示在 x, y, z 方向的初始磁矩分量（单位通常为玻尔磁子 $\mu_B$）。
- **实战建议**:
    - 对于 **共线自旋 (`nspin=2`)** 计算，虽然我们只关心磁矩的大小，但建议习惯性地将其设置在 z 方向（如 `0 0 3`）。
    - **初始值大小**: 不需要非常精确，只需给出一个合理的非零值即可（例如 Fe 的基态磁矩约为 2.2 $\mu_B$，我们可以设为 3.0 或 2.5）。SCF 迭代会自动优化到真实值。

---

## 2.2 输入参数设置 (`INPUT`)

在 `INPUT` 文件中，我们需要开启自旋极化开关，并调整一些有助于磁性收敛的参数。

**文件名**: `INPUT`

```abacus
INPUT_PARAMETERS
# 1. 基础参数
suffix          Fe_ferro
calculation     scf
basis_type      lcao
symmetry        1

# 2. 磁性关键参数 (Critical)
nspin           2           # 开启自旋极化 (1=非磁, 2=共线自旋)

# 3. 电子结构与收敛控制
ecutwfc         100
scf_thr         1.0e-6
scf_nmax        100
smearing_method gauss
smearing_sigma  0.01

# 4. 混合算法 (Mixing) - 磁性计算推荐设置
mixing_type     broyden
mixing_beta     0.2         # 磁性体系建议调小该值 (默认0.7可能导致震荡)
```

### 关键参数详解

1.  **`nspin 2`**:
    - **含义**: 开启共线自旋极化计算（Collinear Spin-polarized calculation）。
    - **物理图景**: 此时 Kohn-Sham 方程会对 **Spin Up (自旋向上)** 和 **Spin Down (自旋向下)** 的电子分别进行求解。
    - **计算成本警告**: 由于需要处理两套波函数和电荷密度，开启 `nspin=2` 后，计算时间通常是同等条件下非磁性计算的 **2倍左右**。

2.  **`mixing_beta 0.2`**:
    - **实战经验**: 磁性体系（尤其是金属）在 SCF 迭代过程中，电荷密度和自旋密度容易发生“晃动”（Sloshing）。将混合参数（mixing beta）从默认的 0.7 降低到 0.2 或 0.3，可以显著提高收敛的稳定性，尽管这可能会增加迭代步数。

---

## 2.3 运行计算与结果分析

运行 ABACUS（例如 `mpirun -np 4 abacus`）后，我们需要检查输出文件以确认计算是否成功。

### 1. 检查收敛性 (`running_scf.log`)
打开日志文件，关注每一次迭代的 `total mag`（总磁矩）变化。

```text
...
ELEM   1     -1.643210e+03      1.2345e-02     2.5000    <-- 初始猜测
...
ELEM  15     -1.645880e+03      5.6789e-07     2.2105    <-- 收敛值
```
- **Total Magnetism**: 最终收敛的值应接近实验值或理论值。对于 bcc-Fe，每个原子的磁矩应在 **2.2 $\mu_B$** 左右。
- **如果最终磁矩为 0**:
    - 检查 `STRU` 中是否漏写了 `m` 参数。
    - 检查 `INPUT` 中是否漏写了 `nspin 2`。
    - 尝试增大初始磁矩猜测值（例如从 3.0 改为 5.0），或者进一步减小 `mixing_beta`。

### 2. 电子态密度 (DOS) 的后处理
在磁性计算中，DOS 的输出文件通常会分为两部分（取决于后处理工具或 `TDOS` 文件格式）：
- **Spin 1 (Up)**: 多数自旋通道。
- **Spin 2 (Down)**: 少数自旋通道。

**绘图提示**: 为了直观展示铁磁性，绘图时通常将 **Spin 2 (Down)** 的 DOS 数值乘以 **-1**，绘制在 X 轴下方。这样可以清晰地看到自旋向上和向下的不对称性（即净磁矩的来源）。

---

## 2.4 进阶提示：反铁磁 (AFM) 与其他情况

虽然本章聚焦于铁磁性，但在实际科研中，你经常会遇到反铁磁（Antiferromagnetic, AFM）情况。

### 1. 反铁磁 (AFM) 计算策略
反铁磁材料的总磁矩为 0，但局部原子磁矩不为 0（例如 Fe1 为 +m，Fe2 为 -m）。
- **超胞 (Supercell)**: 如果原胞只包含 1 个磁性原子，你**必须**构建超胞（Supercell），使其至少包含 2 个磁性原子，以便容纳反平行的磁矩排列。
- **`STRU` 设置**: 需要手动指定不同原子的磁矩方向。
    ```abacus
    ATOMIC_POSITIONS
    ...
    Fe
    0.0 0.0 0.0 m  0.0 0.0  3.0  // Fe1: Spin Up
    0.5 0.5 0.5 m  0.0 0.0 -3.0  // Fe2: Spin Down
    ```

### 2. 赝势的选择
进行磁性计算时，请确保使用的赝势（Pseudopotential）支持自旋极化计算（通常标准的 PBE/LDA 赝势都支持，但需注意价电子排布是否包含产生磁性的 d 轨道或 f 轨道）。

---

**本章总结**:
1.  **`nspin 2`** 是开启磁性计算的总开关。
2.  在 **`STRU`** 中使用 **`m`** 关键字设置非零初始磁矩是打破对称性的关键。
3.  磁性计算成本较高，且对混合参数 **`mixing_beta`** 敏感。

下一章，我们将讨论如何通过 ABACUS 进行结构优化（Relaxation），让原子的位置和晶格常数找到能量最低点。