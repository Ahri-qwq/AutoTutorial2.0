# 第三章：反铁磁性 (Antiferromagnetism) 进阶设置

在上一章中，我们掌握了铁磁性（Ferromagnetism, FM）的计算方法，即体系中所有磁性原子的磁矩方向一致。然而，在实际材料研究中，**反铁磁性（Antiferromagnetism, AFM）** 是一种更为普遍且极具挑战性的磁序状态。

反铁磁材料的宏观总磁矩通常为零，但在微观尺度上，相邻原子的磁矩呈反平行排列。这种“宏观无磁，微观有序”的特性，使得 AFM 计算在结构建模和初始参数设置上比 FM 复杂得多。

本章将指导你如何在 ABACUS 中构建反铁磁模型，并打破体系的对称性以获得正确的磁性基态。

---

## 3.1 反铁磁的结构建模策略

### 为什么单胞（Primitive Cell）往往不够用？

在计算铁磁性时，由于所有原子磁矩方向相同，我们通常可以直接使用晶体的最小重复单元——**原胞（Primitive Cell）**。

但在反铁磁计算中，原胞往往无法描述磁性周期性。
**示例**：考虑体心立方（BCC）结构的铬（Cr）。
- **晶体学原胞**：只包含 1 个原子。
- **磁性结构**：体心位置原子的磁矩与顶角位置原子的磁矩相反。
- **矛盾**：如果你只使用包含 1 个原子的原胞，你无法告诉 DFT 代码这个原子既是“向上”又是“向下”的。

### 解决方案：构建超胞（Supercell）

为了容纳反平行的磁矩排列（Up-Down），我们必须扩大晶胞，构建**超胞**。

1.  **确定磁性单元**：首先需要根据实验文献或物理直觉，确定反铁磁的排列模式（如 A型、C型、G型反铁磁）。
2.  **扩胞**：使用工具（如 ASE, VESTA 或 Phonopy）将原胞沿特定方向扩充。例如，对于 BCC 结构，通常需要构建一个包含 2 个原子的超胞，或者 $\sqrt{2} \times \sqrt{2} \times 1$ 的结构，以确保晶胞内至少包含两个磁性原子，以便我们将它们分别指定为自旋向上（Spin Up）和自旋向下（Spin Down）。

> **教授提示**：
> 即使某些晶体结构的原胞本身包含多个磁性原子（例如 NiO 的原胞），我们仍需仔细检查这些原子在空间上是否允许反铁磁排列。如果原胞内的原子通过对称性操作关联（Symmetry Equivalent），直接计算可能会强制它们具有相同的磁矩。此时，手动破坏对称性或扩胞是必须的。

---

## 3.2 标记原子与指定相反磁矩

这是反铁磁计算中最关键的一步。我们需要在 `STRU` 文件中明确告诉 ABACUS：哪些原子是“上”，哪些原子是“下”。

### 核心原则：对称性破缺（Symmetry Breaking）

**Critical (关键强调)**：
DFT 的自洽迭代（SCF）通常从用户提供的初始猜测开始。如果你不设置初始磁矩（默认为 0），或者将所有原子磁矩设为相同方向，SCF 很容易收敛到非磁性（NM）或铁磁性（FM）的亚稳态，而无法自发找到反铁磁基态。
**你必须手动设置初始磁矩（Initial Guess）为正负相间的值，以引导 SCF 收敛到 AFM 态。**

### `STRU` 文件设置实战

在 ABACUS 的 `STRU` 文件中，我们通过在原子坐标后添加 `mag` 或 `m` 关键字来指定初始磁矩。

假设我们需要计算一个包含 2 个铁原子的反铁磁构型（虽然 Fe 通常是铁磁的，这里仅作语法演示）：

#### 场景：2 个 Fe 原子，磁矩相反

**文件：STRU**
```plain
ATOMIC_SPECIES
Fe 55.845 Fe_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
2.8665 

LATTICE_VECTORS
1.0 0.0 0.0
0.0 1.0 0.0
0.0 0.0 1.0

ATOMIC_POSITIONS
Direct  // 使用分数坐标
Fe      // 元素标签
0.0     // 初始磁矩 (对该元素所有原子的统一默认值，通常设为0，在下方具体指定)
2       // 原子数量
0.0  0.0  0.0  m  4.0   // 第1个原子：初始磁矩设为 +4.0 Bohr
0.5  0.5  0.5  m -4.0   // 第2个原子：初始磁矩设为 -4.0 Bohr
```

**代码解读**：
- `m` (或 `mag`)：这是 ABACUS 识别初始磁矩的关键字。
- `4.0` 和 `-4.0`：这是初始猜测值。
    - **正值**代表 Spin Up（自旋向上）。
    - **负值**代表 Spin Down（自旋向下）。
    - **数值大小**：建议设置得比预期磁矩稍大一些（例如预期 2.2 $\mu_B$，可以设为 3.0 或 4.0），这有助于产生足够强的交换分裂势，加速收敛。

### 进阶技巧：同种元素，不同标记（Type Splitting）

在极少数复杂情况下，如果仅通过坐标指定磁矩不够清晰，或者你想对不同自旋方向的同种元素使用不同的赝势（极其罕见），你可以将同一种元素标记为不同类型。

**文件：STRU (替代方案)**
```plain
ATOMIC_SPECIES
Fe_u 55.845 Fe.upf  // 逻辑上的 Fe_up
Fe_d 55.845 Fe.upf  // 逻辑上的 Fe_down

...

ATOMIC_POSITIONS
Direct
Fe_u
0.0
1
0.0 0.0 0.0 m 4.0

Fe_d
0.0
1
0.5 0.5 0.5 m -4.0
```
*注：通常情况下，推荐使用第一种直接在坐标后加 `m` 的方法，更加简洁且兼容性好。*

---

## 3.3 INPUT 参数清单与计算成本

配置好结构后，`INPUT` 文件的设置与铁磁计算类似，但有几点需要特别注意。

**文件：INPUT**
```plain
INPUT_PARAMETERS
# 基础参数
calculation     scf
basis_type      lcao
ecutwfc         100

# 磁性关键参数
nspin           2      # 开启自旋极化计算 (1=无磁, 2=共线自旋)
# noncolin      0      # 反铁磁通常先尝试共线计算 (默认0)

# 辅助收敛参数 (AFM 较难收敛时建议调整)
mixing_beta     0.2    # 默认 0.7 可能过大，AFM 建议降低至 0.2-0.4
mixing_type     broyden

# 输出设置
out_mul         1      # 输出 Mulliken 电荷与磁矩，用于检查局部磁矩
```

### 关键参数详解

1.  **`nspin 2`**：
    - 必须开启。这告诉 ABACUS 将电子密度分为 $n_{up}(r)$ 和 $n_{down}(r)$ 两个通道分别处理。
    - **计算成本警告**：开启 `nspin 2` 后，Kohn-Sham 方程的求解量加倍。请告知你的团队或导师，计算时间通常是无磁计算（`nspin 1`）的 **1.5 到 2 倍**。

2.  **`mixing_beta`**：
    - 反铁磁态往往是能量曲面上的一个鞍点或较浅的极小值，比铁磁态更难收敛。如果发现 SCF 震荡不收敛，请尝试减小 `mixing_beta`（例如从 0.7 降至 0.2）。

---

## 3.4 结果分析与验证

计算结束后，如何确认你得到的是反铁磁态（AFM），而不是无磁态（NM）？

### 1. 检查总磁矩 (TMAG) 与 绝对磁矩 (AMAG)

查看主输出文件（如 `OUT.ABACUS/running_scf.log` 或屏幕输出）：

*   **TMAG (Total Magnetization)**: 体系的总磁矩。
    *   对于理想 AFM，`TMAG` 应该 **等于或非常接近 0.00**。
*   **AMAG (Absolute Magnetization)**: 体系中各点磁矩绝对值的积分（$\int |n_{up} - n_{down}| dr$）。
    *   对于 AFM，`AMAG` 应该 **显著大于 0**。

**判据表**：
| 状态 | TMAG | AMAG | 结论 |
| :--- | :--- | :--- | :--- |
| **反铁磁 (AFM)** | $\approx 0$ | **很大** (如 > 2.0/atom) | **成功** |
| 无磁 (NM) | $\approx 0$ | $\approx 0$ | 失败 (未极化) |
| 铁磁 (FM) | 很大 | $\approx$ TMAG | 失败 (收敛到 FM) |
| 亚铁磁 (FiM) | 非零小值 | 很大 | 可能是亚铁磁 |

### 2. 检查原子分辨磁矩 (Mulliken Analysis)

如果在 `INPUT` 中设置了 `out_mul 1`，请查看输出目录下的 `mulliken.txt` 文件。

你应当看到类似如下的模式：
```text
Atom  Charge    Mag
1     ...       2.345   <-- 正值 (Up)
2     ...      -2.345   <-- 负值 (Down)
```
如果两个原子的磁矩符号相反且数值相近，说明反铁磁序建立成功。

### 3. 态密度 (DOS) 可视化

在处理 DOS 数据时（通常由 `TDOS` 或 `PDOS` 文件生成），请注意区分自旋通道：
- **Spin 1**: 自旋向上 (Up)
- **Spin 2**: 自旋向下 (Down)

**绘图规范**：
为了直观展示反铁磁性，通常将 **Spin 1 的 DOS 绘制在 Y 轴正半轴**，将 **Spin 2 的 DOS 绘制在 Y 轴负半轴**。
对于完美的 AFM 体系，你会发现上下两部分的图形是**完全对称**的（即 $DOS_{up}(E) = DOS_{down}(E)$），这与铁磁体（上下不对称）形成鲜明对比。

---

**下一章预告**：
当磁矩的方向不再局限于简单的“上”和“下”，而是指向空间任意方向时，我们需要进入更广阔的领域——**第四章：非共线磁性与自旋轨道耦合 (SOC)**。