# ABACUS 自旋极化计算实战：从基础磁序到外场调控

## 前言

欢迎来到《ABACUS 自旋极化计算实战：从基础磁序到外场调控》。

作为国产开源第一性原理计算软件的佼佼者，ABACUS（原子算筹）凭借其独具特色的数值原子轨道（LCAO）基组和高效的平面波（PW）基组，在处理大规模体系和高精度电子结构计算方面展现出显著优势。特别是在磁性材料研究领域，ABACUS 提供了简洁且强大的接口，帮助研究者探索从基础铁磁体到复杂自旋电子学器件的物理本质。

**学习路线图**
本教程旨在为初学者和进阶用户搭建一座从物理理论到数值模拟的桥梁：
1. **理论筑基（第一章）**：建立自旋极化的物理图像，理解对称性破缺与“非磁性陷阱”。
2. **实战起步（第二章）**：以体心立方铁（bcc-Fe）为例，掌握铁磁性计算的标准流程与初始磁矩设置。
3. **进阶挑战（第三章）**：深入反铁磁（AFM）体系，学习如何通过结构建模打破对称性以获得正确的磁性基态。
4. **深度分析（第四章）**：掌握自旋分辨的态密度（DOS）、能带结构（Bands）及电子局域函数（ELF）的提取与可视化。
5. **前沿调控（第五章）**：探索外加电场对磁性体系（如石墨烯纳米带）电子态的调制规律。

**知识体系定位**
在 ABACUS/DFT 的全景知识图谱中，本教程位于“电子结构进阶模块”。它上承基础的非磁性自洽计算（SCF），下启非共线自旋、自旋轨道耦合（SOC）以及更复杂的强关联体系（DFT+U）研究。通过本教程的学习，你将具备处理大多数共线磁性材料计算的能力。

**前置要求**
在开始本教程前，我们建议读者已掌握：
- 基础的 Linux 命令行操作。
- 第一性原理计算的基本概念（如 K 点网格、截断能、自洽迭代）。
- 固体物理中关于能带和磁序的基础知识。

---

# 第一章：自旋极化计算基础与物理图像

在开始真正的 ABACUS 实战计算之前，我们必须先构建正确的物理图像。对于许多初学者来说，最常见的陷阱不是报错，而是程序“成功”运行结束，却输出了一个完全错误的非磁性基态。

本章将带你理解为什么要开启自旋极化（Spin Polarization），开启后对计算资源意味着什么，以及如何避免掉入“非磁性陷阱”。

---

## 1.1 物理概念：自旋、磁序与对称性破缺

在标准的非自旋（Non-spin-polarized）DFT 计算中，我们假设每个空间轨道都被一对自旋相反（自旋向上 $\uparrow$ 和自旋向下 $\downarrow$）的电子占据，且它们的空间波函数完全相同。此时，体系的总磁矩强制为零。

然而，对于过渡金属（如 Fe, Co, Ni）、稀土元素、自由基或某些缺陷体系，自旋向上和自旋向下的电子数并不相等，或者它们在空间上的分布不同。这就需要开启**自旋极化计算**。

### 1.1.1 核心机制：对称性破缺（Symmetry Breaking）
这是本章最重要的概念。

Kohn-Sham 方程的求解是一个自洽迭代（SCF）过程。如果你不告诉程序“这个体系可能有磁性”，程序通常会从一个非磁性的初始电荷密度开始迭代。由于非磁性态通常也是势能面上的一个极值点（虽然可能是鞍点或局域极小值），迭代过程极易“卡”在这个非磁性解上，导致你算出了一个磁矩为 0 的铁原子。

**专家经验法则**：
> **初始磁矩绝对不能设为 0。**
> 必须人为地引入“对称性破缺”。即在计算开始时，通过 `STRU` 文件明确指定原子的初始磁矩（Initial Magnetic Moment），给体系一个初始的“磁性猜测”。哪怕你的猜测值（比如 1.0 $\mu_B$）与最终真实值（比如 2.2 $\mu_B$）不符，这个非零的初始值也是引导 SCF 收敛到磁性基态的关键“火种”。

### 1.1.2 铁磁（FM）与反铁磁（AFM）
- **铁磁 (Ferromagnetic)**: 所有磁性原子的磁矩方向相同。通常在原胞（Primitive Cell）中即可计算。
- **反铁磁 (Anti-Ferromagnetic)**: 相邻原子的磁矩方向相反（如 $\uparrow \downarrow$），总磁矩可能为零，但局部磁矩不为零。

**关于 AFM 的特殊提示**：
反铁磁计算对结构建模有特殊要求。如果晶体的化学原胞中只包含一个磁性原子，你必须构建**超胞（Supercell）**。
*   **原因**: 周期性边界条件强制要求原胞在平移后完全重合。如果原胞里只有一个原子，它不可能既是 Spin-up 又是 Spin-down。
*   **做法**: 扩胞（例如 $2 \times 1 \times 1$），使得超胞内包含两个磁性原子。然后在 `STRU` 文件中，需手动区分这两个原子（即使它们是同一种元素），例如分别标记为 `Fe1` 和 `Fe2`，并分别赋予 `+m` 和 `-m` 的初始磁矩。

---

## 1.2 全局参数设置与计算成本

在 ABACUS 中开启自旋极化非常简单，但它对计算资源的影响是立竿见影的。

### 1.2.1 开启自旋极化 (`INPUT` 文件)

在 `INPUT` 文件中，通过参数 `nspin` 控制自旋模式。

```bash
INPUT_PARAMETERS
# ... 其他参数 ...

# 开启共线自旋极化计算
nspin      2      # 1: 非自旋 (默认); 2: 共线自旋; 4: 非共线自旋(SOC)

# ... 其他参数 ...
```

*   **`nspin 1` (默认)**: 强制自旋简并，$\rho_{\uparrow}(r) = \rho_{\downarrow}(r)$。适用于非磁性半导体、绝缘体或非磁性金属。
*   **`nspin 2`**: 共线自旋极化（Collinear Spin-polarized）。电子密度分为 $\rho_{\uparrow}$ 和 $\rho_{\downarrow}$ 两部分独立处理。适用于大多数铁磁、反铁磁材料。

### 1.2.2 计算成本分析
当你设置 `nspin 2` 后，请务必调整你对计算时间的预期：

1.  **Kohn-Sham 方程加倍**: 程序需要分别求解自旋向上和自旋向下的哈密顿量矩阵。
2.  **内存消耗增加**: 存储波函数和电荷密度的数组大小几乎翻倍。
3.  **时间成本**:
    > **计算耗时 $\approx$ 2 倍于非自旋计算**。
    > 在申请超算机时或规划任务排队时，请务必将此因素考虑在内。

### 1.2.3 结果数据的物理图像
计算完成后，ABACUS 会输出针对两个自旋通道的数据。在后处理（如绘制态密度 DOS 或能带结构）时，请注意区分：

*   **Spin 1 (or Up)**: 自旋向上通道。
*   **Spin 2 (or Down)**: 自旋向下通道。

**绘图惯例**:
为了直观展示磁性，学术界通用的绘图标准是：
- 将 **Spin 1 (Up)** 的 DOS 绘制在 Y 轴**正半轴**。
- 将 **Spin 2 (Down)** 的 DOS 绘制在 Y 轴**负半轴**。
- 如果上下对称，说明体系最终收敛到了非磁性态（净磁矩为 0）；如果不对称，则存在净磁矩。

---

### 本章小结
1.  **必须打破对称性**: 计算磁性体系，必须在 `STRU` 中提供非零的初始磁矩猜测，否则极易得到错误的非磁性解。
2.  **AFM 需扩胞**: 反铁磁计算通常需要构建超胞，并手动设置正负交替的磁矩。
3.  **资源预估**: 开启 `nspin 2` 后，计算时间约为原来的 2 倍。

在下一章中，我们将进入实战环节，手把手教你编写 `STRU` 文件中的磁矩设置以及处理具体的输入文件。

# 第二章：铁磁性 (Ferromagnetism) 计算实战

在掌握了基本的非磁性计算后，我们将进入材料计算中极为重要的一环——磁性计算。本章将以最经典的 **bcc-Fe（体心立方铁）** 为例，带你完成从结构建模、参数设置到结果分析的完整流程。

这是所有自旋极化（Spin-polarized）计算的起点。无论你未来是研究反铁磁、亚铁磁，还是复杂的非共线磁性，本章的逻辑都是通用的基石。

---

## 2.1 结构文件与初始磁矩设置 (`STRU`)

在非磁性计算中，我们只关心原子的位置。但在磁性计算中，我们必须告诉 DFT 求解器：“这个原子是有磁性的”。这需要通过打破体系的自旋对称性来实现。

### 核心概念：对称性破缺
**这是新手最容易踩的坑**：如果你不显式地指定一个非零的初始磁矩，DFT 的自洽迭代（SCF）通常会从“零磁矩”开始猜测。由于数值稳定性，体系往往会陷入非磁性（Non-magnetic, NM）的局部极小值，导致你得到错误的结果（磁矩为 0）。

**必须手动设置初始磁矩，引导体系进入铁磁态。**

### `STRU` 文件编写
我们需要在 `ATOMIC_POSITIONS` 区块中，为 Fe 原子添加磁矩描述。

**文件名**: `STRU`

```abacus
ATOMIC_SPECIES
Fe 55.845 Fe_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
1.8897261258  // 1.8897 Bohr approx 1 Angstrom, check your scaling

LATTICE_VECTORS
-1.433   1.433  1.433
 1.433 -1.433  1.433
 1.433  1.433 -1.433

ATOMIC_POSITIONS
Direct

Fe
0.0
1
0.000000 0.000000 0.000000 m 0.0 0.0 3.0
```

### 语法详解
在 `ATOMIC_POSITIONS` 中，原子坐标后的 `m` 关键字用于设定初始磁矩（Initial Magnetic Moment）：

- **语法**: `x y z m start_mag_x start_mag_y start_mag_z`
- **参数解释**:
    - `m`: 标记关键字，表示后面紧跟的是磁矩设置。
    - `0.0 0.0 3.0`: 表示在 x, y, z 方向的初始磁矩分量（单位通常为玻尔磁子 $\mu_B$）。
- **实战建议**:
    - 对于 **共线自旋 (`nspin=2`)** 计算，虽然我们只关心磁矩的大小，但建议习惯性地将其设置在 z 方向（如 `0 0 3`）。
    - **初始值大小**: 不需要非常精确，只需给出一个合理的非零值即可（例如 Fe 的基态磁矩约为 2.2 $\mu_B$，我们可以设为 3.0 或 2.5）。SCF 迭代会自动优化到真实值。

---

## 2.2 输入参数设置 (`INPUT`)

在 `INPUT` 文件中，我们需要开启自旋极化开关，并调整一些有助于磁性收敛的参数。

**文件名**: `INPUT`

```abacus
INPUT_PARAMETERS
# 1. 基础参数
suffix          Fe_ferro
calculation     scf
basis_type      lcao
symmetry        1

# 2. 磁性关键参数 (Critical)
nspin           2           # 开启自旋极化 (1=非磁, 2=共线自旋)

# 3. 电子结构与收敛控制
ecutwfc         100
scf_thr         1.0e-6
scf_nmax        100
smearing_method gauss
smearing_sigma  0.01

# 4. 混合算法 (Mixing) - 磁性计算推荐设置
mixing_type     broyden
mixing_beta     0.2         # 磁性体系建议调小该值 (默认0.7可能导致震荡)
```

### 关键参数详解

1.  **`nspin 2`**:
    - **含义**: 开启共线自旋极化计算（Collinear Spin-polarized calculation）。
    - **物理图景**: 此时 Kohn-Sham 方程会对 **Spin Up (自旋向上)** 和 **Spin Down (自旋向下)** 的电子分别进行求解。
    - **计算成本警告**: 由于需要处理两套波函数和电荷密度，开启 `nspin=2` 后，计算时间通常是同等条件下非磁性计算的 **2倍左右**。

2.  **`mixing_beta 0.2`**:
    - **实战经验**: 磁性体系（尤其是金属）在 SCF 迭代过程中，电荷密度和自旋密度容易发生“晃动”（Sloshing）。将混合参数（mixing beta）从默认的 0.7 降低到 0.2 或 0.3，可以显著提高收敛的稳定性，尽管这可能会增加迭代步数。

---

## 2.3 运行计算与结果分析

运行 ABACUS（例如 `mpirun -np 4 abacus`）后，我们需要检查输出文件以确认计算是否成功。

### 1. 检查收敛性 (`running_scf.log`)
打开日志文件，关注每一次迭代的 `total mag`（总磁矩）变化。

```text
...
ELEM   1     -1.643210e+03      1.2345e-02     2.5000    <-- 初始猜测
...
ELEM  15     -1.645880e+03      5.6789e-07     2.2105    <-- 收敛值
```
- **Total Magnetism**: 最终收敛的值应接近实验值或理论值。对于 bcc-Fe，每个原子的磁矩应在 **2.2 $\mu_B$** 左右。
- **如果最终磁矩为 0**:
    - 检查 `STRU` 中是否漏写了 `m` 参数。
    - 检查 `INPUT` 中是否漏写了 `nspin 2`。
    - 尝试增大初始磁矩猜测值（例如从 3.0 改为 5.0），或者进一步减小 `mixing_beta`。

### 2. 电子态密度 (DOS) 的后处理
在磁性计算中，DOS 的输出文件通常会分为两部分（取决于后处理工具或 `TDOS` 文件格式）：
- **Spin 1 (Up)**: 多数自旋通道。
- **Spin 2 (Down)**: 少数自旋通道。

**绘图提示**: 为了直观展示铁磁性，绘图时通常将 **Spin 2 (Down)** 的 DOS 数值乘以 **-1**，绘制在 X 轴下方。这样可以清晰地看到自旋向上和向下的不对称性（即净磁矩的来源）。

---

## 2.4 进阶提示：反铁磁 (AFM) 与其他情况

虽然本章聚焦于铁磁性，但在实际科研中，你经常会遇到反铁磁（Antiferromagnetic, AFM）情况。

### 1. 反铁磁 (AFM) 计算策略
反铁磁材料的总磁矩为 0，但局部原子磁矩不为 0（例如 Fe1 为 +m，Fe2 为 -m）。
- **超胞 (Supercell)**: 如果原胞只包含 1 个磁性原子，你**必须**构建超胞（Supercell），使其至少包含 2 个磁性原子，以便容纳反平行的磁矩排列。
- **`STRU` 设置**: 需要手动指定不同原子的磁矩方向。
    ```abacus
    ATOMIC_POSITIONS
    ...
    Fe
    0.0 0.0 0.0 m  0.0 0.0  3.0  // Fe1: Spin Up
    0.5 0.5 0.5 m  0.0 0.0 -3.0  // Fe2: Spin Down
    ```

### 2. 赝势的选择
进行磁性计算时，请确保使用的赝势（Pseudopotential）支持自旋极化计算（通常标准的 PBE/LDA 赝势都支持，但需注意价电子排布是否包含产生磁性的 d 轨道或 f 轨道）。

---

**本章总结**:
1.  **`nspin 2`** 是开启磁性计算的总开关。
2.  在 **`STRU`** 中使用 **`m`** 关键字设置非零初始磁矩是打破对称性的关键。
3.  磁性计算成本较高，且对混合参数 **`mixing_beta`** 敏感。

下一章，我们将讨论如何通过 ABACUS 进行结构优化（Relaxation），让原子的位置和晶格常数找到能量最低点。

# 第三章：反铁磁性 (Antiferromagnetism) 进阶设置

在上一章中，我们掌握了铁磁性（Ferromagnetism, FM）的计算方法，即体系中所有磁性原子的磁矩方向一致。然而，在实际材料研究中，**反铁磁性（Antiferromagnetism, AFM）** 是一种更为普遍且极具挑战性的磁序状态。

反铁磁材料的宏观总磁矩通常为零，但在微观尺度上，相邻原子的磁矩呈反平行排列。这种“宏观无磁，微观有序”的特性，使得 AFM 计算在结构建模和初始参数设置上比 FM 复杂得多。

本章将指导你如何在 ABACUS 中构建反铁磁模型，并打破体系的对称性以获得正确的磁性基态。

---

## 3.1 反铁磁的结构建模策略

### 为什么单胞（Primitive Cell）往往不够用？

在计算铁磁性时，由于所有原子磁矩方向相同，我们通常可以直接使用晶体的最小重复单元——**原胞（Primitive Cell）**。

但在反铁磁计算中，原胞往往无法描述磁性周期性。
**示例**：考虑体心立方（BCC）结构的铬（Cr）。
- **晶体学原胞**：只包含 1 个原子。
- **磁性结构**：体心位置原子的磁矩与顶角位置原子的磁矩相反。
- **矛盾**：如果你只使用包含 1 个原子的原胞，你无法告诉 DFT 代码这个原子既是“向上”又是“向下”的。

### 解决方案：构建超胞（Supercell）

为了容纳反平行的磁矩排列（Up-Down），我们必须扩大晶胞，构建**超胞**。

1.  **确定磁性单元**：首先需要根据实验文献或物理直觉，确定反铁磁的排列模式（如 A型、C型、G型反铁磁）。
2.  **扩胞**：使用工具（如 ASE, VESTA 或 Phonopy）将原胞沿特定方向扩充。例如，对于 BCC 结构，通常需要构建一个包含 2 个原子的超胞，或者 $\sqrt{2} \times \sqrt{2} \times 1$ 的结构，以确保晶胞内至少包含两个磁性原子，以便我们将它们分别指定为自旋向上（Spin Up）和自旋向下（Spin Down）。

> **教授提示**：
> 即使某些晶体结构的原胞本身包含多个磁性原子（例如 NiO 的原胞），我们仍需仔细检查这些原子在空间上是否允许反铁磁排列。如果原胞内的原子通过对称性操作关联（Symmetry Equivalent），直接计算可能会强制它们具有相同的磁矩。此时，手动破坏对称性或扩胞是必须的。

---

## 3.2 标记原子与指定相反磁矩

这是反铁磁计算中最关键的一步。我们需要在 `STRU` 文件中明确告诉 ABACUS：哪些原子是“上”，哪些原子是“下”。

### 核心原则：对称性破缺（Symmetry Breaking）

**Critical (关键强调)**：
DFT 的自洽迭代（SCF）通常从用户提供的初始猜测开始。如果你不设置初始磁矩（默认为 0），或者将所有原子磁矩设为相同方向，SCF 很容易收敛到非磁性（NM）或铁磁性（FM）的亚稳态，而无法自发找到反铁磁基态。
**你必须手动设置初始磁矩（Initial Guess）为正负相间的值，以引导 SCF 收敛到 AFM 态。**

### `STRU` 文件设置实战

在 ABACUS 的 `STRU` 文件中，我们通过在原子坐标后添加 `mag` 或 `m` 关键字来指定初始磁矩。

假设我们需要计算一个包含 2 个铁原子的反铁磁构型（虽然 Fe 通常是铁磁的，这里仅作语法演示）：

#### 场景：2 个 Fe 原子，磁矩相反

**文件：STRU**
```plain
ATOMIC_SPECIES
Fe 55.845 Fe_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
2.8665 

LATTICE_VECTORS
1.0 0.0 0.0
0.0 1.0 0.0
0.0 0.0 1.0

ATOMIC_POSITIONS
Direct  // 使用分数坐标
Fe      // 元素标签
0.0     // 初始磁矩 (对该元素所有原子的统一默认值，通常设为0，在下方具体指定)
2       // 原子数量
0.0  0.0  0.0  m  4.0   // 第1个原子：初始磁矩设为 +4.0 Bohr
0.5  0.5  0.5  m -4.0   // 第2个原子：初始磁矩设为 -4.0 Bohr
```

**代码解读**：
- `m` (或 `mag`)：这是 ABACUS 识别初始磁矩的关键字。
- `4.0` 和 `-4.0`：这是初始猜测值。
    - **正值**代表 Spin Up（自旋向上）。
    - **负值**代表 Spin Down（自旋向下）。
    - **数值大小**：建议设置得比预期磁矩稍大一些（例如预期 2.2 $\mu_B$，可以设为 3.0 或 4.0），这有助于产生足够强的交换分裂势，加速收敛。

### 进阶技巧：同种元素，不同标记（Type Splitting）

在极少数复杂情况下，如果仅通过坐标指定磁矩不够清晰，或者你想对不同自旋方向的同种元素使用不同的赝势（极其罕见），你可以将同一种元素标记为不同类型。

**文件：STRU (替代方案)**
```plain
ATOMIC_SPECIES
Fe_u 55.845 Fe.upf  // 逻辑上的 Fe_up
Fe_d 55.845 Fe.upf  // 逻辑上的 Fe_down

...

ATOMIC_POSITIONS
Direct
Fe_u
0.0
1
0.0 0.0 0.0 m 4.0

Fe_d
0.0
1
0.5 0.5 0.5 m -4.0
```
*注：通常情况下，推荐使用第一种直接在坐标后加 `m` 的方法，更加简洁且兼容性好。*

---

## 3.3 INPUT 参数清单与计算成本

配置好结构后，`INPUT` 文件的设置与铁磁计算类似，但有几点需要特别注意。

**文件：INPUT**
```plain
INPUT_PARAMETERS
# 基础参数
calculation     scf
basis_type      lcao
ecutwfc         100

# 磁性关键参数
nspin           2      # 开启自旋极化计算 (1=无磁, 2=共线自旋)
# noncolin      0      # 反铁磁通常先尝试共线计算 (默认0)

# 辅助收敛参数 (AFM 较难收敛时建议调整)
mixing_beta     0.2    # 默认 0.7 可能过大，AFM 建议降低至 0.2-0.4
mixing_type     broyden

# 输出设置
out_mul         1      # 输出 Mulliken 电荷与磁矩，用于检查局部磁矩
```

### 关键参数详解

1.  **`nspin 2`**：
    - 必须开启。这告诉 ABACUS 将电子密度分为 $n_{up}(r)$ 和 $n_{down}(r)$ 两个通道分别处理。
    - **计算成本警告**：开启 `nspin 2` 后，Kohn-Sham 方程的求解量加倍。请告知你的团队或导师，计算时间通常是无磁计算（`nspin 1`）的 **1.5 到 2 倍**。

2.  **`mixing_beta`**：
    - 反铁磁态往往是能量曲面上的一个鞍点或较浅的极小值，比铁磁态更难收敛。如果发现 SCF 震荡不收敛，请尝试减小 `mixing_beta`（例如从 0.7 降至 0.2）。

---

## 3.4 结果分析与验证

计算结束后，如何确认你得到的是反铁磁态（AFM），而不是无磁态（NM）？

### 1. 检查总磁矩 (TMAG) 与 绝对磁矩 (AMAG)

查看主输出文件（如 `OUT.ABACUS/running_scf.log` 或屏幕输出）：

*   **TMAG (Total Magnetization)**: 体系的总磁矩。
    *   对于理想 AFM，`TMAG` 应该 **等于或非常接近 0.00**。
*   **AMAG (Absolute Magnetization)**: 体系中各点磁矩绝对值的积分（$\int |n_{up} - n_{down}| dr$）。
    *   对于 AFM，`AMAG` 应该 **显著大于 0**。

**判据表**：
| 状态 | TMAG | AMAG | 结论 |
| :--- | :--- | :--- | :--- |
| **反铁磁 (AFM)** | $\approx 0$ | **很大** (如 > 2.0/atom) | **成功** |
| 无磁 (NM) | $\approx 0$ | $\approx 0$ | 失败 (未极化) |
| 铁磁 (FM) | 很大 | $\approx$ TMAG | 失败 (收敛到 FM) |
| 亚铁磁 (FiM) | 非零小值 | 很大 | 可能是亚铁磁 |

### 2. 检查原子分辨磁矩 (Mulliken Analysis)

如果在 `INPUT` 中设置了 `out_mul 1`，请查看输出目录下的 `mulliken.txt` 文件。

你应当看到类似如下的模式：
```text
Atom  Charge    Mag
1     ...       2.345   <-- 正值 (Up)
2     ...      -2.345   <-- 负值 (Down)
```
如果两个原子的磁矩符号相反且数值相近，说明反铁磁序建立成功。

### 3. 态密度 (DOS) 可视化

在处理 DOS 数据时（通常由 `TDOS` 或 `PDOS` 文件生成），请注意区分自旋通道：
- **Spin 1**: 自旋向上 (Up)
- **Spin 2**: 自旋向下 (Down)

**绘图规范**：
为了直观展示反铁磁性，通常将 **Spin 1 的 DOS 绘制在 Y 轴正半轴**，将 **Spin 2 的 DOS 绘制在 Y 轴负半轴**。
对于完美的 AFM 体系，你会发现上下两部分的图形是**完全对称**的（即 $DOS_{up}(E) = DOS_{down}(E)$），这与铁磁体（上下不对称）形成鲜明对比。

---

**下一章预告**：
当磁矩的方向不再局限于简单的“上”和“下”，而是指向空间任意方向时，我们需要进入更广阔的领域——**第四章：非共线磁性与自旋轨道耦合 (SOC)**。

# 第四章：自旋分辨的电子结构分析

在上一章中，我们可能已经通过自洽计算得到了体系的总磁矩。然而，对于材料物理研究者而言，仅仅知道一个总磁矩数值（例如 "2.0 $\mu_B$"）是远远不够的。我们需要知道这些磁矩是由哪些轨道贡献的？自旋向上和向下的电子在能量空间是如何分布的？是否存在半金属（Half-metal）特性？

本章将深入 ABACUS 的输出文件，指导你如何处理双通道（Two-channel）数据，从态密度（DOS）、能带（Bands）和电子局域函数（ELF）三个维度解析磁性材料的电子结构。

---

## 4.0 计算前的关键检查（Pre-calculation Check）

在进行分析之前，必须确保你的计算是正确的。磁性计算不仅是参数设置的问题，更涉及物理原理的正确应用。

### 1. 对称性破缺与初始磁矩
**这是新手最容易犯的错误**：如果你在 `INPUT` 中开启了 `nspin = 2`，但在 `STRU` 文件中没有设置初始磁矩，或者初始磁矩设为 0，ABACUS 的自洽迭代（SCF）通常会收敛到一个非磁性（Non-magnetic）的解。
*   **物理原因**：DFT 迭代需要一个初始的“对称性破缺”来引导电子密度向磁性基态演化。
*   **操作**：在 `STRU` 文件的 `ATOMIC_POSITIONS` 块中，务必为磁性原子指定非零的初始磁矩。

### 2. 反铁磁（AFM）体系的特殊处理
对于反铁磁材料，总磁矩为 0，但局部磁矩不为 0。
*   **超胞（Supercell）**：如果原胞中只有一个磁性原子，你无法构建反铁磁态（因为它自己不能既是 Up 又是 Down）。必须构建超胞（如 $2 \times 1 \times 1$），使得晶胞内至少包含两个磁性原子。
*   **磁矩设置**：在 `STRU` 中手动设置相反的磁矩方向。
    ```abacus
    ATOMIC_POSITIONS
    Direct
    Fe  0.0  0.0  0.0  mag  4.0  // 自旋向上
    Fe  0.5  0.5  0.5  mag -4.0  // 自旋向下
    ```

### 3. 计算成本预警
开启 `nspin = 2` 后，Kohn-Sham 方程需要对 Spin 1 (Up) 和 Spin 2 (Down) 两个通道分别求解。
*   **时间成本**：计算耗时通常是 `nspin = 1` 的 **2倍** 左右。
*   **内存成本**：波函数和电荷密度的存储需求也会相应增加。

---

## 4.1 自旋态密度 (Spin-Resolved DOS)

态密度（DOS）是分析磁性最直观的工具。在自旋极化计算中，ABACUS 会输出两组 DOS 数据。

### 4.1.1 参数设置与输出文件
在 `INPUT` 文件中确保开启 DOS 计算：
```abacus
calculation  scf
nspin        2      // 开启自旋极化
out_dos      1      // 输出态密度
dos_sigma    0.05   // 高斯展宽宽度 (eV)
```

计算完成后，输出目录（`OUT.suffix/`）下会生成以下关键文件：
*   **`DOS1_smearing.dat`**: 自旋向上（Spin Up / Majority Spin）的态密度。
*   **`DOS2_smearing.dat`**: 自旋向下（Spin Down / Minority Spin）的态密度。

### 4.1.2 数据处理与绘图逻辑
为了直观展示磁性，学术界通用的绘图标准是“镜像 DOS 图”：
1.  **读取数据**：两份文件格式相同，第一列为能量（Energy），第二列为总 DOS（Total DOS）。
2.  **数据变换**：
    *   保持 `DOS1` 的数值不变（正值）。
    *   将 `DOS2` 的数值乘以 **-1**（变为负值）。
3.  **绘图**：以能量为 X 轴，DOS 为 Y 轴。
    *   $Y > 0$ 区域代表 Spin Up。
    *   $Y < 0$ 区域代表 Spin Down。

### 4.1.3 物理分析
观察绘制出的镜像 DOS 图：
*   **非磁性**：上下完全对称（镜像重合）。
*   **铁磁性（FM）**：上下不对称，且费米面处的积分差值对应总磁矩。
*   **半金属（Half-metal）**：一个通道在费米面处有 DOS（导电），另一个通道在费米面处 DOS 为 0（绝缘）。这是自旋电子学器件的理想特性。

---

## 4.2 自旋能带结构 (Spin-Resolved Bands)

能带结构描述了电子在动量空间（k空间）的色散关系。磁性会导致能带发生交换分裂（Exchange Splitting）。

### 4.2.1 参数设置与输出文件
在 `INPUT` 文件中设置：
```abacus
calculation  scf    // 先做 scf
// ... 完成后修改为 ...
calculation  nscf   // 非自洽计算用于画能带
nspin        2
out_band     1      // 输出能带
```
*注意：能带计算通常需要指定高对称点路径（在 `KPT` 文件中设置）。*

输出文件通常为：
*   **`BANDS_1.dat`**: 自旋向上能带数据。
*   **`BANDS_2.dat`**: 自旋向下能带数据。

### 4.2.2 数据可视化
使用 ABACUS 提供的辅助脚本（如 `gene_band_dat.py`，如果你的版本包含此工具）或自行编写 Python 脚本处理数据。

**绘图策略**：
*   通常将 Spin Up 绘制为红色实线，Spin Down 绘制为蓝色虚线（或反之）。
*   将两条能带画在同一张图上进行对比。

### 4.2.3 关键特征分析
1.  **能带分裂**：观察同一轨道的能带在能量轴上的错位。分裂的大小反映了交换相互作用的强弱。
2.  **半金属特性识别**：
    *   检查费米能级（$E_F$）是否穿过某一自旋通道的能带。
    *   **Case A**: Spin Up 穿过 $E_F$（金属），Spin Down 在 $E_F$ 处有带隙（半导体/绝缘体） $\rightarrow$ **半金属**。
    *   **Case B**: 两者都穿过 $E_F$ $\rightarrow$ **铁磁金属**。
    *   **Case C**: 两者都有带隙 $\rightarrow$ **磁性半导体/绝缘体**。

---

## 4.3 实空间分析：电子局域函数 (ELF)

除了能量和动量空间，我们还可以在实空间（Real Space）观察自旋分布。电子局域函数（ELF）可以帮助我们理解成键性质和孤对电子分布。

### 4.3.1 参数设置
在 `INPUT` 文件中开启 ELF 输出：
```abacus
out_elf      1
```

### 4.3.2 输出文件解析
当 `nspin = 2` 时，ABACUS 会生成区分自旋的 Cube 文件（文件名可能因版本略有差异，通常如下）：
*   **`ELF_SPIN1.cube`**: 自旋向上电子的局域化程度。
*   **`ELF_SPIN2.cube`**: 自旋向下电子的局域化程度。
*   *(有时也会输出总的 `ELF.cube`)*

### 4.3.3 可视化与分析 (VESTA 实战)
推荐使用 **VESTA** 软件进行可视化：
1.  **导入**：将 `ELF_SPIN1.cube` 拖入 VESTA。
2.  **等值面（Isosurface）**：设置一个较高的等值面数值（如 0.7 或 0.8）。
3.  **对比**：
    *   分别观察 Spin 1 和 Spin 2 的空间分布。
    *   对于磁性原子（如 Fe, Co, Ni），你会发现 $d$ 轨道的 ELF 分布在两个自旋通道中显著不同。
    *   **自旋极化空间分布**：你甚至可以通过工具（如 `chgdiff.py` 脚本，需自备）计算 `CHG_SPIN1.cube` - `CHG_SPIN2.cube` 得到自旋密度差（Spin Density），直接画出“哪里是磁性”的云图。

---

## 总结：数据处理清单

| 分析维度 | 关注文件 (Spin Up) | 关注文件 (Spin Down) | 核心技巧 |
| :--- | :--- | :--- | :--- |
| **DOS** | `DOS1_smearing.dat` | `DOS2_smearing.dat` | Down 通道乘 -1 绘制镜像图 |
| **能带** | `BANDS_1.dat` | `BANDS_2.dat` | 双色叠加绘制，寻找半金属特征 |
| **ELF** | `ELF_SPIN1.cube` | `ELF_SPIN2.cube` | VESTA 等值面分析，对比空间分布差异 |

**专家提示**：在处理所有数据时，请务必确认费米能级（Fermi Energy）的位置。ABACUS 的 `DOS` 文件通常是绝对能量，绘图时建议将能量轴平移，使 $E - E_F = 0$ 位于原点，方便阅读。

# 第五章：外场下的磁性调控 (进阶)

在前面的章节中，我们已经掌握了基本的磁性计算（共线自旋 `nspin=2`）。然而，在实际的自旋电子学（Spintronics）研究中，仅仅得到基态磁性往往是不够的。我们更关注如何通过外部手段（如电场、应力）来**调控**材料的磁性或电子结构。

本章将重点介绍 ABACUS 的进阶功能：**在外加电场下研究磁性体系的能带响应**。我们将以经典的锯齿型石墨烯纳米带（Zigzag Graphene Nanoribbon, ZGNR）为例，展示如何通过电场诱导半导体-金属转变（Half-metallicity）。

---

## 5.1 外加电场设置

在周期性边界条件下施加电场是一个非平凡的问题。ABACUS 采用类似偶极修正（Dipole Correction）的方法，在真空层中引入一个锯齿状（Sawtooth）的电势来模拟恒定电场。

### 5.1.1 适用体系与物理图像
*   **适用体系**：必须是**带真空层的表面模型（Slab）**或一维体系。对于三维块体（Bulk）材料，由于周期性边界条件的限制，不能直接施加恒定电场。
*   **物理效应**：外加电场会破坏体系的空间反演对称性，导致能带发生斯塔克分裂（Stark Splitting）。在磁性体系中，这种分裂是自旋依赖的，可能导致自旋向上和向下的能带发生相对位移，从而实现从反铁磁半导体到半金属（Half-metal）的转变。

### 5.1.2 关键输入参数
在 `INPUT` 文件中，通过以下参数控制电场：

| 参数名 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| **`efield_amp`** | Real | 0.0 | **电场强度**。单位为 **a.u. (atomic units)**。注意这是一个标量，表示电场的幅度。 |
| **`efield_dir`** | Integer | 2 | **电场方向**。0: x方向, 1: y方向, 2: z方向。通常沿表面法线方向（即真空层方向）。 |

> **⚠️ 警告：单位陷阱**
> `efield_amp` 的单位是原子单位（Hartree/Bohr）。
> **1 a.u. $\approx$ 51.42 V/Å**。
> 这是一个非常巨大的电场！通常实验中可实现的电场在 $10^{-4}$ 到 $10^{-2}$ a.u. 量级。切勿直接设置为 `1.0`，否则会导致电子“逃逸”到真空中，计算发散。

### 5.1.3 实战案例：ZGNR 的电场调控
假设我们已经构建好了一个 ZGNR 的超胞，并设置了反铁磁基态（见下文 5.2 节）。现在我们施加一个垂直于纳米带轴向的横向电场。

**INPUT 文件示例**：
```bash
INPUT_PARAMETERS
# 基础自旋设置
nspin           2           # 开启自旋极化
ks_solver       genelpa     # 对角化方法

# 电场设置
efield_amp      0.005       # 施加约 0.25 V/A 的电场
efield_dir      1           # 假设纳米带位于 x-z 平面，真空层在 y 方向（根据实际结构调整）

# 迭代控制
scf_nmax        100
mixing_type     pulay
mixing_beta     0.4         # 磁性计算建议适当降低混合因子
```

**预期结果**：
在无电场时，反铁磁的 ZGNR 是有带隙的半导体，且自旋简并。施加电场后，你可以观察到自旋向上和向下的能带发生分裂，带隙减小，甚至在费米面附近出现单一自旋通道的导电态（半金属性）。

---

## 5.2 进阶磁性构建：反铁磁 (AFM) 与 磁矩约束

在研究电场效应前，必须正确构建磁性基态。对于像 ZGNR 这样的体系，基态通常是边缘反铁磁性（AFM），即一侧边缘自旋向上，另一侧向下。

### 5.2.1 反铁磁 (AFM) 的构建逻辑
ABACUS 计算 AFM 态时，必须满足以下两个条件：
1.  **超胞 (Supercell)**：如果原胞中只有一个磁性原子，必须扩胞（如 $2 \times 1 \times 1$），使得晶胞内至少包含两个磁性原子，以便容纳 $\uparrow$ 和 $\downarrow$ 的排列。
2.  **对称性破缺 (Symmetry Breaking)**：必须在初始时刻手动指定原子的磁矩方向。

**STRU 文件设置示例**：
在 `STRU` 文件中，我们可以为不同原子指定初始磁矩 `magmom`。

```bash
ATOMIC_POSITIONS
Direct
# 元素名  x  y  z  magmom
C         0.0  0.0  0.0   magmom  1.0   # 边缘A，自旋向上
C         0.5  0.0  0.0   magmom -1.0   # 边缘B，自旋向下
...(中间的非磁性碳原子可以设为 0)...
```
*(注：具体 `magmom` 的设置格式请以当前使用的 ABACUS 版本文档为准，部分版本可能在 `INPUT` 中通过列表指定)*

### 5.2.2 磁矩约束 (Constrained Magnetism)
有时电场会导致磁矩发生意想不到的翻转。为了稳定计算，或者研究特定磁矩下的能带，我们可以固定总磁矩。

*   **参数**: `nupdown`
*   **功能**: 强制固定体系的总磁矩差值 ($\Delta N = N_{\uparrow} - N_{\downarrow}$)。
*   **示例**:
    ```bash
    nspin      2
    nupdown    0.0    # 强制总磁矩为0（适用于反铁磁计算，防止漂移到铁磁态）
    ```

---

## 附录：常见问题与排错指南

在进行外场磁性计算时，初学者极易遇到以下陷阱，请务必仔细检查：

### Q1: 为什么我的计算结果显示没有磁性（磁矩为 0）？
**原因**：**对称性未破缺**。
DFT 的自洽迭代是一个寻找能量极小值的过程。如果你在 `INPUT` 或 `STRU` 中没有设置初始磁矩（默认全为 0），或者初始磁矩设置得太小，体系可能会陷入非磁性（NM）的局部极小值，无法自发演化到磁性基态。
**解决方案**：
*   **必须**设置初始磁矩（如 `magmom 1.0` 或更大），给体系一个“初始推动”。
*   对于反铁磁，务必确认正负磁矩的空间排列是否合理。

### Q2: 开启 `nspin=2` 后计算速度变慢了？
**原因**：**计算成本增加**。
这是正常的物理代价。当设置 `nspin=2` 后，Kohn-Sham 方程需要对 Spin Up 和 Spin Down 两个通道分别求解。
*   **时间成本**：大约是 `nspin=1` 的 **2倍**。
*   **内存成本**：波函数和电荷密度的存储需求也会相应增加。

### Q3: 后处理时文件太多，如何区分？
ABACUS 输出的磁性数据严格区分自旋通道：
*   **能带文件**：
    *   `BANDS_1`: 自旋向上 (Spin Up) 的能带数据。
    *   `BANDS_2`: 自旋向下 (Spin Down) 的能带数据。
*   **态密度 (DOS)**：
    *   `TDOS` / `PDOS` 文件中通常包含两列数据（或两个块）。
    *   **绘图技巧**：为了直观展示磁性，通常将 Spin 1 的 DOS 绘制在正半轴，将 Spin 2 的 DOS 绘制在**负半轴**（即乘以 -1），形成“镜像”图。如果上下完全对称，则为非磁或反铁磁（净磁矩为0）；如果不对称，则存在净磁矩。

### Q4: 电场加多大合适？
**建议**：
*   从极小值开始测试，例如 `0.001` a.u.。
*   逐步增加，观察能带带隙的变化趋势。
*   如果计算不收敛（SCF Oscillating），可能是电场过大导致真空层势垒被击穿，电子溢出。此时应检查真空层厚度是否足够，或减小电场。

---

## 附录：进阶学习指南

恭喜你完成了本教程的学习！磁性材料的计算模拟是一个深邃且充满魅力的领域，本教程所涵盖的内容仅是冰山一角。为了进一步提升研究能力，我们建议你在以下方向继续探索：

### 1. 拓展阅读与进阶主题
- **强关联修正（DFT+U）**：对于过渡金属氧化物或稀土元素，标准的 LDA/GGA 往往会低估带隙。学习如何在 ABACUS 中添加 Hubbard U 参数是处理这类材料的关键。
- **非共线磁性与自旋轨道耦合（SOC）**：如果你关注磁各向异性（MAE）或拓扑磁结构（如斯格明子），需进一步学习 `noncollinear` 参数的相关设置。
- **磁性相变与海森堡模型**：尝试通过计算不同磁序下的总能，拟合交换关联常数 $J$，进而通过蒙特卡洛模拟预测材料的居里温度（Tc）或尼尔温度（Tn）。
- **声子谱计算**：探索磁性对晶格动力学的影响，研究磁弹耦合效应。

### 2. 通用调试建议（Troubleshooting）
- **收敛困境**：磁性计算比非磁性计算更难收敛。若遇到不收敛，可尝试减小 `mixing_beta`，或使用更保守的初始磁矩（mag）。
- **磁矩消失**：如果计算出的磁矩为 0，请检查 `nspin` 是否设置为 2，以及 `STRU` 文件中 `mag` 的初值是否足够大以打破对称性。
- **对称性陷阱**：程序有时会强制保持空间对称性而抑制磁序。在计算复杂的反铁磁时，手动微调原子位置（打破完美对称）往往能收到奇效。

### 3. 官方资源与社区
- **官方文档**：请经常查阅 [ABACUS Documentation](https://abacus.deepmodeling.com/) 获取最新的参数说明。
- **示例仓库**：访问 ABACUS 在 GitHub 的 `examples` 目录，参考 `elf`、`nspin` 等相关算例。
- **DeepModeling 社区**：参与 Bohrium 平台或相关论坛的讨论，与全球开发者共同进步。

科学探索永无止境，愿你能利用 ABACUS 在微观世界中发现更多奥秘！
