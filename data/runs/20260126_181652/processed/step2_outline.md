<!-- META_START -->
# ABACUS 实战教程：DeepMD 训练数据集构建指南

## 前言
- **本书逻辑**: 本教程旨在填补第一性原理计算（DFT）与机器学习势函数（MLFF）训练之间的操作空白。我们将从物理本质出发，明确“数据即代码”的理念，详细拆解如何利用 ABACUS 进行高效的势能面（PES）采样，并利用 `dpdata` 工具链将原始 DFT 数据清洗、转化为 DeepMD 训练所需的标准格式。
- **核心知识点**: 势能面采样策略、ABACUS AIMD 参数配置、标签（Label）生成原理、Force/Virial 关键设置、dpdata 数据清洗与格式转换。

<!-- CHAPTER_START -->
## 第一章：物理原理与工作流综述
**本章逻辑**: 在动手操作前，必须建立正确的物理图像。本章阐述为什么需要 DFT 数据来训练神经网络，以及 ABACUS 在 DeepMD 工作流中的定位，防止初学者混淆“生成数据”与“使用模型”的计算模式。

### Section 1.1: 从 DFT 到神经网络势函数
- **内容**: 解释监督学习在材料计算中的应用。定义“Label（标签）”的物理含义：即 DFT 计算得到的能量（Energy）、受力（Force）和维里（Virial）。阐述势能面（PES）采样的必要性——模型只能预测它“见过”的原子构型。
- **关键参数**: 无。

### Section 1.2: 数据生成工作流概览
- **内容**: 宏观展示数据流向：`STRU` (初始结构) -> `ABACUS AIMD` (构型空间探索) -> `MD Output` (原始数据) -> `dpdata` (清洗与转换) -> `DeepMD Kit` (训练)。重点区分 **DFT 模式**（生产数据）与 **DP 模式**（消耗数据）的区别。
- **关键参数**: 
    - `esolver_type`: 重点强调在数据生成阶段必须设为 `ks` (Kohn-Sham DFT)，严禁设为 `dp`。

<!-- CHAPTER_START -->
## 第二章：ABACUS 势能面采样实战
**本章逻辑**: 这是数据生成的源头。本章详细讲解如何设置 ABACUS 的输入文件，以确保生成的轨迹包含训练 DeepMD 所需的所有高精度物理量。

### Section 2.1: 启动 AIMD 进行构型采样
- **内容**: 讲解如何配置 `INPUT` 文件以运行从头算分子动力学（AIMD）。讨论如何通过温度和步数控制采样范围，确保覆盖目标相空间。
- **关键参数**:
    - `calculation`: `md` (推荐) 或 `scf` (用于静态计算)。
    - `md_dumpfreq`: `1` (确保每一步都输出数据，最大化利用计算资源)。
    - `esolver_type`: `ks`。

### Section 2.2: 开启高精度标签输出 (Force & Stress)
- **内容**: DeepMD 的训练依赖于力和维里张量来优化网络参数。本节详细说明如何强制 ABACUS 输出这些关键信息，并解释丢失这些数据对模型精度的致命影响（如无法预测晶格常数或压强）。
- **关键参数**:
    - `cal_force`: `1` (必须开启，用于训练力场)。
    - `cal_stress`: `1` (必须开启，用于训练维里/压强，特别是涉及晶胞变化的体系)。

### Section 2.3: 电子结构计算的收敛性控制
- **内容**: 讨论在高温 MD 采样中，如何保证每一步 SCF 的收敛性。未收敛的步数会产生“噪声数据”，污染训练集。
- **关键参数**:
    - `scf_nmax`: (建议适当增加以应对高温下的电荷震荡)。
    - `KPT`: (强调生成数据时必须设置 K 点，区别于 DPMD 推理阶段)。

<!-- CHAPTER_START -->
## 第三章：数据清洗与格式转换 (dpdata)
**本章逻辑**: 原始的 ABACUS 输出文件无法直接被 DeepMD 识别。本章介绍如何使用 Python 库 `dpdata` 作为“翻译官”，将 DFT 数据转化为压缩的 NumPy 格式。

### Section 3.1: 使用 dpdata 读取 ABACUS 轨迹
- **内容**: 介绍 `dpdata.LabeledSystem` 类，演示如何正确指向 ABACUS 的 MD 输出目录。处理常见的路径错误和文件依赖问题。
- **关键参数**:
    - `fmt`: `'abacus/md'` (指定读取格式)。
    - 路径参数: 指向包含 `MD_dump` 或相关输出的文件夹。

### Section 3.2: 数据集划分策略 (Train/Validation)
- **内容**: 讲解机器学习的基本原则——训练集与验证集的划分。演示如何通过随机索引抽取（Random Indexing）来分离数据，防止模型过拟合。
- **关键参数**:
    - Python 方法: `np.random.choice` (用于生成验证集索引)。
    - `dpdata` 方法: `sub_system` (用于切分数据集)。

### Section 3.3: 导出 DeepMD 格式
- **内容**: 将处理好的数据对象导出为 `.npy` 格式的目录结构（set.000, type.raw 等），为下一步的模型训练做准备。
- **关键参数**:
    - `dpdata` 方法: `to_deepmd_npy`。

<!-- CHAPTER_START -->
## 第四章：进阶流程——集成到 DP-GEN
**本章逻辑**: 针对大规模生产环境，手工处理数据效率低下。本章简要介绍 ABACUS 如何作为计算引擎（Calculator）嵌入到 DP-GEN 的并发主动学习流程中。

### Section 4.1: DP-GEN 中的 ABACUS 接口配置
- **内容**: 解析 DP-GEN 的 `param.json` 配置文件，说明如何指定 ABACUS 为标注（Labeling）工具。
- **关键参数**:
    - `init_fp_style`: `"ABACUS"`。
    - `stages`: 定义迭代轮次 `[1, 2, 3, 4]`。

### Section 4.2: 目录结构与文件依赖
- **内容**: 说明在自动化流程中，除了 `STRU` 文件外，还需要准备哪些辅助文件才能使 ABACUS 正常运行。
- **关键参数**:
    - 依赖文件: `*.orb`, `*.upf`, `KPT`, `machine.json`。

<!-- APPENDIX_START -->
## 附录：常见陷阱与调试指南
- **数据格式陷阱**: ABACUS 版本更新可能导致输出格式微调，致使 `dpdata` 报错，需检查版本兼容性。
- **物理量缺失**: 再次强调检查 `cal_stress`，这是初学者最容易遗漏导致训练失败的原因。
- **KPT 混淆**: 明确 DFT 采样（需 KPT）与 DPMD 推理（无需 KPT）的区别。
- **收敛性检查**: 建议在 `dpdata` 处理前，编写简单脚本扫描 MD 轨迹的能量曲线，剔除能量异常跳变的坏点。