# 第二章：ABACUS 势能面采样实战

在上一章中，我们完成了 ABACUS 的安装与环境配置。本章我们将进入 DeepMD 势函数训练的核心环节——**数据生成**。

DeepMD 模型的精度上限完全取决于训练数据的质量。如果说神经网络是“大脑”，那么由 ABACUS 生成的从头算分子动力学（AIMD）轨迹就是“教材”。本章将详细讲解如何配置 ABACUS 的 `INPUT` 文件，以运行高精度的 AIMD 模拟，并确保输出包含力（Force）和维里应力（Virial Stress）在内的完整标签数据。

---

## 2.1 启动 AIMD 进行构型采样

为了训练一个能够描述材料在不同温度、不同构型下行为的势函数，我们需要通过分子动力学（MD）来遍历相空间。

### 2.1.1 关键参数配置

在 `INPUT` 文件中，启动 AIMD 的核心参数如下。请务必注意，此时我们是在**生成数据**，因此必须使用 DFT（KS-DFT）作为求解器，而不是使用已经训练好的模型。

**INPUT 文件示例 (MD 部分)**：

```bash
INPUT_PARAMETERS
# ---------------------------
# 1. 计算模式控制
# ---------------------------
calculation     md          # 设定计算类型为分子动力学
esolver_type    ks          # 【关键】使用 Kohn-Sham DFT 求解器。绝对不要设为 dp！

# ---------------------------
# 2. MD 系综与恒温器
# ---------------------------
md_type         nvt         # 系综类型：nvt (正则系综) 或 nve (微正则系综)
md_thermostat   nose-hoover # 恒温器算法 (仅 NVT 需要)
md_nstep        2000        # 采样的总步数
md_dt           1.0         # 时间步长，单位 fs (建议 0.5 - 2.0)

# ---------------------------
# 3. 温度控制 (采样范围)
# ---------------------------
md_tfirst       300         # 初始温度 (K)
md_tlast        300         # 结束温度 (K)
# 提示：为了覆盖更广的相空间，通常需要运行多个不同温度的 MD (如 300K, 600K, 1000K)

# ---------------------------
# 4. 输出频率控制
# ---------------------------
md_dumpfreq     1           # 【关键】每隔多少步输出一次构型信息
md_out_file     1           # 输出 MD 轨迹文件
```

### 2.1.2 参数详解与避坑指南

1.  **`calculation`**: 必须设置为 `md`。如果是进行静态单点能计算（如补充高压下的静态构型），则设置为 `scf`。
2.  **`esolver_type` (核心易错点)**:
    *   **生成数据阶段**: 必须设为 `ks` (默认值) 或 `sdft`。这意味着每一步 MD 的力和能量都是通过求解薛定谔方程（DFT）得到的，这是“真值”。
    *   **使用模型阶段**: 只有在后续使用训练好的 DeepMD 模型进行推理时，才会将其设为 `dp`。**切勿混淆！**
3.  **`md_dumpfreq`**: 建议设置为 `1`。
    *   DFT 计算非常昂贵，每一步的 SCF 自洽都消耗了大量算力。如果设置为 10 或 100，意味着中间计算出的 90% 的高精度数据被丢弃了。为了最大化数据利用率，请务必保留每一步的数据。

---

## 2.2 开启高精度标签输出 (Force & Stress)

DeepMD 的损失函数（Loss Function）通常包含三部分：能量（Energy）、力（Force）和维里（Virial）。默认情况下，ABACUS 可能不会输出应力张量，或者不会将力写入特定的输出格式。

### 2.2.1 强制输出标签

在 `INPUT` 文件中，必须显式开启以下开关：

```bash
INPUT_PARAMETERS
# ... (其他参数)

# ---------------------------
# 标签输出控制
# ---------------------------
cal_force       1           # 【必须】计算并输出原子受力
cal_stress      1           # 【必须】计算并输出晶胞应力 (Virial)
```

### 2.2.2 为什么必须开启 `cal_stress`？

很多初学者认为只有 NPT（恒压）模拟才需要应力，这是错误的。
*   **训练角度**: 即使在 NVT 下采样，晶胞的维里应力张量也包含了原子间相互作用对晶格变形的响应信息。
*   **模型能力**: 如果训练数据中缺乏 Stress 标签，训练出的 DeepMD 模型将**无法准确预测晶格常数、弹性模量或高压相变**。
*   **成本权衡**: 开启 `cal_stress` 会增加少量的计算开销，但对于训练数据的完备性而言，这是绝对值得的。

### 2.2.3 数据输出目录结构

运行完成后，ABACUS 会在 `OUT.${suffix}` 目录下生成数据。对于 `dpdata` 数据转换工具，最关键的目录是 `MD_dump`（或旧版本的类似目录，请以最新文档为准）。

典型的目录结构如下：
```text
Running_Dir/
├── INPUT
├── STRU
├── KPT
├── OUT.my_system/
│   ├── running_md.log
│   └── MD_dump/          <-- dpdata 读取的目标
│       ├── BOX.dat       # 晶胞信息
│       ├── POS.dat       # 坐标信息
│       ├── VEL.dat       # 速度信息
│       ├── FORCE.dat     # 力 (Label)
│       ├── VIRIAL.dat    # 应力 (Label, 需开启 cal_stress)
│       └── ...
```

> **风险提示**: `dpdata` 对 ABACUS 的格式支持依赖于具体的输出文件名。请确保 `cal_force` 和 `cal_stress` 开启后，`MD_dump` 目录下确实生成了 `FORCE.dat` 和 `VIRIAL.dat`。如果缺失，`dpdata` 将无法提取标签。

---

## 2.3 电子结构计算的收敛性控制

在高温 MD（例如 1000K 或 2000K）采样中，原子热运动剧烈，电荷密度震荡严重，极易导致 SCF 不收敛。**未收敛步产生的力和能量是错误的**，这些“噪声数据”一旦进入训练集，会严重破坏模型的精度。

### 2.3.1 增强收敛性的参数策略

建议在 `INPUT` 中针对高温采样进行如下调整：

```bash
INPUT_PARAMETERS
# ... (其他参数)

# ---------------------------
# 电子步收敛控制
# ---------------------------
scf_nmax        100         # 建议增加到 100 或更多 (默认通常为 40-50)
scf_thr         1e-6        # 自洽收敛精度，建议不低于 1e-6 Ry

# ---------------------------
# Smearing (展宽) 设置
# ---------------------------
smearing_method gauss       # 或 mp (Methfessel-Paxton)
smearing_sigma  0.02        # 适当的展宽有助于金属或高温体系收敛 (单位 Ry)

# ---------------------------
# 混合 (Mixing) 设置
# ---------------------------
mixing_type     pulay
mixing_beta     0.4         # 如果不收敛，尝试减小该值 (如 0.2)
```

### 2.3.2 K 点设置 (KPT)

*   **生成数据时**: 必须使用足够密度的 K 点（在 `KPT` 文件中设置）。
    *   虽然 DPMD 模型最终是在实空间运行（类似 Gamma 点），但训练数据的**标签质量**必须基于收敛的 K 点计算。如果使用 Gamma 点采样生成数据，训练出的模型将只能描述 Gamma 点的物理性质，无法准确描述体相材料。
*   **INPUT 关联**: 确保 `basis_type` (如 `lcao` 或 `pw`) 与 `ecutwfc` 设置得当，保证基组层面的收敛。

---

## 2.4 数据集划分策略 (实战建议)

在完成 MD 模拟并获得轨迹后，我们通常使用 `dpdata` 将数据转换为 DeepMD 的 `.npy` 格式。在此阶段，需要注意数据集的划分。

**推荐策略**:
1.  **Shuffle (打乱)**: MD 轨迹具有时间相关性。直接截取前 90% 做训练、后 10% 做验证是不科学的。应当在转换时随机打乱数据。
2.  **划分比例**:
    *   **训练集 (Training Set)**: 用于更新神经网络参数。
    *   **验证集 (Validation Set)**: 用于在训练过程中实时监控过拟合情况。
    *   **示例**: 假设一条轨迹有 2000 帧，可以随机抽取 1800 帧放入 `set.000` (训练)，200 帧放入 `set.001` (验证)。

**总结**:
本章我们完成了 ABACUS 的 `INPUT` 配置，重点在于：
1.  使用 `calculation md` + `esolver_type ks` 运行真值计算。
2.  开启 `cal_force` 和 `cal_stress` 获取完整标签。
3.  通过 `md_dumpfreq 1` 最大化数据产出。

下一章，我们将讲解如何使用 `dpdata` 处理这些原始数据，并正式开始 DeepMD 的训练。