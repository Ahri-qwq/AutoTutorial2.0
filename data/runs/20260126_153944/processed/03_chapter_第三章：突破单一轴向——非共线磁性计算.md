# 第三章：突破单一轴向——非共线磁性计算

在前两章中，我们处理的磁性体系都属于**共线磁性（Collinear Magnetism）**。在这种近似下，我们假设材料中所有原子的磁矩都像指南针一样，要么指向上（Up），要么指向下（Down），且被牢牢锁定在全局坐标系的 Z 轴上。

然而，真实的量子世界远比这复杂。在螺旋磁性材料、斯格明子（Skyrmions）以及许多拓扑材料中，原子磁矩的方向可能指向空间中的任意方向（$S_x, S_y, S_z$）。为了模拟这些物理现象，我们需要解除 Z 轴的锁定，进入**非共线磁性（Non-collinear Magnetism）**的领域。

本章将指导你如何激活 ABACUS 的非共线计算模式，并克服最大的难点：如何正确初始化复杂的磁结构。

---

## 3.1 非共线磁性的定义与激活

### 3.1.1 物理图像：从标量到矢量
在 `nspin = 2`（自旋极化）的计算中，电子密度被分为 $\rho_{up}$ 和 $\rho_{down}$ 两个分量。这本质上是一种**标量**处理方式，我们只关心磁矩的大小和正负，默认忽略了磁矩在 X-Y 平面上的分量。这种处理隐含了一个假设：**体系是磁各向同性的，或者我们人为指定了 Z 轴为量子化轴。**

当我们开启**非共线磁性**时，电子密度不再是简单的两个数，而是一个 $2 \times 2$ 的密度矩阵：
$$
\rho = \begin{pmatrix} \rho_{uu} & \rho_{ud} \\ \rho_{du} & \rho_{dd} \end{pmatrix}
$$
这包含了 1 个电荷密度分量和 3 个自旋磁矩分量（$m_x, m_y, m_z$）。因此，在输入参数中，自旋的自由度（`nspin`）将从 2 变为 4。

这对于计算**拓扑绝缘体**、**外尔半金属**以及**强自旋轨道耦合（SOC）体系**至关重要，因为在这些体系中，自旋方向与晶体动量紧密耦合，不再单一指向 Z 轴。

### 3.1.2 核心参数联动逻辑（逻辑陷阱预警）

这是新手最容易出错的地方。ABACUS 通过 `nspin`、`noncolin` 和 `lspinorb` 三个参数的组合来控制磁性行为。请务必死记下表，避免参数冲突：

| 计算类型 | nspin | noncolin | lspinorb | 物理含义 |
| :--- | :--- | :--- | :--- | :--- |
| **无磁性** | 1 | 0 | 0 | 忽略自旋，仅计算电荷。 |
| **共线磁性** | 2 | 0 | 0 | 磁矩锁定 Z 轴，区分 Up/Down。 |
| **非共线磁性 (无 SOC)** | **4** | **1** | 0 | 磁矩可指向任意方向，但忽略轨道耦合。 |
| **非共线磁性 + SOC** | **4** | **1** | **1** | **最完整的物理图像**，包含磁各向异性。 |

> **⚠️ 教授的特别提醒**：
> 1.  **`nspin` 的变化**：一旦开启 `noncolin = 1`，请务必确认 `nspin` 设置为 4（虽然新版 ABACUS 可能自动修正，但在 INPUT 中显式写出 `nspin 4` 是良好的习惯）。
> 2.  **SOC 的前提**：在 ABACUS 中，计算自旋轨道耦合（SOC）通常需要在非共线模式下进行。如果你只设置 `lspinorb 1` 但忘记开启 `noncolin 1`，计算可能会报错或退化为非预期状态。

### 3.1.3 INPUT 文件示例
假设我们要计算一个具有复杂磁构型的体系（暂不考虑 SOC），`INPUT` 文件的关键部分如下：

```bash
INPUT_PARAMETERS
# ... 基础参数 ...
calculation  scf
basis_type   lcao

# --- 磁性核心设置 ---
nspin        4      # 开启 4 分量密度矩阵
noncolin     1      # 激活非共线磁性
lspinorb     0      # 关闭 SOC (若需要 SOC 则设为 1)

# --- 推荐的收敛参数 ---
# 非共线计算通常比共线计算更难收敛，建议适当降低混合参数
mixing_type  broyden
mixing_beta  0.2    # 推荐从较小值开始 (默认 0.7 可能导致震荡)
```

---

## 3.2 复杂磁结构的初始化 (STRU设置)

开启非共线功能只是第一步。如果你不告诉 ABACUS 每个原子磁矩的具体指向，程序通常会默认初始化为铁磁态（全部指向 Z 轴）或零磁矩，最终收敛到一个平凡的解。

为了模拟反铁磁、螺旋磁性或 120 度阻挫磁性，我们需要在 `STRU` 文件中打破对称性。

### 3.2.1 在 STRU 中定义磁矩矢量
在共线计算中，我们通常在 `ATOMIC_SPECIES` 或 `ATOMIC_POSITIONS` 中使用标量 `mag_moment`。而在非共线计算中，我们需要为每个原子指定一个 **3D 矢量**。

> **🛑 关键风险提示 (Missing Info)**：
> 目前 ABACUS 不同版本对于在 `STRU` 文件中定义非共线磁矩的具体语法（是使用欧拉角 `theta/phi` 还是矢量分量 `px py pz`）可能存在差异。
> 
> **在进行下一步之前，请务必查阅您当前使用的 ABACUS 版本的官方文档（Documentation -> Input Files -> STRU），确认 `mag_moment` 或 `angle1/angle2` 的具体写法。**

以下是一种通用的逻辑描述（以矢量分量为例，这是 DFT 软件常见的定义方式）：

**场景假设**：我们需要在一个六角晶格中设置平面内的 120 度反铁磁结构。我们需要手动计算三个原子的磁矩分量。
*   原子 1: 指向 X 轴 ($1, 0, 0$)
*   原子 2: 旋转 120 度 ($-0.5, \frac{\sqrt{3}}{2}, 0$)
*   原子 3: 旋转 240 度 ($-0.5, -\frac{\sqrt{3}}{2}, 0$)

**STRU 文件示意（概念性描述）**：

```text
ATOMIC_POSITIONS
Direct

Fe # 元素类型
1.0 # 磁矩模长缩放因子 (具体用法需核对文档)
3   # 原子数量

# 坐标 x y z   # 磁矩分量 mx my mz (或 angle theta phi)
0.00 0.00 0.00   1.0  0.0      0.0   # 原子1指向 X
0.50 0.50 0.00  -0.5  0.866    0.0   # 原子2指向 120度
0.00 0.50 0.50  -0.5 -0.866    0.0   # 原子3指向 240度
```

### 3.2.2 初始化的策略
1.  **打破对称性**：非共线计算非常依赖初始猜测。如果初始磁矩全部设为 Z 方向，自洽迭代（SCF）很难自动找到位于 XY 平面的基态。你必须给出一个“非零”的 XY 分量作为诱导。
2.  **模长与方向**：通常建议在初始化时，磁矩模长（Magnitude）设置得比预期值稍大一点，方向设置得尽量接近物理直觉。
3.  **使用工具**：对于包含数十个原子的复杂螺旋磁性结构，手写 `STRU` 非常痛苦且易错。建议使用 Python 脚本生成坐标和磁矩部分。

---

## 3.3 进阶锦囊：连接 TB2J 计算磁性相互作用

当你成功完成了非共线磁性（或共线磁性）的 SCF 计算后，你可能想进一步探究原子间的**海森堡交换相互作用参数 ($J_{ij}$)**、**Dzyaloshinskii-Moriya 相互作用 (DMI)** 或 **磁各向异性 (MAE)**。

ABACUS 提供了与 **TB2J** 软件的无缝接口，这使得基于 LCAO 基组快速计算磁性参数成为可能。

### 3.3.1 激活接口
在 `INPUT` 文件中添加以下参数：

```bash
out_mat_hs2  1  # 输出哈密顿量(H)和重叠矩阵(S)
```

### 3.3.2 工作流示意
1.  **ABACUS SCF 计算**：运行计算，程序会在输出目录（如 `OUT.suffix/`）下生成包含 H 和 S 矩阵的二进制文件。
2.  **TB2J 后处理**：使用 `TB2J` 的 Python 接口读取 ABACUS 的输出，计算 $J_{ij}$ 等参数。

这对于设计新型自旋电子学器件（如磁存储器）的研究者来说，是一个非常强大的功能组合。

---

**本章总结**：
非共线磁性计算开启了模拟真实世界复杂磁结构的大门。请牢记 `nspin 4` + `noncolin 1` 的组合，并在 `STRU` 文件中小心地初始化你的磁矩方向。在下一章中，我们将探讨如何通过“约束磁矩计算”来强制固定这些方向，从而计算磁各向异性态的能量。