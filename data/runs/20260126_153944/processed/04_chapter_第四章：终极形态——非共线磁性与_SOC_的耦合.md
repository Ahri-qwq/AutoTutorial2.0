# 第四章：终极形态——非共线磁性与 SOC 的耦合

欢迎来到 ABACUS 计算的“深水区”。在前几章中，我们处理了共线磁性（Collinear Spin）和基础的电子结构计算。然而，真实的物理世界往往更加复杂且迷人：磁矩可能并不乖乖排列在一条直线上（如斯格明子、阻挫磁性），或者电子的自旋与轨道运动之间存在强烈的耦合（SOC），导致能带发生拓扑相变（如外尔半金属）。

本章我们将解锁 ABACUS 的“终极形态”：**同时开启非共线磁性（Non-collinear Magnetism）与自旋轨道耦合（SOC）**。这是研究拓扑材料、磁各向异性（MAE）以及 Dzyaloshinskii-Moriya 相互作用（DMI）的标准配置。

---

## 4.1 全参数开启：参数组合的逻辑与陷阱

在进入计算之前，我们必须厘清 `INPUT` 文件中三个核心参数的联动关系。这是新手最容易“翻车”的地方。

### 4.1.1 核心参数“三巨头”

要开启“非共线+SOC”计算，你需要同时关注以下三个参数：

1.  **`nspin` (4)**: 
    *   **物理含义**: 设置自旋处理模式。
    *   **区别**: 
        *   `nspin=2`: **共线自旋**。假设所有电子自旋仅在 Z 轴方向上（上或下），忽略 X 和 Y 分量。这是“磁各向同性”假设下的简化处理。
        *   `nspin=4`: **非共线自旋**。此时电荷密度矩阵变为 $2 \times 2$ 的矩阵，包含自旋的各个分量。**只要涉及 SOC 或非共线磁性，必须设为 4**。
2.  **`noncolin` (1)**:
    *   **物理含义**: 非共线磁性开关。
    *   **作用**: 允许原子磁矩指向空间任意方向，不再局限于 Z 轴。
3.  **`lspinorb` (1)**:
    *   **物理含义**: 自旋轨道耦合（SOC）开关。
    *   **作用**: 在哈密顿量中引入 $\hat{L} \cdot \hat{S}$ 项，这对于重元素体系或拓扑材料至关重要。

### 4.1.2 参数组合逻辑表

请务必根据你的物理目标，严格遵守下表的参数组合（参考官方文档逻辑）：

| 物理场景 | `nspin` | `noncolin` | `lspinorb` | 备注 |
| :--- | :---: | :---: | :---: | :--- |
| **普通共线磁性** | 2 | 0 | 0 | 默认 Z 轴方向，无 SOC |
| **共线磁性 + SOC** | 4 | 0 | 1 | 磁矩强制共线，但考虑 SOC 分裂 |
| **非共线磁性 (无 SOC)** | 4 | 1 | 0 | 允许磁矩旋转，但忽略相对论效应 |
| **终极形态 (非共线 + SOC)** | **4** | **1** | **1** | **拓扑、DMI、MAE 研究标配** |

> **⚠️ 专家提示 (Critical Logic)**：
> 很多初学者在做 SOC 计算时忘记将 `nspin` 改为 4，或者在做非共线计算时忘记开启 `noncolin`。虽然新版 ABACUS 在某些设置下会自动推断，但为了输入文件的**可读性**和**鲁棒性**，**强烈建议显式写出这三个参数**。

### 4.1.3 标准 INPUT 模板

```bash
INPUT_PARAMETERS
# ... 基础参数 ...

# --- 磁性与 SOC 核心设置 ---
nspin      4    # 开启旋量计算 (Spinors)
noncolin   1    # 开启非共线磁性
lspinorb   1    # 开启自旋轨道耦合

# --- 推荐的辅助参数 ---
# 在 LCAO 基组下，SOC 计算通常需要更严格的收敛标准
scf_thr    1.0e-7
```

---

## 4.2 磁结构初始化：最易被忽视的 STRU 设置

开启了 `INPUT` 中的开关只是第一步。在非共线计算中，**如何告诉 ABACUS 每个原子初始的磁矩指向**是至关重要的。

在共线计算（`nspin=2`）中，我们通常只在 `ATOM_SPECIES` 里设置一个标量磁矩（如 `mag_per_atom`）。但在非共线计算中，你需要定义磁矩的矢量方向。

> **🛑 风险提示 (Missing Info / Risk Warning)**
>
> **ABACUS 的 `STRU` 文件对于非共线磁矩的初始化有特定的格式要求**（通常涉及欧拉角或 `m_x, m_y, m_z` 矢量分量的具体写法，且不同版本可能存在差异）。
>
> 本教程无法覆盖所有版本的具体语法。**在进行计算前，请务必查阅 ABACUS 官方文档中关于 `STRU` 文件原子属性设置（Atomic Properties）的章节**。
>
> **如果初始化不当，系统可能会收敛到一个错误的局部极小值（例如全部磁矩坍缩回 Z 轴），导致物理分析完全失效。**

**实战建议**：
1.  查阅文档，确认是在 `ATOM_SPECIES` 还是 `ATOM_POSITIONS` 中指定磁矩方向。
2.  对于复杂的磁结构（如螺旋磁性），建议编写 Python 脚本生成 `STRU` 文件。

---

## 4.3 物理应用：磁各向异性与 DMI

开启“终极形态”后，我们可以计算哪些高阶物理量？

### 4.3.1 磁各向异性 (MAE) 计算
磁各向异性决定了磁性材料的“易轴”和“难轴”，是磁存储材料的核心参数。

**计算流程**：
1.  **结构 1**：在 `STRU` 中初始化磁矩指向 Z 轴 (0, 0, 1)，进行 SCF 计算，得到总能量 $E_z$。
2.  **结构 2**：在 `STRU` 中初始化磁矩指向 X 轴 (1, 0, 0)，进行 SCF 计算，得到总能量 $E_x$。
3.  **分析**：$MAE = E_x - E_z$。
    *   若 $MAE > 0$，则 Z 轴为易轴。
    *   注意：MAE 通常非常小（meV 甚至 $\mu$eV 量级），因此要求极高的 `scf_thr` 收敛精度（建议 `1.0e-8`）。

### 4.3.2 拓扑性质与能带分析
在拓扑材料（如磁性拓扑绝缘体、外尔半金属）中，磁矩的方向往往决定了对称性的破缺方式，进而决定拓扑节点的产生或湮灭。

*   **应用场景**：通过旋转磁矩方向（改变 SOC 产生的有效磁场方向），观察能带结构中 Weyl 点的移动或能隙的开合。
*   **关联知识**：此类计算常结合“能带反折叠”（Band Unfolding）技术，以便将超胞的能带投影回原胞布里渊区进行分析。

---

## 4.4 进阶锦囊：连接 TB2J 计算磁性相互作用

如果你需要构建海森堡模型（Heisenberg Model）来研究居里温度或磁振子（Magnons），手动计算各种构型极其繁琐。ABACUS 提供了与 **TB2J** 软件的无缝接口。

TB2J 可以直接利用 ABACUS 的 LCAO 局域轨道波函数，通过格林函数方法计算交换相互作用 $J_{ij}$ 和 DMI 矢量 $\vec{D}_{ij}$。

### 操作步骤：

1.  **准备 INPUT**：
    在非共线 SOC 计算的基础上，增加以下参数：
    ```bash
    # --- TB2J 接口参数 ---
    out_mat_hs2  1  # 输出用于 TB2J 的哈密顿量稀疏矩阵
    ```

2.  **运行 ABACUS**：
    计算完成后，输出目录中会生成包含哈密顿量信息的二进制文件。

3.  **运行 TB2J**：
    使用 TB2J 提供的 `abacus2J` 接口命令（需单独安装 TB2J）：
    ```bash
    # 伪代码示例，具体命令请参考 TB2J 文档
    tb2j_abacus --output_path ./OUT.suffix --efermi [费米能级]
    ```

**优势**：
相比于 Wannier90 插值方法，基于 ABACUS LCAO 的方法无需繁琐的 Wannier 函数构造（Wannierization），对于复杂磁性体系和多原子体系具有极高的效率和鲁棒性。

---

**本章总结**：
开启 `nspin=4`、`noncolin=1` 和 `lspinorb=1` 标志着你已经掌握了 ABACUS 最复杂的电子结构计算模式。这不仅是参数的叠加，更是对物理图像理解的升维。请务必小心处理 `STRU` 中的磁矩初始化，这是通往正确结果的最后一道关卡。