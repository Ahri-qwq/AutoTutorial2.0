# ABACUS 实战指南：晶体结构优化的物理原理与工程实践

## 前言

欢迎开启 ABACUS（Atomic-scale Based Ab-initio Computation Utilities）的探索之旅。作为一款由中国科学家主导开发、在国际上具有重要影响力的第一性原理计算软件，ABACUS 不仅在数值轨道（LCAO）基组和高性能并行效率上展现出卓越的竞争力，更为处理大规模体系的电子结构计算提供了强有力的工具。在材料模拟的实际科研流程中，寻找体系的稳定结构——即结构优化——是后续所有性质计算的基石。本教程旨在通过系统性的实战指导，帮助读者跨越从“理论公式”到“高效模拟”的鸿沟。

### 学习路线图
本教程的逻辑构建遵循从理论到实践、从基础到进阶的螺旋式上升路径：
- **第一章**：建立物理直觉。深入探讨晶胞弛豫背后的势能面（PES）概念，并为 VASP 用户提供平滑迁移的理论参考。
- **第二章**：拆解工程细节。详细解析 ABACUS 核心输入参数，理清电子步（SCF）与离子步之间的嵌套关系。
- **第三章**：传授实战策略。针对初学者易犯的“一步到位”误区，提出工业级的“分步优化法”，显著提升计算任务的稳健性。
- **第四章**：进阶自由度控制。讲解如何通过对称性约束和自由度控制进行“外科手术式”的精确优化，满足复杂科研场景的需求。

### 知识体系定位
在整个 DFT 计算的知识图谱中，本教程位于“基态性质计算”的核心板块。结构优化不仅是能带结构、态密度、力学性质等计算的前置工序，更是检验物理模型正确性的第一道关卡。本教程将 ABACUS 的特有功能（如 LCAO 基组下的力学收敛特性）与通用的计算材料学最佳实践相结合，旨在构建一个完整的结构模拟知识闭环。

### 前置要求
在开始本教程前，我们建议读者具备以下基础：
1. **理论基础**：了解密度泛函理论（DFT）的基本假设及晶体学基础常识（如布拉格点阵、空间群）。
2. **操作环境**：具备基本的 Linux 命令行操作能力，能够完成 ABACUS 的安装与基本运行。
3. **科研直觉**：正如资深研究者的建议，在正式开启大规模计算前，理解计算规模与机时成本的权衡至关重要。

---

# 第一章：晶胞弛豫的物理基础与应用场景

在开启 ABACUS 的计算之旅前，我们必须首先建立正确的物理图景。结构优化（Structural Optimization）并非简单的“让程序跑起来”，而是寻找材料在零温下势能面（Potential Energy Surface, PES）最小值的过程。

本章将深入剖析晶胞弛豫的物理本质，阐述何时需要调整晶格矢量，并提供从 VASP 到 ABACUS 的无缝迁移指南。

## 1.1 从原子弛豫到晶胞弛豫

在 ABACUS 的 `INPUT` 文件中，`calculation` 参数决定了计算的任务类型。对于结构优化，最核心的区别在于是否允许晶胞边界发生形变。

### 1.1.1 原子弛豫 (`calculation = relax`)
此时，晶格矢量 $\mathbf{L}$（即晶胞的形状和体积）被固定，程序仅优化基胞内原子的相对坐标 $\mathbf{x}_i$。
*   **物理目标**：消除原子受力（Force），使 $\mathbf{F}_i = -\nabla_{\mathbf{x}_i} E \to 0$。
*   **适用场景**：表面吸附计算（固定底层原子）、点缺陷能计算（通常固定晶胞体积）、分子动力学前的预平衡。

### 1.1.2 晶胞弛豫 (`calculation = cell-relax`)
此时，原子坐标 $\mathbf{x}_i$ 与晶格矢量 $\mathbf{L}$ 同时被优化。这引入了形变梯度的概念，程序不仅要消除原子受力，还要消除晶胞上的宏观应力（Stress）。
*   **物理目标**：最小化焓（Enthalpy, $H = E + PV$）。在零压下，即最小化总能量且消除应力张量 $\sigma_{\alpha\beta} \to 0$。
*   **适用场景**：寻找材料的平衡晶格常数、高压相变模拟、晶体结构预测。

### 1.1.3 【专家策略】分步优化的必要性
**这是一个新手最容易犯的错误：直接对一个粗糙的初始结构开启 `cell-relax`。**

当初始结构的原子受力很大时，直接变胞会导致晶格剧烈震荡，甚至由于对称性破缺导致结构崩塌。为了提高收敛效率和稳定性，**强烈建议**遵循以下“分步走”策略：

1.  **第一步 (`relax`)**：设置 `calculation = relax`。固定晶胞，先让原子“归位”，消除主要的原子受力。
2.  **第二步 (`cell-relax`)**：读取第一步优化后的原子坐标（`STRU`），设置 `calculation = cell-relax`。此时原子已接近平衡位置，变胞过程将更加平滑且容易收敛。

> **风险提示**：如果电子自洽迭代（SCF）不收敛，计算出的力与应力是毫无物理意义的噪声。在调试结构优化参数前，请优先确保 `scf_thr`（自洽阈值）已达成，且 `smearing` 等电子步参数设置合理。

---

## 1.2 解决的科学问题与参数详解

### 1.2.1 关键参数设置
在 `INPUT` 文件中，以下参数控制着优化的停止标准：

*   **`force_thr_ev`** (单位: eV/Å): 原子受力收敛阈值。
    *   **PW 基组建议**: `0.001` ~ `0.01`。平面波基组精度高，可以追求较小的受力。
    *   **LCAO 基组建议**: `0.01` ~ `0.03`。**注意**：由于原子轨道基组存在基组重叠误差（BSSE）和积分格点精度限制，过分追求极低的受力（如 0.0001）往往会导致计算在最后几步死循环，无法收敛，且对物理结果的改善微乎其微。
*   **`stress_thr`** (单位: kBar): 应力收敛阈值。通常设置为 `1` 到 `10` kBar（1 kBar $\approx$ 0.1 GPa）。
*   **`relax_nmax`**: 最大离子步数。建议设置为 `100` 或更高，防止未收敛即意外终止。

### 1.2.2 VASP 用户迁移指南 (ISIF 对照表)
对于熟悉 VASP 的用户，`ISIF` 参数控制了自由度。在 ABACUS 中，我们通过组合 `calculation` 和约束参数来实现相同的功能。

| VASP ISIF | 物理含义 | ABACUS 对应设置 (`INPUT` 文件) |
| :--- | :--- | :--- |
| **ISIF = 2** | 固定晶胞，优化原子 | `calculation = relax`<br>`cal_stress = 1` (可选，仅计算应力但不优化) |
| **ISIF = 3** | 全优化 (原子+晶胞形状+体积) | `calculation = cell-relax` |
| **ISIF = 4** | 优化原子+晶胞形状 (固定体积) | `calculation = cell-relax`<br>`fixed_axes = volume` |
| **ISIF = 7** | 优化原子 (固定晶胞形状和体积) | *注：ABACUS 中通常对应 `relax`，若需特殊约束需配合 `fixed_axes`* |

> **说明**: `fixed_axes` 等参数的具体用法将在后续高级章节详细介绍，初学者主要关注 `relax` (ISIF=2) 和 `cell-relax` (ISIF=3) 即可。

### 1.2.3 实战代码示例
假设我们要优化一个 Ba (钡) 金属的晶胞，以下是一个标准的 `cell-relax` 输入示例：

**INPUT 文件示例**：
```bash
INPUT_PARAMETERS
# 基础参数
suffix          Ba_opt
calculation     cell-relax    # 对应 VASP ISIF=3
symmetry        1             # 开启对称性分析，加速计算

# 电子步参数 (SCF)
basis_type      pw            # 使用平面波基组
ecutwfc         60            # 截断能 (Ry)
scf_thr         1e-6          # 电子自洽精度，建议比结构优化精度高2个数量级

# 离子步参数 (Relaxation)
force_thr_ev    0.01          # 力收敛阈值 (eV/Angstrom)
stress_thr      2             # 应力收敛阈值 (kBar)
relax_nmax      100           # 最大离子步数
out_stru        1             # 输出每一步的结构文件
```

通过本章的学习，你应该已经理解了晶胞弛豫的物理意义，并掌握了避免常见陷阱（如直接变胞、LCAO 精度设置过高）的方法。下一章，我们将正式进入实操环节。

# 第二章：标准晶胞优化流程与参数详解

这是《ABACUS 实战教程》的第二章。在本章中，我们将深入探讨如何正确、高效地进行晶胞优化。

结构优化是第一性原理计算的基石。一个未弛豫的结构会导致错误的能带、虚频的声子谱以及不可靠的力学性质。不同于简单的单点能计算，晶胞优化（Cell Relaxation）涉及电子步（SCF）与离子步（Geometry Optimization）的双重循环，对参数设置的物理直觉要求极高。

---

## 第二章：标准晶胞优化流程与参数详解

### 2.1 核心输入参数配置：从 Relax 到 Cell-Relax

在 ABACUS 中，结构优化主要分为两类：
1.  **原子位置优化 (`relax`)**：固定晶格常数和形状，仅移动原子位置。
2.  **全结构优化 (`cell-relax`)**：原子位置与晶胞形状/体积同时优化。

#### 2.1.1 核心参数速查
在 `INPUT` 文件中，以下参数控制着优化的行为：

| 参数名 | 推荐值/类型 | 物理含义 |
| :--- | :--- | :--- |
| **`calculation`** | `cell-relax` | 开启全结构优化模式（原子+晶胞）。 |
| **`relax_nmax`** | `100` ~ `200` | 最大离子步数。若超过此步数仍未收敛，计算将停止。建议设置得稍大一些，避免在即将收敛时中断。 |
| **`out_stru`** | `1` | **必填**。设置为 1 时，ABACUS 会在每个离子步输出结构文件，并在计算结束时生成 `STRU_ION_D`。这是你进行后续计算（如能带、DOS）的新起点。 |
| **`cal_force`** | `1` | 计算原子受力（`cell-relax` 模式下默认开启，显式写出是个好习惯）。 |
| **`cal_stress`** | `1` | 计算应力张量（`cell-relax` 模式下必须开启，用于驱动晶胞形变）。 |

#### 2.1.2 专家策略：分步优化法（Step-by-Step Optimization）
**这是本教程最关键的建议之一**。

很多初学者喜欢直接对一个粗糙的结构使用 `calculation = cell-relax`。虽然理论上可行，但在实际操作中（特别是 LCAO 基组下），这极易导致：
1.  **SCF 不收敛**：剧烈的晶胞形变导致原子间距过近，电荷密度重叠严重。
2.  **计算效率低**：在远离平衡态时调整晶胞形状，往往是在做无用功。

**最佳实践流程**：
1.  **第一步 (`relax`)**：设置 `calculation = relax`。固定晶胞，先让原子“理顺”内部的化学键。
2.  **第二步 (`cell-relax`)**：读取第一步优化好的结构（将 `STRU_ION_D` 复制为 `STRU`），再开启 `calculation = cell-relax` 进行最终优化。

#### 2.1.3 VASP 用户迁移指南 (ISIF 对照表)
如果你熟悉 VASP，下表可以帮助你快速建立参数映射关系：

| VASP 参数 | ABACUS 对应设置 | 行为描述 |
| :--- | :--- | :--- |
| `ISIF = 2` | `calculation = relax` | 仅优化原子位置，晶胞固定。 |
| `ISIF = 3` | `calculation = cell-relax` | 全优化（原子位置 + 晶胞体积 + 晶胞形状）。 |
| `ISIF = 7` | *(需配合 `fixed_axes` 等约束)* | 保持体积不变优化（ABACUS 中需通过特定约束实现，非默认行为）。 |

---

### 2.2 收敛精度的权衡：PW 与 LCAO 的不同哲学

结构优化的结束标志是：所有原子的受力小于阈值 **且** 晶胞应力小于阈值。
在 ABACUS 中，这就涉及两个关键参数：`force_thr_ev` 和 `stress_thr`。

#### 2.2.1 力收敛标准 (`force_thr_ev`)
*   **单位**：eV/Angstrom
*   **物理意义**：原子受到的最大残余力。

**基组差异化设置（至关重要）：**

*   **平面波 (PW) 基组**：
    *   由于平面波基组具有平移不变性，原子移动时能量变化非常平滑。
    *   **推荐值**：`0.01` 甚至 `0.001` eV/Ang。你可以追求极高的精度。

*   **原子轨道 (LCAO) 基组**：
    *   **蛋盒效应 (Egg-box Effect)**：在 LCAO 方法中，积分网格是固定的，而原子轨道随原子移动。当原子跨过积分网格线时，会产生数值上的虚假力（类似蛋在蛋盒里滚动）。
    *   **风险提示**：如果你在 LCAO 模式下将 `force_thr_ev` 设置为 `0.001`，计算可能**永远无法收敛**，因为数值噪声本身可能就大于这个阈值。
    *   **推荐值**：`0.03` ~ `0.05` eV/Ang。对于绝大多数物理性质（如能带、力学模量），`0.04` eV/Ang 的精度已经足够。

#### 2.2.2 应力收敛标准 (`stress_thr`)
*   **单位**：**kBar** (注意：1 kBar = 0.1 GPa)
*   **推荐值**：通常设置为 `1` 到 `10` kBar。
    *   对于硬材料（如金刚石、氧化物），`10` kBar 对应的应变已经非常小。
    *   对于软材料（如范德华异质结、分子晶体），可能需要更严格的 `1` kBar。

#### 2.2.3 风险提示：SCF 收敛是前提
**切记**：结构优化的每一步都依赖于电子步（SCF）计算出的力和应力。如果 SCF 没有收敛（例如 `scf_thr` 设置过大，或者电子步震荡），那么计算出的力就是错误的。
*   **诊断**：如果发现结构优化步数极多且能量上下乱跳，请优先检查 `scf_thr` 是否足够小（建议 `1e-6` 或更小），以及 SCF 是否达到收敛精度。

---

### 2.3 施加外压与目标控制

在模拟地核环境、高压相变或薄膜外延生长时，我们需要施加外部压强。

#### 2.3.1 设置目标压强
在 `INPUT` 文件中，通过以下参数设置目标压强（Target Pressure）：

*   **参数名**：`press1`, `press2`, `press3`
*   **单位**：**kBar**
*   **含义**：分别对应晶胞三个主轴方向（xx, yy, zz）的目标压强。

**示例场景**：
1.  **静水压 (Hydrostatic Pressure)**：模拟 10 GPa (100 kBar) 的均匀环境。
    ```
    press1  100
    press2  100
    press3  100
    ```
2.  **单轴压缩 (Uniaxial Compression)**：仅在 Z 方向施加压力。
    ```
    press1  0
    press2  0
    press3  50
    ```

*注：具体的参数名称在不同版本的 ABACUS 中可能略有差异（如部分版本使用 `target_pressure` 统一控制），请务必在运行前查阅您当前使用版本的官方文档 `INPUT` 参数列表。*

---

### 2.4 实战案例：标准优化 INPUT 模板

以下是一个标准的 `INPUT` 文件模板，适用于大多数 LCAO 基组的绝缘体/半导体体系优化。

**文件：INPUT**
```bash
INPUT_PARAMETERS
# 1. 基础信息
suffix          MgO_opt
ntype           2
pseudo_dir      ./
orbital_dir     ./

# 2. 电子步 (SCF) 设置
basis_type      lcao
ecutwfc         100       # 根据赝势建议值设置
scf_thr         1e-7      # 必须比力收敛精度高几个数量级
scf_nmax        100
smearing_method gauss
smearing_sigma  0.01

# 3. 结构优化核心设置 (Cell-Relax)
calculation     cell-relax
relax_nmax      100       # 最大离子步
out_stru        1         # 输出优化后的结构

# 4. 力与应力收敛标准 (LCAO 推荐值)
cal_force       1
cal_stress      1
force_thr_ev    0.04      # LCAO下不要设得太小，避免蛋盒效应
stress_thr      2         # 单位 kBar

# 5. 外部压强 (可选，默认为 0)
# press1        0
# press2        0
# press3        0
```

### 总结
1.  **分步走**：先 `relax` 再 `cell-relax`，磨刀不误砍柴工。
2.  **知进退**：LCAO 基组下，`force_thr_ev` 设置为 `0.04` 是明智的妥协，不要强求 `0.001`。
3.  **看单位**：`stress_thr` 的单位是 kBar，不要和 GPa 搞混。

下一章，我们将讨论如何分析优化后的结果，并处理常见的“优化不收敛”灾难现场。

# 第三章：最佳实践策略——分步优化法

在计算材料学的江湖里，新手和老手的最大区别往往不在于掌握了多少高深的理论，而在于**工作流（Workflow）的稳健性**。

很多初学者在拿到 ABACUS 后，最喜欢做的事情就是直接在 `INPUT` 文件里写上 `calculation = cell-relax`（全结构优化），然后设置一个极高的精度，按下回车，期待第二天早上收获完美的结构。然而，现实往往是残酷的：计算要么在震荡中永不收敛，要么因为晶胞剧烈变形导致 SCF 炸裂。

本章将传授工业界标准的**“分步优化法”**。这不仅是经验之谈，更是基于势能面搜索原理的最佳策略。

---

## 3.1 “先 Relax 后 Cell-Relax” 策略

这是本教程最核心的建议：**永远不要直接对一个未知或粗糙的结构运行 `cell-relax`。**

### 3.1.1 为什么要分步走？

结构优化本质上是在高维势能面上寻找极小值点。
*   **原子位置优化 (`relax`)**：是在固定的“盒子”里调整原子，自由度较少，能量下降快，且不容易因为基组（Basis Set）的变化引入数值噪声。
*   **晶胞优化 (`cell-relax`)**：涉及到“盒子”形状和大小的改变。在平面波（PW）或原子轨道（LCAO）计算中，晶胞的改变会导致基组覆盖范围的变化（Pulay Stress 问题），计算成本高且更容易陷入数值不稳定性。

如果你直接开启 `cell-relax`，当原子受力还非常大（远离平衡位置）时，巨大的应力（Stress）会驱动晶胞剧烈变形，这极易导致 SCF 不收敛，甚至将结构“拉坏”。

### 3.1.2 标准工作流演示

我们推荐的“两步走”策略如下：

#### **第一步：固定晶胞，优化原子 (`relax`)**

目标是将原子“理顺”，消除主要的内应力。

**INPUT 文件设置：**
```bash
INPUT_PARAMETERS
# ... 基础参数 ...
calculation     relax       # 关键：仅优化原子位置，固定晶胞
relax_method    bfgs        # 推荐：BFGS 算法对原子位置优化效率极高
force_thr_ev    0.02        # 第一步不需要太高精度，0.02 eV/Ang 足够
relax_nmax      100
out_stru        1           # 输出优化后的结构
```

运行完成后，检查 `OUT.${suffix}/` 目录下的收敛情况。如果收敛，进行下一步。

#### **第二步：全结构优化 (`cell-relax`)**

使用第一步优化好的结构作为起点，开启晶胞自由度。

**操作流程：**
1.  **继承结构**：将第一步输出的结构文件 `STRU_OUT` 复制并覆盖原有的 `STRU` 文件。
    ```bash
    cp OUT.suffix/STRU_OUT ./STRU
    ```
2.  **修改 INPUT**：
    ```bash
    INPUT_PARAMETERS
    # ... 基础参数 ...
    calculation     cell-relax  # 关键：开启晶胞和原子的全优化
    relax_method    cg          # 针对 cell-relax，ABACUS 内部通常使用 CG 或混合算法
    force_thr_ev    0.01        # 最终精度
    stress_thr      2           # 应力收敛标准，单位 kBar (2 kBar 约等于 0.2 GPa)
    relax_nmax      100
    ```

> **专家提示**：ABACUS 的 `cell-relax` 采用的是**嵌套循环（Nested Loop）**机制。外层循环改变晶胞参数（使用 CG 算法），内层循环在固定新晶胞的情况下优化原子位置（使用 BFGS 或 CG）。这种设计本身就比同时改变所有自由度要稳健，但“手动分步”依然是处理复杂体系的黄金法则。

---

## 3.2 应对收敛困难：排查顺序

当你发现结构优化迟迟不收敛（例如 `force` 在 0.05 左右震荡死活降不下去），请按以下顺序排查。切记：**SCF 不收敛，结构优化毫无意义。**

### 3.2.1 优先级 1：检查电子步（SCF）
结构优化的每一步（Ionic Step）都依赖于电子步（SCF）计算出的力和应力。如果 SCF 只是勉强收敛，或者在震荡，那么计算出的力就是“噪声”，结构优化自然无法收敛。

*   **现象**：SCF 迭代次数经常达到最大值，或者能量波动大。
*   **对策**：
    *   **提高 `scf_thr`**：结构优化时，SCF 精度至少要比力精度高 1-2 个数量级。建议 `scf_thr` 设置为 `1e-6` 或更小。
    *   **调整 Smearing**：对于金属或小带隙体系，必须使用 Smearing。
        *   `smearing_method`: `gaussian` 或 `mp` (Methfessel-Paxton)。
        *   `smearing_sigma`: 适当增大（如 0.02 Ry ~ 0.05 Ry）有助于 SCF 收敛，但需注意物理意义。

### 3.2.2 优先级 2：基组与力精度的匹配（LCAO 特别注意）

这是 LCAO（数值原子轨道）用户最常踩的坑。

*   **PW 基组**：平面波基组完备性好，通常可以追求极高的受力精度（如 `1e-3` eV/Å）。
*   **LCAO 基组**：由于基组的局域性和截断误差，LCAO 存在所谓的“蛋盒效应”（Egg-box effect），即原子在空间移动时能量面会有微小的非物理波动。
    *   **风险提示**：在 LCAO 模式下，**不要盲目追求 `force_thr_ev = 0.001`**。对于大多数 LCAO 基组设置，0.01 eV/Å ~ 0.02 eV/Å 已经是物理可信的极限。强行要求过高精度会导致原子在极小范围内反复震荡，永远无法满足收敛条件。

### 3.2.3 优先级 3：算法选择
如果结构非常长条或扁平，或者初始结构非常不合理：
*   尝试将 `relax_method` 切换为 `cg`（共轭梯度法）。虽然 CG 通常比 BFGS 慢，但它对这种病态结构的鲁棒性更强，不易“跑飞”。

---

## 3.3 VASP 用户迁移指南：ISIF 对照表

很多用户习惯了 VASP 的 `ISIF` 参数。在 ABACUS 中，我们没有直接的 `ISIF` 整数代码，而是通过 `calculation` 和约束条件来实现对应功能。

以下是核心功能的对照表，帮助你快速切换思维：

| 优化目标 | VASP 参数 | ABACUS 参数 (`INPUT`) | 物理含义 |
| :--- | :--- | :--- | :--- |
| **仅优化原子位置** | `ISIF = 2` | **`calculation relax`** | 固定晶胞形状和体积，仅移动原子。这是最安全的起步操作。 |
| **全结构优化** | `ISIF = 3` | **`calculation cell-relax`** | 原子位置、晶胞形状、晶胞体积全部允许变化。 |
| **仅优化晶胞** | `ISIF = 7` | *(需特殊设置)* | 这种情况较少见，通常通过 `cell-relax` 配合固定原子的约束实现。 |

**注意**：
1.  **应力单位**：VASP 默认输出 kBar，ABACUS 的 `stress_thr` 也是 **kBar**。
2.  **力单位**：ABACUS 的 `force_thr_ev` 单位是 **eV/Å**，与 VASP 一致。
3.  **约束控制**：如果需要像 `ISIF=4` 那样（改变形状但固定体积），ABACUS 需要在 `STRU` 文件或通过特定的晶胞约束参数（如 `fixed_ibrav` 或相关高级设置）来控制，这比简单的开关要复杂一些，建议查阅官方文档中关于约束（Constraints）的章节。

---

### 本章小结

1.  **慢即是快**：坚持“先 `relax` 再 `cell-relax`”，能解决 90% 的不收敛问题。
2.  **量力而行**：使用 LCAO 基组时，不要设置不切实际的力收敛精度（推荐 0.01 eV/Å）。
3.  **根基为王**：结构优化不收敛，先查 SCF；SCF 不收敛，结构优化免谈。

# 第四章：进阶控制——自由度约束与对称性

在材料模拟的实际战场中，"全自由度弛豫"（Full Relaxation）往往只是理想情况。更多时候，我们需要像外科手术一样精确控制体系的自由度：比如在计算形变势时固定晶胞体积、在模拟异质结时固定底层原子、或者在相变研究中强制保持某种对称性。

本章将深入 ABACUS 的自由度控制机制，并为习惯了 VASP `ISIF` 参数的用户提供一份详尽的迁移指南。

---

## 4.1 限定自由度优化 (Constrained Optimization)

ABACUS 的结构优化逻辑与 VASP 略有不同。VASP 通过 `ISIF` 一个参数控制所有行为，而 ABACUS 将**原子弛豫**和**晶胞弛豫**拆分为不同的计算类型，并通过额外的参数施加约束。

### 4.1.1 核心策略：分步优化 (Step-by-Step)

在开始任何晶胞变动之前，我必须强调一条**黄金法则**：

> **⚠️ 专家建议：永远不要直接运行 `cell-relax`**
>
> 即使你的最终目标是优化晶胞常数，也请务必遵循 **"先原子，后晶胞"** 的策略：
> 1.  先设置 `calculation = relax`（固定晶胞，仅优化原子位置），让原子回归到当前晶格下的能量极小值。
> 2.  读取上一步的结构（`STRU`），再开启 `calculation = cell-relax`（同时优化晶胞和原子）。
>
> **原因**：如果初始结构离平衡态较远，直接变动晶胞会导致应力（Stress）计算极度不稳定，甚至导致基组平面波数量剧烈波动（PW 模式下）或积分格点错位，引发计算发散。

### 4.1.2 晶胞约束：`fixed_axes`

当你开启 `calculation = cell-relax` 时，默认行为是三维全自由度优化（体积和形状均可变）。通过 `fixed_axes` 参数，我们可以锁定特定的自由度。

**常用场景配置 (`INPUT` 文件)：**

1.  **固定体积，优化形状 (Volume Conserved)**
    *   *应用场景*：计算剪切模量、模拟不可压缩流体极限下的晶体形变。
    *   *参数设置*：
        ```bash
        calculation  cell-relax
        cal_stress   1           # 必须开启应力计算
        fixed_axes   volume      # 锁定体积，允许形状改变
        ```

2.  **固定形状，优化体积 (Shape Conserved)**
    *   *应用场景*：状态方程 (EOS) 拟合、各向同性材料的快速预优化。
    *   *参数设置*：
        ```bash
        calculation  cell-relax
        cal_stress   1
        fixed_axes   shape       # 锁定晶胞角度和轴长比例，仅允许整体缩放
        # 注意：在旧版本或某些特定算法中可能被称为 r_shape，请以当前文档为准
        ```

3.  **固定特定方向 (自定义约束)**
    *   *注意*：ABACUS 目前原生支持的 `fixed_axes` 主要是 `volume`, `shape`, `None` (全放开)。如果需要像 VASP `ISIF=4` 那样只固定 z 轴但放开 xy 平面（例如层状材料优化），建议使用 **ASE 接口**（详见 4.2 节）或通过脚本迭代实现。

### 4.1.3 原子约束：`fixed_atoms`

原子位置的约束**不**在 `INPUT` 文件中设置，而是直接写在 `STRU` 结构文件中。这对于表面吸附、缺陷计算或异质结模拟至关重要。

**`STRU` 文件示例：**

```text
ATOMIC_POSITIONS
Direct
# 元素名  x  y  z  m_x  m_y  m_z
Si
0.000000 0.000000 0.000000 0 0 0  <-- 最后的三个 0 代表固定 x,y,z
0.250000 0.250000 0.250000 1 1 1  <-- 1 代表允许移动
```

*   **格式说明**：在原子坐标后的三个整数分别对应 x, y, z 方向的移动许可（1=Move, 0=Fix）。
*   **注意**：如果你的 `STRU` 文件中没有这三列，ABACUS 默认视为 `1 1 1`（全自由）。

---

## 4.2 对称性保持与 ASE 接口

在优化高对称性体系（如立方钙钛矿）时，数值噪声有时会导致结构“坍塌”到低对称性（如四方相）。防止这种情况有两种途径。

### 4.2.1 ABACUS 原生对称性控制

在 `INPUT` 文件中：

```bash
symmetry    1      # 开启对称性分析（默认）
```

*   **原理**：ABACUS 会在每一步 SCF 和结构优化中，强制将电荷密度和受力投影回该空间群的对称操作中。这通常足以维持晶体结构不发生对称性破缺。
*   **风险**：如果初始结构本身有微小的对称性破缺（例如手动微扰过的结构），`symmetry = 1` 可能会强制将其“修复”回高对称性，或者因为无法找到高对称性而报错。

### 4.2.2 进阶武器：ASE (Atomic Simulation Environment)

对于复杂的约束（例如：只允许单斜晶系的 $\beta$ 角变化，固定 $\alpha, \gamma$），ABACUS 原生参数可能不够灵活。此时，推荐使用 Python 的 ASE 库配合 ABACUS 计算器。

**实战代码：使用 ASE 的 `UnitCellFilter` 进行强约束优化**

```python
from ase.io import read
from ase.constraints import UnitCellFilter
from ase.optimize import BFGS
from abacus_interface import AbacusCalculator # 假设你安装了 abacus-develop 的 python 接口

# 1. 读取结构
atoms = read("STRU", format="abacus")

# 2. 设置计算器
calc = AbacusCalculator(
    directory='.',
    inp_params={
        'calculation': 'scf',  # 注意：这里设为 scf，因为弛豫由 ASE 接管
        'ecutwfc': 100,
        'scf_thr': 1e-6,
        'cal_stress': 1,       # 必须计算应力
        'cal_force': 1
    }
)
atoms.calc = calc

# 3. 设置过滤器 (Filter)
# scalar_pressure: 设置外压
# mask: 6个分量对应 [xx, yy, zz, yz, xz, xy]
# 例如：只允许 z 轴 (zz) 弛豫，固定其他
ucf = UnitCellFilter(atoms, scalar_pressure=0.0, mask=[0, 0, 1, 0, 0, 0])

# 4. 运行优化
opt = BFGS(ucf)
opt.run(fmax=0.05) # 0.05 eV/Ang
```

*   **优势**：ASE 的 `UnitCellFilter` 提供了极高自由度的掩码（Mask）机制，可以实现任意维度的晶胞约束。

---

## 4.3 VASP 用户迁移指南 (ISIF 对照表)

这是 VASP 用户最关心的部分。VASP 的 `ISIF` 一个参数涵盖了原子位置、晶胞形状、晶胞体积三个维度。在 ABACUS 中，我们需要组合 `calculation`、`fixed_axes` 和 `STRU` 设置来实现同等效果。

**表 4-1: VASP ISIF 与 ABACUS 参数映射表**

| VASP ISIF | 物理含义 | ABACUS 对应设置 (`INPUT`) | 备注 |
| :--- | :--- | :--- | :--- |
| **2** | **仅优化原子**<br>固定晶胞 | `calculation = relax`<br>`cal_force = 1` | 最常用的设置。 |
| **3** | **全优化**<br>原子+形状+体积 | `calculation = cell-relax`<br>`fixed_axes = None`<br>`cal_stress = 1` | 对应全自由度弛豫。 |
| **4** | **固定体积**<br>优化原子+形状 | `calculation = cell-relax`<br>`fixed_axes = volume`<br>`cal_stress = 1` | 常用于相变路径计算。 |
| **5** | **仅优化形状**<br>固定原子+体积 | ❌ *不推荐直接对应* | ABACUS 优化晶胞时通常也会移动原子。如需固定原子，需在 `STRU` 中设为 `0 0 0`。 |
| **7** | **仅优化体积**<br>固定原子+形状 | `calculation = cell-relax`<br>`fixed_axes = shape`<br>+ `STRU` 中固定原子 | 类似于状态方程计算。 |

**关键区别提示：**
*   **VASP ISIF=3**：同时变动晶胞和原子。
*   **ABACUS cell-relax**：也是同时变动晶胞和原子。
*   **VASP ISIF=2**：等同于 ABACUS 的 `relax`。

---

## 附录：常见陷阱与调试清单

### 1. LCAO 基组的精度陷阱 (Egg box effect)
在使用 LCAO（数值原子轨道）基组进行结构优化时，切勿盲目追求极高的受力收敛精度。
*   **现象**：原子在某个位置附近来回震荡，无法收敛到 `1e-3 eV/Ang`。
*   **原因**：由于积分网格的存在，原子移动时会感受到非物理的“蛋盒势”（Egg box effect）。
*   **建议**：
    *   LCAO 模式下，`force_thr_ev` 设置为 **0.02 ~ 0.05 eV/Ang** 通常已足够发表级精度。
    *   如果必须追求更高精度（如声子谱计算），请切换到平面波（PW）基组或显著增加 `ecutwfc`。

### 2. 单位换算
*   `stress_thr`：ABACUS 中应力收敛阈值的单位通常是 **kBar**。
    *   1 kBar = 0.1 GPa。
    *   不要把 1 GPa 的标准误设为 1 kBar。

### 3. "SCF 不收敛，优化无意义"
这是一个老生常谈但极易被忽视的问题。如果你的 `out_stru` 显示结构跑飞了，或者能量震荡：
*   **第一步**：检查 `OUT.*/running_scf.log`。
*   **判断**：如果电子步（SCF）没有收敛（达到 `scf_nmax`），那么计算出的力（Force）和应力（Stress）就是错误的垃圾数据。
*   **对策**：先调整 `mixing_beta`、`smearing` 或 `ks_solver` 让 SCF 收敛，再谈结构优化。

---

## 附录：进阶学习与调试指南

科学计算的道路永无止境，完成本书的章节练习仅仅是一个开始。为了帮助你在实际科研中应对更复杂的挑战，我们整理了以下进阶建议。

### 1. 进阶学习主题推荐
- **LCAO 与 PW 的精度权衡**：深入研究数值轨道（LCAO）基组下的“Egg-box Effect”。了解为何 LCAO 在力收敛精度上通常设定在 0.04 eV/Angstrom 左右，以及如何通过调整轨道基组和能量截断（Ecut）来逼近平面波（PW）的收敛精度。
- **对称性约束的数学底层**：探索形变梯度张量（Deformation Gradient）在对称化过程中的数学实现。理解空间群约束如何通过对点操作求平均，从而在优化过程中强制保持晶体的对称性。
- **并行效率优化**：研究晶胞朝向对并行效率的影响。对于一维纳米管或具有大真空层的二维表面体系，合理设置晶格基矢的方向（如 X, Y, Z 的选择）往往能显著优化 MPI/OpenMP 的负载均衡。

### 2. 通用调试建议 (Troubleshooting)
当你的优化任务不收敛或报错时，请按以下顺序排查：
- **SCF 优先原则**：首先检查每一步的 SCF 是否收敛。如果电子步都不收敛，结构优化必然失败。尝试调整混合参数（mixing_beta）或增加收敛阈值。
- **由简入繁**：如果 `cell-relax` 剧烈震荡，请退回 `relax` 步，先固定晶胞形状只优化原子位置，待受力减小后再开启全弛豫。
- **精度阶梯**：对于初猜结构较差的体系，先使用低 K 点密度（如 9x9x9）进行粗略搜索，待结构接近稳定点后再切换至高精度参数。
- **算法切换**：BFGS 算法在接近平衡点时效率极高，但如果初始结构偏离严重，可以尝试使用共轭梯度法（CG）进行初步“压惊”。

### 3. 官方资源与社群
- **官方文档**：请务必收藏 [ABACUS Documentation](https://abacus.deepmodeling.com/)，这是获取最新 INPUT 参数解释的权威来源。
- **开源社区**：积极参与 GitHub 上的 Issue 讨论，很多关于并行效率和特定体系优化的宝贵经验都沉淀在社区的互动中。

愿你在原子尺度的探索中，既有严谨的物理直觉，又有稳健的工程手感。保持好奇，勇于尝试！
