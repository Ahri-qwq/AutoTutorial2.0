# 第一章：晶胞弛豫的物理基础与应用场景

在开启 ABACUS 的计算之旅前，我们必须首先建立正确的物理图景。结构优化（Structural Optimization）并非简单的“让程序跑起来”，而是寻找材料在零温下势能面（Potential Energy Surface, PES）最小值的过程。

本章将深入剖析晶胞弛豫的物理本质，阐述何时需要调整晶格矢量，并提供从 VASP 到 ABACUS 的无缝迁移指南。

## 1.1 从原子弛豫到晶胞弛豫

在 ABACUS 的 `INPUT` 文件中，`calculation` 参数决定了计算的任务类型。对于结构优化，最核心的区别在于是否允许晶胞边界发生形变。

### 1.1.1 原子弛豫 (`calculation = relax`)
此时，晶格矢量 $\mathbf{L}$（即晶胞的形状和体积）被固定，程序仅优化基胞内原子的相对坐标 $\mathbf{x}_i$。
*   **物理目标**：消除原子受力（Force），使 $\mathbf{F}_i = -\nabla_{\mathbf{x}_i} E \to 0$。
*   **适用场景**：表面吸附计算（固定底层原子）、点缺陷能计算（通常固定晶胞体积）、分子动力学前的预平衡。

### 1.1.2 晶胞弛豫 (`calculation = cell-relax`)
此时，原子坐标 $\mathbf{x}_i$ 与晶格矢量 $\mathbf{L}$ 同时被优化。这引入了形变梯度的概念，程序不仅要消除原子受力，还要消除晶胞上的宏观应力（Stress）。
*   **物理目标**：最小化焓（Enthalpy, $H = E + PV$）。在零压下，即最小化总能量且消除应力张量 $\sigma_{\alpha\beta} \to 0$。
*   **适用场景**：寻找材料的平衡晶格常数、高压相变模拟、晶体结构预测。

### 1.1.3 【专家策略】分步优化的必要性
**这是一个新手最容易犯的错误：直接对一个粗糙的初始结构开启 `cell-relax`。**

当初始结构的原子受力很大时，直接变胞会导致晶格剧烈震荡，甚至由于对称性破缺导致结构崩塌。为了提高收敛效率和稳定性，**强烈建议**遵循以下“分步走”策略：

1.  **第一步 (`relax`)**：设置 `calculation = relax`。固定晶胞，先让原子“归位”，消除主要的原子受力。
2.  **第二步 (`cell-relax`)**：读取第一步优化后的原子坐标（`STRU`），设置 `calculation = cell-relax`。此时原子已接近平衡位置，变胞过程将更加平滑且容易收敛。

> **风险提示**：如果电子自洽迭代（SCF）不收敛，计算出的力与应力是毫无物理意义的噪声。在调试结构优化参数前，请优先确保 `scf_thr`（自洽阈值）已达成，且 `smearing` 等电子步参数设置合理。

---

## 1.2 解决的科学问题与参数详解

### 1.2.1 关键参数设置
在 `INPUT` 文件中，以下参数控制着优化的停止标准：

*   **`force_thr_ev`** (单位: eV/Å): 原子受力收敛阈值。
    *   **PW 基组建议**: `0.001` ~ `0.01`。平面波基组精度高，可以追求较小的受力。
    *   **LCAO 基组建议**: `0.01` ~ `0.03`。**注意**：由于原子轨道基组存在基组重叠误差（BSSE）和积分格点精度限制，过分追求极低的受力（如 0.0001）往往会导致计算在最后几步死循环，无法收敛，且对物理结果的改善微乎其微。
*   **`stress_thr`** (单位: kBar): 应力收敛阈值。通常设置为 `1` 到 `10` kBar（1 kBar $\approx$ 0.1 GPa）。
*   **`relax_nmax`**: 最大离子步数。建议设置为 `100` 或更高，防止未收敛即意外终止。

### 1.2.2 VASP 用户迁移指南 (ISIF 对照表)
对于熟悉 VASP 的用户，`ISIF` 参数控制了自由度。在 ABACUS 中，我们通过组合 `calculation` 和约束参数来实现相同的功能。

| VASP ISIF | 物理含义 | ABACUS 对应设置 (`INPUT` 文件) |
| :--- | :--- | :--- |
| **ISIF = 2** | 固定晶胞，优化原子 | `calculation = relax`<br>`cal_stress = 1` (可选，仅计算应力但不优化) |
| **ISIF = 3** | 全优化 (原子+晶胞形状+体积) | `calculation = cell-relax` |
| **ISIF = 4** | 优化原子+晶胞形状 (固定体积) | `calculation = cell-relax`<br>`fixed_axes = volume` |
| **ISIF = 7** | 优化原子 (固定晶胞形状和体积) | *注：ABACUS 中通常对应 `relax`，若需特殊约束需配合 `fixed_axes`* |

> **说明**: `fixed_axes` 等参数的具体用法将在后续高级章节详细介绍，初学者主要关注 `relax` (ISIF=2) 和 `cell-relax` (ISIF=3) 即可。

### 1.2.3 实战代码示例
假设我们要优化一个 Ba (钡) 金属的晶胞，以下是一个标准的 `cell-relax` 输入示例：

**INPUT 文件示例**：
```bash
INPUT_PARAMETERS
# 基础参数
suffix          Ba_opt
calculation     cell-relax    # 对应 VASP ISIF=3
symmetry        1             # 开启对称性分析，加速计算

# 电子步参数 (SCF)
basis_type      pw            # 使用平面波基组
ecutwfc         60            # 截断能 (Ry)
scf_thr         1e-6          # 电子自洽精度，建议比结构优化精度高2个数量级

# 离子步参数 (Relaxation)
force_thr_ev    0.01          # 力收敛阈值 (eV/Angstrom)
stress_thr      2             # 应力收敛阈值 (kBar)
relax_nmax      100           # 最大离子步数
out_stru        1             # 输出每一步的结构文件
```

通过本章的学习，你应该已经理解了晶胞弛豫的物理意义，并掌握了避免常见陷阱（如直接变胞、LCAO 精度设置过高）的方法。下一章，我们将正式进入实操环节。