# 第三章：最佳实践策略——分步优化法

在计算材料学的江湖里，新手和老手的最大区别往往不在于掌握了多少高深的理论，而在于**工作流（Workflow）的稳健性**。

很多初学者在拿到 ABACUS 后，最喜欢做的事情就是直接在 `INPUT` 文件里写上 `calculation = cell-relax`（全结构优化），然后设置一个极高的精度，按下回车，期待第二天早上收获完美的结构。然而，现实往往是残酷的：计算要么在震荡中永不收敛，要么因为晶胞剧烈变形导致 SCF 炸裂。

本章将传授工业界标准的**“分步优化法”**。这不仅是经验之谈，更是基于势能面搜索原理的最佳策略。

---

## 3.1 “先 Relax 后 Cell-Relax” 策略

这是本教程最核心的建议：**永远不要直接对一个未知或粗糙的结构运行 `cell-relax`。**

### 3.1.1 为什么要分步走？

结构优化本质上是在高维势能面上寻找极小值点。
*   **原子位置优化 (`relax`)**：是在固定的“盒子”里调整原子，自由度较少，能量下降快，且不容易因为基组（Basis Set）的变化引入数值噪声。
*   **晶胞优化 (`cell-relax`)**：涉及到“盒子”形状和大小的改变。在平面波（PW）或原子轨道（LCAO）计算中，晶胞的改变会导致基组覆盖范围的变化（Pulay Stress 问题），计算成本高且更容易陷入数值不稳定性。

如果你直接开启 `cell-relax`，当原子受力还非常大（远离平衡位置）时，巨大的应力（Stress）会驱动晶胞剧烈变形，这极易导致 SCF 不收敛，甚至将结构“拉坏”。

### 3.1.2 标准工作流演示

我们推荐的“两步走”策略如下：

#### **第一步：固定晶胞，优化原子 (`relax`)**

目标是将原子“理顺”，消除主要的内应力。

**INPUT 文件设置：**
```bash
INPUT_PARAMETERS
# ... 基础参数 ...
calculation     relax       # 关键：仅优化原子位置，固定晶胞
relax_method    bfgs        # 推荐：BFGS 算法对原子位置优化效率极高
force_thr_ev    0.02        # 第一步不需要太高精度，0.02 eV/Ang 足够
relax_nmax      100
out_stru        1           # 输出优化后的结构
```

运行完成后，检查 `OUT.${suffix}/` 目录下的收敛情况。如果收敛，进行下一步。

#### **第二步：全结构优化 (`cell-relax`)**

使用第一步优化好的结构作为起点，开启晶胞自由度。

**操作流程：**
1.  **继承结构**：将第一步输出的结构文件 `STRU_OUT` 复制并覆盖原有的 `STRU` 文件。
    ```bash
    cp OUT.suffix/STRU_OUT ./STRU
    ```
2.  **修改 INPUT**：
    ```bash
    INPUT_PARAMETERS
    # ... 基础参数 ...
    calculation     cell-relax  # 关键：开启晶胞和原子的全优化
    relax_method    cg          # 针对 cell-relax，ABACUS 内部通常使用 CG 或混合算法
    force_thr_ev    0.01        # 最终精度
    stress_thr      2           # 应力收敛标准，单位 kBar (2 kBar 约等于 0.2 GPa)
    relax_nmax      100
    ```

> **专家提示**：ABACUS 的 `cell-relax` 采用的是**嵌套循环（Nested Loop）**机制。外层循环改变晶胞参数（使用 CG 算法），内层循环在固定新晶胞的情况下优化原子位置（使用 BFGS 或 CG）。这种设计本身就比同时改变所有自由度要稳健，但“手动分步”依然是处理复杂体系的黄金法则。

---

## 3.2 应对收敛困难：排查顺序

当你发现结构优化迟迟不收敛（例如 `force` 在 0.05 左右震荡死活降不下去），请按以下顺序排查。切记：**SCF 不收敛，结构优化毫无意义。**

### 3.2.1 优先级 1：检查电子步（SCF）
结构优化的每一步（Ionic Step）都依赖于电子步（SCF）计算出的力和应力。如果 SCF 只是勉强收敛，或者在震荡，那么计算出的力就是“噪声”，结构优化自然无法收敛。

*   **现象**：SCF 迭代次数经常达到最大值，或者能量波动大。
*   **对策**：
    *   **提高 `scf_thr`**：结构优化时，SCF 精度至少要比力精度高 1-2 个数量级。建议 `scf_thr` 设置为 `1e-6` 或更小。
    *   **调整 Smearing**：对于金属或小带隙体系，必须使用 Smearing。
        *   `smearing_method`: `gaussian` 或 `mp` (Methfessel-Paxton)。
        *   `smearing_sigma`: 适当增大（如 0.02 Ry ~ 0.05 Ry）有助于 SCF 收敛，但需注意物理意义。

### 3.2.2 优先级 2：基组与力精度的匹配（LCAO 特别注意）

这是 LCAO（数值原子轨道）用户最常踩的坑。

*   **PW 基组**：平面波基组完备性好，通常可以追求极高的受力精度（如 `1e-3` eV/Å）。
*   **LCAO 基组**：由于基组的局域性和截断误差，LCAO 存在所谓的“蛋盒效应”（Egg-box effect），即原子在空间移动时能量面会有微小的非物理波动。
    *   **风险提示**：在 LCAO 模式下，**不要盲目追求 `force_thr_ev = 0.001`**。对于大多数 LCAO 基组设置，0.01 eV/Å ~ 0.02 eV/Å 已经是物理可信的极限。强行要求过高精度会导致原子在极小范围内反复震荡，永远无法满足收敛条件。

### 3.2.3 优先级 3：算法选择
如果结构非常长条或扁平，或者初始结构非常不合理：
*   尝试将 `relax_method` 切换为 `cg`（共轭梯度法）。虽然 CG 通常比 BFGS 慢，但它对这种病态结构的鲁棒性更强，不易“跑飞”。

---

## 3.3 VASP 用户迁移指南：ISIF 对照表

很多用户习惯了 VASP 的 `ISIF` 参数。在 ABACUS 中，我们没有直接的 `ISIF` 整数代码，而是通过 `calculation` 和约束条件来实现对应功能。

以下是核心功能的对照表，帮助你快速切换思维：

| 优化目标 | VASP 参数 | ABACUS 参数 (`INPUT`) | 物理含义 |
| :--- | :--- | :--- | :--- |
| **仅优化原子位置** | `ISIF = 2` | **`calculation relax`** | 固定晶胞形状和体积，仅移动原子。这是最安全的起步操作。 |
| **全结构优化** | `ISIF = 3` | **`calculation cell-relax`** | 原子位置、晶胞形状、晶胞体积全部允许变化。 |
| **仅优化晶胞** | `ISIF = 7` | *(需特殊设置)* | 这种情况较少见，通常通过 `cell-relax` 配合固定原子的约束实现。 |

**注意**：
1.  **应力单位**：VASP 默认输出 kBar，ABACUS 的 `stress_thr` 也是 **kBar**。
2.  **力单位**：ABACUS 的 `force_thr_ev` 单位是 **eV/Å**，与 VASP 一致。
3.  **约束控制**：如果需要像 `ISIF=4` 那样（改变形状但固定体积），ABACUS 需要在 `STRU` 文件或通过特定的晶胞约束参数（如 `fixed_ibrav` 或相关高级设置）来控制，这比简单的开关要复杂一些，建议查阅官方文档中关于约束（Constraints）的章节。

---

### 本章小结

1.  **慢即是快**：坚持“先 `relax` 再 `cell-relax`”，能解决 90% 的不收敛问题。
2.  **量力而行**：使用 LCAO 基组时，不要设置不切实际的力收敛精度（推荐 0.01 eV/Å）。
3.  **根基为王**：结构优化不收敛，先查 SCF；SCF 不收敛，结构优化免谈。