# 第二章：标准晶胞优化流程与参数详解

这是《ABACUS 实战教程》的第二章。在本章中，我们将深入探讨如何正确、高效地进行晶胞优化。

结构优化是第一性原理计算的基石。一个未弛豫的结构会导致错误的能带、虚频的声子谱以及不可靠的力学性质。不同于简单的单点能计算，晶胞优化（Cell Relaxation）涉及电子步（SCF）与离子步（Geometry Optimization）的双重循环，对参数设置的物理直觉要求极高。

---

## 第二章：标准晶胞优化流程与参数详解

### 2.1 核心输入参数配置：从 Relax 到 Cell-Relax

在 ABACUS 中，结构优化主要分为两类：
1.  **原子位置优化 (`relax`)**：固定晶格常数和形状，仅移动原子位置。
2.  **全结构优化 (`cell-relax`)**：原子位置与晶胞形状/体积同时优化。

#### 2.1.1 核心参数速查
在 `INPUT` 文件中，以下参数控制着优化的行为：

| 参数名 | 推荐值/类型 | 物理含义 |
| :--- | :--- | :--- |
| **`calculation`** | `cell-relax` | 开启全结构优化模式（原子+晶胞）。 |
| **`relax_nmax`** | `100` ~ `200` | 最大离子步数。若超过此步数仍未收敛，计算将停止。建议设置得稍大一些，避免在即将收敛时中断。 |
| **`out_stru`** | `1` | **必填**。设置为 1 时，ABACUS 会在每个离子步输出结构文件，并在计算结束时生成 `STRU_ION_D`。这是你进行后续计算（如能带、DOS）的新起点。 |
| **`cal_force`** | `1` | 计算原子受力（`cell-relax` 模式下默认开启，显式写出是个好习惯）。 |
| **`cal_stress`** | `1` | 计算应力张量（`cell-relax` 模式下必须开启，用于驱动晶胞形变）。 |

#### 2.1.2 专家策略：分步优化法（Step-by-Step Optimization）
**这是本教程最关键的建议之一**。

很多初学者喜欢直接对一个粗糙的结构使用 `calculation = cell-relax`。虽然理论上可行，但在实际操作中（特别是 LCAO 基组下），这极易导致：
1.  **SCF 不收敛**：剧烈的晶胞形变导致原子间距过近，电荷密度重叠严重。
2.  **计算效率低**：在远离平衡态时调整晶胞形状，往往是在做无用功。

**最佳实践流程**：
1.  **第一步 (`relax`)**：设置 `calculation = relax`。固定晶胞，先让原子“理顺”内部的化学键。
2.  **第二步 (`cell-relax`)**：读取第一步优化好的结构（将 `STRU_ION_D` 复制为 `STRU`），再开启 `calculation = cell-relax` 进行最终优化。

#### 2.1.3 VASP 用户迁移指南 (ISIF 对照表)
如果你熟悉 VASP，下表可以帮助你快速建立参数映射关系：

| VASP 参数 | ABACUS 对应设置 | 行为描述 |
| :--- | :--- | :--- |
| `ISIF = 2` | `calculation = relax` | 仅优化原子位置，晶胞固定。 |
| `ISIF = 3` | `calculation = cell-relax` | 全优化（原子位置 + 晶胞体积 + 晶胞形状）。 |
| `ISIF = 7` | *(需配合 `fixed_axes` 等约束)* | 保持体积不变优化（ABACUS 中需通过特定约束实现，非默认行为）。 |

---

### 2.2 收敛精度的权衡：PW 与 LCAO 的不同哲学

结构优化的结束标志是：所有原子的受力小于阈值 **且** 晶胞应力小于阈值。
在 ABACUS 中，这就涉及两个关键参数：`force_thr_ev` 和 `stress_thr`。

#### 2.2.1 力收敛标准 (`force_thr_ev`)
*   **单位**：eV/Angstrom
*   **物理意义**：原子受到的最大残余力。

**基组差异化设置（至关重要）：**

*   **平面波 (PW) 基组**：
    *   由于平面波基组具有平移不变性，原子移动时能量变化非常平滑。
    *   **推荐值**：`0.01` 甚至 `0.001` eV/Ang。你可以追求极高的精度。

*   **原子轨道 (LCAO) 基组**：
    *   **蛋盒效应 (Egg-box Effect)**：在 LCAO 方法中，积分网格是固定的，而原子轨道随原子移动。当原子跨过积分网格线时，会产生数值上的虚假力（类似蛋在蛋盒里滚动）。
    *   **风险提示**：如果你在 LCAO 模式下将 `force_thr_ev` 设置为 `0.001`，计算可能**永远无法收敛**，因为数值噪声本身可能就大于这个阈值。
    *   **推荐值**：`0.03` ~ `0.05` eV/Ang。对于绝大多数物理性质（如能带、力学模量），`0.04` eV/Ang 的精度已经足够。

#### 2.2.2 应力收敛标准 (`stress_thr`)
*   **单位**：**kBar** (注意：1 kBar = 0.1 GPa)
*   **推荐值**：通常设置为 `1` 到 `10` kBar。
    *   对于硬材料（如金刚石、氧化物），`10` kBar 对应的应变已经非常小。
    *   对于软材料（如范德华异质结、分子晶体），可能需要更严格的 `1` kBar。

#### 2.2.3 风险提示：SCF 收敛是前提
**切记**：结构优化的每一步都依赖于电子步（SCF）计算出的力和应力。如果 SCF 没有收敛（例如 `scf_thr` 设置过大，或者电子步震荡），那么计算出的力就是错误的。
*   **诊断**：如果发现结构优化步数极多且能量上下乱跳，请优先检查 `scf_thr` 是否足够小（建议 `1e-6` 或更小），以及 SCF 是否达到收敛精度。

---

### 2.3 施加外压与目标控制

在模拟地核环境、高压相变或薄膜外延生长时，我们需要施加外部压强。

#### 2.3.1 设置目标压强
在 `INPUT` 文件中，通过以下参数设置目标压强（Target Pressure）：

*   **参数名**：`press1`, `press2`, `press3`
*   **单位**：**kBar**
*   **含义**：分别对应晶胞三个主轴方向（xx, yy, zz）的目标压强。

**示例场景**：
1.  **静水压 (Hydrostatic Pressure)**：模拟 10 GPa (100 kBar) 的均匀环境。
    ```
    press1  100
    press2  100
    press3  100
    ```
2.  **单轴压缩 (Uniaxial Compression)**：仅在 Z 方向施加压力。
    ```
    press1  0
    press2  0
    press3  50
    ```

*注：具体的参数名称在不同版本的 ABACUS 中可能略有差异（如部分版本使用 `target_pressure` 统一控制），请务必在运行前查阅您当前使用版本的官方文档 `INPUT` 参数列表。*

---

### 2.4 实战案例：标准优化 INPUT 模板

以下是一个标准的 `INPUT` 文件模板，适用于大多数 LCAO 基组的绝缘体/半导体体系优化。

**文件：INPUT**
```bash
INPUT_PARAMETERS
# 1. 基础信息
suffix          MgO_opt
ntype           2
pseudo_dir      ./
orbital_dir     ./

# 2. 电子步 (SCF) 设置
basis_type      lcao
ecutwfc         100       # 根据赝势建议值设置
scf_thr         1e-7      # 必须比力收敛精度高几个数量级
scf_nmax        100
smearing_method gauss
smearing_sigma  0.01

# 3. 结构优化核心设置 (Cell-Relax)
calculation     cell-relax
relax_nmax      100       # 最大离子步
out_stru        1         # 输出优化后的结构

# 4. 力与应力收敛标准 (LCAO 推荐值)
cal_force       1
cal_stress      1
force_thr_ev    0.04      # LCAO下不要设得太小，避免蛋盒效应
stress_thr      2         # 单位 kBar

# 5. 外部压强 (可选，默认为 0)
# press1        0
# press2        0
# press3        0
```

### 总结
1.  **分步走**：先 `relax` 再 `cell-relax`，磨刀不误砍柴工。
2.  **知进退**：LCAO 基组下，`force_thr_ev` 设置为 `0.04` 是明智的妥协，不要强求 `0.001`。
3.  **看单位**：`stress_thr` 的单位是 kBar，不要和 GPa 搞混。

下一章，我们将讨论如何分析优化后的结果，并处理常见的“优化不收敛”灾难现场。