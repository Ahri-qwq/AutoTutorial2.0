# 第一章：强关联体系与 ABACUS 计算基础

欢迎进入《ABACUS 实战教程》。在开始任何具体的代码操作之前，我们需要先建立正确的物理图像和软件操作逻辑。强关联体系（Strongly Correlated Systems）的计算一直是第一性原理计算中的难点，而 DFT+U 是一种在计算精度与成本之间取得平衡的有效方法。

本章将带你理解为什么标准 DFT 会失效，以及如何在 ABACUS 中正确地构建 DFT+U 的计算模型。

---

## 1.1 物理背景：为何需要 +U？

在密度泛函理论（DFT）的框架下，标准的交换关联泛函（如 LDA 或 GGA-PBE）在处理大多数主族元素（s、p 轨道电子）时表现优异。然而，当涉及**过渡金属（d 轨道）**或**稀土元素（f 轨道）**时，标准 DFT 往往会遭遇滑铁卢。

### 1.1.1 自相互作用误差（Self-Interaction Error）
标准 DFT 泛函倾向于过度“离域化”电子。对于 d 或 f 轨道这种空间上高度局域的电子，LDA/GGA 会错误地将它们描述为弥散在整个晶体中。这种**自相互作用误差（SIE）**会导致以下典型物理问题：

1.  **带隙严重偏小**：本该是莫特绝缘体（Mott Insulator）的氧化物（如 NiO、FeO），在标准 DFT 下可能被计算为金属（带隙为 0）。
2.  **磁矩描述错误**：局域磁矩被低估，甚至导致磁序预测错误。
3.  **晶格常数偏差**：化学键强度描述不准，导致结构优化结果不可信。

### 1.1.2 Hubbard U 的修正思想
DFT+U 方法借鉴了 Hubbard 模型，在标准 DFT 能量泛函的基础上增加了一个修正项：
$$ E_{DFT+U} = E_{DFT} + \frac{U}{2} \sum_{I,\sigma} \left[ n_{I,\sigma} (1 - n_{I,\sigma}) \right] $$
这里的 $U$ 代表**库仑排斥能**（On-site Coulomb Interaction）。简单来说，我们强制给占据同一局域轨道的电子之间增加额外的排斥力，迫使电子更加“局域化”。这就像是给电子穿上了“紧身衣”，修正了过度离域的问题，从而正确打开带隙并恢复局域磁矩。

---

## 1.2 ABACUS 的实现前提与核心限制

ABACUS 作为一款基于数值原子轨道（LCAO）和平面波（PW）双基组的软件，其 DFT+U 功能有特定的实现方式。**请务必牢记以下限制，这是新手最容易报错的地方。**

### 1.2.1 核心限制：必须使用 LCAO 基组
目前 ABACUS 的 DFT+U 功能**仅支持数值原子轨道基组**。

*   **INPUT 设置**：必须确保 `basis_type` 参数设置为 `lcao`。
*   **文件需求**：除了 `.upf` 赝势文件外，你必须为每种元素提供对应的 `.orb` 轨道文件。

> **警告**：如果你在 `basis_type pw`（平面波模式）下设置了 +U 参数，程序通常会忽略这些设置或报错，导致你得到的是标准 DFT 的结果。

### 1.2.2 关键技巧：处理反铁磁体系（以 NiO 为例）
在处理像 NiO 这样的反铁磁（AFM）体系时，晶胞中相邻的 Ni 原子磁矩方向相反（一个为 +2 $\mu_B$，一个为 -2 $\mu_B$）。

在 ABACUS 的 `STRU` 文件中，为了正确初始化这种磁序，**必须将同一种元素拆分为不同的“原子种类（Species）”**。

**错误做法**：只定义一种 Ni，试图在坐标部分区分磁矩（ABACUS 处理起来较困难）。
**正确做法**：定义 `Ni1` 和 `Ni2`。

#### 示例：STRU 文件片段
```plaintext
ATOMIC_SPECIES
Ni1 58.693 Ni_ONCV_PBE-1.0.upf
Ni2 58.693 Ni_ONCV_PBE-1.0.upf
O   15.999 O_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
4.17

LATTICE_VECTORS
0.5 0.5 1.0
0.5 1.0 0.5
1.0 0.5 0.5

ATOMIC_POSITIONS
Direct

Ni1
0.0
0.0 0.0 0.0 2.0  // 最后的 2.0 为初始磁矩 mag

Ni2
0.0
1.0 1.0 1.0 -2.0 // 最后的 -2.0 为初始磁矩 mag

O
2.0
0.5 0.5 0.5 0.0
1.5 1.5 1.5 0.0
```

### 1.2.3 参数数组的严格对应关系
在 `INPUT` 文件中，`orbital_corr`（指定加 U 的轨道）和 `hubbard_u`（U 值大小）是数组形式。

**规则**：数组的长度和顺序必须与 `STRU` 文件中 `ATOMIC_SPECIES` 的行数**严格一致**。

对应上文的 `STRU`（顺序：Ni1, Ni2, O），`INPUT` 设置如下：

```plaintext
INPUT_PARAMETERS
# ... 其他基础参数 ...
basis_type      lcao
nspin           2      # 开启自旋极化

# DFT+U 核心参数
dft_plus_u      1      # 开启功能开关
# 对应关系：     Ni1  Ni2  O
orbital_corr    2    2    -1
hubbard_u       5.0  5.0  0.0
```

*   **orbital_corr**:
    *   `2`: 对 d 轨道加 U（Ni1 和 Ni2）。
    *   `-1`: 不加 U（O 原子）。
    *   *(注：0=s, 1=p, 2=d, 3=f)*
*   **hubbard_u**:
    *   单位为 eV。这里对 Ni 的 d 轨道加 5.0 eV 的 U 值。

---

## 1.3 实战工作流：从标准计算到 OMC 锁定

在强关联体系中，电子很容易陷入亚稳态（Metastable State），导致计算收敛到错误的磁基态。为了解决这个问题，ABACUS 提供了**占据矩阵控制（Occupation Matrix Control, OMC）**功能。

建议采用以下“两步走”策略：

### 第一步：跑通标准 DFT+U (`omc=0`)
首先进行一次标准的自洽计算，让程序自由寻找基态。

**INPUT 设置**:
```plaintext
dft_plus_u      1
omc             0      # 默认值，标准计算
out_chg         1      # 重要！这会输出电荷密度和 onsite.dm
```

**结果验证**:
计算结束后，检查输出目录（如 `OUT.NiO/`）下的 `running_scf.log`：
1.  搜索 `L(S)DA+U` 区块，确认程序正确读入了 U 值。
    ```plaintext
    atom_type=0  L=2  chi=0    U=5ev  <-- 确认 U 值生效
    ```
2.  搜索 `absolute magnetism`，确认得到了反铁磁态。
    *   理想情况：`total magnetism` 接近 0（抵消），但 `absolute magnetism` 很大（如 > 3.0 $\mu_B$/cell）。

### 第二步：锁定占据矩阵 (`omc=2`)
如果第一步得到了正确的磁序和电子态，我们可以将此时的占据矩阵“锁定”，用于后续更复杂的计算（如能带结构、DOS 或 结构弛豫），防止电子态在后续计算中发生坍塌或翻转。

**操作流程**:
1.  找到第一步输出的 `onsite.dm` 文件（位于输出目录中）。
2.  将其复制到工作目录，并重命名为 `initial_onsite.dm`。
3.  修改 `INPUT` 文件：
    ```plaintext
    omc             2      # 锁定模式：读取 initial_onsite.dm 并在计算中保持不变
    ```
4.  重新运行计算。

> **专家提示**：`omc=2` 对于复杂氧化物（如含稀土元素的钙钛矿）非常关键。在这些体系中，f 电子非常容易跑偏，先用小基组或受限条件跑出一个合理的 `onsite.dm`，然后用 `omc=2` 锁住它去跑高精度计算，是资深用户的常用技巧。

---

## 1.4 本章小结

在动手计算前，请确认你已准备好以下清单：
1.  [ ] **基组检查**：确认使用 `basis_type lcao` 及对应的 `.orb` 文件。
2.  [ ] **结构处理**：反铁磁体系是否已将磁性原子拆分为不同 Species（如 Ni1, Ni2）。
3.  [ ] **参数对应**：`orbital_corr` 和 `hubbard_u` 的数组长度是否等于 Species 数量。
4.  [ ] **策略选择**：决定是直接计算还是使用 OMC 工作流。

下一章，我们将基于这些知识，手把手带你完成 NiO 的反铁磁基态计算与能带分析。