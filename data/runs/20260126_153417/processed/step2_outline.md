<!-- META_START -->
# 《ABACUS 实战教程：强关联体系的 DFT+U 计算与调控》

## 前言
- **本书逻辑**: 本教程遵循“物理原理 -> 模型构建 -> 参数映射 -> 结果验证 -> 高级调控”的教学逻辑。DFT+U 不仅仅是一个参数设置问题，更是对物理模型的修正。因此，我们首先强调如何在结构文件中正确定义“原子类型”以适配反铁磁/亚铁磁模型，随后深入讲解参数数组与原子类型的对应关系，最后通过占据矩阵控制（OMC）解决强关联体系常见的亚稳态收敛问题。
- **核心知识点**: 强关联电子体系、Hubbard U 模型、反铁磁体系建模、LCAO 基组下的 +U 实现、占据矩阵控制 (OMC)、Mulliken 磁矩分析。

<!-- CHAPTER_START -->
## 第一章：强关联体系与 ABACUS 计算基础
**本章逻辑**: 在动手计算前，必须明确 DFT+U 解决的是什么物理问题，以及 ABACUS 软件实现该功能的特定限制（如基组要求），避免方向性错误。

### Section 1.1: 物理背景：为何需要 +U？
- **内容**: 简述标准 DFT (LDA/GGA) 在处理过渡金属（d 轨道）和稀土元素（f 轨道）时的“自相互作用误差”及其导致的带隙偏小、磁矩错误等问题。引入 Hubbard U 模型的基本修正思想。
- **关键参数**: 无

### Section 1.2: ABACUS 的实现前提
- **内容**: 明确 ABACUS 中 DFT+U 功能的适用范围。重点强调该功能目前仅支持数值原子轨道基组（LCAO），不支持平面波基组。
- **关键参数**: `basis_type` (必须设为 `lcao`)

<!-- CHAPTER_START -->
## 第二章：复杂磁性体系的模型构建 (STRU)
**本章逻辑**: 对于强关联体系（尤其是反铁磁 NiO 案例），正确的结构定义是计算成败的基石。本章重点讲解如何通过“拆分原子类型”来为同一元素设置不同的磁学环境或 U 值，这是初学者最容易出错的步骤。

### Section 2.1: 案例分析：反铁磁 NiO 体系
- **内容**: 解析 NiO 的晶体结构与反铁磁序（两个 Ni 原子磁矩相反）。展示如何将物理上的同种元素处理为计算中的不同“原子种类”。
- **关键参数**: 无

### Section 2.2: STRU 文件的特殊定义
- **内容**: 实战演示如何在 `STRU` 文件中定义 `ATOMIC_SPECIES`。详细讲解为何需要将 Ni 拆分为 `Ni1` (up) 和 `Ni2` (down)，以及如何在原子坐标部分分别指定初始磁矩。
- **关键参数**: `ATOMIC_SPECIES` (Ni1, Ni2...), `mag_mom` (在原子坐标后设置初始磁矩)

<!-- CHAPTER_START -->
## 第三章：核心参数配置与数组映射 (INPUT)
**本章逻辑**: `INPUT` 文件中的 +U 参数是数组形式，必须与 `STRU` 中的原子类型一一对应。本章将建立严格的映射逻辑，确保参数设置准确无误。

### Section 3.1: 激活 DFT+U 计算
- **内容**: 讲解开启 +U 功能的总开关，以及忽略此设置的后果。
- **关键参数**: `dft_plus_u`

### Section 3.2: 轨道与 U 值的数组映射
- **内容**: 深入解析 `orbital_corr` 和 `hubbard_u` 两个关键数组。
    - 解释数组长度必须等于 `ntype`（原子类型总数）。
    - 演示如何根据第二章定义的 `Ni1`, `Ni2`, `O` 顺序，依次设置 d 轨道的 U 值（如 5.0 eV）和非关联原子的忽略标记（-1）。
- **关键参数**: `orbital_corr`, `hubbard_u`

<!-- CHAPTER_START -->
## 第四章：计算运行与结果验证
**本章逻辑**: 设置完参数后，如何确认计算是否正确执行？本章关注从日志文件中提取关键信息，验证 U 值是否生效，以及物理结果（带隙、磁矩）是否符合预期。

### Section 4.1: 运行 SCF 与日志检查
- **内容**: 运行计算并分析 `running_scf.log`。指导用户查找 `L(S)DA+U` 数据块，验证程序读入的 U 值、L 轨道是否与输入一致，以及查看每步输出的占据矩阵（Occupation Matrix）。
- **关键参数**: `out_bandgap`, `out_mul` (建议开启以辅助分析)

### Section 4.2: 电子结构与磁性分析
- **内容**: 分析输出结果。
    - 能量与带隙：对比加 U 前后的带隙变化（修正绝缘体性质）。
    - 磁性分析：通过 `absolute magnetism` 和 Mulliken 电荷分析，确认反铁磁序是否保持（总磁矩接近 0，局部磁矩非 0）。
- **关键参数**: 无 (主要关注输出文件 `Mulliken.txt`, `running_scf.log`)

<!-- CHAPTER_START -->
## 第五章：进阶调控：占据矩阵控制 (OMC)
**本章逻辑**: 强关联体系常存在多个亚稳态。本章介绍 ABACUS 的高级功能——占据矩阵控制（OMC），通过读取并固定占据矩阵，引导体系进入正确的基态或复现特定轨道占据。

### Section 5.1: OMC 的工作原理与模式
- **内容**: 介绍 `omc` 参数的三种模式（0, 1, 2）及其物理含义。解释何时需要锁定占据矩阵（如消除亚稳态、强制特定轨道序）。
- **关键参数**: `omc`, `out_chg` (必须设为 1 以输出 `onsite.dm`)

### Section 5.2: 实战：固定占据矩阵流程
- **内容**: 演示完整的 OMC 操作流：
    1. 运行标准计算 (`omc=0`, `out_chg=1`) 生成 `onsite.dm`。
    2. 文件操作：将 `onsite.dm` 重命名为 `initial_onsite.dm`。
    3. 修改 `INPUT` 设置 `omc=2` 进行固定矩阵计算，并验证结果的一致性。
- **关键参数**: `omc`, `initial_onsite.dm` (文件名要求)

<!-- APPENDIX_START -->
## 附录：常见问题与进阶建议
- **常见报错**: 数组长度不匹配 (`hubbard_u` size != `ntype`)、基组错误 (使用 PW 基组)。
- **收敛技巧**: 针对难收敛体系的混合参数调整建议 (`mixing_restart`, `mixing_dmr`)。
- **拓展阅读**: 简述 Yukawa 势方法 (`yukawa_potential`) 作为另一种确定 U 值的途径。