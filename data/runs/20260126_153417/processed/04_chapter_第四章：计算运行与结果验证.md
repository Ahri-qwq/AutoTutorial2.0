# 第四章：计算运行与结果验证

在上一章中，我们已经完成了 DFT+U 计算所需的 `INPUT` 和 `STRU` 文件设置。这是至关重要的一步，但经验告诉我们，参数设置正确并不代表计算结果一定符合物理预期。

作为开发者，我经常看到用户设置了 U 值，但由于原子类型顺序错误，导致 U 加到了错误的原子或轨道上；或者在强关联体系中，电子收敛到了错误的亚稳态（Local Minimum）。

本章我们将通过实际运行 NiO 的反铁磁（AFM）算例，深入解析 `running_scf.log` 日志文件，验证 U 值是否正确生效，并学习如何通过 **Occupation Matrix Control (OMC)** 技术锁定基态。

> **⚠️ 核心前提**：
> 目前 ABACUS 的 DFT+U 功能（包括 U 值修正与 OMC）**仅支持 LCAO 基组**。请务必确认你的 `INPUT` 文件中设置了 `basis_type lcao`。

---

## 4.1 运行 SCF 与日志检查

当你提交任务后（例如使用 `mpirun -n 8 abacus`），ABACUS 会生成标准输出文件（通常重定向为日志）和输出目录 `OUT.suffix/`。对于 DFT+U 计算，我们不能只看“是否收敛”，必须检查程序是否正确读入了 Hubbard U 参数。

### 4.1.1 验证 U 值加载 (`L(S)DA+U` 区块)

打开输出目录下的 `running_scf.log` 文件，搜索关键字 `L(S)DA+U`。这是程序初始化 DFT+U 模块的标志。

**检查重点：**
1.  **原子类型对应关系**：确认 `atom_type` 索引与 `STRU` 中 `ATOMIC_SPECIES` 的顺序是否一致。
2.  **轨道角动量 (L)**：确认 U 值是否加在了正确的轨道上（如过渡金属的 d 轨道，L=2）。
3.  **U 值大小**：确认数值是否为你设置的值（单位通常为 eV）。

**日志示例分析 (NiO 案例)**：
假设我们的 `STRU` 中原子顺序为 `Ni1`, `Ni2`, `O`，且 `INPUT` 设置如下：
```bash
# INPUT
orbital_corr 2 2 -1  # 对应 Ni1(d), Ni2(d), O(no U)
hubbard_u    5.0 5.0 0.0
```

你应该在日志中看到如下区块：
```text
 ---------------------------------------------------------
 L(S)DA+U:
 ---------------------------------------------------------
 atom_type=0  L=2  chi=0    U=5ev   <-- 对应 Ni1，d轨道，U=5.0
 atom_type=1  L=2  chi=0    U=5ev   <-- 对应 Ni2，d轨道，U=5.0
 ---------------------------------------------------------
```
> **开发者提示**：如果日志中没有出现这个区块，或者 `atom_type` 的数量少于预期，请立即检查 `dft_plus_u` 是否设为 1，以及 `orbital_corr` 数组长度是否与 `ATOMIC_SPECIES` 行数严格匹配。

### 4.1.2 监控占据矩阵 (Occupation Matrix)

在 SCF 迭代过程中，ABACUS 会在每一步输出当前的占据矩阵。这对于判断电子态的演化非常有用。

在日志中搜索 `atoms` 关键字，你会看到类似 5x5 的矩阵（对于 d 轨道）：
```text
 atoms  0       <-- 第1个原子 (Ni1)
 L  2           <-- d 轨道
 spin  0        <-- 自旋向上 (Spin Up)
 ... (5x5 矩阵数据) ...
 spin  1        <-- 自旋向下 (Spin Down)
 ... (5x5 矩阵数据) ...
```
**实战技巧**：
对于反铁磁 NiO，Ni1 和 Ni2 的磁矩相反。你应该观察到：
- **Ni1**：Spin 0 (Up) 的对角元数值较大（接近 1），Spin 1 (Down) 较小。
- **Ni2**：Spin 0 (Up) 数值较小，Spin 1 (Down) 较大。
如果两个原子的矩阵模式完全一样，说明你可能得到了铁磁态或非磁态，计算失败。

---

## 4.2 电子结构与磁性分析

计算正常结束（收敛）后，我们需要验证物理结果。对于 NiO 这样的强关联反铁磁绝缘体，主要关注**带隙**和**磁序**。

### 4.2.1 带隙验证 (Band Gap)

DFT+U 的主要目的之一是修正 LDA/GGA 低估带隙的问题。
在 `INPUT` 中开启 `out_bandgap 1` 后，直接在日志中搜索 `E_bandgap`。

```text
E_bandgap               +0.205369322748               +2.794192983776
```
*   **解读**：NiO 实验带隙约为 3.6 - 4.0 eV。普通 PBE 计算可能得到 < 1 eV 甚至金属态。加上 U=5.0 eV 后，带隙应显著打开（如上例约 2.8 eV），虽然可能仍低于实验值，但定性性质已修正为绝缘体。

### 4.2.2 磁性分析 (关键！)

这是初学者最容易困惑的地方。我们需要验证体系是否处于**反铁磁态 (AFM)**。

**1. 全局磁矩检查**
在日志中搜索 `absolute magnetism`：
```text
      total magnetism (Bohr mag/cell) = 0.00000000
   absolute magnetism (Bohr mag/cell) = 3.35321634
```
*   **Total magnetism ≈ 0**：说明晶胞内总自旋向上电子数等于自旋向下电子数。这**不一定**是反铁磁，也可能是非磁性。
*   **Absolute magnetism >> 0**：说明局部存在强磁矩，只是矢量和为零。
*   **结论**：**Total=0 且 Absolute>0** 是反铁磁态的典型特征。

**2. 局部磁矩检查 (Mulliken 分析)**
为了确信是 Ni1 和 Ni2 反向排列，我们需要查看每个原子的磁矩。
确保 `INPUT` 中设置了 `out_mul 1`，打开输出目录下的 `Mulliken.txt`：

```text
Total Magnetism on atom  Ni1           1.8268646
Total Magnetism on atom  Ni2          -1.8268646
Total Magnetism on atom  O            -0.0000003
```
*   **验证**：
    *   Ni1 为正值（约 1.8 $\mu_B$）。
    *   Ni2 为负值（约 -1.8 $\mu_B$）。
    *   两者数值接近，符号相反。
    *   O 原子几乎无磁矩。
*   **判定**：恭喜，你成功得到了反铁磁基态。

> **常见错误回顾**：如果你在 `STRU` 中只写了一种 `Ni`，你是无法设置这种反铁磁序的，因为所有 Ni 原子会被强制赋予相同的初始磁矩和 U 值行为。

---

## 4.3 进阶工作流：使用 OMC 锁定基态

在复杂的氧化物或强关联体系中，DFT+U 计算容易陷入亚稳态（Local Minimum）。ABACUS 提供了 **Occupation Matrix Control (OMC)** 功能，允许我们显式地控制和固定电子占据情况。

**推荐的“两步走”工作流：**

### 第一步：跑通标准 DFT+U (`omc=0`)
按照 4.1 和 4.2 节的方法，先进行一次标准的 SCF 计算。确保 `INPUT` 中：
```bash
dft_plus_u 1
omc        0
out_chg    1  # 必须开启，以便输出占据矩阵文件
```
计算完成后，检查 `OUT.suffix/` 目录，你会发现一个名为 `onsite.dm` 的文件。这个文件记录了计算收敛后的 5x5 占据矩阵。

### 第二步：固定占据矩阵 (`omc=2`)
如果你对第一步得到的磁序和电子态满意，并希望在后续计算（如能带结构、态密度或结构弛豫）中**强制保持**这种电子态，防止电子“跑”到其他亚稳态，请执行以下操作：

1.  **复制文件**：将 `OUT.suffix/onsite.dm` 复制到工作目录，并重命名为 `initial_onsite.dm`。
    ```bash
    cp OUT.NiO/onsite.dm ./initial_onsite.dm
    ```
2.  **修改 INPUT**：
    ```bash
    dft_plus_u 1
    omc        2  # 关键：设置为2，表示读取并锁定占据矩阵
    ```
3.  **重新运行**：再次运行 ABACUS。

此时，程序在 SCF 过程中将不再更新占据矩阵，而是始终使用 `initial_onsite.dm` 中的值。这对于计算**非共线磁性**或研究**特定轨道序**（Orbital Ordering）非常有效。

---

### 本章小结

1.  **看日志**：不要只看能量，务必检查 `running_scf.log` 中的 `L(S)DA+U` 区块，确认 U 值加对了位置。
2.  **看磁性**：反铁磁的特征是 `Total Magnetism ≈ 0` 但 `Absolute Magnetism > 0`，且 Mulliken 分析显示原子磁矩反向。
3.  **用 OMC**：利用 `omc=2` 和 `initial_onsite.dm` 可以“冻结”电子态，是处理复杂强关联体系的高级技巧。

下一章，我们将探讨如何基于这些正确的电子态结果，进一步计算能带结构（Band Structure）和态密度（DOS）。