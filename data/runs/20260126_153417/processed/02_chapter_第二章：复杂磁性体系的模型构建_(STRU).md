# 第二章：复杂磁性体系的模型构建 (STRU)

在第一章中，我们已经熟悉了 ABACUS 的基本输入输出。进入本章，我们将面对计算材料学中极具挑战性的领域——**强关联磁性体系**。

对于像氧化镍 (NiO) 这样的反铁磁绝缘体，标准的 DFT (LDA/GGA) 往往会错误地将其预测为金属。为了修正这一问题，我们需要引入 Hubbard U 校正 (DFT+U)。然而，**计算成败的基石并非仅仅在于 U 值的选取，更在于 `STRU` 文件中对原子结构的正确定义**。

本章将以反铁磁 NiO 为例，手把手教你如何通过“拆分原子类型”来构建复杂的磁性模型。

> **⚠️ 核心提示**：本章介绍的 DFT+U 及原子类型拆分功能，主要基于 **LCAO 基组** (`basis_type lcao`)。请确保你的 `INPUT` 文件中已正确设置该参数。

---

## 2.1 案例分析：反铁磁 NiO 体系

NiO 是典型的反铁磁 (Antiferromagnetic, AFM) 材料。在其晶胞中，虽然所有的镍原子在化学上都是同一种元素，但在磁学性质上，它们分为两类：
- **自旋向上 (Spin Up)** 的 Ni 原子
- **自旋向下 (Spin Down)** 的 Ni 原子

如果我们直接在 `STRU` 中将所有镍原子定义为同一种 `Ni`，程序在初始化时会默认赋予它们相同的初始磁矩，导致 SCF 迭代极易收敛到铁磁态 (FM) 或无磁态 (NM)，而非我们预期的反铁磁基态。

**解决方案**：在计算物理层面，我们需要打破对称性，将同种元素人为地“拆分”为两种不同的原子类型（Atomic Species），例如 `Ni1` 和 `Ni2`，并分别赋予相反的初始磁矩。

---

## 2.2 STRU 文件的特殊定义

构建反铁磁 NiO 的 `STRU` 文件主要包含两个关键步骤：定义原子种类和设置原子坐标（含磁矩）。

### 2.2.1 定义 ATOMIC_SPECIES

在 `ATOMIC_SPECIES` 区块中，我们需要定义三类原子：`Ni1`, `Ni2` 和 `O`。
**关键技巧**：`Ni1` 和 `Ni2` 虽然名字不同，但必须使用**完全相同**的原子质量、赝势文件和轨道文件。

```abacus
ATOMIC_SPECIES
Ni1 58.693 Ni_ONCV_PBE-1.0.upf
Ni2 58.693 Ni_ONCV_PBE-1.0.upf
O   15.999 O_ONCV_PBE-1.0.upf
# 注意：这里假设使用了对应的数值原子轨道文件，通常在 NUMERICAL_ORBITAL 部分定义，或集成在 upf 中(视具体版本而定)
```

### 2.2.2 设置 ATOMIC_POSITIONS 与初始磁矩

在 `ATOMIC_POSITIONS` 区块中，我们需要显式地指定每种原子的初始磁矩 (`mag_mom`)。这是引导 SCF 收敛到正确磁序的关键。

**STRU 文件示例片段**：

```abacus
ATOMIC_POSITIONS
Direct  # 使用分数坐标

Ni1     # 第一种 Ni（自旋向上）
2.0     # 【关键】初始磁矩设为 +2.0 muB
1       # 原子数量
0.0 0.0 0.0 1 1 1

Ni2     # 第二种 Ni（自旋向下）
-2.0    # 【关键】初始磁矩设为 -2.0 muB
1       # 原子数量
0.5 0.5 0.5 1 1 1

O       # 氧原子
0.0     # 初始磁矩为 0
2       # 原子数量
0.25 0.25 0.25 1 1 1
0.75 0.75 0.75 1 1 1
```

> **专家解读**：这里的 `2.0` 和 `-2.0` 只是**初始猜测值**。它们的作用是打破初始电荷密度的自旋对称性。最终收敛后的磁矩由 SCF 迭代计算决定，通常不会严格等于初始值。

---

## 2.3 INPUT 文件中的 DFT+U 设置

在 `STRU` 文件将 Ni 拆分为 `Ni1` 和 `Ni2` 后，`INPUT` 文件中的 DFT+U 参数必须与之一一对应。这是初学者最容易出错的地方。

### 2.3.1 核心参数对应法则

ABACUS 通过数组的形式读取 U 值。**数组的长度和顺序必须严格对应 `ATOMIC_SPECIES` 中定义的原子类型顺序。**

假设 `STRU` 中原子顺序为：`Ni1`, `Ni2`, `O`。

`INPUT` 文件设置如下：

```abacus
# Parameter DFT+U
dft_plus_u      1             # 开启 DFT+U 功能
orbital_corr    2 2 -1        # 对应 Ni1(d), Ni2(d), O(无)
hubbard_u       5.0 5.0 0.0   # 对应 U值：Ni1=5.0eV, Ni2=5.0eV, O=0.0eV
```

### 2.3.2 参数详解
- **`dft_plus_u`**: 总开关。设为 `1` 开启计算，设为 `0` 则忽略后续参数（即退化为标准 DFT）。
- **`orbital_corr` (数组)**: 指定对哪个轨道加 U。
    - `2`: 对 d 轨道加 U（过渡金属常用）。
    - `3`: 对 f 轨道加 U（稀土元素常用）。
    - `-1`: 不加 U。
    - **注意**：数组个数必须等于 `ntype`（原子种类数）。
- **`hubbard_u` (数组)**: 指定 U 的数值（单位：eV）。
    - 顺序必须与 `orbital_corr` 完全一致。
    - 即使 `orbital_corr` 设为 `-1`，这里也需要占位（通常填 `0.0`）。

> **⚠️ 严重警告**：如果你的 `STRU` 定义了 3 种原子，但 `hubbard_u` 只写了 2 个数，程序可能会报错或产生不可预知的物理结果。请务必反复检查数组长度！

---

## 2.4 进阶工作流：OMC (Occupation Matrix Control)

对于强关联体系，DFT+U 计算容易陷入亚稳态（Local Minimum）。为了锁定正确的电子基态，ABACUS 提供了占据矩阵控制（OMC）功能。建议采用以下“两步走”策略：

### 第一步：标准 DFT+U 计算 (`omc=0`)
先进行一次标准的自洽计算，让程序自动寻找占据矩阵。

1.  设置 `INPUT`: `omc 0` (默认值)。
2.  设置 `out_chg 1`: 确保输出电荷密度和占据矩阵文件。
3.  运行计算。
4.  检查结果（详见 2.5 节）。

### 第二步：固定占据矩阵计算 (`omc=2`)
如果第一步得到了预期的反铁磁态，我们可以将生成的占据矩阵作为“模板”固定下来，用于后续的能带结构或性质计算，防止波函数漂移。

1.  **准备文件**: 将第一步输出目录 `OUT.NiO/` 下的 `onsite.dm` 复制到工作目录，并重命名为 `initial_onsite.dm`。
    ```bash
    cp OUT.NiO/onsite.dm ./initial_onsite.dm
    ```
2.  **修改 INPUT**:
    ```abacus
    omc 2               # 读入 initial_onsite.dm 并全程固定该矩阵
    ```
3.  **重新运行**: 此时程序将强制电子占据特定的轨道构型。

---

## 2.5 结果验证：如何确认计算正确？

计算完成后，不要只看总能量，必须通过日志文件确认物理图像是否正确。

### 1. 检查 U 值读取 (`running_scf.log`)
打开日志文件，搜索 `L(S)DA+U` 区块，确认程序是否正确解析了你的设置：

```text
 atom_type=0  L=2  chi=0    U=5ev  <-- 对应 Ni1
 atom_type=1  L=2  chi=0    U=5ev  <-- 对应 Ni2
```
如果这里显示的 U 值或 L 值与预期不符，请立即检查 `INPUT` 中的数组顺序。

### 2. 检查磁序 (`running_scf.log` 或 `Mulliken.txt`)
搜索 `absolute magnetism`：

```text
      total magnetism (Bohr mag/cell) = 0.00000000  <-- 反铁磁总磁矩应接近 0
   absolute magnetism (Bohr mag/cell) = 3.35321634  <-- 绝对磁矩应很大
```

如果 `total magnetism` 很大（例如接近 4.0），说明计算收敛到了铁磁态（FM），你需要检查 `STRU` 中的初始磁矩符号是否设置正确，或者尝试增大初始磁矩数值以增强引导能力。

此外，查看 Mulliken 电荷分析（需设置 `out_mul 1`）：
```text
Total Magnetism on atom  Ni1           1.82...
Total Magnetism on atom  Ni2          -1.82...
```
确认 Ni1 和 Ni2 的磁矩符号相反且数值接近。

---

## 本章总结
1.  **拆分原子**：处理反铁磁或电荷有序体系时，必须在 `STRU` 中将同种元素拆分为不同的 `Species`（如 `Ni1`, `Ni2`）。
2.  **数组对齐**：`INPUT` 中的 `hubbard_u` 和 `orbital_corr` 数组必须与 `STRU` 中的原子种类一一对应。
3.  **磁矩引导**：在 `ATOMIC_POSITIONS` 中明确指定相反的初始磁矩。
4.  **OMC 锁定**：利用 `omc=2` 和 `initial_onsite.dm` 可以有效锁定复杂的磁性基态。

掌握了这些技巧，你就迈过了强关联体系计算的第一道门槛。下一章，我们将深入探讨如何进行能带结构与态密度（DOS）的计算与分析。