# ABACUS 实战教程：强关联体系的 DFT+U 计算

## 前言

欢迎阅读《ABACUS 实战教程：强关联体系的 DFT+U 计算》。在凝聚态物理和材料科学的研究中，过渡金属氧化物、稀土化合物等强关联体系一直是对第一性原理计算的巨大挑战。传统的 LDA 或 GGA 泛函往往由于自相互作用误差，无法准确描述这些体系中局域电子的关联效应。ABACUS 作为一款优秀的国产第一性原理计算软件，在数值原子轨道（LCAO）基组下实现了高效且直观的 DFT+U 功能，为科研工作者处理这类复杂体系提供了强有力的工具。

**学习路线图**
本教程采用循序渐进的实战模式，带你攻克强关联计算的重重难关：
1.  **理论基石**：第一章探讨强关联体系的物理本质及为何需要引入 Hubbard U 修正。
2.  **模型构建**：第二章聚焦 `STRU` 文件，手把手教你通过“原子拆分”技巧构建反铁磁（AFM）等复杂磁性模型。
3.  **核心配置**：第三章深入 `INPUT` 文件，解析参数数组与原子类型之间的索引映射逻辑，这是计算成败的关键。
4.  **结果验证**：第四章讲解如何通过日志文件和占据矩阵验证计算的物理正确性。
5.  **高阶调控**：第五章介绍占据矩阵控制（OMC）技术，帮助你摆脱“亚稳态困境”，锁定电子基态。

**知识体系定位**
本教程是 ABACUS 高阶应用序列的重要组成部分。它不仅是 DFT+U 功能的操作指南，更是连接基础 DFT 计算与强关联物理前沿的桥梁。教程中的算法细节参考了 Qu 等人于 2022 年发表在 *The Journal of Chemical Physics* 上的重要研究工作（DOI: 10.1063/5.0090122），代表了目前 LCAO 基组下 DFT+U 实现的主流水平。

**前置要求**
在开始本教程前，我们假设你已经：
- 掌握了密度泛函理论（DFT）的基本概念。
- 熟悉 ABACUS 的基本操作流程（准备赝势、轨道文件及基础 SCF 计算）。
- 能够在 Linux 环境下进行基础的文件操作与脚本运行。

---

# 第一章：强关联体系与 ABACUS 计算基础

欢迎进入《ABACUS 实战教程》。在开始任何具体的代码操作之前，我们需要先建立正确的物理图像和软件操作逻辑。强关联体系（Strongly Correlated Systems）的计算一直是第一性原理计算中的难点，而 DFT+U 是一种在计算精度与成本之间取得平衡的有效方法。

本章将带你理解为什么标准 DFT 会失效，以及如何在 ABACUS 中正确地构建 DFT+U 的计算模型。

---

## 1.1 物理背景：为何需要 +U？

在密度泛函理论（DFT）的框架下，标准的交换关联泛函（如 LDA 或 GGA-PBE）在处理大多数主族元素（s、p 轨道电子）时表现优异。然而，当涉及**过渡金属（d 轨道）**或**稀土元素（f 轨道）**时，标准 DFT 往往会遭遇滑铁卢。

### 1.1.1 自相互作用误差（Self-Interaction Error）
标准 DFT 泛函倾向于过度“离域化”电子。对于 d 或 f 轨道这种空间上高度局域的电子，LDA/GGA 会错误地将它们描述为弥散在整个晶体中。这种**自相互作用误差（SIE）**会导致以下典型物理问题：

1.  **带隙严重偏小**：本该是莫特绝缘体（Mott Insulator）的氧化物（如 NiO、FeO），在标准 DFT 下可能被计算为金属（带隙为 0）。
2.  **磁矩描述错误**：局域磁矩被低估，甚至导致磁序预测错误。
3.  **晶格常数偏差**：化学键强度描述不准，导致结构优化结果不可信。

### 1.1.2 Hubbard U 的修正思想
DFT+U 方法借鉴了 Hubbard 模型，在标准 DFT 能量泛函的基础上增加了一个修正项：
$$ E_{DFT+U} = E_{DFT} + \frac{U}{2} \sum_{I,\sigma} \left[ n_{I,\sigma} (1 - n_{I,\sigma}) \right] $$
这里的 $U$ 代表**库仑排斥能**（On-site Coulomb Interaction）。简单来说，我们强制给占据同一局域轨道的电子之间增加额外的排斥力，迫使电子更加“局域化”。这就像是给电子穿上了“紧身衣”，修正了过度离域的问题，从而正确打开带隙并恢复局域磁矩。

---

## 1.2 ABACUS 的实现前提与核心限制

ABACUS 作为一款基于数值原子轨道（LCAO）和平面波（PW）双基组的软件，其 DFT+U 功能有特定的实现方式。**请务必牢记以下限制，这是新手最容易报错的地方。**

### 1.2.1 核心限制：必须使用 LCAO 基组
目前 ABACUS 的 DFT+U 功能**仅支持数值原子轨道基组**。

*   **INPUT 设置**：必须确保 `basis_type` 参数设置为 `lcao`。
*   **文件需求**：除了 `.upf` 赝势文件外，你必须为每种元素提供对应的 `.orb` 轨道文件。

> **警告**：如果你在 `basis_type pw`（平面波模式）下设置了 +U 参数，程序通常会忽略这些设置或报错，导致你得到的是标准 DFT 的结果。

### 1.2.2 关键技巧：处理反铁磁体系（以 NiO 为例）
在处理像 NiO 这样的反铁磁（AFM）体系时，晶胞中相邻的 Ni 原子磁矩方向相反（一个为 +2 $\mu_B$，一个为 -2 $\mu_B$）。

在 ABACUS 的 `STRU` 文件中，为了正确初始化这种磁序，**必须将同一种元素拆分为不同的“原子种类（Species）”**。

**错误做法**：只定义一种 Ni，试图在坐标部分区分磁矩（ABACUS 处理起来较困难）。
**正确做法**：定义 `Ni1` 和 `Ni2`。

#### 示例：STRU 文件片段
```plaintext
ATOMIC_SPECIES
Ni1 58.693 Ni_ONCV_PBE-1.0.upf
Ni2 58.693 Ni_ONCV_PBE-1.0.upf
O   15.999 O_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
4.17

LATTICE_VECTORS
0.5 0.5 1.0
0.5 1.0 0.5
1.0 0.5 0.5

ATOMIC_POSITIONS
Direct

Ni1
0.0
0.0 0.0 0.0 2.0  // 最后的 2.0 为初始磁矩 mag

Ni2
0.0
1.0 1.0 1.0 -2.0 // 最后的 -2.0 为初始磁矩 mag

O
2.0
0.5 0.5 0.5 0.0
1.5 1.5 1.5 0.0
```

### 1.2.3 参数数组的严格对应关系
在 `INPUT` 文件中，`orbital_corr`（指定加 U 的轨道）和 `hubbard_u`（U 值大小）是数组形式。

**规则**：数组的长度和顺序必须与 `STRU` 文件中 `ATOMIC_SPECIES` 的行数**严格一致**。

对应上文的 `STRU`（顺序：Ni1, Ni2, O），`INPUT` 设置如下：

```plaintext
INPUT_PARAMETERS
# ... 其他基础参数 ...
basis_type      lcao
nspin           2      # 开启自旋极化

# DFT+U 核心参数
dft_plus_u      1      # 开启功能开关
# 对应关系：     Ni1  Ni2  O
orbital_corr    2    2    -1
hubbard_u       5.0  5.0  0.0
```

*   **orbital_corr**:
    *   `2`: 对 d 轨道加 U（Ni1 和 Ni2）。
    *   `-1`: 不加 U（O 原子）。
    *   *(注：0=s, 1=p, 2=d, 3=f)*
*   **hubbard_u**:
    *   单位为 eV。这里对 Ni 的 d 轨道加 5.0 eV 的 U 值。

---

## 1.3 实战工作流：从标准计算到 OMC 锁定

在强关联体系中，电子很容易陷入亚稳态（Metastable State），导致计算收敛到错误的磁基态。为了解决这个问题，ABACUS 提供了**占据矩阵控制（Occupation Matrix Control, OMC）**功能。

建议采用以下“两步走”策略：

### 第一步：跑通标准 DFT+U (`omc=0`)
首先进行一次标准的自洽计算，让程序自由寻找基态。

**INPUT 设置**:
```plaintext
dft_plus_u      1
omc             0      # 默认值，标准计算
out_chg         1      # 重要！这会输出电荷密度和 onsite.dm
```

**结果验证**:
计算结束后，检查输出目录（如 `OUT.NiO/`）下的 `running_scf.log`：
1.  搜索 `L(S)DA+U` 区块，确认程序正确读入了 U 值。
    ```plaintext
    atom_type=0  L=2  chi=0    U=5ev  <-- 确认 U 值生效
    ```
2.  搜索 `absolute magnetism`，确认得到了反铁磁态。
    *   理想情况：`total magnetism` 接近 0（抵消），但 `absolute magnetism` 很大（如 > 3.0 $\mu_B$/cell）。

### 第二步：锁定占据矩阵 (`omc=2`)
如果第一步得到了正确的磁序和电子态，我们可以将此时的占据矩阵“锁定”，用于后续更复杂的计算（如能带结构、DOS 或 结构弛豫），防止电子态在后续计算中发生坍塌或翻转。

**操作流程**:
1.  找到第一步输出的 `onsite.dm` 文件（位于输出目录中）。
2.  将其复制到工作目录，并重命名为 `initial_onsite.dm`。
3.  修改 `INPUT` 文件：
    ```plaintext
    omc             2      # 锁定模式：读取 initial_onsite.dm 并在计算中保持不变
    ```
4.  重新运行计算。

> **专家提示**：`omc=2` 对于复杂氧化物（如含稀土元素的钙钛矿）非常关键。在这些体系中，f 电子非常容易跑偏，先用小基组或受限条件跑出一个合理的 `onsite.dm`，然后用 `omc=2` 锁住它去跑高精度计算，是资深用户的常用技巧。

---

## 1.4 本章小结

在动手计算前，请确认你已准备好以下清单：
1.  [ ] **基组检查**：确认使用 `basis_type lcao` 及对应的 `.orb` 文件。
2.  [ ] **结构处理**：反铁磁体系是否已将磁性原子拆分为不同 Species（如 Ni1, Ni2）。
3.  [ ] **参数对应**：`orbital_corr` 和 `hubbard_u` 的数组长度是否等于 Species 数量。
4.  [ ] **策略选择**：决定是直接计算还是使用 OMC 工作流。

下一章，我们将基于这些知识，手把手带你完成 NiO 的反铁磁基态计算与能带分析。

# 第二章：复杂磁性体系的模型构建 (STRU)

在第一章中，我们已经熟悉了 ABACUS 的基本输入输出。进入本章，我们将面对计算材料学中极具挑战性的领域——**强关联磁性体系**。

对于像氧化镍 (NiO) 这样的反铁磁绝缘体，标准的 DFT (LDA/GGA) 往往会错误地将其预测为金属。为了修正这一问题，我们需要引入 Hubbard U 校正 (DFT+U)。然而，**计算成败的基石并非仅仅在于 U 值的选取，更在于 `STRU` 文件中对原子结构的正确定义**。

本章将以反铁磁 NiO 为例，手把手教你如何通过“拆分原子类型”来构建复杂的磁性模型。

> **⚠️ 核心提示**：本章介绍的 DFT+U 及原子类型拆分功能，主要基于 **LCAO 基组** (`basis_type lcao`)。请确保你的 `INPUT` 文件中已正确设置该参数。

---

## 2.1 案例分析：反铁磁 NiO 体系

NiO 是典型的反铁磁 (Antiferromagnetic, AFM) 材料。在其晶胞中，虽然所有的镍原子在化学上都是同一种元素，但在磁学性质上，它们分为两类：
- **自旋向上 (Spin Up)** 的 Ni 原子
- **自旋向下 (Spin Down)** 的 Ni 原子

如果我们直接在 `STRU` 中将所有镍原子定义为同一种 `Ni`，程序在初始化时会默认赋予它们相同的初始磁矩，导致 SCF 迭代极易收敛到铁磁态 (FM) 或无磁态 (NM)，而非我们预期的反铁磁基态。

**解决方案**：在计算物理层面，我们需要打破对称性，将同种元素人为地“拆分”为两种不同的原子类型（Atomic Species），例如 `Ni1` 和 `Ni2`，并分别赋予相反的初始磁矩。

---

## 2.2 STRU 文件的特殊定义

构建反铁磁 NiO 的 `STRU` 文件主要包含两个关键步骤：定义原子种类和设置原子坐标（含磁矩）。

### 2.2.1 定义 ATOMIC_SPECIES

在 `ATOMIC_SPECIES` 区块中，我们需要定义三类原子：`Ni1`, `Ni2` 和 `O`。
**关键技巧**：`Ni1` 和 `Ni2` 虽然名字不同，但必须使用**完全相同**的原子质量、赝势文件和轨道文件。

```abacus
ATOMIC_SPECIES
Ni1 58.693 Ni_ONCV_PBE-1.0.upf
Ni2 58.693 Ni_ONCV_PBE-1.0.upf
O   15.999 O_ONCV_PBE-1.0.upf
# 注意：这里假设使用了对应的数值原子轨道文件，通常在 NUMERICAL_ORBITAL 部分定义，或集成在 upf 中(视具体版本而定)
```

### 2.2.2 设置 ATOMIC_POSITIONS 与初始磁矩

在 `ATOMIC_POSITIONS` 区块中，我们需要显式地指定每种原子的初始磁矩 (`mag_mom`)。这是引导 SCF 收敛到正确磁序的关键。

**STRU 文件示例片段**：

```abacus
ATOMIC_POSITIONS
Direct  # 使用分数坐标

Ni1     # 第一种 Ni（自旋向上）
2.0     # 【关键】初始磁矩设为 +2.0 muB
1       # 原子数量
0.0 0.0 0.0 1 1 1

Ni2     # 第二种 Ni（自旋向下）
-2.0    # 【关键】初始磁矩设为 -2.0 muB
1       # 原子数量
0.5 0.5 0.5 1 1 1

O       # 氧原子
0.0     # 初始磁矩为 0
2       # 原子数量
0.25 0.25 0.25 1 1 1
0.75 0.75 0.75 1 1 1
```

> **专家解读**：这里的 `2.0` 和 `-2.0` 只是**初始猜测值**。它们的作用是打破初始电荷密度的自旋对称性。最终收敛后的磁矩由 SCF 迭代计算决定，通常不会严格等于初始值。

---

## 2.3 INPUT 文件中的 DFT+U 设置

在 `STRU` 文件将 Ni 拆分为 `Ni1` 和 `Ni2` 后，`INPUT` 文件中的 DFT+U 参数必须与之一一对应。这是初学者最容易出错的地方。

### 2.3.1 核心参数对应法则

ABACUS 通过数组的形式读取 U 值。**数组的长度和顺序必须严格对应 `ATOMIC_SPECIES` 中定义的原子类型顺序。**

假设 `STRU` 中原子顺序为：`Ni1`, `Ni2`, `O`。

`INPUT` 文件设置如下：

```abacus
# Parameter DFT+U
dft_plus_u      1             # 开启 DFT+U 功能
orbital_corr    2 2 -1        # 对应 Ni1(d), Ni2(d), O(无)
hubbard_u       5.0 5.0 0.0   # 对应 U值：Ni1=5.0eV, Ni2=5.0eV, O=0.0eV
```

### 2.3.2 参数详解
- **`dft_plus_u`**: 总开关。设为 `1` 开启计算，设为 `0` 则忽略后续参数（即退化为标准 DFT）。
- **`orbital_corr` (数组)**: 指定对哪个轨道加 U。
    - `2`: 对 d 轨道加 U（过渡金属常用）。
    - `3`: 对 f 轨道加 U（稀土元素常用）。
    - `-1`: 不加 U。
    - **注意**：数组个数必须等于 `ntype`（原子种类数）。
- **`hubbard_u` (数组)**: 指定 U 的数值（单位：eV）。
    - 顺序必须与 `orbital_corr` 完全一致。
    - 即使 `orbital_corr` 设为 `-1`，这里也需要占位（通常填 `0.0`）。

> **⚠️ 严重警告**：如果你的 `STRU` 定义了 3 种原子，但 `hubbard_u` 只写了 2 个数，程序可能会报错或产生不可预知的物理结果。请务必反复检查数组长度！

---

## 2.4 进阶工作流：OMC (Occupation Matrix Control)

对于强关联体系，DFT+U 计算容易陷入亚稳态（Local Minimum）。为了锁定正确的电子基态，ABACUS 提供了占据矩阵控制（OMC）功能。建议采用以下“两步走”策略：

### 第一步：标准 DFT+U 计算 (`omc=0`)
先进行一次标准的自洽计算，让程序自动寻找占据矩阵。

1.  设置 `INPUT`: `omc 0` (默认值)。
2.  设置 `out_chg 1`: 确保输出电荷密度和占据矩阵文件。
3.  运行计算。
4.  检查结果（详见 2.5 节）。

### 第二步：固定占据矩阵计算 (`omc=2`)
如果第一步得到了预期的反铁磁态，我们可以将生成的占据矩阵作为“模板”固定下来，用于后续的能带结构或性质计算，防止波函数漂移。

1.  **准备文件**: 将第一步输出目录 `OUT.NiO/` 下的 `onsite.dm` 复制到工作目录，并重命名为 `initial_onsite.dm`。
    ```bash
    cp OUT.NiO/onsite.dm ./initial_onsite.dm
    ```
2.  **修改 INPUT**:
    ```abacus
    omc 2               # 读入 initial_onsite.dm 并全程固定该矩阵
    ```
3.  **重新运行**: 此时程序将强制电子占据特定的轨道构型。

---

## 2.5 结果验证：如何确认计算正确？

计算完成后，不要只看总能量，必须通过日志文件确认物理图像是否正确。

### 1. 检查 U 值读取 (`running_scf.log`)
打开日志文件，搜索 `L(S)DA+U` 区块，确认程序是否正确解析了你的设置：

```text
 atom_type=0  L=2  chi=0    U=5ev  <-- 对应 Ni1
 atom_type=1  L=2  chi=0    U=5ev  <-- 对应 Ni2
```
如果这里显示的 U 值或 L 值与预期不符，请立即检查 `INPUT` 中的数组顺序。

### 2. 检查磁序 (`running_scf.log` 或 `Mulliken.txt`)
搜索 `absolute magnetism`：

```text
      total magnetism (Bohr mag/cell) = 0.00000000  <-- 反铁磁总磁矩应接近 0
   absolute magnetism (Bohr mag/cell) = 3.35321634  <-- 绝对磁矩应很大
```

如果 `total magnetism` 很大（例如接近 4.0），说明计算收敛到了铁磁态（FM），你需要检查 `STRU` 中的初始磁矩符号是否设置正确，或者尝试增大初始磁矩数值以增强引导能力。

此外，查看 Mulliken 电荷分析（需设置 `out_mul 1`）：
```text
Total Magnetism on atom  Ni1           1.82...
Total Magnetism on atom  Ni2          -1.82...
```
确认 Ni1 和 Ni2 的磁矩符号相反且数值接近。

---

## 本章总结
1.  **拆分原子**：处理反铁磁或电荷有序体系时，必须在 `STRU` 中将同种元素拆分为不同的 `Species`（如 `Ni1`, `Ni2`）。
2.  **数组对齐**：`INPUT` 中的 `hubbard_u` 和 `orbital_corr` 数组必须与 `STRU` 中的原子种类一一对应。
3.  **磁矩引导**：在 `ATOMIC_POSITIONS` 中明确指定相反的初始磁矩。
4.  **OMC 锁定**：利用 `omc=2` 和 `initial_onsite.dm` 可以有效锁定复杂的磁性基态。

掌握了这些技巧，你就迈过了强关联体系计算的第一道门槛。下一章，我们将深入探讨如何进行能带结构与态密度（DOS）的计算与分析。

# 第三章：核心参数配置与数组映射 (INPUT)

在上一章中，我们已经完成了 `STRU` 文件的构建，特别是针对反铁磁氧化镍（NiO）体系，我们将镍原子人为拆分成了 `Ni1`（自旋向上）和 `Ni2`（自旋向下）两种原子类型（Atomic Species）。

本章将进入 ABACUS 计算的核心控制室——`INPUT` 文件。对于 DFT+U 计算而言，最关键的逻辑在于**建立 INPUT 参数数组与 STRU 原子类型之间严格的索引映射关系**。如果这种映射错位，程序将无法正确施加 Hubbard U 修正，导致物理结果完全错误。

> **⚠️ 核心前置条件**：
> 目前 ABACUS 的 DFT+U 功能**仅支持 LCAO 基组**。请务必在 `INPUT` 文件中确认设置了 `basis_type lcao`。

---

## 3.1 激活 DFT+U 计算

在 `INPUT` 文件中，开启 +U 功能需要一个总开关。

### 关键参数：`dft_plus_u`
*   **类型**: Boolean / Integer
*   **默认值**: 0 (False)
*   **说明**:
    *   `0`：关闭功能。即使你设置了后面提到的 U 值参数，程序也会完全忽略它们，执行标准的 DFT (LDA/GGA) 计算。
    *   `1`：激活 DFT+U 模块。

**示例代码**：
```bash
INPUT_PARAMETERS
# ... 其他常规参数 ...
basis_type      lcao    # 必须是 lcao
dft_plus_u      1       # 开启 +U 总开关
```

---

## 3.2 轨道与 U 值的数组映射 (核心逻辑)

这是初学者最容易出错的地方。ABACUS 不通过元素符号（如 "Ni"）来识别加 U 的对象，而是通过**原子类型的索引顺序**。

### 映射规则
在 `STRU` 文件中 `ATOMIC_SPECIES` 块定义的原子类型数量记为 `ntype`。在 `INPUT` 文件中，`orbital_corr` 和 `hubbard_u` 这两个参数必须是**长度为 `ntype` 的数组**，且顺序必须与 `STRU` 中的定义严格一一对应。

### 案例演示：反铁磁 NiO
假设你的 `STRU` 文件定义如下（注意顺序）：

**STRU 文件片段**：
```bash
ATOMIC_SPECIES
Ni1 58.693 Ni_ONCV_PBE-1.0.upf  # 索引 1 (程序内部通常从0计数，这里指第一类)
Ni2 58.693 Ni_ONCV_PBE-1.0.upf  # 索引 2
O   15.999 O_ONCV_PBE-1.0.upf   # 索引 3
```
这里 `ntype = 3`。我们需要对 `Ni1` 和 `Ni2` 的 d 轨道加 U，对 `O` 不加 U。

### 关键参数详解

#### 1. `orbital_corr` (轨道校正类型)
*   **描述**: 指定每种原子类型需要进行 +U 修正的角动量量子数 $l$。
*   **取值**:
    *   `-1`: 不进行修正（用于非关联原子，如氧、碳等）。
    *   `2`: 对 d 轨道进行修正（过渡金属常见设置）。
    *   `3`: 对 f 轨道进行修正（镧系/锕系元素）。
*   **数组设置**:
    *   对应 `Ni1`: d 轨道 -> `2`
    *   对应 `Ni2`: d 轨道 -> `2`
    *   对应 `O`: 无 -> `-1`
    *   **结果**: `2 2 -1`

#### 2. `hubbard_u` (U 值大小)
*   **描述**: 指定对应轨道的有效 U 值（Hubbard U effective），单位为 **eV**。
*   **注意**: 即使对应的 `orbital_corr` 为 -1，这里也必须填一个占位数值（通常填 0.0），以保持数组长度一致。
*   **数组设置**:
    *   对应 `Ni1`: 5.0 eV
    *   对应 `Ni2`: 5.0 eV
    *   对应 `O`: 0.0 eV
    *   **结果**: `5.0 5.0 0.0`

### 完整的 INPUT 配置块
将上述逻辑整合，你的 `INPUT` 文件中关于 DFT+U 的部分应如下所示：

```bash
#Parameter DFT+U
dft_plus_u      1             # 激活开关
orbital_corr    2 2 -1        # 对应 STRU 中的: Ni1(d), Ni2(d), O(none)
hubbard_u       5.0 5.0 0.0   # 对应 U 值: 5.0eV, 5.0eV, 0.0eV
```

> **专家提示 (Ni1 与 Ni2 的拆分意义)**：
> 你可能会问，为什么不直接写一个 Ni？
> 在反铁磁计算中，我们需要在 `STRU` 的 `ATOM_FILES` 块中为不同原子指定相反的初始磁矩（如 `mag 2.0` 和 `mag -2.0`）。虽然 ABACUS 允许对同一种类型的不同原子设置不同磁矩，但为了逻辑清晰以及后续可能针对不同自旋态微调 U 值（虽然本例中 U 值相同），将它们定义为不同的 `Species` (Ni1, Ni2) 是最稳健的做法。这也强制要求我们在 `INPUT` 中显式地为它们分别设置参数。

---

## 3.3 进阶工作流：占据矩阵控制 (OMC)

在强关联体系中，DFT+U 计算容易陷入亚稳态（Local Minima）。为了锁定正确的电子基态（如特定的轨道序或磁序），ABACUS 提供了 `omc` (Occupation Matrix Control) 参数。

### 推荐工作流

#### 第一步：标准自洽计算 (`omc 0`)
首先进行标准的 DFT+U 计算，让电子密度自由弛豫。
*   **参数**: `omc 0` (默认值)
*   **目的**: 获得初步的收敛态，检查磁矩方向是否正确。

#### 第二步：锁定占据矩阵 (`omc 2`)
如果第一步得到了正确的磁序（例如反铁磁态），但你担心在后续做结构弛豫或能带计算时电子态发生“跳变”，可以锁定当前的占据矩阵。

1.  **准备文件**: 第一步计算结束后，在输出目录（如 `OUT.NiO/`）中找到 `onsite.dm` 文件。将其复制到工作目录并重命名为 `initial_onsite.dm`。
    ```bash
    cp OUT.NiO/onsite.dm ./initial_onsite.dm
    ```
2.  **修改 INPUT**:
    ```bash
    omc 2  # 读入 initial_onsite.dm 并在整个计算过程中保持不变
    ```
3.  **重新运行**: 程序将强制使用你提供的占据矩阵，这对于复杂氧化物计算非常有效。

---

## 3.4 结果验证：你真的加上 U 了吗？

计算开始后，不要只看最后能量，必须检查日志文件 `running_scf.log` 确认参数是否被正确读入。

### 1. 检查 L(S)DA+U 区块
打开 `running_scf.log`，搜索 `L(S)DA+U`。你应该看到类似以下的输出：

```text
 ---------------------------------------------------------
 L(S)DA+U:
 atom_type=0  L=2  chi=0    U=5ev   <-- 对应 Ni1, d轨道, 5eV
 atom_type=1  L=2  chi=0    U=5ev   <-- 对应 Ni2, d轨道, 5eV
 ---------------------------------------------------------
```
*验证点*：确认 `atom_type` 的数量和 `U` 值与你的设想一致。如果没有这个区块，说明 `dft_plus_u` 可能没打开，或者 `basis_type` 不是 `lcao`。

### 2. 检查磁矩 (Magnetism)
对于反铁磁 NiO，总磁矩应该接近 0，但局部磁矩应该很大。
搜索 `absolute magnetism`：

```text
      total magnetism (Bohr mag/cell) = 0.00000000  <-- 反铁磁特征：总磁矩为0
   absolute magnetism (Bohr mag/cell) = 3.35321634  <-- 局域磁矩之和不为0
```

同时检查 Mulliken 分析（需设置 `out_mul 1`）：
```text
Total Magnetism on atom  Ni1           1.82...
Total Magnetism on atom  Ni2          -1.82...  <-- 确认符号相反
```

---

### 本章小结
1.  **开关**: `dft_plus_u 1` 且必须是 LCAO 基组。
2.  **映射**: `orbital_corr` 和 `hubbard_u` 的数组长度必须等于 `ntype`，顺序严格对应 `STRU`。
3.  **技巧**: 利用 `omc 2` 和 `initial_onsite.dm` 可以锁定复杂的电子基态。

下一章，我们将深入探讨如何通过 `running_scf.log` 和输出文件进行更详细的电子结构分析。

# 第四章：计算运行与结果验证

在上一章中，我们已经完成了 DFT+U 计算所需的 `INPUT` 和 `STRU` 文件设置。这是至关重要的一步，但经验告诉我们，参数设置正确并不代表计算结果一定符合物理预期。

作为开发者，我经常看到用户设置了 U 值，但由于原子类型顺序错误，导致 U 加到了错误的原子或轨道上；或者在强关联体系中，电子收敛到了错误的亚稳态（Local Minimum）。

本章我们将通过实际运行 NiO 的反铁磁（AFM）算例，深入解析 `running_scf.log` 日志文件，验证 U 值是否正确生效，并学习如何通过 **Occupation Matrix Control (OMC)** 技术锁定基态。

> **⚠️ 核心前提**：
> 目前 ABACUS 的 DFT+U 功能（包括 U 值修正与 OMC）**仅支持 LCAO 基组**。请务必确认你的 `INPUT` 文件中设置了 `basis_type lcao`。

---

## 4.1 运行 SCF 与日志检查

当你提交任务后（例如使用 `mpirun -n 8 abacus`），ABACUS 会生成标准输出文件（通常重定向为日志）和输出目录 `OUT.suffix/`。对于 DFT+U 计算，我们不能只看“是否收敛”，必须检查程序是否正确读入了 Hubbard U 参数。

### 4.1.1 验证 U 值加载 (`L(S)DA+U` 区块)

打开输出目录下的 `running_scf.log` 文件，搜索关键字 `L(S)DA+U`。这是程序初始化 DFT+U 模块的标志。

**检查重点：**
1.  **原子类型对应关系**：确认 `atom_type` 索引与 `STRU` 中 `ATOMIC_SPECIES` 的顺序是否一致。
2.  **轨道角动量 (L)**：确认 U 值是否加在了正确的轨道上（如过渡金属的 d 轨道，L=2）。
3.  **U 值大小**：确认数值是否为你设置的值（单位通常为 eV）。

**日志示例分析 (NiO 案例)**：
假设我们的 `STRU` 中原子顺序为 `Ni1`, `Ni2`, `O`，且 `INPUT` 设置如下：
```bash
# INPUT
orbital_corr 2 2 -1  # 对应 Ni1(d), Ni2(d), O(no U)
hubbard_u    5.0 5.0 0.0
```

你应该在日志中看到如下区块：
```text
 ---------------------------------------------------------
 L(S)DA+U:
 ---------------------------------------------------------
 atom_type=0  L=2  chi=0    U=5ev   <-- 对应 Ni1，d轨道，U=5.0
 atom_type=1  L=2  chi=0    U=5ev   <-- 对应 Ni2，d轨道，U=5.0
 ---------------------------------------------------------
```
> **开发者提示**：如果日志中没有出现这个区块，或者 `atom_type` 的数量少于预期，请立即检查 `dft_plus_u` 是否设为 1，以及 `orbital_corr` 数组长度是否与 `ATOMIC_SPECIES` 行数严格匹配。

### 4.1.2 监控占据矩阵 (Occupation Matrix)

在 SCF 迭代过程中，ABACUS 会在每一步输出当前的占据矩阵。这对于判断电子态的演化非常有用。

在日志中搜索 `atoms` 关键字，你会看到类似 5x5 的矩阵（对于 d 轨道）：
```text
 atoms  0       <-- 第1个原子 (Ni1)
 L  2           <-- d 轨道
 spin  0        <-- 自旋向上 (Spin Up)
 ... (5x5 矩阵数据) ...
 spin  1        <-- 自旋向下 (Spin Down)
 ... (5x5 矩阵数据) ...
```
**实战技巧**：
对于反铁磁 NiO，Ni1 和 Ni2 的磁矩相反。你应该观察到：
- **Ni1**：Spin 0 (Up) 的对角元数值较大（接近 1），Spin 1 (Down) 较小。
- **Ni2**：Spin 0 (Up) 数值较小，Spin 1 (Down) 较大。
如果两个原子的矩阵模式完全一样，说明你可能得到了铁磁态或非磁态，计算失败。

---

## 4.2 电子结构与磁性分析

计算正常结束（收敛）后，我们需要验证物理结果。对于 NiO 这样的强关联反铁磁绝缘体，主要关注**带隙**和**磁序**。

### 4.2.1 带隙验证 (Band Gap)

DFT+U 的主要目的之一是修正 LDA/GGA 低估带隙的问题。
在 `INPUT` 中开启 `out_bandgap 1` 后，直接在日志中搜索 `E_bandgap`。

```text
E_bandgap               +0.205369322748               +2.794192983776
```
*   **解读**：NiO 实验带隙约为 3.6 - 4.0 eV。普通 PBE 计算可能得到 < 1 eV 甚至金属态。加上 U=5.0 eV 后，带隙应显著打开（如上例约 2.8 eV），虽然可能仍低于实验值，但定性性质已修正为绝缘体。

### 4.2.2 磁性分析 (关键！)

这是初学者最容易困惑的地方。我们需要验证体系是否处于**反铁磁态 (AFM)**。

**1. 全局磁矩检查**
在日志中搜索 `absolute magnetism`：
```text
      total magnetism (Bohr mag/cell) = 0.00000000
   absolute magnetism (Bohr mag/cell) = 3.35321634
```
*   **Total magnetism ≈ 0**：说明晶胞内总自旋向上电子数等于自旋向下电子数。这**不一定**是反铁磁，也可能是非磁性。
*   **Absolute magnetism >> 0**：说明局部存在强磁矩，只是矢量和为零。
*   **结论**：**Total=0 且 Absolute>0** 是反铁磁态的典型特征。

**2. 局部磁矩检查 (Mulliken 分析)**
为了确信是 Ni1 和 Ni2 反向排列，我们需要查看每个原子的磁矩。
确保 `INPUT` 中设置了 `out_mul 1`，打开输出目录下的 `Mulliken.txt`：

```text
Total Magnetism on atom  Ni1           1.8268646
Total Magnetism on atom  Ni2          -1.8268646
Total Magnetism on atom  O            -0.0000003
```
*   **验证**：
    *   Ni1 为正值（约 1.8 $\mu_B$）。
    *   Ni2 为负值（约 -1.8 $\mu_B$）。
    *   两者数值接近，符号相反。
    *   O 原子几乎无磁矩。
*   **判定**：恭喜，你成功得到了反铁磁基态。

> **常见错误回顾**：如果你在 `STRU` 中只写了一种 `Ni`，你是无法设置这种反铁磁序的，因为所有 Ni 原子会被强制赋予相同的初始磁矩和 U 值行为。

---

## 4.3 进阶工作流：使用 OMC 锁定基态

在复杂的氧化物或强关联体系中，DFT+U 计算容易陷入亚稳态（Local Minimum）。ABACUS 提供了 **Occupation Matrix Control (OMC)** 功能，允许我们显式地控制和固定电子占据情况。

**推荐的“两步走”工作流：**

### 第一步：跑通标准 DFT+U (`omc=0`)
按照 4.1 和 4.2 节的方法，先进行一次标准的 SCF 计算。确保 `INPUT` 中：
```bash
dft_plus_u 1
omc        0
out_chg    1  # 必须开启，以便输出占据矩阵文件
```
计算完成后，检查 `OUT.suffix/` 目录，你会发现一个名为 `onsite.dm` 的文件。这个文件记录了计算收敛后的 5x5 占据矩阵。

### 第二步：固定占据矩阵 (`omc=2`)
如果你对第一步得到的磁序和电子态满意，并希望在后续计算（如能带结构、态密度或结构弛豫）中**强制保持**这种电子态，防止电子“跑”到其他亚稳态，请执行以下操作：

1.  **复制文件**：将 `OUT.suffix/onsite.dm` 复制到工作目录，并重命名为 `initial_onsite.dm`。
    ```bash
    cp OUT.NiO/onsite.dm ./initial_onsite.dm
    ```
2.  **修改 INPUT**：
    ```bash
    dft_plus_u 1
    omc        2  # 关键：设置为2，表示读取并锁定占据矩阵
    ```
3.  **重新运行**：再次运行 ABACUS。

此时，程序在 SCF 过程中将不再更新占据矩阵，而是始终使用 `initial_onsite.dm` 中的值。这对于计算**非共线磁性**或研究**特定轨道序**（Orbital Ordering）非常有效。

---

### 本章小结

1.  **看日志**：不要只看能量，务必检查 `running_scf.log` 中的 `L(S)DA+U` 区块，确认 U 值加对了位置。
2.  **看磁性**：反铁磁的特征是 `Total Magnetism ≈ 0` 但 `Absolute Magnetism > 0`，且 Mulliken 分析显示原子磁矩反向。
3.  **用 OMC**：利用 `omc=2` 和 `initial_onsite.dm` 可以“冻结”电子态，是处理复杂强关联体系的高级技巧。

下一章，我们将探讨如何基于这些正确的电子态结果，进一步计算能带结构（Band Structure）和态密度（DOS）。

# 第五章：进阶调控：占据矩阵控制 (OMC)

在强关联体系（如过渡金属氧化物、镧系/锕系元素化合物）的计算中，我们经常面临一个棘手的问题：**亚稳态困境**。由于 $d$ 或 $f$ 电子的高度局域性，体系往往存在多个能量极小值（亚稳态）。标准的 DFT+U 自洽迭代有时会陷入错误的轨道占据状态，导致磁矩、能带结构甚至晶格畸变与实验严重不符。

ABACUS 提供了强大的 **占据矩阵控制 (Occupation Matrix Control, OMC)** 功能。它允许我们显式地读取、输出并锁定轨道占据矩阵，从而“引导”或“强制”体系进入我们预期的电子基态。

> **⚠️ 核心前置条件**：
> OMC 功能目前**仅支持 LCAO 基组** (`basis_type lcao`)。如果你使用的是平面波基组 (`basis_type pw`)，请勿开启此功能。

---

## 5.1 OMC 的工作原理与模式

在 DFT+U 理论中，Hubbard $U$ 能量项依赖于局域轨道的占据矩阵 $n_{mm'}^\sigma$。OMC 功能通过控制这个矩阵在自洽迭代（SCF）中的行为来实现对电子态的调控。

### 核心参数详解

在 `INPUT` 文件中，通过以下参数控制 OMC：

1.  **`omc` (整数)**: 控制占据矩阵的读写模式。
    *   **`0` (默认)**: **标准模式**。程序在每一步 SCF 中根据当前的波函数实时计算并更新占据矩阵。这是常规 DFT+U 计算的模式。
    *   **`1` (引导模式)**: **读取并更新**。程序在 SCF 的第一步读取外部提供的 `initial_onsite.dm` 文件作为初始占据矩阵，但在随后的 SCF 步中，程序会根据迭代情况自由更新矩阵。这用于给体系一个正确的“初始推力”。
    *   **`2` (锁定模式)**: **读取并固定**。程序读取 `initial_onsite.dm`，并在整个 SCF 过程中**强制保持**该矩阵不变。这用于复现特定轨道序，或在能带计算（Non-SCF）中保持基态电子分布。

2.  **`out_chg` (整数)**:
    *   设置为 `1` 时，ABACUS 会在计算结束时将最终的占据矩阵输出到 `OUT.suffix/onsite.dm` 文件中。这是进行 OMC 续算的必要步骤。

---

## 5.2 实战：固定占据矩阵流程 (以反铁磁 NiO 为例)

本节将演示一套完整的 OMC 工作流：首先通过标准计算获得正确的反铁磁基态，然后利用 OMC 锁定该状态。

### 案例背景：反铁磁 NiO
NiO 是典型的强关联反铁磁绝缘体。为了正确描述反铁磁序（AFM），我们需要将晶胞中的两个 Ni 原子区分对待：一个自旋向上，一个自旋向下。

### 第一步：准备 STRU 文件 (关键技巧)

**初学者最易犯的错误**是在 `STRU` 中只定义一种 Ni 元素。为了实现反铁磁，必须在 `ATOMIC_SPECIES` 中将 Ni 拆分为 `Ni1` 和 `Ni2`，以便分别设置磁矩和 U 值参数。

**`STRU` 文件片段：**
```text
ATOMIC_SPECIES
Ni1 58.693 Ni_ONCV_PBE-1.0.upf  // 第一种 Ni，用于自旋向上
Ni2 58.693 Ni_ONCV_PBE-1.0.upf  // 第二种 Ni，用于自旋向下
O   15.999 O_ONCV_PBE-1.0.upf

ATOMIC_POSITIONS
Direct
...
Ni1 0.0 0.0 0.0 1.0  // magmom = 1.0 (正磁矩)
Ni2 0.5 0.5 0.5 -1.0 // magmom = -1.0 (负磁矩)
O   0.25 0.25 0.25 0.0
...
```

### 第二步：运行标准 DFT+U 计算 (`omc=0`)

首先进行一次标准的自洽计算，生成基态的占据矩阵。

**`INPUT` 文件设置：**
```text
INPUT_PARAMETERS
# ... 基础参数 ...
basis_type      lcao
calculation     scf

# DFT+U 设置
dft_plus_u      1
# 对应 STRU 中元素的顺序：Ni1(d), Ni2(d), O(no U)
orbital_corr    2 2 -1 
hubbard_u       5.0 5.0 0.0 

# OMC 设置
omc             0       # 标准计算
out_chg         1       # 必须开启！否则不输出 onsite.dm
```

> **⚠️ 数组对应关系警告**：
> `orbital_corr` 和 `hubbard_u` 的数值个数必须严格等于 `STRU` 中 `ATOMIC_SPECIES` 的行数。
> *   本例有 3 种原子 (Ni1, Ni2, O)，所以必须写 3 个数。
> *   `2` 代表对 d 轨道加 U，`-1` 代表不加 U。
> *   顺序必须是：Ni1 -> Ni2 -> O。

**运行并验证结果：**
运行完成后，检查 `OUT.NiO/running_scf.log`：
1.  **检查 U 值读取**：搜索 `L(S)DA+U` 区块，确认程序正确识别了两个 Ni 原子的 d 轨道 (L=2)。
2.  **检查磁性**：搜索 `absolute magnetism`。
    *   `total magnetism` 应接近 0 (反铁磁抵消)。
    *   `absolute magnetism` 应显著大于 0 (例如约 3.3 $\mu_B$/cell)，证明局部磁矩存在且反向排列。

此时，输出目录中应生成了 `onsite.dm` 文件。

### 第三步：使用 OMC 锁定状态 (`omc=2`)

假设我们需要基于上一步的电子态进行后续计算（如能带结构），或者想测试“锁定”功能。

1.  **文件操作**：
    将上一步生成的 `onsite.dm` 复制到工作目录，并**重命名**为 `initial_onsite.dm`。ABACUS 仅识别此文件名的输入。
    ```bash
    cp OUT.NiO/onsite.dm ./initial_onsite.dm
    ```

2.  **修改 `INPUT`**：
    ```text
    # 修改以下参数
    omc             2       # 开启锁定模式
    # out_chg       0       # 此时可以关闭输出，除非你想再次检查
    ```

3.  **再次运行并验证**：
    运行计算。查看 `running_scf.log`，你会发现：
    *   程序提示读取了 `initial_onsite.dm`。
    *   在每一以 `L(S)DA+U` 开头的输出块中，占据矩阵的数据应与第一步计算的最终结果完全一致，且在整个 SCF 过程中保持不变。
    *   最终的总能量 (`FINAL_ETOT`) 和磁矩应与第一步完全吻合。

---

## 附录：常见问题与进阶建议

### 1. 常见报错与排查

*   **Error: `hubbard_u` size is not equal to `ntype`**
    *   **原因**: `INPUT` 中的 `hubbard_u` 或 `orbital_corr` 数组长度与 `STRU` 中的原子类型数量不一致。
    *   **解决**: 即使某些原子不加 U（如氧原子），也必须在数组对应位置填 `0.0` (U值) 和 `-1` (轨道)。

*   **Error: OMC only supports LCAO basis**
    *   **原因**: `INPUT` 中设置了 `basis_type pw` 却开启了 `omc > 0`。
    *   **解决**: 切换为 `basis_type lcao`。

### 2. 收敛困难处理技巧

在强关联体系中，DFT+U 有时比标准 DFT 更难收敛。如果开启 OMC 前无法收敛，可尝试调整混合参数：
*   **`mixing_type`**: 尝试使用 `pulay` (默认) 或 `broyden`。
*   **`mixing_beta`**: 降低该值（如从 0.4 降至 0.1），减缓电荷密度更新幅度。
*   **`mixing_restart`**: 如果电荷密度震荡，可设为 `0.0` 禁用预测。
*   **`mixing_dmr`**: 专门针对 LCAO 的密度矩阵混合参数，对于 d/f 电子体系，适当降低此值有助于稳定占据矩阵。

### 3. 拓展阅读：Yukawa 势方法

除了手动指定 U 值，ABACUS 还支持基于 Yukawa 势的屏蔽方法来估算相互作用。
*   **参数**: `yukawa_potential 1`
*   **原理**: 不直接设置 `hubbard_u`，而是通过 `yukawa_lambda` (屏蔽长度) 来定义相互作用衰减。这为确定 U 值提供了一种非经验的物理途径。详情请参阅官方文档。

---

## 附录：进阶学习指南

完成本教程的学习只是探索强关联体系的第一步。在实际的科研实践中，你可能会遇到更复杂的情况，以下是为你准备的进阶建议与调试指南：

### 1. 深度探索与扩展阅读
- **算法底层原理**：建议深入研读 *Qu X, et al. J. Chem. Phys. 2022;156(23):234104*。理解 LCAO 基组下投影算符的构造，有助于你更精准地设置 `orbital_corr` 参数。
- **非共线磁性计算**：当体系存在非共线磁矩（nspin=4）且难以收敛时，可以尝试开启新方法（设置 `mixing_angle 1.0`），这在寻找非共线基态时具有更强的鲁棒性。
- **几何优化中的磁性**：在进行离子弛豫（Relaxation）计算时，ABACUS 会利用上一步的磁矩作为初试输入，这对于保持磁序的一致性至关重要。

### 2. 常见问题排查（Troubleshooting）
- **收敛性难题**：
    - 如果 DFT+U 计算难以收敛，推荐在 `INPUT` 中设置 `mixing_restart 10` 和 `mixing_dmr 1`。这能让 SCF 在接近基态时通过混合密度矩阵加速收敛。
    - **注意**：如果设置后反而跑飞，请观察 `drho` 曲线，寻找一个电荷密度更接近基态的步数（如 `drho < 10^-3`）作为 `mixing_restart` 的起点。
- **U 值未生效或映射错误**：
    - 务必检查 `INPUT` 中 `hubbard_u` 数组的长度是否与 `STRU` 中定义的原子种类（Species）数量完全一致。即便是同种元素，如果为了设置反铁磁而拆分为 `Ni1` 和 `Ni2`，在 `INPUT` 中也必须对应给出两个 U 值。
- **陷入亚稳态**：
    - 若计算得到的磁矩或占据矩阵与实验明显不符，请回顾第五章的 OMC 功能，通过手动初始化占据矩阵来引导体系进入正确的物理态。

### 3. 获取更多支持
- **官方文档**：请经常查阅 [ABACUS 在线用户指南](https://abacus.deepmodeling.com/)，获取最新的参数说明与功能更新。
- **社区交流**：积极参与 Bohr 平台或 ABACUS 开源社区的讨论，实践经验的分享往往能解决最棘手的技术细节。

科学探索永无止境，愿本教程能成为你攻克强关联材料研究难关的利器！
