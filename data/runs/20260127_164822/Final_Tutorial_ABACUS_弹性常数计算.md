# 第一性原理力学性质计算：ABACUS 弹性常数实战教程

## 前言

### 欢迎开启力学计算之旅
在现代材料科学研究中，理解材料的力学响应是评估其结构稳定性和工程应用潜力的核心。ABACUS（原子算筹）作为一款国产优秀的密度泛函理论（DFT）计算软件，凭借其在数值原子轨道（LCAO）基组上的高效表现，为大规模体系的力学性质模拟提供了强大支撑。本教程旨在通过手把手的实战教学，帮助读者掌握利用 ABACUS 及其生态工具精准计算材料弹性常数的核心技能。

### 学习路线图 (Roadmap)
本教程遵循“理论先行-基准构建-标准实战-进阶拓展”的逻辑链条：
- **第一章**：回顾弹性力学基础，重点阐述广义胡克定律与应力-应变响应的物理本质，解决“算什么”的认知问题。
- **第二章**：聚焦计算准备，强调“零应力”基准的重要性，并解析原胞与惯用胞在力学计算中的选择策略。
- **第三章**：以单质硅（Si）为例，演示结合 `abacustest` 自动化工具的标准工作流，实现从任务生成到数据后处理的闭环。
- **第四章**：深入探讨金红石型二氧化钛（TiO₂），解析非立方晶系的各向异性处理及原子弛豫对弹性性质的关键贡献。

### 知识体系定位 (Knowledge Graph)
弹性常数计算处于 ABACUS/DFT 知识体系中“物性预测”的高阶板块。它向上承接基础的自洽场（SCF）计算与结构优化（Relax），向下则是分析声子谱稳定性、热力学性质以及设计新型结构材料的基石。本教程不仅关注 ABACUS 本身，还引入了 `pymatgen` 与 `abacustest` 等开源生态工具，展示了现代计算材料学“工具链协同”的典型范式。

### 前置需求 (Prerequisites)
在开始本教程之前，建议读者具备以下基础：
1. 掌握基本的密度泛函理论（DFT）概念（如交换相关泛函、K点采样、截断能等）。
2. 能够熟练在 Linux 环境下运行 ABACUS 基本计算任务。
3. 具备基础的 Python 脚本阅读与执行能力。
4. 了解基本的晶体学常识（点群、空间群、布拉维点阵）。

---

# 第一章：弹性力学基础与计算原理

在正式启动 ABACUS 进行计算之前，我们需要先建立清晰的物理图像。很多初学者容易陷入“只知道运行脚本，不知道算出了什么”的误区。本章不涉及具体的代码操作，旨在明确“算什么”和“怎么算”，特别是解释清楚为什么通过施加微小的晶格形变并计算应力响应，就能推导出材料的弹性常数。

## 1.1 广义胡克定律与弹性张量

### 1.1.1 从弹簧到晶体
我们在中学物理中学过胡克定律 $F = -k \Delta x$，描述了弹簧受力与伸长量的线性关系。在三维晶体材料中，这一关系被推广为**广义胡克定律**。

*   **应变（Strain, $\varepsilon$）**：描述晶体形状的微小变化（相当于 $\Delta x$）。
*   **应力（Stress, $\sigma$）**：描述晶体内部为了抵抗形变而产生的单位面积内力（相当于 $F$）。

在弹性极限内（即形变足够小，撤去外力后材料能恢复原状），应力与应变呈线性关系：

$$ \sigma_{ij} = \sum_{kl} C_{ijkl} \varepsilon_{kl} $$

这里的 $C_{ijkl}$ 就是我们要计算的主角——**弹性刚度张量（Elastic Stiffness Tensor）**。

### 1.1.2 Voigt 记号：将 81 个分量简化为 $6 \times 6$ 矩阵
从数学上看，$C_{ijkl}$ 是一个四阶张量，拥有 $3 \times 3 \times 3 \times 3 = 81$ 个分量。直接计算这 81 个数既困难又无必要。利用应力和应变的对称性（$\sigma_{ij}=\sigma_{ji}$，$\varepsilon_{ij}=\varepsilon_{ji}$），我们可以使用 **Voigt 记号** 将下标简化：

*   $xx \rightarrow 1$
*   $yy \rightarrow 2$
*   $zz \rightarrow 3$
*   $yz \rightarrow 4$
*   $xz \rightarrow 5$
*   $xy \rightarrow 6$

通过这种映射，四阶张量被“降维”为一个 $6 \times 6$ 的对称矩阵 $C_{ij}$：

$$
\begin{pmatrix}
\sigma_1 \\ \sigma_2 \\ \sigma_3 \\ \sigma_4 \\ \sigma_5 \\ \sigma_6
\end{pmatrix}
=
\begin{pmatrix}
C_{11} & C_{12} & C_{13} & C_{14} & C_{15} & C_{16} \\
C_{12} & C_{22} & C_{23} & C_{24} & C_{25} & C_{26} \\
\vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
C_{16} & C_{26} & C_{36} & C_{46} & C_{56} & C_{66}
\end{pmatrix}
\begin{pmatrix}
\varepsilon_1 \\ \varepsilon_2 \\ \varepsilon_3 \\ \varepsilon_4 \\ \varepsilon_5 \\ \varepsilon_6
\end{pmatrix}
$$

> **教授提示**：对于立方晶系（如硅 Si、铜 Cu），由于高度的晶体对称性，这个矩阵中只有三个独立的非零分量：$C_{11}$（抗轴向拉伸）、$C_{12}$（泊松效应）、$C_{44}$（抗剪切）。这大大减少了我们需要计算的工作量。

---

## 1.2 第一性原理计算中的应力-应变法

在实验中，我们通常施加力测量形变。而在基于密度泛函理论（DFT）的 ABACUS 计算中，我们采用逆向思维的**应力-应变法（Stress-Strain Method）**。

### 1.2.1 核心计算逻辑
1.  **施加应变**：人为地将晶胞产生微小的变形（例如将晶格矢量 $a$ 拉长 1%）。
2.  **计算应力**：固定变形后的晶胞形状，让电子和离子弛豫到能量最低态，利用 DFT 计算出此时晶胞内部的柯西应力（Cauchy Stress）。
3.  **线性拟合**：对不同大小的应变（如 $\pm 0.5\%, \pm 1.0\%$）重复上述步骤，通过应力-应变曲线的斜率求出 $C_{ij}$。

### 1.2.2 关键参数：`cal_stress`
为了实现上述逻辑，必须要求 ABACUS 在输出文件中打印出应力张量。在 `INPUT` 文件中，这是由以下参数控制的：

```bash
cal_stress   1    # 开启应力计算，这对弹性常数计算至关重要
cal_force    1    # 开启受力计算，用于原子弛豫
```

### 1.2.3 核心难点一：惯用胞 vs 原胞 (Conventional vs. Primitive Cell)
这是新手最容易“翻车”的地方。

*   **问题背景**：以硅（Si）为例，其**原胞（Primitive Cell）**只包含 2 个原子，晶格矢量是非正交的（面心立方基矢）；而**惯用胞（Conventional Cell）**包含 8 个原子，晶格矢量是正交的立方体。
*   **计算选择**：**强烈建议使用惯用胞进行弹性常数计算**。
*   **原因解析**：
    *   弹性常数 $C_{11}, C_{12}, \dots$ 的物理定义通常是基于笛卡尔坐标系（x, y, z）的。
    *   如果你使用 2 原子的原胞，施加的应变是沿着原胞基矢方向的，计算出的 $C$ 矩阵也是基于原胞基矢定义的。得到的矩阵是非对角的，且数值无法直接与实验值（如 $C_{11}=165$ GPa）对应。
    *   虽然可以通过张量旋转变换将原胞结果转为笛卡尔坐标系结果，但这增加了极大的复杂度和出错概率。
    *   **结论**：为了物理直观和后续处理方便，请牺牲一点计算时间，使用 8 原子的立方惯用胞，并确保晶格矢量与坐标轴平行。

### 1.2.4 核心难点二：原子弛豫的重要性 (Relaxed-ion vs. Clamped-ion)
当我们把晶胞拉长（施加应变）后，原子该怎么办？

1.  **Clamped-ion（钳制离子）**：晶胞变了，但原子在晶胞内的相对分数坐标保持不变。这相当于把原子“冻”住了。
2.  **Relaxed-ion（松弛离子）**：晶胞变了，允许原子在新的晶胞形状下移动，寻找新的受力平衡位置。

**物理事实**：在真实的宏观弹性测量中，原子的响应速度远快于宏观形变，它们总是在平衡位置附近。因此，我们需要计算的是**松弛离子弹性常数**。

**ABACUS 操作指南**：
在对变形后的结构进行计算时，`INPUT` 文件中的 `calculation` 类型必须设置为 `relax`（固定晶胞，优化原子位置），而不是 `scf`（静态计算）或 `cell-relax`（变胞优化）。

*   **错误做法**：使用 `scf`。这会得到 Clamped-ion 模量，通常会高估材料的硬度。
*   **错误做法**：使用 `cell-relax`。这会让晶胞变回无应变的状态，导致前功尽弃。
*   **正确做法**：使用 `relax`。固定我们施加的应变形状，让原子去适应这个形状。

### 1.2.5 标准工作流 (Workflow)
基于上述原理，一个完整的计算流程应包含三个阶段：

1.  **Pre-process（预处理）**：
    *   对初始结构进行彻底的 `cell-relax`。必须保证初始结构处于无应力（Zero Stress）状态，否则后续计算的应力会包含初始残余应力，导致拟合误差。
2.  **Process（计算执行）**：
    *   使用脚本（如 `abacustest`）生成一系列变形结构（$\pm \delta$）。
    *   生成对应的 `INPUT` 文件，确保开启 `cal_stress 1` 和 `calculation relax`。
    *   批量提交任务。
3.  **Post-process（后处理）**：
    *   从输出文件中提取应力数据。
    *   进行线性拟合，输出 $C_{ij}$ 矩阵及体模量（Bulk Modulus）、剪切模量（Shear Modulus）等衍生量。

> **锦囊妙计 (Risk Warning)**：
> 在使用 `abacustest elastic` 命令准备输入文件时，请务必注意：**该命令会删除目标目录下已存在的 `deform` 文件夹**。
> 如果你已经算了一半，想补充几个点或重新生成某个文件，**切勿**直接在原目录重复运行该命令，否则你辛苦计算的数据将被瞬间清空。请务必备份或在在不同路径下操作。

# 第二章：计算准备——构建“零应力”基准

在第一性原理计算中，弹性常数（Elastic Constants）对应力极其敏感。它们本质上是能量对晶格应变的二阶导数，或者说是应力对应变的一阶导数。如果你的初始结构中存在残余应力（Residual Stress），那么你施加的微小应变所诱导的物理响应就会被这些“噪音”淹没，导致计算结果出现严重偏差，甚至出现非物理的负模量。

本章我们将构建计算的基石：获得一个应力张量几乎为零的完美初始结构。

## 2.1 晶胞的选择：惯用胞 vs 原胞

在开始计算之前，我们面临的第一个抉择是：使用**原胞（Primitive Cell）**还是**惯用胞（Conventional Cell）**？

对于计算能带结构或声子谱，为了节省计算资源，我们通常首选原子数最少的原胞。然而，**在计算弹性常数时，我强烈推荐使用惯用胞**，特别是对于立方晶系（如 Si, Cu, Al 等）。

### 为什么不推荐使用原胞？

以硅（Si）为例，其面心立方（FCC）原胞包含 2 个原子，晶格矢量 $\vec{a}_1, \vec{a}_2, \vec{a}_3$ 之间夹角为 60°。
如果我们使用原胞进行计算，施加的应变通常是沿着晶格矢量方向的。由于晶格矢量与笛卡尔坐标系（x, y, z）不重合，施加在某一晶格矢量上的“简单拉伸”，在笛卡尔坐标系下会变成复杂的混合应变（既有正应变也有剪切应变）。

这将导致计算得到的弹性刚度矩阵 $C$ 是非对角的，且难以直接阅读。你必须进行复杂的张量坐标变换，才能将其还原为物理直观的 $C_{11}, C_{12}, C_{44}$。

### 惯用胞的优势

对于 Si，我们选择包含 8 个原子的立方惯用胞。
*   **坐标对齐**：其晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 分别与笛卡尔坐标轴 $x, y, z$ 平行。
*   **物理直观**：
    *   沿 x 轴拉伸直接对应 $\epsilon_{11}$，得到的应力响应直接对应 $C_{11}$。
    *   这种“所见即所得”的对应关系，极大地简化了后续的数据处理和物理分析。

> **专家建议**：虽然 8 原子晶胞的计算量是 2 原子晶胞的 4 倍（对于 $O(N^3)$ 算法甚至是 64 倍），但在弹性常数计算中，这种为了物理清晰性而付出的成本是绝对值得的。

## 2.2 消除残余应力：高精度结构优化

获得惯用胞结构文件（如 CIF 文件）后，不能直接用于施加应变。实验测量的晶格常数是在有限温度下测得的，而 DFT 计算通常对应 0K 环境。直接使用实验晶格常数会导致巨大的内应力。

我们需要使用 ABACUS 进行**变胞弛豫（Variable Cell Relaxation）**。

### 2.2.1 核心参数设置 (`INPUT`)

我们需要执行 `cell-relax` 计算。这里的收敛标准必须比常规的能带计算或简单的几何优化更严格。

以下是 `INPUT` 文件的关键参数配置示例：

```bash
INPUT_PARAMETERS
# 1. General Parameters
suffix          Si_cell_relax
calculation     cell-relax    # 关键：同时优化原子位置和晶胞形状/体积
basis_type      lcao          # 或 pw，取决于你的精度/速度需求

# 2. Relaxation Parameters
cal_force       1             # 必须开启力计算
cal_stress      1             # 必须开启应力计算，用于调整晶胞
relax_nmax      100           # 最大离子步数
relax_method    cg            # 或 bfgs，推荐 cg 用于变胞优化

# 3. Convergence Criteria (High Precision)
# 电子步收敛标准：建议 1e-8 或 1e-9，确保力/应力的数值噪音极低
scf_thr         1.0e-9       

# 离子步收敛标准：
# 力的收敛标准，建议 1e-4 eV/Ang (常规计算通常是 0.04 或 0.01)
force_thr_ev    1.0e-4        

# 应力收敛标准：单位 kBar。
# 1 kBar = 0.1 GPa。建议设为 0，或极小值，迫使优化直到几何受限
stress_thr      1.0e-2        

# 4. Smearing (Optional but recommended for metals)
# 对于 Si (半导体) 可不加，但在高精度力计算中，微量的 smearing 有助于收敛
smearing_method gaussian
smearing_sigma  0.001
```

### 2.2.2 结构文件 (`STRU`)

确保你的 `STRU` 文件描述的是惯用胞。例如 Si 的 8 原子结构：

```text
ATOMIC_POSITIONS
Direct
Si
1.0
8
0.0000000000 0.0000000000 0.0000000000 1 1 1
0.5000000000 0.5000000000 0.0000000000 1 1 1
0.0000000000 0.5000000000 0.5000000000 1 1 1
0.5000000000 0.0000000000 0.5000000000 1 1 1
0.2500000000 0.2500000000 0.2500000000 1 1 1
0.7500000000 0.7500000000 0.2500000000 1 1 1
0.7500000000 0.2500000000 0.7500000000 1 1 1
0.2500000000 0.7500000000 0.7500000000 1 1 1
```
*注意：最后的 `1 1 1` 表示允许原子在 x, y, z 方向移动，这对于 `cell-relax` 是必须的。*

### 2.2.3 使用 `abacustest` 自动化准备

我们可以使用 `abacustest` 快速生成优化任务。假设你已经有了 `Si_conventional.cif`：

```bash
# 生成 cell-relax 任务
# -jtype cell-relax 指定任务类型为变胞优化
abacustest submit -f Si_conventional.cif -p input_param.json -jtype cell-relax --folder-syntax "Si_relax"
```
*(注：`input_param.json` 可包含上述的高精度参数，或者生成后手动修改 `INPUT` 文件)*

### 2.2.4 检查“零应力”状态

计算完成后，检查输出文件（通常在 `OUT.suffix/running_cell-relax.log` 或类似日志中）。
你需要确认最后一步的应力张量（Stress Tensor）对角项是否接近于 0。通常，残余应力应小于 0.1 kBar。

## 2.3 核心概念辨析：Relaxed-ion vs. Clamped-ion

在进入下一章施加应变之前，必须澄清一个物理概念，这决定了我们后续的计算流程。

当我们对优化好的晶胞施加一个应变（例如拉伸 1%）时，晶格形状改变了。此时原子内部的位置有两种处理方式：

1.  **Clamped-ion (钳制离子)**: 原子的分数坐标保持不变。原子像是被“钉”在晶格上随晶格一起均匀变形。这对应于高频极限下的弹性响应（原子来不及弛豫）。
2.  **Relaxed-ion (松弛离子)**: 晶格变形后，固定晶胞形状，允许原子在晶胞内部移动（Internal Relaxation）以达到新的受力平衡。这对应于静态或低频下的宏观物理测量。

**实战指南**：
绝大多数实验测量的弹性模量都是 **Relaxed-ion** 模量。
因此，我们的计算流程必须是：
1.  **Pre-process (本章)**: `cell-relax` 获得无应力基准结构。
2.  **Process (下一章)**: 施加应变 -> **固定晶胞，优化原子位置 (`calculation: relax`)** -> 计算最终应力。

> **警告 (Risk of Data Loss)**
>
> 在后续使用 `abacustest elastic` 命令生成应变任务时，请务必注意：**不要在已经存在结果的目录下重复运行该命令**。
> `abacustest` 的初始化脚本通常会清理旧的 `deform` 文件夹。如果你辛辛苦苦算了一半，误运行了准备脚本，你的数据将会瞬间丢失。请养成良好的目录管理习惯，将 `run` 目录与 `analysis` 目录分层管理。

# 第三章：标准工作流实战——以硅（Si）为例

在上一章中，我们详细解析了 ABACUS 的输入参数。本章我们将进入实战环节，以计算材料学中最经典的案例——硅（Silicon）的弹性性质计算为例，演示如何利用 ABACUS 配合自动化工具 `abacustest` 完成从结构优化、批量任务生成到结果后处理的完整工作流。

本章不仅会教你“怎么做”，更会重点解释“为什么这样做”，特别是关于晶胞选择和原子弛豫的物理意义。

---

## 3.0 前置知识：为什么选择 8 原子的惯用胞？

在开始计算之前，我们需要准备硅的初始结构。硅是典型的金刚石结构（Diamond structure），属于面心立方（FCC）晶系。

**核心问题**：在计算能带时，我们通常使用包含 2 个原子的**原胞（Primitive Cell）**以节省计算资源；但在计算弹性模量时，我强烈建议你使用包含 8 个原子的**惯用胞（Conventional Cell）**。

**原因如下**：
弹性张量 $C_{ij}$ 是定义在笛卡尔坐标系（$x, y, z$）下的。
*   **原胞**：基矢量是非正交的，与笛卡尔坐标轴不重合。如果使用原胞施加应变，得到的弹性矩阵将是非对角化的，物理图像不直观，且需要复杂的张量变换才能得到标准的 $C_{11}, C_{12}, C_{44}$。
*   **惯用胞**：其晶格矢量（Lattice Vectors）天然沿着 $x, y, z$ 轴方向（即 $\mathbf{a}=a\hat{x}, \mathbf{b}=a\hat{y}, \mathbf{c}=a\hat{z}$）。在这种坐标系下施加应变，我们可以直接利用立方晶系的对称性，通过胡克定律直接拟合出物理意义明确的弹性常数。

因此，本教程中我们使用 **8 原子的立方惯用胞**作为起点。

---

## 3.1 第一阶段：结构预优化 (Pre-process)

在施加应变之前，必须确保初始结构处于“零应力”的基态。任何残余应力都会导致后续的弹性常数拟合出现误差。

我们将使用 `abacustest` 工具来生成输入文件。假设你已经准备好了 `Si.cif`（惯用胞结构）。

### 3.1.1 生成优化任务
在终端执行以下命令：

```bash
# 使用 cell-relax 模式，生成名为 Si_relax 的任务文件夹
abacustest lib -f Si.cif --jtype cell-relax --lcao --folder-syntax Si_relax
```

### 3.1.2 关键参数解析
生成的 `INPUT` 文件中，针对结构优化，以下参数至关重要：

*   **`calculation`**: `cell-relax`
    *   我们需要同时优化晶胞形状（Cell）和原子位置（Ions），以消除所有内应力。
*   **`cal_stress`**: `1`
    *   必须开启应力计算，否则无法判断晶胞是否达到平衡。
*   **`cal_force`**: `1`
    *   必须开启力计算，用于原子位置弛豫。

提交计算并等待完成后，我们将得到最终的结构文件（通常位于 `OUT.ABACUS/STRU_ION_D` 或类似目录），将其重命名为 `STRU_optimized` 备用。

---

## 3.2 第二阶段：使用 abacustest 准备应变任务 (Process)

弹性常数的计算原理是**应力-应变法（Stress-Strain Method）**：给晶体施加微小的形变（应变 $\varepsilon$），计算产生的应力（$\sigma$），然后通过 $\sigma = C \varepsilon$ 拟合得到 $C$。

手动手动创建几十个变形结构极其繁琐且易错，这里我们使用 `abacustest` 的 `elastic` 模块。

### 3.2.1 自动生成变形任务
基于上一步优化好的结构 `STRU_optimized`，执行以下命令：

```bash
# 自动生成弹性常数计算任务
# --norm: 最大正应变 (normal strain) 幅度
# --shear: 最大剪切应变 (shear strain) 幅度
abacustest elastic -f STRU_optimized --norm 0.01 --shear 0.01
```

**⚠️ 警告 (Risk of Data Loss)**：
请务必在一个干净的目录下或确认无重要数据时运行此命令。如果当前目录下已经存在名为 `deform-xxx` 的文件夹，`abacustest` 会**直接删除并覆盖**它们，不会进行二次确认。

### 3.2.2 生成的目录结构
命令执行后，你会看到类似以下的目录结构：
*   `run_elastic/` (或当前目录)
    *   `org/`: 原始结构的计算任务（作为基准）。
    *   `deform-001/`: 施加了第一种正应变的结构（如 +0.5%）。
    *   `deform-002/`: 施加了第一种正应变的结构（如 -0.5%）。
    *   ...
    *   `deform-012/`: 施加了剪切应变的结构。

### 3.2.3 核心物理策略：Relax vs SCF (Clamped vs Relaxed Ions)

在生成的每个 `deform` 文件夹的 `INPUT` 文件中，你会发现 `calculation` 参数默认被设为了 `relax`（或者你需要手动确认这一点）。这里涉及一个深刻的物理问题：

**当晶胞发生形变后，原子应该动吗？**

1.  **Clamped-ion (钳制离子) 模型**:
    *   **操作**: `calculation = scf`。
    *   **含义**: 晶胞变形，原子保持其分数坐标不变。
    *   **物理对应**: 对应于极高频的响应（如声子频率远高于原子弛豫频率），原子来不及移动。这通常**不符合**我们宏观测量的弹性模量。

2.  **Relaxed-ion (松弛离子) 模型 (推荐)**:
    *   **操作**: `calculation = relax` (注意是固定晶胞，仅优化原子位置)。
    *   **含义**: 晶胞被强制固定在变形后的形状，但允许原子在晶胞内部移动以消除内部微观力（Internal relaxation）。
    *   **物理对应**: 宏观物理测量中，原子总是有时间弛豫到新的平衡位置。
    *   **ABACUS 设置**:
        *   `calculation`: `relax`
        *   `cal_stress`: `1` (必须计算应力用于拟合)
        *   `cal_force`: `1` (用于原子弛豫)

**专家建议**: 除非你有特殊的研究目的（如研究高频声学支），否则**请务必使用 `relax` 模式**。`abacustest` 默认行为通常是生成 `relax` 任务，如果你想强制计算 Clamped-ion 性质，可以使用 `--norelax` 参数。

---

## 3.3 第三阶段：结果后处理与数据拟合 (Post-process)

当所有 `deform-xxx` 文件夹中的 ABACUS 任务都计算完成后（即目录下生成了 `OUT.ABACUS`），我们就可以进行最后的数据收集和拟合。

### 3.3.1 一键后处理
在包含所有 `deform` 文件夹的根目录下，运行：

```bash
abacustest elastic --post
```

### 3.3.2 结果解读
程序会自动读取每个子任务的应力张量，进行线性拟合，并输出如下关键信息：

1.  **弹性刚度张量 (Elastic Stiffness Tensor, $C_{ij}$)**:
    对于硅（立方晶系），你应该关注三个独立分量：
    *   $C_{11}$: 代表沿轴向拉伸的刚度。
    *   $C_{12}$: 代表泊松效应导致的横向耦合。
    *   $C_{44}$: 代表剪切变形的刚度。

    *参考数值（基于 PBE 泛函）*:
    *   $C_{11} \approx 155 \text{ GPa}$
    *   $C_{12} \approx 58 \text{ GPa}$
    *   $C_{44} \approx 76 \text{ GPa}$

2.  **宏观模量 (Voigt-Reuss-Hill bounds)**:
    *   **体模量 (Bulk Modulus, $B$)**: 衡量材料抗压缩的能力。
    *   **剪切模量 (Shear Modulus, $G$)**: 衡量材料抗剪切变形的能力。
    *   **杨氏模量 (Young's Modulus, $E$)**: 描述固体材料抵抗形变能力的物理量。
    *   **泊松比 (Poisson's Ratio, $\nu$)**: 材料横向变形与纵向变形之比。

### 3.3.3 常见问题排查
*   **拟合出的 $C_{ij}$ 矩阵不对称？**
    *   检查 `scf_thr` 是否足够严格（建议 `1e-8`）。
    *   检查 `kspacing` 或 K 点密度是否足够高。
*   **$C_{11}$ 和 $C_{12}$ 偏差很大？**
    *   确认是否使用了惯用胞。如果使用了原胞但按照立方晶系公式拟合，结果会完全错误。

---

## 本章总结

通过本章，我们掌握了 ABACUS 计算弹性性质的标准工作流：
1.  **准备**: 使用 **8 原子惯用胞**，并进行严格的 **Cell-Relax** 预优化。
2.  **计算**: 使用 `abacustest elastic` 生成变形任务，采用 **Relaxed-ion (`calculation=relax`)** 策略以获取符合宏观物理图像的结果。
3.  **分析**: 批量提交后，使用 `--post` 自动拟合得到 $C_{ij}$ 及宏观模量。

这个流程不仅适用于硅，也适用于绝大多数 3D 晶体材料。下一章，我们将探讨更复杂的电子性质计算——能带结构与态密度。

# 第四章：进阶案例与各向异性——金红石型 TiO2

在上一章中，我们通过硅（Si）熟悉了弹性常数计算的基本流程。硅是典型的立方晶系，各向同性较高，仅有 3 个独立的弹性常数。然而，实际研究中我们常会遇到更复杂的晶体结构。

本章我们将以**金红石型二氧化钛（Rutile TiO₂）**为例，深入探讨非立方晶系（四方晶系）的各向异性处理方法。我们将重点解决两个核心问题：**晶胞选取的物理意义**以及**原子弛豫对弹性性质的关键影响**。

---

## 4.1 处理各向异性与晶体取向

在计算弹性张量之前，最关键的一步并非设置参数，而是**构建正确的几何结构**。对于非立方晶系，晶体的取向直接决定了弹性矩阵 $C_{ij}$ 的形式。

### 4.1.1 核心概念：为何要用“惯用胞”而非“原胞”？

这是初学者最容易踩的坑。在电子结构计算（如能带）中，为了节省算力，我们通常使用原子数最少的**原胞（Primitive Cell）**。但在弹性常数计算中，我们强烈建议使用**惯用胞（Conventional Cell）**。

*   **物理直观性**：弹性常数 $C_{11}$ 定义为沿 x 轴的法向应力与法向应变之比。如果使用原胞，其晶格矢量可能并不沿 Cartesian 坐标系的 x, y, z 轴方向（例如面心立方或体心立方的原胞轴之间夹角并非 90 度）。
*   **张量形式**：如果晶格矢量与坐标轴不重合，计算出的弹性张量矩阵将充满非零的非对角项。虽然这在数学上是正确的，但你必须进行复杂的张量旋转变换才能得到物理上直观的 $C_{11}, C_{12}$ 等数值。
*   **最佳实践**：始终构建晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 分别平行于 $x, y, z$ 轴的惯用胞。对于金红石 TiO₂（四方晶系），这意味着 $a=b \neq c$，且 $\alpha=\beta=\gamma=90^\circ$。

### 4.1.2 预处理：结构优化 (Cell Relax)

任何弹性常数计算的前提都是：**系统处于无应力（Stress-free）的平衡态**。如果初始结构存在残余应力，胡克定律的线性关系将不再严格成立，导致计算误差。

**第一步：准备结构**
从 Materials Project 下载 mp-2657 (Rutile TiO₂) 的结构文件（CIF 格式），并转换为 ABACUS 的 `STRU` 文件。

**第二步：执行高精度结构优化**
我们需要同时优化晶胞形状（Cell）和原子位置（Ions）。

使用 `abacustest` 生成优化任务：
```bash
# 假设结构文件名为 TiO2_init.cif
abacustest prepare -f TiO2_init.cif -p INPUT -k KPT --jtype cell-relax --folder-syntax "TiO2_relax"
```

**关键 INPUT 参数解析**：
在生成的 `TiO2_relax/INPUT` 文件中，务必检查以下参数以确保高精度收敛：

```plaintext
INPUT_PARAMETERS
# 任务类型：同时优化晶胞和原子
calculation     cell-relax

# 关联参数：必须足够严格，否则残余应力会影响后续弹性模量
force_thr       1.0e-4      # 力收敛标准 (Ry/Bohr)
stress_thr      1.0e-2      # 应力收敛标准 (KBar)，这一点至关重要！
ecutwfc         100         # 平面波截断能 (Ry)，建议比常规计算设得更高以减少 Pulay 应力

# 电子步收敛
scf_thr         1.0e-8      # 自洽迭代收敛精度
```

提交计算并等待完成。完成后，我们将使用优化后的结构（`OUT.TiO2_relax/STRU_ION_D`）作为后续计算的起点。

---

## 4.2 独立弹性常数分析与实验对比

金红石型 TiO₂ 属于四方晶系（Laue class 4/mmm），根据对称性分析，它具有 **6 个独立弹性常数**：
$$ C_{11}, C_{12}, C_{13}, C_{33}, C_{44}, C_{66} $$

### 4.2.1 核心概念：钳制离子 vs. 松弛离子

在施加应变计算应力时，ABACUS 的工作流中包含了一个极易被忽视但物理意义重大的步骤：**原子内部弛豫**。

*   **钳制离子 (Clamped-ion)**: 施加应变后，晶格变形，但强制原子保持在分数坐标不变。这对应于高频极限（如声波传播速度极快，原子来不及调整位置）。
*   **松弛离子 (Relaxed-ion)**: 施加应变后，固定晶格形状，但**允许原子在晶胞内部移动**以达到新的受力平衡。这对应于静态或低频极限（宏观力学实验测量的数值）。

> **权威指南**: 在绝大多数材料力学性能对比中，我们需要的是**松弛离子**弹性常数。因此，在每一个变形后的子任务中，必须进行 `calculation relax`（固定晶胞优化原子）。

### 4.2.2 实战操作：工作流执行

我们将使用 `abacustest` 自动化完成“施加应变 -> 生成文件 -> 提交计算”的全流程。

**1. 准备输入文件**
创建一个新的目录 `TiO2_elastic`，将上一步优化好的 `STRU` 文件放入，并准备一个标准的 SCF 计算 `INPUT` 模板。

**2. 生成变形任务**
运行以下命令，`abacustest` 会自动根据晶体对称性生成所需的正应变和剪切应变组合。

```bash
# 注意：使用优化后的结构 STRU_optimized
abacustest prepare -f STRU_optimized -p INPUT -k KPT --jtype elastic --folder-syntax "run_elastic"
```

> **⚠️ 风险提示 (Risk of Data Loss)**
> 请勿在已有结果的目录下重复运行上述 `prepare` 命令！该命令会清空并重建所有 `deform-xxx` 文件夹，导致之前的计算数据丢失。

**3. 检查生成的子任务**
进入生成的文件夹，你会发现多个 `deform-xxx` 子目录。检查其中任意一个的 `INPUT` 文件，确认任务类型：
*   `calculation relax`: 确保进行了原子弛豫（这是计算 Relaxed-ion 模量的关键）。
*   `latname`: 这里的晶格矢量是变形后的。

**4. 批量提交与后处理**
提交所有子任务。计算全部完成后，在根目录运行分析命令：

```bash
abacustest analyze -t elastic
```

### 4.2.3 结果分析与验证

程序将输出拟合后的弹性张量矩阵。对于 TiO₂，你应该重点关注矩阵的对称性。

**典型输出示例 (单位 GPa)**：
```text
Elastic Tensor (GPa):
      C11     C12     C13     C14     C15     C16
C11  268.5   175.2   148.0     0.0     0.0     0.0
C21  175.2   268.5   148.0     0.0     0.0     0.0
C31  148.0   148.0   482.0     0.0     0.0     0.0
...
C66    0.0     0.0     0.0     0.0     0.0   190.5
```

**验证清单**：
1.  **对称性检查**：$C_{11}$ 应近似等于 $C_{22}$（四方晶系特征）。如果差异较大，说明 K 点取样不足或应变方向的收敛性不一致。
2.  **数值对比**：
    *   $C_{33}$ 通常远大于 $C_{11}$，反映了金红石结构沿 c 轴（Ti-O 链方向）的刚性更强。
    *   将结果与 Materials Project (mp-2657) 对比。注意：DFT 计算值通常比实验值略高（因为常用 PBE 泛函倾向于高估晶格常数，但弹性模量可能因体积效应而变化，LDA 则通常高估模量）。

---

## 附录：常见问题与最佳实践

在实战中，弹性常数计算是“报错率”较高的任务。以下是资深开发者总结的避坑指南：

### 1. 负模量与数值噪音
如果你计算出的 $C_{ij}$ 矩阵出现负的主对角元（导致声子谱出现虚频，意味着结构不稳定），或者本应为 0 的项（如 $C_{14}$）数值很大（>5 GPa）：
*   **原因 A**：初始结构未完全弛豫。**解决**：重新运行 `cell-relax`，将 `stress_thr` 降至 `1.0e-2` 甚至更低。
*   **原因 B**：应变幅度（Strain Amplitude）不当。
    *   默认应变通常为 $\pm 0.01$ (1%)。
    *   如果体系很软，1% 可能超出线弹性区，尝试减小到 0.005。
    *   如果体系很硬或数值噪音大，1% 可能被误差淹没，尝试增大到 0.02。

### 2. Pulay 应力 (Pulay Stress)
在使用平面波基组（Plane Wave）或 LCAO 基组时，体积变化会导致基组完备性变化，从而产生虚假的“Pulay 应力”。
*   **对策**：在弹性计算中，`ecutwfc`（平面波截断能）应比常规能量计算设置得更高（例如增加 30%）。这能有效压制 Pulay 应力，提高应力张量的计算精度。

### 3. 磁性体系的陷阱
如果计算磁性材料（如 Fe, MnO）：
*   务必在 `INPUT` 中开启 `nspin 2`。
*   **注意**：施加应变可能会导致磁矩翻转或磁序改变。建议在变形后的计算中读取未变形结构的波函数或电荷密度作为初猜，或者手动固定磁矩方向，确保计算的是同一磁态下的弹性响应。

---

## 附录：进阶学习指南

### 进阶探索 (Extended Reading)
完成本教程后，你已经掌握了线性弹性范围内的基本计算。若想在材料力学性质领域进一步深造，建议关注以下方向：
- **Born 稳定性判据**：学习如何利用计算得到的弹性常数矩阵，通过 Born 稳定性准则判断新设计的材料在力学上是否能够稳定存在。
- **高温高压下的弹性性质**：探索如何结合准谐振近似（QHA）或分子动力学（MD）方法，计算材料在极端环境下的力学表现。
- **多尺度模拟协同**：尝试将 ABACUS 计算的弹性张量作为参数，输入到相场模拟或有限元分析（FEA）中，实现从原子尺度到宏观尺度的跨尺度力学分析。
- **高性能计算优化**：针对大规模体系，研究 LCAO 基组下的 `force_stress` 参数微调对计算精度与效率的平衡。

### 通用调试建议 (Troubleshooting)
在计算弹性常数时，若遇到结果不收敛或非物理偏差（如负模量），请按以下顺序排查：
1. **应力基准检查**：初始结构是否经过充分弛豫？残余应力是否已降至 $10^{-1}$ kbar 以下？
2. **收敛参数加固**：弹性常数对应力极其敏感，通常需要比常规 SCF 计算更高的 `ecutwfc` 和更密的 `K_POINTS`。
3. **形变步长验证**：施加的应变（Strain）是否过大？通常建议在 $\pm 0.005$ 到 $\pm 0.02$ 之间取值，以确保处于线性弹性区间。
4. **对称性破缺**：检查施加形变后的结构是否正确保留或按照预期打破了对称性，避免 `abacustest` 脚本在处理复杂晶系时的逻辑错误。

### 官方资源与文档
- **ABACUS 官方文档**：[https://abacus.deepmodeling.com/](https://abacus.deepmodeling.com/)
- **ABACUS 开源算例库**：[https://gitee.com/mcresearch/abacus-user-guide](https://gitee.com/mcresearch/abacus-user-guide)
- **DeepModeling 社区**：鼓励在 GitHub Issues 或相关技术论坛中与开发者直接交流，共同完善国产软件生态。
