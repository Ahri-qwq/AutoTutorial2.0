# 第四章：进阶案例与各向异性——金红石型 TiO2

在上一章中，我们通过硅（Si）熟悉了弹性常数计算的基本流程。硅是典型的立方晶系，各向同性较高，仅有 3 个独立的弹性常数。然而，实际研究中我们常会遇到更复杂的晶体结构。

本章我们将以**金红石型二氧化钛（Rutile TiO₂）**为例，深入探讨非立方晶系（四方晶系）的各向异性处理方法。我们将重点解决两个核心问题：**晶胞选取的物理意义**以及**原子弛豫对弹性性质的关键影响**。

---

## 4.1 处理各向异性与晶体取向

在计算弹性张量之前，最关键的一步并非设置参数，而是**构建正确的几何结构**。对于非立方晶系，晶体的取向直接决定了弹性矩阵 $C_{ij}$ 的形式。

### 4.1.1 核心概念：为何要用“惯用胞”而非“原胞”？

这是初学者最容易踩的坑。在电子结构计算（如能带）中，为了节省算力，我们通常使用原子数最少的**原胞（Primitive Cell）**。但在弹性常数计算中，我们强烈建议使用**惯用胞（Conventional Cell）**。

*   **物理直观性**：弹性常数 $C_{11}$ 定义为沿 x 轴的法向应力与法向应变之比。如果使用原胞，其晶格矢量可能并不沿 Cartesian 坐标系的 x, y, z 轴方向（例如面心立方或体心立方的原胞轴之间夹角并非 90 度）。
*   **张量形式**：如果晶格矢量与坐标轴不重合，计算出的弹性张量矩阵将充满非零的非对角项。虽然这在数学上是正确的，但你必须进行复杂的张量旋转变换才能得到物理上直观的 $C_{11}, C_{12}$ 等数值。
*   **最佳实践**：始终构建晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 分别平行于 $x, y, z$ 轴的惯用胞。对于金红石 TiO₂（四方晶系），这意味着 $a=b \neq c$，且 $\alpha=\beta=\gamma=90^\circ$。

### 4.1.2 预处理：结构优化 (Cell Relax)

任何弹性常数计算的前提都是：**系统处于无应力（Stress-free）的平衡态**。如果初始结构存在残余应力，胡克定律的线性关系将不再严格成立，导致计算误差。

**第一步：准备结构**
从 Materials Project 下载 mp-2657 (Rutile TiO₂) 的结构文件（CIF 格式），并转换为 ABACUS 的 `STRU` 文件。

**第二步：执行高精度结构优化**
我们需要同时优化晶胞形状（Cell）和原子位置（Ions）。

使用 `abacustest` 生成优化任务：
```bash
# 假设结构文件名为 TiO2_init.cif
abacustest prepare -f TiO2_init.cif -p INPUT -k KPT --jtype cell-relax --folder-syntax "TiO2_relax"
```

**关键 INPUT 参数解析**：
在生成的 `TiO2_relax/INPUT` 文件中，务必检查以下参数以确保高精度收敛：

```plaintext
INPUT_PARAMETERS
# 任务类型：同时优化晶胞和原子
calculation     cell-relax

# 关联参数：必须足够严格，否则残余应力会影响后续弹性模量
force_thr       1.0e-4      # 力收敛标准 (Ry/Bohr)
stress_thr      1.0e-2      # 应力收敛标准 (KBar)，这一点至关重要！
ecutwfc         100         # 平面波截断能 (Ry)，建议比常规计算设得更高以减少 Pulay 应力

# 电子步收敛
scf_thr         1.0e-8      # 自洽迭代收敛精度
```

提交计算并等待完成。完成后，我们将使用优化后的结构（`OUT.TiO2_relax/STRU_ION_D`）作为后续计算的起点。

---

## 4.2 独立弹性常数分析与实验对比

金红石型 TiO₂ 属于四方晶系（Laue class 4/mmm），根据对称性分析，它具有 **6 个独立弹性常数**：
$$ C_{11}, C_{12}, C_{13}, C_{33}, C_{44}, C_{66} $$

### 4.2.1 核心概念：钳制离子 vs. 松弛离子

在施加应变计算应力时，ABACUS 的工作流中包含了一个极易被忽视但物理意义重大的步骤：**原子内部弛豫**。

*   **钳制离子 (Clamped-ion)**: 施加应变后，晶格变形，但强制原子保持在分数坐标不变。这对应于高频极限（如声波传播速度极快，原子来不及调整位置）。
*   **松弛离子 (Relaxed-ion)**: 施加应变后，固定晶格形状，但**允许原子在晶胞内部移动**以达到新的受力平衡。这对应于静态或低频极限（宏观力学实验测量的数值）。

> **权威指南**: 在绝大多数材料力学性能对比中，我们需要的是**松弛离子**弹性常数。因此，在每一个变形后的子任务中，必须进行 `calculation relax`（固定晶胞优化原子）。

### 4.2.2 实战操作：工作流执行

我们将使用 `abacustest` 自动化完成“施加应变 -> 生成文件 -> 提交计算”的全流程。

**1. 准备输入文件**
创建一个新的目录 `TiO2_elastic`，将上一步优化好的 `STRU` 文件放入，并准备一个标准的 SCF 计算 `INPUT` 模板。

**2. 生成变形任务**
运行以下命令，`abacustest` 会自动根据晶体对称性生成所需的正应变和剪切应变组合。

```bash
# 注意：使用优化后的结构 STRU_optimized
abacustest prepare -f STRU_optimized -p INPUT -k KPT --jtype elastic --folder-syntax "run_elastic"
```

> **⚠️ 风险提示 (Risk of Data Loss)**
> 请勿在已有结果的目录下重复运行上述 `prepare` 命令！该命令会清空并重建所有 `deform-xxx` 文件夹，导致之前的计算数据丢失。

**3. 检查生成的子任务**
进入生成的文件夹，你会发现多个 `deform-xxx` 子目录。检查其中任意一个的 `INPUT` 文件，确认任务类型：
*   `calculation relax`: 确保进行了原子弛豫（这是计算 Relaxed-ion 模量的关键）。
*   `latname`: 这里的晶格矢量是变形后的。

**4. 批量提交与后处理**
提交所有子任务。计算全部完成后，在根目录运行分析命令：

```bash
abacustest analyze -t elastic
```

### 4.2.3 结果分析与验证

程序将输出拟合后的弹性张量矩阵。对于 TiO₂，你应该重点关注矩阵的对称性。

**典型输出示例 (单位 GPa)**：
```text
Elastic Tensor (GPa):
      C11     C12     C13     C14     C15     C16
C11  268.5   175.2   148.0     0.0     0.0     0.0
C21  175.2   268.5   148.0     0.0     0.0     0.0
C31  148.0   148.0   482.0     0.0     0.0     0.0
...
C66    0.0     0.0     0.0     0.0     0.0   190.5
```

**验证清单**：
1.  **对称性检查**：$C_{11}$ 应近似等于 $C_{22}$（四方晶系特征）。如果差异较大，说明 K 点取样不足或应变方向的收敛性不一致。
2.  **数值对比**：
    *   $C_{33}$ 通常远大于 $C_{11}$，反映了金红石结构沿 c 轴（Ti-O 链方向）的刚性更强。
    *   将结果与 Materials Project (mp-2657) 对比。注意：DFT 计算值通常比实验值略高（因为常用 PBE 泛函倾向于高估晶格常数，但弹性模量可能因体积效应而变化，LDA 则通常高估模量）。

---

## 附录：常见问题与最佳实践

在实战中，弹性常数计算是“报错率”较高的任务。以下是资深开发者总结的避坑指南：

### 1. 负模量与数值噪音
如果你计算出的 $C_{ij}$ 矩阵出现负的主对角元（导致声子谱出现虚频，意味着结构不稳定），或者本应为 0 的项（如 $C_{14}$）数值很大（>5 GPa）：
*   **原因 A**：初始结构未完全弛豫。**解决**：重新运行 `cell-relax`，将 `stress_thr` 降至 `1.0e-2` 甚至更低。
*   **原因 B**：应变幅度（Strain Amplitude）不当。
    *   默认应变通常为 $\pm 0.01$ (1%)。
    *   如果体系很软，1% 可能超出线弹性区，尝试减小到 0.005。
    *   如果体系很硬或数值噪音大，1% 可能被误差淹没，尝试增大到 0.02。

### 2. Pulay 应力 (Pulay Stress)
在使用平面波基组（Plane Wave）或 LCAO 基组时，体积变化会导致基组完备性变化，从而产生虚假的“Pulay 应力”。
*   **对策**：在弹性计算中，`ecutwfc`（平面波截断能）应比常规能量计算设置得更高（例如增加 30%）。这能有效压制 Pulay 应力，提高应力张量的计算精度。

### 3. 磁性体系的陷阱
如果计算磁性材料（如 Fe, MnO）：
*   务必在 `INPUT` 中开启 `nspin 2`。
*   **注意**：施加应变可能会导致磁矩翻转或磁序改变。建议在变形后的计算中读取未变形结构的波函数或电荷密度作为初猜，或者手动固定磁矩方向，确保计算的是同一磁态下的弹性响应。