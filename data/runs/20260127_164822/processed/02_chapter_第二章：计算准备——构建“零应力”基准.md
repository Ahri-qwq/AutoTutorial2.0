# 第二章：计算准备——构建“零应力”基准

在第一性原理计算中，弹性常数（Elastic Constants）对应力极其敏感。它们本质上是能量对晶格应变的二阶导数，或者说是应力对应变的一阶导数。如果你的初始结构中存在残余应力（Residual Stress），那么你施加的微小应变所诱导的物理响应就会被这些“噪音”淹没，导致计算结果出现严重偏差，甚至出现非物理的负模量。

本章我们将构建计算的基石：获得一个应力张量几乎为零的完美初始结构。

## 2.1 晶胞的选择：惯用胞 vs 原胞

在开始计算之前，我们面临的第一个抉择是：使用**原胞（Primitive Cell）**还是**惯用胞（Conventional Cell）**？

对于计算能带结构或声子谱，为了节省计算资源，我们通常首选原子数最少的原胞。然而，**在计算弹性常数时，我强烈推荐使用惯用胞**，特别是对于立方晶系（如 Si, Cu, Al 等）。

### 为什么不推荐使用原胞？

以硅（Si）为例，其面心立方（FCC）原胞包含 2 个原子，晶格矢量 $\vec{a}_1, \vec{a}_2, \vec{a}_3$ 之间夹角为 60°。
如果我们使用原胞进行计算，施加的应变通常是沿着晶格矢量方向的。由于晶格矢量与笛卡尔坐标系（x, y, z）不重合，施加在某一晶格矢量上的“简单拉伸”，在笛卡尔坐标系下会变成复杂的混合应变（既有正应变也有剪切应变）。

这将导致计算得到的弹性刚度矩阵 $C$ 是非对角的，且难以直接阅读。你必须进行复杂的张量坐标变换，才能将其还原为物理直观的 $C_{11}, C_{12}, C_{44}$。

### 惯用胞的优势

对于 Si，我们选择包含 8 个原子的立方惯用胞。
*   **坐标对齐**：其晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 分别与笛卡尔坐标轴 $x, y, z$ 平行。
*   **物理直观**：
    *   沿 x 轴拉伸直接对应 $\epsilon_{11}$，得到的应力响应直接对应 $C_{11}$。
    *   这种“所见即所得”的对应关系，极大地简化了后续的数据处理和物理分析。

> **专家建议**：虽然 8 原子晶胞的计算量是 2 原子晶胞的 4 倍（对于 $O(N^3)$ 算法甚至是 64 倍），但在弹性常数计算中，这种为了物理清晰性而付出的成本是绝对值得的。

## 2.2 消除残余应力：高精度结构优化

获得惯用胞结构文件（如 CIF 文件）后，不能直接用于施加应变。实验测量的晶格常数是在有限温度下测得的，而 DFT 计算通常对应 0K 环境。直接使用实验晶格常数会导致巨大的内应力。

我们需要使用 ABACUS 进行**变胞弛豫（Variable Cell Relaxation）**。

### 2.2.1 核心参数设置 (`INPUT`)

我们需要执行 `cell-relax` 计算。这里的收敛标准必须比常规的能带计算或简单的几何优化更严格。

以下是 `INPUT` 文件的关键参数配置示例：

```bash
INPUT_PARAMETERS
# 1. General Parameters
suffix          Si_cell_relax
calculation     cell-relax    # 关键：同时优化原子位置和晶胞形状/体积
basis_type      lcao          # 或 pw，取决于你的精度/速度需求

# 2. Relaxation Parameters
cal_force       1             # 必须开启力计算
cal_stress      1             # 必须开启应力计算，用于调整晶胞
relax_nmax      100           # 最大离子步数
relax_method    cg            # 或 bfgs，推荐 cg 用于变胞优化

# 3. Convergence Criteria (High Precision)
# 电子步收敛标准：建议 1e-8 或 1e-9，确保力/应力的数值噪音极低
scf_thr         1.0e-9       

# 离子步收敛标准：
# 力的收敛标准，建议 1e-4 eV/Ang (常规计算通常是 0.04 或 0.01)
force_thr_ev    1.0e-4        

# 应力收敛标准：单位 kBar。
# 1 kBar = 0.1 GPa。建议设为 0，或极小值，迫使优化直到几何受限
stress_thr      1.0e-2        

# 4. Smearing (Optional but recommended for metals)
# 对于 Si (半导体) 可不加，但在高精度力计算中，微量的 smearing 有助于收敛
smearing_method gaussian
smearing_sigma  0.001
```

### 2.2.2 结构文件 (`STRU`)

确保你的 `STRU` 文件描述的是惯用胞。例如 Si 的 8 原子结构：

```text
ATOMIC_POSITIONS
Direct
Si
1.0
8
0.0000000000 0.0000000000 0.0000000000 1 1 1
0.5000000000 0.5000000000 0.0000000000 1 1 1
0.0000000000 0.5000000000 0.5000000000 1 1 1
0.5000000000 0.0000000000 0.5000000000 1 1 1
0.2500000000 0.2500000000 0.2500000000 1 1 1
0.7500000000 0.7500000000 0.2500000000 1 1 1
0.7500000000 0.2500000000 0.7500000000 1 1 1
0.2500000000 0.7500000000 0.7500000000 1 1 1
```
*注意：最后的 `1 1 1` 表示允许原子在 x, y, z 方向移动，这对于 `cell-relax` 是必须的。*

### 2.2.3 使用 `abacustest` 自动化准备

我们可以使用 `abacustest` 快速生成优化任务。假设你已经有了 `Si_conventional.cif`：

```bash
# 生成 cell-relax 任务
# -jtype cell-relax 指定任务类型为变胞优化
abacustest submit -f Si_conventional.cif -p input_param.json -jtype cell-relax --folder-syntax "Si_relax"
```
*(注：`input_param.json` 可包含上述的高精度参数，或者生成后手动修改 `INPUT` 文件)*

### 2.2.4 检查“零应力”状态

计算完成后，检查输出文件（通常在 `OUT.suffix/running_cell-relax.log` 或类似日志中）。
你需要确认最后一步的应力张量（Stress Tensor）对角项是否接近于 0。通常，残余应力应小于 0.1 kBar。

## 2.3 核心概念辨析：Relaxed-ion vs. Clamped-ion

在进入下一章施加应变之前，必须澄清一个物理概念，这决定了我们后续的计算流程。

当我们对优化好的晶胞施加一个应变（例如拉伸 1%）时，晶格形状改变了。此时原子内部的位置有两种处理方式：

1.  **Clamped-ion (钳制离子)**: 原子的分数坐标保持不变。原子像是被“钉”在晶格上随晶格一起均匀变形。这对应于高频极限下的弹性响应（原子来不及弛豫）。
2.  **Relaxed-ion (松弛离子)**: 晶格变形后，固定晶胞形状，允许原子在晶胞内部移动（Internal Relaxation）以达到新的受力平衡。这对应于静态或低频下的宏观物理测量。

**实战指南**：
绝大多数实验测量的弹性模量都是 **Relaxed-ion** 模量。
因此，我们的计算流程必须是：
1.  **Pre-process (本章)**: `cell-relax` 获得无应力基准结构。
2.  **Process (下一章)**: 施加应变 -> **固定晶胞，优化原子位置 (`calculation: relax`)** -> 计算最终应力。

> **警告 (Risk of Data Loss)**
>
> 在后续使用 `abacustest elastic` 命令生成应变任务时，请务必注意：**不要在已经存在结果的目录下重复运行该命令**。
> `abacustest` 的初始化脚本通常会清理旧的 `deform` 文件夹。如果你辛辛苦苦算了一半，误运行了准备脚本，你的数据将会瞬间丢失。请养成良好的目录管理习惯，将 `run` 目录与 `analysis` 目录分层管理。