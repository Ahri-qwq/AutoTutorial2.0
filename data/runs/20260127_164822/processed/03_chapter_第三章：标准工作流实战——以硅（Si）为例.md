# 第三章：标准工作流实战——以硅（Si）为例

在上一章中，我们详细解析了 ABACUS 的输入参数。本章我们将进入实战环节，以计算材料学中最经典的案例——硅（Silicon）的弹性性质计算为例，演示如何利用 ABACUS 配合自动化工具 `abacustest` 完成从结构优化、批量任务生成到结果后处理的完整工作流。

本章不仅会教你“怎么做”，更会重点解释“为什么这样做”，特别是关于晶胞选择和原子弛豫的物理意义。

---

## 3.0 前置知识：为什么选择 8 原子的惯用胞？

在开始计算之前，我们需要准备硅的初始结构。硅是典型的金刚石结构（Diamond structure），属于面心立方（FCC）晶系。

**核心问题**：在计算能带时，我们通常使用包含 2 个原子的**原胞（Primitive Cell）**以节省计算资源；但在计算弹性模量时，我强烈建议你使用包含 8 个原子的**惯用胞（Conventional Cell）**。

**原因如下**：
弹性张量 $C_{ij}$ 是定义在笛卡尔坐标系（$x, y, z$）下的。
*   **原胞**：基矢量是非正交的，与笛卡尔坐标轴不重合。如果使用原胞施加应变，得到的弹性矩阵将是非对角化的，物理图像不直观，且需要复杂的张量变换才能得到标准的 $C_{11}, C_{12}, C_{44}$。
*   **惯用胞**：其晶格矢量（Lattice Vectors）天然沿着 $x, y, z$ 轴方向（即 $\mathbf{a}=a\hat{x}, \mathbf{b}=a\hat{y}, \mathbf{c}=a\hat{z}$）。在这种坐标系下施加应变，我们可以直接利用立方晶系的对称性，通过胡克定律直接拟合出物理意义明确的弹性常数。

因此，本教程中我们使用 **8 原子的立方惯用胞**作为起点。

---

## 3.1 第一阶段：结构预优化 (Pre-process)

在施加应变之前，必须确保初始结构处于“零应力”的基态。任何残余应力都会导致后续的弹性常数拟合出现误差。

我们将使用 `abacustest` 工具来生成输入文件。假设你已经准备好了 `Si.cif`（惯用胞结构）。

### 3.1.1 生成优化任务
在终端执行以下命令：

```bash
# 使用 cell-relax 模式，生成名为 Si_relax 的任务文件夹
abacustest lib -f Si.cif --jtype cell-relax --lcao --folder-syntax Si_relax
```

### 3.1.2 关键参数解析
生成的 `INPUT` 文件中，针对结构优化，以下参数至关重要：

*   **`calculation`**: `cell-relax`
    *   我们需要同时优化晶胞形状（Cell）和原子位置（Ions），以消除所有内应力。
*   **`cal_stress`**: `1`
    *   必须开启应力计算，否则无法判断晶胞是否达到平衡。
*   **`cal_force`**: `1`
    *   必须开启力计算，用于原子位置弛豫。

提交计算并等待完成后，我们将得到最终的结构文件（通常位于 `OUT.ABACUS/STRU_ION_D` 或类似目录），将其重命名为 `STRU_optimized` 备用。

---

## 3.2 第二阶段：使用 abacustest 准备应变任务 (Process)

弹性常数的计算原理是**应力-应变法（Stress-Strain Method）**：给晶体施加微小的形变（应变 $\varepsilon$），计算产生的应力（$\sigma$），然后通过 $\sigma = C \varepsilon$ 拟合得到 $C$。

手动手动创建几十个变形结构极其繁琐且易错，这里我们使用 `abacustest` 的 `elastic` 模块。

### 3.2.1 自动生成变形任务
基于上一步优化好的结构 `STRU_optimized`，执行以下命令：

```bash
# 自动生成弹性常数计算任务
# --norm: 最大正应变 (normal strain) 幅度
# --shear: 最大剪切应变 (shear strain) 幅度
abacustest elastic -f STRU_optimized --norm 0.01 --shear 0.01
```

**⚠️ 警告 (Risk of Data Loss)**：
请务必在一个干净的目录下或确认无重要数据时运行此命令。如果当前目录下已经存在名为 `deform-xxx` 的文件夹，`abacustest` 会**直接删除并覆盖**它们，不会进行二次确认。

### 3.2.2 生成的目录结构
命令执行后，你会看到类似以下的目录结构：
*   `run_elastic/` (或当前目录)
    *   `org/`: 原始结构的计算任务（作为基准）。
    *   `deform-001/`: 施加了第一种正应变的结构（如 +0.5%）。
    *   `deform-002/`: 施加了第一种正应变的结构（如 -0.5%）。
    *   ...
    *   `deform-012/`: 施加了剪切应变的结构。

### 3.2.3 核心物理策略：Relax vs SCF (Clamped vs Relaxed Ions)

在生成的每个 `deform` 文件夹的 `INPUT` 文件中，你会发现 `calculation` 参数默认被设为了 `relax`（或者你需要手动确认这一点）。这里涉及一个深刻的物理问题：

**当晶胞发生形变后，原子应该动吗？**

1.  **Clamped-ion (钳制离子) 模型**:
    *   **操作**: `calculation = scf`。
    *   **含义**: 晶胞变形，原子保持其分数坐标不变。
    *   **物理对应**: 对应于极高频的响应（如声子频率远高于原子弛豫频率），原子来不及移动。这通常**不符合**我们宏观测量的弹性模量。

2.  **Relaxed-ion (松弛离子) 模型 (推荐)**:
    *   **操作**: `calculation = relax` (注意是固定晶胞，仅优化原子位置)。
    *   **含义**: 晶胞被强制固定在变形后的形状，但允许原子在晶胞内部移动以消除内部微观力（Internal relaxation）。
    *   **物理对应**: 宏观物理测量中，原子总是有时间弛豫到新的平衡位置。
    *   **ABACUS 设置**:
        *   `calculation`: `relax`
        *   `cal_stress`: `1` (必须计算应力用于拟合)
        *   `cal_force`: `1` (用于原子弛豫)

**专家建议**: 除非你有特殊的研究目的（如研究高频声学支），否则**请务必使用 `relax` 模式**。`abacustest` 默认行为通常是生成 `relax` 任务，如果你想强制计算 Clamped-ion 性质，可以使用 `--norelax` 参数。

---

## 3.3 第三阶段：结果后处理与数据拟合 (Post-process)

当所有 `deform-xxx` 文件夹中的 ABACUS 任务都计算完成后（即目录下生成了 `OUT.ABACUS`），我们就可以进行最后的数据收集和拟合。

### 3.3.1 一键后处理
在包含所有 `deform` 文件夹的根目录下，运行：

```bash
abacustest elastic --post
```

### 3.3.2 结果解读
程序会自动读取每个子任务的应力张量，进行线性拟合，并输出如下关键信息：

1.  **弹性刚度张量 (Elastic Stiffness Tensor, $C_{ij}$)**:
    对于硅（立方晶系），你应该关注三个独立分量：
    *   $C_{11}$: 代表沿轴向拉伸的刚度。
    *   $C_{12}$: 代表泊松效应导致的横向耦合。
    *   $C_{44}$: 代表剪切变形的刚度。

    *参考数值（基于 PBE 泛函）*:
    *   $C_{11} \approx 155 \text{ GPa}$
    *   $C_{12} \approx 58 \text{ GPa}$
    *   $C_{44} \approx 76 \text{ GPa}$

2.  **宏观模量 (Voigt-Reuss-Hill bounds)**:
    *   **体模量 (Bulk Modulus, $B$)**: 衡量材料抗压缩的能力。
    *   **剪切模量 (Shear Modulus, $G$)**: 衡量材料抗剪切变形的能力。
    *   **杨氏模量 (Young's Modulus, $E$)**: 描述固体材料抵抗形变能力的物理量。
    *   **泊松比 (Poisson's Ratio, $\nu$)**: 材料横向变形与纵向变形之比。

### 3.3.3 常见问题排查
*   **拟合出的 $C_{ij}$ 矩阵不对称？**
    *   检查 `scf_thr` 是否足够严格（建议 `1e-8`）。
    *   检查 `kspacing` 或 K 点密度是否足够高。
*   **$C_{11}$ 和 $C_{12}$ 偏差很大？**
    *   确认是否使用了惯用胞。如果使用了原胞但按照立方晶系公式拟合，结果会完全错误。

---

## 本章总结

通过本章，我们掌握了 ABACUS 计算弹性性质的标准工作流：
1.  **准备**: 使用 **8 原子惯用胞**，并进行严格的 **Cell-Relax** 预优化。
2.  **计算**: 使用 `abacustest elastic` 生成变形任务，采用 **Relaxed-ion (`calculation=relax`)** 策略以获取符合宏观物理图像的结果。
3.  **分析**: 批量提交后，使用 `--post` 自动拟合得到 $C_{ij}$ 及宏观模量。

这个流程不仅适用于硅，也适用于绝大多数 3D 晶体材料。下一章，我们将探讨更复杂的电子性质计算——能带结构与态密度。