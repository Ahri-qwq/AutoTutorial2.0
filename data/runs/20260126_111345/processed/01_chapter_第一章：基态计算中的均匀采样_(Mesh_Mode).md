# 第一章：基态计算中的均匀采样 (Mesh Mode)

**作者**：ABACUS 开发团队 & 资深计算材料学教授

在第一性原理计算中，任何材料模拟的起点都是电子密度的自洽场（SCF）计算或几何结构优化。这一过程的核心在于如何处理周期性边界条件下的布里渊区（Brillouin Zone, BZ）积分。

对于基态性质（如总能量、电荷密度、力、应力），我们需要在倒空间进行**均匀采样**。本章将深入解析 ABACUS 中最常用的 Monkhorst-Pack (MP) 采样方法，并介绍两种截然不同的设置路径：经典的 `KPT` 文件法与现代化的 `kspacing` 自动法。

---

## 1.1 物理基础与 KPT 文件结构

根据 Bloch 定理，晶体中的电子波函数由波矢 $\mathbf{k}$ 标记。宏观性质（如总能）是 $\mathbf{k}$ 在第一布里渊区内的积分。在数值计算中，我们用有限的离散点网格（Mesh）来近似这个积分。

在 ABACUS 进行 SCF、Relax 或 Cell-Relax 计算时，必须使用**均匀网格**。这是通过工作目录下的 `KPT` 文件来定义的。

### 标准 KPT 文件格式

一个典型的用于基态计算的 `KPT` 文件如下所示：

```text
K_POINTS
0
Gamma
4 4 4 0 0 0
```

### 参数详解

1.  **关键字 (Line 1)**: `K_POINTS`，这是文件的固定头。
2.  **模式标志 (Line 2)**:
    *   **`0` (关键)**: 这是**自动网格模式（Automatic Generation）**的标志。
    *   **注意**: 如果此处是正整数（如 `20`），则代表手动列出具体的 $k$ 点坐标（Explicit Mode），这通常用于能带计算（Line Mode），**绝不要在 SCF/Relax 中使用手动模式**，除非你非常清楚自己在做什么。
3.  **网格类型 (Line 3)**:
    *   `Gamma`: 生成 **Gamma-centered** Monkhorst-Pack 网格。意味着网格包含原点 $\Gamma (0, 0, 0)$。这是最通用的选择，尤其适用于六角晶系（Hexagonal）以保持正确的对称性。
    *   `mp`: 生成标准的 Monkhorst-Pack 网格。根据网格的奇偶性，原点可能会被平移以避开 $\Gamma$ 点（以此减少计算量，因为 $\Gamma$ 点通常计算较慢），但在某些低对称性体系中需谨慎使用。
    *   **推荐**: 对于初学者，始终优先使用 `Gamma`。
4.  **网格密度与平移 (Line 4)**:
    *   `nx ny nz`: 在倒格子基矢量 $\mathbf{b}_1, \mathbf{b}_2, \mathbf{b}_3$ 方向上的划分份数。数值越大，采样越密，结果越精确，但计算成本呈立方增长。
    *   `sx sy sz`: 网格的平移量（Shift）。在 `Gamma` 模式下通常设为 `0 0 0`。

---

## 1.2 极简方案：使用 kspacing 自动生成

在传统的 DFT 软件使用习惯中，用户需要根据晶胞的大小（Real space cell size）手动计算倒空间网格 `nx ny nz`，这在处理大量不同体积的结构时非常繁琐。

ABACUS 引入了现代化的 **`kspacing`** 参数，允许用户直接在 `INPUT` 文件中定义 $k$ 点之间的最小间距，从而让软件自动计算所需的网格密度。

### 使用方法

在 `INPUT` 文件中添加以下参数：

```text
INPUT_PARAMETERS
# ... 其他参数 ...
kspacing    0.15
# ... 其他参数 ...
```

*   **`kspacing`**: 单位通常为 $1/\text{Bohr}$（请以官方文档最新版本为准，通常建议值在 0.10 ~ 0.20 之间）。
*   **优先级**: 当 `INPUT` 中设置了 `kspacing` 且值大于 0 时，ABACUS 会**忽略**目录下的 `KPT` 文件，直接根据晶胞尺寸自动生成满足间距要求的 MP 网格。

### 方案对比：手动 KPT vs. 自动 kspacing

| 特性 | 手动 KPT 文件 | 自动 kspacing (INPUT) |
| :--- | :--- | :--- |
| **控制精度** | **高**。可以精确控制 $4\times4\times4$ 还是 $5\times5\times5$。 | **中**。软件根据间距取整，可能在临界值处跳变。 |
| **便捷性** | 低。晶胞改变大小（如扩胞）后必须手动重新计算并修改 KPT。 | **极高**。同一套参数可用于不同大小的晶胞，自动适应。 |
| **适用场景** | 精细的收敛性测试、能带计算的前置 SCF、需要严格控制对称性的计算。 | 高通量计算、初步结构优化、机器学习数据集生成。 |

> **锦囊妙计**: 对于初学者或高通量任务，强烈推荐使用 `kspacing`。它能有效避免“扩胞后忘记减少 k 点”导致的计算资源极度浪费。

---

## 1.3 收敛性测试实战

“多少 $k$ 点才够用？”没有标准答案，只有**收敛性测试**。

### 测试方法论

1.  固定截断能（`ecutwfc`）和其他参数。
2.  改变 $k$ 点密度（例如从 $2\times2\times2$ 增加到 $8\times8\times8$）。
3.  记录系统的**总能量**（Total Energy）或关注的物理量（如带隙、磁矩）。
4.  当 $k$ 点增加导致的总能量变化小于设定阈值（如 1 meV/atom）时，即认为收敛。

### 晶系与折叠规则（Scaling Rules）

在设置网格时，需遵循晶体对称性和倒空间尺寸的反比关系：

1.  **立方体系 (Cubic)**:
    实空间晶格矢量长度 $a=b=c$，因此倒空间网格应设为 `nx = ny = nz`（如 `4 4 4`）。
2.  **各向异性体系**:
    如果实空间中 $a < b < c$，则倒空间中 $b_1 > b_2 > b_3$。为了保持采样均匀度一致，网格密度应满足 $n_x > n_y > n_z$。
    *   **经验公式**: $n_i \cdot |\mathbf{a}_i| \approx \text{Constant}$ (Constant 通常取 30~50 Å)。
3.  **超胞折叠 (Supercell Folding)**:
    这是新手最容易犯错的地方。
    *   假设原胞（Unit Cell）收敛网格为 $12 \times 12 \times 12$。
    *   如果你建立了一个 $2 \times 2 \times 2$ 的超胞（Supercell），实空间体积扩大了 8 倍，倒空间体积缩小为原来的 1/8。
    *   此时，超胞仅需 $6 \times 6 \times 6$ 的网格即可达到与原胞相同的采样精度。
    *   **规则**: 扩胞 $N$ 倍，$k$ 点密度可缩减 $1/N$。

---

## 1.4 专家提示：SCF 与 Non-SCF 的文件管理

在进行能带结构（Band Structure）计算时，我们通常分两步走：
1.  **SCF 计算**: 求解基态电荷密度（使用均匀 Mesh 网格）。
2.  **Non-SCF 计算**: 读取电荷密度，计算高对称路径上的能级（使用 Line 模式）。

**严重误区**: 初学者常直接修改 `KPT` 文件为 Line 模式进行第二步计算，这会导致若需重新运行 SCF 时必须再次修改文件，极易出错。

**最佳实践**:
利用 `INPUT` 文件中的 `kpoint_file` 参数实现文件分离。

1.  **准备两个 KPT 文件**:
    *   `KPT`: 存放均匀网格（如 `4 4 4`），用于 SCF。
    *   `KPT_BAND`: 存放高对称路径（Line Mode），用于能带计算。

2.  **SCF 阶段 (INPUT)**:
    不指定 `kpoint_file`，默认读取 `KPT`。
    ```text
    calculation  scf
    # 默认读取名为 KPT 的文件
    ```

3.  **能带计算阶段 (INPUT)**:
    指定读取 `KPT_BAND`。
    ```text
    calculation   nscf
    kpoint_file   KPT_BAND  # 显式指定能带路径文件
    ```

通过这种方式，你可以将同一目录下的计算流程清晰化，避免文件覆盖带来的混乱。

---

**本章小结**:
*   基态计算（SCF/Relax）必须使用均匀网格（Mesh Mode），标志位为 `0`。
*   `Gamma` 方案比 `mp` 方案更通用，推荐作为默认设置。
*   `kspacing` 是懒人神器，适合快速上手。
*   扩胞计算时，切记按比例减小 $k$ 点密度。