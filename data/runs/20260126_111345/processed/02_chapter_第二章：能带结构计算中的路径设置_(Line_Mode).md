# 第二章：能带结构计算中的路径设置 (Line Mode)

在上一章中，我们已经掌握了如何通过自洽场（SCF）计算获得体系的基态电荷密度。然而，对于半导体、金属或拓扑材料的研究者而言，仅仅知道基态能量是不够的。我们需要了解电子在倒空间（Reciprocal Space）中的色散关系——即**能带结构（Band Structure）**。

能带计算的核心挑战在于：它不再像 SCF 那样对布里渊区（Brillouin Zone, BZ）进行均匀采样，而是需要沿着特定的**高对称路径（High-symmetry Path）**进行密集采样。

本章将深入讲解 ABACUS 中能带计算的专用设置，特别是 `KPT` 文件的 **Line 模式**，以及如何通过优雅的文件管理策略实现从 SCF 到 Non-SCF 计算的无缝衔接。

---

## 2.1 高对称路径与 Line 模式格式

在进行 SCF 计算时，我们通常使用 Gamma 中心或 Monkhorst-Pack (MP) 网格来均匀覆盖布里渊区。但在能带计算中，我们需要告诉 ABACUS：“请沿着 $\Gamma \rightarrow X \rightarrow W \dots$ 这条线计算电子原本征值。”

这就需要使用 `KPT` 文件的 **Line 模式**。

### 2.1.1 `KPT` 文件结构详解 (Line Mode)

一个典型的用于能带计算的 `KPT` 文件结构如下：

```text
K_POINTS
4           # 关键参数 N: 高对称点的总数量
Line        # 关键标志: 告诉程序这是线模式，而非 Gamma/mp
0.0 0.0 0.0 20  # 坐标(x,y,z) 和 插值点数(n) -> Gamma点
0.5 0.0 0.5 20  # X点
0.5 0.25 0.75 20 # W点
0.375 0.375 0.75 1 # K点 (最后一个点的插值数通常不起作用，但建议填1或0)
```

### 2.1.2 关键参数解析

1.  **`K_POINTS`**: 文件头，必须存在。
2.  **`N` (高对称点总数)**:
    *   这是指你列出的高对称点的个数（如上例中的 4）。
    *   **注意**: 这不是总 $k$ 点数，而是路径“节点”的个数。
3.  **`Line`**:
    *   这是模式切换的开关。必须严格拼写为 `Line`（区分大小写视版本而定，建议首字母大写）。
    *   一旦设置为 `Line`，ABACUS 将不再进行均匀网格生成，而是执行路径插值。
4.  **坐标 `x y z`**:
    *   **物理含义**: 倒空间的分数坐标（Fractional Coordinates）。
    *   **约束**: 必须与 `STRU` 文件中定义的倒格矢基底相对应。
5.  **插值点数 `n`**:
    *   **含义**: 当前点与**下一个点**之间的间隔点数。
    *   例如，第一行的 `20` 表示从 $\Gamma$ (0,0,0) 到 $X$ (0.5,0,0.5) 之间插入 20 个点。
    *   **总 $k$ 点数估算**: 总点数 $\approx \sum n_i$。点数越多，能带图越平滑，但计算量越大。通常每段路径取 10-20 个点即可满足绘图需求。

---

## 2.2 关键流程：从 SCF 到 Non-SCF

这是初学者最容易犯错的地方。**绝对不要直接使用 Line 模式的 `KPT` 文件进行 SCF（自洽）计算。**

### 2.2.1 为什么不能直接用 Line 模式做 SCF？
自洽计算（SCF）的目标是求解正确的基态电荷密度。这需要对整个布里渊区体积进行积分（求和）。Line 模式只采样了一条线，忽略了布里渊区绝大部分体积，会导致计算出的电荷密度完全错误，进而导致错误的费米能级和总能。

### 2.2.2 标准“两步走”工作流

**Step 1: 自洽计算 (SCF)**
*   **目标**: 获得收敛的电荷密度（`SPIN1_CHG.cube` 或密度矩阵）。
*   **KPT 设置**: 使用 `Gamma` 或 `mp` 模式，保证均匀采样。
*   **INPUT 设置**: `calculation scf`。

**Step 2: 非自洽计算 (Non-SCF / Band)**
*   **目标**: 读取 Step 1 的电荷密度，固定哈密顿量，仅求解特定 $k$ 点（路径）的本征值。
*   **KPT 设置**: 使用 `Line` 模式。
*   **INPUT 设置**:
    *   `calculation nscf`：明确告知程序这是非自洽计算。
    *   `init_chg file`：**核心参数**。指示程序从文件中读取电荷密度，而不是从原子叠加开始初始化。
    *   `out_band 1`：输出能带结构数据（通常生成 `BANDS_1.dat` 等文件）。

---

## 2.3 文件管理与多文件协作 (Best Practice)

在实际操作中，频繁修改 `KPT` 文件既繁琐又容易出错（例如跑完能带想复查 SCF 能量，却发现 `KPT` 已经被覆盖了）。

作为资深开发者，我推荐利用 ABACUS 的 `kpoint_file` 参数进行文件分流。

### 2.3.1 推荐的文件结构
建议在工作目录下准备两个 K 点文件：
1.  `KPT`: 用于 SCF 的均匀网格文件。
2.  `KLINES`: 用于能带计算的路径文件（文件名可自定义）。

### 2.3.2 INPUT 文件配置示例

假设你已经完成了 Step 1 (SCF)，现在进行 Step 2 (Band)。你的 `INPUT` 文件应包含以下关键修改：

```bash
INPUT_PARAMETERS
# ... (基础参数如 suffix, basis_type 等保持不变)

# 计算类型控制
calculation     nscf        # 必须：设置为非自洽计算
init_chg        file        # 必须：读取上一步生成的电荷密度

# 关键：指定能带专用的 K 点文件
kpoint_file     KLINES      # 指定读取 KLINES 而不是默认的 KPT

# 输出控制
out_band        1           # 输出能带数据格式
out_dos         0           # 能带计算通常不需要 DOS，除非同时计算
symmetry        1           # 保持对称性打开有助于确定高对称点
```

**操作技巧**:
通过这种方式，你只需要维护两套输入文件（或者在脚本中修改 `kpoint_file` 参数），而无需反复重写 `KPT` 内容。

---

## 2.4 锦囊妙计：kspacing 与收敛性技巧

### 2.4.1 偷懒神器：`kspacing`
在较新版本的 ABACUS 中，引入了 `kspacing` 参数。如果你在 Step 1 (SCF) 中不想手动编辑 `KPT` 文件，可以直接在 `INPUT` 中设置：

*   **参数**: `kspacing` (单位: 1/Bohr)
*   **作用**: ABACUS 会根据倒格子的大小自动生成满足间距要求的 MP 网格。
*   **优势**: 实现了 $k$ 点网格密度的“归一化”，使得不同晶格常数的体系具有可比的采样精度。
*   **注意**: 当设置了 `kspacing` 时，程序会忽略 `KPT` 文件。但在 Step 2 (Band) 计算时，**必须**移除 `kspacing` 参数，并指定 `kpoint_file`，否则程序仍会尝试自动生成网格而不是读取路径。

### 2.4.2 K 点收敛性经验法则
在 Step 1 (SCF) 中，如何确定 $k$ 点网格是否足够？
1.  **立方体系**: $x, y, z$ 方向的 $k$ 点数应相同。
2.  **各向异性体系**: $k$ 点密度与晶格常数成反比。即实空间晶格越长，倒空间布里渊区越小，所需的 $k$ 点数越少。
3.  **扩胞法则**: 如果你将晶胞在某方向扩大了 $N$ 倍（Supercell），那么该方向的 $k$ 点数可以缩小至原来的 $1/N$，计算精度基本保持不变。

---

**本章总结**:
能带计算是“计算流程”与“物理概念”的结合。请务必牢记：**SCF 用均匀网格定电荷，Non-SCF 用 Line 模式画能带**。通过合理使用 `kpoint_file` 和 `init_chg` 参数，你可以构建出清晰、稳健的计算工作流。

下一章，我们将讨论如何处理金属体系的拖尾效应（Smearing）以及态密度（DOS）的计算细节。