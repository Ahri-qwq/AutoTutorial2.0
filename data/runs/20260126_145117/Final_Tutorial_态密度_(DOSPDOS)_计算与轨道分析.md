# ABACUS 电子结构计算实战：从物理基础到大规模体系模拟

## 前言

欢迎开启 ABACUS（Atomic-orbital Based Ab-initio Computation at UStc）的学习之旅。作为一款由中国自主研发、在国际上具有重要影响力的开源第一性原理计算软件，ABACUS 的核心优势在于其对原子轨道（LCAO）与平面波（PW）基组的完美支持。尤其是在处理数千个原子的超大体系和温稠密物质（WDM）时，ABACUS 展现出了卓越的计算效率与扩展性。虽然对于初学者而言，理解不同基组的选取和复杂的输入参数具有一定挑战，但一旦掌握，它将成为你探索材料微观世界的利器。

**学习路线图**
本教程旨在通过实战引导，带你从零开始掌握 ABACUS 的核心功能：
- **第一章** 夯实基础，建立关于态密度（DOS）的物理直觉，这是理解材料性质的灵魂。
- **第二章** 拆解标准 KS-DFT 计算流程，教你如何熟练操作 SCF 与 NSCF 的“两步走”策略。
- **第三章** 聚焦数据生产力，利用 Python 脚本对原始数据进行费米能级对齐与专业化绘图。
- **第四章** 迈向进阶，介绍 ABACUS 的独门绝技——随机波函数 DFT（SDFT），突破传统计算的尺寸与温度瓶颈。

**知识体系定位**
本教程处于 ABACUS 知识体系的“实战应用层”。它向上连接凝聚态物理与材料科学的理论体系，向下对接高性能计算（HPC）的实际落地。通过本教程的学习，你不仅能完成基本的能带与态密度分析，还能为后续深入研究催化、光学性质及大规模分子动力学打下坚实基础。

**前置要求**
在开始之前，我们建议读者具备以下基础：
1. 基础量子力学与固体物理知识（如能级、布里渊区、费米面等概念）。
2. 基础的 Linux 命令行操作能力（用于提交任务与管理文件）。
3. 简单的 Python 脚本运行经验（用于数据处理）。

---

# 第一章：物理基础与计算原理

在真正开始编写 `INPUT` 文件和提交任务之前，我们需要先建立正确的物理直觉。态密度（Density of States, DOS）不仅仅是一条曲线，它是连接量子力学微观状态与宏观材料性质的桥梁。

本章将带你理解 DOS 背后的物理图景，并阐述在 ABACUS 中计算 DOS 的核心工作流逻辑。理解这些原理，是你判断计算结果是否“靠谱”的基石。

## 1.1 态密度 (DOS) 的物理图景

### 1.1.1 定义与直观理解
**态密度 (DOS)**，记为 $N(E)$，定义为在能量 $E$ 到 $E+dE$ 区间内，系统允许占据的量子态数目。

如果把电子比作住进大楼的住户，能带结构（Band Structure）告诉我们大楼每一层（能量）有哪些房间（k点），而 DOS 则直接统计每一层楼到底有多少个房间。
- **高 DOS 值**：意味着在该能量处有大量的量子态可供电子占据。
- **零 DOS 值**：意味着该能量处没有量子态（即禁带）。

### 1.1.2 范霍夫奇点 (Van Hove Singularities) —— 校验结果的利器
DOS 是能带结构在布里渊区（Brillouin Zone）的积分。数学上，DOS 与能带的梯度成反比：
$$ N(E) \propto \int \frac{dS}{|\nabla_k E(k)|} $$
这意味着：
- **能带越平坦（Flat Band）**：$\nabla_k E(k)$ 趋近于 0，DOS 会出现尖锐的峰值。
- **能带越陡峭（Dispersive Band）**：电子有效质量小，DOS 相对平缓且数值较低。

> **💡 锦囊妙计：如何一眼判断 DOS 是否合理？**
> 利用**范霍夫奇点**的概念。当你看到 DOS 图上有一个巨大的尖峰时，去对照能带图。如果该能量对应的是一条非常平坦的能带（例如 d 轨道或 f 轨道形成的窄带），那么这个峰是物理真实的。如果能带很陡峭却出现了尖峰，那可能是计算参数（如 K 点采样或展宽）设置有问题。

---

## 1.2 分波态密度 (PDOS) 与轨道投影

总态密度（Total DOS）反映了整体性质，但为了理解化学键，我们需要**分波态密度（Projected DOS, PDOS）**。

### 1.2.1 投影原理
PDOS 是将系统的总波函数 $|\psi_{nk}\rangle$ 投影到以原子为中心的局域轨道（Atomic Orbitals, 如 s, p, d, f）上。
$$ N_{\alpha}(E) = \sum_{n,k} |\langle \phi_{\alpha} | \psi_{nk} \rangle|^2 \delta(E - E_{nk}) $$
在 ABACUS 中，如果你使用 LCAO（原子轨道线性组合）基组（`basis_type = lcao`），这种投影是非常自然且高效的，因为波函数本身就是由原子轨道展开的。

### 1.2.2 化学分析应用
通过 PDOS，我们可以解析材料的“基因”：
1.  **元素贡献**：在这个能量范围内，是 A 原子贡献大，还是 B 原子贡献大？
2.  **轨道杂化**：如果 A 原子的 $d$ 轨道峰与 B 原子的 $p$ 轨道峰在同一能量位置重合，且形状相似，说明它们之间发生了强烈的 **$p-d$ 杂化**成键。

---

## 1.3 材料性质的判据

费米能级（$E_F$）是电子填充的最高水位线。通过观察 $E_F$ 处的 DOS 行为，我们可以一锤定音地判断材料属性：

| 材料类型 | DOS 特征 ($E_F$ 处) | 物理意义 |
| :--- | :--- | :--- |
| **金属 (Metal)** | $N(E_F) > 0$ | 费米面穿过能带，电子极易被激发导电。 |
| **半导体 (Semiconductor)** | $N(E_F) = 0$ | 存在较小的带隙（Band Gap），价带顶与导带底分开。 |
| **绝缘体 (Insulator)** | $N(E_F) = 0$ | 存在巨大的带隙。 |
| **半金属 (Half-metal)** | 自旋向上 $>0$，自旋向下 $=0$ | 对一种自旋是金属，对另一种是绝缘体（自旋电子学关键材料）。 |

---

## 1.4 ABACUS 计算原理与工作流

在动手操作前，必须澄清 ABACUS 中的两种计算路径以及标准的“两步法”流程。

### 1.4.1 关键区分：标准 KS-DFT vs. SDFT
ABACUS 提供了多种计算方法，初学者极易混淆：

1.  **标准 KS-DFT (Kohn-Sham DFT)**：
    *   **适用场景**：绝大多数材料计算（基态性质、能带、DOS）。
    *   **特征**：基于平面波（PW）或原子轨道（LCAO）基组，通过对角化哈密顿量求解。
    *   **本教程重点**：我们将专注于此路径。

2.  **SDFT (Stochastic DFT)**：
    *   **适用场景**：超大体系（数千/上万原子）或高温稠密物质（温稠密物质）。
    *   **特征**：基于随机波函数演化。
    *   **警示**：SDFT 涉及如 `method_sto`, `nche_sto` 等特殊参数。**如果你做的是常规材料分析，请忽略这些参数，不要在 INPUT 文件中添加它们，否则会导致计算模式错误。**

### 1.4.2 核心策略：SCF + NSCF 两步法
计算 DOS **绝不是**一次性完成的任务。为了获得平滑、准确的 DOS 曲线，必须遵循“两步走”策略：

#### **第一步：自洽场计算 (SCF)**
*   **目标**：寻找基态电子密度 $\rho(\mathbf{r})$ 和对应的势场 $V_{eff}(\mathbf{r})$。
*   **K 点设置**：相对稀疏（例如 $6 \times 6 \times 6$）。只要能保证总能量和电荷密度收敛即可。
*   **ABACUS 参数**：`calculation = scf`。

#### **第二步：非自洽场计算 (NSCF / Non-SCF)**
*   **目标**：在第一步得到的**固定**电荷密度和势场下，计算更精细的能级分布。
*   **为什么需要这一步？** DOS 的细节（如尖峰和精细结构）需要非常密的 K 点网格（例如 $12 \times 12 \times 12$ 或更密）才能解析出来。如果在如此密的网格上直接跑 SCF，计算成本将呈立方级增长且极难收敛。
*   **操作逻辑**：读取第一步生成的电荷密度文件（通常在 `OUT.suffix` 文件夹中），冻结它，然后仅进行一次哈密顿量对角化。
*   **ABACUS 参数**：`calculation = nscf` (或在某些版本配合 `out_dos = 1`)。

> **⚠️ 警告**
> 如果跳过 SCF 直接跑 DOS 计算（或者在 NSCF 步没有正确读取电荷密度），你得到的将是基于初始猜测（Initial Guess）的错误结果，毫无物理意义。

### 1.4.3 K 点采样的差异
*   **SCF**：关注能量积分的收敛。K 点过密是浪费。
*   **DOS (NSCF)**：关注能级在能量轴上的分布。K 点越密，DOS 曲线越平滑，噪音越小。
*   **结论**：在准备 DOS 计算的 `KPT` 文件时，务必大幅增加 K 点密度。

---
**下一章预告**：
理解了物理图景和“两步法”原理后，下一章我们将进入实战环节。我们将从零开始，手把手教你编写 ABACUS 的 `INPUT` 和 `KPT` 文件，计算硅（Si）的态密度。

# 第二章：标准 KS-DFT 计算流程 (Standard Workflow)

在掌握了 ABACUS 的输入文件结构后，我们将进入最核心的实战环节。对于绝大多数材料模拟任务（如能带结构、态密度 DOS、光学性质等），我们都遵循一套标准的“两步走”或“三步走”策略。

本章将详细拆解 **标准 KS-DFT（Kohn-Sham Density Functional Theory）** 的计算流程。

> **⚠️ 核心提示：区分 KS-DFT 与 SDFT**
> ABACUS 提供了两种截然不同的计算路径：
> 1.  **标准 KS-DFT**：基于平面波（PW）或原子轨道（LCAO）基组，适用于绝大多数常规材料计算（本章重点）。
> 2.  **随机 DFT (SDFT/MDFT)**：基于随机波函数（Stochastic orbitals），主要用于极端高温或超大体系（参数如 `method_sto` 等），这属于高级功能，**不适用**于本章流程。请勿混淆两者的参数设置。

---

## 2.1 流程概览与结构准备

一个完整的电子结构分析通常包含三个阶段。请务必养成良好的文件管理习惯，建议为每个步骤建立独立的文件夹：

1.  **结构弛豫 (Relaxation)**：
    *   **目的**：获得能量最低的稳定几何结构。
    *   **文件夹示例**：`00_relax/`
    *   **注意**：所有的电子性质计算（DOS, Band）都必须基于受力收敛（Force converged）的结构，否则结果没有物理意义。
2.  **自洽计算 (SCF)**：
    *   **目的**：求解 Kohn-Sham 方程，获得收敛的基态电子密度（Charge Density）和波函数。
    *   **文件夹示例**：`01_scf/`
3.  **非自洽计算 (NSCF)**：
    *   **目的**：读取 SCF 产生的电子密度（固定势场），在更密的 K 点网格上计算特征值，用于输出 DOS 或能带。
    *   **文件夹示例**：`02_nscf_dos/`

**本章假设您已经完成了第一步（结构弛豫），我们将重点讲解从 SCF 到 NSCF 的关键操作。**

---

## 2.2 第一步：自洽计算 (SCF)

DOS 计算的质量直接取决于电荷密度的质量。因此，我们需要先运行一个高精度的 SCF 计算。

### 2.2.1 关键参数设置
在 `01_scf` 文件夹中，修改 `INPUT` 文件：

```bash
INPUT_PARAMETERS
# 1. General
suffix          scf_run      # 输出文件夹后缀
calculation     scf          # 核心参数：设置为自洽计算模式
basis_type      lcao         # 或 pw，根据你的基组选择

# 2. Iteration (Convergence)
scf_nmax        100          # 最大迭代步数
scf_thr         1.0e-7       # 收敛精度。DOS计算建议设为 1e-6 或更高
```

### 2.2.2 K 点设置 (`KPT` 文件)
SCF 步骤的 K 点网格只需保证总能收敛即可。
```text
K_POINTS
0
Gamma
4 4 4 0 0 0
```

### 2.2.3 运行与检查
运行 ABACUS 后，检查 `OUT.scf_run/running_scf.log`，确保看到 `Convergence Achieved`。
**关键产物**：计算结束后，在输出目录中会生成电荷密度文件（通常位于 `OUT.scf_run/SPIN1_CHG.cube` 或类似二进制文件，取决于版本和设置）。这是下一步的“种子”。

---

## 2.3 第二步：非自洽计算 (NSCF) 设置

这是初学者最容易出错的步骤。我们需要做的是：**“只算能级，不更新电荷”**。

### 2.3.1 准备工作
1.  创建文件夹 `02_nscf_dos/`。
2.  将 `01_scf/` 中的 `STRU` (结构文件) 和 `*.upf` (赝势文件) 复制过来。
3.  **传递电荷密度**：这是最关键的一步。
    *   将 `01_scf/OUT.scf_run` 文件夹中的电荷密度文件复制到 `02_nscf_dos/` 中（或者在 INPUT 中指定路径）。
    *   *注：ABACUS 新版通常会自动寻找或通过参数指定，建议查阅当前版本的 `init_chg` 说明。*

### 2.3.2 修改 `INPUT` 文件
在 `02_nscf_dos/INPUT` 中，我们需要告诉 ABACUS 进入 NSCF 模式并读取电荷：

```bash
INPUT_PARAMETERS
# 1. General
suffix          nscf_dos
calculation     nscf         # 核心参数：设置为非自洽计算
basis_type      lcao         # 保持与 SCF 一致

# 2. Charge Density Reading
init_chg        file         # 核心参数：从文件读取电荷密度，而不是从原子叠加开始
                             # 确保程序能找到上一步生成的电荷密度文件

# 3. Precision
# 即使是 NSCF，对角化精度也很重要
scf_thr         1.0e-7       
```

> **专家点拨**：
> 为什么要分两步？
> 如果直接在 DOS 计算中进行 SCF 迭代，为了获得平滑曲线，你往往需要极密的 K 点（如 20x20x20）。在如此密的 K 点下做 SCF 迭代（反复求解）极其昂贵且难以收敛。
> **两步法策略**：在稀疏 K 点（如 4x4x4）下快速收敛电荷密度 -> 固定电荷密度 -> 在密 K 点下仅做一次对角化（NSCF）。这是 DFT 计算的标准范式。

---

## 2.4 DOS 核心参数配置

在 `02_nscf_dos/INPUT` 文件中，还需要添加专门控制 DOS 输出的参数：

```bash
# ... (接上文 INPUT 内容)

# 4. DOS Parameters
out_dos         1            # 开启 DOS 输出开关
dos_emin_ev     -10.0        # DOS 能量窗口下限 (相对于费米能级或真空能，视版本而定)
dos_emax_ev     10.0         # DOS 能量窗口上限
dos_edelta_ev   0.01         # 能量间隔（分辨率）
dos_sigma       0.05         # 高斯展宽因子 (eV)
```

### 参数详解：
*   **`out_dos`**: 必须设为 1，否则程序跑完 NSCF 就结束了，不会生成 DOS 文件。
*   **`dos_emin_ev` / `dos_emax_ev`**:
    *   不要设置得过大（如 -100 到 100），这会生成巨大的无用文件。
    *   通常覆盖价带顶以下 10 eV 到导带底以上 10 eV 即可。
*   **`dos_edelta_ev`**:
    *   决定了 DOS 曲线的数据点密度。
    *   **推荐值**：`0.01` eV。如果太小（如 0.001），文件过大且无必要；如果太大（如 0.1），峰形会变成折线。

---

## 2.5 K 点网格与展宽设置

在 NSCF 计算中，`KPT` 文件的设置与 SCF 截然不同。

### 2.5.1 加密 K 点网格
为了得到平滑、连续的 DOS 曲线，我们需要采样布里渊区中更多的点。
修改 `02_nscf_dos/KPT`：

```text
K_POINTS
0
Gamma
12 12 12 0 0 0   # 注意：比 SCF 的 4x4x4 密得多
```

*   **经验法则**：对于半导体和绝缘体，K 点可以适度稀疏；对于**金属**体系，必须使用非常密的 K 点网格，否则费米面附近的 DOS 会出现剧烈的数值震荡。

### 2.5.2 高斯展宽 (`dos_sigma`)
由于我们是用有限的 K 点来模拟无限晶体，离散的能级需要通过数学方法“展宽”成连续曲线。

*   **`dos_sigma` 的物理意义**：
    *   它类似于实验测量中的仪器分辨率。
    *   **过小**：DOS 曲线会出现许多非物理的尖刺（数值噪声）。
    *   **过大**：特征峰被抹平，带隙看起来比实际要小，细节丢失。
    *   **推荐范围**：`0.05` eV ~ `0.2` eV。

> **锦囊妙计：物理图像验证**
> 当你得到 DOS 结果后，如何判断峰值是否合理？
> 请回忆固体物理中的 **范霍夫奇点 (Van Hove Singularities)**。DOS 的尖锐峰值通常对应于能带结构（Band Structure）中的**平坦能带（Flat Bands）**区域。
> *   如果你在 DOS 中看到一个极高的峰，去检查能带图，对应的能量位置应该有一条几乎水平的能带。
> *   这不仅是验证计算结果的手段，也是理解材料局域电子态（如 d 轨道或 f 轨道电子）的关键视角。

---

### 总结：标准 DOS 计算清单

1.  **Relax**: 结构优化（确保受力 < 0.01 eV/Å）。
2.  **SCF**: `calculation = scf`, 稀疏 K 点 (e.g., 4x4x4)，生成电荷密度。
3.  **NSCF**:
    *   `calculation = nscf`
    *   `init_chg = file` (读取上一步电荷)
    *   `out_dos = 1`
    *   加密 K 点 (e.g., 12x12x12)
    *   设置合理的 `dos_sigma` (0.05-0.1 eV)

运行完成后，在输出目录中寻找 `TDOS` (总态密度) 和 `PDOS` (分波态密度) 文件进行绘图分析。

# 第三章：数据处理与可视化分析

算出数据只是完成了一半。在上一章中，我们通过“两步法”（SCF + NSCF）成功完成了 DOS 计算。然而，ABACUS 输出的原始数据通常是一堆枯燥的数字，且能量标度往往未对齐。

本章将指导你如何像专家一样处理这些原始数据，特别是至关重要的**费米能级对齐**，并结合 Python 脚本生成可发表级别的图表。我们将以硅（Si）为例，不仅教你怎么画，更教你怎么看懂图中的物理含义。

---

## 3.1 输出文件结构解析

当你的 NSCF 计算顺利结束后（即 `calculation` 设置为 `nscf` 且 `out_dos` 设置为 `1`），ABACUS 会在 `OUT.${suffix}` 文件夹中生成一系列文件。

### 3.1.1 核心文件概览

进入输出目录（假设 `suffix` 为默认的 `ABACUS`）：
```bash
cd OUT.ABACUS
ls
```

你会看到以下关键文件：

1.  **`TDOS` (Total Density of States)**
    *   **描述**：系统的总态密度。
    *   **格式**：纯文本文件，包含三列数据。
        *   第 1 列：能量 (Energy)，单位通常为 **eV**。
        *   第 2 列：总态密度 (Total DOS)，单位为 States/eV。
        *   第 3 列：积分态密度 (Integrated DOS)，即总电子数的累积值。

2.  **`PDOS` (Projected Density of States)**
    *   **描述**：分波态密度（如果使用了 LCAO 基组或开启了投影功能）。
    *   **格式**：包含能量列以及投影到各个原子轨道（如 Si 的 3s, 3p）上的 DOS 分量。
    *   **用途**：用于分析能带主要由哪些轨道贡献（例如分析杂化情况）。

3.  **`running_nscf.log` (或类似日志)**
    *   **描述**：计算运行日志。
    *   **用途**：**非常重要**，我们需要从中提取费米能级（Fermi Energy）的数值。

> **专家提示 (Developer Note)**：
> 请务必区分标准 **KS-DFT** 和 **SDFT (Stochastic DFT)** 的输出。
> *   如果你使用的是标准的平面波或原子轨道基组（绝大多数初学者的场景），请关注上述的 `TDOS` 文件。
> *   如果你在做高温稠密物质或超大体系并使用了 SDFT（随机波函数方法），输出文件结构会有所不同。本教程主要针对标准 KS-DFT 流程。

---

## 3.2 数据后处理：费米能级对齐

这是新手最容易犯错的步骤。

### 3.2.1 为什么要对齐？
ABACUS（以及大多数 DFT 软件）输出的原始能量值是相对于计算原本的参考零点（通常是平均静电势或真空能级）。这意味着你的价带顶（VBM）或费米能级（$E_F$）可能显示为 -5.2 eV 或 +3.1 eV，而不是物理直觉上的 0 eV。

为了方便分析，我们需要将费米能级平移到 0 eV。

### 3.2.2 提取费米能级
费米能级通常记录在 SCF 计算的日志中（因为 NSCF 步骤通常不重新更新费米能级，或者使用 SCF 的电荷密度确定的费米能级）。

执行以下命令查找费米能级：
```bash
# 在 SCF 或 NSCF 的日志文件中查找
grep "Fermi" OUT.ABACUS/running_*.log
```

输出示例：
```text
Fermi energy = 6.2345 eV
```
记下这个数值，例如 $E_F = 6.2345$。

### 3.2.3 数据处理公式
在绘图时，我们需要对 `TDOS` 文件中的第一列（能量）进行如下操作：

$$ E_{\text{plot}} = E_{\text{raw}} - E_F $$

*   对于**金属**：$E_{\text{plot}} = 0$ 处即为费米面，DOS 值通常不为零。
*   对于**半导体/绝缘体**：$E_{\text{plot}} = 0$ 通常位于带隙中（或价带顶，取决于具体定义）。

---

## 3.3 绘图实战与案例分析：硅 (Si)

我们将使用 Python (Matplotlib) 编写一个通用的脚本来处理数据并绘图。

### 3.3.1 Python 绘图脚本 (`plot_dos.py`)

将以下代码保存为 `plot_dos.py`，放在 `OUT.ABACUS` 同级目录下。

```python
import numpy as np
import matplotlib.pyplot as plt

# ================= 参数设置 =================
fermi_energy = 6.2345  # <--- 请替换为你 grep 到的实际数值
filename = 'OUT.ABACUS/TDOS'
# ===========================================

# 读取数据
# ABACUS TDOS 文件通常有头信息，使用 comments='#' 跳过注释行
try:
    data = np.loadtxt(filename, comments=['#', 'S']) # 兼容不同版本的头文件注释
except Exception as e:
    print(f"Error reading file: {e}")
    exit()

energy_raw = data[:, 0]
dos_total = data[:, 1]

# 费米能级对齐
energy_aligned = energy_raw - fermi_energy

# 绘图
plt.figure(figsize=(8, 6))

# 绘制 DOS 曲线
plt.plot(energy_aligned, dos_total, color='k', linewidth=1.5, label='Total DOS')

# 填充价带部分 (E < 0)
plt.fill_between(energy_aligned, 0, dos_total, 
                 where=(energy_aligned < 0), 
                 facecolor='skyblue', alpha=0.3)

# 装饰图表
plt.axvline(x=0, color='r', linestyle='--', linewidth=1, label='$E_F$')
plt.xlabel(r'$E - E_F$ (eV)', fontsize=14)
plt.ylabel('DOS (states/eV)', fontsize=14)
plt.title('Total Density of States (Si)', fontsize=16)
plt.xlim(-10, 10)  # 根据需要调整显示范围
plt.ylim(0, max(dos_total) * 1.1)
plt.legend()
plt.grid(alpha=0.3)

# 保存图片
plt.savefig('Si_DOS.png', dpi=300)
plt.show()
```

### 3.3.2 物理图像分析

运行脚本后，你会得到一张 DOS 图。结合第一章的物理知识，我们来“看图说话”：

1.  **带隙 (Band Gap)**：
    *   观察 $E=0$ 附近。对于硅（半导体），你应该看到一段 DOS 为 0 的区域。
    *   **验证**：如果 $E=0$ 处 DOS 明显不为 0，说明要么计算的是金属，要么费米能级提取错误，或者 smearing（展宽）参数设置过大导致带隙被“涂抹”了。

2.  **范霍夫奇点 (Van Hove Singularities)**：
    *   你会注意到 DOS 曲线中有许多尖锐的峰。
    *   **物理含义**：这些峰对应于能带结构中 $E(k)$ 比较平坦的区域（即 $\nabla_k E \approx 0$）。在这些能量处，电子态密度非常高。
    *   **K点提示**：如果你的 DOS 曲线看起来非常粗糙或充满杂乱的毛刺，通常是因为 NSCF 计算时 **K 点网格不够密**。DOS 计算通常需要比 SCF 计算更密的 K 点（例如 SCF 用 8x8x8，DOS 建议用 12x12x12 或更高）。

3.  **轨道贡献 (PDOS)**：
    *   如果你绘制了 PDOS，你会发现硅的价带深处（低能区）主要由 s 轨道贡献，而靠近费米能级的价带顶则由 s 和 p 轨道强烈的杂化（sp3 杂化）贡献。

---

## 3.4 自动化工具链 (Bohrium & Atomkit)

对于高通量计算或不想手动编写脚本的用户，ABACUS 生态提供了便捷的工具。

### 3.4.1 Bohrium 平台
如果你在 Bohrium 平台上运行 ABACUS，可以使用平台集成的 `abacus_dos_run` 或相关 Notebook 模板。这些工具会自动读取 `INPUT` 中的参数和 `OUT` 文件夹中的数据，一键生成交互式的 DOS 图表。

### 3.4.2 Atomkit 与 ASE
高级用户可以使用 Python 库来处理数据。
*   **ASE (Atomic Simulation Environment)**：虽然 ASE 主要用于结构操作，但结合自定义的 ABACUS 解析器，可以批量处理多个结构的 DOS 数据。
*   **dpdata / Atomkit**：DeepModeling 社区开发的工具包，能够方便地将 ABACUS 数据转换为其他格式以便分析。

---

**下一章预告**：
掌握了电子结构的静态性质（DOS）后，我们将让电子“动”起来。下一章我们将进入**能带结构（Band Structure）**的计算，这是连接理论与角分辨光电子能谱（ARPES）实验的桥梁。我们将学习如何选取高对称路径（K-path），并绘制漂亮的能带图。

# 第四章：进阶方法：随机波函数 DFT (SDFT)

在前面的章节中，我们已经掌握了基于标准 Kohn-Sham DFT (KS-DFT) 的计算流程。然而，当我们面对**温稠密物质 (Warm Dense Matter, WDM)** 或者**包含数千个原子的超大体系**时，传统的 KS-DFT 往往会遇到瓶颈。

本章将介绍 ABACUS 的独门绝技——**随机波函数 DFT (Stochastic DFT, SDFT)**。这是一种专门应对高温和大规模体系的高级算法，能够以极高的效率计算态密度 (DOS) 和其他物理性质。

> **⚠️ 核心概念区分**：
> *   **标准 KS-DFT**：基于确定性的平面波或原子轨道基组，通过对角化哈密顿量求解。适用于常规体系（基态、低湿）。
> *   **SDFT**：基于随机波函数（Stochastic Orbitals），利用切比雪夫（Chebyshev）多项式展开来逼近费米-狄拉克算符，避免了昂贵的矩阵对角化。适用于**高温**（T > 10,000 K）或**超大体系**。

---

## 4.1 SDFT 适用场景与原理

### 为什么需要 SDFT？
在高温条件下（例如 $T > 1 \text{ eV} \approx 11605 \text{ K}$），电子会被激发到非常高的能级。为了保证计算精度，KS-DFT 需要包含极其庞大的能带数量（Bands），这会导致计算量呈立方级（$O(N^3)$）甚至指数级增长，且内存消耗巨大。

SDFT 通过引入随机向量（Stochastic Orbitals）来表示电子态，其计算复杂度主要取决于体系的尺寸，而对温度不敏感。这使得它成为模拟行星内核、激光聚变等极端条件的理想工具。

### 核心参数设置
要启用 SDFT，必须在 `INPUT` 文件中修改求解器类型。

*   **`esolver_type`**: 设置为 `sdft`。
    *   这是开启随机波函数求解器的总开关。一旦设置，ABACUS 将不再进行常规的 KS 轨道对角化。

---

## 4.2 SDFT 计算参数详解：态密度 (DOS)

与标准 KS-DFT 一样，SDFT 计算 DOS 也必须遵循**“两步法”**原则：
1.  **第一步 (SCF)**：进行自洽计算，获得收敛的电荷密度。
2.  **第二步 (Post-processing)**：读取电荷密度，计算 DOS。

### 关键参数配置

在 SDFT 模式下，DOS 的计算方式与标准 DFT（`calculation = nscf`）有所不同，它依赖于切比雪夫展开。

#### 1. 开启后处理模式
*   **`method_sto`**: 设置为 `2`。
    *   `1`: 进行正常的 SCF 迭代或动力学模拟（默认）。
    *   `2`: **DOS 计算模式**（仅在 SDFT 下有效）。

#### 2. 切比雪夫展开精度
*   **`dos_nche`**: 切比雪夫多项式的展开阶数。
    *   **物理含义**：SDFT 不直接求解本征值，而是通过多项式展开来重构态密度。阶数越高，能量分辨率越高，曲线越精细，但计算成本线性增加。
    *   **推荐值**：通常在 `1000` 到 `4000` 之间。对于需要分辨精细峰值结构的体系，建议使用较高的值（如 2000+）。

#### 3. 能量窗口与展宽
*   **`dos_emin_ev`** / **`dos_emax_ev`**: DOS 计算的能量范围（单位：eV）。
*   **`dos_sigma`**: 高斯展宽因子。在 SDFT 中，这个参数用于平滑随机噪声。

### 实战：SDFT DOS 计算的 INPUT 示例

假设你已经完成了第一步 SCF 计算（生成了 `SPIN*_CHG` 文件），下面是第二步计算 DOS 的 `INPUT` 文件示例：

```bash
INPUT_PARAMETERS
# 基础参数
suffix              sdft_dos_run
ntype               1
ecutwfc             50     # 这里的截断能应与 SCF 一致

# SDFT 核心设置
esolver_type        sdft   # 启用随机波函数求解器
method_sto          2      # 模式 2：计算 DOS
nbands_sto          128    # 随机波函数数量（根据体系大小调整）

# DOS 具体参数
dos_nche            2000   # 切比雪夫展开阶数，决定分辨率
dos_emin_ev         -10    # 能量下限
dos_emax_ev         20     # 能量上限
dos_sigma           0.1    # 展宽因子

# 读取电荷密度
scf_nmax            0      # 不进行 SCF 迭代
init_chg            file   # 从文件读取电荷密度
```

---

## 4.3 内存控制与性能优化

SDFT 虽然避免了对角化，但处理大体系时，存储随机波函数和哈密顿量操作仍可能消耗大量内存。ABACUS 提供了专门的参数来优化这一过程。

### 内存分块控制
*   **`npart_sto`**: 随机波函数的分块数（默认为 1）。
    *   **作用**：将总的随机波函数（`nbands_sto`）分成 `npart_sto` 个部分依次进行计算。
    *   **原理**：
        *   如果 `nbands_sto = 128` 且 `npart_sto = 4`，程序每次只在内存中处理 32 个随机波函数。
        *   计算完成后，释放内存并处理下一批。
    *   **权衡**：
        *   **增大 `npart_sto`**：显著**降低内存峰值**，防止内存溢出 (OOM)。
        *   **代价**：可能会略微增加 I/O 开销或通信时间，但在内存受限的节点上是救命稻草。

---

## 附录：常见问题与避坑指南

### 1. 内存溢出 (OOM) 的急救方案
在跑几千个原子的大体系时，如果遇到 `Out of Memory` 错误，请按以下顺序排查：
1.  **增加 `npart_sto`**：这是最直接的方法。尝试设置为 4、8 甚至更高。
2.  **检查 `nbands_sto`**：随机波函数数量是否过多？通常 `nbands_sto` 需要足够大以收敛误差，但过大则浪费资源。

### 2. 能量窗口截断风险
设置 `dos_emin_ev` 和 `dos_emax_ev` 时要格外小心：
*   **风险**：如果窗口太窄，可能会丢失深层能级或高能激发态的信息。
*   **建议**：先参考标准 DFT 的结果或文献值，预留足够的缓冲区域（Buffer）。

### 3. 展宽因子与分辨率陷阱
*   **`dos_sigma` 过大**：特征峰被抹平，物理细节丢失。
*   **`dos_sigma` 过小**：SDFT 特有的随机噪声（Stochastic Noise）会非常明显，导致 DOS 曲线呈现剧烈的锯齿状震荡。
*   **调试技巧**：SDFT 的 DOS 曲线通常不如标准 KS-DFT 光滑，这是算法特性决定的。适当增加 `nbands_sto` 可以抑制噪声。

### 4. 严守“两步法”原则
**切记**：不要试图在一个输入文件中同时做 SCF 收敛和 DOS 计算。
*   直接跑 DOS（`method_sto=2`）而不读取收敛的电荷密度（`init_chg=file`），得到的结果是基于初始猜测电荷的，**完全没有物理意义**。

### 5. 锦囊妙计：如何验证 DOS 的合理性？
当你得到 DOS 曲线后，如何判断它是否正确？
*   **范霍夫奇点 (Van Hove Singularity)**：观察 DOS 的尖峰。物理上，DOS 的峰值通常对应能带结构中的**平坦区**（Flat Bands）。
*   **物理图像**：能带越平，电子的有效质量越大，态密度越集中。如果你在 DOS 中看到了预期的峰值，说明计算捕捉到了正确的电子结构特征。

### 6. 关于 K 点的特别提示
虽然 SDFT 常用于大体系（通常只用 Gamma 点），但如果你处理的是中等体系并使用了 K 点采样：
*   在计算 DOS 时，为了获得平滑的曲线，通常需要比 SCF 计算使用**更密集的 K 点网格**。
*   在 `KPT` 文件中增加 K 点密度，可以显著改善 DOS 的质量。

---

## 附录：进阶学习指南

恭喜你完成了本书的核心章节！科学计算的学习永无止境，以下是我们为你准备的进阶建议，鼓励你继续在计算材料学的领域深耕。

### 1. 扩展学习建议
- **投影态密度 (PDOS)**：在本教程 TDOS 的基础上，尝试学习如何将总态密度分解到具体的原子轨道（如 s, p, d 轨道），这将帮助你更深入地分析化学键合性质。可参考 `config_pdos.json` 相关工具的使用。
- **结构优化 (Relaxation)**：本教程假设你已拥有稳定的结构。但在实际科研中，第一步通常是结构弛豫。建议学习 `calculation` 设置为 `relax` 或 `cell-relax` 的相关参数。
- **能带结构计算**：态密度是能量维度的积分，而能带结构是动量空间的展开。建议尝试使用 Atomkit 工具配合 ABACUS 绘制高对称路径的能带图。

### 2. 通用调试建议 (Troubleshooting)
- **SCF 不收敛**：首先检查 `STRU` 文件中的原子间距是否合理，其次尝试调整 `mixing_type` 或减小 `mixing_beta` 值。
- **结果不靠谱**：检查 `KPT` 点的密度是否足够，以及 `INPUT` 文件中 `ecutwfc`（截断能）是否经过了收敛性测试。
- **内存溢出 (OOM)**：对于大体系，优先考虑使用 LCAO 基组或开启 SDFT 模式，并合理分配 MPI 进程数。

### 3. 官方资源链接
- **ABACUS 官方文档**：[https://abacus.deepmodeling.com/](https://abacus.deepmodeling.com/)（权威的参数字典与教程）
- **GitHub 仓库**：[https://github.com/abacusmodeling/abacus-develop](https://github.com/abacusmodeling/abacus-develop)（反馈 Bug 与获取最新功能）
- **DeepModeling 社区**：参与讨论，与全球计算材料学专家共同进步。

保持好奇，享受模拟物理世界的乐趣！
