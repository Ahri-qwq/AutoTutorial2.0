# 第四章：进阶方法：随机波函数 DFT (SDFT)

在前面的章节中，我们已经掌握了基于标准 Kohn-Sham DFT (KS-DFT) 的计算流程。然而，当我们面对**温稠密物质 (Warm Dense Matter, WDM)** 或者**包含数千个原子的超大体系**时，传统的 KS-DFT 往往会遇到瓶颈。

本章将介绍 ABACUS 的独门绝技——**随机波函数 DFT (Stochastic DFT, SDFT)**。这是一种专门应对高温和大规模体系的高级算法，能够以极高的效率计算态密度 (DOS) 和其他物理性质。

> **⚠️ 核心概念区分**：
> *   **标准 KS-DFT**：基于确定性的平面波或原子轨道基组，通过对角化哈密顿量求解。适用于常规体系（基态、低湿）。
> *   **SDFT**：基于随机波函数（Stochastic Orbitals），利用切比雪夫（Chebyshev）多项式展开来逼近费米-狄拉克算符，避免了昂贵的矩阵对角化。适用于**高温**（T > 10,000 K）或**超大体系**。

---

## 4.1 SDFT 适用场景与原理

### 为什么需要 SDFT？
在高温条件下（例如 $T > 1 \text{ eV} \approx 11605 \text{ K}$），电子会被激发到非常高的能级。为了保证计算精度，KS-DFT 需要包含极其庞大的能带数量（Bands），这会导致计算量呈立方级（$O(N^3)$）甚至指数级增长，且内存消耗巨大。

SDFT 通过引入随机向量（Stochastic Orbitals）来表示电子态，其计算复杂度主要取决于体系的尺寸，而对温度不敏感。这使得它成为模拟行星内核、激光聚变等极端条件的理想工具。

### 核心参数设置
要启用 SDFT，必须在 `INPUT` 文件中修改求解器类型。

*   **`esolver_type`**: 设置为 `sdft`。
    *   这是开启随机波函数求解器的总开关。一旦设置，ABACUS 将不再进行常规的 KS 轨道对角化。

---

## 4.2 SDFT 计算参数详解：态密度 (DOS)

与标准 KS-DFT 一样，SDFT 计算 DOS 也必须遵循**“两步法”**原则：
1.  **第一步 (SCF)**：进行自洽计算，获得收敛的电荷密度。
2.  **第二步 (Post-processing)**：读取电荷密度，计算 DOS。

### 关键参数配置

在 SDFT 模式下，DOS 的计算方式与标准 DFT（`calculation = nscf`）有所不同，它依赖于切比雪夫展开。

#### 1. 开启后处理模式
*   **`method_sto`**: 设置为 `2`。
    *   `1`: 进行正常的 SCF 迭代或动力学模拟（默认）。
    *   `2`: **DOS 计算模式**（仅在 SDFT 下有效）。

#### 2. 切比雪夫展开精度
*   **`dos_nche`**: 切比雪夫多项式的展开阶数。
    *   **物理含义**：SDFT 不直接求解本征值，而是通过多项式展开来重构态密度。阶数越高，能量分辨率越高，曲线越精细，但计算成本线性增加。
    *   **推荐值**：通常在 `1000` 到 `4000` 之间。对于需要分辨精细峰值结构的体系，建议使用较高的值（如 2000+）。

#### 3. 能量窗口与展宽
*   **`dos_emin_ev`** / **`dos_emax_ev`**: DOS 计算的能量范围（单位：eV）。
*   **`dos_sigma`**: 高斯展宽因子。在 SDFT 中，这个参数用于平滑随机噪声。

### 实战：SDFT DOS 计算的 INPUT 示例

假设你已经完成了第一步 SCF 计算（生成了 `SPIN*_CHG` 文件），下面是第二步计算 DOS 的 `INPUT` 文件示例：

```bash
INPUT_PARAMETERS
# 基础参数
suffix              sdft_dos_run
ntype               1
ecutwfc             50     # 这里的截断能应与 SCF 一致

# SDFT 核心设置
esolver_type        sdft   # 启用随机波函数求解器
method_sto          2      # 模式 2：计算 DOS
nbands_sto          128    # 随机波函数数量（根据体系大小调整）

# DOS 具体参数
dos_nche            2000   # 切比雪夫展开阶数，决定分辨率
dos_emin_ev         -10    # 能量下限
dos_emax_ev         20     # 能量上限
dos_sigma           0.1    # 展宽因子

# 读取电荷密度
scf_nmax            0      # 不进行 SCF 迭代
init_chg            file   # 从文件读取电荷密度
```

---

## 4.3 内存控制与性能优化

SDFT 虽然避免了对角化，但处理大体系时，存储随机波函数和哈密顿量操作仍可能消耗大量内存。ABACUS 提供了专门的参数来优化这一过程。

### 内存分块控制
*   **`npart_sto`**: 随机波函数的分块数（默认为 1）。
    *   **作用**：将总的随机波函数（`nbands_sto`）分成 `npart_sto` 个部分依次进行计算。
    *   **原理**：
        *   如果 `nbands_sto = 128` 且 `npart_sto = 4`，程序每次只在内存中处理 32 个随机波函数。
        *   计算完成后，释放内存并处理下一批。
    *   **权衡**：
        *   **增大 `npart_sto`**：显著**降低内存峰值**，防止内存溢出 (OOM)。
        *   **代价**：可能会略微增加 I/O 开销或通信时间，但在内存受限的节点上是救命稻草。

---

## 附录：常见问题与避坑指南

### 1. 内存溢出 (OOM) 的急救方案
在跑几千个原子的大体系时，如果遇到 `Out of Memory` 错误，请按以下顺序排查：
1.  **增加 `npart_sto`**：这是最直接的方法。尝试设置为 4、8 甚至更高。
2.  **检查 `nbands_sto`**：随机波函数数量是否过多？通常 `nbands_sto` 需要足够大以收敛误差，但过大则浪费资源。

### 2. 能量窗口截断风险
设置 `dos_emin_ev` 和 `dos_emax_ev` 时要格外小心：
*   **风险**：如果窗口太窄，可能会丢失深层能级或高能激发态的信息。
*   **建议**：先参考标准 DFT 的结果或文献值，预留足够的缓冲区域（Buffer）。

### 3. 展宽因子与分辨率陷阱
*   **`dos_sigma` 过大**：特征峰被抹平，物理细节丢失。
*   **`dos_sigma` 过小**：SDFT 特有的随机噪声（Stochastic Noise）会非常明显，导致 DOS 曲线呈现剧烈的锯齿状震荡。
*   **调试技巧**：SDFT 的 DOS 曲线通常不如标准 KS-DFT 光滑，这是算法特性决定的。适当增加 `nbands_sto` 可以抑制噪声。

### 4. 严守“两步法”原则
**切记**：不要试图在一个输入文件中同时做 SCF 收敛和 DOS 计算。
*   直接跑 DOS（`method_sto=2`）而不读取收敛的电荷密度（`init_chg=file`），得到的结果是基于初始猜测电荷的，**完全没有物理意义**。

### 5. 锦囊妙计：如何验证 DOS 的合理性？
当你得到 DOS 曲线后，如何判断它是否正确？
*   **范霍夫奇点 (Van Hove Singularity)**：观察 DOS 的尖峰。物理上，DOS 的峰值通常对应能带结构中的**平坦区**（Flat Bands）。
*   **物理图像**：能带越平，电子的有效质量越大，态密度越集中。如果你在 DOS 中看到了预期的峰值，说明计算捕捉到了正确的电子结构特征。

### 6. 关于 K 点的特别提示
虽然 SDFT 常用于大体系（通常只用 Gamma 点），但如果你处理的是中等体系并使用了 K 点采样：
*   在计算 DOS 时，为了获得平滑的曲线，通常需要比 SCF 计算使用**更密集的 K 点网格**。
*   在 `KPT` 文件中增加 K 点密度，可以显著改善 DOS 的质量。