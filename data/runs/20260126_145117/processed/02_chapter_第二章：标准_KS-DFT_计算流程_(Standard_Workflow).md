# 第二章：标准 KS-DFT 计算流程 (Standard Workflow)

在掌握了 ABACUS 的输入文件结构后，我们将进入最核心的实战环节。对于绝大多数材料模拟任务（如能带结构、态密度 DOS、光学性质等），我们都遵循一套标准的“两步走”或“三步走”策略。

本章将详细拆解 **标准 KS-DFT（Kohn-Sham Density Functional Theory）** 的计算流程。

> **⚠️ 核心提示：区分 KS-DFT 与 SDFT**
> ABACUS 提供了两种截然不同的计算路径：
> 1.  **标准 KS-DFT**：基于平面波（PW）或原子轨道（LCAO）基组，适用于绝大多数常规材料计算（本章重点）。
> 2.  **随机 DFT (SDFT/MDFT)**：基于随机波函数（Stochastic orbitals），主要用于极端高温或超大体系（参数如 `method_sto` 等），这属于高级功能，**不适用**于本章流程。请勿混淆两者的参数设置。

---

## 2.1 流程概览与结构准备

一个完整的电子结构分析通常包含三个阶段。请务必养成良好的文件管理习惯，建议为每个步骤建立独立的文件夹：

1.  **结构弛豫 (Relaxation)**：
    *   **目的**：获得能量最低的稳定几何结构。
    *   **文件夹示例**：`00_relax/`
    *   **注意**：所有的电子性质计算（DOS, Band）都必须基于受力收敛（Force converged）的结构，否则结果没有物理意义。
2.  **自洽计算 (SCF)**：
    *   **目的**：求解 Kohn-Sham 方程，获得收敛的基态电子密度（Charge Density）和波函数。
    *   **文件夹示例**：`01_scf/`
3.  **非自洽计算 (NSCF)**：
    *   **目的**：读取 SCF 产生的电子密度（固定势场），在更密的 K 点网格上计算特征值，用于输出 DOS 或能带。
    *   **文件夹示例**：`02_nscf_dos/`

**本章假设您已经完成了第一步（结构弛豫），我们将重点讲解从 SCF 到 NSCF 的关键操作。**

---

## 2.2 第一步：自洽计算 (SCF)

DOS 计算的质量直接取决于电荷密度的质量。因此，我们需要先运行一个高精度的 SCF 计算。

### 2.2.1 关键参数设置
在 `01_scf` 文件夹中，修改 `INPUT` 文件：

```bash
INPUT_PARAMETERS
# 1. General
suffix          scf_run      # 输出文件夹后缀
calculation     scf          # 核心参数：设置为自洽计算模式
basis_type      lcao         # 或 pw，根据你的基组选择

# 2. Iteration (Convergence)
scf_nmax        100          # 最大迭代步数
scf_thr         1.0e-7       # 收敛精度。DOS计算建议设为 1e-6 或更高
```

### 2.2.2 K 点设置 (`KPT` 文件)
SCF 步骤的 K 点网格只需保证总能收敛即可。
```text
K_POINTS
0
Gamma
4 4 4 0 0 0
```

### 2.2.3 运行与检查
运行 ABACUS 后，检查 `OUT.scf_run/running_scf.log`，确保看到 `Convergence Achieved`。
**关键产物**：计算结束后，在输出目录中会生成电荷密度文件（通常位于 `OUT.scf_run/SPIN1_CHG.cube` 或类似二进制文件，取决于版本和设置）。这是下一步的“种子”。

---

## 2.3 第二步：非自洽计算 (NSCF) 设置

这是初学者最容易出错的步骤。我们需要做的是：**“只算能级，不更新电荷”**。

### 2.3.1 准备工作
1.  创建文件夹 `02_nscf_dos/`。
2.  将 `01_scf/` 中的 `STRU` (结构文件) 和 `*.upf` (赝势文件) 复制过来。
3.  **传递电荷密度**：这是最关键的一步。
    *   将 `01_scf/OUT.scf_run` 文件夹中的电荷密度文件复制到 `02_nscf_dos/` 中（或者在 INPUT 中指定路径）。
    *   *注：ABACUS 新版通常会自动寻找或通过参数指定，建议查阅当前版本的 `init_chg` 说明。*

### 2.3.2 修改 `INPUT` 文件
在 `02_nscf_dos/INPUT` 中，我们需要告诉 ABACUS 进入 NSCF 模式并读取电荷：

```bash
INPUT_PARAMETERS
# 1. General
suffix          nscf_dos
calculation     nscf         # 核心参数：设置为非自洽计算
basis_type      lcao         # 保持与 SCF 一致

# 2. Charge Density Reading
init_chg        file         # 核心参数：从文件读取电荷密度，而不是从原子叠加开始
                             # 确保程序能找到上一步生成的电荷密度文件

# 3. Precision
# 即使是 NSCF，对角化精度也很重要
scf_thr         1.0e-7       
```

> **专家点拨**：
> 为什么要分两步？
> 如果直接在 DOS 计算中进行 SCF 迭代，为了获得平滑曲线，你往往需要极密的 K 点（如 20x20x20）。在如此密的 K 点下做 SCF 迭代（反复求解）极其昂贵且难以收敛。
> **两步法策略**：在稀疏 K 点（如 4x4x4）下快速收敛电荷密度 -> 固定电荷密度 -> 在密 K 点下仅做一次对角化（NSCF）。这是 DFT 计算的标准范式。

---

## 2.4 DOS 核心参数配置

在 `02_nscf_dos/INPUT` 文件中，还需要添加专门控制 DOS 输出的参数：

```bash
# ... (接上文 INPUT 内容)

# 4. DOS Parameters
out_dos         1            # 开启 DOS 输出开关
dos_emin_ev     -10.0        # DOS 能量窗口下限 (相对于费米能级或真空能，视版本而定)
dos_emax_ev     10.0         # DOS 能量窗口上限
dos_edelta_ev   0.01         # 能量间隔（分辨率）
dos_sigma       0.05         # 高斯展宽因子 (eV)
```

### 参数详解：
*   **`out_dos`**: 必须设为 1，否则程序跑完 NSCF 就结束了，不会生成 DOS 文件。
*   **`dos_emin_ev` / `dos_emax_ev`**:
    *   不要设置得过大（如 -100 到 100），这会生成巨大的无用文件。
    *   通常覆盖价带顶以下 10 eV 到导带底以上 10 eV 即可。
*   **`dos_edelta_ev`**:
    *   决定了 DOS 曲线的数据点密度。
    *   **推荐值**：`0.01` eV。如果太小（如 0.001），文件过大且无必要；如果太大（如 0.1），峰形会变成折线。

---

## 2.5 K 点网格与展宽设置

在 NSCF 计算中，`KPT` 文件的设置与 SCF 截然不同。

### 2.5.1 加密 K 点网格
为了得到平滑、连续的 DOS 曲线，我们需要采样布里渊区中更多的点。
修改 `02_nscf_dos/KPT`：

```text
K_POINTS
0
Gamma
12 12 12 0 0 0   # 注意：比 SCF 的 4x4x4 密得多
```

*   **经验法则**：对于半导体和绝缘体，K 点可以适度稀疏；对于**金属**体系，必须使用非常密的 K 点网格，否则费米面附近的 DOS 会出现剧烈的数值震荡。

### 2.5.2 高斯展宽 (`dos_sigma`)
由于我们是用有限的 K 点来模拟无限晶体，离散的能级需要通过数学方法“展宽”成连续曲线。

*   **`dos_sigma` 的物理意义**：
    *   它类似于实验测量中的仪器分辨率。
    *   **过小**：DOS 曲线会出现许多非物理的尖刺（数值噪声）。
    *   **过大**：特征峰被抹平，带隙看起来比实际要小，细节丢失。
    *   **推荐范围**：`0.05` eV ~ `0.2` eV。

> **锦囊妙计：物理图像验证**
> 当你得到 DOS 结果后，如何判断峰值是否合理？
> 请回忆固体物理中的 **范霍夫奇点 (Van Hove Singularities)**。DOS 的尖锐峰值通常对应于能带结构（Band Structure）中的**平坦能带（Flat Bands）**区域。
> *   如果你在 DOS 中看到一个极高的峰，去检查能带图，对应的能量位置应该有一条几乎水平的能带。
> *   这不仅是验证计算结果的手段，也是理解材料局域电子态（如 d 轨道或 f 轨道电子）的关键视角。

---

### 总结：标准 DOS 计算清单

1.  **Relax**: 结构优化（确保受力 < 0.01 eV/Å）。
2.  **SCF**: `calculation = scf`, 稀疏 K 点 (e.g., 4x4x4)，生成电荷密度。
3.  **NSCF**:
    *   `calculation = nscf`
    *   `init_chg = file` (读取上一步电荷)
    *   `out_dos = 1`
    *   加密 K 点 (e.g., 12x12x12)
    *   设置合理的 `dos_sigma` (0.05-0.1 eV)

运行完成后，在输出目录中寻找 `TDOS` (总态密度) 和 `PDOS` (分波态密度) 文件进行绘图分析。