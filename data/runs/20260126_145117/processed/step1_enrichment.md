根据提供的知识库资料，以下是关于 **态密度 (DOS/PDOS) 计算与轨道分析** 的结构化元数据报告。

---

# ABACUS Metadata: 态密度 (DOS/PDOS) 计算

## 1. 物理本质 (Physics Concepts)
- **核心概念**: 
    - **DOS (Density of States)**: 描述在能量 $E$ 附近单位能量范围内可供电子占据的量子态数目。它是能带结构在能量空间的积分。
    - **PDOS (Projected Density of States)**: 将波函数投影到每个原子的不同轨道上，用于分析特定原子轨道（如 s, p, d 轨道）对总态密度的贡献。
    - **范霍夫奇点 (Van Hove Singularities)**: DOS 的峰值通常对应能带结构中电子浓度变化剧烈的位置。
- **科学问题**:
    - **金属性质判定**: 通过费米能级处的 DOS 值判断材料是金属（高 DOS）、半导体（低 DOS/有带隙）还是绝缘体（大带隙）。
    - **成键分析**: 通过 PDOS 分析原子间的成键轨道贡献。
    - **电学性质**: 费米面附近的 DOS 行为直接影响电导率。

## 2. 关键输入参数 (Key Parameters)

### 2.1 必须设置的参数 (INPUT 文件)
以下参数主要基于资料3和资料7整理，适用于控制 DOS 输出细节：

- **`out_dos`**
    - **值**: `1`
    - **物理意义**: 打开态密度计算功能的开关。如果不设置为 1，将不会输出 DOS 文件。
- **`dos_emin_ev`**
    - **推荐值**: 根据体系能带范围设定（例如 `-10` 或 `-20`）。
    - **物理意义**: 态密度计算的能量窗口下限（单位：eV）。
- **`dos_emax_ev`**
    - **推荐值**: 根据体系能带范围设定（例如 `20` 或 `100`）。
    - **物理意义**: 态密度计算的能量窗口上限（单位：eV）。
- **`dos_edelta_ev`**
    - **推荐值**: `0.01` - `0.1` (资料示例中为 `0.1`)。
    - **物理意义**: 控制输出 DOS 时的能量间隔（分辨率），单位 eV。
- **`dos_sigma`**
    - **推荐值**: `0.05` - `0.2` (资料3示例中为 `4`，资料7示例中为 `0.6`，需根据具体体系展宽需求调整)。
    - **物理意义**: 态密度的高斯展宽因子（Gaussian smearing width），单位 eV。

### 2.2 随机波函数 DFT (SDFT) 特有参数
如果使用随机波函数方法计算 DOS（参考资料 3, 7, 8）：
- **`esolver_type`**: 设置为 `sdft`。
- **`method_sto`**: 设置为 `2` (用于运行 SDFT 后处理计算 DOS)。
- **`dos_nche`**: 计算态密度时的切比雪夫（Chebyshev）展开阶数（默认 100，资料示例 120 或 240）。
- **`npart_sto`**: 内存控制参数，用于将内存使用量降为正常的 `1/npart_sto`。

### 2.3 【重要】知识缺口处理 (Knowledge Gaps)
- **电荷密度读取参数**: 
    - 标准流程（资料2, 4, 5）明确指出 DOS 计算通常分为两步：SCF（自洽）-> NSCF（非自洽）。
    - 在 NSCF 步骤中，必须读取上一步 SCF 生成的电荷密度。
    - **缺失信息**: 资料中未明确列出控制“读取电荷密度”的具体参数名（通常是 `init_chg` 或类似参数）。
    - **处理建议**: 撰写教程时，请提示读者“需在 INPUT 文件中配置读取电荷密度的参数（请查阅官网文档确认具体参数名，如 `init_chg`）”，或者仅描述操作逻辑“读入上一步的电子密度”。不要臆造参数名。
- **PDOS 投影半径/轨道定义**: 
    - 资料提及 PDOS 是投影到原子轨道，但未列出是否需要指定投影半径（如 VASP 的 `RWIGS`）或具体的轨道定义文件格式。需提醒读者注意使用的基组或赝势对 PDOS 的影响。

## 3. 体系与接口配置 (System & Interfaces)

- **计算流程 (Workflow)**:
    1.  **结构弛豫 (Relaxation)**: 获得稳定晶体结构。
    2.  **自洽计算 (SCF)**: 输出收敛的基态电子密度（资料4示例：`INPUT-scf`）。
    3.  **非自洽计算 (NSCF/DOS)**: 读取电子密度，固定密度，使用更密的 K 点或特定能量网格计算 DOS（资料4示例：`INPUT-nscf`）。
- **文件操作**:
    - 准备两套 INPUT 和 KPT 文件（`INPUT-scf`/`KPT-scf` 和 `INPUT-nscf`/`KPT-nscf`）。
    - 资料4和5展示了通过 `cp` 命令切换输入文件并连续运行 `abacus` 的脚本化操作。
- **输出文件**:
    - 结果保存在 `OUT` 文件夹中。
    - 包含总 DOS 和分波 PDOS 数据。
- **外部接口**:
    - **Bohrium/ABACUS-Agent-tools**: 提供了 `abacus_dos_run` 函数，可自动处理并返回 DOS/PDOS 图片（资料1）。
    - **Atomkit**: 资料标题提及 "ABACUS+Atomkit"，暗示 Atomkit 可能用于后处理或绘图，但具体操作细节资料中较少。

## 4. 教程编写特殊指令 (Special Instructions for Writer)

- **Critical: 区分标准 DFT 与 SDFT**:
    - 资料同时提供了基于平面波/原子轨道的标准 KS-DFT 流程（资料2, 4, 5）和基于随机波函数（SDFT）的 DOS 计算流程（资料3, 7, 8）。
    - **指令**: 教程必须明确区分这两种路径。初学者通常使用标准 KS-DFT（SCF+NSCF）流程。SDFT 是高级功能，适用于大体系或高温条件。不要混淆两者的参数（例如 `method_sto` 仅用于 SDFT）。
- **Critical: 强调两步法**:
    - 必须强调 DOS 计算通常不是一次性完成的。必须先跑 SCF 得到准确的电荷密度，再跑 NSCF（或 Non-SCF）计算 DOS。直接跑 DOS 而没有收敛的电荷密度会导致结果错误。
- **K点设置提示**:
    - 提醒读者：在 NSCF 计算 DOS 时，通常需要比 SCF 计算使用更密的 K 点网格（资料2提及“选取想要计算的能级和 K 点”），以获得更平滑的曲线。
- **锦囊妙计**:
    - 引用资料2中的物理图像：解释 DOS 峰值与能带平坦区（范霍夫奇点）的对应关系，帮助用户验证结果的合理性。

## 5. 常见报错与注意事项 (Pitfalls)

- **内存溢出 (OOM)**:
    - 在使用 SDFT 方法计算 DOS 时，资料3特别提到 `npart_sto` 参数，用于防止内存不够导致无法计算。
- **能量范围截断**:
    - 如果 `dos_emin_ev` 和 `dos_emax_ev` 设置过窄，可能会丢失深能级或高能级的重要信息。
- **费米能级对齐**:
    - 资料2提示：分析时通常将费米能级设为 0 点。原始输出数据中的能量通常是相对于真空能级或平均静电势的，用户绘图时需要手动减去费米能级（Fermi energy）。
- **展宽因子 (Smearing) 选择**:
    - `dos_sigma` 过大会导致特征峰模糊，过小会导致曲线充满噪声（尤其是在 K 点不足时）。需根据 K 点密度和物理需求权衡。