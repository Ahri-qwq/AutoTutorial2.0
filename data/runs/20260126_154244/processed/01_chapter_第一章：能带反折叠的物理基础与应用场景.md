# 第一章：能带反折叠的物理基础与应用场景

欢迎来到《ABACUS 实战教程》。在开始敲击键盘运行代码之前，作为开发者，我必须先带你理解“能带反折叠”（Band Unfolding）背后的物理图像。很多初学者能够跑通流程，但往往因为对物理概念理解偏差，导致 `m_matrix` 设置错误或对结果图产生误读。

此外，本章还将明确 ABACUS 配合 PYATB 进行反折叠计算的**标准工作流规范**。遵守这些规范将为你节省大量的排错时间。

---

## 1.1 超胞计算与能带折叠困境

### 为什么我们需要超胞（Supercell）？
在计算材料学中，我们经常需要处理破坏了完美晶体平移对称性的体系，例如：
- **掺杂（Doping）**：在硅中掺杂磷原子。
- **缺陷（Defects）**：空位或间隙原子。
- **合金（Alloys）**：如 SiGe 随机合金。
- **表面与界面**：为了模拟表面重构。

为了在周期性边界条件（Bloch 定理）下处理这些问题，我们通常构建**超胞（Supercell）**。即把 $N \times N \times N$ 个原胞（Primitive Cell, PC）拼成一个大盒子，然后在其中引入杂质或缺陷。

### 什么是能带折叠（Band Folding）？
根据固体物理的基本原理，实空间晶格矢量变大，倒空间布里渊区（Brillouin Zone, BZ）就会相应变小。
- **实空间**：超胞体积是原胞的 $M$ 倍（$V_{SC} = M \times V_{PC}$）。
- **倒空间**：超胞布里渊区体积是原胞的 $1/M$。

这就导致了一个严重的后果：**能带折叠**。
原胞中原本舒展清晰的能带，被迫“折叠”进了超胞那个极小的布里渊区内。这就好比把一张原本画在 A4 纸上的图，折叠了无数次塞进了一个火柴盒里。结果就是能带图变得极度密集、杂乱无章（Spaghetti bands），原本清晰的物理特征（如带隙性质、有效质量、能谷位置）完全无法辨认。

更重要的是，实验手段（如角分辨光电子能谱 **ARPES**）测量的是基于材料**有效原胞**的电子结构。如果我们直接拿超胞的一团乱麻的能带去和 ARPES 对比，是完全对不上号的。

---

## 1.2 反折叠（Unfolding）原理简介

为了解决上述问题，我们需要一种数学手段，将折叠进超胞布里渊区的波函数，“投影”回原胞的布里渊区。这就是**能带反折叠**。

### 核心思想：谱权重（Spectral Weight）
在超胞计算中，我们得到的本征态 $|\Psi_{KN}\rangle$（$K$ 为超胞 k 点，$N$ 为能带索引）虽然是超胞的本征态，但它依然包含了原胞的物理信息。

反折叠的核心思想是：将超胞的波函数 $|\Psi_{KN}\rangle$，用原胞的一组完备的布洛赫波函数 $|\psi_{kn}\rangle$（$k$ 为原胞 k 点，$n$ 为能带索引）进行展开。

我们需要计算一个物理量：**谱权重 $W_{Kn}(k)$**。
$$ P_{KN}(k) = \sum_{n} | \langle \psi_{kn} | \Psi_{KN} \rangle |^2 $$

这个权重的物理意义非常直观：**它代表了超胞的第 $N$ 条能带在 $K$ 点的量子态中，有多少成分是来自于原胞的 $k$ 点的。**

### 结果呈现：有效能带结构（EBS）
经过反折叠处理后，我们不再画单一的线条，而是画带有“深浅”或“粗细”的能带图：
- **权重高**：表示该能带保持了较好的原胞对称性（如未受杂质干扰的深层能级），在图中显示为深色/粗线。
- **权重低**：表示该能带被杂质散射严重，平移对称性破坏较大，在图中显示为浅色/模糊。
- **消失**：如果某处权重为零，说明该能带被完全破坏（如带隙中的杂质态）。

这与 ARPES 实验得到的谱函数强度图是直接对应的。

---

## 1.3 关键工作流规范（开发者建议）

在进入下一章的实操前，作为 ABACUS 和 PYATB 的使用者，你必须遵守以下**工程规范**。这是无数用户踩坑后总结出的血泪经验。

### 1. 环境配置警告
> **Warning**: PYATB 依赖特定的数学库（Eigen, MKL）和 Python 环境（mpi4py, pybind11）。环境搭建极易出错。

*   **推荐方案**：请务必使用官方验证过的镜像 `abacus:3.2.3`。
*   **原因**：不同版本的 GCC 和 Python 库极易导致 PYATB 编译失败或运行时出现 `undefined symbol` 错误。

### 2. 目录结构分离（Critical）
**绝对不要**在同一个文件夹下同时运行 ABACUS 的自洽计算（SCF）和 PYATB 的反折叠计算。

*   **ABACUS 输入文件**：名为 `INPUT` (全大写)。
*   **PYATB 输入文件**：名为 `Input` (首字母大写)。
*   **风险**：在不区分大小写的文件系统（如某些配置下的 macOS 或 Windows 挂载卷）中，或者当你手误使用 `rm` 命令时，这两个文件极易混淆或覆盖。

**推荐目录结构**：
```text
Work_Dir/
├── abacus_scf/       <-- 运行 ABACUS 自洽计算
│   ├── INPUT
│   ├── STRU
│   ├── KPT
│   └── ...
└── pyatb_run/        <-- 运行 PYATB 后处理
    ├── Input         <-- PYATB 的输入文件
    ├── STRU          <-- 必须与 abacus_scf 中完全一致
    ├── *.csr         <-- 从 abacus_scf 拷贝过来的稀疏矩阵文件
    └── ...
```

### 3. 必须手动获取费米能级（Manual Breakpoint）
这是全流程中唯一无法自动化的“断点”。
PYATB 需要知道体系的费米能级（Fermi Energy）来确定能量零点，但它目前**不会**自动去读取 ABACUS 的日志文件。

*   **操作**：自洽计算结束后，你必须执行：
    ```bash
    grep "EFERMI" OUT.suffix/running_scf.log
    ```
*   **动作**：将获取的数值（例如 `11.0829 eV`）**手动复制粘贴**到 PYATB 的 `Input` 文件中的 `fermi_energy` 字段。
*   **后果**：如果这一步填错或没填，画出来的能带图能量零点会偏移，导致费米面位置错误，所有物理分析将毫无意义。

### 4. 理解扩胞矩阵（m_matrix）
在 PYATB 的 `Input` 文件中，有一个参数叫 `m_matrix`。这**不是**随便抄一个案例就能用的。
它描述了**超胞晶格矢量**与**原胞晶格矢量**的变换关系：
$$ \vec{A}_{super} = M \times \vec{A}_{prim} $$

*   **案例**：如果你做的是 $2 \times 2 \times 2$ 的扩胞：
    ```text
    m_matrix  2 0 0  0 2 0  0 0 2
    ```
*   **注意**：如果你做的是 $3 \times 3 \times 1$ 的表面板层计算，矩阵必须相应修改为：
    ```text
    m_matrix  3 0 0  0 3 0  0 0 1
    ```
    *请务必根据你的实际 `STRU` 结构来设置此参数！*

### 5. 绘图脚本的微调
PYATB 运行结束后会生成一个 `plot_unfold.py` 脚本。
*   **默认行为**：它通常预设了一个较小的能量窗口（如 `[-4, 6]` eV）。
*   **操作**：你通常需要打开该 Python 脚本，找到 `energy_range` 变量，将其修改为你关心的范围（例如包含深层价带的 `[-14, 12]`），否则生成的 PDF 图中能带可能会被截断。

---

准备好了吗？理解了物理图像并记住了这些“避坑指南”后，请进入第二章，我们将开始实战操作。