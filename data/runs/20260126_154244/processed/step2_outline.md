<!-- META_START -->
# ABACUS 实战教程：基于 pyatb 的能带反折叠流程详解

## 前言
- **本书逻辑**: 本教程遵循“理论背景 -> 环境构建 -> 数据生产 (ABACUS) -> 数据后处理 (pyatb) -> 结果分析”的工程化逻辑。能带反折叠涉及两个软件的协同工作，因此流程的规范性和接口的准确对接是本教程的核心。
- **核心知识点**: 超胞与原胞的倒空间关系、紧束缚哈密顿量矩阵生成、谱权重计算、pyatb 接口配置、Python 绘图参数调整。

<!-- CHAPTER_START -->
## 第一章：能带反折叠的物理基础与应用场景
**本章逻辑**: 在动手计算前，必须明确“为什么要做反折叠”。本章从超胞计算引入的能带折叠问题出发，阐述反折叠如何恢复原胞的平移对称性特征，建立物理图像。

### Section 1.1: 超胞计算与能带折叠困境
- **内容**: 解释在杂质、缺陷或合金体系计算中引入超胞（Supercell）的必要性，以及超胞导致的布里渊区折叠（Band Folding）现象，说明为何直接的超胞能带图难以与实验（如 ARPES）对比。
- **关键参数**: 无

### Section 1.2: 反折叠（Unfolding）原理简介
- **内容**: 简述如何利用原胞的一组完备布洛赫波函数将超胞波函数展开。介绍谱权重（Spectral Weight）的概念，即不同 $k$ 点对超胞本征态的贡献权重。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第二章：计算环境搭建与依赖库安装
**本章逻辑**: pyatb 是一个独立的 Python 包，且依赖特定的数学库。由于环境配置是该流程中最易报错的环节（如 MKL 链接错误），本章需独立成章，确保地基稳固。

### Section 2.1: 基础依赖库安装
- **内容**: 详细介绍 `pybind11` 和 `mpi4py` 的安装，以及 `eigen3` 库的下载与路径配置。强调镜像选择的重要性（推荐 `abacus:3.2.3`）。
- **关键参数**: 无

### Section 2.2: pyatb 编译与安装
- **内容**: 演示从 GitHub 克隆 pyatb 源码，修改 `siteconfig.py`（如需）以及执行 pip 安装的全过程。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第三章：ABACUS 自洽计算与矩阵生成
**本章逻辑**: ABACUS 在此流程中扮演“哈密顿量生成器”的角色。本章重点在于如何通过正确的参数设置，输出 pyatb 所需的稀疏矩阵文件。

### Section 3.1: 输入参数设置 (INPUT)
- **内容**: 详解 ABACUS 的 `INPUT` 文件设置。特别强调必须使用 LCAO 基组，并开启矩阵输出开关。同时讨论 `nbands` 的设置，确保包含足够的高能级以便反折叠分析。
- **关键参数**: 
    - `calculation`: `scf`
    - `basis_type`: `lcao` (必须)
    - `out_mat_hs2`: `1` (输出 Hamiltonian 和 Overlap 矩阵)
    - `out_mat_r`: `1` (输出位置算符矩阵)
    - `nbands`: (需设置足够大)

### Section 3.2: 结构与基组文件准备
- **内容**: 介绍 `STRU` 文件（超胞结构）、赝势文件 (`.upf`) 和轨道文件 (`.orb`) 的准备。
- **关键参数**: 无

### Section 3.3: 运行自洽计算与结果检查
- **内容**: 运行 ABACUS scf 计算。检查输出目录 `OUT.suffix` 中是否成功生成了关键的 `.csr` 稀疏矩阵文件。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第四章：pyatb 后处理与能带反折叠计算
**本章逻辑**: 这是流程的核心枢纽。涉及 ABACUS 输出数据向 pyatb 输入数据的“手动”传递，以及 pyatb 核心参数的物理意义配置。

### Section 4.1: 工作目录规划与数据迁移
- **内容**: 建议建立独立的 `pyatb` 文件夹以避免文件混淆。指导用户将 ABACUS 生成的三个 `.csr` 文件（`data-HR-sparse...` 等）复制到新目录。
- **关键参数**: 无

### Section 4.2: 关键步骤：费米能级的手动提取
- **内容**: **重点强调**。演示如何从 ABACUS 的 `running_scf.log` 中读取 `EFERMI` 值，并将其填入 pyatb 的输入文件中。解释为何这一步不能自动化及其物理后果。
- **关键参数**: `fermi_energy` (在 pyatb Input 中)

### Section 4.3: pyatb 输入文件 (Input) 详解
- **内容**: 详细解析 pyatb 的 `Input` 文件结构。重点讲解如何定义超胞相对于原胞的变换矩阵 `m_matrix`，以及能带计算路径的设置。
- **关键参数**: 
    - `package`: `ABACUS`
    - `HR_route`, `SR_route`, `rR_route` (指定矩阵文件路径)
    - `m_matrix` (超胞变换矩阵)
    - `band_range`

### Section 4.4: 运行 pyatb 与 MKL 环境配置
- **内容**: 演示运行 `pyatb` 命令。**特别处理**：介绍如何通过设置 `LD_PRELOAD` 环境变量解决 Intel MKL 库的链接报错问题（`undefined symbol`），这是运行成功的关键。
- **关键参数**: 环境变量 `LD_PRELOAD`

<!-- CHAPTER_START -->
## 第五章：结果可视化与分析
**本章逻辑**: 计算完成后，如何将抽象的数据转化为直观的能带图（Spectral Weight Map）。

### Section 5.1: 绘图脚本参数调整
- **内容**: 解析 `plot_unfold.py` 脚本。指导用户如何根据实际体系的费米能级和能带分布，修改脚本中的能量范围参数，避免生成的图片空白或比例失调。
- **关键参数**: `energy_range` (Python 脚本参数)

### Section 5.2: 结果解读
- **内容**: 展示最终的 `unfold.pdf`。解释图中颜色的深浅代表谱权重的大小，如何识别主能带与由于对称性破缺引入的“影子带”或模糊化特征。
- **关键参数**: 无

<!-- APPENDIX_START -->
## 附录：常见问题与进阶建议
- **常见报错**: 汇总 MKL 链接错误、文件路径错误、输入文件名大小写混淆（`INPUT` vs `Input`）等典型问题。
- **自旋极化处理**: 简要说明如果是磁性体系（`nspin 2`），涉及 `SPIN0` 和 `SPIN1` 矩阵时的处理思路。