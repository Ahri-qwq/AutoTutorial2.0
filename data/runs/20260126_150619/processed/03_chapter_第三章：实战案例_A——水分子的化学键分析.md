# 第三章：实战案例 A——水分子的化学键分析

在计算材料学中，除了关注能量和力，电子结构的分析往往能为我们揭示材料性质的微观起源。**电子局域函数（Electron Localization Function, ELF）** 是描述电子局域化程度的强有力工具，它能清晰地展示出共价键、孤对电子以及原子壳层结构。

本章将以经典的“水分子（H₂O）”为例，带领大家完成一次完整的化学键分析。我们将通过对比 ABACUS 的两种核心基组——**平面波（PW）** 和 **原子轨道（LCAO）** 的计算结果，深入理解不同基组对电子结构描述的细微差异，特别是 ABACUS 在 LCAO 基组下为保证物理结果正确性所做的特殊数值处理。

---

## 3.0 理论背景：ELF 的物理定义与自旋差异

在开始实战前，我们需要明确 ELF 的定义，特别是 ABACUS 内部是如何处理自旋极化与非极化情况的，这直接关系到我们对结果的理解。

ELF 的值域为 $[0, 1]$：
*   **ELF = 1**：电子高度局域化（如成键区域、孤对电子）。
*   **ELF = 0.5**：对应均匀电子气行为（类似金属键特征）。
*   **ELF ≈ 0**：电子完全离域或真空区。

### 核心公式
ELF 的通用形式为：
$$ELF = \frac{1}{1 + \chi^2}$$

其中 $\chi$ 是一个无量纲的局域化指数，其定义依赖于动能密度。

**1. 自旋非极化（Spin Unpolarized, `nspin 1`）**
$$ \chi = \frac{\tau_{KS} - \tau_{vW}}{\tau_{TF}} $$
*   $\tau_{KS}$：Kohn-Sham 动能密度（正定形式）。
*   $\tau_{vW}$：von Weizsäcker 动能密度（代表玻色子项）。
*   $\tau_{TF}$：Thomas-Fermi 动能密度（参考标准）。

**2. 自旋极化（Spin Polarized, `nspin 2`）**
在自旋极化下，ABACUS 分别计算自旋向上（$\alpha$）和自旋向下（$\beta$）的 ELF。根据自旋标度率（Spin Scaling），动能泛函的形式发生变化：
$$ \chi_\sigma = \frac{\tau_{KS}^\sigma - \tau_{vW}^\sigma}{\tau_{TF}^\sigma} \quad (\sigma = \alpha, \beta) $$
*   注意 $\tau_{TF}^\sigma$ 的标度关系：$\tau_{TF}^\sigma(\rho_\sigma) = 2^{2/3} \tau_{TF}^{non-spin}(\rho_\sigma)$。这反映了泡利不相容原理对同自旋电子的排斥作用更强。

---

## 3.1 平面波 (PW) 基组计算流程

平面波基组具有完备性，能够非常精确地描述真空区行为。我们首先使用 PW 基组建立一个“标准答案”。

### 3.1.1 准备输入文件
创建一个名为 `H2O_PW` 的文件夹，准备以下文件：

**1. INPUT (核心参数设置)**
```bash
INPUT_PARAMETERS
# 基础参数
suffix          H2O_PW
calculation     scf
basis_type      pw          # 指定使用平面波基组
ecutwfc         60          # 能量截断值 (Ry)，水分子通常需要较高精度
scf_nmax        50
symmetry        1           # 开启对称性分析

# 电子局域函数输出
out_elf         1           # [关键参数] 1=开启ELF输出, 0=关闭
```
> **参数详解**：`out_elf` 是控制 ELF 计算的开关。它接受两个整数，第一个控制开关（1为开），第二个控制输出精度（默认为3）。通常设置 `out_elf 1` 即可。

**2. STRU (结构文件)**
将水分子置于一个较大的盒子中（例如 10 Å），以避免周期性镜像相互作用。
```bash
ATOMIC_SPECIES
O 15.999 O.upf
H 1.008  H.upf

LATTICE_CONSTANT
1.889726125  # 1.0 Angstrom in Bohr

LATTICE_VECTORS
10.0 0.0 0.0
0.0 10.0 0.0
0.0 0.0 10.0

ATOMIC_POSITIONS
Cartesian
O 5.000000 5.000000 5.000000 1 1 1
H 5.757000 5.586000 5.000000 1 1 1
H 5.757000 4.414000 5.000000 1 1 1
```

**3. KPT (K点设置)**
由于是大超胞孤立分子计算，使用 Gamma 点即可。
```bash
K_POINTS
0
Gamma
1 1 1 0 0 0
```

### 3.1.2 运行与结果检查
运行 ABACUS 后，进入输出目录 `OUT.H2O_PW`。你会发现生成了一个名为 `ELF.cube` 的文件。

**物理正确性验证**：
在 PW 基组下，由于基组在全空间（包括真空）都是完备的，当远离水分子时，电荷密度 $\rho \to 0$，动能密度 $\tau_{KS}$ 和 $\tau_{vW}$ 均趋于 0，且 $\tau_{KS} \approx \tau_{vW}$（单电子行为）。此时 $\chi$ 的分母 $\tau_{TF}$ 虽然也趋于 0，但在物理极限下 ELF 应趋于 0。
*   **观察**：PW 计算出的 `ELF.cube` 在真空区域数值严格为 0（或极小的数值噪声），这是物理上正确的表现。

---

## 3.2 原子轨道 (LCAO) 基组计算与对比

接下来，我们使用 LCAO 基组进行相同的计算。由于原子轨道是中心局域的，它们在远离原子核的区域会快速衰减，这引入了一个特殊的数值稳定性问题。

### 3.2.1 准备输入文件
新建文件夹 `H2O_LCAO`，复制之前的 STRU 和 KPT，修改 `INPUT` 文件。

**INPUT (修改部分)**
```bash
INPUT_PARAMETERS
suffix          H2O_LCAO
calculation     scf
basis_type      lcao        # [关键变化] 切换为原子轨道基组
ecutwfc         60
out_elf         1           # 同样开启 ELF 输出
ks_solver       genelpa     # LCAO 推荐的对角化求解器
```
*注意：使用 LCAO 模式时，请确保 STRU 文件中引用的原子轨道文件（`.orb`）路径正确。*

### 3.2.2 关键知识点：LCAO 下的稳定性修正

在运行之前，作为高阶用户，你必须理解 ABACUS 在 LCAO 模式下计算 ELF 的特殊处理机制。

**问题背景**：
ELF 的核心变量 $\chi = \frac{\tau_{KS} - \tau_{vW}}{\tau_{TF}}$。
在远离分子的真空区，理论上分子和分母都趋于 0。然而，由于 **LCAO 基组的不完备性**（即基函数在截断半径外强制为 0），动能密度的计算可能出现数值不稳定。具体表现为：分母 $\tau_{TF}$ 趋于 0 的速度可能比分子更快，导致 $\chi \to \infty$，进而使得 $ELF \to 0$ 的物理图像失效，出现非物理的“伪局域化”数值（即真空区 ELF 不为 0）。

**ABACUS 的解决方案**：
为了消除这种非物理伪影，ABACUS 参考了文献（*J. Chem. Phys. 1990, 92, 5397* 及后续改进），在 $\chi$ 的分子上引入了一个微小的**稳定性修正值** $\epsilon$：

$$ \chi_{corrected} = \frac{\tau_{KS} - \tau_{vW} + \epsilon}{\tau_{TF}} $$

*   **默认值**：ABACUS 内部设定 $\epsilon = 10^{-5}$。
*   **效果**：在电子密度显著的区域（成键区），$\epsilon$ 相比真实动能密度可以忽略不计，不影响结果；但在真空区，$\epsilon$ 的存在确保了分子不为 0，而分母趋于 0，使得 $\chi \to \infty$，从而强制 $ELF \to 0$。

> **提示**：当你查看 LCAO 计算的 `ELF.cube` 时，如果发现真空区极其干净地为 0，正是得益于这个修正项。如果没有这个修正，你可能会在真空区看到杂乱的噪点。

---

## 3.3 结果可视化 (VESTA 实战)

获得 `.cube` 文件后，我们需要使用可视化软件来直观分析化学键。这里推荐使用免费且强大的 **VESTA**。

### 3.3.1 加载数据
1.  打开 VESTA。
2.  将 `OUT.H2O_PW/ELF.cube` 或 `OUT.H2O_LCAO/ELF.cube` 直接拖入窗口。

### 3.3.2 绘制等高面 (Isosurface) —— 寻找孤对电子
等高面展示了 ELF 值等于某个特定数值的空间分布。
1.  点击左侧面板的 **Properties**。
2.  选择 **Isosurfaces** 标签页。
3.  **调整 Isosurface level**：
    *   **Level = 0.5**：你会看到类似电子云的包裹形状，区分度不高。
    *   **Level = 0.8**（推荐）：这是观察共价键和孤对电子的最佳值。
        *   你将清晰地看到氧原子周围有两个突出的“耳朵”状区域，这就是**氧原子的孤对电子**。
        *   同时，O-H 键之间也会有高 ELF 值的连通区域，表征强共价键。

### 3.3.3 绘制 2D 切面图 (Slice) —— 剖析内部结构
为了更定量地看清键的内部，我们可以切开分子。
1.  在左侧工具栏选择 **Utilities** -> **2D Data Display**。
2.  在弹出的窗口中点击 **Slice**。
3.  **定义切面**：
    *   我们需要一个穿过 H-O-H 平面的切面。
    *   选择 **Calculate the best plane for the selected atoms**，然后点击主窗口中的三个原子（O, H, H），VESTA 会自动计算切面参数 (hkl) 和距离。
4.  点击 **OK**。
5.  **观察**：
    *   你将看到一张彩色的 2D 热力图。
    *   **红色区域 (ELF ≈ 1)**：集中在 O 原子周围（壳层结构）和 O-H 键中间。
    *   **蓝色区域 (ELF ≈ 0)**：真空区。
    *   **绿色区域 (ELF ≈ 0.5)**：电子气特征区域。

### 3.3.4 对比 PW 与 LCAO 结果
此时，你可以同时打开两个 VESTA 窗口，分别加载 PW 和 LCAO 的结果。
*   **宏观一致性**：两者的 O-H 键长、孤对电子形状应高度一致。
*   **微观差异**：仔细观察远离原子核的边缘区域或原子核附近的极高值区，可能会发现等高线形状有细微差别。这是由于 LCAO 基组的径向函数与平面波展开的数学形式不同导致的，属于正常现象。

---

**本章小结**
通过本章，我们不仅学会了如何开启 `out_elf` 参数，更重要的是理解了 ELF 背后的物理含义以及 ABACUS 在处理 LCAO 基组真空区数值稳定性时的底层逻辑。在下一章中，我们将处理更复杂的体系——自旋极化的铁磁性材料，届时我们将分别处理 Spin Up 和 Spin Down 的 ELF。