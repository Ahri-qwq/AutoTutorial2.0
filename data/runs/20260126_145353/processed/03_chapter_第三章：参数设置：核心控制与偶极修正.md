# 第三章：参数设置：核心控制与偶极修正

在完成了前两章的基础建模与环境搭建后，我们来到了 ABACUS 实操中最关键的环节——**INPUT 参数文件的深度定制**。

对于表面科学计算（Surface Science），特别是功函数（Work Function）和表面吸附能的计算，仅仅让程序“跑通”是不够的。很多初学者经常会遇到算出功函数偏差巨大、或者真空层电势不平坦的问题，其根源往往在于两个核心设置：**静电势输出模式**与**偶极修正**。

本章将以“计算正确的功函数”为导向，带你避开这些常见的“坑”。

---

## 3.1 激活静电势输出：`out_pot` 的陷阱

计算功函数的核心公式是 $\Phi = V_{vac} - E_F$。其中 $E_F$（费米能级）可以直接从输出日志中读取，但 $V_{vac}$（真空静电势）必须通过分析空间势场分布得到。

在 ABACUS 的 `INPUT` 文件中，控制势场输出的参数是 `out_pot`。这里存在一个极易混淆的陷阱。

### 3.1.1 参数详解

| 参数名 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- |
| `out_pot` | Integer | 0 | 控制势场输出文件的类型 |

### 3.1.2 取值含义与核心区别（Critical）

*   **`out_pot 0`**：不输出任何势场文件（默认）。
*   **`out_pot 1` (Total Potential)**：输出**总势（Total Potential）**。
    *   包含：Hartree 势 + 局域赝势（Local Pseudopotential） + **交换关联势（XC Potential）**。
    *   文件名：`TotalPotential.cube`
    *   **警告**：**绝对不要用这个文件计算功函数！** 因为交换关联势在真空区域的行为与静电势不同，包含它会导致真空能级数值错误。
*   **`out_pot 2` (Electrostatic Potential)**：输出**静电势（Electrostatic Potential）**。
    *   包含：Hartree 势 + 局域赝势（Local Pseudopotential）。
    *   文件名：`ElecStaticPot.cube`
    *   **正确做法**：**这是计算功函数的唯一正确选项。** 我们定义的“真空能级”是指电子感受到的静电势在真空中的渐进值。

### 3.1.3 实战设置示例

在 `INPUT` 文件中添加：

```bash
#Parameters (7.Output)
out_pot  2  # 强制输出不含XC的静电势，用于功函数分析
```

---

## 3.2 偶极修正 (Dipole Correction) 设置

### 3.2.1 为什么需要偶极修正？

在周期性边界条件（PBC）下，如果你计算的是非对称表面（例如：一面吸附了分子，另一面是洁净表面），平板两侧的电荷分布不均会产生净偶极矩。

由于 PBC 强制势场在边界处连续，这会导致在真空层中产生一个**非物理的人造电场（Artificial Electric Field）**。这个伪电场会穿过整个平板，严重扭曲电子结构，导致算出的功函数和吸附能不准确。

**偶极修正的原理**：在真空层的某个位置引入一个锯齿状的外部电势（Sawtooth Potential），人为地抵消掉由 PBC 引起的电势倾斜，恢复真空层的平坦。

### 3.2.2 关键参数详解

要开启偶极修正，需要在 `INPUT` 文件中设置以下参数（基于 ABACUS 官方实现）：

1.  **`efield_flag`** (Bool):
    *   设置为 `1`。开启外加电场模块，这是偶极修正的前置开关。
2.  **`dip_cor_flag`** (Bool):
    *   设置为 `1`。开启偶极修正功能。
3.  **`efield_pos_max`** (Float):
    *   锯齿状电势“台阶”所在的位置。
    *   **单位**：分数坐标（0.0 到 1.0），沿 Z 轴方向（假设表面法向为 Z）。
    *   **设置技巧**：应设置在真空层的正中央，远离表面电荷密度区域。例如，如果你的平板在 0.0~0.5 区间，真空在 0.5~1.0 区间，那么该值设为 `0.75` 左右最安全。
4.  **`efield_pos_dec`** (Float):
    *   电势台阶的衰减长度（Decay length）。
    *   **单位**：分数坐标。
    *   **设置技巧**：通常设置一个较小的值，如 `0.1`，确保电势突变局限在真空深处，不接触到原子表面。

### 3.2.3 INPUT 文件配置示例

假设我们计算一个非对称的 H2O 吸附表面，以下是标准的偶极修正配置块：

```bash
INPUT_PARAMETERS
# ... (其他常规参数) ...

#Parameters (6.Dipole correction)
efield_flag     1      # 开启电场模块
dip_cor_flag    1      # 开启偶极修正
efield_pos_max  0.5    # 锯齿电势突变位置（假设真空层位于晶胞中部）
efield_pos_dec  0.1    # 突变区域宽度
efield_amp      0.00   # 初始外场强度设为0，由程序自动计算修正值
```

> **注意**：`efield_pos_max` 的默认值通常为 0.5，但请务必根据你的 `STRU` 文件中原子的实际位置进行调整。**绝对不能让锯齿台阶切过原子层！**

---

## 3.3 实战：功函数计算全流程

结合上述两节，计算功函数（Work Function, $\Phi$）的标准流程如下：

### 步骤 1：运行计算
确保 `INPUT` 中包含 `out_pot 2` 和正确的偶极修正参数。运行 SCF 计算。

### 步骤 2：获取费米能级 ($E_F$)
计算结束后，查看输出日志（如 `OUT.ABACUS/running_scf.log`），找到最终的费米能级。

```text
...
Fermi Energy = -0.12345 Hartree
...
```
*注：ABACUS 内部单位通常为 Hartree 或 eV，请仔细核对日志中的单位说明。*

### 步骤 3：处理静电势文件
使用后处理工具（如 Python 脚本或 VESTA）读取生成的 `ElecStaticPot.cube` 文件。
我们需要做**平面平均（Planar Average）**：将三维势场 $V(x, y, z)$ 在 $x, y$ 平面上积分，得到沿 $z$ 轴的一维分布曲线 $V(z)$。

### 步骤 4：读取真空能级 ($V_{vac}$)
绘制 $V(z)$ 曲线。
*   **检查点**：在真空层区域，曲线应该呈现出一个平坦的“平台”（Plateau）。
*   如果曲线在真空层是倾斜的，说明偶极修正未生效或真空层太薄。
*   读取该平台处的数值，即为 $V_{vac}$。

### 步骤 5：计算功函数 ($\Phi$)

使用以下公式计算：

$$ \Phi = V_{vac} - E_F $$

---

## 3.4 专家锦囊 (Tips)

### 1. 单位换算至关重要
ABACUS 的 `.cube` 文件输出单位通常是 **Hartree (atomic unit)**。而我们在发表文章时通常使用 **eV**。
*   **换算因子**：$1 \text{ Hartree} \approx 27.2114 \text{ eV}$。
*   **建议**：在做减法公式之前，先将 $V_{vac}$ 和 $E_F$ 统一换算成 eV。即：
    $$ \Phi (\text{eV}) = (V_{vac}^{\text{Ha}} - E_F^{\text{Ha}}) \times 27.2114 $$

### 2. 如何判断偶极修正是否完美？
作图观察平面平均静电势 $V(z)$：
*   **无修正/修正失败**：真空区域的电势是一条斜线，左右两个真空边界的值不相等。
*   **修正成功**：真空区域是平的，且左右两侧的真空能级可能出现台阶（Step），这是正常的，因为非对称表面的两侧功函数本身就不同。我们通常取远离吸附物一侧（或你关心的那一侧）的真空能级。

### 3. 常见报错排查
如果你开启了 `dip_cor_flag 1` 但计算崩溃，请检查：
*   是否是表面体系？（必须有真空层）
*   `efield_pos_max` 是否设置在了原子上？（必须在真空里）
*   基组支持：ABACUS 的偶极修正支持平面波（PW）和数值原子轨道（LCAO）基组。

---

下一章，我们将进入具体的计算资源分配与并行效率优化，探讨如何让 ABACUS 跑得更快。