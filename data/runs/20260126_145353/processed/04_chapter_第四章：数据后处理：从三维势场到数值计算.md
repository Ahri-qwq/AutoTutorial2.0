# 第四章：数据后处理：从三维势场到数值计算

在完成了耗时的 SCF 自洽计算后，我们得到了一系列原始数据文件。对于表面科学研究者而言，如何从这些数据中提取出**功函数 (Work Function)**、**表面偶极矩**等物理量，是连接计算与实验的关键一步。

本章将带你完成从原始 Log 文件和 3D Cube 文件到最终物理结论的全流程。我们将重点讨论如何正确处理静电势，这是新手最容易出错的环节。

---

## 4.1 提取费米能级 ($E_F$)

功函数 ($\Phi$) 的定义是真空能级 ($V_{vac}$) 与费米能级 ($E_F$) 之差。因此，第一步是获取体系的费米能级。

### 4.1.1 定位数据源
ABACUS 的费米能级信息记录在主输出日志文件中（通常命名为 `running_scf.log` 或 `running_${suffix}.log`）。

### 4.1.2 操作步骤
可以使用 `grep` 命令快速提取。在终端中执行：

```bash
grep "Fermi Energy" running_scf.log
```

### 4.1.3 输出示例与解读
你将看到类似如下的输出：

```text
Fermi Energy = -2.34567 eV
```

**注意**：
1.  ABACUS 输出的费米能级单位通常默认为 **eV**。
2.  对于半导体或绝缘体表面，费米能级可能位于带隙中；对于金属，它对应最高占据态。
3.  请记录下这个数值，记为 $E_F$。

---

## 4.2 平面平均静电势的处理

为了得到真空能级 $V_{vac}$，我们需要分析体系的静电势分布。ABACUS 计算结束后会输出 `.cube` 格式的势场文件，我们需要将其从三维数据降维处理为沿表面法向（通常为 Z 轴）的一维曲线。

### 4.2.1 关键参数设置 (INPUT)
在进行 SCF 计算前，必须在 `INPUT` 文件中正确设置 `out_pot` 参数。这是本章的**核心考点**：

| 参数名 | 设置值 | 物理含义 | 适用场景 |
| :--- | :--- | :--- | :--- |
| `out_pot` | **2** | **静电势 (Electrostatic Potential)** <br>包含：Hartree 势 + 离子局域赝势 | **计算功函数**、静电势分布 |
| `out_pot` | 1 | 总局域势 (Total Local Potential)<br>包含：静电势 + 交换关联势 (XC) | 能带对齐 (Band Alignment) 分析 |

> **警告**：计算功函数时，请务必使用 **`out_pot 2`**。如果错误地使用了 `out_pot 1`，虽然在真空层深处 XC 势趋于零，但在表面附近的势场行为会包含非物理的 XC 贡献，干扰“真空平台”的识别。

### 4.2.2 数据降维原理
`ElecStaticPot.cube` 文件包含空间网格点 $(x, y, z)$ 上的电势值 $V(x, y, z)$。我们需要计算**平面平均电势 (Planar Average Potential)** $\bar{V}(z)$：

$$ \bar{V}(z) = \frac{1}{S} \iint_{S} V(x, y, z) \, dx \, dy $$

其中 $S$ 是 $xy$ 平面的面积。这步操作消除了原子尺度上 $xy$ 平面的周期性起伏，只保留沿 $z$ 方向的宏观变化。

### 4.2.3 Python 处理脚本示例
虽然可以使用 VESTA 查看 3D 等势面，但为了定量计算，我们需要 Python 脚本。以下是一个基于 `Cubefile` 读取逻辑的简化处理流程：

```python
import numpy as np

def read_cube_and_average(filename):
    """
    读取 Cube 文件并计算 Z 方向的平面平均势
    注意：这里仅为逻辑演示，实际建议使用 ase.io.cube 或 pymatgen 读取
    """
    with open(filename, 'r') as f:
        # 跳过头部注释和原子信息，读取网格数据
        # ... (省略文件解析代码) ...
        # 假设 data 是一个形状为 (Nx, Ny, Nz) 的 3D numpy 数组
        pass 
    
    # 核心操作：沿 X 和 Y 轴求平均
    # axis=(0, 1) 对应 x, y 维度，保留 z 维度
    planar_avg = np.mean(data, axis=(0, 1))
    
    return planar_avg

# 假设读取到了数据
# data_z 包含了沿 Z 轴每个网格点的电势值 (单位: Hartree)
# z_coords 是对应的 Z 轴坐标 (单位: Bohr)
```

**推荐工具**：
- 社区常用工具：`vaspkit` (部分兼容 cube) 或专门针对 ABACUS 开发的后处理脚本 `abacus-kit` (如有)。
- 通用方法：使用 `ASE` (Atomic Simulation Environment) 读取 cube 文件后进行平均。

---

## 4.3 确定真空能级与单位换算

得到 $\bar{V}(z)$ 曲线后，我们就可以计算功函数了。

### 4.3.1 识别真空平台 (Vacuum Plateau)
使用绘图软件（如 Matplotlib 或 Origin）绘制 $\bar{V}(z)$ 随 $z$ 变化的曲线。
- **原子层区域**：电势剧烈震荡，对应原子核和电子云的分布。
- **真空层区域**：电势应趋于一条平直的直线。

**操作**：读取该平直区域的数值，即为真空能级 $V_{vac}$。

### 4.3.2 核心公式与单位陷阱
这是新手最容易发生数量级错误的地方。

**公式**：
$$ \Phi = V_{vac} - E_F $$

**单位换算**：
- **$E_F$ (来自 log)**: 单位通常是 **eV**。
- **$V_{vac}$ (来自 cube)**: ABACUS 的 `.cube` 文件输出单位通常是 **Hartree (atomic unit)**。

因此，实际计算公式为：

$$ \Phi \text{ (eV)} = \left( V_{vac}^{\text{cube}} \times 27.2114 \right) - E_F^{\text{log}} $$

> **常数说明**: 1 Hartree $\approx$ 27.211386 eV。教程中推荐保留 4 位小数使用 **27.2114**。

### 4.3.3 实例计算
假设我们得到以下数据：
1.  从 `running_scf.log` 读取到 $E_F = -2.50$ eV。
2.  从 `ElecStaticPot.cube` 处理得到的平面平均图上，读取到真空平台高度为 $0.15$ a.u. (Hartree)。

计算过程：
$$ V_{vac} (\text{eV}) = 0.15 \times 27.2114 = 4.0817 \text{ eV} $$
$$ \Phi = 4.0817 - (-2.50) = 6.58 \text{ eV} $$

该表面的功函数为 6.58 eV。

---

## 附录：常见报错与避坑指南

在后处理过程中，如果得到的图像或数值异常，请检查以下几点：

### 1. 锯齿位置错误 (Dipole Correction Artifacts)
如果你在 `INPUT` 中开启了偶极修正（`efield_flag 1`），ABACUS 会在由 `efield_pos_max` 指定的位置引入一个电势阶跃（锯齿）来抵消人工电场。
- **正常现象**：电势阶跃出现在真空层中间，且该处没有原子。
- **错误现象**：电势阶跃穿过了原子层，导致原子区域的电势发生非物理断裂。
- **对策**：调整 `efield_pos_max`（0~1 之间的分数坐标），确保它位于真空层的正中央。

### 2. 真空层不足 (Insufficient Vacuum)
- **现象**：在 $\bar{V}(z)$ 图中，真空区域没有出现平坦的“平台”，而是呈现倾斜或抛物线形状，或者两个相邻表面的电势波函数还没衰减完就互相重叠了。
- **后果**：无法准确读取 $V_{vac}$，功函数计算失效。
- **对策**：增加 `STRU` 文件中的晶格矢量 $z$ 分量长度，加厚真空层（通常建议至少 15-20 Å）。

### 3. 单位混淆
- **现象**：计算出的功函数数值大得离谱（例如 > 100 eV）或非常小。
- **检查**：确认你是否忘记将 Cube 文件中的数值乘以 27.2114。务必牢记：**Cube 文件是 Hartree，Log 文件是 eV**。