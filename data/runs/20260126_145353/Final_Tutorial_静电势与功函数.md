# ABACUS 表面计算实战指南：从静电势到功函数

## 前言

欢迎来到《ABACUS 表面计算实战指南》。作为一款由中国开发者主导、面向全球的高性能国产密度泛函理论（DFT）软件，ABACUS 在处理大规模体系和复杂电子结构方面展现出了卓越的效率与精度。特别是在表面科学领域，ABACUS 提供了完善的基组支持（平面波与原子轨道）以及针对性的物理模型修正，为研究催化机理、半导体能带对齐及电子输运提供了强有力的工具。

**学习路线图**
本教程旨在帮助读者跨越从“运行代码”到“理解物理”的鸿沟。全书分为四个核心阶段：
1. **理论筑基**（第一章）：阐明静电势与功函数的物理本质，区分总局域势与静电势的底层逻辑。
2. **模型构建**（第二章）：实战演练 Slab 模型的搭建技巧，探讨真空层厚度对物理结果的敏感性。
3. **参数精控**（第三章）：深入解析 INPUT 文件的关键参数，特别是如何通过偶极修正消除周期性边界条件带来的人工误差。
4. **数据转化**（第四章）：演示如何从收敛的计算结果中提取费米能级与三维势场，完成从数据到物理结论的最后跃迁。

**知识体系定位**
本教程属于 ABACUS 官方知识体系中的“表面科学进阶”模块。它上承《ABACUS 基础入门》，下接《表面催化反应路径模拟》等高级课题。通过本教程，你将掌握表面计算中最核心的物理量——功函数的标准计算流程。

**前置要求**
在开始学习之前，我们建议读者具备以下基础：
- 密度泛函理论（DFT）的基本物理概念。
- 能够独立完成 ABACUS 块体体系的自洽场（SCF）计算。
- 基础的 Linux 命令行操作与 Python 数据处理能力。

---

# 第一章：物理基础：静电势与功函数的定义

在开始任何实际计算之前，我们必须先厘清物理概念。对于表面科学计算（如催化、半导体异质结能带对齐等），**功函数（Work Function）** 是最基础也是最重要的物理量之一。

很多初学者在使用 DFT 软件时，往往能跑通计算，却在数据提取环节犯错——最典型的错误就是混淆了“总局域势”与“静电势”，导致计算出的功函数数值完全偏离物理直觉。作为 ABACUS 的开发者，本章将带你从代码实现的底层逻辑出发，彻底理解我们需要“算什么”。

---

## 1.1 ABACUS 中的势场分类

在 Kohn-Sham DFT 框架下，电子感受到的有效势场（Effective Potential, $V_{eff}$）通常由以下几部分构成：

$$
V_{eff}(\mathbf{r}) = V_{H}(\mathbf{r}) + V_{ion}(\mathbf{r}) + V_{xc}(\mathbf{r}) + V_{ext}(\mathbf{r})
$$

其中：
*   $V_{H}$：哈特里势（Hartree Potential），源于电子密度的经典静电相互作用。
*   $V_{ion}$：离子实产生的局域势（Local Pseudopotential）。
*   $V_{xc}$：交换关联势（Exchange-Correlation Potential），包含量子力学效应。
*   $V_{ext}$：外场（如外加电场或偶极修正引入的势）。

### 核心概念：静电势 ($V_{static}$)
在计算功函数时，我们需要关注的是**静电势（Electrostatic Potential）**。在 ABACUS 的定义中，静电势**不包含**交换关联势。其数学表达为：

$$
V_{static}(\mathbf{r}) = V_{H}(\mathbf{r}) + V_{ion}(\mathbf{r}) + V_{ext}(\mathbf{r})
$$

### 关键参数：`out_pot`

在 ABACUS 的 `INPUT` 输入文件中，`out_pot` 参数控制势场文件的输出。这是本章最关键的设置，请务必区分：

*   **`out_pot 1` (Total Local Potential)**:
    *   输出内容：$V_{local} = V_{static} + V_{xc}$
    *   物理含义：电子在 KS 方程中感受到的总有效局域势。
    *   **警告**：虽然在真空中 $V_{xc}$ 趋于 0，但在表面附近及材料内部，$V_{xc}$ 贡献显著。**严禁使用此项计算功函数**，否则会引入非静电项的干扰。

*   **`out_pot 2` (Electrostatic Potential)**:
    *   输出内容：$V_{static} = V_{H} + V_{ion} + V_{ext}$
    *   物理含义：纯粹的经典静电势场。
    *   **用途**：**这是计算功函数、能带对齐（Band Alignment）的正确选项。**

> **开发者提示 (Developer's Note)**: 
> 当你设置 `out_pot 2` 后，ABACUS 会在计算结束后输出一个名为 `ElecStaticPot.cube` 的文件。这个文件包含了三维空间的静电势分布数据，是我们后续分析的基础。

---

## 1.2 功函数的物理定义与计算公式

### 物理定义
功函数 ($\Phi$) 定义为将一个电子从材料内部的费米能级（Fermi Level）移动到材料表面外的真空能级（Vacuum Level）所需的最小能量。

### 计算公式
在实际的 DFT 表面模型计算中，功函数通过以下公式计算：

$$
\Phi = V_{vac} - E_F
$$

其中：
1.  **$V_{vac}$ (真空静电势)**:
    *   这是电子刚刚脱离材料表面，处于静止状态时的静电势能。
    *   **获取方式**: 通过处理 `ElecStaticPot.cube` 文件，计算沿表面法线方向（通常为 Z 轴）的平面平均静电势（Planar-averaged Potential），在真空层区域读取到的**平台值（Plateau）**。
    
2.  **$E_F$ (费米能级)**:
    *   材料内部电子填充的最高能级（对于金属）或价带顶（对于半导体，需视具体定义而定，通常 DFT 输出的 $E_F$ 位于带隙中）。
    *   **获取方式**: 直接从 ABACUS 的自洽计算日志文件（如 `running_scf.log`）或输出文件（如 `OUT.suffix/running_scf.log`）中读取 `Fermi Energy`。

### 势场分布示意图
为了直观理解，我们通常会绘制“平面平均静电势 vs. Z轴坐标”的曲线图：

*   **材料内部区域**: 电势呈现周期性振荡，反映了原子层的排列结构。
*   **真空层区域**: 电势逐渐趋于平缓，形成一个平台。这个平台的高度就是 $V_{vac}$。

---

## 1.3 专家锦囊 (Tips & Tricks)

在实战中，以下细节决定了计算的成败：

### 1. 单位陷阱 (Unit Conversion)
ABACUS 作为一款物理导向的软件，其底层输出（包括 `.cube` 文件和 Log 中的能量）默认使用 **Hartree (Atomic Unit, a.u.)** 单位，而不是化学家常用的 eV。
*   **换算关系**: $1 \text{ Hartree} \approx 27.2114 \text{ eV}$
*   **实战建议**: 在作图或计算 $\Phi$ 时，务必将 $V_{vac}$ 和 $E_F$ 都乘以 27.2114 转换为 eV。如果你算出的功函数只有 0.15 左右，那一定是忘了单位换算（$0.15 \text{ Ha} \approx 4.08 \text{ eV}$）。

### 2. 偶极修正的判断 (Dipole Correction Check)
对于非对称表面（Slab 上下表面原子结构不同），必须在 `INPUT` 中开启偶极修正（通常设置 `dipole_correction 1`，具体参数将在后续章节详解）。
*   **如何检查修正是否正确？**
    观察静电势分布图的真空区域。
    *   **正确**: 真空区电势是平坦的（Flat Plateau）。
    *   **错误**: 真空区电势呈现倾斜（Slope），说明偶极场未被完全抵消，或者真空层太薄导致周期性镜像相互作用。此时读取的 $V_{vac}$ 是无意义的。

### 3. 费米能级的读取时机
确保读取的是**自洽迭代（SCF）完全收敛后**的费米能级。如果在弛豫（Relax）过程中，应读取最后一步离子步的 SCF 结果。

---

**下一章预告**：
明白了“算什么”，下一章我们将进入“怎么算”。我们将手把手教你如何构建表面模型（Slab Model），以及如何编写正确的 `INPUT` 文件来开启静电势输出。

# 第二章：模型构建：表面体系与真空层设计

在第一章中，我们熟悉了 ABACUS 的基本运行流程。从本章开始，我们将进入实战的核心——如何构建一个物理上合理、计算上高效的模型。

对于表面科学（催化、腐蚀、薄膜生长等）研究而言，**Slab 模型（平板模型）** 是最常用的近似方法。好的计算始于好的模型，本章将指导你如何在 ABACUS 的 `STRU` 文件中构建 Slab，并深入探讨真空层与原子位置的微妙关系，这直接决定了后续功函数（Work Function）计算和偶极修正的成败。

---

## 2.1 Slab 模型与真空层厚度

### 2.1.1 为什么需要真空层？

ABACUS 基于周期性边界条件（Periodic Boundary Conditions, PBC）。这意味着，当你定义一个晶胞时，软件会在三维空间中无限复制它。

如果你直接从体材料（Bulk）中切出一个表面，而不做特殊处理，PBC 会导致你的表面与上方镜像晶胞的“底部”紧密接触，这实际上模拟的是层状体材料，而非表面。

为了模拟真实的表面，我们必须在垂直于表面（通常设为 Z 轴）的方向上人为引入一段“空无一物”的区域，这就是**真空层（Vacuum Layer）**。它的作用有两个：
1.  **隔绝相互作用**：防止 Slab 上表面的电子云与上方镜像 Slab 的下表面发生重叠或静电相互作用。
2.  **提供能量参考**：为计算功函数提供一个静电势为常数的真空参考能级（$V_{vac}$）。

### 2.1.2 在 STRU 文件中设置真空层

在 ABACUS 的 `STRU` 文件中，真空层的大小并不是通过某个参数直接设置的，而是通过**拉长晶胞矢量**来实现的。

假设我们有一个 FCC 金属的 (111) 表面，原本的层厚约为 6 Å。为了添加 15 Å 的真空层，我们需要将 `LATTICE_VECTORS` 中的第三个矢量（Z方向）长度增加。

**示例：STRU 文件片段**

```abacus
ATOMIC_SPECIES
Ag 107.868 Ag_ONCV_PBE-1.0.upf

LATTICE_CONSTANT
1.889726125  # 1.0 Angstrom in Bohr (ABACUS 默认单位可能为 Bohr，此处需注意转换)

LATTICE_VECTORS
2.889 0.000 0.000    # X 方向
1.445 2.502 0.000    # Y 方向
0.000 0.000 25.000   # Z 方向：Slab厚度 + 真空层厚度

ATOMIC_POSITIONS
Direct
...
```

> **经验法则**：
> 对于大多数金属和半导体表面，**15 Å - 20 Å** 的真空层通常是安全的。
> *   **过薄**：电子云溢出，镜像相互作用显著，总能计算不准，静电势无法展平。
> *   **过厚**：平面波基组计算量显著增加（因为需要填充更多的平面波来描述真空）。

---

## 2.2 原子位置与偶极修正的几何考量

构建好“盒子”后，原子的摆放位置大有讲究。这不仅是为了美观，更是为了物理结果的正确性，特别是在涉及**偶极修正（Dipole Correction）**时。

### 2.2.1 表面偶极矩问题

当 Slab 的上下表面不对称（例如：一面吸附了分子，另一面是洁净表面）时，体系会在 Z 方向产生净偶极矩。在周期性边界条件下，这会导致穿过真空层的静电势出现人为的梯度（倾斜），导致真空能级无法定义，总能收敛困难。

此时，我们需要在 `INPUT` 文件中开启偶极修正（通常涉及 `dipole_correction` 相关参数，具体请查阅文档）。

### 2.2.2 原子摆放策略

为了配合偶极修正，并确保计算稳定，原子在 Z 轴上的位置推荐采用以下两种策略之一：

1.  **居中放置（Centering）**：
    将 Slab 置于 Z 轴方向的中间，上下各留出一半的真空层。
    *   *优点*：几何对称性好，便于观察。
    *   *适用*：对称 Slab 或无偶极修正的计算。

2.  **特定区间放置（避免边界）**：
    ABACUS（以及大多数平面波 DFT 软件）的偶极修正通常是在真空层的某处引入一个“锯齿状电势突变”来抵消偶极场。
    *   **核心原则**：**绝对不要让原子跨越晶胞边界（Z=0 或 Z=1）**，也不要让原子位于真空层的正中央（如果偶极修正势阶跃点设在那里的化）。
    *   **推荐做法**：将 Slab 放置在 `0.1 < Z_frac < 0.9` 的区间内，确保 Z=0 附近是纯粹的真空。

---

## 2.3 实战核心：功函数（Work Function）计算流程

这是本章的重中之重。很多初学者在计算功函数时，因选错输出势文件而导致结果谬以千里。

**功函数定义**：
$$ \Phi = V_{vac} - E_F $$
其中：
*   $V_{vac}$：真空静电势（Vacuum Electrostatic Potential）。
*   $E_F$：费米能级（Fermi Energy）。

### 2.3.1 关键参数设置 (INPUT)

在 `INPUT` 文件中，必须正确设置 `out_pot` 参数。

*   **`out_pot 1` (CRITICAL)**: 输出**静电势 (Electrostatic Potential)**。包含离子实局域势和 Hartree 势。**这是计算功函数唯一正确的选择。**
*   `out_pot 2`: 输出总局域势 (Total Local Potential)。它在静电势的基础上，还包含了交换关联势 ($V_{xc}$)。**绝对不要用这个计算功函数**，因为 $V_{xc}$ 在真空中衰减行为复杂，会导致错误的真空能级读数。

**INPUT 文件示例：**

```abacus
INPUT_PARAMETERS
# ... 其他参数 ...
calculation  scf       # 自洽计算
out_pot      1         # 【核心】输出静电势用于功函数计算
# ... 其他参数 ...
```

### 2.3.2 数据提取与计算步骤

计算完成后，按以下步骤操作：

**Step 1: 获取费米能 ($E_F$)**
从输出的日志文件（如 `running_scf.log` 或 `OUT.suffix/running_scf.log`）中读取。
```bash
grep "Fermi Energy" OUT.suffix/running_scf.log
# 输出示例: Fermi Energy is 5.1234 eV
```
*注意：ABACUS 输出的费米能通常单位已经是 eV。*

**Step 2: 获取真空静电势 ($V_{vac}$)**
1.  找到输出的势文件，通常命名为 `ElecStaticPot.cube`（对应 `out_pot 1`）。
2.  **平面平均（Planar Average）**：使用后处理工具（如 Python 脚本、VESTA 或专门的 planar average code）将三维势场沿 XY 平面积分，得到沿 Z 轴的一维电势分布 $V(z)$。
3.  **读取平台值**：绘制 $V(z)$ 曲线。在真空层区域，你应该看到一段平坦的直线（Plateau）。读取该平台处的数值即为 $V_{vac}$。

> **锦囊妙计 (Tips) - 如何判断结果可靠性？**
> *   **看平台**：如果真空层区域的电势不是水平的，而是倾斜的，说明偶极修正未开启或设置不当，或者真空层太薄导致镜像相互作用未消除。此时读取的 $V_{vac}$ 是无意义的。
> *   **单位陷阱**：`ElecStaticPot.cube` 文件中的原始数据单位通常是 **Hartree (a.u.)**。
>     *   1 Hartree $\approx$ 27.2114 eV。
>     *   在代入公式 $\Phi = V_{vac} - E_F$ 前，务必将 $V_{vac}$ 乘以 27.2114 转换为 eV（假设 $E_F$ 已经是 eV）。

**Step 3: 计算**
$$ \Phi (\text{eV}) = (V_{vac}^{\text{Hartree}} \times 27.2114) - E_F^{\text{eV}} $$

---

## 2.4 本章小结

构建表面模型不仅仅是切出一个 Slab，更在于对真空层的精心设计。
1.  **真空层**：厚度要足以隔绝镜像，通常 15 Å 起步。
2.  **原子位置**：避免跨越边界，为偶极修正留出空间。
3.  **功函数计算**：
    *   **严禁**使用 `out_pot 2`。
    *   **必须**使用 `out_pot 1`。
    *   **切记** Hartree 到 eV 的单位转换。

下一章，我们将讨论表面计算中的 k 点取样与收敛性测试，这是平衡计算精度与成本的关键。

# 第三章：参数设置：核心控制与偶极修正

在完成了前两章的基础建模与环境搭建后，我们来到了 ABACUS 实操中最关键的环节——**INPUT 参数文件的深度定制**。

对于表面科学计算（Surface Science），特别是功函数（Work Function）和表面吸附能的计算，仅仅让程序“跑通”是不够的。很多初学者经常会遇到算出功函数偏差巨大、或者真空层电势不平坦的问题，其根源往往在于两个核心设置：**静电势输出模式**与**偶极修正**。

本章将以“计算正确的功函数”为导向，带你避开这些常见的“坑”。

---

## 3.1 激活静电势输出：`out_pot` 的陷阱

计算功函数的核心公式是 $\Phi = V_{vac} - E_F$。其中 $E_F$（费米能级）可以直接从输出日志中读取，但 $V_{vac}$（真空静电势）必须通过分析空间势场分布得到。

在 ABACUS 的 `INPUT` 文件中，控制势场输出的参数是 `out_pot`。这里存在一个极易混淆的陷阱。

### 3.1.1 参数详解

| 参数名 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- |
| `out_pot` | Integer | 0 | 控制势场输出文件的类型 |

### 3.1.2 取值含义与核心区别（Critical）

*   **`out_pot 0`**：不输出任何势场文件（默认）。
*   **`out_pot 1` (Total Potential)**：输出**总势（Total Potential）**。
    *   包含：Hartree 势 + 局域赝势（Local Pseudopotential） + **交换关联势（XC Potential）**。
    *   文件名：`TotalPotential.cube`
    *   **警告**：**绝对不要用这个文件计算功函数！** 因为交换关联势在真空区域的行为与静电势不同，包含它会导致真空能级数值错误。
*   **`out_pot 2` (Electrostatic Potential)**：输出**静电势（Electrostatic Potential）**。
    *   包含：Hartree 势 + 局域赝势（Local Pseudopotential）。
    *   文件名：`ElecStaticPot.cube`
    *   **正确做法**：**这是计算功函数的唯一正确选项。** 我们定义的“真空能级”是指电子感受到的静电势在真空中的渐进值。

### 3.1.3 实战设置示例

在 `INPUT` 文件中添加：

```bash
#Parameters (7.Output)
out_pot  2  # 强制输出不含XC的静电势，用于功函数分析
```

---

## 3.2 偶极修正 (Dipole Correction) 设置

### 3.2.1 为什么需要偶极修正？

在周期性边界条件（PBC）下，如果你计算的是非对称表面（例如：一面吸附了分子，另一面是洁净表面），平板两侧的电荷分布不均会产生净偶极矩。

由于 PBC 强制势场在边界处连续，这会导致在真空层中产生一个**非物理的人造电场（Artificial Electric Field）**。这个伪电场会穿过整个平板，严重扭曲电子结构，导致算出的功函数和吸附能不准确。

**偶极修正的原理**：在真空层的某个位置引入一个锯齿状的外部电势（Sawtooth Potential），人为地抵消掉由 PBC 引起的电势倾斜，恢复真空层的平坦。

### 3.2.2 关键参数详解

要开启偶极修正，需要在 `INPUT` 文件中设置以下参数（基于 ABACUS 官方实现）：

1.  **`efield_flag`** (Bool):
    *   设置为 `1`。开启外加电场模块，这是偶极修正的前置开关。
2.  **`dip_cor_flag`** (Bool):
    *   设置为 `1`。开启偶极修正功能。
3.  **`efield_pos_max`** (Float):
    *   锯齿状电势“台阶”所在的位置。
    *   **单位**：分数坐标（0.0 到 1.0），沿 Z 轴方向（假设表面法向为 Z）。
    *   **设置技巧**：应设置在真空层的正中央，远离表面电荷密度区域。例如，如果你的平板在 0.0~0.5 区间，真空在 0.5~1.0 区间，那么该值设为 `0.75` 左右最安全。
4.  **`efield_pos_dec`** (Float):
    *   电势台阶的衰减长度（Decay length）。
    *   **单位**：分数坐标。
    *   **设置技巧**：通常设置一个较小的值，如 `0.1`，确保电势突变局限在真空深处，不接触到原子表面。

### 3.2.3 INPUT 文件配置示例

假设我们计算一个非对称的 H2O 吸附表面，以下是标准的偶极修正配置块：

```bash
INPUT_PARAMETERS
# ... (其他常规参数) ...

#Parameters (6.Dipole correction)
efield_flag     1      # 开启电场模块
dip_cor_flag    1      # 开启偶极修正
efield_pos_max  0.5    # 锯齿电势突变位置（假设真空层位于晶胞中部）
efield_pos_dec  0.1    # 突变区域宽度
efield_amp      0.00   # 初始外场强度设为0，由程序自动计算修正值
```

> **注意**：`efield_pos_max` 的默认值通常为 0.5，但请务必根据你的 `STRU` 文件中原子的实际位置进行调整。**绝对不能让锯齿台阶切过原子层！**

---

## 3.3 实战：功函数计算全流程

结合上述两节，计算功函数（Work Function, $\Phi$）的标准流程如下：

### 步骤 1：运行计算
确保 `INPUT` 中包含 `out_pot 2` 和正确的偶极修正参数。运行 SCF 计算。

### 步骤 2：获取费米能级 ($E_F$)
计算结束后，查看输出日志（如 `OUT.ABACUS/running_scf.log`），找到最终的费米能级。

```text
...
Fermi Energy = -0.12345 Hartree
...
```
*注：ABACUS 内部单位通常为 Hartree 或 eV，请仔细核对日志中的单位说明。*

### 步骤 3：处理静电势文件
使用后处理工具（如 Python 脚本或 VESTA）读取生成的 `ElecStaticPot.cube` 文件。
我们需要做**平面平均（Planar Average）**：将三维势场 $V(x, y, z)$ 在 $x, y$ 平面上积分，得到沿 $z$ 轴的一维分布曲线 $V(z)$。

### 步骤 4：读取真空能级 ($V_{vac}$)
绘制 $V(z)$ 曲线。
*   **检查点**：在真空层区域，曲线应该呈现出一个平坦的“平台”（Plateau）。
*   如果曲线在真空层是倾斜的，说明偶极修正未生效或真空层太薄。
*   读取该平台处的数值，即为 $V_{vac}$。

### 步骤 5：计算功函数 ($\Phi$)

使用以下公式计算：

$$ \Phi = V_{vac} - E_F $$

---

## 3.4 专家锦囊 (Tips)

### 1. 单位换算至关重要
ABACUS 的 `.cube` 文件输出单位通常是 **Hartree (atomic unit)**。而我们在发表文章时通常使用 **eV**。
*   **换算因子**：$1 \text{ Hartree} \approx 27.2114 \text{ eV}$。
*   **建议**：在做减法公式之前，先将 $V_{vac}$ 和 $E_F$ 统一换算成 eV。即：
    $$ \Phi (\text{eV}) = (V_{vac}^{\text{Ha}} - E_F^{\text{Ha}}) \times 27.2114 $$

### 2. 如何判断偶极修正是否完美？
作图观察平面平均静电势 $V(z)$：
*   **无修正/修正失败**：真空区域的电势是一条斜线，左右两个真空边界的值不相等。
*   **修正成功**：真空区域是平的，且左右两侧的真空能级可能出现台阶（Step），这是正常的，因为非对称表面的两侧功函数本身就不同。我们通常取远离吸附物一侧（或你关心的那一侧）的真空能级。

### 3. 常见报错排查
如果你开启了 `dip_cor_flag 1` 但计算崩溃，请检查：
*   是否是表面体系？（必须有真空层）
*   `efield_pos_max` 是否设置在了原子上？（必须在真空里）
*   基组支持：ABACUS 的偶极修正支持平面波（PW）和数值原子轨道（LCAO）基组。

---

下一章，我们将进入具体的计算资源分配与并行效率优化，探讨如何让 ABACUS 跑得更快。

# 第四章：数据后处理：从三维势场到数值计算

在完成了耗时的 SCF 自洽计算后，我们得到了一系列原始数据文件。对于表面科学研究者而言，如何从这些数据中提取出**功函数 (Work Function)**、**表面偶极矩**等物理量，是连接计算与实验的关键一步。

本章将带你完成从原始 Log 文件和 3D Cube 文件到最终物理结论的全流程。我们将重点讨论如何正确处理静电势，这是新手最容易出错的环节。

---

## 4.1 提取费米能级 ($E_F$)

功函数 ($\Phi$) 的定义是真空能级 ($V_{vac}$) 与费米能级 ($E_F$) 之差。因此，第一步是获取体系的费米能级。

### 4.1.1 定位数据源
ABACUS 的费米能级信息记录在主输出日志文件中（通常命名为 `running_scf.log` 或 `running_${suffix}.log`）。

### 4.1.2 操作步骤
可以使用 `grep` 命令快速提取。在终端中执行：

```bash
grep "Fermi Energy" running_scf.log
```

### 4.1.3 输出示例与解读
你将看到类似如下的输出：

```text
Fermi Energy = -2.34567 eV
```

**注意**：
1.  ABACUS 输出的费米能级单位通常默认为 **eV**。
2.  对于半导体或绝缘体表面，费米能级可能位于带隙中；对于金属，它对应最高占据态。
3.  请记录下这个数值，记为 $E_F$。

---

## 4.2 平面平均静电势的处理

为了得到真空能级 $V_{vac}$，我们需要分析体系的静电势分布。ABACUS 计算结束后会输出 `.cube` 格式的势场文件，我们需要将其从三维数据降维处理为沿表面法向（通常为 Z 轴）的一维曲线。

### 4.2.1 关键参数设置 (INPUT)
在进行 SCF 计算前，必须在 `INPUT` 文件中正确设置 `out_pot` 参数。这是本章的**核心考点**：

| 参数名 | 设置值 | 物理含义 | 适用场景 |
| :--- | :--- | :--- | :--- |
| `out_pot` | **2** | **静电势 (Electrostatic Potential)** <br>包含：Hartree 势 + 离子局域赝势 | **计算功函数**、静电势分布 |
| `out_pot` | 1 | 总局域势 (Total Local Potential)<br>包含：静电势 + 交换关联势 (XC) | 能带对齐 (Band Alignment) 分析 |

> **警告**：计算功函数时，请务必使用 **`out_pot 2`**。如果错误地使用了 `out_pot 1`，虽然在真空层深处 XC 势趋于零，但在表面附近的势场行为会包含非物理的 XC 贡献，干扰“真空平台”的识别。

### 4.2.2 数据降维原理
`ElecStaticPot.cube` 文件包含空间网格点 $(x, y, z)$ 上的电势值 $V(x, y, z)$。我们需要计算**平面平均电势 (Planar Average Potential)** $\bar{V}(z)$：

$$ \bar{V}(z) = \frac{1}{S} \iint_{S} V(x, y, z) \, dx \, dy $$

其中 $S$ 是 $xy$ 平面的面积。这步操作消除了原子尺度上 $xy$ 平面的周期性起伏，只保留沿 $z$ 方向的宏观变化。

### 4.2.3 Python 处理脚本示例
虽然可以使用 VESTA 查看 3D 等势面，但为了定量计算，我们需要 Python 脚本。以下是一个基于 `Cubefile` 读取逻辑的简化处理流程：

```python
import numpy as np

def read_cube_and_average(filename):
    """
    读取 Cube 文件并计算 Z 方向的平面平均势
    注意：这里仅为逻辑演示，实际建议使用 ase.io.cube 或 pymatgen 读取
    """
    with open(filename, 'r') as f:
        # 跳过头部注释和原子信息，读取网格数据
        # ... (省略文件解析代码) ...
        # 假设 data 是一个形状为 (Nx, Ny, Nz) 的 3D numpy 数组
        pass 
    
    # 核心操作：沿 X 和 Y 轴求平均
    # axis=(0, 1) 对应 x, y 维度，保留 z 维度
    planar_avg = np.mean(data, axis=(0, 1))
    
    return planar_avg

# 假设读取到了数据
# data_z 包含了沿 Z 轴每个网格点的电势值 (单位: Hartree)
# z_coords 是对应的 Z 轴坐标 (单位: Bohr)
```

**推荐工具**：
- 社区常用工具：`vaspkit` (部分兼容 cube) 或专门针对 ABACUS 开发的后处理脚本 `abacus-kit` (如有)。
- 通用方法：使用 `ASE` (Atomic Simulation Environment) 读取 cube 文件后进行平均。

---

## 4.3 确定真空能级与单位换算

得到 $\bar{V}(z)$ 曲线后，我们就可以计算功函数了。

### 4.3.1 识别真空平台 (Vacuum Plateau)
使用绘图软件（如 Matplotlib 或 Origin）绘制 $\bar{V}(z)$ 随 $z$ 变化的曲线。
- **原子层区域**：电势剧烈震荡，对应原子核和电子云的分布。
- **真空层区域**：电势应趋于一条平直的直线。

**操作**：读取该平直区域的数值，即为真空能级 $V_{vac}$。

### 4.3.2 核心公式与单位陷阱
这是新手最容易发生数量级错误的地方。

**公式**：
$$ \Phi = V_{vac} - E_F $$

**单位换算**：
- **$E_F$ (来自 log)**: 单位通常是 **eV**。
- **$V_{vac}$ (来自 cube)**: ABACUS 的 `.cube` 文件输出单位通常是 **Hartree (atomic unit)**。

因此，实际计算公式为：

$$ \Phi \text{ (eV)} = \left( V_{vac}^{\text{cube}} \times 27.2114 \right) - E_F^{\text{log}} $$

> **常数说明**: 1 Hartree $\approx$ 27.211386 eV。教程中推荐保留 4 位小数使用 **27.2114**。

### 4.3.3 实例计算
假设我们得到以下数据：
1.  从 `running_scf.log` 读取到 $E_F = -2.50$ eV。
2.  从 `ElecStaticPot.cube` 处理得到的平面平均图上，读取到真空平台高度为 $0.15$ a.u. (Hartree)。

计算过程：
$$ V_{vac} (\text{eV}) = 0.15 \times 27.2114 = 4.0817 \text{ eV} $$
$$ \Phi = 4.0817 - (-2.50) = 6.58 \text{ eV} $$

该表面的功函数为 6.58 eV。

---

## 附录：常见报错与避坑指南

在后处理过程中，如果得到的图像或数值异常，请检查以下几点：

### 1. 锯齿位置错误 (Dipole Correction Artifacts)
如果你在 `INPUT` 中开启了偶极修正（`efield_flag 1`），ABACUS 会在由 `efield_pos_max` 指定的位置引入一个电势阶跃（锯齿）来抵消人工电场。
- **正常现象**：电势阶跃出现在真空层中间，且该处没有原子。
- **错误现象**：电势阶跃穿过了原子层，导致原子区域的电势发生非物理断裂。
- **对策**：调整 `efield_pos_max`（0~1 之间的分数坐标），确保它位于真空层的正中央。

### 2. 真空层不足 (Insufficient Vacuum)
- **现象**：在 $\bar{V}(z)$ 图中，真空区域没有出现平坦的“平台”，而是呈现倾斜或抛物线形状，或者两个相邻表面的电势波函数还没衰减完就互相重叠了。
- **后果**：无法准确读取 $V_{vac}$，功函数计算失效。
- **对策**：增加 `STRU` 文件中的晶格矢量 $z$ 分量长度，加厚真空层（通常建议至少 15-20 Å）。

### 3. 单位混淆
- **现象**：计算出的功函数数值大得离谱（例如 > 100 eV）或非常小。
- **检查**：确认你是否忘记将 Cube 文件中的数值乘以 27.2114。务必牢记：**Cube 文件是 Hartree，Log 文件是 eV**。

---

## 附录：进阶学习指南

恭喜你完成了本书的学习！掌握功函数的计算只是探索表面科学的第一步。为了进一步提升你的研究深度，我们建议你在以下方向继续探索：

### 1. 进阶主题推荐
- **外加电场模拟**：在理解了偶极修正的基础上，尝试通过 `efield_amp` 参数在真空层施加外电场，模拟电催化或场发射环境。
- **补偿电荷与溶剂化模型**：对于涉及带电表面或固液界面的体系，研究如何利用补偿电荷（Compensating Charge）来平衡超胞电荷，并结合 ABACUS 的溶剂化模型进行更贴近实际环境的模拟。
- **表面吸附与覆盖度效应**：探索不同吸附质（如 O, CO, H）对金属表面功函数的影响，理解表面偶极矩如何随覆盖度变化。

### 2. 通用调试建议（Troubleshooting）
- **势场不平坦？** 如果发现真空层的静电势曲线没有出现预期的“平台”，请首先检查真空层厚度是否足够（通常需 >15 Å），其次确认偶极修正的锯齿势位置（`efield_pos_max`）是否正确放置在真空区域中。
- **数值偏差过大？** 请务必确认 `out_pot` 是否设置为 `2`。设置为 `1` 会包含交换关联势，这会导致提取出的“功函数”与实验值产生显著偏差。
- **收敛困难？** 表面体系往往具有较多原子，建议先进行粗糙的结构优化，再使用高质量基组进行静态计算。

### 3. 官方资源与社区
- **官方文档**：请经常访问 [ABACUS User Guide](https://mcresearch.github.io/abacus-user-guide/) 获取最新的参数说明与更新日志。
- **开源脚本库**：在处理 3D Cube 文件或进行平面平均电势处理时，推荐使用 ABACUS 社区提供的 Python 后处理工具包，以提高科研效率。

科学探索是一场马拉松，愿 ABACUS 成为你手中最锋利的凿子，助你开辟微观世界的真理之路。
