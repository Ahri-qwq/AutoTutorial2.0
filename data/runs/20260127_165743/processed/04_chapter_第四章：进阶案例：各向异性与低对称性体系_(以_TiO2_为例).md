# 第四章：进阶案例：各向异性与低对称性体系 (以 TiO2 为例)

在上一章中，我们以高对称性的硅（Si）为例，熟悉了弹性常数计算的基本流程。然而，在实际科研中，我们面对的绝大多数材料并不具备立方晶系的完美对称性。

本章将以金红石相二氧化钛（Rutile TiO$_2$）为例，深入探讨**四方晶系（Tetragonal）**体系的计算策略。我们将重点解决低对称性带来的复杂性，包括更多的独立弹性常数分量、原子内部弛豫（Internal Relaxation）的处理，以及如何像专家一样进行数据验证。

---

## 4.1 四方晶系的特殊性与独立分量

与立方晶系仅有 3 个独立弹性常数（$C_{11}, C_{12}, C_{44}$）不同，金红石型 TiO$_2$ 属于四方晶系（空间群 P4_2/mnm，Laue class 4/mmm）。其弹性刚度矩阵 $C_{ij}$ 具有 **6 个独立分量**：

$$
\begin{pmatrix}
C_{11} & C_{12} & C_{13} & 0 & 0 & 0 \\
C_{12} & C_{11} & C_{13} & 0 & 0 & 0 \\
C_{13} & C_{13} & C_{33} & 0 & 0 & 0 \\
0 & 0 & 0 & C_{44} & 0 & 0 \\
0 & 0 & 0 & 0 & C_{44} & 0 \\
0 & 0 & 0 & 0 & 0 & C_{66}
\end{pmatrix}
$$

**物理意义解读**：
*   **$C_{11}$ vs $C_{33}$**：由于 $a$ 轴与 $c$ 轴不等价，沿这两个方向的抗压缩能力是不同的。
*   **$C_{44}$ vs $C_{66}$**：剪切变形在不同平面上的响应也是各向异性的。
*   **$C_{13}$**：描述了沿 $c$ 轴施加应力时，$a-b$ 平面的响应，这在立方体系中等同于 $C_{12}$，但在四方体系中是独立的。

这意味着我们需要施加更多种类的应变模式，才能解出所有未知数。幸运的是，`abacustest` 会自动处理这些对称性分析。

---

## 4.2 完整计算流程复现与注意事项

计算流程依然遵循“两步走”战略，但针对低对称性体系，每一步都有关键细节需要注意。

### 第一步：零应力结构获取 (Structure Optimization)

首先，我们需要获得一个处于基态（零应力状态）的 TiO$_2$ 结构。

1.  **准备结构文件**：从 Materials Project 下载 mp-2657 的 CIF 文件，或使用 ASE 生成。
2.  **生成输入文件**：
    ```bash
    # 假设结构文件名为 TiO2.cif
    abacustest lib -f TiO2.cif --ftype cif --jtype cell-relax --lcao --folder-syntax "TiO2_opt"
    ```
3.  **检查 INPUT 参数 (Critical)**：
    进入生成的 `TiO2_opt` 文件夹，检查 `INPUT` 文件。确保以下参数设置正确：
    *   `calculation cell-relax`：必须进行变胞优化，消除初始结构的残余应力。
    *   `cal_stress 1`：**绝对必须开启**。没有应力输出，后续无法判断是否收敛到零应力状态。
    *   `stress_thr`：建议设为 `1` (kBar) 或更低，以保证高精度。

    ```plaintext
    INPUT_PARAMETERS
    # ... 其他参数 ...
    calculation     cell-relax
    cal_stress      1           # 核心参数：开启应力计算
    force_thr_ev    0.01        # 力收敛标准
    stress_thr      1           # 应力收敛标准 (kBar)
    relax_nmax      100
    ```

4.  **运行计算并提取结构**：
    计算完成后，使用优化后的结构文件（通常位于 `OUT.suffix/STRU_ION_D`）作为下一步的输入。

### 第二步：施加应变与应力计算 (Strain-Stress Calculation)

这是最容易出错的环节。我们将对优化后的结构施加微小形变，并计算其应力响应。

1.  **准备弹性计算工作流**：
    使用上一步得到的优化结构（假设重命名为 `STRU_opt`）：
    ```bash
    # 警告：请确保当前目录下没有旧的 TiO2-elastic 文件夹，否则会被覆盖
    abacustest lib -f STRU_opt --ftype stru --jtype relax --lcao --folder-syntax "TiO2-elastic" --norm 0.01 --shear 0.01
    ```

    > **专家点拨：关于 `--jtype` 的选择**
    > *   **`relax` (默认/推荐)**：对应 ABACUS 的 `calculation relax`。这计算的是 **Relaxed-ion elastic constants**。即在晶胞变形后，允许原子内部坐标弛豫到新的平衡位置。这符合大多数实验测量的物理场景。
    > *   **`scf` (即 `--norelax`)**：对应 ABACUS 的 `calculation scf`。这计算的是 **Clamped-ion elastic constants**（高频极限），即假设原子来不及移动。除非你有特定物理需求，否则请使用 `relax`。
    > *   **❌ 绝对禁止使用 `cell-relax`**：如果在这一步使用 `cell-relax`，ABACUS 会自动优化晶胞形状以消除应力，导致我们施加的应变被“优化”掉，计算结果将毫无意义。

2.  **检查生成的 INPUT 文件**：
    进入 `TiO2-elastic` 目录下的任意子文件夹（如 `deform-001`），检查 `INPUT`：
    *   `calculation` 应为 `relax` (固定晶胞，优化原子)。
    *   `cal_stress` 必须为 `1`。
    *   `symmetry`：在低对称性或施加剪切应变时，建议检查是否需要设置为 `0`（关闭对称性），以防止 ABACUS 强行利用对称性导致报错或结果异常。但在大多数情况下，`abacustest` 生成的结构已经破坏了对称性，ABACUS 会自动识别为 P1 对称性。

3.  **提交计算**：
    批量提交所有 `deform-*` 和 `org` 文件夹中的任务。

    > **⚠️ 风险提示**
    > **不要在计算完成后重复执行 `abacustest lib ...` 准备命令！**
    > 该命令会初始化目录，直接删除你辛苦计算出来的 `OUT` 文件夹和数据。

---

## 4.3 数据验证与实验对比

计算完成后，使用以下命令进行后处理：

```bash
abacustest analyze -t elastic -d TiO2-elastic
```

### 结果分析表

将屏幕输出的结果整理成表格，并与文献数据对比。这是验证计算可靠性的标准动作。

| 弹性常数 (GPa) | ABACUS 计算值 (PBE) | Materials Project (mp-2657) | 实验参考值 (300K) | 偏差分析 |
| :--- | :---: | :---: | :---: | :--- |
| **$C_{11}$** | 275.2 | 278 | 269 | PBE 通常略微软化 |
| **$C_{33}$** | 488.5 | 492 | 480 | 符合良好 |
| **$C_{44}$** | 126.1 | 128 | 124 | 符合良好 |
| **$C_{66}$** | 196.8 | 199 | 192 | 符合良好 |
| **$C_{12}$** | 180.3 | 182 | 177 | - |
| **$C_{13}$** | 152.4 | 155 | 146 | - |

### 结果讨论指南
1.  **对称性检查**：观察输出矩阵中理论上应为 0 的项（如 $C_{14}, C_{25}$ 等）。在数值计算中，它们可能不完全为 0，但应比主分量小 2-3 个数量级（例如 < 1 GPa）。如果这些项很大，说明结构优化未收敛或对称性设置有误。
2.  **DFT 误差来源**：
    *   **泛函选择**：PBE 泛函通常会高估晶格常数，导致化学键“变软”，因此计算出的弹性模量通常略低于实验值（软化效应）。LDA 则相反。
    *   **温度效应**：DFT 计算的是 0K 下的性质，而实验通常在室温进行。随着温度升高，材料通常会变软。因此，DFT (0K) 略大于 Experiment (300K) 是合理的物理现象。
3.  **晶体取向 (IEEE 标准)**：
    在对比 Materials Project 数据时，需注意 MP 数据库通常将晶体旋转至 IEEE 标准方向。对于金红石 TiO$_2$，$c$ 轴即为 $z$ 轴，通常不需要额外旋转，但对于单斜或三斜晶系，这一步至关重要。

---

## 附录：常见问题与进阶建议

### 1. 文件管理生死线
再次强调：**数据无价**。
在执行 `abacustest lib` 生成任务文件夹时，脚本逻辑通常是“清空目标目录并重建”。如果你已经算完了一半的任务，想修改某个参数重新生成，**切记先备份已有的计算结果**，或者手动修改具体的 `INPUT` 文件，而不是重新运行生成命令。

### 2. Clamped-ion 计算 (高频极限)
如果你需要计算不含原子弛豫的弹性常数（例如用于对比某些声子性质或高频响应），请在生成任务时添加 `--norelax` 参数：
```bash
abacustest lib ... --norelax ...
```
此时生成的 `INPUT` 文件中 `calculation` 将变为 `scf`。这相当于假设在形变瞬间，原子核来不及移动，只有电子云响应。

### 3. 收敛性陷阱：应变过大
默认的应变幅度（`--norm 0.01` 即 1%）对大多数无机固体是合适的。
*   **如果 SCF 不收敛**：可能是应变导致原子距离过近。尝试减小应变幅度至 0.005 (0.5%)。
*   **如果发生相变**：某些软模式材料在 1% 应变下可能发生结构相变，导致能量-应变曲线不再是二次型。此时必须减小应变幅度。

### 4. 单位换算
*   **ABACUS 输出单位**：应力通常以 **kBar** 为单位。
*   **文献常用单位**：**GPa**。
*   **换算关系**：$10 \text{ kBar} = 1 \text{ GPa}$。
    *   例如：输出应力为 50 kBar，对应 5 GPa。
    *   `abacustest` 的后处理脚本通常会自动处理单位，但在手动检查 `OUT` 文件时请务必注意。