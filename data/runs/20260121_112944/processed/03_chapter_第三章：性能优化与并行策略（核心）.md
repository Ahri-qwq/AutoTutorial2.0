# 第三章：性能优化与并行策略（核心）

在计算材料学中，杂化泛函（Hybrid Functionals，如 HSE06, PBE0）因其能更准确地描述带隙和电子局域化行为而被广泛使用。然而，天下没有免费的午餐——杂化泛函引入的精确交换相互作用（Exact Exchange, EXX）项，使得计算复杂度从标准 DFT 的 $O(N^3)$ 飙升至 $O(N^4)$ 甚至更高。

对于 ABACUS 用户而言，如果不进行针对性的优化，一个中等体系的杂化泛函计算可能会轻易耗尽节点内存（OOM）或运行数周无法收敛。本章将揭示 ABACUS 内核中针对 EXX 的并行逻辑，并提供一套经过实战检验的参数配置策略。

---

## 3.1 混合并行策略与内存管理

在 LCAO 基组下计算 EXX 项时，内存带宽和容量通常是最大的瓶颈。ABACUS 采用 **MPI（多进程）** 与 **OpenMP（多线程）** 混合并行的模式。理解二者的区别是优化的第一步：

*   **MPI 进程**：每个进程拥有独立的内存空间。增加 MPI 进程数会显著增加总内存消耗，因为每个进程都需要复制一份基础数据（如基组信息、格点数据等）。
*   **OpenMP 线程**：线程间共享内存。增加线程数几乎不增加内存消耗，主要用于加速计算密集型的循环（如四中心积分）。

### 3.1.1 “多线程、少进程”的黄金法则

针对杂化泛函计算，**内存通常比 CPU 算力更早成为瓶颈**。因此，我们的黄金法则是：**在节点内尽可能开满 OpenMP 线程，尽量减少 MPI 进程数。**

#### 极端内存受限场景（推荐默认方案）
如果你的体系较大（例如 > 200 原子），或者内存紧张，建议**每个计算节点只开启 1 个 MPI 进程**，将节点内的所有物理核心分配给 OpenMP。

**案例**：假设使用 3 个计算节点，每个节点有 56 个物理核心。
*   **Shell 提交脚本设置**：
    ```bash
    # 设置 OpenMP 线程数为 56
    export OMP_NUM_THREADS=56
    
    # 启动 MPI，总共 3 个进程，每个节点 1 个进程
    # -np 3: 总进程数
    # -ppn 1: 每个节点的进程数 (processes per node)
    mpirun -np 3 -ppn 1 abacus
    ```
    *注：具体 MPI 启动参数（如 `-ppn`, `--map-by ppr:1:node`）取决于你的集群调度系统（Slurm/PBS）和 MPI 版本（IntelMPI/OpenMPI）。*

#### 内存充裕时的性能压榨
虽然“1 节点 1 进程”最省内存，但某些计算步骤（如哈密顿量对角化、格点积分）在 MPI 并行下效率更高。如果**确认内存足够**（例如体系较小，或拥有大内存节点），可以适当增加 MPI 进程数以提升整体速度。

**案例**：同上硬件，但体系较小（如 64 原子的 Si），追求极致速度。
*   **配置策略**：尝试每节点 4 进程，每进程 14 线程（4 * 14 = 56 核）。
    ```bash
    export OMP_NUM_THREADS=14
    mpirun -np 12 -ppn 4 abacus
    ```
    *警告：一旦发生 `std::bad_alloc` 或被系统 Kill，请立即回退到“1 节点 1 进程”方案。*

---

## 3.2 自洽迭代循环算法的选择

杂化泛函的自洽场（SCF）收敛往往比普通 GGA 更困难。ABACUS 提供了参数 `exx_separate_loop` 来控制 EXX 的更新策略，这直接决定了内存占用和收敛行为。

### 3.2.1 两种循环模式对比

在 `INPUT` 文件中设置：

#### 模式 0：单层循环 (`exx_separate_loop 0`)
*   **逻辑**：在每一次 SCF 迭代中，同时更新 GGA 势场和 EXX 势场。
*   **优点**：收敛性质较好，适用于电子结构复杂、难以收敛的体系。
*   **缺点**：**内存消耗巨大**。为了通过 `mixing_ndim` 进行历史信息的混合（Charge Mixing），程序需要存储多步的密度矩阵或势场信息，这对 EXX 计算来说是沉重的负担。
*   **适用场景**：小体系、磁性体系、绝缘体-金属相变体系。

#### 模式 1：双层循环 (`exx_separate_loop 1`)
*   **逻辑**：
    *   **外层循环（Blue Loop）**：更新构建 EXX 势场。
    *   **内层循环（Red Loop）**：固定 EXX 势场，只更新 GGA 部分，直到电荷密度变化 `DRHO` 小于 `scf_thr`。
*   **优点**：**极度节省内存**。不需要存储用于混合的历史 EXX 矩阵。
*   **缺点**：总迭代步数可能增加。虽然单步 EXX 计算次数减少，但内层 GGA 循环次数会显著增多。
*   **适用场景**：**大体系（推荐默认）**、内存受限环境、宽带隙绝缘体。

### 3.2.2 决策树：我该选哪种？

```mermaid
graph TD
    A[开始 EXX 计算] --> B{内存是否紧张?}
    B -- 是 --> C[exx_separate_loop 1 (双层循环)]
    B -- 否 --> D{体系是否难以收敛?}
    D -- 是 (如磁性/金属) --> E[exx_separate_loop 0 (单层循环)]
    D -- 否 (如标准半导体) --> C
```

**实战数据参考**（1024 原子 Si 晶体）：
*   **双层循环**：峰值内存 105 GB，总耗时 2591s。
*   **单层循环**：峰值内存 116 GB，总耗时 2062s。
*   *结论*：在内存不溢出的前提下，单层循环可能更快；但为了稳定性，双层循环是处理大体系的安全牌。

---

## 3.3 基组选择的性能陷阱

在 LCAO 方法中，EXX 计算量的物理标度极其陡峭。很多初学者习惯于“无脑”增加精度，这在杂化泛函计算中是致命的。

### 3.3.1 截断半径的幂律灾难 ($R_{cut}^9$)
EXX 的计算量与原子轨道截断半径 $R_{cut}$ 呈约 **9 次方** 的关系。
$$ Cost \propto (R_{cut})^9 $$

*   **陷阱**：在 `STRU` 文件中随意将 $R_{cut}$ 从 7.0 改为 10.0。
*   **后果**：计算时间可能暴增 3-5 倍。
    *   *实测*：Rcut=7au (106s) vs Rcut=10au (282s)。
*   **建议**：**严格使用 ABACUS 官方提供的默认轨道文件**。官方轨道经过了仔细的优化，在精度和 $R_{cut}$ 之间取得了平衡。除非由于重元素或极高压环境导致基组完备性严重不足，否则不要手动增大 $R_{cut}$。

### 3.3.2 基组数目的四次方关系 ($N^4$)
EXX 计算量与基组函数总数 $N$ 呈 4 次方关系。

*   **对比**：
    *   **DZP (Double Zeta + Polarization)**：通常足够精确，性价比最高。
    *   **TZDP (Triple Zeta + Polarization)**：精度略有提升，但计算量剧增。
    *   *实测*：DZP (106s) vs TZDP (612s)。
*   **建议**：对于杂化泛函，**坚持使用 DZP 基组**。如果需要验证精度，可仅在单点能计算时尝试 TZDP，结构优化务必使用 DZP。

---

## 3.4 数值加速技巧

除了并行和算法选择，ABACUS 还提供了一些利用物理特性进行数值加速的参数。

### 3.4.1 实数域计算 (`exx_real_number`)

EXX 计算依赖于实空间的密度矩阵 $D(R)$。
*   **原理**：如果体系具有中心反演对称性，且无自旋轨道耦合（SOC），密度矩阵的虚部理论上为零。
*   **参数设置**：
    ```bash
    # INPUT 文件
    exx_real_number 1  # 强制在实数域计算 EXX
    ```
*   **效果**：将复数运算转为实数运算，计算速度可提升 **2 倍以上**（实测 106s vs 270s）。
*   **适用条件**：
    1.  无自旋轨道耦合（`lspinorb 0`）。
    2.  非螺旋磁性结构。
    3.  绝大多数常规的绝缘体和半导体计算。

### 3.4.2 辅助格点积分精度 (`exx_ccp_rmesh_times`)

ABACUS 使用库伦约束的投影（CCP）或类似的辅助格点技术来处理四中心积分。
*   **参数**：`exx_ccp_rmesh_times`（默认值通常为 1.5 或更高，具体视版本而定）。
*   **含义**：控制辅助积分格点相对于主格点的密度倍数。
*   **调节策略**：
    *   降低该值（例如设为 1.5）：减少辅助格点数，显著加速积分过程，但可能损失微小的精度。
    *   增加该值：提高积分精度，减速。
*   **建议**：保持默认值，仅在极度追求速度且对精度要求不高（如预弛豫阶段）时尝试调低。

---

## 本章总结：EXX 性能优化清单

在提交杂化泛函任务前，请对照以下清单检查：

1.  **并行检查**：是否设置了 `OMP_NUM_THREADS`？是否遵循了“1 节点 1 进程”或“少进程多线程”原则？
2.  **循环策略**：内存是否紧张？如果是，请设置 `exx_separate_loop 1`。
3.  **基组检查**：是否使用了官方推荐的 DZP 轨道？`STRU` 中的 `Rcut` 是否被不必要地改大了？
4.  **物理加速**：如果体系允许（无 SOC），是否开启了 `exx_real_number 1`？

遵循以上策略，你将在 ABACUS 中获得兼具速度与精度的杂化泛函计算体验。