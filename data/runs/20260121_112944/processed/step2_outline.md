<!-- META_START -->
# ABACUS 实战教程：杂化泛函高效计算指南

## 前言
- **本书逻辑**: 本教程旨在帮助用户掌握在 ABACUS 中使用杂化泛函（Hybrid Functionals）进行高精度电子结构计算的方法。逻辑上遵循“理论认知 -> 环境准备 -> 基础运行 -> 性能调优 -> 进阶配置”的路径。特别针对杂化泛函计算量大、内存消耗高的痛点，将“性能优化与并行策略”作为核心章节重点阐述。
- **核心知识点**: 杂化泛函物理原理、LibRI 库编译依赖、LCAO 基组下的参数设置、混合并行策略（MPI+OpenMP）、自洽迭代的双层循环算法、EXX 计算加速技巧。

<!-- CHAPTER_START -->
## 第一章：杂化泛函基础与环境准备
**本章逻辑**: 在动手计算前，用户必须理解杂化泛函解决了什么物理问题，以及 ABACUS 运行此类计算所需的特殊编译环境，这是避免“未定义泛函”报错的第一步。

### Section 1.1: 物理背景与适用场景
- **内容**: 简述杂化泛函通过引入 Hartree-Fock 精确交换能（EXX）修正 DFT 自相互作用误差（SIE）的原理。明确其在半导体带隙修正、强关联体系及局域化电子态描述中的优势。
- **关键参数**: 无

### Section 1.2: 编译依赖与安装检查
- **内容**: 详解 ABACUS 杂化泛函功能的编译要求，重点强调必须链接 `Libxc`（泛函库）、`LibRI`（电子积分库）和 `LibComm`。说明如何通过 `git submodule` 获取依赖，以及如何排查因缺库导致的运行时错误。
- **关键参数**: 无（涉及编译选项，非 INPUT 参数）

<!-- CHAPTER_START -->
## 第二章：标准计算流程与输入参数
**本章逻辑**: 建立一个最小可运行的杂化泛函计算案例。从输入文件设置到基组选择，确保用户能跑通第一个任务。

### Section 2.1: 核心输入参数设置
- **内容**: 讲解如何在 `INPUT` 文件中激活杂化泛函。介绍不同泛函（HSE, PBE0, HF）的指定方式，以及 LCAO 基组模式的选择。强调由于库伦势长程相互作用，杂化泛函对 K 点密度的需求可能高于普通 DFT。
- **关键参数**: `dft_functional` (推荐 hse/pbe0), `basis_type` (推荐 lcao)

### Section 2.2: 自动化参数与默认行为
- **内容**: 说明当指定 `dft_functional` 后，程序如何自动设定 EXX 混合比例和屏蔽参数。解释为何初学者应优先使用默认值以平衡精度与速度。
- **关键参数**: `exx_fock_alpha` (自动), `exx_erfc_omega` (自动)

<!-- CHAPTER_START -->
## 第三章：性能优化与并行策略（核心）
**本章逻辑**: 杂化泛函计算极度消耗资源，不当的设置会导致计算旷日持久甚至内存溢出。本章是本教程的重中之重，指导用户如何通过并行策略和算法选择来“压榨”机器性能。

### Section 3.1: 混合并行策略与内存管理
- **内容**: 深入剖析 EXX 计算的内存瓶颈。阐述“多线程（OpenMP）、少进程（MPI）”的黄金法则。提供具体的并行配置案例（如单节点全线程 vs 单节点 4 进程），指导用户如何在计算速度和内存消耗之间寻找平衡点，避免 OOM（内存溢出）。
- **关键参数**: `OMP_NUM_THREADS` (环境变量), MPI 进程数 (`-np`)

### Section 3.2: 自洽迭代循环算法的选择
- **内容**: 详解 `exx_separate_loop` 的两种模式。对比“单层循环”（同时更新 GGA+EXX，收敛好但费内存）与“双层循环”（外层 EXX 内层 GGA，省内存但步骤多）的优劣。提供基于体系收敛难易度和硬件内存限制的决策树。
- **关键参数**: `exx_separate_loop` (0 或 1), `mixing_ndim`

### Section 3.3: 基组选择的性能陷阱
- **内容**: 揭示 EXX 计算量与原子轨道截断半径（$R_{cut}^9$）及基组数目（$N^4$）的幂律关系。警告盲目增加基组精度（如 dzp -> tzdp）带来的巨大性能代价，建议使用官方默认优化基组。
- **关键参数**: 涉及 STRU 文件中的原子轨道定义 (Rcut, Zeta 数目)

### Section 3.4: 数值加速技巧
- **内容**: 介绍在特定物理条件下（如无自旋轨道耦合、中心反演对称）利用实数域计算加速的方法。讲解辅助格点积分精度的调节对速度的影响。
- **关键参数**: `exx_real_number`, `exx_ccp_rmesh_times`

<!-- CHAPTER_START -->
## 第四章：进阶配置与自定义泛函
**本章逻辑**: 针对有特殊科研需求的用户，介绍如何微调杂化泛函的内部参数，以及处理收敛性问题。

### Section 4.1: 自定义杂化参数
- **内容**: 指导用户如何手动修改 Hartree-Fock 交换项的混合比例（Alpha）和范围分离参数（Omega），以满足特定体系（如宽禁带半导体）的特殊物理需求。
- **关键参数**: `exx_fock_alpha`, `exx_erfc_omega`

### Section 4.2: 收敛性问题处理
- **内容**: 探讨在双层循环模式下可能遇到的收敛震荡问题，以及如何切换回单层循环或调整混合参数来解决。
- **关键参数**: `exx_separate_loop`, `scf_thr`

<!-- APPENDIX_START -->
## 附录：常见问题排查 (Troubleshooting)
- **报错解析**: "Unrecognized exchange-correlation functional", "compile with libri..." 等常见错误的原因与解法。
- **性能清单**: 遇到计算太慢或内存不足时的快速检查清单（Checklist）。