# 第二章：标准计算流程与输入参数

欢迎来到 ABACUS 实战教程的第二章。在上一章中，我们完成了软件的安装与环境配置。本章我们将直接进入“深水区”，构建一个最小可运行的**杂化泛函（Hybrid Functional）**计算案例。

作为一名资深开发者，我深知杂化泛函（如 HSE06）在带隙预测和缺陷能级计算中的重要性，但其高昂的计算成本往往让初学者望而却步。ABACUS 的优势在于其基于数值原子轨道（LCAO）的高效杂化泛函实现。本章将指导你如何通过极其精简的参数设置，正确跑通第一个 HSE 任务。

---

## Section 2.1: 核心输入参数设置

在 ABACUS 中，激活杂化泛函并不复杂，但由于其底层物理实现的特殊性（涉及精确交换项 Exact Exchange, EXX 的计算），我们需要在 `INPUT` 文件中格外注意泛函类型与基组模式的匹配。

### 1. 激活杂化泛函 (`dft_functional`)

这是最关键的一步。不同于常见的 PBE 计算，你需要显式指定杂化泛函的名称。

*   **参数名**: `dft_functional`
*   **推荐值**: `hse` (对应 HSE06) 或 `pbe0`
*   **注意**: 请确保你在编译或安装 ABACUS 时包含了 `Libxc`、`LibRI` 和 `LibComm` 库。如果缺少这些依赖，程序会报错 `Unrecognized exchange-correlation functional` 或提示需编译 LibRI。

### 2. 选择基组模式 (`basis_type`)

虽然 ABACUS 支持平面波（PW）基组，但对于杂化泛函计算，**强烈推荐**使用 LCAO（线性组合原子轨道）基组。

*   **参数名**: `basis_type`
*   **推荐值**: `lcao`
*   **原理**: 杂化泛函计算涉及四中心积分，计算量随基组大小呈 $N^4$ 甚至更高次方的增长。LCAO 基组的定域性和稀疏性可以极大地降低计算成本。相比之下，平面波基组在处理 EXX 项时通常需要极高的截断能，导致计算极其缓慢。

### 3. K 点设置的特殊考量

在 `KPT` 文件中设置 K 点时，需要注意杂化泛函对 K 点密度的敏感性。

*   **物理背景**: 杂化泛函中的库伦势具有长程相互作用（$1/r$），在倒空间中对应 $1/q^2$ 的奇异性。虽然 ABACUS 内部使用了辅助函数处理奇异点，但为了获得收敛的交换能，杂化泛函计算通常需要比普通 GGA 计算**更密集的 K 点网格**。
*   **建议**: 如果你在 PBE 计算中使用了 $4 \times 4 \times 4$ 的网格，在 HSE 计算中可能需要测试 $6 \times 6 \times 6$ 以确保精度。

### 4. 最小可运行 `INPUT` 示例

以下是一个针对硅（Si）晶体的标准 HSE06 计算 `INPUT` 文件模板：

```fortran
INPUT_PARAMETERS
# 1. 一般控制参数
suffix              si_hse_test   # 任务后缀名，用于区分输出文件
calculation         scf           # 计算类型：自洽场计算
symmetry            1             # 开启对称性分析

# 2. 基组与精度控制
basis_type          lcao          # 【关键】使用 LCAO 基组
ecutwfc             60            # 平面波截断能（用于格点积分网格），单位 Ry
scf_thr             1.0e-6        # 自洽收敛阈值
scf_nmax            100           # 最大迭代步数

# 3. 杂化泛函核心设置
dft_functional      hse           # 【关键】激活 HSE06 泛函
```

> **教授的“避坑”指南**：
> 很多初学者会直接复用 PBE 的 `INPUT` 文件，仅修改 `dft_functional`。请务必检查 `basis_type` 是否为 `lcao`。如果你在 `pw` 模式下强行运行 HSE，虽然程序可能不会立即崩溃，但通过 GPU/DCU 加速时通常仅支持 PW 基组的常规 DFT，而 LCAO 才是 CPU 上跑杂化泛函的主力。

---

## Section 2.2: 自动化参数与默认行为

ABACUS 的设计哲学之一是“智能默认”。当你在 `INPUT` 中指定了 `dft_functional` 后，程序会自动配置一系列复杂的底层参数。理解这些默认行为，有助于你在不牺牲精度的前提下“躺平”计算。

### 1. 自动化的 EXX 参数 (`exx_...`)

杂化泛函的通用形式通常包含一部分 Hartree-Fock 交换能（EXX）。以 HSE06 为例，其交换关联泛函中混合了 25% 的短程 HF 交换能。

在 ABACUS 中，当你设置 `dft_functional hse` 时，程序会自动设定以下参数，**通常无需用户手动修改**：

*   **`exx_fock_alpha`**: 自动设为 **0.25**。
    *   *含义*: 混合参数 $\alpha$，代表 HF 交换能的比例。
*   **`exx_erfc_omega`**: 自动设为 **0.11** (单位 $Bohr^{-1}$)。
    *   *含义*: 屏蔽参数 $\omega$，用于控制库伦相互作用的范围（Range-separation）。HSE06 的标准定义即为 $\omega = 0.11$。

**何时需要修改？**
仅当你需要计算带隙与实验值严格匹配的体系（如某些宽禁带半导体），或者进行 PBE0 计算（此时 $\omega=0$）时，才需要手动覆盖这些参数。

### 2. 性能相关的默认行为与调整

杂化泛函计算极其消耗资源。ABACUS 提供了一些高级参数来平衡速度与内存，虽然有默认值，但建议用户根据机器配置进行调整。

#### A. 自洽迭代循环模式 (`exx_separate_loop`)
ABACUS 提供了两种处理 EXX 势更新的策略：

*   **`exx_separate_loop 1` (双层循环)**:
    *   *逻辑*: 外层循环更新 EXX 势，内层循环只更新 GGA 势。
    *   *优势*: **内存消耗较低**。
    *   *劣势*: 总耗时可能略长。
*   **`exx_separate_loop 0` (单层循环)**:
    *   *逻辑*: 每一步同时更新 GGA 和 EXX。
    *   *优势*: **收敛性较好**，适合难收敛体系。
    *   *劣势*: 内存消耗较高（需额外存储历史密度矩阵）。

> **实战建议**: 默认情况或内存受限时，保持默认或手动设为 `1`。如果发现 SCF 震荡不收敛，尝试改为 `0`。

#### B. 实数/复数优化 (`exx_real_number`)
*   **参数名**: `exx_real_number`
*   **默认行为**: 程序通常默认处理复数情况以保证通用性。
*   **优化技巧**: 如果你确定体系具有时间反演对称性且 K 点包含 $\Gamma$ 点等情况，使得密度矩阵 $D(R)$ 的虚部始终为零（绝大多数绝缘体基态计算），可以显式设置：
    ```fortran
    exx_real_number 1
    ```
    这将强制 EXX 在实数域计算，**速度通常可提升 2 倍以上**（例如单步 EXX 耗时从 270s 降至 106s）。

### 3. 截断半径与基组大小（隐性影响）

虽然这不是 `INPUT` 里的参数，但必须在此提及。EXX 计算量与原子轨道截断半径（$R_{cut}$）的 9 次方成正比（$R_{cut}^9$），与基组数量的 4 次方成正比（$N^4$）。

*   **默认行为**: ABACUS 官网提供的标准轨道文件（如 `Si_gga_7au_100Ry_2s2p1d.orb`）通常经过优化。
*   **切记**: 跑杂化泛函时，**千万不要盲目追求大基组**（如 TZDP 或 $R_{cut}=10$ a.u.），除非你确实需要极高的精度且有无限的计算时间。使用默认的 DZP 轨道和适中的截断半径（如 6-7 a.u.）是性价比最高的选择。

---

### 本章小结：你的第一个 HSE 任务清单

在提交任务前，请最后检查一遍：
1.  **INPUT**: `dft_functional hse` + `basis_type lcao`。
2.  **STRU**: 确保使用了推荐的 DZP 轨道文件。
3.  **KPT**: 适当增加了 K 点密度。
4.  **资源**: 尽量使用 OpenMP 多线程并行（如 `OMP_NUM_THREADS=N`），减少 MPI 进程数，以应对 EXX 的内存压力。

在下一章中，我们将深入探讨如何分析计算结果，并利用辅助工具处理能带结构。