# ABACUS 实战指南：数值原子轨道与截断半径的深度调控

## 前言

欢迎来到《ABACUS 实战指南》。在计算材料科学的领域中，ABACUS 作为一款由中国开发者主导、性能卓越的国产密度泛函理论（DFT）软件，凭借其对平面波（Plane Wave, PW）和数值原子轨道（Numerical Atomic Orbitals, NAO）的双重支持，已成为学术界与工业界的重要工具。本教程旨在帮助读者攻克 LCAO（原子轨道线性组合）计算中最核心、也最令初学者困惑的环节——截断半径（$R_{cut}$）的理解与应用。

### 学习路线图
本教程通过四个层层递进的章节，带你完成从理论到实战的跨越：
1. **物理基础**：理解为何 $R_{cut}$ 是 LCAO 计算中效率与精度的平衡支点。
2. **基准确立**：学习如何利用 ABACUS 的 PW 模式建立“金标准”，为后续优化提供参照。
3. **实战演练**：掌握通过更换轨道文件（而非修改参数）来调整 $R_{cut}$ 的核心技巧。
4. **决策分析**：运用 Delta Test 等定量方法，在实际科研场景中筛选出最优的轨道参数。

### 知识体系定位
在 ABACUS 的知识图谱中，本教程处于“计算进阶与精度控制”的核心位置。它连接了基础的 DFT 理论与复杂的体系模拟（如大体系输运、激发态计算等）。理解了 $R_{cut}$，你便掌握了 LCAO 模式下控制计算开销与精度的“总闸门”。

### 前置要求
在开始本教程之前，我们假设你已经：
- 具备基本的密度泛函理论（DFT）物理背景。
- 熟悉 Linux 命令行操作及基本的脚本编写。
- 完成了 ABACUS 的初步安装，并能成功运行基础的例子（如单点能计算）。

---

# 第一章：物理基础——为何 Rcut 是效率与精度的平衡点？

在开始任何 ABACUS 的 LCAO（原子轨道线性组合）计算之前，你必须理解一个核心概念：**截断半径（Cutoff Radius, $R_{cut}$）**。

很多初学者习惯了平面波（Plane Wave, PW）软件的思维，认为提高精度只需要增加能量截断（`ecutwfc`）。但在 ABACUS 的 LCAO 模式下，**$R_{cut}$ 才是决定计算效率与精度的第一要素**。本章将带你深入物理底层，理解为何这个半径值是整个计算的“阿基米德支点”。

---

## 1.1 数值原子轨道 (NAO) 的空间局域性

要理解 $R_{cut}$，我们需要先对比两种基组：平面波（PW）与数值原子轨道（NAO）。

### 1.1.1 平面波 vs. NAO：全域与局域的对决

-   **平面波 (PW)**：
    平面波是弥散在整个晶胞空间的（Delocalized）。当你扰动晶胞左下角的一个原子，其波函数的变化理论上会瞬间影响到右上角的电子分布。这意味着哈密顿量矩阵（Hamiltonian Matrix）是**稠密（Dense）**的——矩阵中几乎没有零元素。
    *   **代价**：随着体系增大，计算量呈 $O(N^3)$ 爆炸式增长。

-   **数值原子轨道 (NAO)**：
    ABACUS 的 LCAO 模式使用以原子为中心的轨道函数 $\phi(\mathbf{r})$。这些轨道有一个强制的物理边界，即 **$R_{cut}$**。
    $$ \phi(\mathbf{r}) = 0, \quad \text{if } |\mathbf{r}| > R_{cut} $$
    这意味着，电子波函数被严格限制在一个球体内。

### 1.1.2 稀疏矩阵：速度的来源

$R_{cut}$ 的存在直接导致了哈密顿量矩阵的**稀疏化（Sparsity）**。

在量子力学计算中，我们需要计算两个轨道 $\phi_i$ 和 $\phi_j$ 之间的矩阵元 $H_{ij} = \langle \phi_i | \hat{H} | \phi_j \rangle$。
-   如果原子 $I$ 和原子 $J$ 的距离 $d_{IJ}$ 足够远，使得它们的轨道半径没有任何重叠（即 $d_{IJ} > R_{cut, I} + R_{cut, J}$），那么积分值严格为零。
-   在大型体系中，绝大多数原子对之间都没有重叠。因此，哈密顿量矩阵中充满了大量的“0”。

**结论**：$R_{cut}$ 越小，矩阵越稀疏，内存占用越低，对角化或迭代求解的速度越快。这就是 ABACUS 处理千原子级体系依然高效的物理原因。

---

## 1.2 截断半径的双刃剑效应

既然 $R_{cut}$ 越小越快，为什么我们不把所有轨道都设为 2.0 a.u.？这就涉及到了精度的权衡。

### 1.2.1 $R_{cut}$ 过小的风险：长程尾部丢失

真实的电子波函数（尤其是价电子）在空间中是指数衰减的，理论上延伸至无穷远。
-   **物理失真**：如果你强行在 4.0 a.u. 处将波函数截断为零，相当于人为地切掉了波函数的“长程尾部”。
-   **后果**：
    1.  **能量偏高**：电子被限制在更窄的空间内，动能增加（不确定性原理）。
    2.  **原子间作用力错误**：如果两个原子本该通过尾部重叠产生化学键或弱相互作用，过短的 $R_{cut}$ 会导致这些相互作用完全丢失。
    3.  **基组不完备**：数学上无法通过线性组合准确描述真实的电子态。

### 1.2.2 $R_{cut}$ 过大的风险：计算灾难与 BSSE

-   **计算量激增**：当 $R_{cut}$ 增大，原子间的重叠邻居数呈立方级增长（$V \propto R^3$）。矩阵迅速变稠密，失去了 LCAO 的效率优势。
-   **基组重叠误差 (BSSE)**：在分子或表面吸附计算中，过大的 $R_{cut}$ 会导致严重的 BSSE 问题，使得结合能计算虚高。

### 1.2.3 经验法则：多少才是合适的？

根据经验（参考资料及社区最佳实践），我们有以下推荐范围：

| 体系类型 | 推荐 $R_{cut}$ (a.u.) | 物理理由 |
| :--- | :--- | :--- |
| **固体/体材料** | **6.0 ~ 8.0** | 固体中原子排列紧密，近邻原子的轨道重叠可以补偿单个原子轨道的短程截断，互补性强。 |
| **分子/团簇/表面** | **8.0 ~ 10.0+** | 孤立体系缺乏近邻原子的基组补偿，需要更长的 $R_{cut}$ 来描述电子的自由衰减。 |
| **高压/致密体系** | **< 6.0** | 原子间距极度压缩，短半径即可覆盖近邻。 |

> **专家提示**：对于固体系统，通常可以使用比孤立分子更短的 $R_{cut}$。不要因为追求极致精度而盲目使用 10 a.u. 以上的轨道，那通常是浪费算力。

---

## 1.3 实战核心：如何调整 $R_{cut}$？

这是本章最重要的实战部分。在 ABACUS 中，调整 $R_{cut}$ 的方式与传统软件完全不同。

### 1.3.1 核心机制：文件名即参数

在 ABACUS 的 `INPUT` 文件中，**没有**一个名为 `rcut = 7.0` 的参数供你直接修改。

> **CRITICAL (关键强调)**
>
> 在 LCAO 模式下，**$R_{cut}$ 是固化在轨道文件（.orb）里的**。
>
> 要改变 $R_{cut}$，你必须**更换轨道文件**。
> 例如：从 `Si_gga_6au_1.orb` 换成 `Si_gga_7au_1.orb`。

你需要在 `INPUT` 文件中指定轨道文件的存放目录，并在 `STRU` 文件中指定具体的轨道文件名。

**INPUT 文件示例**:
```bash
INPUT_PARAMETERS
# ... 其他参数 ...
basis_type      lcao
orbital_dir     ./orbitals/   # 指定存放 .orb 文件的文件夹
```

**STRU 文件示例**:
```bash
ATOMIC_SPECIES
Si  28.086  Si_gga_7au_dzp.orb  # 这里指定了具体的轨道文件，决定了 Rcut
```

### 1.3.2 黄金流程：PW vs LCAO 基准测试

如何确定当前的 $R_{cut}$ 是否足够？**绝对不要只跑 LCAO！** 你必须有一个参照系。

**标准收敛性测试流程**：

1.  **Step 1: 建立基准 (Ground Truth)**
    *   使用 `basis_type pw` (平面波模式) 对同一体系进行单点能计算。
    *   确保 PW 计算的 `ecutwfc` 已经收敛。
    *   记录总能量 $E_{PW}$。

2.  **Step 2: LCAO 测试**
    *   下载或生成一系列不同 $R_{cut}$ 的轨道文件（例如 6au, 7au, 8au）。
    *   修改 `STRU` 文件，依次使用这些轨道进行计算。
    *   记录总能量 $E_{LCAO}(R_{cut})$。

3.  **Step 3: 计算 Delta 值**
    $$ \Delta = \frac{|E_{LCAO} - E_{PW}|}{N_{atoms}} $$

**收敛标准**：
-   **高精度标准**：$\Delta < 1 \text{ meV/atom}$
-   **常规计算**：$\Delta < 3 \sim 5 \text{ meV/atom}$ 通常也是可接受的，具体取决于你关注的物理量（如能带结构通常比总能量对 $R_{cut}$ 更不敏感）。

### 1.3.3 避坑指南

*   **误区 1**：结果不准时盲目增加 `ecutwfc`。
    *   **正解**：在 LCAO 中，`ecutwfc` 仅控制积分网格的密度。如果 $R_{cut}$ 太短导致基组不完备，你把 `ecutwfc` 加到 200 Ry 也没用。优先检查 $R_{cut}$ 和基组大小（SZ/DZP）。
*   **误区 2**：试图在 INPUT 中截断长轨道。
    *   **正解**：ABACUS 目前不支持在运行时动态截断轨道文件。如果你手头只有 10 a.u. 的轨道但想用 7 a.u.，请去官网下载对应的 7 a.u. 文件，或使用辅助工具重新生成。

---

**本章总结**：
$R_{cut}$ 是 LCAO 计算中定义“精度-效率”杠杆的支点。理解它意味着你需要习惯“通过更换文件来调整参数”的操作模式，并始终保持“以 PW 结果为锚点”的严谨态度。

下一章，我们将正式进入实操环节，手把手教你准备 ABACUS 计算所需的四大核心文件。

# 第二章：确立“标准答案”——平面波 (PW) 基准计算

在进入 LCAO（原子轨道中心线性组合）的高效计算世界之前，我们必须先停下来，问自己一个关键问题：**我们怎么知道算得准不准？**

LCAO 方法的核心优势是效率，但这种效率是建立在对基组进行截断（Rcut）和近似基础上的。如果没有一个“标准答案”作为参照，盲目追求 LCAO 的速度是非常危险的。在 ABACUS 中，我们拥有一个独特的优势：**同一个软件框架既支持 LCAO 也支持平面波（Plane Wave, PW）基组**。

平面波基组在数学上具有完备性（Systematically Improvable），只要动能截断（Energy Cutoff）足够大，它就能给出在该泛函和赝势下的“精确解”。因此，本章的目标非常明确：**运行一个高精度的 PW 计算，获取总能量和电子结构的“标准答案”，作为后续评估 LCAO 轨道精度的标尺。**

---

## 2.1 准备 PW 计算环境

与 LCAO 模式相比，PW 模式最大的特点是**不需要轨道文件（.orb）**。它只需要赝势文件（.upf/.vwr）和足够密集的积分网格。

### 2.1.1 修改 INPUT 文件

要将 ABACUS 切换到平面波模式，我们需要在 `INPUT` 文件中进行关键设置。以下是一个用于基准测试的标准 `INPUT` 模板：

```bash
INPUT_PARAMETERS
# 1. 基础任务设置
suffix          benchmark_pw   # 任务后缀，区分输出文件
calculation     scf            # 自洽场计算
basis_type      pw             # 【核心参数】设置为平面波模式
symmetry        1              # 开启对称性分析以加速

# 2. 精度控制（基准测试核心）
ecutwfc         100            # 【关键】平面波动能截断，单位 Rydberg
scf_thr         1.0e-8         # 自洽收敛阈值，基准测试建议设严一点
scf_nmax        100            # 最大迭代步数

# 3. 涂抹与混合（根据体系调整）
smearing_method gaussian
smearing_sigma  0.01
mixing_type     pulay
mixing_beta     0.7

# 4. 路径设置
pseudo_dir      ./             # 赝势文件路径
# orbital_dir   ./             # PW 模式下此参数会被忽略，但保留也无妨
```

#### 关键参数详解：
*   **`basis_type pw`**: 这是告诉 ABACUS 放弃原子轨道，改用平面波基组展开波函数的开关。
*   **`ecutwfc` (Energy Cutoff for Wavefunctions)**:
    *   **含义**: 限制平面波基组的动能上限。
    *   **基准策略**: 在日常计算中，我们可能会取 50-60 Ry（取决于赝势），但在做 **Benchmark（基准）** 时，我们必须“杀鸡用牛刀”。建议设置为 **80-100 Ry** 甚至更高，以确保基组完备性误差降到最低，从而保证我们看到的误差纯粹来自 LCAO 基组本身，而不是 PW 没算准。

### 2.1.2 检查 STRU 文件

在 PW 模式下，`STRU` 文件中的 `NUMERICAL_ORBITAL` 部分虽然可以保留，但程序在运行时会**自动忽略**它。程序仅读取 `ATOMIC_SPECIES` 中的赝势信息。

**STRU 示例**：
```bash
ATOMIC_SPECIES
Si  28.086  Si_ONCV_PBE-1.0.upf  # 仅依赖赝势

NUMERICAL_ORBITAL
Si_gga_8au_60Ry_2s2p1d.orb       # 在 basis_type=pw 时，此行被忽略

LATTICE_CONSTANT
10.2                             # Bohr

LATTICE_VECTORS
0.5 0.5 0.0
0.5 0.0 0.5
0.0 0.5 0.5

ATOMIC_POSITIONS
Direct
Si  0.00  0.00  0.00 1 1 1
Si  0.25  0.25  0.25 1 1 1
```

---

## 2.2 获取基准物理量与收敛标准

运行计算后（例如执行 `abacus`），我们需要从输出文件（如 `OUT.benchmark_pw/running_scf.log` 或标准输出）中提取关键数据。

### 2.2.1 提取总能量 (Total Energy)

这是最核心的指标。
```bash
grep "final etot" OUT.benchmark_pw/running_scf.log
```
输出示例：
```text
!FINAL_ETOT_IS -231.56781234 Ry
```
记录下这个数值，记为 $E_{PW}$。

### 2.2.2 确立“高精度”标准 (The Gold Standard)

在后续章节中，我们将运行 LCAO 计算并获得 $E_{LCAO}$。我们定义能量误差 Delta 为：
$$ \Delta E = \frac{|E_{LCAO} - E_{PW}|}{N_{atoms}} $$

根据计算材料学的经验法则（参考资料4），我们确立以下**收敛标准**：

1.  **高精度标准**: $\Delta E < 1 \text{ meV/atom}$
    *   这是发表级数据通常追求的精度，意味着 LCAO 基组的质量已经非常接近完备基。
2.  **常规计算标准**: $\Delta E \approx 10 \text{ meV/atom}$
    *   对于一些定性的趋势分析或大体系预筛选，这个精度有时是可以接受的，但在 ABACUS 中我们通常争取做到更好。

### 2.2.3 力的基准（可选但推荐）

如果你的后续任务涉及结构弛豫或分子动力学，仅看能量是不够的，还需要检查力（Force）的误差。
在 `OUT.benchmark_pw/` 目录下会生成力的输出文件（通常在日志或单独文件中）。记录下原子受力，作为 $F_{PW}$。

---

## 2.3 专家锦囊：避坑指南

在这一步，很多初学者容易混淆概念，导致后续测试失效。请务必阅读以下核心逻辑：

### 🔴 核心强调：文件名即参数
在 ABACUS 的 LCAO 模式中，**轨道截断半径（Rcut）是写死在轨道文件里的**。
*   **错误理解**: 在 `INPUT` 里找一个叫 `rcut` 的参数修改数值。
*   **正确操作**: 如果你想测试 6.0 au 和 7.0 au 的区别，你必须**更换轨道文件**。
    *   例如：从使用 `Si_gga_6au.orb` 改为在 STRU 中引用 `Si_gga_7au.orb`。
    *   *风险提示*: 目前 ABACUS 不支持在 INPUT 中直接对长轨道文件进行截断（除非使用特定开发版的高级功能，一般不推荐）。请务必准备好不同 Rcut 的轨道文件进行测试。

### 💡 概念辨析：ecutwfc vs. Rcut
*   **`ecutwfc` (Energy Cutoff)**: 控制积分网格的密度（Grid Mesh）。在 LCAO 中，它决定了实空间积分网格的精细度。
*   **`Rcut` (Cutoff Radius)**: 控制原子轨道的空间广度。
*   **常见误区**: 发现 LCAO 结果不准，拼命增加 `INPUT` 里的 `ecutwfc`。
*   **专家建议**: 如果 `ecutwfc` 已经达到 50-60 Ry，继续增加它对 LCAO 结果的改善微乎其微。此时**瓶颈通常在轨道基组本身**（即 Rcut 太小或 Zeta 数不足）。请优先检查轨道文件！

### ⚡ 效率与精度的折中建议
根据经验（参考资料7），不同体系对 Rcut 的敏感度不同：
*   **固体/体相材料 (Solids)**: 由于近邻原子的轨道重叠提供了额外的基组完备性，通常 **6.0 - 8.0 au** 的 Rcut 就能达到很好的精度。
*   **分子/团簇/表面 (Molecules/Surfaces)**: 或者是低维材料，原子周围有大量真空。为了描述真空中的波函数衰减，通常需要更大的 Rcut，建议 **9.0 - 10.0 au** 甚至更大，以减少基组重叠误差（BSSE）和描述长程效应。

---

**本章小结**
现在，你已经拿到了 $E_{PW}$ 这个“标准答案”。在下一章，我们将正式切换回 LCAO 模式，通过调整轨道文件，看看你的 LCAO 计算能多接近这个标准答案。

# 第三章：实战演练——通过更换轨道文件测试 Rcut

在上一章中，我们了解了数值原子轨道（NAO）的基本原理。当你准备开始第一个 LCAO 计算时，很多初学者的第一反应是在 `INPUT` 文件中寻找一个名为 `rcut` 或 `orbital_radius` 的参数，试图通过修改这个数字来控制计算精度。

**请立刻停下来。**

在 ABACUS 的 LCAO 模式中，**$R_{cut}$ 不是一个输入参数，而是轨道文件的固有属性**。要改变 $R_{cut}$，你必须更换不同半径的轨道文件。本章将带你一步步完成这个核心操作，并建立一套标准的精度测试流程。

---

## 3.1 轨道文件的准备与识别：文件名即参数

数值原子轨道文件（通常以 `.orb` 结尾）是预先生成好的数据表。ABACUS 读取这些文件时，轨道的形状、节点数以及最重要的截断半径（$R_{cut}$）就已经被固定了。

### 3.1.1 读懂文件名
虽然文件名可以任意修改，但官方发布的轨道文件通常遵循严格的命名规范，这包含了我们所需的所有信息。

以文件名 `Si_gga_7au_100Ry_2s2p1d.orb` 为例：
- **Si**: 元素符号。
- **gga**: 交换关联泛函类型（需与赝势一致）。
- **7au**: **这就是 $R_{cut}$**。表示该轨道的截断半径为 7.0 Bohr（约 3.7 Å）。
- **100Ry**: 生成该轨道时使用的截断能（参考值，提示你在 LCAO 计算中 `ecutwfc` 最好不低于此值）。
- **2s2p1d**: 基组大小（Zeta），表示包含 2 个 s 轨道，2 个 p 轨道和 1 个 d 轨道。

### 3.1.2 准备测试序列
为了测试 $R_{cut}$ 对计算结果的影响，你不能只准备一个文件。你需要从 ABACUS 官网或使用 PTG 程序准备一系列不同半径的轨道文件。

**实战准备**：假设我们要测试硅（Si）晶体，请确保你的工作目录下有以下三个文件（如果没有，请假设我们已经生成了它们）：
1.  `Si_gga_6au_100Ry_2s2p1d.orb` (短半径，速度快，精度可能不足)
2.  `Si_gga_7au_100Ry_2s2p1d.orb` (中等半径，推荐起点)
3.  `Si_gga_8au_100Ry_2s2p1d.orb` (长半径，精度高，计算量大)

---

## 3.2 LCAO 计算参数设置 (INPUT)

在进行 Rcut 测试之前，我们需要配置 `INPUT` 文件。这里有一个极易混淆的概念需要澄清：`ecutwfc` 在 LCAO 中的作用。

### 3.2.1 关键参数配置
创建一个标准的 `INPUT` 文件：

```bash
INPUT_PARAMETERS
# 基础计算模式
calculation     scf
basis_type      lcao    # 关键：开启 LCAO 模式

# 精度控制
ecutwfc         100     # 推荐值：100 Ry
scf_thr         1e-6    # 自洽收敛标准
scf_nmax        100

# 涂抹设置 (针对金属或小能隙体系)
smearing_method gaussian
smearing_sigma  0.01

# 混合参数
mixing_type     pulay
mixing_beta     0.7
```

### 3.2.2 专家点拨：ecutwfc 与 Rcut 的无关性
> **误区警示**：很多用户发现 LCAO 结果不准，第一反应是把 `ecutwfc` 从 100 Ry 加到 200 Ry，结果发现能量几乎没变。

**原理**：
- 在 **PW（平面波）** 模式下，`ecutwfc` 决定了基组的大小（圆球半径），直接决定精度。
- 在 **LCAO** 模式下，基组的大小由 `.orb` 文件（即 $R_{cut}$ 和 Zeta）决定。此时 `ecutwfc` 仅控制**实空间积分网格的疏密**。

**结论**：只要 `ecutwfc` 足够高（通常 100 Ry 对于大多数标准轨道已足够），能准确描述轨道波函数的起伏即可。**如果结果不准，请去换轨道文件（改 Rcut 或 Zeta），而不是盲目增加 `ecutwfc`。**

---

## 3.3 核心操作——修改 STRU 文件

这是本章的实操重点。改变 $R_{cut}$ 的操作完全在 `STRU` 文件中进行。

### 3.3.1 STRU 文件结构
`STRU` 文件定义了原子种类、晶格和坐标。我们需要关注的是 `ATOMIC_SPECIES` 模块。

**格式说明**：
```text
ATOMIC_SPECIES
元素名  原子质量  赝势文件路径  轨道文件路径
```

### 3.3.2 实战演练：6au -> 7au -> 8au
我们将进行三次独立的 SCF 计算，每次仅修改 `STRU` 文件中的最后一列。

**测试 1：使用 6au 轨道**
修改 `STRU` 文件：
```text
ATOMIC_SPECIES
Si  28.086  Si_ONCV_PBE-1.0.upf  Si_gga_6au_100Ry_2s2p1d.orb
```
*运行 ABACUS，记录总能量 $E_{6au}$。*

**测试 2：使用 7au 轨道**
修改 `STRU` 文件：
```text
ATOMIC_SPECIES
Si  28.086  Si_ONCV_PBE-1.0.upf  Si_gga_7au_100Ry_2s2p1d.orb
```
*运行 ABACUS，记录总能量 $E_{7au}$。*

**测试 3：使用 8au 轨道**
修改 `STRU` 文件：
```text
ATOMIC_SPECIES
Si  28.086  Si_ONCV_PBE-1.0.upf  Si_gga_8au_100Ry_2s2p1d.orb
```
*运行 ABACUS，记录总能量 $E_{8au}$。*

---

## 3.4 建立基准：PW vs LCAO 对比测试

单纯看 LCAO 的能量变化是不够的，因为 LCAO 是变分近似。我们需要一个“真值”作为标尺。在 DFT 计算中，收敛的高截断能平面波（PW）结果通常被视为基准。

### 3.4.1 标准测试流程
建议在正式大规模计算前，对你的体系进行如下 Benchmark：

1.  **运行 PW 基准计算**：
    - 修改 `INPUT`: `basis_type pw`, `ecutwfc 80` (或更高，确保 PW 收敛)。
    - 运行计算，获得 $E_{PW}$。
2.  **计算能量差 ($\Delta E$)**：
    - $\Delta E = (E_{LCAO} - E_{PW}) / N_{atoms}$
    - 单位通常转换为 meV/atom。

### 3.4.2 精度判据
根据经验，我们推荐以下收敛标准：

| 精度等级 | $\Delta E$ (vs PW) | 适用场景 | 建议 Rcut |
| :--- | :--- | :--- | :--- |
| **高精度** | < 1 meV/atom | 声子谱、弹性常数、高精度能带 | 7.0 - 9.0 au |
| **中等精度** | < 10 meV/atom | 结构弛豫、MD 预跑、大体系筛选 | 6.0 - 7.0 au |
| **低精度** | > 10 meV/atom | 仅做定性分析（慎用） | < 6.0 au |

### 3.4.3 锦囊妙计：固体 vs 分子
在选择 $R_{cut}$ 时，请记住物理环境的区别：

*   **固体/体材料**：原子排列紧密，近邻原子的轨道重叠非常大。这种重叠实际上弥补了单个原子基组的不足（类似于基组完备性借用）。因此，**固体计算通常可以使用较短的 Rcut（如 6-7 au）** 就能达到很高精度。
*   **分子/表面/团簇**：存在真空层，原子周围的“邻居”少，必须依靠自身的轨道延伸来描述波函数。因此，**孤立体系通常需要更长的 Rcut（如 8-10 au）**，这也有助于减少基组重叠误差（BSSE）。

---

## 3.5 本章总结

1.  **文件名即参数**：不要在 INPUT 里找 `rcut`，请直接在 `STRU` 的 `ATOMIC_SPECIES` 中更换轨道文件。
2.  **控制变量**：测试 Rcut 时，保持 `ecutwfc`（推荐 100 Ry）和基组大小（如 DZP）不变。
3.  **PW 是标尺**：没有 PW 结果做对比的 LCAO 计算是“盲飞”。务必先跑一个 PW 算例作为 Reference。
4.  **按需选择**：固体体系 6-7 au 通常足矣；分子体系建议 8 au 起步。

在掌握了如何通过更换文件控制 $R_{cut}$ 后，下一章我们将深入探讨另一个决定精度的关键因素：**基组大小（SZ, DZP, TZDP）的选择策略**。

# 第四章：数据分析与决策——寻找最优 Rcut

在 ABACUS 的数值原子轨道（LCAO）计算中，**截断半径（Rcut）** 是决定计算精度与效率平衡的核心参数。不同于平面波（PW）基组只需简单增加截断能（`ecutwfc`），LCAO 基组的完备性高度依赖于轨道的空间延展范围。

本章将指导你如何通过定量的“Delta Test”流程，针对不同体系（固体、分子、表面）筛选出最优的 Rcut。

> **核心概念澄清**：
> 在 ABACUS 的 LCAO 模式中，**改变 Rcut 通常意味着更换轨道文件**。
> 你无法在 `INPUT` 文件中简单地修改一个数字来改变 Rcut。你必须在 `STRU` 文件中指定不同截断半径的轨道文件（例如从 `Si_7au.orb` 换成 `Si_8au.orb`）。

---

## 4.1 能量与能带的误差分析 (Delta Test)

LCAO 是一种近似方法，其精度上限由基组决定。为了验证 Rcut 是否足够，我们需要一个“绝对真值”作为标尺。在 ABACUS 中，**平面波（PW）计算结果**就是这个标尺。

### 4.1.1 建立基准：PW 计算 (Reference)

首先，我们需要对同一体系进行一次高精度的平面波计算。

1.  **准备 INPUT**：将 `basis_type` 设置为 `pw`。
2.  **设置参数**：为了保证作为基准的可靠性，PW 计算的 `ecutwfc` 应设置得足够高（通常建议 80-100 Ry 或更高，视赝势软硬而定）。

**INPUT 示例 (PW Benchmark):**
```bash
INPUT_PARAMETERS
# ... 通用设置 ...
calculation     scf
basis_type      pw        # 关键：使用平面波作为基准
ecutwfc         100       # 关键：足够大的截断能
scf_thr         1e-8      # 高精度收敛标准
# ... 其他参数 ...
```

记录下此次计算的总能量 $E_{PW}$（单位：eV 或 Ry）。

### 4.1.2 测试对象：LCAO 计算

接下来，保持体系结构（`STRU` 中的晶格和原子位置）完全不变，切换到 LCAO 模式，并轮换使用不同 Rcut 的轨道文件。

**INPUT 示例 (LCAO Test):**
```bash
INPUT_PARAMETERS
# ... 通用设置 ...
calculation     scf
basis_type      lcao      # 关键：切换为 LCAO
ecutwfc         100       # 建议与 PW 保持一致或至少 60+ Ry，用于处理积分网格
# ... 其他参数 ...
```

**STRU 文件调整 (关键步骤):**
在 `ATOMIC_SPECIES` 部分，你需要修改第三列引用的轨道文件名。假设你手头有一组不同 Rcut 的轨道文件（通常位于 `orbital_dir` 指定的目录下）：

*   **测试 6.0 au:**
    ```
    ATOMIC_SPECIES
    Si  28.086  Si.upf  Si_DZP_6.0au.orb
    ```
*   **测试 7.0 au:**
    ```
    ATOMIC_SPECIES
    Si  28.086  Si.upf  Si_DZP_7.0au.orb
    ```
*   **测试 8.0 au:**
    ```
    ATOMIC_SPECIES
    Si  28.086  Si.upf  Si_DZP_8.0au.orb
    ```

> **注意**：必须确保 PW 和 LCAO 计算使用的是**完全相同**的赝势文件（`.upf`），否则能量差值没有物理意义。

### 4.1.3 评估标准：Delta E

计算每个 Rcut 下的能量差值：
$$ \Delta E(R_{cut}) = \frac{|E_{LCAO}(R_{cut}) - E_{PW}|}{N_{atoms}} $$

**高精度收敛标准**：
- **优 (Excellent)**: $\Delta E < 1 \text{ meV/atom}$
- **良 (Good)**: $\Delta E < 5 \text{ meV/atom}$ (对于大规模动力学模拟通常可接受)
- **差 (Poor)**: $\Delta E > 10 \text{ meV/atom}$ (需增大 Rcut 或基组大小)

绘制一张 "Delta E vs. Rcut" 的曲线图。你会发现随着 Rcut 增加，$\Delta E$ 会迅速下降并趋于平缓。选择那个**刚进入“优/良”区间且 Rcut 最小**的点，即为最优解。

---

## 4.2 不同体系的选取策略

虽然 Delta Test 是金标准，但在实际科研中，我们可以根据体系的物理特性应用经验法则。

### 4.2.1 固体体系 (Bulk Systems)
**推荐策略**：**较短 Rcut (6 - 8 au)**

*   **物理原理**：在致密的固体中，原子间距较小。一个原子的波函数可以通过邻近原子的轨道线性组合来补充（即邻近原子的轨道“伸”过来帮忙描述电子）。这种重叠效应增加了基组的有效完备性。
*   **决策**：通常 6.0 au 或 7.0 au 的 DZP 轨道就能达到非常高的精度（< 1 meV/atom）。过大的 Rcut (如 > 9 au) 会导致哈密顿量矩阵变得不够稀疏，显著增加计算量，却对精度提升极小。

### 4.2.2 分子与表面体系 (Molecules & Surfaces)
**推荐策略**：**较长 Rcut (8 - 10 au)**

*   **物理原理**：
    1.  **真空衰减**：在分子或表面模型中，电子波函数需要向真空层延伸并自然衰减。真空中没有“邻居”原子提供轨道重叠支持，因此必须依靠原子自身的轨道拖得足够长来描述这种衰减。
    2.  **BSSE 问题**：虽然长 Rcut 理论上可能引入基组重叠误差（BSSE），但在 LCAO 中，过短的 Rcut 造成的“人为禁闭误差”（电子撞到截断半径墙壁）通常比 BSSE 更严重。
*   **决策**：对于真空中孤立分子或吸附表面，建议从 8.0 au 起步测试，通常 9.0 au 或 10.0 au 是更稳妥的选择。

---

## 附录：常见陷阱与进阶

### 1. SZ vs DZP 的陷阱
**警告**：**永远不要在 SZ (Single Zeta) 基组上做 Rcut 测试。**
SZ 基组本身自由度太少，无论 Rcut 多大，其精度都无法逼近 PW 结果。你可能会看到 $\Delta E$ 很大且不随 Rcut 改善，从而错误地认为是 Rcut 不够大。
**正确做法**：始终使用 **DZP (Double Zeta Polarized)** 或更高阶基组进行 Rcut 收敛性测试。

### 2. 内存溢出 (OOM) 风险
**现象**：当 Rcut 很大（如 > 10 au）且体系原子很密时，稀疏矩阵（H 和 S 矩阵）的非零元数量会呈立方级增长，导致内存瞬间耗尽。
**解决方案**：
- 如果必须使用超大 Rcut，请务必增加计算节点（MPI 进程），利用并行分摊内存。
- 检查是否误用了针对团簇设计的长轨道去计算高压致密固体。

### 3. 不要混淆 `ecutwfc` 与 Rcut
- **Rcut (轨道半径)**：决定了基组的广度，直接影响 LCAO 的物理精度。
- **`ecutwfc` (网格截断能)**：在 LCAO 中，它决定了实空间积分网格的密度。
**调试指南**：如果 LCAO 结果不准，**90% 的情况应该优先检查 Rcut 和基组大小（DZP/TZP）**，而不是盲目增加 `ecutwfc`。只要 `ecutwfc` 达到 60-100 Ry，它通常不是误差的主要来源。

---

## 附录

### 进阶学习指南：探索微观世界的更多可能

恭喜你完成了关于 $R_{cut}$ 的核心课程！但这仅仅是 ABACUS 广阔世界的起点。为了进一步提升你的计算能力，我们建议你在以下方向继续探索：

#### 1. 深度扩展阅读
- **轨道生成技术**：本教程教你如何“使用”轨道，而进阶学习则应关注如何“产生”高精度的数值原子轨道。建议查阅关于 `ABACUS-Orbitals` 轨道产生工具的文档，了解 `maxL`、`Level1/2/3`（如 SZ, DZP, TZP 基组等级）对计算结果的影响。
- **赝势与轨道的匹配**：轨道文件必须与对应的赝势（Pseudopotential）相匹配。深入研究模守恒赝势（ONCV）与 NAO 的协同效应，将有助于你处理更复杂的元素体系。
- **大体系优化策略**：在掌握了 $R_{cut}$ 的基础上，可以尝试探索 ABACUS 在数千原子体系中的线性标度（Order-N）计算优势。

#### 2. 通用调试建议 (Troubleshooting)
- **单位陷阱**：务必注意 ABACUS 中长度单位的转换。$R_{cut}$ 通常以 Bohr 为单位，而晶格参数可能涉及 Angstrom。1 Bohr ≈ 0.529177 Å。
- **内存溢出**：过大的 $R_{cut}$ 会导致重叠矩阵变得稠密，急剧增加内存消耗。若遇到内存报错，请优先检查是否选择了不必要的大半径轨道。
- **收敛性协同**：记住 $R_{cut}$ 的测试应与 K 点密度、电子温度（Smearing）等参数统筹考虑，而非孤立存在。

#### 3. 官方资源推荐
- **官方文档**：[ABACUS User Guide](https://abacus.deepmodeling.com/) 包含最权威的参数说明。
- **开源社区**：关注 DeepModeling 开源社区的 GitHub 仓库，参与讨论并获取最新的轨道库更新。

科学探索是一场马拉松，愿你通过本教程建立的严谨习惯，能助你在未来的研究中无往不利！
