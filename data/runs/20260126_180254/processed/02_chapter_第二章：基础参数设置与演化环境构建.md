# 第二章：基础参数设置与演化环境构建

在上一章中，我们完成了 ABACUS 的安装与基本运行测试。如果说基态自洽计算（SCF）是描绘材料的“静态肖像”，那么实时含时密度泛函理论（rt-TDDFT）就是拍摄材料电子运动的“超快电影”。

本章我们将确立计算的“地基”。从静态计算过渡到动力学模拟，不仅仅是修改几个参数，更需要物理观念的转变。我们将重点讲解如何激活 rt-TDDFT 模块、如何选择正确的时间步长，以及如何利用 ABACUS 独有的**混合规范（Hybrid Gauge）**技术来保证周期性体系计算的精度与效率。

---

## 2.1 激活 rt-TDDFT 模块：从静态到动态

在 ABACUS 中，rt-TDDFT 的功能集成在分子动力学（MD）的大框架下，但通过特殊的求解器类型来指定电子的演化。我们需要修改 `INPUT` 文件，告诉程序：我们不再寻找能量最低点，而是要让电子随时间“动”起来。

### 核心参数设置

请在你的 `INPUT` 文件中进行如下修改或添加：

```fortran
INPUT_PARAMETERS
# ... (原有基态参数)

# --- 任务类型设置 ---
calculation     md          # 将计算类型设置为分子动力学(MD)框架
esolver_type    tddft       # 指定电子求解器为 rt-TDDFT

# ... (后续参数)
```

*   **`calculation`**: 必须设为 `md`。在 ABACUS 的架构中，时间演化过程（无论是离子移动还是电子演化）都属于 MD 的范畴。
*   **`esolver_type`**: 这是关键开关。设为 `tddft` 后，程序将不再进行波函数的对角化求解，而是使用时间演化算符（Propagator）来更新波函数。

---

## 2.2 ABACUS 的杀手锏：混合规范 (Hybrid Gauge)

在设置具体演化参数之前，作为资深开发者，我必须向你介绍 ABACUS 在 rt-TDDFT 领域的核心竞争力——**混合规范（Hybrid Gauge）**。这是你选择 ABACUS 而非其他软件进行周期性体系激发的最大理由。

### 2.2.1 为什么我们需要混合规范？

在模拟激光或电场对材料的激发时，我们面临一个两难的物理困境：

1.  **长度规范 (Length Gauge)**:
    *   **原理**: 使用标量势 $V = \mathbf{E} \cdot \mathbf{r}$ 描述电场。
    *   **问题**: 在周期性体系（如晶体）中，位置算符 $\mathbf{r}$ 是无界的，这破坏了布洛赫定理（周期性边界条件）。因此，长度规范**无法直接用于固体计算**。

2.  **速度规范 (Velocity Gauge)**:
    *   **原理**: 使用矢量势 $\mathbf{A}(t)$ 描述电场。
    *   **优势**: 保持了哈密顿量的周期性，理论上适用于固体。
    *   **致命缺陷**: 在使用**数值原子轨道 (LCAO)** 基组时，传统速度规范忽略了轨道内部由矢量势引起的相位变化。
    *   **后果**: 这种相位缺失会导致严重的系统性误差，特别是在低频区域，计算出的电流可能会发散，或者光谱出现虚假的峰值。虽然可以通过无限增大基组来缓解，但这会让计算成本爆炸，失去了 LCAO 高效的优势。

### 2.2.2 混合规范的解决方案

ABACUS 引入的 **混合规范 (Hybrid Gauge)** 完美解决了上述矛盾。

*   **核心逻辑**: 它在速度规范的基础上，显式地引入了依赖于矢量势的**局域相位修正因子**。
*   **效果**: 
    *   **精度**: 它修复了 LCAO 基组下的相位误差，给出的结果与全基组极限下的长度规范一致。
    *   **效率**: 它保留了 LCAO 基组计算量小的优势，不需要为了消除误差而使用极大的基组。
    *   **通用性**: 无论是孤立分子还是周期性晶体，无论是弱场还是强场，都能统一处理。

> **实战案例分析**: 
> 在硅（Si）单胞的强场激发模拟中，如果使用传统**速度规范**，计算得到的响应电流往往包含非物理的漂移，且介电函数在低频区出现发散。而使用 ABACUS 的**混合规范**，不仅消除了这些误差，还能准确捕捉到高次谐波（High-harmonic generation, HHG）信号（如 3、5、7 次谐波），其结果具有极高的物理可靠性。

### 2.2.3 风险提示与参数查阅

**Risk Note**: 由于 ABACUS 版本迭代较快，开启混合规范的具体参数名（例如是否涉及 `td_gauge` 或特定的电场设置方式）可能会有细微变化。

*   **行动指南**: 在撰写 `INPUT` 文件时，**请务必查阅 ABACUS 官方文档中关于 "TDDFT" 或 "Systematic Gauge" 部分的最新说明**，确认开启混合规范的具体参数及电场定义的格式。通常默认情况下或通过指定特定的规范参数即可启用。

---

## 2.3 时间尺度与演化步长

rt-TDDFT 模拟的是电子的动力学行为，其时间尺度是**阿秒 (attosecond, $10^{-18}$ s)** 量级，这与传统离子分子动力学的飞秒 ($10^{-15}$ s) 量级有本质区别。

### 关键参数设置

```fortran
# --- 时间演化参数 ---
md_dt       0.05    # 时间步长 (单位通常为飞秒 fs，请以官方文档为准)
md_nstep    2000    # 总演化步数
```

*   **`md_dt` (时间步长)**: 
    *   **物理意义**: 决定了演化算符 $U(t, t+\Delta t)$ 的积分精度。
    *   **设置建议**: 对于电子动力学，步长必须极小。通常建议在 **0.01 fs 到 0.1 fs** 之间。如果步长过大，演化算符将不再幺正（Unitarity），导致总电子数不守恒或能量发散。
    *   **自检方法**: 在输出文件中监控总电子数，如果随时间漂移，说明 `md_dt` 太大了。

*   **`md_nstep` (总步数)**:
    *   决定了模拟的总时长。例如 `md_dt 0.05` * `md_nstep 2000` = 100 fs 的总物理时间。
    *   根据你研究的物理过程（如拉比振荡周期、退相干时间）来决定。

---

## 2.4 电子结构准备：为空带留出空间

这是初学者最容易犯的错误：**只计算了占据态，没有计算空带。**

在基态计算中，我们只关心填满电子的能带。但在 rt-TDDFT 中，电子受到外场激发，会从占据态跃迁到空态（导带）。如果你的计算空间中没有包含空带，电子就“无路可去”，激发现象就无法发生。

### 关键参数设置

```fortran
# --- 电子结构参数 ---
nbands      20      # 能带总数 (必须显著大于占据态数目)
```

*   **`nbands`**: 
    *   **警示**: 默认情况下，ABACUS 可能只计算占据带。做 rt-TDDFT 时，**必须手动设置**一个较大的 `nbands`。
    *   **经验法则**: 
        *   对于绝缘体/半导体：`nbands` 至少应为占据带数目的 1.5 到 2 倍。
        *   对于高能激发（如高次谐波）：需要更多的空带以描述高能连续态。
    *   **检查**: 确保你的赝势和基组能够支持这么多能带。

*   **基组选择 (`orbital_dir`)**:
    *   rt-TDDFT 对基组的质量要求比基态计算更高。建议使用 `DZP` (Double Zeta plus Polarization) 或更高精度的数值原子轨道基组，以确保激发态空间的完备性。

---

## 本章小结：你的 INPUT 文件概览

经过本章的设置，你的 `INPUT` 文件中关于 rt-TDDFT 的核心部分应该如下所示（示例）：

```fortran
INPUT_PARAMETERS
# 基础参数
suffix          Si_excitation
ntype           1
ecutwfc         60

# 激活 rt-TDDFT
calculation     md
esolver_type    tddft

# 演化参数 (电子动力学尺度)
md_dt           0.02      # 20 attoseconds
md_nstep        5000      # Total 100 fs

# 电子结构 (关键！)
nbands          30        # 假设体系有8个价电子，这里留出了大量空带

# 混合规范与电场 (请查阅文档补充具体参数)
# [PARAMETER_MISSING]: td_gauge / td_field_... 
```

**下一步预告**：
地基已经打好。在下一章，我们将正式“通电”——学习如何定义激光脉冲（电场形式、频率、包络），并启动计算观察电子的狂舞。