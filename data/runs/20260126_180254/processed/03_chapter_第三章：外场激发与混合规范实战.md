# 第三章：外场激发与混合规范实战

欢迎来到 ABACUS 实战教程的核心章节。在前两章中，我们已经掌握了如何构建静态的基态体系。现在，我们要让电子“动”起来。

实时含时密度泛函理论（rt-TDDFT）的本质，是模拟电子在含时外场（通常是激光脉冲）作用下的演化行为。本章将带你深入理解 ABACUS 在这一领域的**杀手锏功能——混合规范（Hybrid Gauge）**，并手把手教你如何设置外场来“踢”动硅晶体中的电子。

---

## 3.1 核心原理：为什么必须选择“混合规范”？

在开始写输入文件之前，作为开发者，我必须向你解释清楚一个困扰计算材料学界多年的难题，以及 ABACUS 是如何解决它的。这是你获得准确结果的前提。

### 3.1.1 规范的“不可能三角”
在 rt-TDDFT 计算中，描述光与物质相互作用主要有两种方式（规范）：

1.  **长度规范 (Length Gauge)**:
    *   **原理**: 使用标量势 $V = \mathbf{r} \cdot \mathbf{E}(t)$。
    *   **优点**: 数值稳定性好，物理图像直观。
    *   **致命缺陷**: 位置算符 $\mathbf{r}$ 在周期性边界条件（PBC）下是未定义的（电子跑出边界后坐标会跳变）。因此，**长度规范原则上不能直接用于周期性晶体计算**。

2.  **速度规范 (Velocity Gauge)**:
    *   **原理**: 使用矢量势 $\mathbf{A}(t)$，哈密顿量包含 $\mathbf{p} \cdot \mathbf{A}$ 项。
    *   **优点**: 动量算符 $\mathbf{p}$ 与周期性边界条件完美兼容。
    *   **隐形陷阱**: 在使用原子轨道（LCAO）基组时，速度规范会引入严重的相位误差。
        *   *原因*: 电子在场中运动会积累相位，但有限的原子轨道基组无法完美表达这个由矢量势引起的相位因子 $e^{i\mathbf{A}\cdot\mathbf{r}}$。
        *   *后果*: 计算出的光谱在低频区（$\omega \to 0$）会出现非物理的发散（Drude-like tail），导致介电函数计算错误。虽然增大基组可以缓解，但计算成本会指数级上升。

### 3.1.2 ABACUS 的解决方案：混合规范 (Hybrid Gauge)
为了解决上述两难困境，ABACUS 引入了**混合规范**。这是 ABACUS 在 rt-TDDFT 领域的一项重要算法创新。

*   **核心思想**: 在速度规范的基础上，显式地在原子轨道上乘上一个依赖于矢量势的相位因子。
*   **优势**:
    1.  **保持周期性**: 继承了速度规范对晶体计算的兼容性。
    2.  **修正相位误差**: 即使使用较小的基组（如 DZP），也能得到与完备基组一致的高精度结果。
    3.  **高效率**: 避免了为了追求精度而不得不使用极昂贵的大基组。

> **专家建议**: 
> 对于**周期性体系（固体、表面、纳米线）**的 rt-TDDFT 计算，请务必开启**混合规范**。这是 ABACUS 区别于其他许多软件的独特优势。

---

## 3.2 关键参数设置指南

在 `INPUT` 文件中进行 rt-TDDFT 计算，主要涉及“开启混合规范”和“定义外加电场”两部分。

### 3.2.1 开启混合规范
我们需要在输入文件中指定规范类型。

> **⚠️ 风险提示 (Risk Note)**
> 由于 ABACUS 的 rt-TDDFT 模块处于快速迭代中，具体的参数名称（Key）可能会随版本更新。以下描述基于物理原理，**请在实操前务必查阅 ABACUS 官方文档中关于 `TDDFT` 输入参数的最新说明**，确认参数名是 `td_gauge`、`prop_gauge` 还是其他变体。

在 `INPUT` 文件中，你需要关注类似如下的设置逻辑：

```bash
# 伪代码示例 - 请核对官方文档确认具体参数名
td_gauge        hybrid      # 核心参数：选择混合规范
td_gauge_fix    0           # (可选) 针对速度规范的经验性修正，使用混合规范时通常设为0
```

*   **Value 选择**:
    *   `hybrid`: **推荐**。适用于周期性体系，精度最高。
    *   `velocity`: 速度规范。仅作为对比测试使用，已知在 LCAO 下有误差。
    *   `length`: 长度规范。仅适用于孤立分子体系（Cluster/Molecule）。

### 3.2.2 定义外加电场 (External Field)
要激发电子，我们需要施加一个含时电场 $\mathbf{E}(t)$。根据研究目的不同，主要有两种激发模式：

#### A. 脉冲激发 (Delta-kick / Gaussian Pulse)
*   **用途**: 计算线性响应物理量，如**光吸收谱**、**介电函数**、**折射率**。
*   **原理**: 在 $t=0$ 时刻施加一个极短的脉冲。根据傅里叶变换原理，一个狄拉克 $\delta$ 函数包含所有频率成分，相当于同时用所有频率的光“踢”了一下电子，一次计算即可得到全频段响应。
*   **参数逻辑**:
    *   **场型**: 选择 `Gaussian` 或 `Step`。
    *   **强度**: 必须足够小（处于线性响应区），通常在 $0.001 \sim 0.01$ a.u. 左右。
    *   **方向**: 根据晶体对称性选择极化方向（x, y, 或 z）。

#### B. 持续强场 (Continuous / Laser Field)
*   **用途**: 研究非线性效应，如 **Rabi 振荡**、**高次谐波产生 (HHG)**。
*   **原理**: 模拟真实的激光束持续照射材料。
*   **参数逻辑**:
    *   **场型**: 通常为正弦/余弦波包。
    *   **强度**: 较大，视具体物理目标而定。

---

## 3.3 案例实操 A：硅 (Si) 单胞的线性响应

我们将复现经典的硅光学性质计算案例。目标是计算 Si 的介电函数。

### 3.3.1 准备工作
请确保你已经完成了 Si 单胞的结构弛豫和自洽计算（SCF），并拥有收敛的电荷密度。

### 3.3.2 输入文件设置 (INPUT)
在 rt-TDDFT 步骤中，`INPUT` 文件需要进行关键修改。

**关键参数清单**:

```bash
INPUT_PARAMETERS
# ... (基础参数如 ecutwfc, basis_type 等保持不变) ...

# --- TDDFT 控制参数 ---
calculation     td_dft      # 开启实时 TDDFT 计算模式 (请核对文档具体value)
nbands          20          # [重要!] 必须手动增加能带数

# --- 时间演化参数 ---
td_dt           0.02        # 时间步长 (通常 0.01~0.05 a.u.)
td_nstep        2000        # 总步数，决定了频谱的分辨率

# --- 规范选择 (核心) ---
td_gauge        hybrid      # 开启混合规范，确保周期性体系结果准确

# --- 外场激发 (模拟 Delta-kick) ---
td_efield_type  gaussian    # 高斯脉冲
td_field_amp    0.001       # 场强 (a.u.)，保持在线性区
td_field_pol    1 0 0       # 电场极化方向 (x方向)
td_field_t0     10.0        # 脉冲中心时间
td_field_sigma  0.5         # 脉冲宽度
```

> **🛑 警示：关于 `nbands` 的设置**
> 在做基态 SCF 计算时，你可能只需要计算占据态（对于 Si 是 4 条价带）。
> 但在 **TDDFT** 中，电子需要被激发到空带上。如果你不手动设置 `nbands`，电子将“无处可去”，激发无法发生！
> **规则**: `nbands` 必须显著大于占据带数目（例如 Si 有 4 个价电子，建议设置 `nbands` 至少为 12~20，甚至更多以覆盖高能激发）。

### 3.3.3 运行与结果分析
提交任务后，ABACUS 会输出每个时间步的电流密度 $J(t)$。

1.  **数据处理**:
    *   从输出文件中提取感应电流 $J(t)$。
    *   对 $J(t)$ 做傅里叶变换得到 $J(\omega)$。
    *   利用公式 $\sigma(\omega) = J(\omega) / E(\omega)$ 计算电导率，进而得到介电函数 $\epsilon(\omega)$。

2.  **结果对比 (混合规范 vs 速度规范)**:
    *   如果你尝试将 `td_gauge` 改为 `velocity` 并重算，你会发现：
        *   **混合规范**: 得到的介电函数 $\epsilon(\omega)$ 在 $\omega \to 0$ 时趋于常数（对于半导体），符合物理预期。
        *   **速度规范**: 在低频区会出现虚假的发散（数值急剧上升），这是由于 LCAO 基组下的相位误差导致的。

### 3.3.4 常见报错与排查
*   **电子不激发**: 检查 `nbands` 是否包含了空带？检查 `td_field_amp` 是否为 0？
*   **能量发散**: 检查 `td_dt` 是否过大？通常 rt-TDDFT 需要极小的时间步长（阿秒级，即 $\sim 0.02$ a.u.）。

---

**本章总结**:
通过本章，你掌握了 ABACUS rt-TDDFT 的核心——**混合规范**。它是你在周期性体系中获得高精度光学性质的保障。下一章，我们将深入探讨如何处理输出数据，绘制高次谐波谱（HHG）。