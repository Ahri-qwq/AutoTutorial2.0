# 第一章：rt-TDDFT 理论基础与规范难题

欢迎来到 ABACUS rt-TDDFT 实战教程的第一章。

在开始编写输入文件之前，我们必须先解决一个核心问题：**为什么在周期性体系（如晶体、表面）中做实时电子动力学模拟如此困难？**

很多初学者在使用 rt-TDDFT 时，往往直接套用分子计算的经验，结果发现在固体中计算出的电流发散，或者光谱在低频区出现非物理的虚假信号。这并非是你操作失误，而是理论本身存在“规范（Gauge）”选择的陷阱。

本章将带你深入理解 rt-TDDFT 的物理图像，并揭示 ABACUS 的杀手锏功能——**混合规范（Hybrid Gauge）**是如何优雅地解决这一难题的。

---

## 1.1 实时演化与 TDKS 方程：从静态到动态

绝大多数 DFT 计算关注的是基态（Ground State），即电子在能量最低时的静态分布。但在激光辐照、电荷输运或高次谐波产生（HHG）等过程中，电子处于剧烈的非平衡态。此时，我们需要求解**含时 Kohn-Sham (TDKS) 方程**：

$$
i\hbar \frac{\partial \psi_j(\mathbf{r},t)}{\partial t} = \hat{H}_{KS}[\rho](\mathbf{r},t) \psi_j(\mathbf{r},t)
$$

这背后的理论基石是 **Runge-Gross 定理**，它证明了在给定初始态下，含时外势与含时电子密度之间存在一一对应关系。

### 为什么选择 rt-TDDFT (Real-Time) 而非 LR-TDDFT (Linear Response)?

在 ABACUS 中，我们通过 `esolver_type` 参数来区分这两种方法。虽然它们同宗同源，但适用场景截然不同：

*   **LR-TDDFT (线性响应)**：
    *   **场景**：弱场微扰。主要用于计算光吸收谱（激发能）。
    *   **局限**：假设外场很弱，电子仅在基态附近微小振荡。无法处理强激光导致的电子电离或非线性光学效应。
*   **rt-TDDFT (实时演化)**：
    *   **场景**：**强场、非线性、远离平衡态**。
    *   **优势**：直接在时间轴上一步步演化波函数（Propagator）。你可以看着电子如何在激光驱动下从价带跃迁到导带，甚至被拉出原子束缚。
    *   **ABACUS 实现**：在 ABACUS 中，通过设置 `esolver_type = tddft` 和 `calculation = md` 来开启此功能。

---

## 1.2 周期性体系的“规范”困境

当我们将 rt-TDDFT 应用于固体（周期性边界条件）时，会立刻撞上一堵墙：**电磁场的规范选择**。

电场 $\mathbf{E}(t)$ 可以通过标量势 $\phi$ 或 矢势 $\mathbf{A}$ 来描述，这就引出了两种规范：

### 1. 长度规范 (Length Gauge)
$$ \hat{H}_{ext} = e \mathbf{E}(t) \cdot \mathbf{r} $$
*   **物理图像**：最直观，类似于外加一个倾斜的电势。
*   **致命缺陷**：位置算符 $\mathbf{r}$ 是无界的。在周期性边界条件（PBC）下，电子绕过边界回到原胞时，势能会发生突变（锯齿波），破坏了哈密顿量的周期性。
*   **结论**：**长度规范原则上不能直接用于周期性固体计算。**

### 2. 速度规范 (Velocity Gauge)
$$ \hat{H}_{ext} = \frac{e}{m} \mathbf{A}(t) \cdot \hat{\mathbf{p}} $$
*   **物理图像**：通过矢势 $\mathbf{A}(t)$ 耦合动量算符 $\hat{\mathbf{p}}$。
*   **优势**：动量算符和矢势都具有平移对称性，**完美保留了周期性**。
*   **隐形陷阱**：这是最令人头疼的地方。在平面波基组中，速度规范工作良好；但在 **原子轨道（LCAO/NAO）基组**（ABACUS 的核心优势）下，速度规范存在严重的**相位误差**。

> **教授视角的深度解析**：
> 在 LCAO 基组下，波函数展开为 $\psi = \sum c_{i} \phi_{i}(\mathbf{r}-\mathbf{R})$。标准的速度规范实现忽略了原子轨道 $\phi_i$ 内部由矢势引起的相位变化。这种近似会导致计算出的电流在低频区域（$\omega \to 0$）出现非物理的发散（Drifting），使得光谱计算完全失真。

---

## 1.3 ABACUS 混合规范 (Hybrid Gauge) 解决方案

为了解决“长度规范破坏周期性”与“速度规范在 LCAO 下精度差”的矛盾，ABACUS 引入了独创的 **混合规范 (Hybrid Gauge)** 算法。

### 核心思想
该方法由中国科学技术大学何力新教授团队提出。其核心在于：在哈密顿量保持速度规范（周期性友好）形式的同时，在原子轨道基组中显式引入一个依赖于矢势的**局域相位因子**：

$$ \phi_{i}^{HG}(\mathbf{r}, t) = e^{-i \frac{e}{\hbar} \mathbf{A}(t) \cdot \mathbf{R}_I} \phi_{i}(\mathbf{r}) $$

其中 $\mathbf{R}_I$ 是原子中心位置。

### 混合规范的“降维打击”
1.  **精度修正**：通过引入相位因子，混合规范在数学形式上找回了被传统速度规范丢失的动力学相位信息。
2.  **保持周期性**：它没有引入无界的 $\mathbf{r}$ 算符，因此完美兼容布洛赫定理，适用于晶体。
3.  **效率极高**：传统方法要消除速度规范的误差，往往需要极大的基组（增加计算成本）；而混合规范在**小基组（如 DZP）**下即可获得与大基组一致的高精度结果。

### 案例实证：Si 单胞的响应
在 ABACUS 的测试案例（如 Si 单胞在激光场下的响应）中：
*   **传统速度规范**：计算得到的电流在脉冲结束后无法归零，导致介电函数在低频区发散。
*   **混合规范**：电流响应准确，介电函数与理论值完美吻合，且能够清晰分辨出高次谐波（HHG）信号（1, 3, 5, 7 次谐波）。

> **结论**：在 ABACUS 中进行周期性体系的 rt-TDDFT 计算时，**混合规范是兼顾精度与效率的最佳选择**。

---

## 1.4 关键参数设置与避坑指南

在理解了理论之后，我们需要在 `INPUT` 文件中落实这些设置。

### 1. 基础功能开启
要进行 rt-TDDFT 计算，以下参数是必须的：

```bash
INPUT_PARAMETERS
# 求解器设置
calculation     md        # 必须设为 md，因为 rt-TDDFT 涉及时间演化
esolver_type    tddft     # 显式指定使用 rt-TDDFT 求解器

# 基组设置
basis_type      lcao      # 目前 rt-TDDFT 仅支持 LCAO 基组
gamma_only      0         # 警告：必须设为 0！
                          # rt-TDDFT 使用复数波函数演化，不支持 gamma_only=1 的实数优化
```

### 2. 极其重要的 `nbands`
这是新手最容易犯的错误。
*   **错误做法**：使用默认的 `nbands`（通常只包含占据态）。
*   **后果**：rt-TDDFT 的本质是电子在能级间跃迁。如果你只计算了占据态，电子就像被困在一个满员的房间里，无法跳到高能级（空态），导致无法发生激发。
*   **正确做法**：**手动设置一个足够大的 `nbands`**，包含足够多的空带。

```bash
# 假设体系有 8 个价电子，默认可能只算 4 或 5 条带
# 做 rt-TDDFT 时，建议显著增加空带数量
nbands          20        # 示例：预留充足的空带供电子跃迁
```

### 3. 混合规范与电场设置 (Risk Note)

由于 ABACUS 版本迭代较快，开启混合规范的具体参数名（例如 `td_gauge` 或类似开关）以及定义激光脉冲形状的参数块，**请务必查阅 ABACUS 官方文档中关于 "TDDFT Input Parameters" 的最新说明**。

通常，你需要关注以下几类参数（参数名仅为示意，请以文档为准）：
*   **规范选择**：寻找选择 `Velocity Gauge` 或 `Hybrid Gauge` 的开关。
*   **外场定义**：定义电场的方向、强度、脉冲形状（高斯型、阶跃型等）及持续时间。

### 4. 占据数控制 (`ocp`)
如果你想模拟非基态的初始分布（例如模拟瞬间激发的电子空穴对），可以使用 `ocp` 参数手动修改占据数：

```bash
ocp             1               # 开启手动占据
ocp_set         1 1 0 0 ...     # 手动指定每条能带的电子数
```

---

**本章总结**：
理解“混合规范”是使用 ABACUS 进行高质量 rt-TDDFT 计算的入场券。它解决了 LCAO 基组在周期性势场中的相位丢失问题，使得我们能够用较低的计算成本，精确模拟固体材料在强场下的非线性动力学行为。

在下一章中，我们将通过一个具体的 **硅（Si）晶体激光激发** 案例，手把手教你编写输入文件并分析输出结果。