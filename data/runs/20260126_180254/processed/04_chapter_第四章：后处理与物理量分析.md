# 第四章：后处理与物理量分析

欢迎来到 ABACUS 实战教程的第四章。在前几章中，我们已经成功让 ABACUS 跑起来了。对于实时含时密度泛函理论（rt-TDDFT）计算而言，任务的结束往往只是工作的开始。

与基态计算直接输出能量或力不同，rt-TDDFT 的输出是一系列随时间剧烈震荡的数据（如电流、偶极矩）。本章的核心任务，就是扮演“数据矿工”的角色，从这些看似杂乱的时间序列中，利用物理学原理（主要是傅里叶变换）挖掘出材料的光学性质（吸收谱、介电函数）以及非线性特征（高次谐波）。

特别地，本章将深入探讨 ABACUS 的**核心杀手锏——混合规范（Hybrid Gauge）**，这是理解高精度 LCAO 基组动力学模拟的关键。

---

## 4.1 关键物理量提取

当 rt-TDDFT 计算完成后，ABACUS 会在输出目录中生成记录时间演化过程的文件。我们需要关注的核心物理量通常是**电流密度 (Current Density, $J(t)$)** 和 **偶极矩 (Dipole Moment, $P(t)$)**。

### 4.1.1 理解输出文件
虽然具体的文件名可能会随版本更新而微调，但通常你会在输出目录（如 `OUT.suffix/`）下找到包含以下关键词的文件：

*   **电流密度 ($J(t)$)**: 记录了体系在三个笛卡尔方向（x, y, z）上随时间变化的宏观电流。这是计算周期性体系（固体）光学性质的核心数据。
*   **偶极矩 ($P(t)$)**: 记录了体系电偶极矩随时间的变化。这通常用于有限体系（如分子、团簇）的光谱分析。

### 4.1.2 数据预处理
在进行分析前，请检查数据的完整性：
1.  **时间步长均匀性**: 确保 `md_dt`（时间步长）在整个文件中是恒定的。
2.  **收敛性检查**: 观察 $t=0$ 时刻的数据，如果初始时刻就有巨大的非物理震荡，可能意味着基态计算未收敛或 `nbands` 设置不足。

---

## 4.2 傅里叶变换与光谱计算

物理图像通常在频率域（$\omega$）中更为清晰。我们需要将时间域信号 $f(t)$ 通过离散傅里叶变换（DFT/FFT）转换为频率域信号 $f(\omega)$。

### 4.2.1 核心公式
对于周期性体系，光电导率 $\sigma(\omega)$ 和介电函数 $\epsilon(\omega)$ 的计算流程如下：

1.  **计算电流谱**:
    $$ J(\omega) = \int_{0}^{T} J(t) e^{-i\omega t} dt $$
2.  **计算外场谱**:
    $$ E(\omega) = \int_{0}^{T} E(t) e^{-i\omega t} dt $$
    *注：如果是脉冲激光，E(t) 是高斯包络或 delta 函数；如果是阶跃光，处理方式略有不同。*
3.  **计算光电导率**:
    $$ \sigma(\omega) = \frac{J(\omega)}{E(\omega)} $$
4.  **计算介电函数**:
    $$ \epsilon(\omega) = 1 + \frac{4\pi i \sigma(\omega)}{\omega} $$

### 4.2.2 数据处理脚本示例 (Python)
由于 ABACUS 输出的是原始数据，建议使用 Python (`numpy`) 进行后处理。以下是一个通用的处理逻辑框架：

```python
import numpy as np
import matplotlib.pyplot as plt

# 1. 读取数据 (假设文件名为 J_t.dat，格式为: time, Jx, Jy, Jz)
data = np.loadtxt('OUT.ABACUS/TDDFT_J.dat') # 请根据实际文件名调整
time = data[:, 0] * 2.418884e-17 # 将原子单位(au)转换为秒(s)，具体单位请查阅文档
J_t = data[:, 1]  # 假设电场沿 x 方向

# 2. 傅里叶变换
dt = time[1] - time[0]
freq = np.fft.rfftfreq(len(time), d=dt)
J_omega = np.fft.rfft(J_t)

# 3. 假设外场 E(t) 是 delta 脉冲 (E_omega 为常数)
# 如果是高斯脉冲，需读取 E(t) 做同样的 FFT
E_omega_const = 0.01 # 示例场强

# 4. 计算光电导率 (简化示例)
sigma = J_omega / E_omega_const

# 5. 绘图
plt.plot(freq, np.abs(sigma))
plt.xlabel('Energy (eV)')
plt.ylabel('Conductivity')
plt.show()
```

---

## 4.3 案例实操 B - 非线性效应与混合规范 (Hybrid Gauge)

本节是本章的**重中之重**。我们将通过硅（Si）的强场激发案例，深入解析 ABACUS 独特的**混合规范（Hybrid Gauge）**技术。

### 4.3.1 为什么我们需要混合规范？
在 rt-TDDFT 计算中，描述光与物质相互作用的规范选择至关重要。这是一个困扰计算物理学界多年的难题，其逻辑链如下：

1.  **长度规范 (Length Gauge)**:
    *   **原理**: $H = H_0 + \mathbf{E} \cdot \mathbf{r}$。
    *   **问题**: 在周期性体系（晶体）中，位置算符 $\mathbf{r}$ 是无界的，破坏了平移对称性。**结论：无法直接用于固体计算。**
2.  **速度规范 (Velocity Gauge)**:
    *   **原理**: 引入矢量势 $\mathbf{A}(t)$，相互作用项为 $\mathbf{p} \cdot \mathbf{A}$。
    *   **优势**: 保持了周期性。
    *   **致命缺陷**: 当使用原子轨道（LCAO）基组时，基函数 $\phi(\mathbf{r})$ 是局域的，无法正确反映外场引起的相位变化。这会导致**严重的系统性误差**，特别是在低频区域，计算出的光谱往往会发散（Drude-like divergence），且结果严重依赖于基组大小。
3.  **ABACUS 的解决方案：混合规范 (Hybrid Gauge)**:
    *   **原理**: 在速度规范的基础上，ABACUS 创新性地在每个原子轨道前引入了一个依赖于矢量势的相位因子：
        $$ \psi_{n\mathbf{k}}(\mathbf{r}, t) = \sum_{\mu} c_{\mu}(t) e^{-i \mathbf{A}(t) \cdot \mathbf{R}_{\mu}} \phi_{\mu}(\mathbf{r} - \mathbf{R}_{\mu}) $$
    *   **核心优势**: 
        *   **精度**: 完美修正了 LCAO 基组的相位误差，结果与全电子或大平面波基组一致。
        *   **效率**: 相比于为了消除误差而不得不使用巨大的基组，混合规范在小基组下就能得到准确结果，计算效率极高。
        *   **通用性**: 既适用于分子，也适用于固体；既适用于线性响应，也适用于强场非线性光学。

> **专家提示**: 如果你使用 ABACUS 进行周期性体系的 rt-TDDFT 计算，**强烈建议**开启混合规范。这是 ABACUS 区别于其他 LCAO 软件的显著优势。

### 4.3.2 案例分析：Si 的高次谐波产生 (HHG)
设定一个强激光场作用于 Si 单胞。

#### 参数设置要点
在 `INPUT` 文件中，除了常规参数外，关注以下几点（具体参数名请参考下文风险提示）：
*   **高强度电场**: 设置较大的 `td_field_amp`（如 $0.01 \sim 0.05$ a.u.）以激发非线性效应。
*   **长演化时间**: 增加 `md_nstep`，保证有足够的时间分辨率来分辨高频信号。
*   **开启混合规范**: 这是关键步骤。

> **Risk Note (风险提示)**: 
> 由于 ABACUS 版本迭代较快，开启混合规范的具体参数名（例如 `td_gauge` 或类似开关）以及定义电场波形的具体参数，请务必**查阅 ABACUS 官方文档中关于 TDDFT 输入参数的最新说明**。文档中通常会有专门针对 `Gauge` 选择的章节。

#### 结果分析
当我们对输出的电流 $J(t)$ 进行分析时，对比传统速度规范和混合规范的结果：

1.  **线性区对比**:
    *   **速度规范**: 在低频区（$\omega \to 0$），介电函数虚部可能出现虚假的“发散”尾巴。
    *   **混合规范**: 结果干净、准确，与实验值或高精度平面波结果吻合。

2.  **非线性区 (HHG)**:
    *   对强场下的 $J(t)$ 做傅里叶变换，取对数坐标绘图。
    *   你将清晰地看到**奇数次谐波**：基频 $\omega_0$ 及其倍频 $3\omega_0, 5\omega_0, 7\omega_0 \dots$。
    *   这是由于 Si 晶体的反演对称性，偶数次谐波被禁止。如果观察到偶数次谐波，说明体系对称性被破坏或计算存在误差。

---

## 附录：常见问题与进阶建议

在进行 rt-TDDFT 计算时，以下陷阱请务必避开：

### 1. 能带数 (nbands) 的陷阱
*   **现象**: 加上电场后，电子不动，或者光谱全为零。
*   **原因**: rt-TDDFT 的本质是电子从占据态跃迁到空态。如果你在 `INPUT` 中设置的 `nbands` 仅仅等于占据态数目（默认行为通常如此），电子就没有“去处”。
*   **解决方案**: **必须手动设置 `nbands`**，使其远大于占据带数目（例如，包含足够多的空带以覆盖你感兴趣的能量范围）。

### 2. 基组收敛性
虽然混合规范修正了相位误差，允许使用较小的基组，但这并不意味着可以使用质量极差的基组。对于高能态（高次谐波涉及的能级），仍需确保基组（如 `DZP` 或更大）能够合理描述这些高能级波函数。

### 3. 对称性破坏
施加外电场是一个矢量操作，它会打破体系原有的空间对称性。
*   在 `INPUT` 中，建议仔细检查 `symmetry` 参数。在某些复杂的动力学模拟中，关闭对称性（`symmetry 0` 或 `-1`）可能是更安全的选择，尽管这会增加计算量。

### 4. 计算资源预估
rt-TDDFT 极其耗时。
*   **建议**: 先用小体系（如单胞）测试 `md_dt`（通常需 $\le 0.05$ fs）和收敛性，估算每一步的耗时，再通过 `md_nstep` 预估总时长，避免任务在超算上因超时被杀。

### 5. 参数速查
*   `calculation`: 必须设为 `md` 或 `rt-tddft` 相关类型。
*   `esolver_type`: `ksdft`。
*   `td_...`: 所有以 `td_` 开头的参数都与含时演化相关，请重点阅读官方文档该部分。