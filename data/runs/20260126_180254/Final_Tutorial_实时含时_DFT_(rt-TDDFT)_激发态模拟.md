# ABACUS 实时含时密度泛函理论（rt-TDDFT）实战指南：从混合规范理论到超快动力学模拟

## 前言

欢迎开启 ABACUS 实时演化含时密度泛函理论（rt-TDDFT）的学习之旅。在计算材料学领域，如果说传统的基态自洽计算（SCF）是在为材料拍摄“静态照片”，那么 rt-TDDFT 则是为电子运动拍摄“超快电影”。作为国产开源密度泛函理论软件的佼佼者，ABACUS 凭借其高效的数值原子轨道（NAO）基组，在处理大规模体系动力学方面具有显著优势。更为重要的是，针对周期性体系中长期存在的“规范不变性”难题，ABACUS 引入了创新的**混合规范（Hybrid Gauge）**技术，这使得它在处理固体材料的超快光谱、高次谐波（HHG）等前沿领域时，兼具了极高的计算精度与数值稳定性。

**学习路线图**
本教程旨在通过循序渐进的四个章节，带你掌握 rt-TDDFT 的核心操作：
1. **理论筑基**：第一章深入剖析周期性体系中的规范选择难题，阐述混合规范的物理必要性。
2. **环境构建**：第二章聚焦参数配置，教你如何从静态计算平滑过渡到时间演化环境。
3. **实战激发**：第三章是核心环节，手把手演示如何施加激光脉冲并激活混合规范进行电子演化。
4. **数据挖掘**：第四章侧重后处理，指导你从剧烈震荡的时域信号中提取吸收谱、介电函数等物理量。

**知识体系定位**
rt-TDDFT 是建立在 Runge-Gross 定理之上的第一性原理方法，主要研究时间依赖的 Kohn-Sham（TDKS）方程。在 ABACUS 的知识图谱中，它处于激发态动力学模块的核心，向上对接 Ehrenfest 动力学（模拟离子实运动），向下承接基态 DFT 的电荷密度与波函数。它是研究光与物质相互作用、非线性光学响应及载流子弛豫等现象的关键手段。

**前置知识要求**
在开始本教程前，我们建议你已具备以下基础：
- 熟练掌握 ABACUS 的基态自洽计算（SCF）流程。
- 了解密度泛函理论（DFT）的基本物理概念。
- 具备基础的 Linux 命令行操作能力及 Python/Matplotlib 数据可视化经验。

---

# 第一章：rt-TDDFT 理论基础与规范难题

欢迎来到 ABACUS rt-TDDFT 实战教程的第一章。

在开始编写输入文件之前，我们必须先解决一个核心问题：**为什么在周期性体系（如晶体、表面）中做实时电子动力学模拟如此困难？**

很多初学者在使用 rt-TDDFT 时，往往直接套用分子计算的经验，结果发现在固体中计算出的电流发散，或者光谱在低频区出现非物理的虚假信号。这并非是你操作失误，而是理论本身存在“规范（Gauge）”选择的陷阱。

本章将带你深入理解 rt-TDDFT 的物理图像，并揭示 ABACUS 的杀手锏功能——**混合规范（Hybrid Gauge）**是如何优雅地解决这一难题的。

---

## 1.1 实时演化与 TDKS 方程：从静态到动态

绝大多数 DFT 计算关注的是基态（Ground State），即电子在能量最低时的静态分布。但在激光辐照、电荷输运或高次谐波产生（HHG）等过程中，电子处于剧烈的非平衡态。此时，我们需要求解**含时 Kohn-Sham (TDKS) 方程**：

$$
i\hbar \frac{\partial \psi_j(\mathbf{r},t)}{\partial t} = \hat{H}_{KS}[\rho](\mathbf{r},t) \psi_j(\mathbf{r},t)
$$

这背后的理论基石是 **Runge-Gross 定理**，它证明了在给定初始态下，含时外势与含时电子密度之间存在一一对应关系。

### 为什么选择 rt-TDDFT (Real-Time) 而非 LR-TDDFT (Linear Response)?

在 ABACUS 中，我们通过 `esolver_type` 参数来区分这两种方法。虽然它们同宗同源，但适用场景截然不同：

*   **LR-TDDFT (线性响应)**：
    *   **场景**：弱场微扰。主要用于计算光吸收谱（激发能）。
    *   **局限**：假设外场很弱，电子仅在基态附近微小振荡。无法处理强激光导致的电子电离或非线性光学效应。
*   **rt-TDDFT (实时演化)**：
    *   **场景**：**强场、非线性、远离平衡态**。
    *   **优势**：直接在时间轴上一步步演化波函数（Propagator）。你可以看着电子如何在激光驱动下从价带跃迁到导带，甚至被拉出原子束缚。
    *   **ABACUS 实现**：在 ABACUS 中，通过设置 `esolver_type = tddft` 和 `calculation = md` 来开启此功能。

---

## 1.2 周期性体系的“规范”困境

当我们将 rt-TDDFT 应用于固体（周期性边界条件）时，会立刻撞上一堵墙：**电磁场的规范选择**。

电场 $\mathbf{E}(t)$ 可以通过标量势 $\phi$ 或 矢势 $\mathbf{A}$ 来描述，这就引出了两种规范：

### 1. 长度规范 (Length Gauge)
$$ \hat{H}_{ext} = e \mathbf{E}(t) \cdot \mathbf{r} $$
*   **物理图像**：最直观，类似于外加一个倾斜的电势。
*   **致命缺陷**：位置算符 $\mathbf{r}$ 是无界的。在周期性边界条件（PBC）下，电子绕过边界回到原胞时，势能会发生突变（锯齿波），破坏了哈密顿量的周期性。
*   **结论**：**长度规范原则上不能直接用于周期性固体计算。**

### 2. 速度规范 (Velocity Gauge)
$$ \hat{H}_{ext} = \frac{e}{m} \mathbf{A}(t) \cdot \hat{\mathbf{p}} $$
*   **物理图像**：通过矢势 $\mathbf{A}(t)$ 耦合动量算符 $\hat{\mathbf{p}}$。
*   **优势**：动量算符和矢势都具有平移对称性，**完美保留了周期性**。
*   **隐形陷阱**：这是最令人头疼的地方。在平面波基组中，速度规范工作良好；但在 **原子轨道（LCAO/NAO）基组**（ABACUS 的核心优势）下，速度规范存在严重的**相位误差**。

> **教授视角的深度解析**：
> 在 LCAO 基组下，波函数展开为 $\psi = \sum c_{i} \phi_{i}(\mathbf{r}-\mathbf{R})$。标准的速度规范实现忽略了原子轨道 $\phi_i$ 内部由矢势引起的相位变化。这种近似会导致计算出的电流在低频区域（$\omega \to 0$）出现非物理的发散（Drifting），使得光谱计算完全失真。

---

## 1.3 ABACUS 混合规范 (Hybrid Gauge) 解决方案

为了解决“长度规范破坏周期性”与“速度规范在 LCAO 下精度差”的矛盾，ABACUS 引入了独创的 **混合规范 (Hybrid Gauge)** 算法。

### 核心思想
该方法由中国科学技术大学何力新教授团队提出。其核心在于：在哈密顿量保持速度规范（周期性友好）形式的同时，在原子轨道基组中显式引入一个依赖于矢势的**局域相位因子**：

$$ \phi_{i}^{HG}(\mathbf{r}, t) = e^{-i \frac{e}{\hbar} \mathbf{A}(t) \cdot \mathbf{R}_I} \phi_{i}(\mathbf{r}) $$

其中 $\mathbf{R}_I$ 是原子中心位置。

### 混合规范的“降维打击”
1.  **精度修正**：通过引入相位因子，混合规范在数学形式上找回了被传统速度规范丢失的动力学相位信息。
2.  **保持周期性**：它没有引入无界的 $\mathbf{r}$ 算符，因此完美兼容布洛赫定理，适用于晶体。
3.  **效率极高**：传统方法要消除速度规范的误差，往往需要极大的基组（增加计算成本）；而混合规范在**小基组（如 DZP）**下即可获得与大基组一致的高精度结果。

### 案例实证：Si 单胞的响应
在 ABACUS 的测试案例（如 Si 单胞在激光场下的响应）中：
*   **传统速度规范**：计算得到的电流在脉冲结束后无法归零，导致介电函数在低频区发散。
*   **混合规范**：电流响应准确，介电函数与理论值完美吻合，且能够清晰分辨出高次谐波（HHG）信号（1, 3, 5, 7 次谐波）。

> **结论**：在 ABACUS 中进行周期性体系的 rt-TDDFT 计算时，**混合规范是兼顾精度与效率的最佳选择**。

---

## 1.4 关键参数设置与避坑指南

在理解了理论之后，我们需要在 `INPUT` 文件中落实这些设置。

### 1. 基础功能开启
要进行 rt-TDDFT 计算，以下参数是必须的：

```bash
INPUT_PARAMETERS
# 求解器设置
calculation     md        # 必须设为 md，因为 rt-TDDFT 涉及时间演化
esolver_type    tddft     # 显式指定使用 rt-TDDFT 求解器

# 基组设置
basis_type      lcao      # 目前 rt-TDDFT 仅支持 LCAO 基组
gamma_only      0         # 警告：必须设为 0！
                          # rt-TDDFT 使用复数波函数演化，不支持 gamma_only=1 的实数优化
```

### 2. 极其重要的 `nbands`
这是新手最容易犯的错误。
*   **错误做法**：使用默认的 `nbands`（通常只包含占据态）。
*   **后果**：rt-TDDFT 的本质是电子在能级间跃迁。如果你只计算了占据态，电子就像被困在一个满员的房间里，无法跳到高能级（空态），导致无法发生激发。
*   **正确做法**：**手动设置一个足够大的 `nbands`**，包含足够多的空带。

```bash
# 假设体系有 8 个价电子，默认可能只算 4 或 5 条带
# 做 rt-TDDFT 时，建议显著增加空带数量
nbands          20        # 示例：预留充足的空带供电子跃迁
```

### 3. 混合规范与电场设置 (Risk Note)

由于 ABACUS 版本迭代较快，开启混合规范的具体参数名（例如 `td_gauge` 或类似开关）以及定义激光脉冲形状的参数块，**请务必查阅 ABACUS 官方文档中关于 "TDDFT Input Parameters" 的最新说明**。

通常，你需要关注以下几类参数（参数名仅为示意，请以文档为准）：
*   **规范选择**：寻找选择 `Velocity Gauge` 或 `Hybrid Gauge` 的开关。
*   **外场定义**：定义电场的方向、强度、脉冲形状（高斯型、阶跃型等）及持续时间。

### 4. 占据数控制 (`ocp`)
如果你想模拟非基态的初始分布（例如模拟瞬间激发的电子空穴对），可以使用 `ocp` 参数手动修改占据数：

```bash
ocp             1               # 开启手动占据
ocp_set         1 1 0 0 ...     # 手动指定每条能带的电子数
```

---

**本章总结**：
理解“混合规范”是使用 ABACUS 进行高质量 rt-TDDFT 计算的入场券。它解决了 LCAO 基组在周期性势场中的相位丢失问题，使得我们能够用较低的计算成本，精确模拟固体材料在强场下的非线性动力学行为。

在下一章中，我们将通过一个具体的 **硅（Si）晶体激光激发** 案例，手把手教你编写输入文件并分析输出结果。

# 第二章：基础参数设置与演化环境构建

在上一章中，我们完成了 ABACUS 的安装与基本运行测试。如果说基态自洽计算（SCF）是描绘材料的“静态肖像”，那么实时含时密度泛函理论（rt-TDDFT）就是拍摄材料电子运动的“超快电影”。

本章我们将确立计算的“地基”。从静态计算过渡到动力学模拟，不仅仅是修改几个参数，更需要物理观念的转变。我们将重点讲解如何激活 rt-TDDFT 模块、如何选择正确的时间步长，以及如何利用 ABACUS 独有的**混合规范（Hybrid Gauge）**技术来保证周期性体系计算的精度与效率。

---

## 2.1 激活 rt-TDDFT 模块：从静态到动态

在 ABACUS 中，rt-TDDFT 的功能集成在分子动力学（MD）的大框架下，但通过特殊的求解器类型来指定电子的演化。我们需要修改 `INPUT` 文件，告诉程序：我们不再寻找能量最低点，而是要让电子随时间“动”起来。

### 核心参数设置

请在你的 `INPUT` 文件中进行如下修改或添加：

```fortran
INPUT_PARAMETERS
# ... (原有基态参数)

# --- 任务类型设置 ---
calculation     md          # 将计算类型设置为分子动力学(MD)框架
esolver_type    tddft       # 指定电子求解器为 rt-TDDFT

# ... (后续参数)
```

*   **`calculation`**: 必须设为 `md`。在 ABACUS 的架构中，时间演化过程（无论是离子移动还是电子演化）都属于 MD 的范畴。
*   **`esolver_type`**: 这是关键开关。设为 `tddft` 后，程序将不再进行波函数的对角化求解，而是使用时间演化算符（Propagator）来更新波函数。

---

## 2.2 ABACUS 的杀手锏：混合规范 (Hybrid Gauge)

在设置具体演化参数之前，作为资深开发者，我必须向你介绍 ABACUS 在 rt-TDDFT 领域的核心竞争力——**混合规范（Hybrid Gauge）**。这是你选择 ABACUS 而非其他软件进行周期性体系激发的最大理由。

### 2.2.1 为什么我们需要混合规范？

在模拟激光或电场对材料的激发时，我们面临一个两难的物理困境：

1.  **长度规范 (Length Gauge)**:
    *   **原理**: 使用标量势 $V = \mathbf{E} \cdot \mathbf{r}$ 描述电场。
    *   **问题**: 在周期性体系（如晶体）中，位置算符 $\mathbf{r}$ 是无界的，这破坏了布洛赫定理（周期性边界条件）。因此，长度规范**无法直接用于固体计算**。

2.  **速度规范 (Velocity Gauge)**:
    *   **原理**: 使用矢量势 $\mathbf{A}(t)$ 描述电场。
    *   **优势**: 保持了哈密顿量的周期性，理论上适用于固体。
    *   **致命缺陷**: 在使用**数值原子轨道 (LCAO)** 基组时，传统速度规范忽略了轨道内部由矢量势引起的相位变化。
    *   **后果**: 这种相位缺失会导致严重的系统性误差，特别是在低频区域，计算出的电流可能会发散，或者光谱出现虚假的峰值。虽然可以通过无限增大基组来缓解，但这会让计算成本爆炸，失去了 LCAO 高效的优势。

### 2.2.2 混合规范的解决方案

ABACUS 引入的 **混合规范 (Hybrid Gauge)** 完美解决了上述矛盾。

*   **核心逻辑**: 它在速度规范的基础上，显式地引入了依赖于矢量势的**局域相位修正因子**。
*   **效果**: 
    *   **精度**: 它修复了 LCAO 基组下的相位误差，给出的结果与全基组极限下的长度规范一致。
    *   **效率**: 它保留了 LCAO 基组计算量小的优势，不需要为了消除误差而使用极大的基组。
    *   **通用性**: 无论是孤立分子还是周期性晶体，无论是弱场还是强场，都能统一处理。

> **实战案例分析**: 
> 在硅（Si）单胞的强场激发模拟中，如果使用传统**速度规范**，计算得到的响应电流往往包含非物理的漂移，且介电函数在低频区出现发散。而使用 ABACUS 的**混合规范**，不仅消除了这些误差，还能准确捕捉到高次谐波（High-harmonic generation, HHG）信号（如 3、5、7 次谐波），其结果具有极高的物理可靠性。

### 2.2.3 风险提示与参数查阅

**Risk Note**: 由于 ABACUS 版本迭代较快，开启混合规范的具体参数名（例如是否涉及 `td_gauge` 或特定的电场设置方式）可能会有细微变化。

*   **行动指南**: 在撰写 `INPUT` 文件时，**请务必查阅 ABACUS 官方文档中关于 "TDDFT" 或 "Systematic Gauge" 部分的最新说明**，确认开启混合规范的具体参数及电场定义的格式。通常默认情况下或通过指定特定的规范参数即可启用。

---

## 2.3 时间尺度与演化步长

rt-TDDFT 模拟的是电子的动力学行为，其时间尺度是**阿秒 (attosecond, $10^{-18}$ s)** 量级，这与传统离子分子动力学的飞秒 ($10^{-15}$ s) 量级有本质区别。

### 关键参数设置

```fortran
# --- 时间演化参数 ---
md_dt       0.05    # 时间步长 (单位通常为飞秒 fs，请以官方文档为准)
md_nstep    2000    # 总演化步数
```

*   **`md_dt` (时间步长)**: 
    *   **物理意义**: 决定了演化算符 $U(t, t+\Delta t)$ 的积分精度。
    *   **设置建议**: 对于电子动力学，步长必须极小。通常建议在 **0.01 fs 到 0.1 fs** 之间。如果步长过大，演化算符将不再幺正（Unitarity），导致总电子数不守恒或能量发散。
    *   **自检方法**: 在输出文件中监控总电子数，如果随时间漂移，说明 `md_dt` 太大了。

*   **`md_nstep` (总步数)**:
    *   决定了模拟的总时长。例如 `md_dt 0.05` * `md_nstep 2000` = 100 fs 的总物理时间。
    *   根据你研究的物理过程（如拉比振荡周期、退相干时间）来决定。

---

## 2.4 电子结构准备：为空带留出空间

这是初学者最容易犯的错误：**只计算了占据态，没有计算空带。**

在基态计算中，我们只关心填满电子的能带。但在 rt-TDDFT 中，电子受到外场激发，会从占据态跃迁到空态（导带）。如果你的计算空间中没有包含空带，电子就“无路可去”，激发现象就无法发生。

### 关键参数设置

```fortran
# --- 电子结构参数 ---
nbands      20      # 能带总数 (必须显著大于占据态数目)
```

*   **`nbands`**: 
    *   **警示**: 默认情况下，ABACUS 可能只计算占据带。做 rt-TDDFT 时，**必须手动设置**一个较大的 `nbands`。
    *   **经验法则**: 
        *   对于绝缘体/半导体：`nbands` 至少应为占据带数目的 1.5 到 2 倍。
        *   对于高能激发（如高次谐波）：需要更多的空带以描述高能连续态。
    *   **检查**: 确保你的赝势和基组能够支持这么多能带。

*   **基组选择 (`orbital_dir`)**:
    *   rt-TDDFT 对基组的质量要求比基态计算更高。建议使用 `DZP` (Double Zeta plus Polarization) 或更高精度的数值原子轨道基组，以确保激发态空间的完备性。

---

## 本章小结：你的 INPUT 文件概览

经过本章的设置，你的 `INPUT` 文件中关于 rt-TDDFT 的核心部分应该如下所示（示例）：

```fortran
INPUT_PARAMETERS
# 基础参数
suffix          Si_excitation
ntype           1
ecutwfc         60

# 激活 rt-TDDFT
calculation     md
esolver_type    tddft

# 演化参数 (电子动力学尺度)
md_dt           0.02      # 20 attoseconds
md_nstep        5000      # Total 100 fs

# 电子结构 (关键！)
nbands          30        # 假设体系有8个价电子，这里留出了大量空带

# 混合规范与电场 (请查阅文档补充具体参数)
# [PARAMETER_MISSING]: td_gauge / td_field_... 
```

**下一步预告**：
地基已经打好。在下一章，我们将正式“通电”——学习如何定义激光脉冲（电场形式、频率、包络），并启动计算观察电子的狂舞。

# 第三章：外场激发与混合规范实战

欢迎来到 ABACUS 实战教程的核心章节。在前两章中，我们已经掌握了如何构建静态的基态体系。现在，我们要让电子“动”起来。

实时含时密度泛函理论（rt-TDDFT）的本质，是模拟电子在含时外场（通常是激光脉冲）作用下的演化行为。本章将带你深入理解 ABACUS 在这一领域的**杀手锏功能——混合规范（Hybrid Gauge）**，并手把手教你如何设置外场来“踢”动硅晶体中的电子。

---

## 3.1 核心原理：为什么必须选择“混合规范”？

在开始写输入文件之前，作为开发者，我必须向你解释清楚一个困扰计算材料学界多年的难题，以及 ABACUS 是如何解决它的。这是你获得准确结果的前提。

### 3.1.1 规范的“不可能三角”
在 rt-TDDFT 计算中，描述光与物质相互作用主要有两种方式（规范）：

1.  **长度规范 (Length Gauge)**:
    *   **原理**: 使用标量势 $V = \mathbf{r} \cdot \mathbf{E}(t)$。
    *   **优点**: 数值稳定性好，物理图像直观。
    *   **致命缺陷**: 位置算符 $\mathbf{r}$ 在周期性边界条件（PBC）下是未定义的（电子跑出边界后坐标会跳变）。因此，**长度规范原则上不能直接用于周期性晶体计算**。

2.  **速度规范 (Velocity Gauge)**:
    *   **原理**: 使用矢量势 $\mathbf{A}(t)$，哈密顿量包含 $\mathbf{p} \cdot \mathbf{A}$ 项。
    *   **优点**: 动量算符 $\mathbf{p}$ 与周期性边界条件完美兼容。
    *   **隐形陷阱**: 在使用原子轨道（LCAO）基组时，速度规范会引入严重的相位误差。
        *   *原因*: 电子在场中运动会积累相位，但有限的原子轨道基组无法完美表达这个由矢量势引起的相位因子 $e^{i\mathbf{A}\cdot\mathbf{r}}$。
        *   *后果*: 计算出的光谱在低频区（$\omega \to 0$）会出现非物理的发散（Drude-like tail），导致介电函数计算错误。虽然增大基组可以缓解，但计算成本会指数级上升。

### 3.1.2 ABACUS 的解决方案：混合规范 (Hybrid Gauge)
为了解决上述两难困境，ABACUS 引入了**混合规范**。这是 ABACUS 在 rt-TDDFT 领域的一项重要算法创新。

*   **核心思想**: 在速度规范的基础上，显式地在原子轨道上乘上一个依赖于矢量势的相位因子。
*   **优势**:
    1.  **保持周期性**: 继承了速度规范对晶体计算的兼容性。
    2.  **修正相位误差**: 即使使用较小的基组（如 DZP），也能得到与完备基组一致的高精度结果。
    3.  **高效率**: 避免了为了追求精度而不得不使用极昂贵的大基组。

> **专家建议**: 
> 对于**周期性体系（固体、表面、纳米线）**的 rt-TDDFT 计算，请务必开启**混合规范**。这是 ABACUS 区别于其他许多软件的独特优势。

---

## 3.2 关键参数设置指南

在 `INPUT` 文件中进行 rt-TDDFT 计算，主要涉及“开启混合规范”和“定义外加电场”两部分。

### 3.2.1 开启混合规范
我们需要在输入文件中指定规范类型。

> **⚠️ 风险提示 (Risk Note)**
> 由于 ABACUS 的 rt-TDDFT 模块处于快速迭代中，具体的参数名称（Key）可能会随版本更新。以下描述基于物理原理，**请在实操前务必查阅 ABACUS 官方文档中关于 `TDDFT` 输入参数的最新说明**，确认参数名是 `td_gauge`、`prop_gauge` 还是其他变体。

在 `INPUT` 文件中，你需要关注类似如下的设置逻辑：

```bash
# 伪代码示例 - 请核对官方文档确认具体参数名
td_gauge        hybrid      # 核心参数：选择混合规范
td_gauge_fix    0           # (可选) 针对速度规范的经验性修正，使用混合规范时通常设为0
```

*   **Value 选择**:
    *   `hybrid`: **推荐**。适用于周期性体系，精度最高。
    *   `velocity`: 速度规范。仅作为对比测试使用，已知在 LCAO 下有误差。
    *   `length`: 长度规范。仅适用于孤立分子体系（Cluster/Molecule）。

### 3.2.2 定义外加电场 (External Field)
要激发电子，我们需要施加一个含时电场 $\mathbf{E}(t)$。根据研究目的不同，主要有两种激发模式：

#### A. 脉冲激发 (Delta-kick / Gaussian Pulse)
*   **用途**: 计算线性响应物理量，如**光吸收谱**、**介电函数**、**折射率**。
*   **原理**: 在 $t=0$ 时刻施加一个极短的脉冲。根据傅里叶变换原理，一个狄拉克 $\delta$ 函数包含所有频率成分，相当于同时用所有频率的光“踢”了一下电子，一次计算即可得到全频段响应。
*   **参数逻辑**:
    *   **场型**: 选择 `Gaussian` 或 `Step`。
    *   **强度**: 必须足够小（处于线性响应区），通常在 $0.001 \sim 0.01$ a.u. 左右。
    *   **方向**: 根据晶体对称性选择极化方向（x, y, 或 z）。

#### B. 持续强场 (Continuous / Laser Field)
*   **用途**: 研究非线性效应，如 **Rabi 振荡**、**高次谐波产生 (HHG)**。
*   **原理**: 模拟真实的激光束持续照射材料。
*   **参数逻辑**:
    *   **场型**: 通常为正弦/余弦波包。
    *   **强度**: 较大，视具体物理目标而定。

---

## 3.3 案例实操 A：硅 (Si) 单胞的线性响应

我们将复现经典的硅光学性质计算案例。目标是计算 Si 的介电函数。

### 3.3.1 准备工作
请确保你已经完成了 Si 单胞的结构弛豫和自洽计算（SCF），并拥有收敛的电荷密度。

### 3.3.2 输入文件设置 (INPUT)
在 rt-TDDFT 步骤中，`INPUT` 文件需要进行关键修改。

**关键参数清单**:

```bash
INPUT_PARAMETERS
# ... (基础参数如 ecutwfc, basis_type 等保持不变) ...

# --- TDDFT 控制参数 ---
calculation     td_dft      # 开启实时 TDDFT 计算模式 (请核对文档具体value)
nbands          20          # [重要!] 必须手动增加能带数

# --- 时间演化参数 ---
td_dt           0.02        # 时间步长 (通常 0.01~0.05 a.u.)
td_nstep        2000        # 总步数，决定了频谱的分辨率

# --- 规范选择 (核心) ---
td_gauge        hybrid      # 开启混合规范，确保周期性体系结果准确

# --- 外场激发 (模拟 Delta-kick) ---
td_efield_type  gaussian    # 高斯脉冲
td_field_amp    0.001       # 场强 (a.u.)，保持在线性区
td_field_pol    1 0 0       # 电场极化方向 (x方向)
td_field_t0     10.0        # 脉冲中心时间
td_field_sigma  0.5         # 脉冲宽度
```

> **🛑 警示：关于 `nbands` 的设置**
> 在做基态 SCF 计算时，你可能只需要计算占据态（对于 Si 是 4 条价带）。
> 但在 **TDDFT** 中，电子需要被激发到空带上。如果你不手动设置 `nbands`，电子将“无处可去”，激发无法发生！
> **规则**: `nbands` 必须显著大于占据带数目（例如 Si 有 4 个价电子，建议设置 `nbands` 至少为 12~20，甚至更多以覆盖高能激发）。

### 3.3.3 运行与结果分析
提交任务后，ABACUS 会输出每个时间步的电流密度 $J(t)$。

1.  **数据处理**:
    *   从输出文件中提取感应电流 $J(t)$。
    *   对 $J(t)$ 做傅里叶变换得到 $J(\omega)$。
    *   利用公式 $\sigma(\omega) = J(\omega) / E(\omega)$ 计算电导率，进而得到介电函数 $\epsilon(\omega)$。

2.  **结果对比 (混合规范 vs 速度规范)**:
    *   如果你尝试将 `td_gauge` 改为 `velocity` 并重算，你会发现：
        *   **混合规范**: 得到的介电函数 $\epsilon(\omega)$ 在 $\omega \to 0$ 时趋于常数（对于半导体），符合物理预期。
        *   **速度规范**: 在低频区会出现虚假的发散（数值急剧上升），这是由于 LCAO 基组下的相位误差导致的。

### 3.3.4 常见报错与排查
*   **电子不激发**: 检查 `nbands` 是否包含了空带？检查 `td_field_amp` 是否为 0？
*   **能量发散**: 检查 `td_dt` 是否过大？通常 rt-TDDFT 需要极小的时间步长（阿秒级，即 $\sim 0.02$ a.u.）。

---

**本章总结**:
通过本章，你掌握了 ABACUS rt-TDDFT 的核心——**混合规范**。它是你在周期性体系中获得高精度光学性质的保障。下一章，我们将深入探讨如何处理输出数据，绘制高次谐波谱（HHG）。

# 第四章：后处理与物理量分析

欢迎来到 ABACUS 实战教程的第四章。在前几章中，我们已经成功让 ABACUS 跑起来了。对于实时含时密度泛函理论（rt-TDDFT）计算而言，任务的结束往往只是工作的开始。

与基态计算直接输出能量或力不同，rt-TDDFT 的输出是一系列随时间剧烈震荡的数据（如电流、偶极矩）。本章的核心任务，就是扮演“数据矿工”的角色，从这些看似杂乱的时间序列中，利用物理学原理（主要是傅里叶变换）挖掘出材料的光学性质（吸收谱、介电函数）以及非线性特征（高次谐波）。

特别地，本章将深入探讨 ABACUS 的**核心杀手锏——混合规范（Hybrid Gauge）**，这是理解高精度 LCAO 基组动力学模拟的关键。

---

## 4.1 关键物理量提取

当 rt-TDDFT 计算完成后，ABACUS 会在输出目录中生成记录时间演化过程的文件。我们需要关注的核心物理量通常是**电流密度 (Current Density, $J(t)$)** 和 **偶极矩 (Dipole Moment, $P(t)$)**。

### 4.1.1 理解输出文件
虽然具体的文件名可能会随版本更新而微调，但通常你会在输出目录（如 `OUT.suffix/`）下找到包含以下关键词的文件：

*   **电流密度 ($J(t)$)**: 记录了体系在三个笛卡尔方向（x, y, z）上随时间变化的宏观电流。这是计算周期性体系（固体）光学性质的核心数据。
*   **偶极矩 ($P(t)$)**: 记录了体系电偶极矩随时间的变化。这通常用于有限体系（如分子、团簇）的光谱分析。

### 4.1.2 数据预处理
在进行分析前，请检查数据的完整性：
1.  **时间步长均匀性**: 确保 `md_dt`（时间步长）在整个文件中是恒定的。
2.  **收敛性检查**: 观察 $t=0$ 时刻的数据，如果初始时刻就有巨大的非物理震荡，可能意味着基态计算未收敛或 `nbands` 设置不足。

---

## 4.2 傅里叶变换与光谱计算

物理图像通常在频率域（$\omega$）中更为清晰。我们需要将时间域信号 $f(t)$ 通过离散傅里叶变换（DFT/FFT）转换为频率域信号 $f(\omega)$。

### 4.2.1 核心公式
对于周期性体系，光电导率 $\sigma(\omega)$ 和介电函数 $\epsilon(\omega)$ 的计算流程如下：

1.  **计算电流谱**:
    $$ J(\omega) = \int_{0}^{T} J(t) e^{-i\omega t} dt $$
2.  **计算外场谱**:
    $$ E(\omega) = \int_{0}^{T} E(t) e^{-i\omega t} dt $$
    *注：如果是脉冲激光，E(t) 是高斯包络或 delta 函数；如果是阶跃光，处理方式略有不同。*
3.  **计算光电导率**:
    $$ \sigma(\omega) = \frac{J(\omega)}{E(\omega)} $$
4.  **计算介电函数**:
    $$ \epsilon(\omega) = 1 + \frac{4\pi i \sigma(\omega)}{\omega} $$

### 4.2.2 数据处理脚本示例 (Python)
由于 ABACUS 输出的是原始数据，建议使用 Python (`numpy`) 进行后处理。以下是一个通用的处理逻辑框架：

```python
import numpy as np
import matplotlib.pyplot as plt

# 1. 读取数据 (假设文件名为 J_t.dat，格式为: time, Jx, Jy, Jz)
data = np.loadtxt('OUT.ABACUS/TDDFT_J.dat') # 请根据实际文件名调整
time = data[:, 0] * 2.418884e-17 # 将原子单位(au)转换为秒(s)，具体单位请查阅文档
J_t = data[:, 1]  # 假设电场沿 x 方向

# 2. 傅里叶变换
dt = time[1] - time[0]
freq = np.fft.rfftfreq(len(time), d=dt)
J_omega = np.fft.rfft(J_t)

# 3. 假设外场 E(t) 是 delta 脉冲 (E_omega 为常数)
# 如果是高斯脉冲，需读取 E(t) 做同样的 FFT
E_omega_const = 0.01 # 示例场强

# 4. 计算光电导率 (简化示例)
sigma = J_omega / E_omega_const

# 5. 绘图
plt.plot(freq, np.abs(sigma))
plt.xlabel('Energy (eV)')
plt.ylabel('Conductivity')
plt.show()
```

---

## 4.3 案例实操 B - 非线性效应与混合规范 (Hybrid Gauge)

本节是本章的**重中之重**。我们将通过硅（Si）的强场激发案例，深入解析 ABACUS 独特的**混合规范（Hybrid Gauge）**技术。

### 4.3.1 为什么我们需要混合规范？
在 rt-TDDFT 计算中，描述光与物质相互作用的规范选择至关重要。这是一个困扰计算物理学界多年的难题，其逻辑链如下：

1.  **长度规范 (Length Gauge)**:
    *   **原理**: $H = H_0 + \mathbf{E} \cdot \mathbf{r}$。
    *   **问题**: 在周期性体系（晶体）中，位置算符 $\mathbf{r}$ 是无界的，破坏了平移对称性。**结论：无法直接用于固体计算。**
2.  **速度规范 (Velocity Gauge)**:
    *   **原理**: 引入矢量势 $\mathbf{A}(t)$，相互作用项为 $\mathbf{p} \cdot \mathbf{A}$。
    *   **优势**: 保持了周期性。
    *   **致命缺陷**: 当使用原子轨道（LCAO）基组时，基函数 $\phi(\mathbf{r})$ 是局域的，无法正确反映外场引起的相位变化。这会导致**严重的系统性误差**，特别是在低频区域，计算出的光谱往往会发散（Drude-like divergence），且结果严重依赖于基组大小。
3.  **ABACUS 的解决方案：混合规范 (Hybrid Gauge)**:
    *   **原理**: 在速度规范的基础上，ABACUS 创新性地在每个原子轨道前引入了一个依赖于矢量势的相位因子：
        $$ \psi_{n\mathbf{k}}(\mathbf{r}, t) = \sum_{\mu} c_{\mu}(t) e^{-i \mathbf{A}(t) \cdot \mathbf{R}_{\mu}} \phi_{\mu}(\mathbf{r} - \mathbf{R}_{\mu}) $$
    *   **核心优势**: 
        *   **精度**: 完美修正了 LCAO 基组的相位误差，结果与全电子或大平面波基组一致。
        *   **效率**: 相比于为了消除误差而不得不使用巨大的基组，混合规范在小基组下就能得到准确结果，计算效率极高。
        *   **通用性**: 既适用于分子，也适用于固体；既适用于线性响应，也适用于强场非线性光学。

> **专家提示**: 如果你使用 ABACUS 进行周期性体系的 rt-TDDFT 计算，**强烈建议**开启混合规范。这是 ABACUS 区别于其他 LCAO 软件的显著优势。

### 4.3.2 案例分析：Si 的高次谐波产生 (HHG)
设定一个强激光场作用于 Si 单胞。

#### 参数设置要点
在 `INPUT` 文件中，除了常规参数外，关注以下几点（具体参数名请参考下文风险提示）：
*   **高强度电场**: 设置较大的 `td_field_amp`（如 $0.01 \sim 0.05$ a.u.）以激发非线性效应。
*   **长演化时间**: 增加 `md_nstep`，保证有足够的时间分辨率来分辨高频信号。
*   **开启混合规范**: 这是关键步骤。

> **Risk Note (风险提示)**: 
> 由于 ABACUS 版本迭代较快，开启混合规范的具体参数名（例如 `td_gauge` 或类似开关）以及定义电场波形的具体参数，请务必**查阅 ABACUS 官方文档中关于 TDDFT 输入参数的最新说明**。文档中通常会有专门针对 `Gauge` 选择的章节。

#### 结果分析
当我们对输出的电流 $J(t)$ 进行分析时，对比传统速度规范和混合规范的结果：

1.  **线性区对比**:
    *   **速度规范**: 在低频区（$\omega \to 0$），介电函数虚部可能出现虚假的“发散”尾巴。
    *   **混合规范**: 结果干净、准确，与实验值或高精度平面波结果吻合。

2.  **非线性区 (HHG)**:
    *   对强场下的 $J(t)$ 做傅里叶变换，取对数坐标绘图。
    *   你将清晰地看到**奇数次谐波**：基频 $\omega_0$ 及其倍频 $3\omega_0, 5\omega_0, 7\omega_0 \dots$。
    *   这是由于 Si 晶体的反演对称性，偶数次谐波被禁止。如果观察到偶数次谐波，说明体系对称性被破坏或计算存在误差。

---

## 附录：常见问题与进阶建议

在进行 rt-TDDFT 计算时，以下陷阱请务必避开：

### 1. 能带数 (nbands) 的陷阱
*   **现象**: 加上电场后，电子不动，或者光谱全为零。
*   **原因**: rt-TDDFT 的本质是电子从占据态跃迁到空态。如果你在 `INPUT` 中设置的 `nbands` 仅仅等于占据态数目（默认行为通常如此），电子就没有“去处”。
*   **解决方案**: **必须手动设置 `nbands`**，使其远大于占据带数目（例如，包含足够多的空带以覆盖你感兴趣的能量范围）。

### 2. 基组收敛性
虽然混合规范修正了相位误差，允许使用较小的基组，但这并不意味着可以使用质量极差的基组。对于高能态（高次谐波涉及的能级），仍需确保基组（如 `DZP` 或更大）能够合理描述这些高能级波函数。

### 3. 对称性破坏
施加外电场是一个矢量操作，它会打破体系原有的空间对称性。
*   在 `INPUT` 中，建议仔细检查 `symmetry` 参数。在某些复杂的动力学模拟中，关闭对称性（`symmetry 0` 或 `-1`）可能是更安全的选择，尽管这会增加计算量。

### 4. 计算资源预估
rt-TDDFT 极其耗时。
*   **建议**: 先用小体系（如单胞）测试 `md_dt`（通常需 $\le 0.05$ fs）和收敛性，估算每一步的耗时，再通过 `md_nstep` 预估总时长，避免任务在超算上因超时被杀。

### 5. 参数速查
*   `calculation`: 必须设为 `md` 或 `rt-tddft` 相关类型。
*   `esolver_type`: `ksdft`。
*   `td_...`: 所有以 `td_` 开头的参数都与含时演化相关，请重点阅读官方文档该部分。

---

## 附录：进阶学习指南

恭喜你完成了本教程的基础实战！rt-TDDFT 是一个深邃且充满活力的领域，为了帮助你进一步从“使用者”成长为“研究者”，我们提供以下进阶方向：

### 1. 深度扩展阅读
- **混合规范的算法细节**：如果你对算法底层逻辑感兴趣，强烈建议阅读赵昊天、何力新教授发表的相关论文，深入理解矢势依赖的时变相位是如何修正局域基组不完备性误差的。
- **Ehrenfest 动力学**：本教程主要关注电子演化。在实际研究中，电子与离子的耦合同样重要。你可以尝试探索 ABACUS 中的 `calculation md` 模式与 `esolver_type tddft` 的结合，模拟光激发下的晶格畸变。
- **强场物理与非线性光学**：利用 rt-TDDFT 输出的电流密度，可以进一步计算高次谐波产生（HHG），这是目前超快物理领域的热点方向。

### 2. 通用调试建议 (Troubleshooting)
- **步长稳定性**：如果计算发散，请优先检查 `td_timestep`。通常 0.1~1.0 as（阿秒）是比较稳健的选择。
- **基组完备性**：NAO 基组的大小对激发态描述至关重要。若光谱结果与实验差异较大，请尝试增加轨道基组的数量（如使用 DZP 或 TZP）。
- **规范检查**：在处理周期性固体时，请务必确认是否开启了混合规范，以避免低频区的非物理虚假信号。

### 3. 官方资源与社区
- **官方文档**：有关输入参数的最新定义，请实时查阅 [ABACUS 在线文档](https://abacus.deepmodeling.com/en/latest/advanced/input_files/input-main.html#tddft-time-dependent-density-functional-theory)。
- **算例仓库**：更多复杂的 rt-TDDFT 算例（如改变占据数激发等）可在 [ABACUS User Guide 仓库](https://gitee.com/mcresearch/abacus-user-guide/tree/master/examples/tddft) 中找到。

科学探索永无止境，愿你能利用 ABACUS 揭开微观世界超快过程的奥秘！
