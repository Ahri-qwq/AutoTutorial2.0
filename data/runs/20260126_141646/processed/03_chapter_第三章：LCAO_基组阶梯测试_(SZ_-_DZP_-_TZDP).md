# 第三章：LCAO 基组阶梯测试 (SZ -> DZP -> TZDP)

这是一个关于 ABACUS 软件 LCAO 基组选择的核心实战章节。作为开发者和教授，我将带你深入理解数值原子轨道（NAO）的精度阶梯，并避开新手常犯的参数设置误区。

---

# 第三章：LCAO 基组阶梯测试 (SZ -> DZP -> TZDP)

在上一章我们完成了平面波（PW）基组的收敛性测试，确立了体系的“真值”基准。本章我们将进入 ABACUS 的核心优势领域——**LCAO（原子轨道线性组合）** 模式。

LCAO 模式的效率远高于 PW，但其精度高度依赖于所选的轨道基组（Basis Set）。我们将通过“控制变量法”，从粗糙的 SZ 基组开始，逐步升级到标准的 DZP 和高精度的 TZDP，并与 PW 结果进行对比，从而掌握如何在精度与效率之间找到最佳平衡点。

## 3.0 实验前的关键认知与准备

在开始之前，请务必理解以下三个核心原则，否则测试将失去意义：

1.  **控制变量法**：在对比不同精度轨道（如 SZ vs DZP）时，**必须保持赝势文件（UPF/Vanderbilt）不变**，同时 K 点网格（`kspacing` 或 `KPT` 文件）必须与 PW 基准计算保持一致。
2.  **Ecut 的误区**：在 LCAO 模式下，`ecutwfc` **不决定基组的大小**（这是与 PW 模式最大的不同）。它仅决定积分网格的密度。试图通过调大 `ecutwfc` 来修复 SZ 基组的误差是徒劳的，提高精度的唯一方法是更换更完备的轨道文件。
3.  **基准线（Ground Truth）**：请确保你已经完成了一次 `basis_type = pw` 的计算。根据变分原理，在相同赝势下，LCAO 的能量通常会略高于 PW（约 0.1-0.2 eV/atom），这是正常的物理现象。

---

## 3.1 最小基组 (SZ) 的快速预估

**SZ (Single-Zeta)** 是最基础的基组，每个角动量通道只有一条径向函数。它计算极快，但精度较低，通常用于极大规模体系的初步弛豫或紧束缚模型研究。

### 3.1.1 读懂轨道文件名
ABACUS 的轨道文件通常遵循特定命名规范，例如：
`Si_gga_7au_100Ry_s2p1.orb`

*   **Si**: 元素名称。
*   **gga**: 生成轨道时使用的泛函类型（需与赝势一致）。
*   **7au**: **截断半径 (Cutoff Radius)**。半径越大，轨道描述越精确，但哈密顿量矩阵越稀疏度越低（计算越慢）。
*   **100Ry**: **推荐截断能**。这是生成轨道时使用的网格精度，也是你在 `INPUT` 中设置 `ecutwfc` 的参考值。
*   **s2p1**: **核心标识**。表示有 2 个 s 轨道，1 个 p 轨道。通常 SZ 带有较少的轨道数和极化函数。

### 3.1.2 修改 STRU 文件
在 LCAO 模式下，`STRU` 文件中的 `ATOMIC_SPECIES` 区块需要显式指定轨道文件。

**STRU 示例 (SZ 配置)**：
```abacus
ATOMIC_SPECIES
Si  28.0855  Si_ONCV_PBE-1.0.upf  Si_gga_7au_100Ry_s2p1.orb
```
*注意：第四列即为轨道文件名。请确保该文件位于 `orbital_dir` 指定的目录下。*

### 3.1.3 修改 INPUT 文件
将计算模式从平面波切换为 LCAO。

**INPUT 关键参数**：
```abacus
INPUT_PARAMETERS
# ... 其他参数保持不变 ...
basis_type      lcao        # 开启 LCAO 模式
ks_solver       genelpa     # 推荐的对角化求解器 (或 scalapack_gvx)
ecutwfc         100         # 设置为轨道文件推荐的值
orbital_dir     ./          # 轨道文件所在路径
```

运行计算后，你会发现计算速度极快，但总能量与 PW 基准相比可能有较大偏差（例如 > 1 eV/atom），且力（Force）的准确度较差。这证实了 SZ 仅适用于定性分析。

---

## 3.2 标准基组 (DZP) 与高精度基组 (TZDP) 的进阶

为了获得发表级的计算精度，我们需要引入更完备的基组。

*   **DZP (Double-Zeta Polarized)**：标准配置。双倍径向函数 + 极化轨道（例如 Si 的 d 轨道）。适用于绝大多数物理化学性质计算。
*   **TZDP (Triple-Zeta Doubly Polarized)**：高精度配置。三倍径向函数 + 双重极化。用于对精度要求极高的基准测试。

### 3.2.1 轨道文件的替换
假设我们有以下两个文件：
1.  **DZP**: `Si_gga_7au_100Ry_2s2p1d.orb` (2s, 2p, 1d)
2.  **TZDP**: `Si_gga_7au_100Ry_3s3p2d.orb` (3s, 3p, 2d)

**操作步骤**：
只需修改 `STRU` 文件中的第四列文件名即可，无需更改 `INPUT` 中的 `ecutwfc`（只要轨道文件推荐值相同）。

**STRU 示例 (DZP 配置)**：
```abacus
ATOMIC_SPECIES
Si  28.0855  Si_ONCV_PBE-1.0.upf  Si_gga_7au_100Ry_2s2p1d.orb
```

### 3.2.2 深入理解 ecutwfc 在 LCAO 中的作用
很多初学者在从 PW 转到 LCAO 时会感到困惑：**为什么换了更准的 TZDP 轨道，`ecutwfc` 还是 100 Ry？**

*   **物理意义**：在 LCAO 中，基组是预先数值定义好的。`ecutwfc` 此时控制的是**实空间积分网格的精细度**。我们需要足够密的网格来准确计算轨道间的重叠积分（Overlap）和哈密顿量矩阵元。
*   **设置原则**：使用轨道文件名中标识的数值（如 100Ry）通常已经足够消除“蛋格效应”（Egg-box effect）。
*   **警告**：如果你将 `ecutwfc` 设得过低（如 40 Ry），会导致数值积分误差，使得变分原理失效（能量可能不正常地低于 PW 结果）。

### 3.2.3 求解器选择 (ks_solver)
随着基组变大（TZDP），矩阵维数增加。
*   默认推荐使用 `ks_solver = genelpa`（基于 ELPA 库，速度快）。
*   如果遇到并行报错或内存溢出，可切换为 `ks_solver = scalapack_gvx`（稳定性更好，但稍慢）。

---

## 3.3 混合基组策略（进阶技巧）

在处理大型复杂体系（如表面吸附、缺陷计算）时，我们往往面临两难：全用 TZDP 太慢，全用 SZ 不准。此时可以使用**混合基组策略**。

**场景**：计算 CO 分子在 Au(111) 表面的吸附。
*   **关键区域**：CO 分子和表层 Au 原子 -> 使用 **TZDP** 或 **DZP**。
*   **环境区域**：底层的 Au 原子（仅起体相固定作用） -> 使用 **SZ**。

### 3.3.1 STRU 文件的多轨道写法
ABACUS 允许在 `ATOMIC_SPECIES` 中定义同种元素的不同“类型”，分别挂载不同的轨道文件。

**STRU 示例 (混合精度)**：
```abacus
ATOMIC_SPECIES
# 标签      质量      赝势文件              轨道文件
Au_surf    196.967   Au_ONCV.upf          Au_gga_7au_100Ry_2s2p1d.orb  # DZP: 用于表面
Au_bulk    196.967   Au_ONCV.upf          Au_gga_7au_100Ry_s1p1.orb    # SZ:  用于底层
C          12.011    C_ONCV.upf           C_gga_6au_100Ry_2s2p1d.orb   # DZP
O          15.999    O_ONCV.upf           O_gga_6au_100Ry_2s2p1d.orb   # DZP

ATOMIC_POSITIONS
Direct
# 使用定义的标签
Au_surf    0.0000000000    0.0000000000    0.5000000000 1 1 1
Au_bulk    0.5000000000    0.5000000000    0.0000000000 0 0 0
...
```

通过这种方式，你可以在保证关键反应位点精度的同时，大幅降低哈密顿量的维度，显著提升计算效率。

---

## 3.4 结果分析与验收标准

完成 SZ、DZP、TZDP 的计算后，请整理如下表格进行对比（以 PW 结果为基准）：

| 基组类型 | 轨道数/原子 | 总能量 (eV) | 能量差 (vs PW) | 耗时 (s) | 评价 |
| :--- | :---: | :---: | :---: | :---: | :--- |
| **PW (100Ry)** | N/A | -1000.500 | 0 (Ref) | 1000 | **真值基准** |
| **SZ** | 4 | -998.200 | +2.300 | 50 | 仅供粗略参考 |
| **DZP** | 13 | -1000.350 | +0.150 | 120 | **性价比之选** |
| **TZDP** | 22 | -1000.480 | +0.020 | 300 | 高精度 |

**验收标准**：
1.  **能量顺序**：应满足 $E_{PW} \le E_{TZDP} \le E_{DZP} \le E_{SZ}$。如果 LCAO 能量显著低于 PW，请检查是否使用了不同的赝势，或 `ecutwfc` 设置过低导致积分误差。
2.  **收敛性**：通常 DZP 的结果与 PW 的能量差在 0.1~0.2 eV/atom 范围内，且晶格常数误差 < 1%，即视为可用的生产级参数。

通过本章的测试，你应该已经选定了一套适合你体系的轨道文件（通常是 DZP）。在下一章，我们将探讨如何利用 ABACUS 独特的“基组优化”功能，进一步压榨 LCAO 的潜力。