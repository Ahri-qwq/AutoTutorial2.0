# 第四章：结果分析与精度评估

在前几章中，我们已经成功运行了基于平面波（PW）和不同精度数值原子轨道（LCAO-SZ/DZP/TZDP）的计算。面对终端输出的一堆数据，初学者往往会感到迷茫：**到底哪个结果是可信的？DZP 够用了吗？为什么 LCAO 的能量总比 PW 高？**

本章我们将像剥洋葱一样，通过绝对能量对比、能量-体积（E-V）曲线扫描以及计算效率评估，建立一套科学的精度验证体系。

---

## 4.1 绝对能量与相对趋势分析

首先，我们需要明确一个计算材料学的核心公理：**DFT 计算出的绝对总能量（Total Energy）本身没有物理意义，有意义的是能量差（Energy Difference）。**

但是，在评估基组精度时，绝对能量是一个重要的参考指标。根据**变分原理**，在相同的哈密顿量（相同的泛函、赝势）下，基组越完备，计算得到的总能量越低（越接近真实基态）。

### 4.1.1 建立基准线（Benchmark）

在进行 LCAO 精度测试时，**必须**首先进行一组高精度的 PW 计算作为“真值”。

*   **控制变量法（关键）**：
    在对比测试中，以下参数必须在所有计算中保持严格一致，否则对比无效：
    *   `pseudo_dir` 下的赝势文件（`.upf` 或 `.vanderbilt`）。
    *   `kspacing` 或 K 点网格密度。
    *   `xc` 交换关联泛函。
    *   `ecutwfc`（虽然 PW 和 LCAO 对截断能敏感度不同，但建议设定为赝势建议的高值，如 80-100 Ry，以消除积分网格带来的误差）。

### 4.1.2 数据提取与对比

假设我们计算了体相硅（Si）在不同基组下的总能量（单位：eV），数据可能如下（仅为示例）：

| 基组类型 | 轨道配置 (Configuration) | 总能量 (eV) | 相对 PW 误差 (eV/atom) |
| :--- | :--- | :--- | :--- |
| **PW (基准)** | Plane Wave (Ecut=100Ry) | -216.500 | 0.000 |
| **LCAO-TZDP** | 2s2p1d | -216.485 | +0.015 |
| **LCAO-DZP** | 2s2p1d (较小半径或基函数少) | -216.420 | +0.080 |
| **LCAO-SZ** | 1s1p | -214.800 | +1.700 |

**分析结论**：
1.  **$E_{LCAO} > E_{PW}$ 是正常的**：由于数值原子轨道是截断的（有限半径），而平面波在全空间展开（完备基），LCAO 的能量通常会略高于 PW。
2.  **收敛趋势**：随着基组从 SZ $\to$ DZP $\to$ TZDP 增大，能量应逐渐降低并逼近 PW 结果。
3.  **精度判断**：通常情况下，如果 TZDP 与 PW 的能量差在 **10-50 meV/atom** 以内，我们认为该基组在能量描述上是合格的。

> **⚠️ 误区警示：Ecut 的作用**
> 在 LCAO 模式下，很多初学者发现能量不准，第一反应是调大 `ecutwfc`。
> **这是徒劳的！**
> 在 LCAO 中，`ecutwfc` 仅控制积分网格的密度。一旦网格足够密（通常 >60 Ry），误差主要来源于**基组的不完备性**（即轨道太少或截断半径太短）。要提高精度，必须更换更高级的轨道文件（如从 SZ 换到 DZP），而不是死磕 `ecutwfc`。

---

## 4.2 能量-体积 (E-V) 曲线扫描

单点能的对比可能受偶然因素影响。更具物理意义的检验方法是计算**状态方程（Equation of State, EOS）**，即扫描一系列不同晶格常数下的能量，拟合得到平衡晶格常数 ($a_0$) 和体模量 ($B_0$)。

### 4.2.1 扫描策略

我们需要改变晶胞体积，进行多次 `calculation = scf` 计算。

*   **操作方法**：准备 5-7 个结构文件（`STRU`），体积范围覆盖平衡体积的 $\pm 5\%$ 到 $\pm 10\%$。
*   **关键参数**：
    *   `calculation`: `scf`
    *   `basis_type`: `lcao` (针对不同轨道分别测试) vs `pw`

### 4.2.2 简易脚本示例 (Shell)

虽然可以使用 Python (ASE/Pymatgen) 自动化，但为了理解原理，这里展示一个简单的 Shell 脚本逻辑，用于批量修改晶格常数并计算：

```bash
#!/bin/bash

# 定义晶格常数缩放因子列表
scales=(0.94 0.96 0.98 1.00 1.02 1.04 1.06)
basis="Si_gga_7au_100Ry_2s2p1d.orb" # 当前测试的轨道

for s in "${scales[@]}"
do
    work_dir="run_${s}"
    mkdir -p $work_dir
    
    # 1. 复制输入文件
    cp INPUT KPT $basis $work_dir/
    # 假设赝势在上一级目录
    
    # 2. 生成新的 STRU (这里假设原始 STRU 晶格常数为 10.2 bohr)
    # 注意：实际操作中建议用 Python 生成 STRU 以保证精度
    new_lat=$(echo "10.2 * $s" | bc -l)
    
    cat > $work_dir/STRU <<EOF
ATOMIC_SPECIES
Si 28.086 Si_ONCV_PBE-1.0.upf $basis

LATTICE_CONSTANT
$new_lat  

LATTICE_VECTORS
0.5 0.5 0.0
0.5 0.0 0.5
0.0 0.5 0.5

ATOMIC_POSITIONS
Direct
Si 0.00 0.00 0.00 1 1 1
Si 0.25 0.25 0.25 1 1 1
EOF

    # 3. 运行 ABACUS
    cd $work_dir
    mpirun -np 4 abacus > running.log
    
    # 4. 提取能量
    e_tot=$(grep "Final Etot" OUT.*/running_scf.log | awk '{print $4}')
    echo "Scale: $s, Energy: $e_tot" >> ../ev_curve.data
    cd ..
done
```

### 4.2.3 结果分析

将 `ev_curve.data` 中的数据绘制成曲线（抛物线状）。

*   **合格标准**：
    *   **DZP/TZDP** 的曲线最低点（平衡位置）应与 **PW** 的最低点非常接近。
    *   **SZ** 曲线通常会发生显著偏移（例如 $a_0$ 偏大或偏小），且曲率（对应体模量 $B_0$）可能完全错误。这就是为什么我们强调 SZ 不能用于发表文章。

---

## 4.3 效率评估：时间与内存

在科研中，我们追求的是“性价比”。如果 TZDP 比 DZP 慢 10 倍但精度只提升 0.1%，那么 DZP 可能是更好的选择。

### 4.3.1 查看计算消耗

ABACUS 的运行日志（通常在 `OUT.suffix/running_scf.log` 或屏幕输出）末尾提供了详细的性能统计。

**关注指标**：
1.  **Total Time**: 总运行时间。
2.  **Memory**: 峰值内存占用（部分版本显示，或通过系统 `time -v` 命令查看）。

### 4.3.2 典型对比表

| 指标 | PW (100Ry) | LCAO-SZ | LCAO-DZP | LCAO-TZDP |
| :--- | :--- | :--- | :--- | :--- |
| **单步 SCF 时间** | 100% (基准) | ~5% | ~15% | ~40% |
| **内存占用** | 高 | 极低 | 低 | 中 |
| **精度 (eV/atom)** | 0 | +1.7 | +0.08 | +0.015 |

**决策建议**：
*   **高通量筛选/预弛豫**：使用 **SZ** 或 **DZP**。
*   **最终性质计算（能带、DOS、精密结构）**：使用 **DZP**（如果验证过精度够用）或 **TZDP**。
*   **大体系（>500 原子）**：PW 通常内存爆炸，必须使用 **LCAO-DZP**。

---

## 附录：常见问题与避坑指南

### A.1 如何解读轨道文件名？
ABACUS 的轨道文件命名通常包含关键信息，例如 `Si_gga_7au_100Ry_2s2p1d.orb`：
*   `Si`: 元素。
*   `gga`: 泛函类型（需与赝势匹配）。
*   `7au`: **截断半径 ($R_{cut}$)**。这是 LCAO 的核心参数。
    *   **越大**：精度越高，但计算越慢，稀疏矩阵变稠密，内存消耗激增。
    *   **越小**：计算极快，但精度下降。
*   `100Ry`: 生成该轨道时使用的参考截断能（建议计算时的 `ecutwfc` 不低于此值）。
*   `2s2p1d`: **轨道配置**。
    *   这是判断基组大小的依据。例如 Si 价电子是 $3s^2 3p^2$。
    *   `1s1p` = SZ (Minimal Basis)
    *   `2s2p1d` = DZP (Double Zeta + Polarization)
    *   `3s3p2d1f` = TZDP (Triple Zeta + Double Polarization)

### A.2 BSSE 误差（基组重叠误差）
在计算吸附能或分子间相互作用时，LCAO 容易出现 BSSE 误差（由于表面借用了吸附分子的基函数导致能量人为降低）。
*   **对策**：PW 基组不存在 BSSE。如果使用 LCAO 计算弱相互作用，务必进行 CP (Counterpoise) 矫正（目前需手动处理或借助脚本）。

### A.3 求解器崩溃与并行错误
如果你在并行计算大体系时遇到 `segmentation fault` 或 `ELPA` 相关的错误：
*   **原因**：默认的 `ks_solver = genelpa` 在某些硬件或并行配置下可能不稳定。
*   **解决**：在 `INPUT` 中修改求解器为 ScaLAPACK（速度稍慢但极稳）：
    ```bash
    ks_solver  scalapack
    ```

### A.4 内存爆炸风险
*   **现象**：程序刚启动就被系统 Kill。
*   **原因**：使用了过大的截断半径（如 > 10 au）配合 TZDP 基组，或者体系原子极其密集。
*   **解决**：
    1.  检查 `STRU` 中是否误用了长半径轨道。
    2.  尝试减小 `ecutwfc`（影响辅助网格内存）。
    3.  增加节点数（增加总内存）。

### A.5 再次强调：不可用的 SZ
**切记**：SZ (Single Zeta) 基组仅包含最小基，缺乏极化函数，无法正确描述化学键的形变。**严禁将 SZ 的计算结果（无论是结构还是能量）直接用于发表论文**，它只能用于快速测试代码流程或极其粗糙的初始猜测。