# ABACUS 第一性原理计算实战：从平面波基准到数值原子轨道精度阶梯

## 前言

欢迎开启 ABACUS 的深度学习之旅。在当今计算材料学领域，ABACUS（基于原子轨道的国产第一性原理计算软件）正以其独特的双基组设计——平面波（Plane Wave, PW）与数值原子轨道（LCAO）——在学术界和工业界崭露头角。ABACUS 的核心优势在于它既能提供平面波基组的高精度“真值”，又能通过 LCAO 模式实现海量原子体系的高效模拟，这种“精度与效率”的平衡是其最迷人之处。

**学习路线图**
本教程旨在帮助读者跨越“跑通代码”到“科学计算”的鸿沟。全书逻辑严密：
- **第一章**奠定物理基础，确立“控制变量”的测试逻辑；
- **第二章**通过平面波计算建立体系的精度基准（Benchmark）；
- **第三章**带你攀登 LCAO 基组阶梯（从 SZ 到 TZDP），理解数值原子轨道的收敛行为；
- **第四章**则聚焦于结果分析，通过能量-体积（E-V）曲线等科学手段评估计算的可靠性。

**知识体系定位**
在整个密度泛函理论（DFT）的学习版图中，本教程处于“方法论验证与实战进阶”的核心位置。它不只是教你如何修改 `INPUT` 文件，更是引导你理解基组完备性、赝势收敛性以及计算效率优化等深层科学问题。这不仅是掌握 ABACUS 的必经之路，也是理解计算物理严谨性的重要实践。

**前置要求**
在开始之前，我们希望你已具备：
1. 基础的固体物理与量子力学常识；
2. 密度泛函理论（DFT）的基本概念（如 Kohn-Sham 方程）；
3. 基础的 Linux 命令行操作能力。

让我们一起在 ABACUS 的世界里，建立起属于你的精准计算体系。

---

# 第一章：物理基础与测试策略

欢迎来到 ABACUS 实战教程的第一章。

很多初学者在拿到软件后，往往急于修改 `INPUT` 文件里的参数让程序“跑起来”。但在计算材料学中，“跑通”和“算对”之间隔着巨大的鸿沟。作为一款同时支持**平面波 (Plane Wave, PW)** 和 **数值原子轨道 (LCAO)** 双基组的软件，ABACUS 赋予了用户极大的灵活性，但也带来了选择的困惑。

本章将不涉及复杂的代码操作，而是为你建立一套严谨的**基准测试（Benchmark）逻辑**。在动手计算前，你必须理解我们手中的“尺子”——基组——是如何工作的，以及如何通过控制变量法来验证计算结果的可靠性。

---

## 1.1 平面波 (PW) vs. 局域轨道 (LCAO)

在 ABACUS 的 `INPUT` 文件中，`basis_type` 是决定计算核心逻辑的最重要参数。它决定了薛定谔方程中的波函数 $\psi(r)$ 如何被数学表达。

### 1.1.1 平面波基组 (`basis_type = pw`)
平面波是固体物理中最经典的基组。它的数学形式是简单的 $e^{i\mathbf{G}\cdot\mathbf{r}}$。

*   **优势**：
    *   **完备性（Completeness）**：这是 PW 最大的优点。你只需要通过一个参数——**截断能 (`ecutwfc`)**——就能系统性地控制精度。只要 `ecutwfc` 足够大，平面波基组就能无限逼近真实波函数。
    *   **无偏见**：它均匀地覆盖整个空间，不依赖于原子的具体位置。
*   **劣势**：
    *   **计算昂贵**：为了描述原子核附近的剧烈振荡或真空区域（对于低维材料），需要大量的平面波，导致计算量急剧增加。

### 1.1.2 数值原子轨道基组 (`basis_type = lcao`)
LCAO 使用类似于原子轨道的函数（如 $s, p, d$ 轨道）作为基底。ABACUS 使用的是数值原子轨道（Numerical Atomic Orbitals, NAO）。

*   **优势**：
    *   **极高效率**：轨道只在原子附近存在（局域性），哈密顿量矩阵是稀疏的。这使得 ABACUS 能够处理数千甚至上万原子的体系，且计算速度通常比 PW 快 1-2 个数量级。
    *   **物理直观**：可以直接对应到化学键的概念。
*   **劣势**：
    *   **基组依赖性**：精度取决于你选择了哪一套轨道文件（.orb）。如果轨道选得不好，计算结果可能偏差很大。

### 1.1.3 变分原理与能量基准
根据密度泛函理论（DFT）的**变分原理**，在相同的哈密顿量下，基组越完备，计算得到的总能量越低（越接近真实基态）。

> **教授的经验法则**：
> 通常情况下，**PW 计算的能量会略低于 LCAO 计算的能量**（约 0.1 - 0.2 eV/atom）。
>
> 因此，我们的测试策略是：**以高精度的 PW 计算结果为“真值”（Ground Truth），来衡量 LCAO 基组的误差是否在可接受范围内。**

---

## 1.2 解读数值原子轨道 (.orb) 文件

在 LCAO 模式下，你需要为每种元素提供一个 `.orb` 文件。这些文件通常由 ABACUS 开发团队或社区提供（如 `SG15` 或 `Chen-Cheng` 库）。读懂文件名是选择基组的第一步。

### 1.2.1 文件名解剖学
以一个标准的硅元素轨道文件为例：
`Si_gga_7au_100Ry_2s2p1d.orb`

我们可以将其拆解为四个关键部分：

1.  **`Si` (元素)**: 适用元素。
2.  **`gga` (泛函类型)**: 生成该轨道时使用的交换关联泛函。
    *   **关键注意**：轨道文件的泛函类型最好与赝势文件（`.upf` 或 `.vsp`）一致，虽然混用有时能跑通，但不推荐。
3.  **`7au` (截断半径 $R_{cut}$)**: 轨道的空间范围。
    *   **物理含义**：轨道在 7.0 Bohr (原子单位) 处被截断为 0。
    *   **权衡**：$R_{cut}$ 越大，轨道重叠越多，精度越高，但计算矩阵越稠密，速度越慢。7au 是一个中等偏大的安全值；6au 较快；8au+ 极高精度。
4.  **`100Ry` (参考截断能)**:
    *   **物理含义**：这是生成该轨道时使用的能量截断值。
    *   **实战指导**：这提示你在 `INPUT` 文件中设置 `ecutwfc` 时，**建议不低于 100 Ry**。虽然设低了程序也能跑，但这会导致积分网格过于稀疏，无法准确描述该轨道的高频部分，产生“蛋箱效应”（Egg-box effect）误差。
5.  **`2s2p1d` (轨道配置)**: **这是判断精度的核心指标**。
    *   它表示该基组包含：2个 s 轨道，2个 p 轨道，1个 d 轨道。

### 1.2.2 如何判断基组精度（SZ, DZP, TZDP）
我们需要结合元素的价电子排布来看。以 Si ($3s^2 3p^2$) 为例，其价层是 s 和 p。

*   **SZ (Single Zeta)**: 最小基组。
    *   配置：`1s1p` (每个价层轨道只有 1 个径向函数)。
    *   特点：极快，但精度仅适用于定性分析或紧束缚模型预研。
*   **DZP (Double Zeta Polarized)**: 标准科研基组。
    *   配置：`2s2p1d` (每个价层 2 个径向函数 + 1 个极化轨道 d)。
    *   特点：**性价比之王**。大多数科研论文（能带、结构优化）使用此精度。
*   **TZDP / TZTP (Triple Zeta)**: 高精度基组。
    *   配置：`3s3p2d` 或更高。
    *   特点：用于对精度要求极高的计算（如态密度细节、弱相互作用），接近 PW 精度。

---

## 1.3 测试方案设计：控制变量法

在正式开始大规模计算前，必须进行收敛性和一致性测试。很多初学者容易陷入“乱调参数”的误区。

### 1.3.1 核心原则：控制变量
我们在对比 PW 和 LCAO，或者对比 DZP 和 TZDP 时，**只能**改变与基组相关的参数。

**必须保持严格一致的参数（不变量）：**
1.  **`pseudo_dir` & 赝势文件**：绝对不能换赝势！不同的赝势定义的内核不同，能量没有可比性。
2.  **K 点网格 (`kspacing` 或 `K_POINTS`)**：K 点密度必须一致。
3.  **晶体结构 (`STRU`)**：晶格常数和原子位置必须完全冻结。
4.  **`ecutwfc` (特殊情况)**：在 PW 计算中这是变量；但在 LCAO 对比测试中，建议固定在一个较高值（如 100 Ry），以排除积分网格带来的误差。

### 1.3.2 常见的 LCAO 误区（Warning）
> **误区**：我在使用 SZ (1s1p) 基组时发现精度不够，于是我把 `INPUT` 里的 `ecutwfc` 从 100 Ry 提高到 200 Ry，希望能提高精度。
>
> **真相**：**这是徒劳的。**
> 在 LCAO 模式下，`ecutwfc` 仅决定实空间积分网格的密度。一旦网格足够密（能分辨轨道的特征），再增加 `ecutwfc` 并不能改变基组本身只有 "1s1p" 这一事实。**基组的完备性缺陷无法通过提高截断能来弥补。** 想要提高精度，必须更换更完备的 `.orb` 文件（如换成 DZP）。

### 1.3.3 标准测试协议 (Protocol)

建议在开始课题前，按照以下步骤建立基准：

**Step 1: 建立 PW 真值 (Benchmark)**
*   设置 `basis_type = pw`。
*   进行 `ecutwfc` 收敛性测试（如 60, 70, ..., 120 Ry），找到能量收敛点（例如 100 Ry）。
*   记录此时的总能量 $E_{PW}$ 和关键物理量（如晶格常数、带隙）。

**Step 2: LCAO 精度测试**
*   设置 `basis_type = lcao`。
*   保持 `ecutwfc` 为 100 Ry（参考 Step 1 的收敛值或轨道文件名推荐值）。
*   **实验 A**: 使用 SZ 轨道文件。记录 $E_{SZ}$。
*   **实验 B**: 使用 DZP 轨道文件。记录 $E_{DZP}$。
*   **实验 C**: 使用 TZDP 轨道文件（可选）。记录 $E_{TZDP}$。

**Step 3: 结果分析**
*   验证是否满足：$E_{SZ} > E_{DZP} > E_{PW}$。
*   计算能量差 $\Delta E = E_{LCAO} - E_{PW}$。如果 DZP 的 $\Delta E$ 在 10-200 meV/atom 范围内，且能带结构与 PW 基本重合，则说明该 LCAO 基组可靠，可用于后续的大规模计算。

### 1.3.4 必要的输入文件准备
为了执行上述测试，你需要准备以下文件结构。请注意 `STRU` 文件在引入轨道时的写法。

**文件结构示例：**
```text
.
├── pseudopotentials/     # 存放 .upf 或 .vsp 文件
├── orbitals/             # 存放 .orb 文件
├── 01_pw_benchmark/      # PW 计算目录
│   ├── INPUT
│   ├── STRU
│   └── K_POINTS
└── 02_lcao_dzp/          # LCAO 计算目录
    ├── INPUT
    ├── STRU
    └── K_POINTS
```

**关于 STRU 文件的特别提示：**
在 `02_lcao_dzp/STRU` 中，`ATOMIC_SPECIES` 部分必须显式指定轨道文件。

```text
ATOMIC_SPECIES
Si  28.0855  Si_ONCV_PBE-1.0.upf  Si_gga_7au_100Ry_2s2p1d.orb
// 元素名  原子量  赝势文件名  轨道文件名(LCAO模式必需)
```
*注意：PW 模式下，`STRU` 中的第四列（轨道文件名）会被忽略，但为了文件统一，保留它也不会报错。*

---

**总结**：
本章我们确立了“以 PW 为尺，衡量 LCAO 精度”的核心思想。理解 `basis_type` 的区别和 `.orb` 文件的含义是使用 ABACUS 的基本功。下一章，我们将进入实战环节，手把手教你编写第一个 `INPUT` 文件。

# 第二章：建立基准——平面波 (PW) 计算

这是一篇基于 ABACUS 最佳实践撰写的《ABACUS 实战教程》第二章。本章旨在建立计算的“基准真值”，为后续的 LCAO（数值原子轨道）计算提供精度评估的标尺。

---

# 第二章：建立基准——平面波 (PW) 计算

在进入 ABACUS 高效的 LCAO（线性组合原子轨道）模式之前，我们必须先完成一步至关重要的工作：**建立基准（Benchmark）**。

很多初学者容易陷入一个误区：直接使用 LCAO 模式计算，却不知道结果偏离了多少。**没有基准的测试是毫无意义的。** 在本章中，我们将利用 ABACUS 的平面波（Plane Wave, PW）基组功能，对体系进行一次高精度的计算。由于平面波基组具有系统可收敛性（Systematic Convergence），我们可以将其结果视为该赝势下的“参考真值”（Ground Truth）。

## 2.1 PW 模式下的输入文件配置

在这一节，我们将配置 `INPUT` 文件以启动平面波计算。此时我们的目标不是速度，而是**精度**。

### 核心参数详解

要开启 PW 模式，最关键的参数是 `basis_type` 和 `ecutwfc`。

1.  **`basis_type`**: 设置为 `pw`。这告诉 ABACUS 忽略轨道文件，直接使用平面波展开波函数。
2.  **`ecutwfc`**: 波函数截断能（Energy Cutoff for Wavefunctions），单位为 Rydberg (Ry)。
    *   **物理意义**: 它决定了平面波基组的大小。数值越大，基组越完备，结果越精确，但计算量呈指数级增长。
    *   **推荐值**: 为了获得“真值”，我们通常设置一个较高的数值，例如 **100 Ry**（对于大多数软/中等硬度赝势已足够收敛）。
    *   **注意**: 在 PW 模式下，`ecutwfc` 直接决定精度；而在 LCAO 模式下，它的作用完全不同（详见 2.3 节）。

### INPUT 文件示例

创建一个名为 `INPUT` 的文件，写入以下内容：

```bash
INPUT_PARAMETERS
# 1. 基础计算参数
suffix              Si_PW_Benchmark  # 输出文件后缀
calculation         scf              # 自洽场计算
basis_type          pw               # 关键：指定使用平面波基组
symmetry            1                # 开启对称性分析以加速

# 2. 精度控制参数
ecutwfc             100              # 关键：设置为 100 Ry 以确保高精度
scf_thr             1.0e-8           # 自洽收敛阈值 (Ry)，基准计算建议设严
scf_nmax            100              # 最大自洽步数

# 3. 赝势路径
pseudo_dir          ./               # 赝势文件所在目录
# orbital_dir       ./               # PW 模式下不需要此参数，但保留也不报错
```

> **专家提示**：
> 这里的 `scf_thr` 设为了 `1.0e-8`，比日常计算（通常 `1.0e-6`）更严格，这是为了消除数值噪声，确保我们拿到的能量是真正的收敛解。

## 2.2 准备结构与赝势 (STRU & KPT)

除了 `INPUT` 文件，我们还需要定义晶体结构和 K 点。

### 1. 准备赝势文件
确保你的目录下有对应的赝势文件（例如 `Si.upf`）。
*   **重要原则（控制变量法）**：在后续对比 LCAO 精度时，**必须使用完全相同的赝势文件**。切勿在对比过程中更换赝势（如从 LDA 换到 GGA），否则能量差将失去物理意义。

### 2. 编写 STRU 文件
`STRU` 文件定义了原子种类、晶格常数和原子位置。

**风险提示**：在 PW 模式下，虽然不需要读取数值轨道文件（`.orb`），但 `ATOMIC_SPECIES` 部分的格式必须保持完整。

```bash
ATOMIC_SPECIES
Si  28.0855  Si.upf  # 元素名 质量 赝势文件名

LATTICE_CONSTANT
10.2                 # 晶格常数 (Bohr)

LATTICE_VECTORS
0.5 0.5 0.0
0.5 0.0 0.5
0.0 0.5 0.5

ATOMIC_POSITIONS
Direct               # 分数坐标
Si                   # 元素名
0.0   0.0   0.0      # 磁矩(可选) 坐标x 坐标y 坐标z
0.25  0.25  0.25
```

### 3. 编写 KPT 文件
K 点网格密度直接影响能量精度。

```bash
K_POINTS
0
Gamma
4 4 4 0 0 0
```

> **重要原则（控制变量法）**：请记住这里设置的 `4 4 4`。在下一章进行 LCAO 计算时，**必须保持 K 点网格完全一致**。如果 PW 用 `4 4 4` 而 LCAO 用 `2 2 2`，两者的能量差异将包含 K 点采样误差，导致无法评估基组误差。

## 2.3 运行计算与数据记录

### 执行计算
在终端运行 ABACUS（根据你的环境，命令可能是 `abacus` 或 `mpirun -np 4 abacus`）：

```bash
mpirun -np 4 abacus | tee output.log
```

### 提取基准能量 (Ground Truth)
计算完成后，我们需要提取总能量。在 `output.log` 或 `OUT.Si_PW_Benchmark/running_scf.log` 中寻找 `!FINAL_ETOT_IS` 关键字。

```bash
grep "FINAL_ETOT_IS" OUT.Si_PW_Benchmark/running_scf.log
```

假设输出为：
`!FINAL_ETOT_IS  -231.567890 eV`

**记录下这个数值**。这就是我们在当前赝势、当前结构、当前 K 点下的“真值”。

## 2.4 核心概念辨析与预告

在进入下一章 LCAO 实战前，作为开发者，我必须澄清几个极其关键的概念，这直接关系到你是否能正确使用 ABACUS。

### 1. 为什么 LCAO 的能量通常比 PW 高？
根据变分原理，基组越完备，总能量越低（越接近真实基态）。
*   **PW (100 Ry)**：基组非常完备，能量极低，接近极限。
*   **LCAO (DZP/TZDP)**：基组是有限的，完备性不如高截断能的平面波。
因此，**LCAO 的总能量通常会比 PW 高 0.1 ~ 0.2 eV/atom**。这是一个正常的物理现象，称为“基组误差”。我们的目标不是消除它，而是将其控制在可接受范围内（如 < 10 meV/atom）。

### 2. `ecutwfc` 的致命误区
在 **PW 模式**下，调大 `ecutwfc` = 提高精度。
在 **LCAO 模式**下，**这是一个常见的陷阱**！
*   LCAO 模式下，`ecutwfc` 仅决定积分格点的密度（Grid Mesh）。
*   如果你使用的是小基组（如 SZ），即使把 `ecutwfc` 加到 500 Ry，结果依然是不准的 SZ 结果，只是积分更精确的“错误结果”而已。
*   **结论**：在 LCAO 模式下要提高精度，必须更换更完备的轨道文件（如从 SZ 换到 DZP），而不是盲目增加 `ecutwfc`。

### 3. 预习：如何解读轨道文件名
在下一章我们将引入轨道文件。请先学会阅读 ABACUS 标准轨道库的文件名，例如 `Si_gga_7au_100Ry_2s2p1d.orb`：

*   **`Si`**: 元素。
*   **`gga`**: 生成该轨道时使用的泛函类型（需与赝势匹配）。
*   **`7au`**: **截断半径 ($R_{cut}$)**。这是 LCAO 的核心参数。半径越大，轨道拖尾越长，精度越高，但计算越慢（稀疏矩阵变稠密）。
*   **`100Ry`**: **生成截断能**。指生成这个数值轨道时，参考的平面波截断能是 100 Ry。这**不是**你在 `INPUT` 里设置的 `ecutwfc`，而是一个标签，代表这个轨道的“品质”。
*   **`2s2p1d`**: **轨道配置**。
    *   `2s`: 2 个 s 轨道。
    *   `2p`: 2 组 p 轨道。
    *   `1d`: 1 组 d 轨道（极化轨道）。
    *   这是判断基组大小（DZP, TZDP）的直接依据。

---

**本章总结**：
你已经成功运行了 `basis_type = pw` 的高精度计算，并拿到了总能量的参考真值。请妥善保存 `INPUT`、`STRU` 和 `KPT` 文件，下一章我们将保持这些参数不变，仅通过引入 `.orb` 文件和修改 `basis_type`，来体验 LCAO 的极速计算与精度平衡。

# 第三章：LCAO 基组阶梯测试 (SZ -> DZP -> TZDP)

这是一个关于 ABACUS 软件 LCAO 基组选择的核心实战章节。作为开发者和教授，我将带你深入理解数值原子轨道（NAO）的精度阶梯，并避开新手常犯的参数设置误区。

---

# 第三章：LCAO 基组阶梯测试 (SZ -> DZP -> TZDP)

在上一章我们完成了平面波（PW）基组的收敛性测试，确立了体系的“真值”基准。本章我们将进入 ABACUS 的核心优势领域——**LCAO（原子轨道线性组合）** 模式。

LCAO 模式的效率远高于 PW，但其精度高度依赖于所选的轨道基组（Basis Set）。我们将通过“控制变量法”，从粗糙的 SZ 基组开始，逐步升级到标准的 DZP 和高精度的 TZDP，并与 PW 结果进行对比，从而掌握如何在精度与效率之间找到最佳平衡点。

## 3.0 实验前的关键认知与准备

在开始之前，请务必理解以下三个核心原则，否则测试将失去意义：

1.  **控制变量法**：在对比不同精度轨道（如 SZ vs DZP）时，**必须保持赝势文件（UPF/Vanderbilt）不变**，同时 K 点网格（`kspacing` 或 `KPT` 文件）必须与 PW 基准计算保持一致。
2.  **Ecut 的误区**：在 LCAO 模式下，`ecutwfc` **不决定基组的大小**（这是与 PW 模式最大的不同）。它仅决定积分网格的密度。试图通过调大 `ecutwfc` 来修复 SZ 基组的误差是徒劳的，提高精度的唯一方法是更换更完备的轨道文件。
3.  **基准线（Ground Truth）**：请确保你已经完成了一次 `basis_type = pw` 的计算。根据变分原理，在相同赝势下，LCAO 的能量通常会略高于 PW（约 0.1-0.2 eV/atom），这是正常的物理现象。

---

## 3.1 最小基组 (SZ) 的快速预估

**SZ (Single-Zeta)** 是最基础的基组，每个角动量通道只有一条径向函数。它计算极快，但精度较低，通常用于极大规模体系的初步弛豫或紧束缚模型研究。

### 3.1.1 读懂轨道文件名
ABACUS 的轨道文件通常遵循特定命名规范，例如：
`Si_gga_7au_100Ry_s2p1.orb`

*   **Si**: 元素名称。
*   **gga**: 生成轨道时使用的泛函类型（需与赝势一致）。
*   **7au**: **截断半径 (Cutoff Radius)**。半径越大，轨道描述越精确，但哈密顿量矩阵越稀疏度越低（计算越慢）。
*   **100Ry**: **推荐截断能**。这是生成轨道时使用的网格精度，也是你在 `INPUT` 中设置 `ecutwfc` 的参考值。
*   **s2p1**: **核心标识**。表示有 2 个 s 轨道，1 个 p 轨道。通常 SZ 带有较少的轨道数和极化函数。

### 3.1.2 修改 STRU 文件
在 LCAO 模式下，`STRU` 文件中的 `ATOMIC_SPECIES` 区块需要显式指定轨道文件。

**STRU 示例 (SZ 配置)**：
```abacus
ATOMIC_SPECIES
Si  28.0855  Si_ONCV_PBE-1.0.upf  Si_gga_7au_100Ry_s2p1.orb
```
*注意：第四列即为轨道文件名。请确保该文件位于 `orbital_dir` 指定的目录下。*

### 3.1.3 修改 INPUT 文件
将计算模式从平面波切换为 LCAO。

**INPUT 关键参数**：
```abacus
INPUT_PARAMETERS
# ... 其他参数保持不变 ...
basis_type      lcao        # 开启 LCAO 模式
ks_solver       genelpa     # 推荐的对角化求解器 (或 scalapack_gvx)
ecutwfc         100         # 设置为轨道文件推荐的值
orbital_dir     ./          # 轨道文件所在路径
```

运行计算后，你会发现计算速度极快，但总能量与 PW 基准相比可能有较大偏差（例如 > 1 eV/atom），且力（Force）的准确度较差。这证实了 SZ 仅适用于定性分析。

---

## 3.2 标准基组 (DZP) 与高精度基组 (TZDP) 的进阶

为了获得发表级的计算精度，我们需要引入更完备的基组。

*   **DZP (Double-Zeta Polarized)**：标准配置。双倍径向函数 + 极化轨道（例如 Si 的 d 轨道）。适用于绝大多数物理化学性质计算。
*   **TZDP (Triple-Zeta Doubly Polarized)**：高精度配置。三倍径向函数 + 双重极化。用于对精度要求极高的基准测试。

### 3.2.1 轨道文件的替换
假设我们有以下两个文件：
1.  **DZP**: `Si_gga_7au_100Ry_2s2p1d.orb` (2s, 2p, 1d)
2.  **TZDP**: `Si_gga_7au_100Ry_3s3p2d.orb` (3s, 3p, 2d)

**操作步骤**：
只需修改 `STRU` 文件中的第四列文件名即可，无需更改 `INPUT` 中的 `ecutwfc`（只要轨道文件推荐值相同）。

**STRU 示例 (DZP 配置)**：
```abacus
ATOMIC_SPECIES
Si  28.0855  Si_ONCV_PBE-1.0.upf  Si_gga_7au_100Ry_2s2p1d.orb
```

### 3.2.2 深入理解 ecutwfc 在 LCAO 中的作用
很多初学者在从 PW 转到 LCAO 时会感到困惑：**为什么换了更准的 TZDP 轨道，`ecutwfc` 还是 100 Ry？**

*   **物理意义**：在 LCAO 中，基组是预先数值定义好的。`ecutwfc` 此时控制的是**实空间积分网格的精细度**。我们需要足够密的网格来准确计算轨道间的重叠积分（Overlap）和哈密顿量矩阵元。
*   **设置原则**：使用轨道文件名中标识的数值（如 100Ry）通常已经足够消除“蛋格效应”（Egg-box effect）。
*   **警告**：如果你将 `ecutwfc` 设得过低（如 40 Ry），会导致数值积分误差，使得变分原理失效（能量可能不正常地低于 PW 结果）。

### 3.2.3 求解器选择 (ks_solver)
随着基组变大（TZDP），矩阵维数增加。
*   默认推荐使用 `ks_solver = genelpa`（基于 ELPA 库，速度快）。
*   如果遇到并行报错或内存溢出，可切换为 `ks_solver = scalapack_gvx`（稳定性更好，但稍慢）。

---

## 3.3 混合基组策略（进阶技巧）

在处理大型复杂体系（如表面吸附、缺陷计算）时，我们往往面临两难：全用 TZDP 太慢，全用 SZ 不准。此时可以使用**混合基组策略**。

**场景**：计算 CO 分子在 Au(111) 表面的吸附。
*   **关键区域**：CO 分子和表层 Au 原子 -> 使用 **TZDP** 或 **DZP**。
*   **环境区域**：底层的 Au 原子（仅起体相固定作用） -> 使用 **SZ**。

### 3.3.1 STRU 文件的多轨道写法
ABACUS 允许在 `ATOMIC_SPECIES` 中定义同种元素的不同“类型”，分别挂载不同的轨道文件。

**STRU 示例 (混合精度)**：
```abacus
ATOMIC_SPECIES
# 标签      质量      赝势文件              轨道文件
Au_surf    196.967   Au_ONCV.upf          Au_gga_7au_100Ry_2s2p1d.orb  # DZP: 用于表面
Au_bulk    196.967   Au_ONCV.upf          Au_gga_7au_100Ry_s1p1.orb    # SZ:  用于底层
C          12.011    C_ONCV.upf           C_gga_6au_100Ry_2s2p1d.orb   # DZP
O          15.999    O_ONCV.upf           O_gga_6au_100Ry_2s2p1d.orb   # DZP

ATOMIC_POSITIONS
Direct
# 使用定义的标签
Au_surf    0.0000000000    0.0000000000    0.5000000000 1 1 1
Au_bulk    0.5000000000    0.5000000000    0.0000000000 0 0 0
...
```

通过这种方式，你可以在保证关键反应位点精度的同时，大幅降低哈密顿量的维度，显著提升计算效率。

---

## 3.4 结果分析与验收标准

完成 SZ、DZP、TZDP 的计算后，请整理如下表格进行对比（以 PW 结果为基准）：

| 基组类型 | 轨道数/原子 | 总能量 (eV) | 能量差 (vs PW) | 耗时 (s) | 评价 |
| :--- | :---: | :---: | :---: | :---: | :--- |
| **PW (100Ry)** | N/A | -1000.500 | 0 (Ref) | 1000 | **真值基准** |
| **SZ** | 4 | -998.200 | +2.300 | 50 | 仅供粗略参考 |
| **DZP** | 13 | -1000.350 | +0.150 | 120 | **性价比之选** |
| **TZDP** | 22 | -1000.480 | +0.020 | 300 | 高精度 |

**验收标准**：
1.  **能量顺序**：应满足 $E_{PW} \le E_{TZDP} \le E_{DZP} \le E_{SZ}$。如果 LCAO 能量显著低于 PW，请检查是否使用了不同的赝势，或 `ecutwfc` 设置过低导致积分误差。
2.  **收敛性**：通常 DZP 的结果与 PW 的能量差在 0.1~0.2 eV/atom 范围内，且晶格常数误差 < 1%，即视为可用的生产级参数。

通过本章的测试，你应该已经选定了一套适合你体系的轨道文件（通常是 DZP）。在下一章，我们将探讨如何利用 ABACUS 独特的“基组优化”功能，进一步压榨 LCAO 的潜力。

# 第四章：结果分析与精度评估

在前几章中，我们已经成功运行了基于平面波（PW）和不同精度数值原子轨道（LCAO-SZ/DZP/TZDP）的计算。面对终端输出的一堆数据，初学者往往会感到迷茫：**到底哪个结果是可信的？DZP 够用了吗？为什么 LCAO 的能量总比 PW 高？**

本章我们将像剥洋葱一样，通过绝对能量对比、能量-体积（E-V）曲线扫描以及计算效率评估，建立一套科学的精度验证体系。

---

## 4.1 绝对能量与相对趋势分析

首先，我们需要明确一个计算材料学的核心公理：**DFT 计算出的绝对总能量（Total Energy）本身没有物理意义，有意义的是能量差（Energy Difference）。**

但是，在评估基组精度时，绝对能量是一个重要的参考指标。根据**变分原理**，在相同的哈密顿量（相同的泛函、赝势）下，基组越完备，计算得到的总能量越低（越接近真实基态）。

### 4.1.1 建立基准线（Benchmark）

在进行 LCAO 精度测试时，**必须**首先进行一组高精度的 PW 计算作为“真值”。

*   **控制变量法（关键）**：
    在对比测试中，以下参数必须在所有计算中保持严格一致，否则对比无效：
    *   `pseudo_dir` 下的赝势文件（`.upf` 或 `.vanderbilt`）。
    *   `kspacing` 或 K 点网格密度。
    *   `xc` 交换关联泛函。
    *   `ecutwfc`（虽然 PW 和 LCAO 对截断能敏感度不同，但建议设定为赝势建议的高值，如 80-100 Ry，以消除积分网格带来的误差）。

### 4.1.2 数据提取与对比

假设我们计算了体相硅（Si）在不同基组下的总能量（单位：eV），数据可能如下（仅为示例）：

| 基组类型 | 轨道配置 (Configuration) | 总能量 (eV) | 相对 PW 误差 (eV/atom) |
| :--- | :--- | :--- | :--- |
| **PW (基准)** | Plane Wave (Ecut=100Ry) | -216.500 | 0.000 |
| **LCAO-TZDP** | 2s2p1d | -216.485 | +0.015 |
| **LCAO-DZP** | 2s2p1d (较小半径或基函数少) | -216.420 | +0.080 |
| **LCAO-SZ** | 1s1p | -214.800 | +1.700 |

**分析结论**：
1.  **$E_{LCAO} > E_{PW}$ 是正常的**：由于数值原子轨道是截断的（有限半径），而平面波在全空间展开（完备基），LCAO 的能量通常会略高于 PW。
2.  **收敛趋势**：随着基组从 SZ $\to$ DZP $\to$ TZDP 增大，能量应逐渐降低并逼近 PW 结果。
3.  **精度判断**：通常情况下，如果 TZDP 与 PW 的能量差在 **10-50 meV/atom** 以内，我们认为该基组在能量描述上是合格的。

> **⚠️ 误区警示：Ecut 的作用**
> 在 LCAO 模式下，很多初学者发现能量不准，第一反应是调大 `ecutwfc`。
> **这是徒劳的！**
> 在 LCAO 中，`ecutwfc` 仅控制积分网格的密度。一旦网格足够密（通常 >60 Ry），误差主要来源于**基组的不完备性**（即轨道太少或截断半径太短）。要提高精度，必须更换更高级的轨道文件（如从 SZ 换到 DZP），而不是死磕 `ecutwfc`。

---

## 4.2 能量-体积 (E-V) 曲线扫描

单点能的对比可能受偶然因素影响。更具物理意义的检验方法是计算**状态方程（Equation of State, EOS）**，即扫描一系列不同晶格常数下的能量，拟合得到平衡晶格常数 ($a_0$) 和体模量 ($B_0$)。

### 4.2.1 扫描策略

我们需要改变晶胞体积，进行多次 `calculation = scf` 计算。

*   **操作方法**：准备 5-7 个结构文件（`STRU`），体积范围覆盖平衡体积的 $\pm 5\%$ 到 $\pm 10\%$。
*   **关键参数**：
    *   `calculation`: `scf`
    *   `basis_type`: `lcao` (针对不同轨道分别测试) vs `pw`

### 4.2.2 简易脚本示例 (Shell)

虽然可以使用 Python (ASE/Pymatgen) 自动化，但为了理解原理，这里展示一个简单的 Shell 脚本逻辑，用于批量修改晶格常数并计算：

```bash
#!/bin/bash

# 定义晶格常数缩放因子列表
scales=(0.94 0.96 0.98 1.00 1.02 1.04 1.06)
basis="Si_gga_7au_100Ry_2s2p1d.orb" # 当前测试的轨道

for s in "${scales[@]}"
do
    work_dir="run_${s}"
    mkdir -p $work_dir
    
    # 1. 复制输入文件
    cp INPUT KPT $basis $work_dir/
    # 假设赝势在上一级目录
    
    # 2. 生成新的 STRU (这里假设原始 STRU 晶格常数为 10.2 bohr)
    # 注意：实际操作中建议用 Python 生成 STRU 以保证精度
    new_lat=$(echo "10.2 * $s" | bc -l)
    
    cat > $work_dir/STRU <<EOF
ATOMIC_SPECIES
Si 28.086 Si_ONCV_PBE-1.0.upf $basis

LATTICE_CONSTANT
$new_lat  

LATTICE_VECTORS
0.5 0.5 0.0
0.5 0.0 0.5
0.0 0.5 0.5

ATOMIC_POSITIONS
Direct
Si 0.00 0.00 0.00 1 1 1
Si 0.25 0.25 0.25 1 1 1
EOF

    # 3. 运行 ABACUS
    cd $work_dir
    mpirun -np 4 abacus > running.log
    
    # 4. 提取能量
    e_tot=$(grep "Final Etot" OUT.*/running_scf.log | awk '{print $4}')
    echo "Scale: $s, Energy: $e_tot" >> ../ev_curve.data
    cd ..
done
```

### 4.2.3 结果分析

将 `ev_curve.data` 中的数据绘制成曲线（抛物线状）。

*   **合格标准**：
    *   **DZP/TZDP** 的曲线最低点（平衡位置）应与 **PW** 的最低点非常接近。
    *   **SZ** 曲线通常会发生显著偏移（例如 $a_0$ 偏大或偏小），且曲率（对应体模量 $B_0$）可能完全错误。这就是为什么我们强调 SZ 不能用于发表文章。

---

## 4.3 效率评估：时间与内存

在科研中，我们追求的是“性价比”。如果 TZDP 比 DZP 慢 10 倍但精度只提升 0.1%，那么 DZP 可能是更好的选择。

### 4.3.1 查看计算消耗

ABACUS 的运行日志（通常在 `OUT.suffix/running_scf.log` 或屏幕输出）末尾提供了详细的性能统计。

**关注指标**：
1.  **Total Time**: 总运行时间。
2.  **Memory**: 峰值内存占用（部分版本显示，或通过系统 `time -v` 命令查看）。

### 4.3.2 典型对比表

| 指标 | PW (100Ry) | LCAO-SZ | LCAO-DZP | LCAO-TZDP |
| :--- | :--- | :--- | :--- | :--- |
| **单步 SCF 时间** | 100% (基准) | ~5% | ~15% | ~40% |
| **内存占用** | 高 | 极低 | 低 | 中 |
| **精度 (eV/atom)** | 0 | +1.7 | +0.08 | +0.015 |

**决策建议**：
*   **高通量筛选/预弛豫**：使用 **SZ** 或 **DZP**。
*   **最终性质计算（能带、DOS、精密结构）**：使用 **DZP**（如果验证过精度够用）或 **TZDP**。
*   **大体系（>500 原子）**：PW 通常内存爆炸，必须使用 **LCAO-DZP**。

---

## 附录：常见问题与避坑指南

### A.1 如何解读轨道文件名？
ABACUS 的轨道文件命名通常包含关键信息，例如 `Si_gga_7au_100Ry_2s2p1d.orb`：
*   `Si`: 元素。
*   `gga`: 泛函类型（需与赝势匹配）。
*   `7au`: **截断半径 ($R_{cut}$)**。这是 LCAO 的核心参数。
    *   **越大**：精度越高，但计算越慢，稀疏矩阵变稠密，内存消耗激增。
    *   **越小**：计算极快，但精度下降。
*   `100Ry`: 生成该轨道时使用的参考截断能（建议计算时的 `ecutwfc` 不低于此值）。
*   `2s2p1d`: **轨道配置**。
    *   这是判断基组大小的依据。例如 Si 价电子是 $3s^2 3p^2$。
    *   `1s1p` = SZ (Minimal Basis)
    *   `2s2p1d` = DZP (Double Zeta + Polarization)
    *   `3s3p2d1f` = TZDP (Triple Zeta + Double Polarization)

### A.2 BSSE 误差（基组重叠误差）
在计算吸附能或分子间相互作用时，LCAO 容易出现 BSSE 误差（由于表面借用了吸附分子的基函数导致能量人为降低）。
*   **对策**：PW 基组不存在 BSSE。如果使用 LCAO 计算弱相互作用，务必进行 CP (Counterpoise) 矫正（目前需手动处理或借助脚本）。

### A.3 求解器崩溃与并行错误
如果你在并行计算大体系时遇到 `segmentation fault` 或 `ELPA` 相关的错误：
*   **原因**：默认的 `ks_solver = genelpa` 在某些硬件或并行配置下可能不稳定。
*   **解决**：在 `INPUT` 中修改求解器为 ScaLAPACK（速度稍慢但极稳）：
    ```bash
    ks_solver  scalapack
    ```

### A.4 内存爆炸风险
*   **现象**：程序刚启动就被系统 Kill。
*   **原因**：使用了过大的截断半径（如 > 10 au）配合 TZDP 基组，或者体系原子极其密集。
*   **解决**：
    1.  检查 `STRU` 中是否误用了长半径轨道。
    2.  尝试减小 `ecutwfc`（影响辅助网格内存）。
    3.  增加节点数（增加总内存）。

### A.5 再次强调：不可用的 SZ
**切记**：SZ (Single Zeta) 基组仅包含最小基，缺乏极化函数，无法正确描述化学键的形变。**严禁将 SZ 的计算结果（无论是结构还是能量）直接用于发表论文**，它只能用于快速测试代码流程或极其粗糙的初始猜测。

---

## 附录：进阶学习指南

计算材料学的探索永无止境，完成本教程的四个章节仅是踏上了征程。为了进一步提升研究深度，我们建议你在以下方向继续探索：

### 1. 深度扩展阅读
- **BSSE 修正**：在处理小分子体系时，基组重叠误差（Basis Set Superposition Error, BSSE）会显著影响结果。建议深入研究如何在 LCAO 模式下进行反计修正（Counterpoise Correction）。
- **轨道优化逻辑**：数值原子轨道的半径（Cutoff Radius）直接影响计算精度与效率。建议查阅文献 [1] 和 [2]，理解如何针对特定体系生成和优化自己的轨道文件（.orb）。
- **大体系模拟策略**：当体系原子数超过 50 个时，LCAO 的效率优势将呈指数级放大。尝试使用 ABACUS 进行包含数百个原子的复杂界面或缺陷模型计算。

### 2. 通用调试建议 (Troubleshooting)
- **收敛失败**：若 SCF 迭代在 `scf_nmax` 步内未收敛，请检查体系是否为金属（需调整 `mixing_type` 或 `smearing`），或者初始结构是否过于离谱。
- **能量差异显著**：若 PW 与 LCAO 计算的能量差远大于 0.1-0.2 eV/atom，请优先检查 LCAO 的 `ecutwfc`（格点积分精度）是否足够，或轨道文件是否与赝势匹配。
- **内存溢出**：LCAO 模式下，过长的轨道截断半径（如 >10 au）会急剧增加内存消耗，请根据精度需求合理设置。

### 3. 官方资源与文献
- **官方文档**：请务必定期访问 [ABACUS 在线手册](https://abacus.deepmodeling.com/) 获取最新的参数说明。
- **经典文献**：
  - [1] M. Chen, et al. "Systematically Improvable Optimized Atomic Basis Sets for Ab Initio Calculations", J. Phys.: Condens. Matter 22, 445501 (2010).
  - [2] M. Chen, et al. "Electronic Structure Interpolation via Atomic Orbitals", J. Phys.: Condens. Matter 23, 325501 (2011).

保持好奇，严谨求证，祝你在计算材料学的道路上不断进阶！
