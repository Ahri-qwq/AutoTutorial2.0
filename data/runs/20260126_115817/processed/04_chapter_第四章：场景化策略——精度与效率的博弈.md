# 第四章：场景化策略——精度与效率的博弈

你好！我是计算材料学教授。欢迎回到《ABACUS 实战教程》。

在前几章中，我们已经成功配置了 ABACUS 的运行环境，并理解了数值原子轨道（NAO）的基本原理。现在，我们面临一个在实际科研中必须做出的关键决策：**在 APNS 提供的 `efficiency`（高效版）和 `precision`（高精版）轨道之间，我该如何选择？**

这一章不仅仅是关于参数设置，更是关于**计算资源管理**与**物理精度需求**之间的博弈艺术。

---

# 第四章：场景化策略——精度与效率的博弈

在 APNS (Abacus Pre-generated Numerical Orbitals) 库中，针对同一种元素，通常提供了两套轨道文件。初学者往往倾向于“无脑选精度最高的”，而经验丰富的开发者则会根据物理问题的本质“看菜下碟”。

本章将带你深入理解这两套方案的适用边界，助你在保证物理结果可靠的前提下，最大化计算吞吐量。

## 4.1 Efficiency 版本：高通量与动力学的首选

### 4.1.1 适用范围定义
`efficiency` 版本的设计哲学是：**以最小的基组规模，描述最核心的占据态性质**。
它通常采用 DZP (Double-Zeta + Polarization) 甚至更精简的配置，且截断半径（`rcut`）相对较小。

**推荐场景：**
1.  **晶体结构优化 (`calculation relax / cell_relax`)**：基态的几何结构主要由占据态电子的成键性质决定，Efficiency 版本通常能提供非常准确的键长和晶格常数。
2.  **分子动力学模拟 (`calculation md`)**：MD 往往需要计算数万步，且对力的精度要求高于对能级细节的要求。Efficiency 版本带来的速度提升（通常 2-5 倍）在 MD 中是决定性的。
3.  **声子谱计算**：无论是有限位移法还是微扰法，都需要大量的受力计算。
4.  **高通量材料筛选**：在数千个候选材料中进行初步筛选时，速度优先。

### 4.1.2 为什么它更快？
在 ABACUS 的 LCAO 基组下，计算复杂度主要受哈密顿量矩阵的**维度**和**稀疏度**影响：
*   **维度**：由轨道总数决定。Efficiency 版本轨道数少，矩阵对角化速度快。
*   **稀疏度**：由截断半径 `rcut` 决定。`rcut` 越小，原子间重叠越少，矩阵越稀疏，S、H 矩阵构建越快。

### 4.1.3 实战配置示例
假设我们要对硅（Si）进行分子动力学模拟。

**STRU 文件片段：**
```abacus
ATOMIC_SPECIES
Si 28.0855  Si_ONCV_PBE-1.0.upf  Si_orb_efficiency.orb  // 选用效率版轨道
```

**INPUT 文件关键参数：**
```abacus
INPUT_PARAMETERS
# 任务类型：分子动力学
calculation     md
# 基组类型：原子轨道
basis_type      lcao
# 精度控制：MD 中通常不需要极高的 SCF 收敛标准，以换取速度
scf_thr         1.0e-6
scf_nmax        50
```

> **教授提示**：在使用 Efficiency 版本进行结构优化后，如果需要发表数据，建议使用 Precision 版本做一次单点能计算（SCF）进行最终校验，这是一种“高低搭配”的聪明策略。

---

## 4.2 Precision 版本：电子结构与激发态的基石

### 4.2.1 适用范围定义
`precision` 版本的设计哲学是：**完备性优先，尽可能准确地描述希尔伯特空间，特别是空带（Unoccupied States）**。
它通常采用 TZDP (Triple-Zeta + Polarization) 或更高级别的配置，拥有更大的截断半径和更多的极化函数。

**推荐场景：**
1.  **能带结构与态密度 (`calculation nscf`)**：如果你关心费米面以上的能带（导带），必须使用 Precision 版本。Efficiency 版本由于基组缺乏灵活性，往往会导致高能级能带变形甚至缺失（Ghost States 风险）。
2.  **光学性质与介电函数**：这些性质依赖于电子从占据态到空态的跃迁，空态描述不准，光谱必错。
3.  **高精度能量计算**：如形成能、吸附能的精确对比，或者涉及弱相互作用的体系。
4.  **TD-DFT（含时密度泛函理论）**：激发态计算对基组的完备性极其敏感。

### 4.2.2 误用的代价
如果在需要描述电子结构的场景下误用了 Efficiency 版本，你可能会观察到：
*   **带隙异常**：导带底位置不准，导致带隙数值错误。
*   **平带（Flat bands）**：在高能区出现物理上不存在的平直能带，这是基组完备性不足的典型特征。

### 4.2.3 实战配置示例
假设我们要计算硅的能带结构。

**STRU 文件片段：**
```abacus
ATOMIC_SPECIES
Si 28.0855  Si_ONCV_PBE-1.0.upf  Si_orb_precision.orb  // 选用高精版轨道
```

**INPUT 文件关键参数：**
```abacus
INPUT_PARAMETERS
# 任务类型：非自洽计算（能带）
calculation     nscf
basis_type      lcao
# 读入电荷密度（需先进行 scf 计算）
init_chg        file
# 增加空带数量，确保看到高能级能带
nbands          20 
```

---

## 4.3 局限性与特殊情况

作为开发者，我必须诚实地告诉你当前版本（APNS-PPORB-v1）的局限性，以免你浪费算力。

### 4.3.1 旋轨耦合 (SOC) 的限制
**现状**：目前的 APNS-v1 版本轨道是基于非相对论或标量相对论生成的，**不支持**完全的旋轨耦合计算。

**技术细节**：
在开启 SOC (`lspinorb 1`) 时，ABACUS 需要使用全相对论赝势，并且理想情况下，原子轨道也应包含 $j=l \pm 1/2$ 的分裂特征。目前的 v1 版轨道未包含此信息。

**决策指南**：
*   如果你必须计算 SOC（如拓扑绝缘体、重金属表面态）：
    *   **不要使用** 当前的 APNS-v1 轨道。
    *   请寻找专门适配 SOC 的轨道库，或使用平面波基组 (`basis_type pw`) 进行计算（虽然速度较慢，但物理上更严谨）。
*   **INPUT 参数检查**：
    ```abacus
    lspinorb  1  // 如果开启此项，请务必更换轨道文件或基组模式
    noncolin  1  // 非共线磁性通常也建议搭配 SOC
    ```

### 4.3.2 无轨道密度泛函 (OFDFT) 的混淆
ABACUS 支持无轨道密度泛函理论（Orbital-Free DFT），这在大尺度铝、镁等金属模拟中非常有用。

**关键区别**：
*   **KS-DFT (LCAO)**: 使用 UPF 赝势 + `.orb` 轨道文件。
*   **OFDFT**: 使用 BLPS (Bulk Local Pseudopotentials) 格式赝势，**不需要** `.orb` 轨道文件。

**决策指南**：
如果你在做 OFDFT 计算（`esolver_type ofdft`），请不要在 `STRU` 中指定 APNS 的轨道文件，也不要使用常规的 UPF 赝势，否则程序会报错或结果荒谬。

---

## 附录：常见陷阱与避坑指南

在实际操作中，我见过太多学生因为忽视细节而导致计算失败。以下是“血泪经验”总结：

### 1. 文件名误读：盲目追求大 `au`
APNS 的文件名通常包含截断半径信息（如 `7au`, `8au`）。
*   **陷阱**：认为 `au` 越大越好。
*   **后果**：计算时间呈立方级增长。对于大多数固体体系，`6au` - `8au` 通常是性价比区间。只有在气相分子或极疏松体系中才考虑超大截断半径。

### 2. `ecutwfc` 参数不一致
每个轨道文件在生成时都有一个推荐的平面波截断能量（用于数值积分网格）。
*   **陷阱**：`INPUT` 中的 `ecutwfc` 设置得比轨道文件推荐值低。
*   **后果**：**严重的蛋壳效应（Egg-box effect）**。原子移动时能量剧烈震荡，导致结构优化无法收敛。
*   **对策**：务必检查轨道文件头部的注释，确保 `INPUT` 中的 `ecutwfc` $\ge$ 推荐值。

### 3. `STRU` 路径灾难
*   **陷阱**：直接复制别人的 `STRU` 文件，但当前目录下没有对应的 `.orb` 或 `.upf` 文件。
*   **对策**：建议使用绝对路径引用公共库中的赝势和轨道，或者编写脚本在计算前自动软链接所需文件。

```abacus
// 错误示范：文件名与实际不符
Si 28.08 Si.upf Si_orb_dzp.orb 

// 正确示范：明确指定版本
Si 28.08 Si_ONCV_PBE-1.0.upf Si_orb_Si_7.0au_efficiency.orb
```

---
**下一章预告**：
选好了轨道，写好了 INPUT，我们即将进入实战核心——**第五章：结构优化与收敛性调试**。如果你发现你的原子在盒子里“乱飞”或者能量震荡不休，下一章将是你的救命稻草。