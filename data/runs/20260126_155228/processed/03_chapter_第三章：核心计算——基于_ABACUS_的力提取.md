# 第三章：核心计算——基于 ABACUS 的力提取

在上一章中，我们利用 Phonopy 生成了包含微小位移的超胞结构文件（如 `STRU-001`, `STRU-002`...）。本章将进入整个声子谱计算中**算力消耗最大**的环节：对每一个微扰结构进行高精度的自洽场（SCF）计算，并提取原子受力。

这一步的质量直接决定了声子谱的准确性。如果力计算不准，声子谱会出现虚频或软模。作为 ABACUS 的开发者，我将带你深入理解如何配置 `INPUT` 文件以满足声子计算的苛刻要求。

---

## 3.1 电子步参数设置 (INPUT)

在这一步，我们的核心目标是：**在固定原子位置（不进行离子弛豫）的前提下，计算出系统处于基态时的精确原子受力。**

这就要求我们在 `INPUT` 文件中做出一系列特定的配置。以下是一个针对声子计算的标准 `INPUT` 模板（基于 LCAO 基组示例，平面波基组逻辑相同）：

```bash
INPUT_PARAMETERS
# 1. General Parameters
suffix          Al-fcc-disp001  # 建议后缀包含位移编号，便于管理
calculation     scf             # 关键：必须是静态自洽计算
symmetry        1               # 允许 ABACUS 分析剩余对称性
cal_force       1               # 核心：必须开启力计算
cal_stress      1               # 推荐：开启应力计算（辅助判断）
stru_file       STRU-001        # 技巧：直接指定读取的结构文件

# 2. Iteration & Precision
scf_thr         1e-8            # 关键：高精度收敛标准
scf_nmax        100             # 防止难收敛体系过早退出

# 3. Basis & Smearing (根据具体体系调整)
basis_type      lcao
ecutwfc         100
smearing_method mp
smearing_sigma  0.015
mixing_type     pulay
mixing_beta     0.7
```

### 关键参数详解

#### 1. `calculation`: `scf`
*   **含义**：执行电子自洽迭代（Self-Consistent Field），但不移动离子位置。
*   **专家提示**：千万不要设置为 `relax` 或 `cell-relax`。我们的目的是获取原子在**偏离平衡位置**时的回复力（Restoring Force），如果开启弛豫，原子跑回平衡位置，力变为零，声子计算就失败了。

#### 2. `cal_force`: `1`
*   **含义**：开启原子受力计算。
*   **默认值**：在 `calculation = scf` 时，默认通常为 `0`（视版本而定，显式设置为 `1` 最安全）。
*   **物理意义**：ABACUS 会根据 Hellmann-Feynman 定理计算每个原子在三个方向上的受力。这是构建力常数矩阵（Force Constants）的直接数据来源。

#### 3. `scf_thr`: `1e-7` 或 `1e-8`
*   **含义**：自洽迭代的能量收敛阈值（单位：Ry）。
*   **专家提示**：声子计算对精度要求极高。
    *   普通的能量计算可能 `1e-6` 就够了。
    *   但在有限位移法中，我们需要的是能量对位置的导数（力）。如果波函数收敛不够彻底，计算出的力会包含“数值噪声”，导致声子谱（尤其是声学支在 $\Gamma$ 点附近）出现非物理的虚频。建议设置为 `1e-7` 甚至更小。

#### 4. `stru_file`: `STRU-001` (高效技巧)
*   **含义**：指定 ABACUS 读取特定的结构文件名，而不是默认的 `STRU`。
*   **实战价值**：
    *   Phonopy 生成的文件通常命名为 `STRU-001`, `STRU-002` 等。
    *   **传统笨办法**：把 `STRU-001` 复制为 `STRU` -> 运行 -> 删掉 -> 复制 `STRU-002`...
    *   **ABACUS 原生支持**：直接在 `INPUT` 中修改 `stru_file` 参数，即可让程序直接读取对应的微扰文件，极大简化了批量脚本的编写逻辑。

#### 5. `symmetry`: `1`
*   **含义**：开启对称性分析。
*   **原理解析**：虽然引入微扰会破坏晶体的平移对称性，但某些微扰结构可能仍保留部分点群对称性。开启此选项允许 ABACUS 利用剩余对称性来加速计算（例如减少 k 点采样）。即使结构完全失去对称性（P1），开启此选项也是安全的，ABACUS 会自动退化处理。

---

## 3.2 批量任务执行与验证

Phonopy 根据扩胞大小和晶体对称性，可能会生成几个到几百个不等的微扰结构。我们需要对每一个结构运行一次 ABACUS。

### 推荐的文件组织结构

为了方便后续使用 `phonopy -f` 命令提取力，建议采用以下两种组织方式之一：

#### 方案 A：子文件夹模式（最稳健，推荐）
为每个微扰结构建立独立的文件夹，避免输出文件相互覆盖。
```text
Work_Dir/
├── disp-001/
│   ├── INPUT          (stru_file 指定为 STRU)
│   ├── STRU           (由 STRU-001 重命名而来)
│   ├── KPT
│   └── pseudopotentials/
├── disp-002/
│   ├── INPUT
│   ├── STRU           (由 STRU-002 重命名而来)
│   └── ...
```
在这种模式下，你需要编写脚本进入每个文件夹运行 ABACUS。

#### 方案 B：原地运行模式（配合 `stru_file`）
利用 `stru_file` 参数，在同一目录下依次运行，但必须**重命名输出目录**，否则会被覆盖。
```bash
# 伪代码示例
for i in {001..005}; do
    # 1. 修改 INPUT 中的 stru_file 为 STRU-$i
    sed -i "s/stru_file.*/stru_file STRU-$i/g" INPUT
    
    # 2. 运行 ABACUS
    abacus > running_scf.log
    
    # 3. 备份关键日志（Phonopy 需要读取 log 文件）
    mkdir -p disp-$i
    cp OUT*/running_scf.log disp-$i/
done
```

### 结果验证：如何确认计算成功？

在将数据喂给 Phonopy 之前，必须进行人工或脚本检查。打开 `running_scf.log`（或输出目录下的日志文件），检查以下两点：

1.  **收敛性检查**：
    文件末尾不应出现 "Convergence NOT achieved" 的警告。如果未收敛，计算出的力是无意义的。
    *   *对策*：如果遇到不收敛，尝试增加 `scf_nmax` 或调整 `mixing_beta`（通常减小该值，如从 0.7 降至 0.3）。

2.  **力数据输出**：
    搜索关键字 `FORCE`。你应该能看到类似下方的输出块：
    ```text
    -----------------------------------------------------------------------------------------------------
                                       FORCE (eV/Angstrom)
    -----------------------------------------------------------------------------------------------------
    Atom           x            y            z
    -----------------------------------------------------------------------------------------------------
    Al             0.001234     -0.045678     0.000000
    Al            -0.001234      0.045678     0.000000
    ...
    ```
    **注意**：Phonopy 的 ABACUS 接口正是通过解析这个日志文件中的 `FORCE` 部分来提取数据的。如果日志中没有这一段，说明 `cal_force` 未正确开启。

### 下一步预告
一旦你确认所有微扰结构的 `running_scf.log` 都已生成且包含收敛的力数据，最耗时的计算部分就完成了。下一章，我们将使用 Phonopy 收集这些数据，构建力常数矩阵，并最终绘制出漂亮的声子谱。