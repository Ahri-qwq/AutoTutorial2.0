<!-- META_START -->
# ABACUS 实战教程：晶体结构优化原理与应用

## 前言
- **本书逻辑**: 本教程遵循“物理图像构建 -> 基础操作上手 -> 进阶场景应用 -> 精度与陷阱排查”的教学逻辑。旨在帮助读者从理解“为什么要优化”出发，掌握 ABACUS 中两种核心优化模式（原子弛豫与变胞优化）的区别与设置，最终具备处理复杂体系（如对称性破缺、高精度收敛）的能力。
- **核心知识点**: 电子步与离子步迭代、`relax` 与 `cell-relax` 的应用场景、力与应力的收敛标准、LCAO 基组下的精度控制、ASE 外部驱动优化。

<!-- CHAPTER_START -->
## 第一章：物理图像与算法原理
**本章逻辑**: 在操作软件之前，必须建立正确的物理直觉。本章阐述结构优化的本质是寻找势能面极小值，并解释 ABACUS 内部如何通过嵌套循环实现这一过程，为后续参数设置打下理论基础。

### Section 1.1: 寻找基态：从势能面到力
- **内容**: 解释结构优化（Geometry Optimization）的物理含义——寻找体系在零温下的能量最低点（基态）。介绍 Born-Oppenheimer 近似下的势能面概念，以及力（能量对坐标的一阶导数）如何驱动原子移动。
- **关键参数**: 无（理论概念）。

### Section 1.2: 迭代机制：电子步与离子步
- **内容**: 详解 ABACUS 的双重迭代循环结构。
    1. **电子步 (Electronic Step)**: 固定原子求解 Kohn-Sham 方程，获取能量和力（涉及 SCF 自洽）。
    2. **离子步 (Ionic Step)**: 根据力/应力调整原子坐标/晶胞，进入下一个电子步。
- **关键参数**: `calculation` (作为流程控制的总开关)。

### Section 1.3: 优化算法概览
- **内容**: 简述驱动离子步的数学算法（如 BFGS, CG 等）。*注意：由于素材未明确 ABACUS 原生 INPUT 中选择具体算法的参数名，本节将重点介绍算法通识，并提示读者查阅官方文档以确定具体算法参数。*
- **关键参数**: 待定 (需查阅官方文档以选择具体的离子步迭代算法)。

<!-- CHAPTER_START -->
## 第二章：基础实战：固定晶胞的原子弛豫 (Relax)
**本章逻辑**: 这是最简单的优化场景。本章通过 `relax` 模式，教授如何消除原子内部受力，适用于表面计算、缺陷体系或已知晶格常数的场景，重点在于理解原子位置的更新。

### Section 2.1: 场景定义与 INPUT 设置
- **内容**: 明确 `relax` 模式的定义：固定晶胞形状和体积，仅优化原子位置。
- **关键参数**: 
    - `calculation`: 设置为 `relax`。
    - `relax_nmax`: 设置最大离子步数（强调需设置足够大，如 50-200，避开素材中 `1` 的测试陷阱）。

### Section 2.2: 结构文件 (STRU) 准备
- **内容**: 规范 `STRU` 文件的写法。强调推荐使用分数坐标 (`Direct`) 以保持优化过程中的相对位置稳定性。说明原子质量在静态优化中不影响结果。
- **关键参数**: `ATOMIC_POSITIONS` (推荐 `Direct`), `ATOMIC_SPECIES`.

### Section 2.3: 收敛标准与结果分析
- **内容**: 如何判断优化是否完成。解读输出文件中的残余力。
- **关键参数**: `force_thr_ev` (力收敛阈值，如 0.01 eV/Ang).

<!-- CHAPTER_START -->
## 第三章：进阶实战：变胞优化与晶格常数确定 (Cell-Relax)
**本章逻辑**: 对于块体材料，确定晶格常数是计算能带和声子的前提。本章引入 `cell-relax`，增加了“晶胞应力”这一核心变量，是本教程的重难点。

### Section 3.1: 晶格优化的物理意义
- **内容**: 解释何时需要优化晶胞（如未知材料探索、高压相变研究）。引入“应力张量”概念，目标是将晶胞内部应力降为零（或目标压强）。
- **关键参数**: `calculation`: 设置为 `cell-relax`。

### Section 3.2: 应力控制与收敛
- **内容**: 设置晶胞优化的收敛条件。不仅有力，还有应力。
- **关键参数**: 
    - `stress_thr`: 应力收敛阈值 (需核实单位，通常为 kbar)。
    - `force_thr_ev`: 原子受力阈值（两者需同时满足）。

### Section 3.3: 常见问题：对称性维持
- **内容**: 讨论变胞优化中的对称性风险。解释为何高对称性结构（如 bcc）在无约束下可能坍塌为低对称性结构（如 fcc），以及物理上的亚稳态问题。
- **关键参数**: `symmetry` (待定，需查阅文档确认 ABACUS 原生对称性开关参数)。

<!-- CHAPTER_START -->
## 第四章：精度控制与工程陷阱
**本章逻辑**: 会跑代码不代表结果正确。本章专门讨论影响优化质量的“隐形”因素，如 K 点、基组精度，以及如何避免常见的工程错误。

### Section 4.1: 基组与 K 点对力的影响
- **内容**: 阐述平面波截断能和 K 点采样密度如何直接影响力和应力的计算精度。强调素材中提到的“示例参数（如 2x2x2 K点）仅供测试，生产环境需严格收敛”。
- **关键参数**: 
    - `ecutwfc` / `ecut`: 平面波截断能。
    - `basis_type`: `lcao` (需注意轨道文件质量)。

### Section 4.2: 陷阱排查：震荡与未收敛
- **内容**: 分析优化不收敛的常见原因（步数不够、精度设置不合理、物理体系本身不稳定）。
- **关键参数**: `relax_nmax` (再次强调其重要性), `force_thr_ev` (过严可能导致震荡).

<!-- CHAPTER_START -->
## 第五章：高级应用：ASE 接口驱动优化
**本章逻辑**: 现代计算流程常借助 Python 脚本。本章介绍如何利用 ASE 库作为驱动器调用 ABACUS，重点解决原生输入难以处理的复杂对称性约束问题。

### Section 5.1: ASE 与 ABACUS 的交互机制
- **内容**: 解释 Calculator 模式：ASE 提供优化算法（Optimizer），ABACUS 提供能量和力。对比原生 `calculation=relax` 与 ASE 驱动的区别。
- **关键参数**: 无（Python 接口配置）。

### Section 5.2: 强对称性约束 (FixSymmetry)
- **内容**: 利用 ASE 的 `FixSymmetry` 类防止晶胞优化过程中的对称性破缺。解决素材中提到的“bcc 结构在特定势下自动演化为 fcc”的物理控制问题。
- **关键参数**: ASE Python 类 `FixSymmetry`, `UnitCellFilter`.

<!-- APPENDIX_START -->
## 附录：常见报错与速查表
- **参数速查**: 整理 `relax` vs `cell-relax` 的关键参数对比表。
- **常见坑点**: 
    1. `relax_nmax` 设为 1 导致计算意外终止。
    2. 混淆 `relax` (修原子) 和 `cell-relax` (修晶格) 的使用场景。
    3. 应力单位 (`stress_thr`) 的确认。
    4. 赝势与 LCAO 轨道文件不匹配导致的计算异常。