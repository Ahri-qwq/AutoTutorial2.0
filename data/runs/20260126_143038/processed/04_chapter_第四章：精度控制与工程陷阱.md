# 第四章：精度控制与工程陷阱

在前面的章节中，你已经成功让 ABACUS 跑了起来，并输出了能量和能带结构。但在计算材料学的世界里，**“程序不报错”与“结果正确”之间往往隔着巨大的鸿沟**。

本章将带你深入 ABACUS 的“引擎室”，探讨那些决定计算生死的隐形参数。我们将重点解决两个问题：一是如何确保计算结果在物理上是收敛的（精度控制）；二是如何避免新手常犯的“伪收敛”和配置错误（工程陷阱）。

---

## 4.1 基组与 K 点：力的隐形杀手

在结构优化（Relaxation）中，原子受力（Force）和应力（Stress）的计算精度直接决定了原子最终会停在哪里。如果基组或 K 点设置不足，你得到的可能是一个数学上“收敛”但物理上错误的结构。

### 4.1.1 K 点采样：别被示例误导

在教程和测试案例中，为了节省时间，我们经常使用 `2 2 2` 甚至 `1 1 1` 的 K 点采样。
**警示**：**在生产环境（Production Run）中，照搬测试参数是致命错误。**

*   **稀疏 K 点的后果**：会导致总能计算不准，更严重的是会导致电荷密度在实空间分布错误，进而导致原子受力计算出现系统性偏差。
*   **收敛性测试**：对于一个新的体系，必须进行 K 点收敛性测试。即逐渐增加 K 点密度（如 `2x2x2` -> `4x4x4` -> `6x6x6`），直到总能和原子受力的变化低于你的容忍阈值（例如能量差 < 1 meV/atom）。
*   **金属体系**：金属体系费米面附近的电子态非常复杂，通常需要比绝缘体更密的 K 点采样。

### 4.1.2 平面波截断能 (`ecutwfc`) 与 LCAO

即使你使用的是数值原子轨道（LCAO）基组，`ecutwfc` 依然是一个核心参数。

*   **参数含义**：`ecutwfc`（单位：Ry）决定了实空间积分网格的密度。
*   **LCAO 下的作用**：虽然 LCAO 也就是 `basis_type lcao` 主要是用轨道展开波函数，但 ABACUS 在处理哈密顿量中的某些项（如局部赝势、电荷密度计算）时，依然依赖实空间网格。
*   **推荐设置**：
    *   默认值通常为 50 Ry。
    *   对于“硬”赝势（如氧、过渡金属）或高精度受力计算，建议提高到 **60-100 Ry**。
    *   **判据**：如果发现原子受力出现非物理的微小震荡（Egg-box effect），适当提高 `ecutwfc` 往往能改善。

### 4.1.3 轨道文件的质量

在 `basis_type lcao` 模式下，计算精度上限由轨道文件（`.orb`）决定。
*   **DZP vs TZP**：通常 `DZP`（Double Zeta Polarized）是效率和精度的平衡点。但在高压物理或强关联体系中，可能需要 `TZP` 甚至更高级别的轨道。
*   **陷阱**：不要混用不同赝势库的轨道文件。赝势文件（`.upf`）必须与轨道文件（`.orb`）严格匹配（通常由同一套生成程序产生）。

---

## 4.2 结构优化中的陷阱排查

结构优化（Geometry Optimization）是材料模拟中最耗时的步骤之一。以下是 ABACUS 用户最容易踩的坑。

### 4.2.1 核心区分：`relax` vs `cell-relax`

这是新手最容易混淆的两个计算模式，选错会导致物理图像完全错误。

| 参数设置 (`calculation`) | 物理含义 | 晶胞行为 | 原子行为 | 典型应用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **`relax`** | 离子弛豫 | **固定** (Fixed) | 移动 | 表面计算、缺陷能、吸附能、声子谱计算前的优化 |
| **`cell-relax`** | 晶胞弛豫 | **可变** (Variable) | 移动 | 寻找块体材料的基态晶格常数、加压下的相变研究 |

*   **场景引导 1（表面计算）**：如果你切了一个表面（Slab），并在上面放了一个吸附原子。此时**必须使用 `relax`**。如果你使用了 `cell-relax`，真空层（Vacuum）会因为没有原子支撑而坍塌，导致计算失败。
*   **场景引导 2（晶格常数）**：如果你想知道硅（Si）在 DFT 下的理论晶格常数是多少，**必须使用 `cell-relax`**。如果用 `relax`，晶格常数会被锁定在你的初始结构（如 `STRU` 文件）中，原子跑得再久，晶格常数也不会变。

### 4.2.2 参数陷阱：`relax_nmax` 的虚假安全感

在许多快速入门教程中，为了演示流程，可能会设置 `relax_nmax 1`。

*   **危险操作**：在实际计算中，**千万不要保留 `relax_nmax 1`**。
*   **后果**：ABACUS 会在跑完 1 步离子步后强行停止。此时输出的 `STRU_ION_D` 虽然是新的，但原子受力可能依然巨大（例如 2 eV/Ang），结构处于极不稳定的高能态。
*   **正确做法**：生产环境中，请将 `relax_nmax` 设置为 **50 ~ 200**。让程序有足够的步数去寻找势能面极小值。

### 4.2.3 震荡与收敛标准 (`force_thr_ev`)

如果你的优化跑满了 `relax_nmax` 却依然不收敛（Not Converged），通常有以下原因：

1.  **收敛标准过严**：
    *   `force_thr_ev` 控制力的收敛阈值（单位 eV/Angstrom）。
    *   推荐值：`0.01` ~ `0.05`。
    *   **陷阱**：如果你设为 `0.0001`，由于数值噪音的存在，原子可能永远无法满足这个条件，从而在极小值附近反复震荡。

2.  **对称性破缺风险 (`symmetry`)**：
    *   `symmetry 1`（默认）：利用晶体对称性加速计算并约束搜索空间。
    *   `symmetry 0`：关闭空间对称性。
    *   **风险案例**：假设你计算一个体心立方（BCC）金属，初始结构稍微有一点点畸变。
        *   如果开启对称性，程序会强制保持 BCC 对称性进行优化。
        *   如果关闭对称性（`symmetry 0`），微小的数值扰动可能导致结构在优化过程中“滑向”面心立方（FCC）或非晶态（如果该势能面下 BCC 不稳定）。
    *   **建议**：除非你明确知道要研究对称性破缺（如 Jahn-Teller 效应或电荷密度波），否则建议保持 `symmetry 1`。

### 4.2.4 生产环境 `INPUT` 模板示例

以下是一个用于**生产环境**的 `INPUT` 文件片段，标注了关键的精度控制参数：

```bash
INPUT_PARAMETERS
# ... (系统参数)

# ----------------- 精度控制区 -----------------
ecutwfc         60          # [推荐] 生产环境建议 60-80 Ry，比默认 50 Ry 更稳
scf_thr         1.0e-7      # [推荐] 自洽精度，优化结构时建议比能量计算更严一点
basis_type      lcao        # 基组类型

# ----------------- 优化控制区 -----------------
calculation     cell-relax  # [关键] 确定你是要动晶胞(cell-relax)还是只动原子(relax)
relax_nmax      100         # [关键] 必须足够大！不要用 1
force_thr_ev    0.02        # [推荐] 力的收敛标准，0.01-0.05 是合理区间
stress_thr      0.5         # [推荐] 应力收敛标准(KBar)，仅在 cell-relax 时有效

# ----------------- 对称性与涂抹 -----------------
symmetry        1           # [推荐] 保持对称性，除非需破缺
smearing_method mp          # 金属体系推荐 Methfessel-Paxton
smearing_sigma  0.02        # 涂抹宽度(Ry)
```

## 4.3 本章小结：工程自检清单

在提交任务到超算集群之前，请按以下清单自检：

1.  **K 点够不够？** 不要用 `2x2x2` 算性质，除非你的晶胞非常大（>50原子）。
2.  **模式对不对？** 算表面/缺陷用 `relax`，算晶格常数用 `cell-relax`。
3.  **步数够不够？** `relax_nmax` 是否大于 50？
4.  **标准是否合理？** `force_thr_ev` 是否设为了物理上合理的数值（0.01-0.05）？

掌握了这些，你就跨越了“跑通代码”到“计算科学”的关键一步。下一章，我们将进入电子性质的深水区——能带与态密度的计算。