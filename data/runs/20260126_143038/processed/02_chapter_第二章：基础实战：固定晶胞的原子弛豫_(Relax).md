# 第二章：基础实战：固定晶胞的原子弛豫 (Relax)

在第一章中，我们学习了如何进行单点能计算（SCF）。然而，在实际材料研究中，我们构建的初始结构往往不是能量最低的稳定态。原子之间可能存在巨大的内应力，这会导致计算出的电子性质（如能带、态密度）物理意义存疑。

本章将介绍最基础的结构优化模式——**固定晶胞的原子弛豫（Relax）**。

## 2.1 场景定义与 INPUT 设置

### 2.1.1 什么是 Relax？
在 ABACUS 中，`calculation` 参数决定了计算任务的类型。
- **`relax` (本章重点)**：**固定晶胞**的形状和体积（即晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 不变），仅根据原子受力移动**原子位置**，直到原子受力小于设定阈值。
- **`cell-relax` (下一章)**：同时优化原子位置和晶胞形状/体积。

> **核心区分 (Critical)**：
> *   **何时用 `relax`？**
>     *   **表面计算**：构建 Slab 模型时，通常固定底层原子，只弛豫表面原子，且必须保持真空层和晶格常数不变。
>     *   **缺陷体系**：在超胞中引入空位或掺杂后，通常保持超胞晶格不变，仅让原子适应局部畸变。
>     *   **已知实验晶格**：当你明确希望在实验测定的晶格常数下研究电子结构时。
> *   **何时用 `cell-relax`？**
>     *   **块体材料基态**：当你需要确定材料理论上的平衡晶格常数（如计算状态方程 EOS）时。

### 2.1.2 关键参数详解
在 `INPUT` 文件中，启动 Relax 模式需要设置以下核心参数：

```bash
INPUT_PARAMETERS
# ... (基础参数如 suffix, ecutwfc, basis_type 等) ...

# 任务类型
calculation     relax           # 开启固定晶胞的原子弛豫

# 迭代控制 (重要!)
relax_nmax      100             # 最大离子步数 (建议 50-200)
force_thr_ev    0.01            # 力收敛阈值 (单位: eV/Angstrom)

# 输出控制
out_stru        1               # 输出优化后的 STRU 文件
```

> **参数陷阱 (Critical Warning)**：
> 在部分测试案例或教程中，你可能会看到 `relax_nmax 1`。这通常是为了快速测试流程是否跑通而设置的极小值。
> **在实际生产计算中，切勿照搬！** 复杂的体系往往需要几十甚至上百步才能收敛。如果设置为 1，计算会在第一步后强行终止，你得到的将是一个未优化的中间结构，且没有任何报错提示。请务必将其设置为 **50 到 200** 之间的数值。

### 2.1.3 物理原理补充
- **`force_thr_ev`**: 默认值通常在 0.025 eV/Å 左右（具体视版本而定），但在高精度计算（如声子谱计算前置优化）中，建议收紧至 **0.001 eV/Å**。
- **`cal_force`**: 在 `calculation` 为 `relax` 时，ABACUS 会自动开启力的计算，无需手动设置。

---

## 2.2 结构文件 (STRU) 准备

在结构优化中，`STRU` 文件的规范性直接影响收敛效率。

### 2.2.1 推荐使用分数坐标 (Direct)
虽然 ABACUS 支持笛卡尔坐标 (`Cartesian`)，但在优化过程中，推荐使用分数坐标 (`Direct`)。

**示例 STRU 片段**：
```text
ATOMIC_POSITIONS
Direct
Si  0.0000000000  0.0000000000  0.0000000000 1 1 1
Si  0.2500000000  0.2500000000  0.2500000000 1 1 1
```
*   **移动限制**：坐标后的 `1 1 1` 表示允许该原子在 x, y, z 三个方向上移动。如果写成 `0 0 0`，则该原子被固定（常用于表面计算固定底层）。
*   **原子质量**：在 `ATOMIC_SPECIES` 中指定的原子质量仅影响分子动力学（MD）的轨迹，**不影响** `relax` 的最终收敛位置和能量，因为静态优化只与势能面（PES）有关，与惯性无关。

### 2.2.2 对称性与 K 点的隐形风险

> **风险提示 (Symmetry Risk)**：
> 如果你的初始结构是对称性完美的（例如理想的 BCC 结构），但你希望它弛豫到另一种对称性（如畸变相），请务必检查 `symmetry` 参数。
> *   默认情况下，ABACUS 可能会利用初始结构的对称性来加速计算。
> *   如果初始结构有微小的人为扰动（为了诱导相变），但未关闭对称性约束，优化过程可能会强行保持高对称性，导致无法弛豫到真正的基态。

> **实战技巧 (K-Point Convergence)**：
> 结构优化对 K 点采样非常敏感。
> *   **不要**为了省时间使用稀疏的 K 点（如 Gamma only 或 2x2x2）进行粗略优化后再用密 K 点计算性质。
> *   力的收敛对 K 点的依赖性很高。如果 K 点不足，计算出的受力方向可能是错误的，导致结构“跑偏”。请务必使用与最终静态计算一致的、收敛的 K 点网格。

---

## 2.3 运行与结果分析

### 2.3.1 运行过程
执行计算后，ABACUS 会进行双重循环：
1.  **电子步 (Electronic Step)**：在固定原子位置下，进行 SCF 迭代求解基态电子密度和能量。
2.  **离子步 (Ionic Step)**：根据电子步得到的 Hellmann-Feynman 力，移动原子位置。
3.  重复上述过程，直到所有原子的受力都小于 `force_thr_ev`。

### 2.3.2 结果分析
计算结束后，我们需要检查输出文件（通常是屏幕输出重定向的文件，如 `running_relax.log`）来确认收敛情况。

**关键日志解读**：
```text
...
Step  1  Time  ...
Total Energy = -1234.5678 eV
...
FORCE STATISTICS (eV/Angstrom)
Atom     Max Force     RMS Force
...      0.523         0.310
...
Step  2  Time  ...
...
FORCE STATISTICS (eV/Angstrom)
Atom     Max Force     RMS Force
...      0.008         0.004
...
Relaxation is converged!
```

1.  **收敛标志**：寻找 "Relaxation is converged!" 字样。
2.  **能量变化**：随着离子步（Step 1, 2...）的进行，`Total Energy` 应该呈现下降趋势。如果能量震荡或上升，可能意味着步长过大或电子步未收敛。
3.  **力的变化**：关注 `Max Force`（最大受力）。当该值小于 INPUT 中设置的 `force_thr_ev` 时，优化结束。

### 2.3.3 获取优化后的结构
如果设置了 `out_stru 1`，计算完成后，输出目录（默认为 `OUT.suffix`）下会生成一个新的结构文件，通常命名为 `STRU_ION_D`（D 代表 Direct 坐标）。

*   **下一步操作**：将此文件复制并重命名为新的 `STRU`，即可用于后续的能带结构、态密度或光学性质计算。

---

**本章总结**：
通过 `relax` 模式，我们可以在固定晶格的前提下消除原子内力。这是绝大多数表面科学和缺陷物理研究的第一步。请务必记住：**合理的物理模型（是否需要固定晶胞）比参数设置更重要**。在下一章，我们将解锁更高级的 `cell-relax`，让晶胞自己“动”起来。