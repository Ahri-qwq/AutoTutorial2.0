# 第三章：进阶实战：变胞优化与晶格常数确定 (Cell-Relax)

在上一章中，我们学会了如何计算给定结构的能量。然而，在实际材料研究中，我们往往不知道材料的精确晶格常数，或者需要探究材料在高压下的相变行为。这就需要从“静态计算”跨越到“动态优化”。

本章将深入探讨 ABACUS 中的变胞优化（Variable-Cell Relaxation）。与仅移动原子位置的 `relax` 不同，`cell-relax` 允许晶胞的形状和体积发生变化，是确定块体材料基态晶格常数、计算状态方程（EOS）以及研究压电效应的核心手段。

---

## 3.1 晶格优化的物理意义：`relax` vs `cell-relax`

在开始计算之前，必须从物理图像上清晰区分两种优化模式。这是初学者最容易混淆的概念。

### 核心概念：应力张量 (Stress Tensor)
当原子在晶胞内受力不平衡时，会产生**原子受力 (Force)**；当晶胞本身的体积或形状不处于能量极小值时，会产生**晶胞应力 (Stress)**。
*   **Force**: 驱动原子移动，直到受力为零。
*   **Stress**: 驱动晶胞边长（晶格矢量）伸缩或倾斜，直到内部压强与外部压强（通常为0）平衡。

### 场景决策指南

| 场景 | 推荐模式 (`calculation`) | 物理目标 | 典型案例 |
| :--- | :--- | :--- | :--- |
| **固定晶胞优化** | `relax` | 仅消除原子受力，保持晶格常数不变 | 表面板模型（Surface Slab）、晶格中的缺陷/掺杂、分子在盒子中 |
| **变胞优化** | `cell-relax` | 同时消除原子受力和晶胞应力 | **块体材料基态搜索**、高压相变研究、未知晶体结构预测 |

> **⚠️ 警告 (Critical)**：
> 如果你的目标是计算一个块体材料（如单晶硅、金属铜）的理论晶格常数，**必须使用 `cell-relax`**。如果错误地使用了 `relax`，软件只会移动原子位置，而晶胞边长会被死死锁住，导致你永远无法得到能量最低的晶格常数。

---

## 3.2 实战设置：应力控制与收敛

进行变胞优化时，我们需要在 `INPUT` 文件中引入对应力的控制参数。

### 核心参数详解

#### 1. 开启变胞优化
```bash
calculation  cell-relax
```
ABACUS 的变胞优化采用嵌套循环机制：内层循环优化原子位置（Relax Ions），外层循环调整晶胞形状（Relax Cell）。

#### 2. 收敛阈值 (Thresholds)
变胞优化比固定晶胞优化更难收敛，因为它需要同时满足两个条件：
*   **力收敛 (`force_thr_ev`)**: 原子受力足够小。
*   **应力收敛 (`stress_thr`)**: 晶胞应力足够小。

```bash
force_thr_ev  0.01  # 单位: eV/Angstrom。推荐值: 0.01 ~ 0.02
stress_thr    2     # 单位: kbar。推荐值: 1 ~ 5
```
*   **单位注意**: `stress_thr` 的单位是 **kbar** (千巴)。1 kbar = 0.1 GPa。
*   **经验值**: 对于绝大多数科研用途，`2 kbar` 是一个平衡了精度与计算成本的合理值。如果你需要极高精度的弹性常数计算，可降至 `0.5` 或 `1`。

#### 3. 步数陷阱 (`relax_nmax`)
这是新手最容易“翻车”的参数。

> **⚠️ 陷阱 (Pitfall)**：
> 在某些测试脚本或简易教程中，你可能会看到 `relax_nmax 1`。这仅仅是为了测试流程是否跑通！
> **在生产环境中，请务必将其设置为 50 ~ 200。**

如果 `relax_nmax` 太小（例如默认值或设为 10），优化过程可能在结构远未达到基态时就强行终止，导致你得到一个错误的“半成品”结构。

```bash
relax_nmax    100   # 允许的最大离子/晶胞调整步数
```

### 完整 INPUT 示例 (LCAO 基组)

以下是一个针对 MgO 块体进行晶格常数优化的 `INPUT` 文件示例：

```bash
INPUT_PARAMETERS
# --- 基础设置 ---
suffix          MgO_cell_opt
ntype           2
pseudo_dir      ./
orbital_dir     ./
basis_type      lcao

# --- 电子步设置 ---
ecutwfc         100       # 结构优化对截断能敏感，建议取值比静态计算略高
scf_thr         1e-6      # 电子步收敛精度需高于离子步

# --- 结构优化核心设置 ---
calculation     cell-relax # 开启变胞优化
force_thr_ev    0.01       # 力收敛标准 (eV/Ang)
stress_thr      2          # 应力收敛标准 (kbar)
relax_nmax      100        # 最大步数，切勿设为 1
out_stru        1          # 输出每一步的结构文件
```

---

## 3.3 进阶难点：对称性维持与 K 点效应

在变胞优化中，自由度的增加带来了两个潜在风险：对称性破缺和 K 点采样误差。

### 1. 对称性维持 (Symmetry)

在优化高对称性结构（如立方晶系 BCC/FCC）时，数值噪音可能会导致晶胞发生微小的畸变，使其坍塌到低对称性结构（如三斜晶系）。

*   **风险**: 你原本想计算 BCC 铁的晶格常数，结果优化出来变成了一个稍微歪斜的盒子，角度变成了 89.9°。
*   **解决方案**: 在 `INPUT` 中显式开启对称性约束。

```bash
symmetry      1     # 1: 开启对称性分析并约束优化方向
```
开启后，ABACUS 会分析初始结构的对称性（Space Group），并在优化过程中强行保持这一对称性。例如，立方晶系在优化过程中，三个边长 $a, b, c$ 将被强制保持相等，三个角保持 90°。

### 2. K 点采样的敏感性

结构优化（尤其是变胞优化）对 K 点采样非常敏感。

*   **Pulay Stress (普莱应力)**: 在平面波 (PW) 计算中，当晶胞体积改变时，如果基组截断能不够大，会产生虚假的应力分量。虽然 LCAO 基组对此不那么敏感，但 K 点密度的变化依然会影响能量面。
*   **实战建议**: 
    1.  **K 点密度**: 资料中提到的 `2x2x2` 仅供快速演示。实际计算块体材料（如金属、半导体）的晶格常数时，请务必使用更密的 K 点（如 `6x6x6` 或 `8x8x8`，具体取决于晶胞大小），以确保应力计算准确。
    2.  **截断能**: 结构优化时使用的 `ecutwfc` 应略高于最终静态计算的值，以消除基组不完备带来的虚假力。

---

## 3.4 结果分析

运行完成后，你需要检查输出文件（通常在 `OUT.suffix/` 目录下）。

1.  **查看收敛过程**:
    检查日志文件，寻找 `RELAX CELL` 和 `RELAX IONS` 的标记。
    *   `RELAX IONS`: 在固定晶胞下优化原子。
    *   `RELAX CELL`: 更新晶胞形状。
    *   如果日志最后显示 `Structure relaxation finished.`，说明计算成功收敛。

2.  **获取最终结构**:
    ABACUS 会输出最终结构文件（通常命名为 `STRU_ION_D` 或类似，取决于版本）。你可以直接使用该文件中的 `LATTICE_CONSTANT` 和 `LATTICE_VECTORS` 作为后续能带计算的输入。

### 总结：变胞优化检查清单
- [ ] `calculation` 设为 `cell-relax`？
- [ ] `stress_thr` 设为合理值（如 2 kbar）？
- [ ] `relax_nmax` 足够大（>50）？
- [ ] `symmetry` 是否已开启（防止晶格畸变）？
- [ ] K 点采样是否足够收敛？