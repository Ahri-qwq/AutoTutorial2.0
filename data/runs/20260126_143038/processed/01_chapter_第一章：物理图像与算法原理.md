# 第一章：物理图像与算法原理

在开始编写任何一行输入文件之前，作为一名计算材料学者，我们必须首先在脑海中建立清晰的物理图像。ABACUS 作为一个基于密度泛函理论（DFT）的软件，其核心任务往往归结为两个字：**优化**。

本章将带你深入 ABACUS 的“黑盒”内部，理解结构优化的物理本质，以及软件是如何通过嵌套循环一步步逼近真实物理世界的基态。

---

## 1.1 寻找基态：从势能面到力

### 结构优化的物理本质
当我们谈论“结构优化”（Geometry Optimization）或“弛豫”（Relaxation）时，我们的物理目标是寻找体系在零温下的**基态（Ground State）**。

在 Born-Oppenheimer 近似下，原子核的运动速度远慢于电子。我们可以认为电子是瞬时响应原子核位置变化的。对于原子核的任意一种排布结构 $\mathbf{R}$，体系都有一个对应的总能量 $E(\mathbf{R})$。如果我们把所有可能的原子坐标作为变量，能量 $E$ 就是这些变量的函数，构成了一个多维的**势能面（Potential Energy Surface, PES）**。

结构优化的过程，本质上就是一个**登山者在浓雾中寻找山谷最低点**的过程：
1.  **高度**：体系的总能量 $E$。
2.  **坡度**：原子受到的力 $\mathbf{F}$。根据 Hellmann-Feynman 定理，力是能量对坐标的一阶导数的负值（$\mathbf{F} = -\nabla E$）。
3.  **方向**：力指引了能量下降最快的方向。

ABACUS 的任务，就是通过计算当前的“高度”和“坡度”，指挥原子核向受力方向移动，直到所有原子受力为零（$\mathbf{F} \approx 0$），此时体系处于势能面的极小值点。

---

## 1.2 迭代机制：电子步与离子步

为了实现上述过程，ABACUS 内部运行着一个严密的**双重迭代循环**。理解这一机制对于排查计算不收敛（Non-convergence）的问题至关重要。

### 1.2.1 内部循环：电子步 (Electronic Step)
这是内层循环，也称为 **SCF (Self-Consistent Field) 迭代**。
*   **状态**：原子核位置 **固定不动**。
*   **任务**：求解 Kohn-Sham 方程，寻找电子密度的基态。
*   **输出**：当前原子结构下的总能量 $E$ 和原子受力 $\mathbf{F}$（以及应力张量 $\sigma$）。
*   **控制参数**：`scf_thr`（电荷密度或能量的收敛阈值）。只有当电子步收敛，计算出的力和能量才是有物理意义的。

### 1.2.2 外部循环：离子步 (Ionic Step)
这是外层循环，也称为 **Geometry Optimization 迭代**。
*   **状态**：根据电子步算出的力 $\mathbf{F}$ 和应力 $\sigma$，**移动原子**或**改变晶胞形状**。
*   **任务**：降低体系总能量，消除原子受力和晶胞应力。
*   **控制参数**：`calculation` 是控制这一行为的总开关。

### 1.2.3 核心区分：`relax` vs `cell-relax`
在 `INPUT` 文件中，`calculation` 参数决定了离子步的具体行为。这是新手最容易混淆，也是最容易导致物理结果错误的设置。

| 参数设置 | `calculation relax` | `calculation cell-relax` |
| :--- | :--- | :--- |
| **物理含义** | **晶格固定**，仅优化原子内部坐标 | **全弛豫**，优化原子坐标 + 晶胞形状/体积 |
| **自由度** | 原子位置 ($\mathbf{r}_i$) | 原子位置 ($\mathbf{r}_i$) + 晶格矢量 ($\mathbf{h}$) |
| **典型场景** | 1. **表面计算**（需固定真空层和底层原子）<br>2. **缺陷计算**（需保持晶格与完美的超胞一致）<br>3. **分子/团簇**（无周期性边界条件） | 1. **块体材料**（Bulk）寻找基态晶格常数<br>2. **相变研究**（如加压下的结构形变）<br>3. **弹性常数**计算前的预处理 |
| **潜在风险** | 如果晶格常数设置错误，原子会受到巨大的内应力但无法释放。 | **K点采样敏感**：晶胞体积变化会导致倒空间 K 点密度变化，需使用足够密的 K 点。 |

> **⚠️ 专家警示：对称性破缺风险**
> 在进行 `cell-relax` 时，如果初始结构具有某种高对称性（如 bcc），但存在微小的数值扰动且未施加对称性约束，优化过程可能会导致结构“滑落”到更低对称性的相（如 fcc）。
> *   **建议**：在 `INPUT` 中明确检查对称性设置（通常默认开启），或者在 `STRU` 文件中严格定义初始结构。

---

## 1.3 优化算法概览与关键参数

在离子步中，ABACUS 需要决定原子移动的“步长”和“方向”。这依赖于具体的数学优化算法（如 CG, BFGS 等）。虽然用户通常只需使用默认算法，但理解以下参数对于控制计算流程至关重要。

### 1.3.1 必须设置的“安全阀”：`relax_nmax`
这是一个经常被误用的参数。它定义了离子步（结构优化）的**最大迭代步数**。

*   **测试陷阱**：在很多测试脚本或教程（如资料 6）中，你可能会看到 `relax_nmax 1`。这仅仅是为了测试代码流程是否跑通，**绝不是**生产环境的设置。
*   **生产建议**：
    *   对于简单体系：建议设置为 **50 - 100**。
    *   对于复杂体系（如表面重构、大分子）：建议设置为 **100 - 200** 甚至更高。
    *   **后果**：如果设置为 1 或过小，ABACUS 会在结构远未达到基态时强行停止，导致你分析的是一个处于高能激发态的错误结构。

### 1.3.2 收敛判据
ABACUS 如何知道“山谷底部”到了？它依赖于力和应力的阈值。虽然具体参数名需查阅最新文档（通常涉及 `force_thr` 或类似关键字），但物理逻辑如下：
1.  **力收敛**：所有原子的受力小于阈值（例如 $0.01 \text{ eV}/\mathring{A}$）。
2.  **应力收敛**（仅限 `cell-relax`）：晶胞应力小于阈值（例如 $1 \text{ kBar}$）。
3.  **能量收敛**：相邻两个离子步的能量差小于阈值。

### 1.3.3 实战 INPUT 模板示例
以下是一个标准的结构优化 `INPUT` 文件片段，展示了本章讨论的核心参数：

```bash
INPUT_PARAMETERS
# ---------------------------
# 流程控制 (Section 1.2)
# ---------------------------
suffix          Si_bulk_opt   # 任务名
calculation     cell-relax    # 关键！块体材料需优化晶胞
relax_nmax      100           # 关键！给予足够的迭代步数

# ---------------------------
# 物理量计算开关
# ---------------------------
cal_force       1             # 显式开启力计算（部分版本默认开启）
cal_stress      1             # cell-relax 必须开启应力计算

# ---------------------------
# 电子步参数 (Section 1.2.1)
# ---------------------------
ecutwfc         60            # 平面波截断能 (Ry)
scf_thr         1.0e-7        # 电子步收敛精度 (Ry)
basis_type      lcao          # 或 pw，取决于基组选择

# ---------------------------
# 专家提示：
# 实际计算中，请务必在 KPT 文件中设置收敛的 K 点网格。
# 2x2x2 通常仅用于测试，生产环境可能需要 6x6x6 或更高。
# ---------------------------
```

### 总结
*   **结构优化** = 电子步（算力）+ 离子步（移原子）的循环。
*   **`calculation`** 决定了你是只动原子（`relax`）还是连晶胞一起动（`cell-relax`）。
*   **`relax_nmax`** 必须设置得足够大，切勿照搬测试脚本中的 `1`。

下一章，我们将基于这些理论，手把手教你准备 `STRU` 结构文件，迈出计算的第一步。