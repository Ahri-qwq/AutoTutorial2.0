# ABACUS 第一性原理计算实战：从结构优化到工程进阶

## 前言

欢迎来到《ABACUS 第一性原理计算实战：从结构优化到工程进阶》。

作为由中国科学技术大学领衔开发的国产开源密度泛函理论（DFT）软件，ABACUS 凭借其独特的数值原子轨道（LCAO）基组优势，在处理大规模体系计算时展现出了卓越的效率。在计算材料学的漫长征途中，结构优化是几乎所有研究的“第一步”，也是决定后续物理量计算准确性的“基石”。

### 本书的学习路线图
为了帮助读者从零开始掌握 ABACUS 的结构优化技术，本书构建了循序渐进的五章内容：
1.  **物理图像与算法原理**：打破“黑盒”，带你理解电子自洽迭代（SCF）与离子步优化之间的嵌套关系。
2.  **基础实战：原子弛豫**：掌握最常用的 `relax` 计算，学习如何让原子在固定晶格中找到稳态位置。
3.  **进阶实战：变胞优化**：深入 `cell-relax`，学习如何确定材料的基态晶格常数及应对压力环境。
4.  **精度控制与工程陷阱**：这是本书的“排雷区”，重点探讨基组、K 点收敛性以及如何识别“伪收敛”现象。
5.  **高级应用：ASE 接口驱动**：打破原生输入限制，利用 Python 生态实现高通量计算与复杂对称性约束下的优化。

### 知识体系位置
在整个 ABACUS/DFT 知识体系中，本教程位于“静态单点能计算”之后、“动力学与物性计算”之前。它解决了“离子步”层面的核心问题。掌握了本书内容，你将能够为后续的能带结构分析、声子谱计算（如结合 ShengBTE 计算热导率）以及过渡态搜索提供精确的结构输入。

### 前置知识要求
在阅读本书前，我们建议读者具备以下基础：
- 了解密度泛函理论（DFT）的基本概念（如 Kohn-Sham 方程、交换关联泛函）。
- 熟悉 Linux 基本命令行操作。
- 能够完成基础的 ABACUS 单点能（SCF）计算任务。
- 具备基础的 Python 语法常识（仅针对第五章）。

---

# 第一章：物理图像与算法原理

在开始编写任何一行输入文件之前，作为一名计算材料学者，我们必须首先在脑海中建立清晰的物理图像。ABACUS 作为一个基于密度泛函理论（DFT）的软件，其核心任务往往归结为两个字：**优化**。

本章将带你深入 ABACUS 的“黑盒”内部，理解结构优化的物理本质，以及软件是如何通过嵌套循环一步步逼近真实物理世界的基态。

---

## 1.1 寻找基态：从势能面到力

### 结构优化的物理本质
当我们谈论“结构优化”（Geometry Optimization）或“弛豫”（Relaxation）时，我们的物理目标是寻找体系在零温下的**基态（Ground State）**。

在 Born-Oppenheimer 近似下，原子核的运动速度远慢于电子。我们可以认为电子是瞬时响应原子核位置变化的。对于原子核的任意一种排布结构 $\mathbf{R}$，体系都有一个对应的总能量 $E(\mathbf{R})$。如果我们把所有可能的原子坐标作为变量，能量 $E$ 就是这些变量的函数，构成了一个多维的**势能面（Potential Energy Surface, PES）**。

结构优化的过程，本质上就是一个**登山者在浓雾中寻找山谷最低点**的过程：
1.  **高度**：体系的总能量 $E$。
2.  **坡度**：原子受到的力 $\mathbf{F}$。根据 Hellmann-Feynman 定理，力是能量对坐标的一阶导数的负值（$\mathbf{F} = -\nabla E$）。
3.  **方向**：力指引了能量下降最快的方向。

ABACUS 的任务，就是通过计算当前的“高度”和“坡度”，指挥原子核向受力方向移动，直到所有原子受力为零（$\mathbf{F} \approx 0$），此时体系处于势能面的极小值点。

---

## 1.2 迭代机制：电子步与离子步

为了实现上述过程，ABACUS 内部运行着一个严密的**双重迭代循环**。理解这一机制对于排查计算不收敛（Non-convergence）的问题至关重要。

### 1.2.1 内部循环：电子步 (Electronic Step)
这是内层循环，也称为 **SCF (Self-Consistent Field) 迭代**。
*   **状态**：原子核位置 **固定不动**。
*   **任务**：求解 Kohn-Sham 方程，寻找电子密度的基态。
*   **输出**：当前原子结构下的总能量 $E$ 和原子受力 $\mathbf{F}$（以及应力张量 $\sigma$）。
*   **控制参数**：`scf_thr`（电荷密度或能量的收敛阈值）。只有当电子步收敛，计算出的力和能量才是有物理意义的。

### 1.2.2 外部循环：离子步 (Ionic Step)
这是外层循环，也称为 **Geometry Optimization 迭代**。
*   **状态**：根据电子步算出的力 $\mathbf{F}$ 和应力 $\sigma$，**移动原子**或**改变晶胞形状**。
*   **任务**：降低体系总能量，消除原子受力和晶胞应力。
*   **控制参数**：`calculation` 是控制这一行为的总开关。

### 1.2.3 核心区分：`relax` vs `cell-relax`
在 `INPUT` 文件中，`calculation` 参数决定了离子步的具体行为。这是新手最容易混淆，也是最容易导致物理结果错误的设置。

| 参数设置 | `calculation relax` | `calculation cell-relax` |
| :--- | :--- | :--- |
| **物理含义** | **晶格固定**，仅优化原子内部坐标 | **全弛豫**，优化原子坐标 + 晶胞形状/体积 |
| **自由度** | 原子位置 ($\mathbf{r}_i$) | 原子位置 ($\mathbf{r}_i$) + 晶格矢量 ($\mathbf{h}$) |
| **典型场景** | 1. **表面计算**（需固定真空层和底层原子）<br>2. **缺陷计算**（需保持晶格与完美的超胞一致）<br>3. **分子/团簇**（无周期性边界条件） | 1. **块体材料**（Bulk）寻找基态晶格常数<br>2. **相变研究**（如加压下的结构形变）<br>3. **弹性常数**计算前的预处理 |
| **潜在风险** | 如果晶格常数设置错误，原子会受到巨大的内应力但无法释放。 | **K点采样敏感**：晶胞体积变化会导致倒空间 K 点密度变化，需使用足够密的 K 点。 |

> **⚠️ 专家警示：对称性破缺风险**
> 在进行 `cell-relax` 时，如果初始结构具有某种高对称性（如 bcc），但存在微小的数值扰动且未施加对称性约束，优化过程可能会导致结构“滑落”到更低对称性的相（如 fcc）。
> *   **建议**：在 `INPUT` 中明确检查对称性设置（通常默认开启），或者在 `STRU` 文件中严格定义初始结构。

---

## 1.3 优化算法概览与关键参数

在离子步中，ABACUS 需要决定原子移动的“步长”和“方向”。这依赖于具体的数学优化算法（如 CG, BFGS 等）。虽然用户通常只需使用默认算法，但理解以下参数对于控制计算流程至关重要。

### 1.3.1 必须设置的“安全阀”：`relax_nmax`
这是一个经常被误用的参数。它定义了离子步（结构优化）的**最大迭代步数**。

*   **测试陷阱**：在很多测试脚本或教程（如资料 6）中，你可能会看到 `relax_nmax 1`。这仅仅是为了测试代码流程是否跑通，**绝不是**生产环境的设置。
*   **生产建议**：
    *   对于简单体系：建议设置为 **50 - 100**。
    *   对于复杂体系（如表面重构、大分子）：建议设置为 **100 - 200** 甚至更高。
    *   **后果**：如果设置为 1 或过小，ABACUS 会在结构远未达到基态时强行停止，导致你分析的是一个处于高能激发态的错误结构。

### 1.3.2 收敛判据
ABACUS 如何知道“山谷底部”到了？它依赖于力和应力的阈值。虽然具体参数名需查阅最新文档（通常涉及 `force_thr` 或类似关键字），但物理逻辑如下：
1.  **力收敛**：所有原子的受力小于阈值（例如 $0.01 \text{ eV}/\mathring{A}$）。
2.  **应力收敛**（仅限 `cell-relax`）：晶胞应力小于阈值（例如 $1 \text{ kBar}$）。
3.  **能量收敛**：相邻两个离子步的能量差小于阈值。

### 1.3.3 实战 INPUT 模板示例
以下是一个标准的结构优化 `INPUT` 文件片段，展示了本章讨论的核心参数：

```bash
INPUT_PARAMETERS
# ---------------------------
# 流程控制 (Section 1.2)
# ---------------------------
suffix          Si_bulk_opt   # 任务名
calculation     cell-relax    # 关键！块体材料需优化晶胞
relax_nmax      100           # 关键！给予足够的迭代步数

# ---------------------------
# 物理量计算开关
# ---------------------------
cal_force       1             # 显式开启力计算（部分版本默认开启）
cal_stress      1             # cell-relax 必须开启应力计算

# ---------------------------
# 电子步参数 (Section 1.2.1)
# ---------------------------
ecutwfc         60            # 平面波截断能 (Ry)
scf_thr         1.0e-7        # 电子步收敛精度 (Ry)
basis_type      lcao          # 或 pw，取决于基组选择

# ---------------------------
# 专家提示：
# 实际计算中，请务必在 KPT 文件中设置收敛的 K 点网格。
# 2x2x2 通常仅用于测试，生产环境可能需要 6x6x6 或更高。
# ---------------------------
```

### 总结
*   **结构优化** = 电子步（算力）+ 离子步（移原子）的循环。
*   **`calculation`** 决定了你是只动原子（`relax`）还是连晶胞一起动（`cell-relax`）。
*   **`relax_nmax`** 必须设置得足够大，切勿照搬测试脚本中的 `1`。

下一章，我们将基于这些理论，手把手教你准备 `STRU` 结构文件，迈出计算的第一步。

# 第二章：基础实战：固定晶胞的原子弛豫 (Relax)

在第一章中，我们学习了如何进行单点能计算（SCF）。然而，在实际材料研究中，我们构建的初始结构往往不是能量最低的稳定态。原子之间可能存在巨大的内应力，这会导致计算出的电子性质（如能带、态密度）物理意义存疑。

本章将介绍最基础的结构优化模式——**固定晶胞的原子弛豫（Relax）**。

## 2.1 场景定义与 INPUT 设置

### 2.1.1 什么是 Relax？
在 ABACUS 中，`calculation` 参数决定了计算任务的类型。
- **`relax` (本章重点)**：**固定晶胞**的形状和体积（即晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 不变），仅根据原子受力移动**原子位置**，直到原子受力小于设定阈值。
- **`cell-relax` (下一章)**：同时优化原子位置和晶胞形状/体积。

> **核心区分 (Critical)**：
> *   **何时用 `relax`？**
>     *   **表面计算**：构建 Slab 模型时，通常固定底层原子，只弛豫表面原子，且必须保持真空层和晶格常数不变。
>     *   **缺陷体系**：在超胞中引入空位或掺杂后，通常保持超胞晶格不变，仅让原子适应局部畸变。
>     *   **已知实验晶格**：当你明确希望在实验测定的晶格常数下研究电子结构时。
> *   **何时用 `cell-relax`？**
>     *   **块体材料基态**：当你需要确定材料理论上的平衡晶格常数（如计算状态方程 EOS）时。

### 2.1.2 关键参数详解
在 `INPUT` 文件中，启动 Relax 模式需要设置以下核心参数：

```bash
INPUT_PARAMETERS
# ... (基础参数如 suffix, ecutwfc, basis_type 等) ...

# 任务类型
calculation     relax           # 开启固定晶胞的原子弛豫

# 迭代控制 (重要!)
relax_nmax      100             # 最大离子步数 (建议 50-200)
force_thr_ev    0.01            # 力收敛阈值 (单位: eV/Angstrom)

# 输出控制
out_stru        1               # 输出优化后的 STRU 文件
```

> **参数陷阱 (Critical Warning)**：
> 在部分测试案例或教程中，你可能会看到 `relax_nmax 1`。这通常是为了快速测试流程是否跑通而设置的极小值。
> **在实际生产计算中，切勿照搬！** 复杂的体系往往需要几十甚至上百步才能收敛。如果设置为 1，计算会在第一步后强行终止，你得到的将是一个未优化的中间结构，且没有任何报错提示。请务必将其设置为 **50 到 200** 之间的数值。

### 2.1.3 物理原理补充
- **`force_thr_ev`**: 默认值通常在 0.025 eV/Å 左右（具体视版本而定），但在高精度计算（如声子谱计算前置优化）中，建议收紧至 **0.001 eV/Å**。
- **`cal_force`**: 在 `calculation` 为 `relax` 时，ABACUS 会自动开启力的计算，无需手动设置。

---

## 2.2 结构文件 (STRU) 准备

在结构优化中，`STRU` 文件的规范性直接影响收敛效率。

### 2.2.1 推荐使用分数坐标 (Direct)
虽然 ABACUS 支持笛卡尔坐标 (`Cartesian`)，但在优化过程中，推荐使用分数坐标 (`Direct`)。

**示例 STRU 片段**：
```text
ATOMIC_POSITIONS
Direct
Si  0.0000000000  0.0000000000  0.0000000000 1 1 1
Si  0.2500000000  0.2500000000  0.2500000000 1 1 1
```
*   **移动限制**：坐标后的 `1 1 1` 表示允许该原子在 x, y, z 三个方向上移动。如果写成 `0 0 0`，则该原子被固定（常用于表面计算固定底层）。
*   **原子质量**：在 `ATOMIC_SPECIES` 中指定的原子质量仅影响分子动力学（MD）的轨迹，**不影响** `relax` 的最终收敛位置和能量，因为静态优化只与势能面（PES）有关，与惯性无关。

### 2.2.2 对称性与 K 点的隐形风险

> **风险提示 (Symmetry Risk)**：
> 如果你的初始结构是对称性完美的（例如理想的 BCC 结构），但你希望它弛豫到另一种对称性（如畸变相），请务必检查 `symmetry` 参数。
> *   默认情况下，ABACUS 可能会利用初始结构的对称性来加速计算。
> *   如果初始结构有微小的人为扰动（为了诱导相变），但未关闭对称性约束，优化过程可能会强行保持高对称性，导致无法弛豫到真正的基态。

> **实战技巧 (K-Point Convergence)**：
> 结构优化对 K 点采样非常敏感。
> *   **不要**为了省时间使用稀疏的 K 点（如 Gamma only 或 2x2x2）进行粗略优化后再用密 K 点计算性质。
> *   力的收敛对 K 点的依赖性很高。如果 K 点不足，计算出的受力方向可能是错误的，导致结构“跑偏”。请务必使用与最终静态计算一致的、收敛的 K 点网格。

---

## 2.3 运行与结果分析

### 2.3.1 运行过程
执行计算后，ABACUS 会进行双重循环：
1.  **电子步 (Electronic Step)**：在固定原子位置下，进行 SCF 迭代求解基态电子密度和能量。
2.  **离子步 (Ionic Step)**：根据电子步得到的 Hellmann-Feynman 力，移动原子位置。
3.  重复上述过程，直到所有原子的受力都小于 `force_thr_ev`。

### 2.3.2 结果分析
计算结束后，我们需要检查输出文件（通常是屏幕输出重定向的文件，如 `running_relax.log`）来确认收敛情况。

**关键日志解读**：
```text
...
Step  1  Time  ...
Total Energy = -1234.5678 eV
...
FORCE STATISTICS (eV/Angstrom)
Atom     Max Force     RMS Force
...      0.523         0.310
...
Step  2  Time  ...
...
FORCE STATISTICS (eV/Angstrom)
Atom     Max Force     RMS Force
...      0.008         0.004
...
Relaxation is converged!
```

1.  **收敛标志**：寻找 "Relaxation is converged!" 字样。
2.  **能量变化**：随着离子步（Step 1, 2...）的进行，`Total Energy` 应该呈现下降趋势。如果能量震荡或上升，可能意味着步长过大或电子步未收敛。
3.  **力的变化**：关注 `Max Force`（最大受力）。当该值小于 INPUT 中设置的 `force_thr_ev` 时，优化结束。

### 2.3.3 获取优化后的结构
如果设置了 `out_stru 1`，计算完成后，输出目录（默认为 `OUT.suffix`）下会生成一个新的结构文件，通常命名为 `STRU_ION_D`（D 代表 Direct 坐标）。

*   **下一步操作**：将此文件复制并重命名为新的 `STRU`，即可用于后续的能带结构、态密度或光学性质计算。

---

**本章总结**：
通过 `relax` 模式，我们可以在固定晶格的前提下消除原子内力。这是绝大多数表面科学和缺陷物理研究的第一步。请务必记住：**合理的物理模型（是否需要固定晶胞）比参数设置更重要**。在下一章，我们将解锁更高级的 `cell-relax`，让晶胞自己“动”起来。

# 第三章：进阶实战：变胞优化与晶格常数确定 (Cell-Relax)

在上一章中，我们学会了如何计算给定结构的能量。然而，在实际材料研究中，我们往往不知道材料的精确晶格常数，或者需要探究材料在高压下的相变行为。这就需要从“静态计算”跨越到“动态优化”。

本章将深入探讨 ABACUS 中的变胞优化（Variable-Cell Relaxation）。与仅移动原子位置的 `relax` 不同，`cell-relax` 允许晶胞的形状和体积发生变化，是确定块体材料基态晶格常数、计算状态方程（EOS）以及研究压电效应的核心手段。

---

## 3.1 晶格优化的物理意义：`relax` vs `cell-relax`

在开始计算之前，必须从物理图像上清晰区分两种优化模式。这是初学者最容易混淆的概念。

### 核心概念：应力张量 (Stress Tensor)
当原子在晶胞内受力不平衡时，会产生**原子受力 (Force)**；当晶胞本身的体积或形状不处于能量极小值时，会产生**晶胞应力 (Stress)**。
*   **Force**: 驱动原子移动，直到受力为零。
*   **Stress**: 驱动晶胞边长（晶格矢量）伸缩或倾斜，直到内部压强与外部压强（通常为0）平衡。

### 场景决策指南

| 场景 | 推荐模式 (`calculation`) | 物理目标 | 典型案例 |
| :--- | :--- | :--- | :--- |
| **固定晶胞优化** | `relax` | 仅消除原子受力，保持晶格常数不变 | 表面板模型（Surface Slab）、晶格中的缺陷/掺杂、分子在盒子中 |
| **变胞优化** | `cell-relax` | 同时消除原子受力和晶胞应力 | **块体材料基态搜索**、高压相变研究、未知晶体结构预测 |

> **⚠️ 警告 (Critical)**：
> 如果你的目标是计算一个块体材料（如单晶硅、金属铜）的理论晶格常数，**必须使用 `cell-relax`**。如果错误地使用了 `relax`，软件只会移动原子位置，而晶胞边长会被死死锁住，导致你永远无法得到能量最低的晶格常数。

---

## 3.2 实战设置：应力控制与收敛

进行变胞优化时，我们需要在 `INPUT` 文件中引入对应力的控制参数。

### 核心参数详解

#### 1. 开启变胞优化
```bash
calculation  cell-relax
```
ABACUS 的变胞优化采用嵌套循环机制：内层循环优化原子位置（Relax Ions），外层循环调整晶胞形状（Relax Cell）。

#### 2. 收敛阈值 (Thresholds)
变胞优化比固定晶胞优化更难收敛，因为它需要同时满足两个条件：
*   **力收敛 (`force_thr_ev`)**: 原子受力足够小。
*   **应力收敛 (`stress_thr`)**: 晶胞应力足够小。

```bash
force_thr_ev  0.01  # 单位: eV/Angstrom。推荐值: 0.01 ~ 0.02
stress_thr    2     # 单位: kbar。推荐值: 1 ~ 5
```
*   **单位注意**: `stress_thr` 的单位是 **kbar** (千巴)。1 kbar = 0.1 GPa。
*   **经验值**: 对于绝大多数科研用途，`2 kbar` 是一个平衡了精度与计算成本的合理值。如果你需要极高精度的弹性常数计算，可降至 `0.5` 或 `1`。

#### 3. 步数陷阱 (`relax_nmax`)
这是新手最容易“翻车”的参数。

> **⚠️ 陷阱 (Pitfall)**：
> 在某些测试脚本或简易教程中，你可能会看到 `relax_nmax 1`。这仅仅是为了测试流程是否跑通！
> **在生产环境中，请务必将其设置为 50 ~ 200。**

如果 `relax_nmax` 太小（例如默认值或设为 10），优化过程可能在结构远未达到基态时就强行终止，导致你得到一个错误的“半成品”结构。

```bash
relax_nmax    100   # 允许的最大离子/晶胞调整步数
```

### 完整 INPUT 示例 (LCAO 基组)

以下是一个针对 MgO 块体进行晶格常数优化的 `INPUT` 文件示例：

```bash
INPUT_PARAMETERS
# --- 基础设置 ---
suffix          MgO_cell_opt
ntype           2
pseudo_dir      ./
orbital_dir     ./
basis_type      lcao

# --- 电子步设置 ---
ecutwfc         100       # 结构优化对截断能敏感，建议取值比静态计算略高
scf_thr         1e-6      # 电子步收敛精度需高于离子步

# --- 结构优化核心设置 ---
calculation     cell-relax # 开启变胞优化
force_thr_ev    0.01       # 力收敛标准 (eV/Ang)
stress_thr      2          # 应力收敛标准 (kbar)
relax_nmax      100        # 最大步数，切勿设为 1
out_stru        1          # 输出每一步的结构文件
```

---

## 3.3 进阶难点：对称性维持与 K 点效应

在变胞优化中，自由度的增加带来了两个潜在风险：对称性破缺和 K 点采样误差。

### 1. 对称性维持 (Symmetry)

在优化高对称性结构（如立方晶系 BCC/FCC）时，数值噪音可能会导致晶胞发生微小的畸变，使其坍塌到低对称性结构（如三斜晶系）。

*   **风险**: 你原本想计算 BCC 铁的晶格常数，结果优化出来变成了一个稍微歪斜的盒子，角度变成了 89.9°。
*   **解决方案**: 在 `INPUT` 中显式开启对称性约束。

```bash
symmetry      1     # 1: 开启对称性分析并约束优化方向
```
开启后，ABACUS 会分析初始结构的对称性（Space Group），并在优化过程中强行保持这一对称性。例如，立方晶系在优化过程中，三个边长 $a, b, c$ 将被强制保持相等，三个角保持 90°。

### 2. K 点采样的敏感性

结构优化（尤其是变胞优化）对 K 点采样非常敏感。

*   **Pulay Stress (普莱应力)**: 在平面波 (PW) 计算中，当晶胞体积改变时，如果基组截断能不够大，会产生虚假的应力分量。虽然 LCAO 基组对此不那么敏感，但 K 点密度的变化依然会影响能量面。
*   **实战建议**: 
    1.  **K 点密度**: 资料中提到的 `2x2x2` 仅供快速演示。实际计算块体材料（如金属、半导体）的晶格常数时，请务必使用更密的 K 点（如 `6x6x6` 或 `8x8x8`，具体取决于晶胞大小），以确保应力计算准确。
    2.  **截断能**: 结构优化时使用的 `ecutwfc` 应略高于最终静态计算的值，以消除基组不完备带来的虚假力。

---

## 3.4 结果分析

运行完成后，你需要检查输出文件（通常在 `OUT.suffix/` 目录下）。

1.  **查看收敛过程**:
    检查日志文件，寻找 `RELAX CELL` 和 `RELAX IONS` 的标记。
    *   `RELAX IONS`: 在固定晶胞下优化原子。
    *   `RELAX CELL`: 更新晶胞形状。
    *   如果日志最后显示 `Structure relaxation finished.`，说明计算成功收敛。

2.  **获取最终结构**:
    ABACUS 会输出最终结构文件（通常命名为 `STRU_ION_D` 或类似，取决于版本）。你可以直接使用该文件中的 `LATTICE_CONSTANT` 和 `LATTICE_VECTORS` 作为后续能带计算的输入。

### 总结：变胞优化检查清单
- [ ] `calculation` 设为 `cell-relax`？
- [ ] `stress_thr` 设为合理值（如 2 kbar）？
- [ ] `relax_nmax` 足够大（>50）？
- [ ] `symmetry` 是否已开启（防止晶格畸变）？
- [ ] K 点采样是否足够收敛？

# 第四章：精度控制与工程陷阱

在前面的章节中，你已经成功让 ABACUS 跑了起来，并输出了能量和能带结构。但在计算材料学的世界里，**“程序不报错”与“结果正确”之间往往隔着巨大的鸿沟**。

本章将带你深入 ABACUS 的“引擎室”，探讨那些决定计算生死的隐形参数。我们将重点解决两个问题：一是如何确保计算结果在物理上是收敛的（精度控制）；二是如何避免新手常犯的“伪收敛”和配置错误（工程陷阱）。

---

## 4.1 基组与 K 点：力的隐形杀手

在结构优化（Relaxation）中，原子受力（Force）和应力（Stress）的计算精度直接决定了原子最终会停在哪里。如果基组或 K 点设置不足，你得到的可能是一个数学上“收敛”但物理上错误的结构。

### 4.1.1 K 点采样：别被示例误导

在教程和测试案例中，为了节省时间，我们经常使用 `2 2 2` 甚至 `1 1 1` 的 K 点采样。
**警示**：**在生产环境（Production Run）中，照搬测试参数是致命错误。**

*   **稀疏 K 点的后果**：会导致总能计算不准，更严重的是会导致电荷密度在实空间分布错误，进而导致原子受力计算出现系统性偏差。
*   **收敛性测试**：对于一个新的体系，必须进行 K 点收敛性测试。即逐渐增加 K 点密度（如 `2x2x2` -> `4x4x4` -> `6x6x6`），直到总能和原子受力的变化低于你的容忍阈值（例如能量差 < 1 meV/atom）。
*   **金属体系**：金属体系费米面附近的电子态非常复杂，通常需要比绝缘体更密的 K 点采样。

### 4.1.2 平面波截断能 (`ecutwfc`) 与 LCAO

即使你使用的是数值原子轨道（LCAO）基组，`ecutwfc` 依然是一个核心参数。

*   **参数含义**：`ecutwfc`（单位：Ry）决定了实空间积分网格的密度。
*   **LCAO 下的作用**：虽然 LCAO 也就是 `basis_type lcao` 主要是用轨道展开波函数，但 ABACUS 在处理哈密顿量中的某些项（如局部赝势、电荷密度计算）时，依然依赖实空间网格。
*   **推荐设置**：
    *   默认值通常为 50 Ry。
    *   对于“硬”赝势（如氧、过渡金属）或高精度受力计算，建议提高到 **60-100 Ry**。
    *   **判据**：如果发现原子受力出现非物理的微小震荡（Egg-box effect），适当提高 `ecutwfc` 往往能改善。

### 4.1.3 轨道文件的质量

在 `basis_type lcao` 模式下，计算精度上限由轨道文件（`.orb`）决定。
*   **DZP vs TZP**：通常 `DZP`（Double Zeta Polarized）是效率和精度的平衡点。但在高压物理或强关联体系中，可能需要 `TZP` 甚至更高级别的轨道。
*   **陷阱**：不要混用不同赝势库的轨道文件。赝势文件（`.upf`）必须与轨道文件（`.orb`）严格匹配（通常由同一套生成程序产生）。

---

## 4.2 结构优化中的陷阱排查

结构优化（Geometry Optimization）是材料模拟中最耗时的步骤之一。以下是 ABACUS 用户最容易踩的坑。

### 4.2.1 核心区分：`relax` vs `cell-relax`

这是新手最容易混淆的两个计算模式，选错会导致物理图像完全错误。

| 参数设置 (`calculation`) | 物理含义 | 晶胞行为 | 原子行为 | 典型应用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **`relax`** | 离子弛豫 | **固定** (Fixed) | 移动 | 表面计算、缺陷能、吸附能、声子谱计算前的优化 |
| **`cell-relax`** | 晶胞弛豫 | **可变** (Variable) | 移动 | 寻找块体材料的基态晶格常数、加压下的相变研究 |

*   **场景引导 1（表面计算）**：如果你切了一个表面（Slab），并在上面放了一个吸附原子。此时**必须使用 `relax`**。如果你使用了 `cell-relax`，真空层（Vacuum）会因为没有原子支撑而坍塌，导致计算失败。
*   **场景引导 2（晶格常数）**：如果你想知道硅（Si）在 DFT 下的理论晶格常数是多少，**必须使用 `cell-relax`**。如果用 `relax`，晶格常数会被锁定在你的初始结构（如 `STRU` 文件）中，原子跑得再久，晶格常数也不会变。

### 4.2.2 参数陷阱：`relax_nmax` 的虚假安全感

在许多快速入门教程中，为了演示流程，可能会设置 `relax_nmax 1`。

*   **危险操作**：在实际计算中，**千万不要保留 `relax_nmax 1`**。
*   **后果**：ABACUS 会在跑完 1 步离子步后强行停止。此时输出的 `STRU_ION_D` 虽然是新的，但原子受力可能依然巨大（例如 2 eV/Ang），结构处于极不稳定的高能态。
*   **正确做法**：生产环境中，请将 `relax_nmax` 设置为 **50 ~ 200**。让程序有足够的步数去寻找势能面极小值。

### 4.2.3 震荡与收敛标准 (`force_thr_ev`)

如果你的优化跑满了 `relax_nmax` 却依然不收敛（Not Converged），通常有以下原因：

1.  **收敛标准过严**：
    *   `force_thr_ev` 控制力的收敛阈值（单位 eV/Angstrom）。
    *   推荐值：`0.01` ~ `0.05`。
    *   **陷阱**：如果你设为 `0.0001`，由于数值噪音的存在，原子可能永远无法满足这个条件，从而在极小值附近反复震荡。

2.  **对称性破缺风险 (`symmetry`)**：
    *   `symmetry 1`（默认）：利用晶体对称性加速计算并约束搜索空间。
    *   `symmetry 0`：关闭空间对称性。
    *   **风险案例**：假设你计算一个体心立方（BCC）金属，初始结构稍微有一点点畸变。
        *   如果开启对称性，程序会强制保持 BCC 对称性进行优化。
        *   如果关闭对称性（`symmetry 0`），微小的数值扰动可能导致结构在优化过程中“滑向”面心立方（FCC）或非晶态（如果该势能面下 BCC 不稳定）。
    *   **建议**：除非你明确知道要研究对称性破缺（如 Jahn-Teller 效应或电荷密度波），否则建议保持 `symmetry 1`。

### 4.2.4 生产环境 `INPUT` 模板示例

以下是一个用于**生产环境**的 `INPUT` 文件片段，标注了关键的精度控制参数：

```bash
INPUT_PARAMETERS
# ... (系统参数)

# ----------------- 精度控制区 -----------------
ecutwfc         60          # [推荐] 生产环境建议 60-80 Ry，比默认 50 Ry 更稳
scf_thr         1.0e-7      # [推荐] 自洽精度，优化结构时建议比能量计算更严一点
basis_type      lcao        # 基组类型

# ----------------- 优化控制区 -----------------
calculation     cell-relax  # [关键] 确定你是要动晶胞(cell-relax)还是只动原子(relax)
relax_nmax      100         # [关键] 必须足够大！不要用 1
force_thr_ev    0.02        # [推荐] 力的收敛标准，0.01-0.05 是合理区间
stress_thr      0.5         # [推荐] 应力收敛标准(KBar)，仅在 cell-relax 时有效

# ----------------- 对称性与涂抹 -----------------
symmetry        1           # [推荐] 保持对称性，除非需破缺
smearing_method mp          # 金属体系推荐 Methfessel-Paxton
smearing_sigma  0.02        # 涂抹宽度(Ry)
```

## 4.3 本章小结：工程自检清单

在提交任务到超算集群之前，请按以下清单自检：

1.  **K 点够不够？** 不要用 `2x2x2` 算性质，除非你的晶胞非常大（>50原子）。
2.  **模式对不对？** 算表面/缺陷用 `relax`，算晶格常数用 `cell-relax`。
3.  **步数够不够？** `relax_nmax` 是否大于 50？
4.  **标准是否合理？** `force_thr_ev` 是否设为了物理上合理的数值（0.01-0.05）？

掌握了这些，你就跨越了“跑通代码”到“计算科学”的关键一步。下一章，我们将进入电子性质的深水区——能带与态密度的计算。

# 第五章：高级应用：ASE 接口驱动优化

在前面的章节中，我们已经掌握了如何通过直接编辑 `INPUT` 文件来运行 ABACUS 的结构优化。然而，在面对复杂的科研场景时——例如高通量计算、过渡态搜索（NEB）、或者需要严格保持晶体对称性的相变研究——仅靠 ABACUS 原生的优化器可能不够灵活。

本章将介绍如何利用 Python 的 **ASE (Atomic Simulation Environment)** 库作为“驱动器（Driver）”，调用 ABACUS 作为“计算引擎（Calculator）”。这种模式不仅能极大扩展计算的自由度，还能有效解决原生输入难以处理的复杂对称性约束问题。

---

## 5.1 ASE 与 ABACUS 的交互机制

### 5.1.1 Calculator 模式：谁在掌舵？

理解 ASE 接口的核心在于区分“谁在移动原子”。

1.  **原生模式 (Native Mode)**：
    *   **掌舵者**：ABACUS 程序本身。
    *   **设置**：在 `INPUT` 中设置 `calculation relax` 或 `cell-relax`。
    *   **流程**：ABACUS 读取结构 -> 计算力 -> ABACUS 移动原子 -> 循环直到收敛。
    *   **优点**：简单，无需编写 Python 脚本，效率略高（无 I/O 开销）。

2.  **ASE 驱动模式 (ASE Driver Mode)**：
    *   **掌舵者**：Python 脚本中的 ASE 优化器（如 `BFGS`, `FIRE`）。
    *   **引擎**：ABACUS。
    *   **设置**：在 Python 脚本中，ABACUS 的 `calculation` 参数通常设为 `scf`（单点能计算）。
    *   **流程**：
        1. ASE 给定原子位置。
        2. ASE 调用 ABACUS 计算单点能（SCF），获取能量、力和应力。
        3. ASE 根据力，利用自身的算法（如 BFGS）计算下一步原子位置。
        4. ASE 更新位置，再次调用 ABACUS。
    *   **优点**：可以使用 ASE 强大的生态（如声子谱、NEB、遗传算法），且能通过 Python 代码对每一步进行精细控制（如施加特殊的对称性约束）。

### 5.1.2 基础调用示例

以下是一个典型的 Python 脚本框架，展示了如何使用 ASE 调用 ABACUS 进行结构优化。

> **注意**：运行此脚本前，请确保环境已安装 `ase` 库，并配置好 ABACUS 的环境变量。

```python
import os
from ase.io import read
from ase.optimize import BFGS
from ase.calculators.abacus import Abacus, AbacusProfile

# 1. 设置 ABACUS 运行环境
# 请根据实际机器修改 command，例如 mpirun -np 4 abacus
abacus_cmd = "mpirun -np 8 abacus" 
# 指向包含赝势和轨道文件的目录
pp_orb_dir = "./" 

profile = AbacusProfile(command=abacus_cmd)

# 2. 准备结构 (可以从文件读取，也可以用 ASE 建模)
atoms = read("STRU", format="abacus")

# 3. 设置计算器参数 (对应 INPUT 文件)
# 注意：这里 calculation 设为 'scf'，因为优化循环由 ASE 控制
calc = Abacus(
    profile=profile,
    directory='run_ase_opt',
    pp_dir=pp_orb_dir,
    orb_dir=pp_orb_dir,
    suffix='ase_driver',
    calculation='scf',       # 关键：只让 ABACUS 算单点能和力
    ecutwfc=100,             # Ry
    scf_thr=1e-6,
    basis_type='lcao',
    ks_solver='genelpa',
    smearing_method='gaussian',
    smearing_sigma=0.01,
    kpts=[4, 4, 4]           # 警告：实际计算请务必进行 K 点收敛测试
)

atoms.calc = calc

# 4. 设置 ASE 优化器
# logfile 记录优化过程，trajectory 保存轨迹
opt = BFGS(atoms, logfile='opt.log', trajectory='opt.traj')

# 5. 运行优化
# fmax 单位为 eV/Ang
opt.run(fmax=0.01)

# 6. 保存最终结构
atoms.write('STRU_optimized', format='abacus')
```

---

## 5.2 强对称性约束 (FixSymmetry)

在材料计算中，一个常见且棘手的问题是**对称性破缺**。

### 5.2.1 物理背景：BCC 到 FCC 的“意外”演化
假设你正在研究体心立方（BCC）铁在极端条件下的性质。如果你使用可变晶胞优化（Variable Cell Relaxation），由于数值噪音或初始结构的微小扰动，BCC 结构可能会沿着某个软模方向“滑移”，最终演化为面心立方（FCC）结构或更低对称性的结构。

虽然这在物理上可能是正确的（找到了更低能量的基态），但如果你**仅仅想研究 BCC 结构下的性质**（例如计算 BCC 下的声子谱或弹性常数），这种自动演化就是灾难性的。

### 5.2.2 解决方案：ASE FixSymmetry
ASE 提供了 `FixSymmetry` 类，它可以在优化的每一步强制清洗掉破坏对称性的力和应力分量，确保结构始终保持在指定的空间群中。

### 5.2.3 实战代码

我们需要结合 `UnitCellFilter`（用于优化晶胞）和 `FixSymmetry`（用于约束对称性）。

```python
from ase.constraints import FixSymmetry, UnitCellFilter
from ase.spacegroup import get_spacegroup

# ... (前文的 atoms 和 calc 设置代码同上) ...

# 1. 分析并施加对称性约束
# symprec 是对称性识别精度，建议设为 1e-5 或更小
atoms.set_constraint(FixSymmetry(atoms, symprec=1e-5))

# 打印当前识别出的空间群，确认是否符合预期
sg = get_spacegroup(atoms, symprec=1e-5)
print(f"Current Spacegroup: {sg.symbol} ({sg.no})")

# 2. 设置晶胞过滤器
# 如果要优化晶胞常数 (相当于 cell-relax)，必须使用 UnitCellFilter
# scalar_pressure 设置外压，单位通常为 eV/Ang^3 (ASE单位)，需注意换算
ucf = UnitCellFilter(atoms, scalar_pressure=0.0)

# 3. 将过滤器传入优化器，而不是直接传入 atoms
opt = BFGS(ucf, logfile='opt_sym.log')

# 4. 运行优化
# 此时，无论优化多少步，BCC 结构都不会变成 FCC，
# 只有保持 BCC 对称性的晶格常数和原子位置会被优化。
opt.run(fmax=0.01)
```

**专家提示**：
*   **初始结构很重要**：如果初始结构本身已经严重偏离了高对称性点，`FixSymmetry` 可能无法正确识别你想要的空间群。建议在建模时保证坐标的精确性。
*   **UnitCellFilter**：在 ASE 中，普通的 `BFGS(atoms)` 默认只优化原子坐标（固定晶胞）。如果你需要优化晶格常数（对应 ABACUS 的 `cell-relax`），必须使用 `UnitCellFilter` 或 `ExpCellFilter` 包装 atoms 对象。

---

<!-- APPENDIX_START -->
## 附录：常见报错与速查表

在进行结构优化时，参数设置失误是导致计算失败或结果不可信的主要原因。以下是针对 ABACUS 原生优化参数的速查表与避坑指南。

### 1. `relax` vs `cell-relax` 核心区分

这是初学者最容易混淆的概念，选错会导致物理意义完全不同的结果。

| 参数值 (`calculation`) | 物理含义 | 优化对象 | 典型应用场景 |
| :--- | :--- | :--- | :--- |
| **`relax`** | 几何优化 (Geometry Optimization) | **仅原子位置** (晶胞形状和体积固定) | 表面计算、缺陷体系、分子吸附、NEB 初态末态构建。 |
| **`cell-relax`** | 变胞优化 (Variable Cell Relaxation) | **原子位置 + 晶胞形状 + 体积** | 块体材料基态搜索、相变研究、寻找平衡晶格常数。 |

> **场景引导**：如果你在做一个表面吸附计算（构建了真空层），千万**不要**使用 `cell-relax`，否则真空层会因为没有原子支撑而坍缩，或者晶胞会发生非物理的畸变。

### 2. 常见“坑点”与解决方案

#### (1) `relax_nmax` 设为 1 的陷阱
*   **现象**：计算运行了一步离子步后就提示“收敛”或直接结束，但受力依然很大。
*   **原因**：在某些测试脚本或教程中，为了快速演示流程，会将 `relax_nmax`（最大离子迭代步数）设为 1。
*   **修正**：在生产计算中，**务必将 `relax_nmax` 设置得足够大**。
    *   推荐值：`relax_nmax 100` 或 `200`。
    *   如果 100 步仍未收敛，通常意味着初始结构太差或收敛标准过高，而不是步数不够。

#### (2) 应力单位 (`stress_thr`)
*   **现象**：设置了 `stress_thr 0.01`，结果计算永远不收敛，或者精度极差。
*   **原因**：ABACUS 的 `INPUT` 文件中，`stress_thr` 的默认单位是 **kBar**，而不是 eV/Ang³ 或 GPa。
*   **换算**：1 GPa = 10 kBar。
*   **推荐值**：
    *   粗略优化：`stress_thr 10` (1 GPa)
    *   精确优化：`stress_thr 1` (0.1 GPa)

#### (3) 赝势与 LCAO 轨道文件不匹配
*   **现象**：程序启动时报错，或者 SCF 第一步能量就是 `NaN`。
*   **原因**：使用 LCAO 基组时，`orbital_dir` 下的 `.orb` 文件必须与 `pseudo_dir` 下的 `.upf/.vwr` 文件是同一套生成参数制作的。
*   **修正**：始终从官方网站或可靠来源下载**成对**的赝势和轨道文件，不要混用不同版本的库。

#### (4) K 点采样的收敛性
*   **风险**：教程示例为了运行速度快，常使用 `2 2 2` 或 `3 3 3` 的 K 点。
*   **修正**：结构优化（尤其是 `cell-relax`）对 K 点密度非常敏感。K 点不足会导致晶格常数计算误差巨大。实际计算中，请务必进行 K 点收敛测试（例如对比 `4x4x4`, `6x6x6`, `8x8x8` 的结果）。

---

## 附录：进阶学习指南

恭喜你完成了本书的学习！结构优化只是计算材料学的起点，前方还有更广阔的领域等待探索。

### 1. 扩展阅读与进阶主题
- **对称性约束下的优化**：在处理复杂晶体时，保持空间群对称性至关重要。建议深入研究如何利用 Wyckoff 位置信息（参考资料 2）来简化优化路径并保持结构特征。
- **声子谱与热力学性质**：结构优化是计算声子谱的前提。你可以尝试将优化后的 `STRU` 文件用于声子动力学计算，甚至结合 ShengBTE 工具研究材料的晶格热导率（参考资料 3）。
- **过渡态搜索（NEB）**：如果你对化学反应路径或原子扩散感兴趣，可以利用第五章学到的 ASE 接口，调用 ABACUS 进行 nudged elastic band (NEB) 计算。

### 2. 通用调试建议 (Troubleshooting)
在实战中遇到计算不收敛或结果异常时，请按以下顺序排查：
- **检查 SCF 收敛性**：如果电子步不收敛，离子步的受力信息将毫无意义。尝试调整 `mixing_type` 或减小 `mixing_beta`。
- **验证 K 点与 Ecut**：受力（Force）和应力（Stress）对精度的要求通常高于总能量。请务必进行收敛性测试，确保 `ecutwfc` 和 K 点密度足够（参考资料 6）。
- **物理合理性检查**：观察输出的 `STRU` 文件，看原子是否“飞出”了晶胞，或者原子间距是否过近（通常意味着初始结构给得太差或受力过大）。

### 3. 官方资源
- **ABACUS 在线文档**：查阅最新的 `INPUT` 参数手册，获取更多关于 `press1/2/3` 等压力控制参数的细节。
- **Bohrium 案例库**：参考更多如锰元素磁性结构优化（参考资料 1）等特定元素的实战案例。

**保持好奇，勇于尝试，祝你在计算材料学的世界里发现更多可能！**
