# 第三章：进阶调试与难收敛体系处理

这是一个关于 ABACUS 软件进阶使用的专业章节。根据您的要求，我将结合计算材料学原理与 ABACUS 的具体实现，撰写这一章节。

---

# 第三章：进阶调试与难收敛体系处理

在上一章中，我们已经成功运行了标准的自洽计算（SCF）。然而，在实际科研中，我们经常会遇到“硬骨头”——电荷密度震荡不减、能量跳变或者收敛极慢。这通常发生在磁性体系、强关联体系、金属表面或者大间隙绝缘体中。

本章将深入 ABACUS 的 SCF 迭代核心，通过精细调控混合（Mixing）算法的历史维度、预处理机制以及多物理量协同混合策略，解决这些难收敛问题。

## 3.1 历史信息的利用与重置 (Dimension & Restart)

ABACUS 默认使用的 `broyden` 混合算法是一种基于“历史”的算法。它不仅利用当前步的输入输出差值，还会回溯过去 $N$ 步的信息，以预测下一步的最佳电荷密度。

### 3.1.1 历史维度：`mixing_ndim`

参数 `mixing_ndim` 决定了算法在内存中保存多少步的历史电荷密度信息。

*   **物理意义**：这就好比开车，`mixing_ndim` 决定了你能通过后视镜看到多远的过去。
    *   **默认值**：`8`。对于大多数简单体系（如 Si, Al）已经足够。
    *   **何时调整**：
        *   **震荡不收敛**：如果 SCF 误差（`drho`）在某个量级（如 1.0e-4）上下震荡，无法继续下降，说明当前的线性预测空间不足以描述复杂的势能面。此时应**增大** `mixing_ndim`（推荐尝试 12, 16, 甚至 20）。
        *   **内存受限**：保存历史步骤需要消耗内存。对于超大体系（数千原子），如果内存吃紧，可以适当**减小**此值，但一般不建议低于 4。

### 3.1.2 历史重置：`mixing_restart`

有时，历史信息反而是一种负担。如果在 SCF 初期，电荷密度发生剧烈变化，或者陷入了错误的局部极小值，早期的历史数据可能会“误导”当前的预测。

*   **策略**：通过 `mixing_restart` 参数，设定每隔多少步清除一次历史信息，强制算法重新构建 Jacobian 矩阵的近似。
*   **典型应用**：在某些极难收敛的磁性体系中，设置 `mixing_restart` 为 0.0 (不重置) 以外的值（例如在某些特定脚本控制下手动重启 SCF）或在计算流程中通过调整 `scf_nmax` 分段计算来间接实现。
    *   *注：在标准 INPUT 中，更常用的手段是当检测到收敛停滞时，停止计算，读取上一步的电荷密度（`init_chg file`）并略微改变混合参数重新开始，这本质上也是一种“保留优秀密度但重置混合历史”的策略。*

---

## 3.2 复杂泛函的特殊混合 (DFT+U & Meta-GGA)

标准的 SCF 混合仅针对**电荷密度（Charge Density, $\rho$）**。但对于某些高级泛函，哈密顿量不仅依赖于 $\rho$，还依赖于其他物理量。如果这些量不参与混合，SCF 就会因为变量不同步而震荡。

### 3.2.1 强关联体系：`mixing_dmr` (DFT+U)

在 DFT+U 计算中，Hubbard $U$ 项引入了对**轨道占据数（Occupation Matrix）**的依赖。

*   **现象**：总电荷密度 $\rho$ 似乎已经收敛，但总能量仍在跳动，或者磁矩在不同轨道间反复横跳。
*   **解决方案**：必须对密度矩阵（Density Matrix）进行混合。
*   **关键参数**：
    *   `mixing_dmr` (或相关布尔开关 `mixing_dftu`): 控制密度矩阵混合的开启与权重。
    *   **建议**：在进行 DFT+U 计算（特别是 f 电子体系或氧化物）时，务必关注此项。如果发现收敛困难，请确保开启了密度矩阵的混合功能。

### 3.2.2 Meta-GGA 体系：`mixing_tau`

Meta-GGA 泛函（如 SCAN, TPSS）依赖于**动能密度（Kinetic Energy Density, $\tau$）**。

*   **关键参数**：`mixing_tau`
*   **用法**：设置为 `1` (True) 开启。
*   **建议**：使用 SCAN 等泛函时，若不开启此选项，SCF 极难收敛。ABACUS 在检测到 Meta-GGA 泛函时通常会自动处理，但在手动调试时需确认此参数状态。

---

## 3.3 体系分类调试策略 (Critical Strategy)

这是本章的核心实战指南。不同物理性质的材料，其最佳混合策略截然不同。请根据你的体系类型，直接参考以下预设：

### 1. 原子与孤立分子 (Atoms & Molecules)
此类体系具有长程库伦作用，且没有费米面附近的屏蔽效应。
*   **核心策略**：**关闭 Kerker 预处理**。
*   **INPUT 推荐**：
    ```bash
    mixing_type     broyden
    mixing_beta     0.4     # 0.3 ~ 0.7 均可
    mixing_gg0      0.0     # 关键！必须设为 0，否则可能负优化
    mixing_ndim     8
    ```

### 2. 绝缘体与半导体 (Insulators & Semiconductors)
有带隙，屏蔽效应有限。
*   **核心策略**：标准参数通常即可，Kerker 预处理效果不明显，可关可不关。
*   **INPUT 推荐**：
    ```bash
    mixing_type     broyden
    mixing_beta     0.7     # 带隙越大，beta 可以越大（收敛越快）
    mixing_gg0      0.0     # 推荐关闭，或保持默认
    ```

### 3. 金属体系 (Metals)
存在费米面，长波（低频）电荷震荡极易导致发散（Charge Sloshing）。
*   **核心策略**：**必须开启 Kerker 预处理**，并降低 Beta。
*   **INPUT 推荐**：
    ```bash
    mixing_type     broyden
    mixing_beta     0.2     # 必须降低！推荐 0.1 ~ 0.3
    mixing_gg0      1.0     # 关键！开启 Kerker 抑制长程震荡
                            # 如果仍不收敛，可尝试增大至 1.5 或 2.0
    mixing_ndim     12      # 金属体系通常需要更多历史信息
    ```

### 4. 复杂磁性/强关联 (DFT+U / Magnetic)
*   **核心策略**：多物理量协同混合，保守迭代。
*   **INPUT 推荐**：
    ```bash
    mixing_type     broyden
    mixing_beta     0.1     # 非常保守的步长
    mixing_ndim     20      # 利用长程历史
    mixing_dmr      1       # (或 mixing_dftu) 开启密度矩阵混合
    scf_thr         1e-6    # 先用低精度收敛，读波函数后再提高精度
    ```

---

<!-- APPENDIX_START -->
## 附录：调试速查表与常见报错

### A.1 "如果不收敛怎么办" 流程图 (Text Version)

当你的 SCF 步数达到 `scf_nmax` 却仍未收敛（`drho` > `scf_thr`）时，请按以下顺序操作：

1.  **Step 1: 检查 `mixing_beta`**
    *   操作：将当前值减半（例如 0.7 -> 0.3）。
    *   原理：步子迈大了容易扯着蛋（震荡），减小步长能增加稳定性。

2.  **Step 2: 检查 `mixing_ndim`**
    *   操作：将当前值增加（例如 8 -> 12）。
    *   原理：利用更多历史数据来构建更准确的势能面。

3.  **Step 3: 体系诊断 (金属 check)**
    *   如果是金属或窄带隙体系：确认 `mixing_gg0 > 0` (推荐 1.0)。
    *   如果是分子/原子：确认 `mixing_gg0 = 0.0`。

4.  **Step 4: 复杂项检查**
    *   如果是 DFT+U：检查是否开启了密度矩阵混合 (`mixing_dmr` / `mixing_dftu`)。
    *   如果是 Meta-GGA：检查 `mixing_tau`。

5.  **Step 5: 终极手段**
    *   改用 `mixing_type pulay`（虽然通常 Broyden 更快，但有时换个算法有奇效）。
    *   检查结构是否合理（原子是否重叠？），这往往是 SCF 跑飞的物理根源。

### A.2 常见陷阱与风险提示

*   **能量大幅震荡（Positive Energy / NaN）**：
    *   通常不是混合参数的问题，而是结构问题（原子距离太近）或赝势截断能（`ecutwfc`）太低。
*   **Kerker 误用的后果**：
    *   在绝缘体中开启强 Kerker (`mixing_gg0` 很大) 会导致极低频的电荷密度无法更新，表现为 `drho` 看起来很小，但总能量收敛极慢甚至错误。
*   **收敛判据的差异 (`scf_thr`)**：
    *   **LCAO 基组**：默认 `scf_thr` 通常为 `1e-7`。
    *   **PW 基组**：默认 `scf_thr` 通常为 `1e-8`。
    *   *注意*：在对比不同基组结果或调试时，请留意这一数量级的差异。
*   **内存消耗**：
    *   `mixing_ndim` 与内存消耗呈线性关系。在几千个原子的大体系 LCAO 计算中，将 `mixing_ndim` 从 8 加到 20 可能会导致 OOM (Out of Memory)。

### A.3 混合参数默认值速查

| 参数名 | 类型 | 默认值 | 物理含义 |
| :--- | :--- | :--- | :--- |
| `mixing_type` | String | `broyden` | 混合算法 (broyden/pulay/plain) |
| `mixing_beta` | Real | 0.8 (nspin=1)<br>0.4 (nspin=2) | 混合步长 (0.0 ~ 1.0) |
| `mixing_ndim` | Int | 8 | 历史步数 |
| `mixing_gg0` | Real | 1.0 | Kerker 预处理强度 (0.0 为关闭) |
| `mixing_tau` | Bool | 0 (False) | 是否混合动能密度 (Meta-GGA) |