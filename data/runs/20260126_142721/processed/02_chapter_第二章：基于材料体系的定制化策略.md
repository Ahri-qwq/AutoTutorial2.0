# 第二章：基于材料体系的定制化策略

在第一性原理计算的实战中，“一套参数走天下”是最大的误区。ABACUS 作为一款兼具平面波（PW）和原子轨道（LCAO）基组的软件，其自洽场（SCF）收敛行为与材料的电子结构特征紧密相关。

本章是本教程的核心战术部分。我们将抛弃枯燥的参数列表，而是从**能隙（Band Gap）**、**金属丰度（Metallicity）**和**维度（Dimension）**三个维度出发，为你提供分门别类的参数预设策略。

---

## 2.1 宽带隙体系：绝缘体与半导体
**典型代表**：Si, SiO₂, NaCl, 大部分有机分子晶体

对于能隙大于 1 eV 的体系，电子在费米面附近的态密度（DOS）为零或极低。这意味着体系对电荷密度的微小扰动不敏感，不容易发生电荷在不同能级间的剧烈“震荡”。因此，我们可以采取**激进**的混合策略，以减少迭代步数。

### 核心策略
1.  **激进的混合因子 (`mixing_beta`)**：由于体系稳定，我们可以“大步快跑”。
2.  **关闭 Kerker 预处理 (`mixing_gg0`)**：宽带隙体系不需要抑制长波震荡，引入 Kerker 往往不仅无用，反而增加计算开销或导致收敛变慢。

### 推荐参数配置 (INPUT)
```bash
INPUT_PARAMETERS
# ... 其他参数 ...

# 电荷密度混合方法，推荐使用 Pulay 或 Broyden
mixing_type     pulay

# 混合因子 (0.0 ~ 1.0)
# 对于绝缘体/半导体，推荐 0.4 ~ 0.7
mixing_beta     0.7

# Kerker 预处理参数
# 对于非金属体系，必须设为 0 (无量纲)
mixing_gg0      0.0

# 混合历史步数，默认通常够用，难收敛时可调大
mixing_ndim     8
```

> **专家提示**：
> 在 ABACUS 中，`scf_thr`（自洽收敛判据）的默认值取决于基组选择。
> *   **PW 基组**：默认 `1.0e-8` Ry
> *   **LCAO 基组**：默认 `1.0e-7` Ry
> 在进行高精度计算（如声子谱、弹性常数）时，建议显式指定更严格的 `scf_thr`（如 `1.0e-9`）。

---

## 2.2 金属与窄带隙体系：Kerker 预处理的艺术
**典型代表**：Al, Cu, Fe, 石墨烯, 拓扑绝缘体

金属体系的费米面穿过能带，导致费米能级附近存在大量的电子态。在 SCF 迭代初期，输入电势的微小变化会导致电子在费米面附近剧烈重排，产生所谓的**电荷震荡（Charge Sloshing）**。这种震荡在倒空间的长波极限（$G \to 0$）尤为严重，表现为计算迟迟不收敛，能量在两个数值间跳动。

### 核心策略：Kerker Scaling
为了抑制这种震荡，我们需要引入 **Kerker 预处理**。它的物理本质是在倒空间对混合残差进行加权：抑制长波（小 $G$ 矢量）部分的混合，而保留短波（大 $G$ 矢量）部分。

在 ABACUS 中，这一机制通过 `mixing_gg0` 控制。同时，为了配合 Kerker 机制，我们需要显著降低 `mixing_beta`，采用“小步慢跑”的策略。

### 推荐参数配置 (INPUT)
```bash
INPUT_PARAMETERS
# ... 其他参数 ...

mixing_type     pulay

# 混合因子：金属体系必须调小！
# 推荐范围 0.1 ~ 0.3
mixing_beta     0.2

# Kerker 预处理参数 (单位：bohr^-2 左右的量级，具体视实现而定)
# 开启 Kerker 模式，推荐从 1.0 或 1.5 开始尝试
mixing_gg0      1.0  

# 增加历史步数有助于金属体系捕捉复杂的震荡模式
mixing_ndim     10
```

> **实战经验**：
> `mixing_gg0` 没有绝对的“标准值”。如果你发现 SCF 震荡依然剧烈，可以尝试增大该值（如 1.5 或 2.0）；如果收敛极其缓慢但不再震荡，可以适当减小该值或略微增大 `mixing_beta`。

---

## 2.3 孤立体系：原子与分子的特殊陷阱
**典型代表**：孤立的 O 原子, H₂O 分子, 团簇

这是一个新手常犯的错误区域。很多用户在计算孤立原子（特别是过渡金属原子）时，因为看到它们有未填满的电子壳层，就下意识地套用“金属”的参数设置。

**这是错误的。**

### 核心逻辑
孤立体系通常被置于巨大的真空层中。Kerker 预处理的核心是抑制 $G \to 0$ 的电荷变动，而对于孤立体系，长程的静电势变化（对应小 $G$）是物理上真实且必要的。在这些体系中开启 Kerker (`mixing_gg0 > 0`) 往往会导致“负优化”，使电荷密度无法正确弛豫到真空边界，导致收敛停滞。

### 推荐参数配置 (INPUT)
```bash
INPUT_PARAMETERS
# ... 其他参数 ...

# 绝对不要在孤立体系中使用 Kerker
mixing_gg0      0.0

# Beta 值视具体分子的 HOMO-LUMO 间隙而定
# 绝缘分子可设 0.5，开壳层原子/自由基可设 0.2-0.3
mixing_beta     0.5
```

---

## 2.4 强关联体系：DFT+U 与杂化泛函
**典型代表**：过渡金属氧化物 (NiO, CoO), 稀土化合物

当引入 Hubbard U (DFT+U) 或使用杂化泛函（如 HSE06）时，SCF 循环不仅要优化电荷密度，还要优化**密度矩阵（Density Matrix）**或相关的占据数。这引入了额外的非线性。

### 核心策略
除了常规的电荷密度混合，ABACUS 允许对密度矩阵的残差进行控制。对于难以收敛的 +U 计算，以下参数至关重要。

### 关键参数说明
*   **`mixing_dmr`**: 是否对密度矩阵进行混合及加速。在 DFT+U 计算难收敛时，确保此功能处于激活状态或调整相关权重（具体参数名及默认行为请参考最新版官方文档，通常 +U 计算会自动处理，但需留意日志中的 mixing 行为）。
*   **`mixing_restart`**: 如果迭代陷入死循环，定期重置混合历史有时能跳出局部陷阱。

---

## 2.5 总结：如果不收敛怎么办？（实战流程图）

当你在屏幕前看着 `E_Fermi` 或 `dEtot` 上下乱跳时，请按照以下“急救流程”操作：

```mermaid
graph TD
    A[SCF 不收敛] --> B{体系类型?};
    
    B -- 绝缘体/半导体 --> C[检查 mixing_beta];
    C --> C1[减小 beta (如 0.7 -> 0.3)];
    C1 --> D[检查 mixing_ndim];
    
    B -- 金属/窄带隙 --> E[检查 mixing_gg0];
    E --> E1{是否已开启 Kerker?};
    E1 -- No --> E2[设置 mixing_gg0 = 1.0];
    E1 -- Yes --> E3[增大 mixing_gg0 或 减小 beta];
    E3 --> D;
    
    B -- 孤立原子/分子 --> F[确认 mixing_gg0 = 0.0];
    F --> C1;
    
    D --> D1[增大 ndim (如 8 -> 12)];
    D1 --> G{是否为 DFT+U?};
    
    G -- Yes --> H[检查 mixing_dmr / 增加 U 值合理性测试];
    G -- No --> I[检查结构合理性 / Smearing 设置];
```

### 文字版调试速查表

1.  **第一招：降速 (`mixing_beta`)**
    *   无论什么体系，减小 `mixing_beta` 总是最安全的尝试。从 0.7 降到 0.3，甚至 0.1。代价是步数增加，但总比不收敛好。

2.  **第二招：增加记忆 (`mixing_ndim`)**
    *   将 `mixing_ndim` 从默认值增加到 12 或 15。这让算法利用更多的历史信息来预测下一步，对于复杂的电荷震荡（如自旋螺旋体系）非常有效。

3.  **第三招：调节 Kerker (`mixing_gg0`)**
    *   **仅限金属**。如果震荡剧烈，尝试增大 `mixing_gg0` (1.0 -> 1.5)。
    *   **切记**：绝缘体和分子必须保持为 0.0。

4.  **第四招：检查电子温度 (`smearing`)**
    *   (将在后续章节详细讲解) 对于金属，适当提高 `smearing_sigma` (如 0.01 Ry -> 0.02 Ry) 可以平滑费米面附近的占据数分布，显著改善收敛性。

通过本章的策略，你应该能够为 90% 的材料计算任务配置出合理的初始参数。下一章，我们将深入探讨基组的选择——平面波与原子轨道的终极对决。