# ABACUS 计算材料学实战：从物理基础到自动化收敛测试

## 前言

欢迎开启 ABACUS 的学习之旅。作为由中国科研团队主导开发的国产开源密度泛函理论（DFT）软件，ABACUS 凭借其独特的数值原子轨道（LCAO）与平面波（PW）双基组优势，在处理大规模体系计算和保持高精度模拟方面展现了卓越的性能。然而，正如书中所强调的，“跑通”不等于“正确”。对于初学者而言，如何从繁杂的参数中抽丝剥茧，建立起稳健的计算工作流，是通往科研进阶的必经之路。

**学习路线图**
本教程旨在通过一个闭环的实战案例，带你掌握 DFT 计算的核心逻辑：
1. **物理领悟**：第一章回归物理本质，探讨 K 点采样与数值收敛的底层逻辑。
2. **参数构建**：第二章深入解析 `INPUT` 与 `KPT` 文件，夯实“输入质量决定输出质量”的意识。
3. **效率进阶**：第三章引入 Shell 脚本，演示如何利用自动化手段摆脱低效的手动重复。
4. **科学判据**：第四章教你如何从海量原始数据中提取能量曲线，并建立严谨的收敛标准。
5. **专家策略**：第五章针对大体系与特殊场景，提供 Gamma-only 等进阶优化方案。

**知识体系定位**
在整个 DFT 计算知识图谱中，本教程聚焦于“数值收敛性测试”这一支柱。收敛性测试是所有定量计算的基石，它与平面波截断能（`ecutwfc`）测试、伪势选择以及基组优化共同构成了计算可靠性的保障。掌握了本书中的 K 点测试方法，你将能举一反三，轻松应对 ABACUS 的其他核心参数优化。

**前置要求**
在开始之前，我们假设你已经具备了基础的 Linux 命令行操作能力，并对固体物理（如布里渊区、倒空间）有初步的了解。让我们开始吧，在数字世界中还原物质的真实面貌。

---

# 第一章：物理基础与收敛性原理

欢迎来到 ABACUS 实战教程的第一章。在真正开始敲击键盘运行计算之前，我们需要先建立正确的物理图像。

很多初学者容易陷入一个误区：拿到软件直接运行，只要不报错就算成功。但在计算材料学中，**“跑通”不等于“正确”**。密度泛函理论（DFT）计算是一个数值近似的过程，我们需要通过调整一系列参数，在“计算精度”和“计算成本”之间找到最佳平衡点。

本章将聚焦于 DFT 计算中最基础的两个数值参数之一：**K 点（K-points）**（另一个是平面波截断能 `ecutwfc`，将在后续章节讨论）。我们将解释为何需要采样 K 点，以及如何科学地测试其收敛性。

---

## 1.1 布里渊区采样 (Brillouin Zone Sampling)

### 物理图像：从连续到离散

在固体物理中，晶体具有周期性结构。根据**布洛赫定理（Bloch's Theorem）**，晶体中的电子波函数可以写成一个调幅平面波。为了计算体系的总能量、电荷密度等物理量，我们需要对倒空间（Reciprocal Space）的第一布里渊区（First Brillouin Zone）进行积分。

理论上，这个积分应该是连续的。但在计算机中，我们无法处理连续积分，必须将其离散化。这就好比我们在计算定积分 $\int f(x) dx$ 时，将其近似为一系列矩形面积的求和 $\sum f(x_i) \Delta x$。

*   **K 点（K-points）**：就是我们在倒空间中选取的这些离散采样点。
*   **K 点网格（K-mesh）**：这些点在布里渊区排列成的网格。

**核心结论**：采样点越密（K 点越多），离散求和就越接近连续积分的真实值，计算结果越精确，但计算量也越大。

### ABACUS 中的 K 点设置 (`KPT` 文件)

在 ABACUS 中，K 点的设置独立于 `INPUT` 文件，通常存储在一个名为 `KPT` 的文件中。对于自洽场（SCF）计算和结构弛豫，我们通常使用均匀网格。

以下是一个标准的 `KPT` 文件示例：

**文件名：KPT**
```text
K_POINTS
0
Gamma
4 4 4 0 0 0
```

**参数详解**：

1.  **第一行 (`K_POINTS`)**: 关键词，标识文件类型。
2.  **第二行 (`0`)**: K 点总数。
    *   设置为 `0` 表示让 ABACUS 根据后续参数自动生成网格（推荐）。
    *   若设置为具体数字，则需要手动列出每个 K 点的坐标和权重（仅在特定高级需求下使用）。
3.  **第三行 (`Gamma`)**: 网格生成模式。
    *   `Gamma`: 生成 **Gamma-centered Monkhorst-Pack** 网格。即网格包含原点 $\Gamma(0, 0, 0)$ 点。这是最常用的模式，特别是对于六角晶系（Hexagonal）建议强制使用。
    *   `MP`: 标准 Monkhorst-Pack 网格，可能会根据网格奇偶性发生位移，不一定包含 Gamma 点。
4.  **第四行 (`4 4 4 0 0 0`)**: 网格密度与偏移。
    *   前三个数 `4 4 4`：分别对应倒空间三个基矢量方向上的分割份数（$N_x, N_y, N_z$）。
    *   后三个数 `0 0 0`：网格在三个方向上的偏移量（Shift）。通常设为 0。

---

## 1.2 数值收敛与计算成本的权衡

### 什么是“数值收敛”？

在计算材料学中，“收敛”通常指：**随着某个数值参数精度提高（如 K 点网格加密），计算得到的物理量（如总能量）趋于一个稳定值。**

我们需要明确一个观念：我们追求的不是“绝对真值”（那是实验的事），而是“数值稳定值”。

### 核心矛盾：精度 vs. 成本

*   **精度**：K 点网格越密（如从 $2\times2\times2$ 增加到 $8\times8\times8$），总能量越准确。
*   **成本**：计算时间与 K 点数量大致成线性关系（$O(N_k)$）。

我们的目标是找到**性价比最高的点**：即 K 点增加带来的能量变化已经小于我们可以容忍的误差范围，此时的网格密度就是我们的“收敛标准”。

### 实战操作：K 点收敛性测试 (Convergence Test)

这是任何高质量计算的第一步。我们将采用**控制变量法**。

#### 1. 准备工作
固定其他所有参数，特别是平面波截断能 `ecutwfc`。建议先设置一个相对安全的值（例如 60-100 Ry，取决于赝势建议值）。

**文件名：INPUT** (基础模板)
```text
INPUT_PARAMETERS
suffix          k_test
calculation     scf         # 进行自洽计算
basis_type      pw          # 使用平面波基组
ecutwfc         100         # 固定截断能，控制变量
scf_thr         1e-6        # 自洽收敛精度
symmetry        1           # 开启对称性分析（加速计算）
ntype           1
pseudo_dir      ./
orbital_dir     ./
```
*(注：请确保目录下有对应的 `STRU` 文件和赝势文件)*

#### 2. 迭代测试
依次修改 `KPT` 文件中的网格密度，运行计算并记录总能量。

*   **Step 1**: `KPT` 设置为 `2 2 2 0 0 0` $\rightarrow$ 运行 $\rightarrow$ 记录 `Total Energy`。
*   **Step 2**: `KPT` 设置为 `3 3 3 0 0 0` $\rightarrow$ 运行 $\rightarrow$ 记录 `Total Energy`。
*   **Step 3**: `KPT` 设置为 `4 4 4 0 0 0` $\rightarrow$ ...
*   ...以此类推。

#### 3. 判据标准 (Critical)
如何判断收敛？学术界通用的经验判据是：
> **当 K 点网格密度增加导致的总能量变化 $\Delta E$ 小于 1 meV/atom 时，即可认为收敛。**

*注意：是每个原子的能量变化，不是整个体系的总能量变化。*

#### 4. 结果可视化 (强烈推荐)
建议将测试结果绘制成曲线图，这是科研记录的好习惯。
*   **横坐标**: K 点网格密度 (2, 3, 4, 5...)
*   **纵坐标**: 总能量 (eV)

典型的收敛曲线会呈现**阻尼振荡**或**单调趋近**的形式，最终拉成一条水平线。一旦曲线进入“平台期”，平台开始处的 K 点密度即为最佳选择。

---

## 1.3 专家锦囊 (Tips & Tricks)

在实际项目中，我们不需要每次都盲目地从 $1\times1\times1$ 测到 $20\times20\times20$。以下经验法则可以帮你快速定位：

### 1. 扩胞经验法则 ($1/n$ Rule)
K 点采样的本质是覆盖倒空间。倒空间的大小与实空间晶胞大小成反比 ($V_{rec} \propto 1/V_{real}$)。
*   如果你有一个单胞，测试发现需要 $12\times12\times12$ 的 K 点。
*   当你建立一个 $2\times2\times2$ 的超胞（Supercell）时，实空间体积扩大了 8 倍，倒空间体积缩小为原来的 1/8。
*   此时，你的 K 点网格只需要 $6\times6\times6$ 即可达到相同的采样精度。

**公式**：$N_{new} \approx N_{old} \times \frac{L_{old}}{L_{new}}$

### 2. Gamma Only 模式
对于非常大的体系（如包含数百个原子的超胞、非周期性的分子/团簇计算），倒空间非常小，往往只需要一个 K 点——即原点 $\Gamma (0, 0, 0)$。
ABACUS 针对这种情况提供了专门的加速算法。
*   **启用方法**: 在 `INPUT` 文件中设置 `gamma_only 1`。
*   **效果**: 计算速度显著提升，内存消耗降低。
*   **注意**: 此时 `KPT` 文件仍需存在，内容应设为 Gamma 点单点采样。

### 3. 风险提示：能带计算
本章讨论的 K 点采样仅针对 **SCF（自洽场）计算**和**结构优化**，目的是获取准确的基态电子密度。
如果你需要计算**能带结构（Band Structure）**，`KPT` 文件的写法完全不同（需要使用 Line Mode 选取高对称路径）。请务必查阅 ABACUS 官方文档中关于 `KPT` 路径生成的说明，切勿直接套用 VASP 的 KPOINTS 格式，两者的 Line Mode 定义方式存在差异。

---

**下一章预告**：
搞定了 K 点，我们将在第二章攻克另一个核心参数——**平面波截断能 (`ecutwfc`)**，并正式开始我们的第一个结构优化任务。

# 第二章：输入参数配置详解

在上一章中，我们完成了 ABACUS 的环境搭建与基本运行测试。俗话说“Garbage in, garbage out”，输入文件的质量直接决定了计算结果的物理意义。

本章我们将聚焦于 DFT 计算中最基础的收敛性测试——**K 点收敛测试**。我们将深入剖析控制 K 点网格的 `KPT` 文件，并构建一个用于测试的标准化 `INPUT` 文件。

---

## 2.1 KPT 文件结构剖析

在周期性体系计算中，布里渊区（Brillouin Zone）的积分精度由 K 点网格密度决定。ABACUS 使用 `KPT` 文件来定义这一网格。

对于自洽场（SCF）计算和结构弛豫，我们通常使用**自动生成网格**模式。以下是一个标准的 `KPT` 文件示例：

**文件名：KPT**
```text
K_POINTS         # Line 1: 文件的标签/注释（通常写 K_POINTS）
0                # Line 2: K点总数。设为 0 表示自动生成网格
Gamma            # Line 3: 网格生成模式（Gamma 或 MP）
4 4 4 0 0 0      # Line 4: nx, ny, nz 以及三个方向的漂移量
```

### 逐行详解

1.  **Line 1: 标签行**
    *   这是一个注释行，ABACUS 读取时会忽略，但建议保留 `K_POINTS` 字样以保持文件可读性。

2.  **Line 2: K 点总数**
    *   **设置为 0**：这是最常用的设置。它告诉程序根据 Line 3 和 Line 4 的规则自动生成 Monkhorst-Pack 网格。
    *   **设置为具体整数**：如果你需要手动指定每一个 K 点的坐标和权重（例如在某些特殊的能带计算或杂化泛函计算中），这里填 K 点的具体数量。但在本章的 SCF 测试中，请务必设为 `0`。

3.  **Line 3: 网格生成模式**
    *   **Gamma**: 以 Gamma 点（0, 0, 0）为中心的网格。生成的网格包含 Gamma 点。
    *   **MP (Monkhorst-Pack)**: 经典的 MP 网格生成方法。生成的网格**不一定**包含 Gamma 点。
    *   **实战建议**: 对于六角晶系（Hexagonal）结构，通常推荐使用 `Gamma` Center 网格以保持对称性；对于正交或立方晶系，`MP` 往往效率更高。如果不确定，使用 `Gamma` 是较安全的保底选择。

4.  **Line 4: 网格密度与漂移**
    *   格式：`nx ny nz shift_x shift_y shift_z`
    *   `nx ny nz`: 在倒空间三个基矢量方向上的划分份数。整数越大，网格越密，计算越准，但耗时呈立方级增长。
    *   `shift_x/y/z`: 网格原点的漂移量（通常为 0 或 0.5）。
    *   **注意**: 在常规的 SCF 计算中，后三位通常设为 `0 0 0`。

> **风险提示**: `KPT` 文件还支持用于能带计算的 `Line mode`，但其格式与 VASP 的 KPOINTS 不同。在进行能带计算（非 SCF 收敛测试）时，请务必查阅 ABACUS 官方文档，切勿直接套用其他软件的格式经验。

---

## 2.2 INPUT 文件与控制变量策略

`INPUT` 文件是 ABACUS 的总控中心。在进行 K 点收敛测试时，必须严格遵守**控制变量法**：即除了 K 点密度外，其他所有参数（尤其是截断能）必须保持固定。

以下是一个用于 K 点测试的标准化 `INPUT` 模板：

**文件名：INPUT**
```bash
INPUT_PARAMETERS

# 1. 计算模式控制
calculation     scf         # 进行自洽场计算
basis_type      lcao        # 基组类型：lcao (原子轨道) 或 pw (平面波)
                            # 注意：K点测试逻辑对两种基组通用

# 2. 精度控制（控制变量的核心）
ecutwfc         100         # [重要] 平面波截断能 (Ry)。
                            # 在测试 K 点时，ecutwfc 必须固定且足够大（如 100 Ry），
                            # 以消除截断能不足带来的误差干扰。
scf_thr         1.0e-7      # 自洽迭代收敛判据 (eV)，建议设为 1e-6 或 1e-7

# 3. 电子步迭代控制
scf_nmax        100         # 最大电子迭代步数
smearing_method gaussian    # 展宽方法：gaussian (绝缘体/半导体) 或 mp (金属)
smearing_sigma  0.01        # 展宽宽度 (Ry)

# 4. 体系信息（部分信息可能需从 STRU 读取，视版本而定）
# nspin         1           # 自旋极化：1(非磁), 2(自旋极化)
```

### 关键参数解析

*   **`calculation`**: 设置为 `scf`。我们只需要得到体系的总能量，不需要进行结构弛豫（`relax`）或分子动力学（`md`）。
*   **`ecutwfc`**: 这是一个极易被初学者混淆的点。
    *   **误区**: 一边测 K 点，一边改 `ecutwfc`。
    *   **正解**: 选定一个较高的 `ecutwfc`（例如 100 Ry 或根据赝势推荐值的 1.5 倍），在整个 K 点测试过程中保持不变。只有这样，总能量的变化才完全归因于 K 点网格的改变。
*   **`basis_type`**: ABACUS 支持 LCAO（数值原子轨道）和 PW（平面波）。虽然 LCAO 效率极高，但在进行高精度基准测试时，K 点收敛规律在两种基组下是一致的。

---

## 2.3 实战：执行收敛测试

### 收敛判据
在计算材料学中，我们无法追求“绝对真值”，只能追求“收敛值”。
**黄金标准**: 当 K 点网格密度增加（例如从 2x2x2 变为 3x3x3），体系的**总能量变化小于 1 meV/atom** 时，我们认为该 K 点网格已满足计算精度要求。

$$ |E_{total}(N) - E_{total}(N-1)| < 1 \text{ meV} \times N_{atoms} $$

### 操作步骤
1.  **准备**: 准备好 `STRU`（结构文件）、`INPUT`（固定参数）和赝势/轨道文件。
2.  **迭代**:
    *   修改 `KPT` 文件 Line 4 为 `2 2 2 0 0 0`，运行 ABACUS，记录总能量。
    *   修改 `KPT` 文件 Line 4 为 `3 3 3 0 0 0`，运行 ABACUS，记录总能量。
    *   修改 `KPT` 文件 Line 4 为 `4 4 4 0 0 0`，...
3.  **分析**: 计算相邻两次计算的能量差。

---

## 2.4 专家锦囊（Pro Tips）

### 1. 可视化建议：绘制收敛曲线
强烈建议将测试结果绘制成图表，而不是只看枯燥的数字。
*   **横坐标**: K 点网格密度（如 2, 3, 4, 5...）
*   **纵坐标**: 体系总能量（Total Energy, eV）
*   **观察**: 曲线通常会呈现阻尼振荡或单调趋近的形式。找到曲线开始“变平”的那个拐点，即为最佳 K 点设置。

### 2. 扩胞后的 K 点缩减法则（$1/n$ Rule）
这是一个非常实用的经验法则，能帮你节省大量测试时间：
> **如果晶胞在某个方向上扩大了 $n$ 倍（即构建了超胞），那么该方向上的 K 点密度可以相应减少为原来的 $1/n$。**

**例子**:
*   原胞（Unit Cell）收敛的 K 点网格是 `12 12 12`。
*   如果你构建了一个 `2 2 2` 的超胞（Supercell，体积是原来的 8 倍）。
*   那么超胞的 K 点网格只需设置 `6 6 6` 即可达到相同的精度。

### 3. 进阶技巧：`gamma_only`
对于非常大的体系（例如超过 200 个原子的超胞或无序体系），布里渊区非常小，往往只需要 Gamma 点（1 1 1）即可。
此时，可以在 `INPUT` 文件中添加参数：
```bash
gamma_only      1
```
开启此参数后，ABACUS 会利用 Gamma 点波函数的实数性质进行特殊优化，计算速度可提升约 2 倍，内存消耗减半。**注意：这仅适用于 K 点确认为 1x1x1 的情况。**

---

下一章，我们将深入探讨另一个核心收敛参数——**截断能（ecutwfc）** 的配置与测试策略。

# 第三章：自动化测试流程实战

在前两章中，我们已经成功编译了 ABACUS 并手动完成了一次简单的自洽计算（SCF）。但在实际科研中，手动修改参数、提交任务、记录数据的过程不仅枯燥，而且极易出错。

本章将带你进入**计算材料学的“工业化”时代**。我们将编写 Shell 脚本，构建一个“修改-运行-提取”的自动化闭环。我们将以**K 点收敛性测试**为例，演示如何通过脚本一键完成从参数扫描到数据汇总的全过程。

---

## 3.1 编写自动化批处理脚本

在进行收敛性测试时，我们需要控制变量。对于 K 点测试，原则是：**固定截断能（`ecutwfc`）和其他参数，仅改变 K 点网格密度**。

### 3.1.1 准备工作目录
首先，建立一个干净的测试目录，并准备好基础文件：
- `STRU`：结构文件（如硅或铝）。
- `INPUT`：输入参数文件。
- `KPT`：我们将用脚本动态生成此文件，初始可以不存在。
- 赝势文件（`.upf` 或 `.orb` 等）。

**关键设置**：
在 `INPUT` 文件中，我们通常设置一个 `suffix` 参数。
- **参数名**: `suffix`
- **作用**: 指定输出目录的后缀。例如设置 `suffix Si_test`，输出文件夹将命名为 `OUT.Si_test`。
- **自动化意义**: 在批量计算中，我们需要动态修改这个参数，防止后一个任务的结果覆盖前一个任务。

### 3.1.2 编写 Shell 脚本 (`auto_test_kpt.sh`)

我们将使用 Linux 系统中最常用的 Shell 脚本配合 `sed` 命令来实现自动化。请在测试目录下创建名为 `auto_test_kpt.sh` 的文件，并写入以下内容：

```bash
#!/bin/bash

# 1. 定义要测试的 K 点网格密度列表
# 这里我们测试从 2x2x2 到 8x8x8
k_values="2 3 4 5 6 7 8"

# 2. 清理旧的数据文件 (可选)
rm -f energy_convergence.dat

# 3. 开始循环
for k in $k_values
do
    echo "Testing K-point grid: $k x $k x $k"

    # --- 步骤 A: 动态生成 KPT 文件 ---
    # ABACUS 的 KPT 格式通常如下：
    # K_POINTS
    # 0
    # Gamma
    # n n n 0 0 0
    # 我们使用 cat 命令直接重写 KPT 文件
    cat > KPT <<EOF
K_POINTS
0
Gamma
$k $k $k 0 0 0
EOF

    # --- 步骤 B: 动态修改 INPUT 文件中的 suffix ---
    # 使用 sed 命令找到以 'suffix' 开头的行，并将其替换为新的后缀
    # 这样输出目录会变为 OUT.Si_k2, OUT.Si_k3 等
    sed -i "s/^suffix.*/suffix Si_k${k}/" INPUT

    # --- 步骤 C: 运行计算 ---
    # 假设使用 mpirun 进行 4 核并行计算
    # 将标准输出重定向到 log 文件中，方便后续提取
    mpirun -np 4 abacus > running_k${k}.log

    # --- 步骤 D: 提取数据 ---
    # 从日志文件中筛选包含 "final etot" 的行
    # awk '{print $4}' 表示提取该行的第 4 列数据（即能量值）
    # 注意：根据 ABACUS 版本不同，能量可能在不同列，请先手动检查一次 log 确认位置
    energy=$(grep "final etot" running_k${k}.log | awk '{print $4}')

    # 将 K 点密度和对应的能量写入汇总文件
    echo "$k $energy" >> energy_convergence.dat
done

echo "All calculations finished. Results saved in energy_convergence.dat"
```

### 3.1.3 脚本核心解析
1.  **`cat > KPT <<EOF ... EOF`**: 这是一个非常实用的“Here Document”写法，它允许我们在脚本中直接“画”出文件的内容。每次循环，$k 的值都会改变，从而生成新的 `KPT` 文件。
2.  **`sed -i ...`**: `sed` 是流编辑器。`"s/^suffix.*/suffix Si_k${k}/"` 的意思是：查找所有以 `suffix` 开头的行（`^`表示行首），将其替换为 `suffix Si_k2`（当 k=2 时）。这是防止结果覆盖的**关键操作**。

---

## 3.2 运行计算与数据分析

### 3.2.1 执行脚本
赋予脚本执行权限并运行：
```bash
chmod +x auto_test_kpt.sh
./auto_test_kpt.sh
```

此时，终端会依次打印正在计算的 K 点信息。计算完成后，目录下会出现一系列日志文件（`running_k2.log`, `running_k3.log`...）和输出文件夹（`OUT.Si_k2`, `OUT.Si_k3`...）。

### 3.2.2 结果分析与收敛判据
查看生成的汇总文件 `energy_convergence.dat`：
```bash
cat energy_convergence.dat
```
输出示例（假设值）：
```text
2 -215.12345678
3 -215.45678901
4 -215.48901234
5 -215.49012345
6 -215.49045678
7 -215.49051234
8 -215.49052345
```

**Critical: 收敛判据**
如何判断 K 点是否取够了？
1.  **能量差标准**: 计算相邻两个 K 点网格的总能量差值 $\Delta E = E_{n} - E_{n-1}$。
2.  **归一化**: 将能量差除以体系中的原子数。
3.  **阈值**: 当能量变化小于 **1 meV/atom** (即 $0.001 \text{ eV/atom}$) 时，通常认为计算已经收敛。

在上述示例中，从 5x5x5 到 6x6x6，能量变化极小（约 0.3 meV），因此对于该体系，选取 5x5x5 或 6x6x6 作为后续计算参数是合理的。

### 3.2.3 锦囊妙计：可视化建议
强烈建议不要只看数字。将 `energy_convergence.dat` 导入绘图软件（如 Gnuplot, Python Matplotlib 或 Origin）。
- **横坐标**: K-point Grid Density (2, 3, 4...)
- **纵坐标**: Total Energy (eV)
绘制 **"Total Energy vs. K-point Grid"** 曲线图。你会看到一条能量迅速下降（或上升）并最终趋于平坦的曲线。这种可视化的直觉对于判断收敛性至关重要。

---

## 3.3 进阶技巧与风险提示

### Pro Tip 1: 扩胞后的 K 点缩减法则
很多初学者在做完单胞（Unit Cell）测试后，转去做超胞（Supercell）计算时，往往不知道如何设置 K 点。
**经验法则**: K 点网格密度与晶胞尺寸成**反比**。
> 如果你的晶胞在 x 方向扩大了 $n$ 倍（例如建立了一个 $2 \times 1 \times 1$ 的超胞），那么你在 x 方向的 K 点数目可以减少为原来的 $1/n$。
> **例子**: 单胞收敛 K 点为 $8 \times 8 \times 8$。建立 $2 \times 2 \times 2$ 超胞后，K 点只需设为 $4 \times 4 \times 4$ 即可保持同等的计算精度。

### Pro Tip 2: Gamma Only 模式
对于非常大的体系（例如超过 200 个原子），或者非周期性体系（如团簇、分子），布里渊区非常小，通常只需要计算 $\Gamma$ 点（0 0 0）。
ABACUS 针对这种情况有专门的优化参数。
- 在 `INPUT` 文件中设置：
  ```text
  gamma_only 1
  ```
- 此时 `KPT` 文件应明确写为：
  ```text
  K_POINTS
  1
  Direct
  0 0 0 1
  ```
开启 `gamma_only` 可以利用实数空间的算法显著降低内存消耗并提升计算速度。

### Risk Warning: KPT 文件的 Line Mode
本章主要讨论的是自洽计算（SCF）用的均匀 K 点网格。如果你在进行能带结构（Band Structure）计算，`KPT` 文件的格式会完全不同（通常称为 Line Mode）。
- **切勿模仿 VASP**: ABACUS 的能带路径格式与 VASP 的 `KPOINTS` 不同。
- **查阅文档**: 请务必查阅 ABACUS 官方文档中关于 `KPT` 格式的说明，不要凭直觉瞎编格式，否则程序可能会报错或计算出错误的能带路径。

---

通过本章的实战，你不仅掌握了 K 点测试的方法，更重要的是掌握了**Shell 脚本自动化**这一核心技能。在后续的截断能（Ecut）测试、晶格常数优化等任务中，你只需微调上述脚本即可轻松应对。

# 第四章：结果分析与收敛判据

在上一章中，我们已经完成了不同 K 点网格密度下的批量计算。获得数据只是第一步，如何从这些数据中提取出科学的结论，并据此确定后续计算的参数，才是体现“计算材料学直觉”的关键环节。

本章将带你完成从“数据提取”到“收敛性判断”的完整流程，并建立一套标准化的判据体系。

---

## 4.1 可视化分析 (Total Energy vs. K-grid)

人类的大脑对图像的敏感度远高于数字。在确定最优 K 点网格时，最直观的方法是绘制 **“总能量 vs. K点网格密度”** 的收敛曲线。

### 4.1.1 数据提取
首先，我们需要从 ABACUS 的输出文件中提取总能量。在 SCF 计算结束后，ABACUS 会在日志文件（通常输出在屏幕或重定向到文件中，如 `running_scf.log`）或输出目录（`OUT.suffix/running_scf.log`）中打印最终能量。

关键词通常是 `Final Etot`。你可以使用以下 Shell 命令快速查看所有测试文件夹下的能量数据（假设你的文件夹命名为 `K_2`, `K_3` 等）：

```bash
# 批量提取能量数据的命令示例
grep "Final Etot" K_*/OUT.*/running_scf.log
```

输出示例：
```text
K_2/OUT.ABACUS/running_scf.log: Final Etot = -256.12345678 eV
K_3/OUT.ABACUS/running_scf.log: Final Etot = -258.45678901 eV
K_4/OUT.ABACUS/running_scf.log: Final Etot = -258.49876543 eV
K_5/OUT.ABACUS/running_scf.log: Final Etot = -258.50012345 eV
K_6/OUT.ABACUS/running_scf.log: Final Etot = -258.50023456 eV
```

### 4.1.2 绘制收敛曲线
建议使用 Python (Matplotlib)、Gnuplot 或 Origin 绘制曲线：
- **横坐标 (X-axis)**: K 点网格的密度参数（例如 2, 3, 4, 5... 代表 2x2x2, 3x3x3...）。
- **纵坐标 (Y-axis)**: 体系的总能量 (Total Energy, eV)。

**曲线特征分析**：
1.  **剧烈变化区**：在 K 点较少时（如 1x1x1 到 3x3x3），能量通常会发生剧烈跳变。这是因为稀疏的 K 点无法正确积分布里渊区，此时的结果是物理上不可靠的。
2.  **震荡/趋平区**：随着 K 点增加，能量变化幅度逐渐减小。曲线可能呈现单调下降/上升，也可能在某个值附近微小震荡。
3.  **平台区**：当 K 点足够密时，能量几乎不再变化，曲线进入“平台期”。

> **注意**：在进行 K 点测试时，必须严格遵守**控制变量法**。确保 `INPUT` 文件中的平面波截断能 `ecutwfc`（例如固定为 100 Ry）和其他参数保持不变，仅改变 `KPT` 文件。

---

## 4.2 确定最优 K 点网格

“收敛”在数值计算中是一个相对概念。我们追求的是在**计算精度**和**计算成本**之间找到最佳平衡点。

### 4.2.1 量化收敛标准 (The 1 meV Criterion)
学术界通用的收敛判据如下：

**当 K 点网格密度增加（例如从 NxNxN 增加到 (N+1)x(N+1)x(N+1)）时，如果体系总能量的变化 $\Delta E$ 满足以下条件，即可认为收敛：**

$$ \frac{|\Delta E|}{N_{atoms}} < 1 \text{ meV/atom} $$

其中：
- $\Delta E$ 是两次计算的总能量差值。
- $N_{atoms}$ 是晶胞中的原子总数。
- $1 \text{ meV} = 0.001 \text{ eV}$。

**实战演练**：
假设体系包含 2 个原子：
- **3x3x3 网格**: $E = -258.4568$ eV
- **4x4x4 网格**: $E = -258.4988$ eV
    - $\Delta E = 0.042$ eV = 42 meV
    - 平均每原子变化 = 21 meV (**未收敛**)
- **5x5x5 网格**: $E = -258.5001$ eV
    - 与 4x4x4 相比 $\Delta E = 0.0013$ eV = 1.3 meV
    - 平均每原子变化 = 0.65 meV (**已收敛**)

**结论**：在这种情况下，**4x4x4** 的网格通常已经被认为是“足够好”的（因为再增加到 5x5x5 带来的收益小于 1 meV/atom），或者为了保险起见选择 **5x5x5**。

### 4.2.2 耗时评估与最终决策
随着 K 点数目的增加，计算耗时通常呈线性或更高次方的增长。
- 查看 `running_scf.log` 结尾处的 `total time`。
- 如果 5x5x5 比 4x4x4 慢了 3 倍，但能量精度只提升了 0.5 meV/atom，那么在资源有限的情况下，**4x4x4** 是性价比更高的选择。

---

## 4.3 专家经验与进阶技巧

作为 ABACUS 的开发者，这里有几条教科书上不常写的“锦囊妙计”，能帮你避开常见陷阱。

### 4.3.1 扩胞后的 K 点缩减法则 ($1/n$ Rule)
很多初学者在扩胞（Supercell）计算时，习惯沿用原胞（Unit Cell）的 K 点密度，这会造成极大的资源浪费。

**经验法则**：K 点网格密度与晶格常数成**反比**。
如果你将晶胞在某个方向扩大了 $n$ 倍，那么该方向的 K 点数目可以减少为原来的 $1/n$。

*   **原胞**: 晶格常数 $a=3.8$ Å，收敛 K 点为 **12x12x12**。
*   **2x2x2 超胞**: 晶格常数 $a'=7.6$ Å，推荐 K 点为 **6x6x6**。
*   **4x4x4 超胞**: 晶格常数 $a''=15.2$ Å，推荐 K 点为 **3x3x3**。

### 4.3.2 大体系的 Gamma Only 模式
对于非常大的体系（例如超过 200 个原子的超胞或分子动力学模拟），布里渊区已经非常小，通常只需要计算 $\Gamma$ 点（0,0,0）即可。

在 ABACUS 的 `INPUT` 文件中，可以使用专门的加速参数：

```text
INPUT_PARAMETERS
# ... 其他参数 ...
gamma_only      1    # 开启 Gamma 点专用优化算法
```

- **作用**：当 `gamma_only` 设置为 1 时，ABACUS 会利用 $\Gamma$ 点波函数的实数性质，将计算速度提升约 2 倍，并显著降低内存消耗。
- **适用场景**：仅限于大体系且 K 点确实只需要 1x1x1 的情况。

### 4.3.3 风险提示：KPT 文件的 Line Mode
本章讨论的收敛性测试针对的是**自洽计算（SCF）**，使用的是均匀网格（Monkhorst-Pack）。

如果你在查阅文献或教程时看到类似以下的 `KPT` 内容：
```text
K_POINTS
10
Line
0.0 0.0 0.0 20
0.5 0.0 0.0 1
```
**请注意**：这是用于计算**能带结构（Band Structure）**的高对称路径模式（Line mode）。**绝对不要**用这种 K 点文件来进行能量收敛测试或结构弛豫，否则你会得到错误的基态能量。请务必查阅 ABACUS 官方文档中关于 `KPT` 格式的说明，区分 "Gamma/Monkhorst-Pack" 模式与 "Line" 模式。

---

**下一章预告**：
搞定了 K 点，我们还不能松懈。另一个决定精度的核心参数——**平面波截断能 (ecutwfc)** 同样需要严格的测试。下一章我们将讲解如何确定最优的 `ecutwfc`，并探讨它与赝势的微妙关系。

# 第五章：进阶技巧与特殊场景

在前几章中，我们已经掌握了 ABACUS 的基础运行流程和标准参数设置。然而，在实际科研中，我们经常会遇到非标准的计算场景：体系太大跑不动？扩胞之后 K 点怎么设？高对称性晶体为何计算结果不对称？

本章将针对这些进阶场景，提供专家级的解决方案和优化策略。掌握这些技巧，不仅能帮你节省宝贵的机时，更能避免许多隐蔽的物理错误。

---

## 5.1 大体系优化：Gamma Only 模式

随着研究的深入，你可能会处理包含数百甚至上千个原子的超大体系（如表面吸附、非晶体系、大团簇或生物大分子）。对于这些体系，倒空间（Reciprocal Space）的体积会变得非常小。

### 物理原理
根据固体物理原理，实空间晶胞越大，倒空间的第一布里渊区（Brillouin Zone）就越小。
*   **小体系**：布里渊区大，需要密集的 K 点网格来积分。
*   **大体系**：布里渊区极小，往往只需要一个点——**Gamma 点 (0, 0, 0)**——就足以代表整个倒空间的性质。

### ABACUS 的 Gamma Only 优化
当 K 点网格仅需 `1 1 1` 时，ABACUS 提供了一种特殊的算法优化，称为 **Gamma Only** 模式。
开启此模式后，软件会利用 $\Gamma$ 点波函数的实数性质（而在一般 K 点波函数是复数），将计算量和内存消耗降低约一半。

### 设置方法
在 `INPUT` 文件中添加以下参数：

```bash
# INPUT file
gamma_only      1        # 开启 Gamma 点特定优化算法 (0:关闭, 1:开启)
```

同时，你的 `KPT` 文件必须显式设置为 Gamma 点：

```text
K_POINTS
0
Gamma
1 1 1 0 0 0
```

> **专家提示**：
> 1. **适用门槛**：通常建议当体系原子数 $N > 100$ 且各个方向的晶格常数都较大（例如 > 10-15 Å）时，才考虑仅使用 Gamma 点。
> 2. **基组兼容性**：此功能在平面波（PW）基组下效果最为显著。
> 3. **性能收益**：对于超大体系，开启 `gamma_only` 是能否在有限内存节点上完成计算的关键。

---

## 5.2 扩胞后的 K 点缩减规则

这是初学者最容易造成资源浪费的地方。当你从单胞（Unit Cell）构建超胞（Supercell）时，K 点网格不需要保持不变，而是应该**相应稀疏化**。

### 经验法则：$1/n$ 定律
**规则**：如果晶胞在某个方向上扩大了 $n$ 倍，那么该方向上的 K 点密度可以减少为原来的 $1/n$。

### 实战演练
假设你有一个金（Au）的单胞，经过收敛性测试，确定的 K 点网格为 `12 12 12`。

1.  **场景 A：构建 $2 \times 2 \times 2$ 超胞**
    *   实空间体积扩大：8倍。
    *   倒空间体积缩小：8倍。
    *   **推荐 K 点**：$12/2 = 6$。设置 `KPT` 为 `6 6 6`。
    *   *结果*：此时的有效 K 点密度与单胞计算时完全一致，精度相当。

2.  **场景 B：构建表面模型（Slab），在 Z 方向加真空层**
    *   假设 XY 方向扩胞 $2 \times 2$，Z 方向变为非周期性（或周期极大）。
    *   **推荐 K 点**：XY 方向取 `6 6`，Z 方向取 `1`。
    *   *结果*：`KPT` 设置为 `6 6 1`。

### 为什么这样做？
DFT 计算的精度主要取决于**K 点在倒空间中的采样密度**（K-point density）。扩胞导致倒空间矢量缩短，因此更少的离散点就能达到相同的采样密度。盲目在超胞中使用 `12 12 12` 会导致计算量爆炸（计算成本与 $N_{atoms}^3 \times N_k$ 成正比），且对精度提升微乎其微。

---

## 5.3 对称性与网格设置陷阱

在处理高对称性体系（如立方晶系、六方晶系）时，K 点网格的选取必须尊重晶体的对称性，否则会导致对称性破缺，甚至产生错误的电子态占据。

### 陷阱案例
假设你计算一个面心立方（FCC）的硅单胞。
*   **正确设置**：`8 8 8`。三个方向网格数相等，保持了立方对称性。
*   **错误设置**：`8 4 4`。
    *   *后果*：人为引入了各向异性。虽然数学上程序能跑通，但输出的电荷密度可能不再具有立方对称性，导致后续的受力分析或能带计算出现物理谬误。

### 最佳实践
1.  **各向同性原则**：对于立方晶系，$K_x = K_y = K_z$。
2.  **倒格子比例原则**：对于正交或四方晶系，K 点数目应与倒格矢长度成正比（即与实空间晶格常数成反比）。
    *   公式：$K_i \propto 1 / a_i$
    *   例子：若晶格常数 $a=5, b=10, c=20$，则 K 点网格比例应接近 $4:2:1$（如 `12 6 3`）。

---

## 附录：常见问题与避坑指南

在结束本章之前，整理了一些用户在 K 点设置和任务提交中常见的问题。

### 1. 收敛判据的黄金标准
很多新手问：“K 点到底取多少才算够？”
*   **标准**：当 K 点网格密度增加（如从 `3 3 3` 变到 `4 4 4`），体系的**总能量（Total Energy）变化小于 1 meV/atom** 时，即可认为收敛。
*   **控制变量法（至关重要）**：在测试 K 点收敛性时，必须**固定** `ecutwfc`（平面波截断能）和其他所有参数。建议将 `ecutwfc` 设置得稍高（如 80-100 Ry），排除基组不完备带来的干扰。

> **可视化建议**：
> 强烈建议你在报告或论文中绘制一张 **"Total Energy vs. K-point Grid"** 的曲线图。
> *   **横坐标**：K 点网格密度（2, 3, 4, 5...）
> *   **纵坐标**：Total Energy (eV)
> *   这不仅是严谨的科研态度，也是排查计算问题的最有效手段。

### 2. `KPT` 文件的两种模式：Line Mode vs. MP
ABACUS 的 `KPT` 文件不仅用于自洽计算（SCF），也用于能带结构计算（Band Structure），但两者格式完全不同，切勿混淆。

*   **Monkhorst-Pack (MP) 模式**：用于 **SCF、结构弛豫、MD**。
    *   特征：第三行是 `Gamma` 或 `MP`，第四行是网格整数 `n1 n2 n3`。
    *   作用：均匀采样整个布里渊区，获取准确的电荷密度和总能。

*   **Line Mode (线模式)**：**仅**用于 **nscf 能带计算**。
    *   特征：显式列出高对称点路径（如 Gamma -> X -> W...）。
    *   **风险提示**：如果你在做 SCF（自洽迭代）时使用了 Line Mode 的 `KPT` 文件，程序虽然可能运行，但得到的电荷密度是错误的（因为只采样了线上的点，忽略了体内的点），导致结果毫无物理意义。
    *   *切记：做能带计算前，先用 MP 网格做 SCF 得到收敛的电荷密度（`SPIN*_CHG`），再换 Line Mode 做 nscf。*

### 3. 常见报错与环境问题
*   **脚本权限**：如果你编写了辅助脚本（如 `kpt_test.sh`），运行时提示 `Permission denied`，请执行：
    ```bash
    chmod +x kpt_test.sh
    ```
*   **结果覆盖**：ABACUS 默认会将结果输出到 `OUT.suffix` 文件夹。如果你修改参数后重新运行，默认会**覆盖**旧结果。
    *   *建议*：在 `INPUT` 中修改 `suffix` 参数（如 `suffix Si_kpt_444`），或者在提交脚本中手动备份旧目录。

### 4. 计算资源警示
K 点数目的增加会导致计算成本呈**线性**甚至更快的增长。
*   从 `2 2 2` (8个点) 增加到 `4 4 4` (64个点)，计算量可能增加 8 倍。
*   务必在精度和效率之间寻找平衡点，不要盲目追求过高的 K 点密度（除非是为了获得极高精度的态密度 DOS）。

---

**下一章预告**：
搞定了 K 点和结构，我们如何确定电子的基组精度？下一章我们将深入探讨 **平面波截断能（ecutwfc）与基组选择**，这是决定计算准确度的另一大支柱。

---

## 附录：进阶学习指南

恭喜你完成了本书的学习！掌握 K 点收敛测试只是第一步，计算材料学的世界广阔无垠，以下是为你准备的进阶探索建议：

### 1. 扩展阅读与深度主题
- **平面波截断能 (Ecut) 测试**：平面波基组的精度由 `ecutwfc` 决定。建议参考官方文档，采用与本书类似的脚本流程，对不同体系进行 Ecut 收敛性扫描（通常取值范围在 20~100 Ry 之间）。
- **LCAO 基组优化**：ABACUS 的一大特色是数值原子轨道。在进阶研究中，学习如何针对特定体系选择或生成高精度的轨道基组（Basis Sets）将极大提升你的计算效率。
- **对称性与计算效率**：正如资料 6 所述，ABACUS 会利用晶体对称性减少实际计算的 K 点数。深入理解空间群对称性，能帮你解释为何某些高对称体系的计算速度远超预期。
- **结构优化 (Geometry Optimization)**：在完成自洽场（SCF）计算后，下一步通常是寻找能量最低的原子坐标。建议学习 `STRU` 文件中原子位置的调整以及结构优化参数的配置。

### 2. 通用调试建议 (Troubleshooting)
- **检查 `running_scf.log`**：这是你的第一情报源。如果计算不收敛，观察电子步能量的变化趋势，判断是震荡还是发散。
- **能量突变排查**：如果在 K 点测试中发现能量随网格增加而出现非单调的剧烈跳变（如资料 4 所示），请检查 `STRU` 文件中的晶格常数是否合理，或尝试增加 `ecutwfc`。
- **内存溢出预警**：对于超大体系，若 K 点网格过密导致内存不足，请优先考虑开启 `gamma_only 1` 模式。

### 3. 官方资源
- **官方文档**：[ABACUS User Guide](http://abacus.deepmodeling.com/) 是最权威的参数字典。
- **社区讨论**：积极参与 DeepModeling 社区交流，那里有许多开发者与资深用户能为你答疑解惑。

科研之路始于足下，保持好奇，勇于尝试不同的参数组合，你终将培养出敏锐的“计算直觉”！
