# 第二章：输入参数配置详解

在上一章中，我们完成了 ABACUS 的环境搭建与基本运行测试。俗话说“Garbage in, garbage out”，输入文件的质量直接决定了计算结果的物理意义。

本章我们将聚焦于 DFT 计算中最基础的收敛性测试——**K 点收敛测试**。我们将深入剖析控制 K 点网格的 `KPT` 文件，并构建一个用于测试的标准化 `INPUT` 文件。

---

## 2.1 KPT 文件结构剖析

在周期性体系计算中，布里渊区（Brillouin Zone）的积分精度由 K 点网格密度决定。ABACUS 使用 `KPT` 文件来定义这一网格。

对于自洽场（SCF）计算和结构弛豫，我们通常使用**自动生成网格**模式。以下是一个标准的 `KPT` 文件示例：

**文件名：KPT**
```text
K_POINTS         # Line 1: 文件的标签/注释（通常写 K_POINTS）
0                # Line 2: K点总数。设为 0 表示自动生成网格
Gamma            # Line 3: 网格生成模式（Gamma 或 MP）
4 4 4 0 0 0      # Line 4: nx, ny, nz 以及三个方向的漂移量
```

### 逐行详解

1.  **Line 1: 标签行**
    *   这是一个注释行，ABACUS 读取时会忽略，但建议保留 `K_POINTS` 字样以保持文件可读性。

2.  **Line 2: K 点总数**
    *   **设置为 0**：这是最常用的设置。它告诉程序根据 Line 3 和 Line 4 的规则自动生成 Monkhorst-Pack 网格。
    *   **设置为具体整数**：如果你需要手动指定每一个 K 点的坐标和权重（例如在某些特殊的能带计算或杂化泛函计算中），这里填 K 点的具体数量。但在本章的 SCF 测试中，请务必设为 `0`。

3.  **Line 3: 网格生成模式**
    *   **Gamma**: 以 Gamma 点（0, 0, 0）为中心的网格。生成的网格包含 Gamma 点。
    *   **MP (Monkhorst-Pack)**: 经典的 MP 网格生成方法。生成的网格**不一定**包含 Gamma 点。
    *   **实战建议**: 对于六角晶系（Hexagonal）结构，通常推荐使用 `Gamma` Center 网格以保持对称性；对于正交或立方晶系，`MP` 往往效率更高。如果不确定，使用 `Gamma` 是较安全的保底选择。

4.  **Line 4: 网格密度与漂移**
    *   格式：`nx ny nz shift_x shift_y shift_z`
    *   `nx ny nz`: 在倒空间三个基矢量方向上的划分份数。整数越大，网格越密，计算越准，但耗时呈立方级增长。
    *   `shift_x/y/z`: 网格原点的漂移量（通常为 0 或 0.5）。
    *   **注意**: 在常规的 SCF 计算中，后三位通常设为 `0 0 0`。

> **风险提示**: `KPT` 文件还支持用于能带计算的 `Line mode`，但其格式与 VASP 的 KPOINTS 不同。在进行能带计算（非 SCF 收敛测试）时，请务必查阅 ABACUS 官方文档，切勿直接套用其他软件的格式经验。

---

## 2.2 INPUT 文件与控制变量策略

`INPUT` 文件是 ABACUS 的总控中心。在进行 K 点收敛测试时，必须严格遵守**控制变量法**：即除了 K 点密度外，其他所有参数（尤其是截断能）必须保持固定。

以下是一个用于 K 点测试的标准化 `INPUT` 模板：

**文件名：INPUT**
```bash
INPUT_PARAMETERS

# 1. 计算模式控制
calculation     scf         # 进行自洽场计算
basis_type      lcao        # 基组类型：lcao (原子轨道) 或 pw (平面波)
                            # 注意：K点测试逻辑对两种基组通用

# 2. 精度控制（控制变量的核心）
ecutwfc         100         # [重要] 平面波截断能 (Ry)。
                            # 在测试 K 点时，ecutwfc 必须固定且足够大（如 100 Ry），
                            # 以消除截断能不足带来的误差干扰。
scf_thr         1.0e-7      # 自洽迭代收敛判据 (eV)，建议设为 1e-6 或 1e-7

# 3. 电子步迭代控制
scf_nmax        100         # 最大电子迭代步数
smearing_method gaussian    # 展宽方法：gaussian (绝缘体/半导体) 或 mp (金属)
smearing_sigma  0.01        # 展宽宽度 (Ry)

# 4. 体系信息（部分信息可能需从 STRU 读取，视版本而定）
# nspin         1           # 自旋极化：1(非磁), 2(自旋极化)
```

### 关键参数解析

*   **`calculation`**: 设置为 `scf`。我们只需要得到体系的总能量，不需要进行结构弛豫（`relax`）或分子动力学（`md`）。
*   **`ecutwfc`**: 这是一个极易被初学者混淆的点。
    *   **误区**: 一边测 K 点，一边改 `ecutwfc`。
    *   **正解**: 选定一个较高的 `ecutwfc`（例如 100 Ry 或根据赝势推荐值的 1.5 倍），在整个 K 点测试过程中保持不变。只有这样，总能量的变化才完全归因于 K 点网格的改变。
*   **`basis_type`**: ABACUS 支持 LCAO（数值原子轨道）和 PW（平面波）。虽然 LCAO 效率极高，但在进行高精度基准测试时，K 点收敛规律在两种基组下是一致的。

---

## 2.3 实战：执行收敛测试

### 收敛判据
在计算材料学中，我们无法追求“绝对真值”，只能追求“收敛值”。
**黄金标准**: 当 K 点网格密度增加（例如从 2x2x2 变为 3x3x3），体系的**总能量变化小于 1 meV/atom** 时，我们认为该 K 点网格已满足计算精度要求。

$$ |E_{total}(N) - E_{total}(N-1)| < 1 \text{ meV} \times N_{atoms} $$

### 操作步骤
1.  **准备**: 准备好 `STRU`（结构文件）、`INPUT`（固定参数）和赝势/轨道文件。
2.  **迭代**:
    *   修改 `KPT` 文件 Line 4 为 `2 2 2 0 0 0`，运行 ABACUS，记录总能量。
    *   修改 `KPT` 文件 Line 4 为 `3 3 3 0 0 0`，运行 ABACUS，记录总能量。
    *   修改 `KPT` 文件 Line 4 为 `4 4 4 0 0 0`，...
3.  **分析**: 计算相邻两次计算的能量差。

---

## 2.4 专家锦囊（Pro Tips）

### 1. 可视化建议：绘制收敛曲线
强烈建议将测试结果绘制成图表，而不是只看枯燥的数字。
*   **横坐标**: K 点网格密度（如 2, 3, 4, 5...）
*   **纵坐标**: 体系总能量（Total Energy, eV）
*   **观察**: 曲线通常会呈现阻尼振荡或单调趋近的形式。找到曲线开始“变平”的那个拐点，即为最佳 K 点设置。

### 2. 扩胞后的 K 点缩减法则（$1/n$ Rule）
这是一个非常实用的经验法则，能帮你节省大量测试时间：
> **如果晶胞在某个方向上扩大了 $n$ 倍（即构建了超胞），那么该方向上的 K 点密度可以相应减少为原来的 $1/n$。**

**例子**:
*   原胞（Unit Cell）收敛的 K 点网格是 `12 12 12`。
*   如果你构建了一个 `2 2 2` 的超胞（Supercell，体积是原来的 8 倍）。
*   那么超胞的 K 点网格只需设置 `6 6 6` 即可达到相同的精度。

### 3. 进阶技巧：`gamma_only`
对于非常大的体系（例如超过 200 个原子的超胞或无序体系），布里渊区非常小，往往只需要 Gamma 点（1 1 1）即可。
此时，可以在 `INPUT` 文件中添加参数：
```bash
gamma_only      1
```
开启此参数后，ABACUS 会利用 Gamma 点波函数的实数性质进行特殊优化，计算速度可提升约 2 倍，内存消耗减半。**注意：这仅适用于 K 点确认为 1x1x1 的情况。**

---

下一章，我们将深入探讨另一个核心收敛参数——**截断能（ecutwfc）** 的配置与测试策略。