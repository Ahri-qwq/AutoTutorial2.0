# 第一章：物理基础与收敛性原理

欢迎来到 ABACUS 实战教程的第一章。在真正开始敲击键盘运行计算之前，我们需要先建立正确的物理图像。

很多初学者容易陷入一个误区：拿到软件直接运行，只要不报错就算成功。但在计算材料学中，**“跑通”不等于“正确”**。密度泛函理论（DFT）计算是一个数值近似的过程，我们需要通过调整一系列参数，在“计算精度”和“计算成本”之间找到最佳平衡点。

本章将聚焦于 DFT 计算中最基础的两个数值参数之一：**K 点（K-points）**（另一个是平面波截断能 `ecutwfc`，将在后续章节讨论）。我们将解释为何需要采样 K 点，以及如何科学地测试其收敛性。

---

## 1.1 布里渊区采样 (Brillouin Zone Sampling)

### 物理图像：从连续到离散

在固体物理中，晶体具有周期性结构。根据**布洛赫定理（Bloch's Theorem）**，晶体中的电子波函数可以写成一个调幅平面波。为了计算体系的总能量、电荷密度等物理量，我们需要对倒空间（Reciprocal Space）的第一布里渊区（First Brillouin Zone）进行积分。

理论上，这个积分应该是连续的。但在计算机中，我们无法处理连续积分，必须将其离散化。这就好比我们在计算定积分 $\int f(x) dx$ 时，将其近似为一系列矩形面积的求和 $\sum f(x_i) \Delta x$。

*   **K 点（K-points）**：就是我们在倒空间中选取的这些离散采样点。
*   **K 点网格（K-mesh）**：这些点在布里渊区排列成的网格。

**核心结论**：采样点越密（K 点越多），离散求和就越接近连续积分的真实值，计算结果越精确，但计算量也越大。

### ABACUS 中的 K 点设置 (`KPT` 文件)

在 ABACUS 中，K 点的设置独立于 `INPUT` 文件，通常存储在一个名为 `KPT` 的文件中。对于自洽场（SCF）计算和结构弛豫，我们通常使用均匀网格。

以下是一个标准的 `KPT` 文件示例：

**文件名：KPT**
```text
K_POINTS
0
Gamma
4 4 4 0 0 0
```

**参数详解**：

1.  **第一行 (`K_POINTS`)**: 关键词，标识文件类型。
2.  **第二行 (`0`)**: K 点总数。
    *   设置为 `0` 表示让 ABACUS 根据后续参数自动生成网格（推荐）。
    *   若设置为具体数字，则需要手动列出每个 K 点的坐标和权重（仅在特定高级需求下使用）。
3.  **第三行 (`Gamma`)**: 网格生成模式。
    *   `Gamma`: 生成 **Gamma-centered Monkhorst-Pack** 网格。即网格包含原点 $\Gamma(0, 0, 0)$ 点。这是最常用的模式，特别是对于六角晶系（Hexagonal）建议强制使用。
    *   `MP`: 标准 Monkhorst-Pack 网格，可能会根据网格奇偶性发生位移，不一定包含 Gamma 点。
4.  **第四行 (`4 4 4 0 0 0`)**: 网格密度与偏移。
    *   前三个数 `4 4 4`：分别对应倒空间三个基矢量方向上的分割份数（$N_x, N_y, N_z$）。
    *   后三个数 `0 0 0`：网格在三个方向上的偏移量（Shift）。通常设为 0。

---

## 1.2 数值收敛与计算成本的权衡

### 什么是“数值收敛”？

在计算材料学中，“收敛”通常指：**随着某个数值参数精度提高（如 K 点网格加密），计算得到的物理量（如总能量）趋于一个稳定值。**

我们需要明确一个观念：我们追求的不是“绝对真值”（那是实验的事），而是“数值稳定值”。

### 核心矛盾：精度 vs. 成本

*   **精度**：K 点网格越密（如从 $2\times2\times2$ 增加到 $8\times8\times8$），总能量越准确。
*   **成本**：计算时间与 K 点数量大致成线性关系（$O(N_k)$）。

我们的目标是找到**性价比最高的点**：即 K 点增加带来的能量变化已经小于我们可以容忍的误差范围，此时的网格密度就是我们的“收敛标准”。

### 实战操作：K 点收敛性测试 (Convergence Test)

这是任何高质量计算的第一步。我们将采用**控制变量法**。

#### 1. 准备工作
固定其他所有参数，特别是平面波截断能 `ecutwfc`。建议先设置一个相对安全的值（例如 60-100 Ry，取决于赝势建议值）。

**文件名：INPUT** (基础模板)
```text
INPUT_PARAMETERS
suffix          k_test
calculation     scf         # 进行自洽计算
basis_type      pw          # 使用平面波基组
ecutwfc         100         # 固定截断能，控制变量
scf_thr         1e-6        # 自洽收敛精度
symmetry        1           # 开启对称性分析（加速计算）
ntype           1
pseudo_dir      ./
orbital_dir     ./
```
*(注：请确保目录下有对应的 `STRU` 文件和赝势文件)*

#### 2. 迭代测试
依次修改 `KPT` 文件中的网格密度，运行计算并记录总能量。

*   **Step 1**: `KPT` 设置为 `2 2 2 0 0 0` $\rightarrow$ 运行 $\rightarrow$ 记录 `Total Energy`。
*   **Step 2**: `KPT` 设置为 `3 3 3 0 0 0` $\rightarrow$ 运行 $\rightarrow$ 记录 `Total Energy`。
*   **Step 3**: `KPT` 设置为 `4 4 4 0 0 0` $\rightarrow$ ...
*   ...以此类推。

#### 3. 判据标准 (Critical)
如何判断收敛？学术界通用的经验判据是：
> **当 K 点网格密度增加导致的总能量变化 $\Delta E$ 小于 1 meV/atom 时，即可认为收敛。**

*注意：是每个原子的能量变化，不是整个体系的总能量变化。*

#### 4. 结果可视化 (强烈推荐)
建议将测试结果绘制成曲线图，这是科研记录的好习惯。
*   **横坐标**: K 点网格密度 (2, 3, 4, 5...)
*   **纵坐标**: 总能量 (eV)

典型的收敛曲线会呈现**阻尼振荡**或**单调趋近**的形式，最终拉成一条水平线。一旦曲线进入“平台期”，平台开始处的 K 点密度即为最佳选择。

---

## 1.3 专家锦囊 (Tips & Tricks)

在实际项目中，我们不需要每次都盲目地从 $1\times1\times1$ 测到 $20\times20\times20$。以下经验法则可以帮你快速定位：

### 1. 扩胞经验法则 ($1/n$ Rule)
K 点采样的本质是覆盖倒空间。倒空间的大小与实空间晶胞大小成反比 ($V_{rec} \propto 1/V_{real}$)。
*   如果你有一个单胞，测试发现需要 $12\times12\times12$ 的 K 点。
*   当你建立一个 $2\times2\times2$ 的超胞（Supercell）时，实空间体积扩大了 8 倍，倒空间体积缩小为原来的 1/8。
*   此时，你的 K 点网格只需要 $6\times6\times6$ 即可达到相同的采样精度。

**公式**：$N_{new} \approx N_{old} \times \frac{L_{old}}{L_{new}}$

### 2. Gamma Only 模式
对于非常大的体系（如包含数百个原子的超胞、非周期性的分子/团簇计算），倒空间非常小，往往只需要一个 K 点——即原点 $\Gamma (0, 0, 0)$。
ABACUS 针对这种情况提供了专门的加速算法。
*   **启用方法**: 在 `INPUT` 文件中设置 `gamma_only 1`。
*   **效果**: 计算速度显著提升，内存消耗降低。
*   **注意**: 此时 `KPT` 文件仍需存在，内容应设为 Gamma 点单点采样。

### 3. 风险提示：能带计算
本章讨论的 K 点采样仅针对 **SCF（自洽场）计算**和**结构优化**，目的是获取准确的基态电子密度。
如果你需要计算**能带结构（Band Structure）**，`KPT` 文件的写法完全不同（需要使用 Line Mode 选取高对称路径）。请务必查阅 ABACUS 官方文档中关于 `KPT` 路径生成的说明，切勿直接套用 VASP 的 KPOINTS 格式，两者的 Line Mode 定义方式存在差异。

---

**下一章预告**：
搞定了 K 点，我们将在第二章攻克另一个核心参数——**平面波截断能 (`ecutwfc`)**，并正式开始我们的第一个结构优化任务。