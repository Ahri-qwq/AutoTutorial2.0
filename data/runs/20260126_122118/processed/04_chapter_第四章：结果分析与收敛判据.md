# 第四章：结果分析与收敛判据

在上一章中，我们已经完成了不同 K 点网格密度下的批量计算。获得数据只是第一步，如何从这些数据中提取出科学的结论，并据此确定后续计算的参数，才是体现“计算材料学直觉”的关键环节。

本章将带你完成从“数据提取”到“收敛性判断”的完整流程，并建立一套标准化的判据体系。

---

## 4.1 可视化分析 (Total Energy vs. K-grid)

人类的大脑对图像的敏感度远高于数字。在确定最优 K 点网格时，最直观的方法是绘制 **“总能量 vs. K点网格密度”** 的收敛曲线。

### 4.1.1 数据提取
首先，我们需要从 ABACUS 的输出文件中提取总能量。在 SCF 计算结束后，ABACUS 会在日志文件（通常输出在屏幕或重定向到文件中，如 `running_scf.log`）或输出目录（`OUT.suffix/running_scf.log`）中打印最终能量。

关键词通常是 `Final Etot`。你可以使用以下 Shell 命令快速查看所有测试文件夹下的能量数据（假设你的文件夹命名为 `K_2`, `K_3` 等）：

```bash
# 批量提取能量数据的命令示例
grep "Final Etot" K_*/OUT.*/running_scf.log
```

输出示例：
```text
K_2/OUT.ABACUS/running_scf.log: Final Etot = -256.12345678 eV
K_3/OUT.ABACUS/running_scf.log: Final Etot = -258.45678901 eV
K_4/OUT.ABACUS/running_scf.log: Final Etot = -258.49876543 eV
K_5/OUT.ABACUS/running_scf.log: Final Etot = -258.50012345 eV
K_6/OUT.ABACUS/running_scf.log: Final Etot = -258.50023456 eV
```

### 4.1.2 绘制收敛曲线
建议使用 Python (Matplotlib)、Gnuplot 或 Origin 绘制曲线：
- **横坐标 (X-axis)**: K 点网格的密度参数（例如 2, 3, 4, 5... 代表 2x2x2, 3x3x3...）。
- **纵坐标 (Y-axis)**: 体系的总能量 (Total Energy, eV)。

**曲线特征分析**：
1.  **剧烈变化区**：在 K 点较少时（如 1x1x1 到 3x3x3），能量通常会发生剧烈跳变。这是因为稀疏的 K 点无法正确积分布里渊区，此时的结果是物理上不可靠的。
2.  **震荡/趋平区**：随着 K 点增加，能量变化幅度逐渐减小。曲线可能呈现单调下降/上升，也可能在某个值附近微小震荡。
3.  **平台区**：当 K 点足够密时，能量几乎不再变化，曲线进入“平台期”。

> **注意**：在进行 K 点测试时，必须严格遵守**控制变量法**。确保 `INPUT` 文件中的平面波截断能 `ecutwfc`（例如固定为 100 Ry）和其他参数保持不变，仅改变 `KPT` 文件。

---

## 4.2 确定最优 K 点网格

“收敛”在数值计算中是一个相对概念。我们追求的是在**计算精度**和**计算成本**之间找到最佳平衡点。

### 4.2.1 量化收敛标准 (The 1 meV Criterion)
学术界通用的收敛判据如下：

**当 K 点网格密度增加（例如从 NxNxN 增加到 (N+1)x(N+1)x(N+1)）时，如果体系总能量的变化 $\Delta E$ 满足以下条件，即可认为收敛：**

$$ \frac{|\Delta E|}{N_{atoms}} < 1 \text{ meV/atom} $$

其中：
- $\Delta E$ 是两次计算的总能量差值。
- $N_{atoms}$ 是晶胞中的原子总数。
- $1 \text{ meV} = 0.001 \text{ eV}$。

**实战演练**：
假设体系包含 2 个原子：
- **3x3x3 网格**: $E = -258.4568$ eV
- **4x4x4 网格**: $E = -258.4988$ eV
    - $\Delta E = 0.042$ eV = 42 meV
    - 平均每原子变化 = 21 meV (**未收敛**)
- **5x5x5 网格**: $E = -258.5001$ eV
    - 与 4x4x4 相比 $\Delta E = 0.0013$ eV = 1.3 meV
    - 平均每原子变化 = 0.65 meV (**已收敛**)

**结论**：在这种情况下，**4x4x4** 的网格通常已经被认为是“足够好”的（因为再增加到 5x5x5 带来的收益小于 1 meV/atom），或者为了保险起见选择 **5x5x5**。

### 4.2.2 耗时评估与最终决策
随着 K 点数目的增加，计算耗时通常呈线性或更高次方的增长。
- 查看 `running_scf.log` 结尾处的 `total time`。
- 如果 5x5x5 比 4x4x4 慢了 3 倍，但能量精度只提升了 0.5 meV/atom，那么在资源有限的情况下，**4x4x4** 是性价比更高的选择。

---

## 4.3 专家经验与进阶技巧

作为 ABACUS 的开发者，这里有几条教科书上不常写的“锦囊妙计”，能帮你避开常见陷阱。

### 4.3.1 扩胞后的 K 点缩减法则 ($1/n$ Rule)
很多初学者在扩胞（Supercell）计算时，习惯沿用原胞（Unit Cell）的 K 点密度，这会造成极大的资源浪费。

**经验法则**：K 点网格密度与晶格常数成**反比**。
如果你将晶胞在某个方向扩大了 $n$ 倍，那么该方向的 K 点数目可以减少为原来的 $1/n$。

*   **原胞**: 晶格常数 $a=3.8$ Å，收敛 K 点为 **12x12x12**。
*   **2x2x2 超胞**: 晶格常数 $a'=7.6$ Å，推荐 K 点为 **6x6x6**。
*   **4x4x4 超胞**: 晶格常数 $a''=15.2$ Å，推荐 K 点为 **3x3x3**。

### 4.3.2 大体系的 Gamma Only 模式
对于非常大的体系（例如超过 200 个原子的超胞或分子动力学模拟），布里渊区已经非常小，通常只需要计算 $\Gamma$ 点（0,0,0）即可。

在 ABACUS 的 `INPUT` 文件中，可以使用专门的加速参数：

```text
INPUT_PARAMETERS
# ... 其他参数 ...
gamma_only      1    # 开启 Gamma 点专用优化算法
```

- **作用**：当 `gamma_only` 设置为 1 时，ABACUS 会利用 $\Gamma$ 点波函数的实数性质，将计算速度提升约 2 倍，并显著降低内存消耗。
- **适用场景**：仅限于大体系且 K 点确实只需要 1x1x1 的情况。

### 4.3.3 风险提示：KPT 文件的 Line Mode
本章讨论的收敛性测试针对的是**自洽计算（SCF）**，使用的是均匀网格（Monkhorst-Pack）。

如果你在查阅文献或教程时看到类似以下的 `KPT` 内容：
```text
K_POINTS
10
Line
0.0 0.0 0.0 20
0.5 0.0 0.0 1
```
**请注意**：这是用于计算**能带结构（Band Structure）**的高对称路径模式（Line mode）。**绝对不要**用这种 K 点文件来进行能量收敛测试或结构弛豫，否则你会得到错误的基态能量。请务必查阅 ABACUS 官方文档中关于 `KPT` 格式的说明，区分 "Gamma/Monkhorst-Pack" 模式与 "Line" 模式。

---

**下一章预告**：
搞定了 K 点，我们还不能松懈。另一个决定精度的核心参数——**平面波截断能 (ecutwfc)** 同样需要严格的测试。下一章我们将讲解如何确定最优的 `ecutwfc`，并探讨它与赝势的微妙关系。