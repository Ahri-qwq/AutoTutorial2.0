<!-- META_START -->
# ABACUS 实战教程：K点网格密度收敛性测试

## 前言
- **本书逻辑**: 本教程遵循“物理原理 -> 参数详解 -> 自动化实战 -> 数据分析 -> 进阶优化”的教学逻辑。旨在帮助读者不仅掌握如何操作 ABACUS 进行 K 点测试，更能理解其背后的物理意义，从而在计算精度与资源消耗之间找到最佳平衡点。
- **核心知识点**: 布里渊区采样理论、KPT 文件结构解析、Shell 脚本自动化批处理、收敛判据（1 meV/atom）、Gamma Only 优化策略。

<!-- CHAPTER_START -->
## 第一章：物理基础与收敛性原理
**本章逻辑**: 在动手操作前，必须建立正确的物理图像。本章解释为何需要进行 K 点采样，以及“收敛”在数值计算中的具体含义，为后续操作确立目标。

### Section 1.1: 布里渊区采样 (Brillouin Zone Sampling)
- **内容**: 阐述周期性边界条件下，如何通过在倒空间（第一布里渊区）选取离散的 K 点来近似连续积分，从而求解 Kohn-Sham 方程。解释 K 点密度与积分精度的关系。
- **关键参数**: 无

### Section 1.2: 数值收敛与计算成本的权衡
- **内容**: 定义“数值收敛”的概念（随着网格加密，总能量趋于稳定）。分析计算精度与计算成本（机时、内存）之间的矛盾，确立本教程的核心目标——寻找满足精度要求的最小计算代价。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第二章：输入参数配置详解
**本章逻辑**: 熟悉 ABACUS 的核心输入文件是进行测试的前提。本章重点解析控制 K 点网格的 `KPT` 文件及配合测试的 `INPUT` 文件设置。

### Section 2.1: KPT 文件结构剖析
- **内容**: 详细解读 `KPT` 文件的格式。重点讲解 Line 2（K点总数设为 0 的含义）、Line 3（Gamma 与 MP 方法的区别）以及 Line 4（网格划分整数设置）。
- **关键参数**: `KPT File` (Line 2, Line 3, Line 4)

### Section 2.2: INPUT 文件与控制变量策略
- **内容**: 设置 SCF 自洽计算的基础参数。强调“控制变量法”的重要性：在测试 K 点时，必须固定截断能（`ecutwfc`）及其他参数。说明基组类型（PW/LCAO）对测试的通用性。
- **关键参数**: `calculation` (scf), `ecutwfc`, `basis_type`, `smearing_method`

<!-- CHAPTER_START -->
## 第三章：自动化测试流程实战
**本章逻辑**: 这是本教程的核心操作部分。通过编写 Shell 脚本实现“修改-运行-提取”的自动化闭环，避免繁琐的人工操作，提升效率。

### Section 3.1: 编写自动化批处理脚本
- **内容**: 指导读者编写 Shell 脚本（参考素材中的 `my_script.sh`）。实现利用 `sed` 命令动态修改 `KPT` 文件中的网格密度（如从 2 2 2 到 8 8 8），并管理 `suffix` 以防止结果覆盖。
- **关键参数**: `suffix`

### Section 3.2: 运行计算与数据提取
- **内容**: 执行批量计算任务，并编写命令从 `running_scf.log` 中提取关键数据（`final etot`）。演示如何将 K 点密度与对应的总能量输出到文本文件中。
- **关键参数**: 无 (涉及 Shell 命令 `grep`, `mpirun`)

<!-- CHAPTER_START -->
## 第四章：结果分析与收敛判据
**本章逻辑**: 获得数据后，如何科学地判断是否“收敛”是关键。本章提供标准化的判断流程和可视化建议。

### Section 4.1: 可视化分析 (Total Energy vs. K-grid)
- **内容**: 建议绘制“总能量 vs. K点网格密度”曲线图。分析曲线走势（单调变化或震荡），识别能量趋于平稳的区域。
- **关键参数**: 无

### Section 4.2: 确定最优 K 点网格
- **内容**: 引入量化的收敛标准（如能量变化小于 **1 meV/atom**）。结合计算效率（耗时随 K 点增加而上升），指导读者选定最终的 K 点网格参数（如 4x4x4）。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第五章：进阶技巧与特殊场景
**本章逻辑**: 针对非标准场景（大体系、扩胞、低对称性），提供专家级的优化建议和注意事项，提升读者的实际解决问题能力。

### Section 5.1: 大体系优化：Gamma Only 模式
- **内容**: 介绍针对大原子数体系（N原子以上）的特殊优化参数。解释当 K 点网格仅需 Gamma 点（1 1 1）时，开启此功能如何节省内存并加速计算。
- **关键参数**: `gamma_only`

### Section 5.2: 扩胞后的 K 点缩减规则
- **内容**: 传授经验法则——当晶胞在某方向扩胞 $n$ 倍时，该方向的 K 点密度可相应减少为原来的 $1/n$，从而避免由于盲目设置过密网格导致的资源浪费。
- **关键参数**: 无

### Section 5.3: 对称性与网格设置陷阱
- **内容**: 讨论晶格对称性对 K 点选取的限制。警示在立方晶系等高对称结构中设置极端不均匀网格（如 8 2 2）可能带来的风险。
- **关键参数**: 无

<!-- APPENDIX_START -->
## 附录：常见问题与避坑指南
- **常见报错**: 脚本权限问题 (`chmod +x`)、结果文件覆盖问题。
- **风险提示**: `KPT` 文件的 Line Mode（能带计算）与 SCF 收敛测试的区别。
- **计算资源**: 提醒 K 点增加导致的计算成本非线性增长。