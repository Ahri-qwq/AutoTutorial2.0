# ABACUS 第一性原理实战：电荷密度分析与可视化指南

## 前言

欢迎来到《ABACUS 第一性原理实战：电荷密度分析与可视化指南》。

在当今计算材料学领域，由中国科学家主导开发的开源密度泛函理论（DFT）软件 ABACUS，凭借其在数值原子轨道（LCAO）基组上的卓越效率和对大规模体系的优秀扩展性，正逐渐成为科研工作者的重要利器。然而，对于初学者而言，如何从枯燥的 SCF 迭代数据中提取出直观、深刻的物理图景，依然是一道不小的门槛。

**本书路线图**
本教程旨在通过手把手的教学，带你攻克电子结构分析中最核心的环节——电荷密度分析。全书分为四个阶段：
1. **物理基础（第一章）**：建立差分电荷密度的理论模型，理解“扣除流程”的物理意义。
2. **标准流程（第二章）**：掌握 ABACUS 空间网格对齐技巧，获取严格的 `.cube` 原始数据。
3. **后处理与可视化（第三章）**：构建“ABACUS + Python/VESTA”工作流，实现数据到精美图表的转化。
4. **进阶应用（第四章）**：深入能带分解电荷密度（PCHG），探索费米面附近的微观电子态。

**知识体系定位**
在整个 ABACUS/DFT 知识体系中，电荷密度分析处于“承上启下”的关键位置。它上接 SCF 自洽迭代（涉及电荷密度混合算法等底层逻辑），下接催化活性分析、STM 图像模拟及化学键性质判定。掌握了本书内容，你将能够跨越“只会跑程序”的阶段，真正进入“用计算解释物理”的殿堂。

**前置知识**
在开始本书的学习之前，建议读者具备以下基础：
- 固体物理或量子化学的基本概念（如能带、布里渊区、费米面）。
- 基础的 Linux 命令行操作能力。
- 了解 ABACUS 的基本输入文件（INPUT, KPT, STRU, POTENTIAL）配置方法。

---

# 第一章：物理基础与计算策略

在正式开始操作 ABACUS 进行计算之前，我们必须先构建清晰的物理图像和计算策略。很多初学者容易陷入“拿到软件就跑任务”的误区，最后发现算出的数据无法进行物理分析。

对于**差分电荷密度（Charge Density Difference）** 这一课题，核心难点不在于如何写 INPUT 文件，而在于如何设计一套严格的**“扣除流程”**，以确保相减的物理量在空间上是严格对齐的。

本章将为你建立这一理论框架。

---

## 1.1 差分电荷密度的物理图景

### 什么是电荷重排？
当两个独立的原子或分子片段结合成一个整体时，它们的电子云并不会简单地叠加，而是会发生**重排（Redistribution）**。电子会从高势能区域流向低势能区域，或者在原子核之间聚集形成化学键。

差分电荷密度 $\Delta \rho(\mathbf{r})$ 正是用来描述这种**“变化量”**的物理量。其定义公式如下：

$$
\Delta \rho(\mathbf{r}) = \rho_{AB}(\mathbf{r}) - \rho_A(\mathbf{r}) - \rho_B(\mathbf{r})
$$

其中：
- $\rho_{AB}(\mathbf{r})$：相互作用后的整体体系（AB）的电荷密度。
- $\rho_A(\mathbf{r})$：保持在 AB 中几何构型的孤立片段 A 的电荷密度。
- $\rho_B(\mathbf{r})$：保持在 AB 中几何构型的孤立片段 B 的电荷密度。

### 物理意义解读
通过分析 $\Delta \rho(\mathbf{r})$ 的空间分布，我们可以直观地看到：
- **正值区域（$\Delta \rho > 0$）**：电子**积聚**区。通常出现在成键区域（共价键）或电负性较强的原子附近。
- **负值区域（$\Delta \rho < 0$）**：电子**耗损**区。通常出现在被极化的原子核附近。

这为我们理解界面电荷转移、化学键的强弱以及吸附机理提供了最直接的证据。

---

## 1.2 ABACUS 中的“三步走”构建策略

### 核心原则：ABACUS 不直接输出差分结果
作为开发者，我必须向大家强调一个关键点：**ABACUS 内核（以及绝大多数 DFT 软件）在单次 SCF 计算中，只负责输出当前体系的总电荷密度（Total Charge Density），不会自动计算差分值。**

因此，我们需要人为设计一个**“三步走”**的计算流程，分别得到三个独立的电荷密度文件（通常为 `.cube` 格式），最后在后处理阶段进行数学相减。

### 策略详解
为了保证 $\rho_{AB}$、$\rho_A$ 和 $\rho_B$ 能够在空间网格上点对点相减，必须严格遵守以下操作规范：

#### 第一步：计算整体体系 AB
- **目标**：获得 $\rho_{AB}$。
- **操作**：进行标准的自洽场（SCF）计算。
- **关键输出**：开启电荷密度输出参数（`out_chg 1`），获得 `SPIN1_CHG.cube`（或类似命名）。

#### 第二步：计算孤立部分 A
- **目标**：获得 $\rho_A$。
- **操作**：
    1.  **继承晶胞**：必须使用与 AB 完全相同的晶胞参数（Lattice Vectors）。**严禁进行晶胞弛豫（vc-relax）。**
    2.  **继承坐标**：保留 A 部分的原子坐标，**且必须保持其在 AB 中的绝对位置不变**。直接删除 B 部分的原子。
    3.  **冻结原子**：严禁进行离子步弛豫（relax），必须进行静态计算（scf）。
- **物理含义**：这代表了“如果 B 不存在，A 在这个位置原本的电子分布”。

#### 第三步：计算孤立部分 B
- **目标**：获得 $\rho_B$。
- **操作**：同上，保留 B 部分原子，删除 A 部分原子。保持晶胞和坐标严格冻结。

---

## 1.3 避坑指南：对称性与网格陷阱（Critical）

在执行上述“三步走”时，有两个极易被忽视的技术细节，一旦出错，会导致差分结果完全变成“噪音”。

### 1. 强制关闭对称性 (`symmetry -1`)
在计算孤立体系 A 或 B 时，由于原子数量减少，体系的对称性可能会发生变化（通常会升高或改变点群）。
- **风险**：如果开启对称性分析，ABACUS 可能会根据 A 的新对称性自动约化 k 点或调整实空间 FFT 网格的取向。这将导致 $\rho_A$ 的网格点与 $\rho_{AB}$ **无法一一对应**。
- **解决方案**：在所有三步计算的 `INPUT` 文件中，必须显式设置：
  ```bash
  INPUT_PARAMETERS
  # ... 其他参数 ...
  symmetry    -1    # 强制关闭对称性分析，确保不进行空间群操作
  ```
  *注：虽然部分版本 `symmetry 0` 亦可，但 `-1` 是更为彻底的开发者建议，确保完全禁用对称性操作，保证 Grid 数据与原子坐标的原始映射。*

### 2. 锁定 FFT 网格 (FFT Grid Consistency)
差分的前提是矩阵相减，这意味着三个 `.cube` 文件的网格尺寸（Nx, Ny, Nz）必须完全一致。
- **风险**：虽然 `ecutwfc`（波函数截断能）决定了网格密度，但在不同体系（AB vs A）中，自动算法可能因微小的数值差异导致 FFT 网格点数出现 $\pm 1$ 的偏差。
- **解决方案**：
    1.  先运行 AB 体系的计算。
    2.  检查输出日志（如 `running_scf.log` 或 `OUT.ABACUS/` 下的文件），找到类似 `FFT grid` 或 `fft_nx`, `fft_ny`, `fft_nz` 的数值。
    3.  **（强烈建议）** 如果 ABACUS 版本支持手动固定 FFT 网格，请在 A 和 B 的计算中显式指定这些参数（请查阅对应版本的官方文档确认参数名）。
    4.  **（通用做法）** 只要严格保持 `ecutwfc` 和晶胞参数（Cell）完全一致，并配合 `symmetry -1`，通常可以保证网格一致。**但在进行减法前，务必检查三个 cube 文件的头部信息，确认网格维数完全相同！**

### 3. LCAO 基组下的特殊说明
如果你使用的是原子轨道基组（`basis_type lcao`）：
- 上述“直接删除原子”的方法计算的是**原子形变密度（Deformation Density）**，即相对于孤立原子的电荷转移，这是最常用的分析方法。
- 如果需要计算涉及基组重叠误差（BSSE）的相互作用能，或者需要更精细的轨道分析，可能需要引入 **Ghost Atom**（鬼原子：有基函数但无核电荷和电子的原子）。但在标准的差分电荷密度图绘制中，通常采用上述物理定义的“三步走”即可。

---

**本章小结**：
我们已经明确了目标：通过三次独立的、固定晶胞和坐标的、关闭对称性的 SCF 计算，分别获取 $\rho_{AB}$、$\rho_A$ 和 $\rho_B$。下一章，我们将进入实战环节，手把手教你编写输入文件。

# 第二章：标准计算流程（Total Charge Density）

在第一性原理计算中，**差分电荷密度（Charge Density Difference, CDD）** 是分析原子间成键、电荷转移以及界面相互作用最直观的工具之一。

然而，新手最容易陷入的误区是试图寻找一个直接输出“差分电荷”的开关。在此必须明确一个核心概念：**ABACUS 内核不直接输出差分电荷密度文件**。我们需要通过严格控制的“三步走”流程，分别计算整体与分体系的电荷密度，最后在后处理阶段进行网格点对点的相减。

本章将带你完成这一流程的核心部分：获取三个在空间上严格对齐的 `.cube` 电荷密度文件。

---

## 2.1 步骤一：整体体系（AB）的 SCF 计算

这是所有后续分析的基准（Reference）。我们需要对由 A 部分和 B 部分组成的完整体系（System AB）进行自洽场（SCF）计算。

### 2.1.1 核心参数设置

在 `INPUT` 文件中，除了常规的收敛参数（如 `ecutwfc`, `scf_thr`）外，必须特别关注以下三个控制项：

```bash
INPUT_PARAMETERS
# ... (常规参数如 ecutwfc, mixing_type 等) ...

calculation     scf         # 进行自洽计算
symmetry        -1          # [关键] 强制关闭对称性分析
out_chg         1           # 输出电荷密度文件 (通常为 density.cube 或 CHARGE)
basis_type      lcao        # 或 pw，根据实际需求选择
```

### 2.1.2 为什么必须设置 `symmetry -1`？
这是本教程最重要的经验总结之一。
*   **默认行为**：ABACUS 默认会分析晶体对称性以加速计算（`symmetry 1`）。这可能会导致程序自动旋转坐标系、移动原点或通过对称性操作减少存储的网格点。
*   **灾难后果**：如果 System AB 开启了对称性，而 System A（由于原子缺失）对称性降低，两者输出的电荷密度网格（FFT Grid）在实空间中可能发生**旋转或错位**。此时进行差分相减（$\rho_{AB} - \rho_A - \rho_B$），得到的将是毫无物理意义的噪声。
*   **解决方案**：设置 `symmetry -1` 强制程序使用原始输入的 `STRU` 坐标系，不进行任何对称性约化，确保空间网格的绝对锚定。

### 2.1.3 运行与记录
提交任务运行完成后，请务必查看输出日志（如 `OUT.AB/running_scf.log`），找到 FFT 网格的维度信息。这对于下一步至关重要。

> **日志示例（需记录的数值）：**
> ```text
> FFT grid for charge/potential:  108 * 108 * 144
> ```
> *注：这代表 x, y, z 方向的网格点数分别为 nx=108, ny=108, nz=144。*

---

## 2.2 步骤二：分体系（A 与 B）的独立计算

接下来，我们需要分别计算单独存在的 A 部分和 B 部分的电荷密度。此步骤的成败在于：**控制变量**。

### 2.2.1 修改 STRU 文件：移除而非移动
以计算 System A 为例。我们需要基于 System AB 的 `STRU` 文件进行修改：
1.  **保持晶胞不变**：`ATOMIC_POSITIONS` 上方的晶格矢量（Lattice Vectors）必须与 System AB **完全一致**。
2.  **移除原子**：直接删除（或注释掉）属于 B 部分的原子行。
3.  **禁止移动**：绝对不要改变剩余 A 原子的坐标数值。

**System AB 的 STRU (示例):**
```text
ATOMIC_POSITIONS
Cartesian
Fe 0.00 0.00 0.00  # A部分
O  1.50 0.00 0.00  # B部分
```

**System A 的 STRU (修改后):**
```text
ATOMIC_POSITIONS
Cartesian
Fe 0.00 0.00 0.00  # 保留 A
# O  1.50 0.00 0.00  <-- 删除 B
```

### 2.2.2 锁定 FFT 网格（Grid Consistency）
这是最容易被忽略的隐形陷阱。
虽然理论上只要晶胞大小（Cell）和截断能（`ecutwfc`）不变，FFT 网格应该是相同的。但在某些极端情况下（或不同版本的自动并行策略下），软件自动生成的网格可能会有微小差异（例如从 108 变为 110）。

为了万无一失，建议在 System A 和 System B 的 `INPUT` 文件中**手动固定 FFT 网格维度**，数值来源于 2.1.3 节中记录的 System AB 的日志。

**System A/B 的 INPUT 追加参数：**
```bash
# 手动固定 FFT 网格，确保与 System AB 完全一致
# 注意：参数名可能随版本略有不同，请查阅文档确认是 nx/ny/nz 或 nr1/nr2/nr3
nx              108 
ny              108
nz              144

symmetry        -1    # 同样必须保持关闭
out_chg         1     # 同样需要输出电荷
```

### 2.2.3 LCAO 基组的特殊考量（Ghost Atom）
如果你使用的是 `basis_type lcao`：
*   **直接移除原子**：意味着同时也移除了该原子所携带的原子轨道基组。这在物理上对应的是“将 B 移至无穷远”。这是计算成键电荷密度的标准做法。
*   **Ghost Atom（鬼原子）**：如果你需要极高精度的基组重叠误差（BSSE）校正，或者分析的是特定轨道杂化，可能需要将 B 原子设为“Ghost Atom”（保留基组但不含核电荷与电子）。
    *   *本教程采用标准做法（直接移除原子），适合绝大多数界面与成键分析。*

---

## 2.3 常见陷阱自检（Self-Check）

在进行最终的减法处理之前（将在第三章介绍），请务必执行以下“三查”：

1.  **查收敛性**：
    检查 `OUT.A/running_scf.log` 和 `OUT.B/running_scf.log`，确认 `TOTAL-FORCE` 和 `ETOT` 均已达到收敛标准。孤立体系有时比完整体系更难收敛（因为存在悬挂键），若不收敛，需调整 `mixing_beta`。

2.  **查网格维度（Grid Match）**：
    使用 `grep` 命令快速对比三个计算的网格是否严格一致。
    ```bash
    grep "FFT grid" OUT.*/running_scf.log
    ```
    **预期输出（必须完全相同）：**
    ```text
    OUT.AB/running_scf.log: FFT grid for charge/potential:  108 * 108 * 144
    OUT.A/running_scf.log:  FFT grid for charge/potential:  108 * 108 * 144
    OUT.B/running_scf.log:  FFT grid for charge/potential:  108 * 108 * 144
    ```

3.  **查输出文件**：
    确认目录下生成了对应的电荷密度文件（通常为 `SPIN1_CHG.cube` 或 `density.cube`，具体取决于版本和设置）。

---

**下一步预告**：
现在你已经手握三份在空间上完美对齐的“数字地图”（$\rho_{AB}, \rho_A, \rho_B$）。在第三章中，我们将使用 Python 脚本或后处理工具，对这些地图进行像素级的减法运算，揭示出隐藏在原子间隙中的电子转移秘密。

# 第三章：数据后处理与可视化

在完成了繁重的 SCF 迭代与几何优化后，我们手中的 `.cube` 文件就像是埋藏着物理规律的“原石”。本章的任务，就是通过数学切割（矩阵运算）和光学打磨（可视化），将这些数据转化为能够发表在顶级期刊上的精美图表。

作为开发者，我必须坦诚地告诉你：**ABACUS 内核专注于高效求解薛定谔方程，而非图形渲染。** 因此，本章将重点讲解如何构建“ABACUS + Python/VESTA”的黄金工作流。

---

## Section 3.1: 数据的矩阵运算（差分电荷密度）

差分电荷密度（Charge Density Difference）是分析电荷转移（Charge Transfer）最直观的工具。其核心定义为：
$$ \Delta \rho = \rho_{AB} - \rho_A - \rho_B $$
其中 $\rho_{AB}$ 是总体系电荷密度，$\rho_A$ 和 $\rho_B$ 是保持原子位置不变的孤立部分电荷密度。

### 3.1.1 核心流程：严谨的“三步走”

**特别注意**：ABACUS **不会**直接输出差分电荷密度文件。你必须手动设计三次独立的计算任务。

#### 第一步：计算总体系 (AB)
在 `INPUT` 文件中开启电荷密度输出：
```bash
INPUT_PARAMETERS
# ... 其他参数 ...
out_chg  1       # 开启电荷密度输出，生成 SPIN1_CHG.cube
symmetry 0       # 【关键】关闭对称性，防止格点还原时的旋转误差
```
运行后，将生成的 `SPIN1_CHG.cube` 重命名为 `rho_AB.cube`。

#### 第二步：计算分体系 (A)
修改 `STRU` 文件，**删除** B 部分的原子，但**必须保留** A 部分原子的坐标和晶胞（Lattice）参数完全不变。
*   **LCAO 基组用户的特殊提示**：
    在原子轨道（LCAO）基组下，直接删除原子意味着同时也删除了该原子携带的基函数（Basis Set）。这会导致基组重叠误差（BSSE）。
    *   **常规做法**：直接删除原子。这在定性分析成键时通常是可以接受的。
    *   **高精度做法**：引入“鬼原子”（Ghost Atom）。在 ABACUS 中，这通常需要通过修改元素类型或赝势来实现（即保留基组但不包含核电荷与电子），操作较为高阶。对于初学者，建议先采用“直接删除法”，但需知晓其物理局限性。

#### 第三步：计算分体系 (B)
同理，删除 A 部分原子，计算得到 `rho_B.cube`。

### 3.1.2 风险管控：FFT 网格陷阱

这是新手最容易“翻车”的地方。
$$ \rho_{AB}, \rho_A, \rho_B \text{ 必须定义在完全相同的 FFT 网格上！} $$

ABACUS 会根据晶胞大小和 `ecutwfc` 自动生成 FFT 网格。虽然晶胞不变通常网格也不变，但为了万无一失：
1.  检查第一步计算的日志文件（如 `OUT.ABACUS/running_scf.log`）。
2.  搜索 `FFT GRID` 关键字，找到类似 `108 108 144` 的数值。
3.  （可选但推荐）在第二、三步的 `INPUT` 中显式固定该网格（如果 ABACUS 版本支持直接指定 FFT 参数），或者务必确保 `ecutwfc` 和晶胞参数与第一步**完全一致**。

### 3.1.3 实战脚本：Python 矩阵相减

由于 `.cube` 文件本质上是带头信息的 3D 矩阵，我们可以使用 Python 脚本轻松完成运算。

**脚本示例 (`calc_diff.py`)**:
```python
import numpy as np

def read_cube(fname):
    with open(fname, 'r') as f:
        lines = f.readlines()
    
    # 解析 Header (前6行是标准Cube格式头信息)
    natoms = int(lines[2].split()[0])
    # 数据从 header + natoms 行之后开始
    start_idx = 6 + natoms
    
    # 提取网格数据
    data = []
    for line in lines[start_idx:]:
        data.extend([float(x) for x in line.split()])
    
    return np.array(data), lines[:start_idx]

def write_cube(fname, data, header):
    with open(fname, 'w') as f:
        f.writelines(header)
        # 格式化输出，每行6个数据
        for i, val in enumerate(data):
            f.write(f"{val:13.5E}")
            if (i + 1) % 6 == 0:
                f.write("\n")
            elif (i + 1) == len(data): # 最后一行
                f.write("\n")

# 主程序
print("Reading rho_AB...")
rho_AB, header = read_cube("rho_AB.cube")
print("Reading rho_A...")
rho_A, _ = read_cube("rho_A.cube")
print("Reading rho_B...")
rho_B, _ = read_cube("rho_B.cube")

# 核心运算：矩阵相减
if len(rho_AB) != len(rho_A) or len(rho_AB) != len(rho_B):
    print("Error: Grid sizes do not match! Check your FFT grids.")
    exit()

rho_diff = rho_AB - rho_A - rho_B

print("Writing rho_diff.cube...")
write_cube("rho_diff.cube", rho_diff, header)
print("Done!")
```

---

## Section 3.2: VESTA 可视化实战

拿到 `rho_diff.cube` 后，我们使用 VESTA 进行可视化。

### 3.2.1 导入与初步设置
1.  打开 VESTA，拖入 `rho_diff.cube`。
2.  此时你可能会看到一个充满整个晶胞的混乱色块，不要慌，这是因为默认的等值面（Isosurface）阈值太低。

### 3.2.2 调整等值面 (Isosurfaces)
1.  点击左侧面板的 **Properties** -> **Isosurfaces**。
2.  **设置正值（电荷积聚）**:
    *   点击列表中的第一项。
    *   **Isosurface level**: 设置为一个合理的正值，例如 `0.002`（具体数值取决于体系大小和电荷转移量，需尝试）。
    *   **Color**: 建议设置为 **黄色** (Yellow)，代表电子获得区域。
3.  **设置负值（电荷耗散）**:
    *   点击 "New" 增加一个等值面。
    *   **Isosurface level**: 设置为对应的负值，例如 `-0.002`。
    *   **Color**: 建议设置为 **青色** (Cyan) 或 **蓝色**，代表电子失去区域。
4.  点击 OK，你将看到清晰的电荷转移图像：电子从蓝色区域流向了黄色区域。

---

## Section 3.3: 定量分析与单位换算

漂亮的图片用于展示，严谨的数据用于论证。在处理 ABACUS 数据时，单位是最大的“坑”。

### 3.3.1 单位陷阱：1/Bohr³
ABACUS 的 `.cube` 文件输出单位默认为 **原子单位 (Atomic Units)**，即：
$$ \text{Unit} = \frac{e}{\text{Bohr}^3} $$

而在文献中，我们通常习惯使用 $e/\text{\AA}^3$。
*   **换算关系**: 1 Bohr $\approx$ 0.529177 $\AA$。
*   **体积因子**: $1 \text{ Bohr}^3 \approx 0.1482 \text{ \AA}^3$。
*   **密度换算公式**:
    $$ \rho (e/\text{\AA}^3) = \rho (e/\text{Bohr}^3) \times 6.748 $$

**警示**：当你进行平面平均电荷密度（Planar Average）或线性电荷分布分析时，务必乘上这个系数，否则你的电荷密度数值将比文献值小一个数量级！

### 3.3.2 Bader 电荷分析前置
虽然差分电荷密度给出了空间的分布，但有时我们需要知道“每个原子具体得失了多少电子”。这就需要 **Bader 电荷分析**。
*   **原理**: 基于电子密度的零通量面（Zero-flux surface）划分原子体积。
*   **操作**:
    1.  使用 Section 3.1 得到的高精度 `rho_AB.cube`（总电荷密度）。
    2.  使用 Henkelman 组开发的 `bader` 程序。
    3.  命令：`bader rho_AB.cube`。
    4.  输出文件 `ACF.dat` 中包含了每个原子的价电子总数。
    5.  **电荷转移量** = `Z_valence` (赝势价电子数) - `Q_bader` (Bader分析出的电子数)。

---

**本章小结**：
从 `.cube` 到差分图，再到 Bader 电荷，我们完成了从“算出数”到“看懂物理图像”的跨越。下一章，我们将进入更激动人心的领域：**能带结构与态密度（DOS）的计算与分析**。

# 第四章：进阶应用——能带分解电荷密度

在前一章中，我们掌握了总电荷密度的计算与差分分析。然而，在催化机理研究、STM 图像模拟或缺陷态分析中，仅仅知道“总电子分布”往往是不够的。我们需要深入微观层面，回答诸如“**费米面附近的电子长什么样？**”、“**HOMO/LUMO 轨道分布在哪里？**”或“**特定的缺陷能级是由哪个原子的哪个轨道贡献的？**”等问题。

这就需要用到**能带分解电荷密度**（Band-Decomposed Charge Density），常被称为**Partial Charge Density (PCHG)**。

本章将指导你如何从成百上千条能带中，精准提取出你关心的那几条，并将其可视化。由于 ABACUS 的双基组特性，**PW（平面波）**与 **LCAO（原子轨道）**在此功能的实现逻辑上存在显著差异，请务必根据你的计算设置选择对应的阅读小节。

---

## 4.1 平面波（PW）基组下的能带分解

在平面波基组下，波函数天然弥散在整个空间，计算特定能带的电荷密度相对直观，通常可以在 SCF 自洽计算过程中直接输出。

### 4.1.1 核心参数设置

在 `INPUT` 文件中，除了常规的 SCF 参数外，你需要添加以下控制参数：

```bash
# INPUT for PW Basis Partial Charge
basis_type      pw
calculation     scf

# 输出控制
out_chg         1       # 输出电荷密度
out_bandgap     1       # 推荐开启，便于在日志中确认 HOMO/LUMO 的能带索引
out_wfc_pw      0       # 通常不需要输出波函数文件，除非做 Wannier90

# 核心参数：指定输出的能带
# 语法：bands_to_print band_index1 band_index2 ...
# 注意：能带索引从 1 开始
bands_to_print  10 11 12
```

### 4.1.2 实战技巧：如何确定 `bands_to_print`？

你不可能在计算前就知道 HOMO 是第几条能带。通常的流程是：
1.  **预计算**：先跑一个普通的 `scf` 或 `nscf` 计算。
2.  **查阅日志**：查看 `OUT.suffix/running_scf.log` 或 EIGENVAL 文件，找到费米能级（Fermi Energy）附近的能带索引。
3.  **设置参数**：在 `INPUT` 中填入感兴趣的索引（例如 HOMO 为 10，LUMO 为 11），再次运行（或在 NSCF 步运行）。

### 4.1.3 输出文件

计算完成后，你会在输出目录中找到类似 `rho_k0_b10.cube` 的文件（命名格式可能随版本微调，通常包含 k 点索引和 band 索引）。

> **⚠️ 专家提示**：
> 如果你的体系有自旋极化（`nspin 2`），输出文件会区分自旋通道（如 `up` / `down`）。务必检查文件名后缀。

---

## 4.2 原子轨道（LCAO）基组下的特殊流程

LCAO 基组的计算效率极高，但其波函数是以原子轨道系数形式存储的。要获得实空间的能带电荷密度，ABACUS 采用**“两步法”**策略：先计算电子结构，再后处理重构实空间密度。

### 4.2.1 第一步：完成 SCF 计算

首先，进行一次标准的 SCF 计算，确保电子步收敛，并保存波函数系数。

**INPUT (Step 1):**
```bash
basis_type      lcao
calculation     scf
out_wfc_lcao    1      # 必须输出 LCAO 波函数系数，供第二步读取
directory       OUT.step1
```

### 4.2.2 第二步：运行 `get_pchg`

SCF 结束后，**不要删除输出文件夹**。修改 `INPUT` 文件，将计算类型改为 `get_pchg`，并指定要读取的轨道文件和需要输出的能带。

**INPUT (Step 2):**
```bash
basis_type      lcao
calculation     get_pchg   # 关键：指定计算类型为提取部分电荷
read_file_dir   OUT.step1  # 指定第一步结果的路径

# 指定输出的能带索引
bands_to_print  30 31

# 必须再次指定轨道文件路径（与 Step 1 保持一致）
orbital_dir     /path/to/your/pseudopotentials/
```

运行 ABACUS（通常只需单核即可快速完成），程序会读取第一步的收敛波函数，重构出第 30 和 31 条能带的实空间电荷密度，并输出为 `.cube` 文件。

---

## 4.3 进阶分析：差分电荷密度的“三步走”铁律

在掌握了如何输出特定电荷密度后，很多同学会尝试做“差分”分析（例如：吸附前后的电荷转移）。这里必须再次强调一个**新手最容易犯的错误**：

> **❌ 错误认知**：认为 ABACUS 可以通过设置某个参数（如 `calculate_diff = 1`）直接输出差分电荷密度文件。

> **✅ 正确流程**：ABACUS **不直接输出**差分文件。所有差分分析（无论是总电荷还是能带分解电荷）都必须遵循**“三步走 + 后处理”**流程。

### 标准操作流程（以吸附体系 AB 为例）：

1.  **计算整体 AB**：得到 `rho_AB.cube`。
2.  **计算碎片 A**：
    *   **关键**：移除 B 原子，但**必须保持晶胞尺寸（Cell）和 FFT 网格（Grid）与 AB 完全一致**。
    *   得到 `rho_A.cube`。
3.  **计算碎片 B**：
    *   同理，移除 A 原子，保持晶胞和网格不变。
    *   得到 `rho_B.cube`。
4.  **脚本相减**：
    *   使用 Python 脚本或 `chg_diff.py` 工具执行：$\Delta \rho = \rho_{AB} - \rho_{A} - \rho_{B}$。

**为什么这很重要？**
如果在计算碎片 A 和 B 时，程序自动重新优化了 FFT 网格（例如因为原子变少了，程序觉得不需要那么密的网格），那么 `rho_AB` 和 `rho_A` 的数据点数量将不匹配，导致无法进行点对点相减。**这是导致差分分析失败的头号原因。**

---

## 附录：常见问题与进阶建议

### 1. 致命的“网格不匹配” (Grid Mismatch)
如上所述，进行差分分析时，必须强制固定 FFT 网格。
*   **如何做**：
    1.  先运行 AB 的 SCF 初始化。
    2.  在输出日志（log）中查找 `FFT grid` 关键词，找到 `nx, ny, nz` 的数值（例如 `120 120 120`）。
    3.  在计算碎片 A 和 B 的 `INPUT` 文件中，显式写入：
        ```bash
        nx  120
        ny  120
        nz  120
        ```
    这将强制 ABACUS 使用指定的网格，确保所有 cube 文件尺寸一致。

### 2. 对称性陷阱 (Symmetry Trap)
在输出实空间数据（Cube 文件）用于可视化时，强烈建议关闭对称性。
*   **参数**：`symmetry -1` (或 `0`，视版本而定，`-1` 意为完全关闭对称性分析)。
*   **原因**：开启对称性（`symmetry 1`）时，程序可能会利用对称操作减少存储量或计算量（IBZ k-points）。但在还原回实空间 Cube 文件时，如果处理不当，可能会导致电荷密度在空间上出现“缺块”或坐标映射错误。关闭对称性虽然会略微增加计算量，但能保证输出数据的几何完整性。

### 3. Ghost Atom（鬼原子）与 LCAO
在 LCAO 基组下计算吸附能或差分电荷时，为了消除基组重叠误差（BSSE），在计算碎片（如单独的表面）时，通常建议保留吸附分子的“基函数”但不保留“原子核”和“电子”。
*   **ABACUS 实现**：这通常通过将原子类型标记为 Ghost 来实现（具体需查阅 `STRU` 文件的高级设置或使用 `ghost_atom` 相关参数）。这对于高精度的 LCAO 差分分析是必须的，否则 $\rho_{AB}$ 和 $\rho_{A} + \rho_{B}$ 的希尔伯特空间不完备性差异会掩盖真实的物理效应。

### 4. 收敛困难处理
对于表面或带电体系的能带分解计算，如果 SCF 难以收敛：
*   尝试更改 `mixing_type` 为 `pulay` 或 `broyden`。
*   减小 `mixing_beta`（例如从默认的 0.7 降至 0.2）。
*   对于金属体系，适当增加 `smearing_sigma`。

---

## 附录：进阶学习指南

完成本书的学习只是你科研征程的起点。为了帮助你在第一性原理计算领域走得更远，我们整理了以下进阶建议：

### 1. 深入底层算法
如果你在计算复杂体系（如金属界面或大体系磁性结构）时遇到 SCF 不收敛的问题，建议深入研读**电荷密度混合算法**。ABACUS 实现了多种先进的混合策略（如作者孙亮、审核陈默涵教授介绍的混合算法），理解这些数学背后的物理逻辑，能帮助你更有效地调整 `mixing_type` 和 `mixing_beta` 参数。

### 2. 探索密度矩阵（DMR）与波函数
对于使用 LCAO 基组的用户，电荷密度的生成本质上是密度矩阵与原子轨道叠加的结果。进一步学习 ABACUS 输出的 `DMR` 文件和波函数分析，可以让你开展更深入的电子布居分析（Mulliken/Löwdin Analysis）以及轨道投影能带结构研究。

### 3. 常见问题调试（Troubleshooting）
- **网格对齐问题**：在做差分电荷密度时，必须确保分体系与总体系的 `lat0`、`latvec` 以及 `bx, by, bz`（网格划分）完全一致，否则相减结果将毫无物理意义。
- **LCAO 基组完整性**：能带分解电荷密度的准确性高度依赖于数值原子轨道的截断半径和基组完备性，建议在正式计算前进行基组收敛性测试。
- **能量截断（Cutoff）**：确保平面波截断能足够大，以保证空间电荷分布的平滑度。

### 4. 推荐资源
- **ABACUS 官方文档**：始终是获取最新参数说明和功能更新的第一出处。
- **Bohrium 科学计算平台**：推荐查阅关于偶极矩、极化率及几何优化算法的深度文章，这些与电荷密度分布息息相关。
- **开源社区**：积极参与 ABACUS 的 GitHub 讨论组，与开发者直接交流。

科学探索的过程往往伴随着枯燥的调试，但当你第一次在 VESTA 中看到电荷在原子间跃动、成键的瞬间，所有的努力都将获得回报。祝你在计算材料学的世界里发现属于你的科学之美！
