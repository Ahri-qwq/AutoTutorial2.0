# 第四章：进阶应用——能带分解电荷密度

在前一章中，我们掌握了总电荷密度的计算与差分分析。然而，在催化机理研究、STM 图像模拟或缺陷态分析中，仅仅知道“总电子分布”往往是不够的。我们需要深入微观层面，回答诸如“**费米面附近的电子长什么样？**”、“**HOMO/LUMO 轨道分布在哪里？**”或“**特定的缺陷能级是由哪个原子的哪个轨道贡献的？**”等问题。

这就需要用到**能带分解电荷密度**（Band-Decomposed Charge Density），常被称为**Partial Charge Density (PCHG)**。

本章将指导你如何从成百上千条能带中，精准提取出你关心的那几条，并将其可视化。由于 ABACUS 的双基组特性，**PW（平面波）**与 **LCAO（原子轨道）**在此功能的实现逻辑上存在显著差异，请务必根据你的计算设置选择对应的阅读小节。

---

## 4.1 平面波（PW）基组下的能带分解

在平面波基组下，波函数天然弥散在整个空间，计算特定能带的电荷密度相对直观，通常可以在 SCF 自洽计算过程中直接输出。

### 4.1.1 核心参数设置

在 `INPUT` 文件中，除了常规的 SCF 参数外，你需要添加以下控制参数：

```bash
# INPUT for PW Basis Partial Charge
basis_type      pw
calculation     scf

# 输出控制
out_chg         1       # 输出电荷密度
out_bandgap     1       # 推荐开启，便于在日志中确认 HOMO/LUMO 的能带索引
out_wfc_pw      0       # 通常不需要输出波函数文件，除非做 Wannier90

# 核心参数：指定输出的能带
# 语法：bands_to_print band_index1 band_index2 ...
# 注意：能带索引从 1 开始
bands_to_print  10 11 12
```

### 4.1.2 实战技巧：如何确定 `bands_to_print`？

你不可能在计算前就知道 HOMO 是第几条能带。通常的流程是：
1.  **预计算**：先跑一个普通的 `scf` 或 `nscf` 计算。
2.  **查阅日志**：查看 `OUT.suffix/running_scf.log` 或 EIGENVAL 文件，找到费米能级（Fermi Energy）附近的能带索引。
3.  **设置参数**：在 `INPUT` 中填入感兴趣的索引（例如 HOMO 为 10，LUMO 为 11），再次运行（或在 NSCF 步运行）。

### 4.1.3 输出文件

计算完成后，你会在输出目录中找到类似 `rho_k0_b10.cube` 的文件（命名格式可能随版本微调，通常包含 k 点索引和 band 索引）。

> **⚠️ 专家提示**：
> 如果你的体系有自旋极化（`nspin 2`），输出文件会区分自旋通道（如 `up` / `down`）。务必检查文件名后缀。

---

## 4.2 原子轨道（LCAO）基组下的特殊流程

LCAO 基组的计算效率极高，但其波函数是以原子轨道系数形式存储的。要获得实空间的能带电荷密度，ABACUS 采用**“两步法”**策略：先计算电子结构，再后处理重构实空间密度。

### 4.2.1 第一步：完成 SCF 计算

首先，进行一次标准的 SCF 计算，确保电子步收敛，并保存波函数系数。

**INPUT (Step 1):**
```bash
basis_type      lcao
calculation     scf
out_wfc_lcao    1      # 必须输出 LCAO 波函数系数，供第二步读取
directory       OUT.step1
```

### 4.2.2 第二步：运行 `get_pchg`

SCF 结束后，**不要删除输出文件夹**。修改 `INPUT` 文件，将计算类型改为 `get_pchg`，并指定要读取的轨道文件和需要输出的能带。

**INPUT (Step 2):**
```bash
basis_type      lcao
calculation     get_pchg   # 关键：指定计算类型为提取部分电荷
read_file_dir   OUT.step1  # 指定第一步结果的路径

# 指定输出的能带索引
bands_to_print  30 31

# 必须再次指定轨道文件路径（与 Step 1 保持一致）
orbital_dir     /path/to/your/pseudopotentials/
```

运行 ABACUS（通常只需单核即可快速完成），程序会读取第一步的收敛波函数，重构出第 30 和 31 条能带的实空间电荷密度，并输出为 `.cube` 文件。

---

## 4.3 进阶分析：差分电荷密度的“三步走”铁律

在掌握了如何输出特定电荷密度后，很多同学会尝试做“差分”分析（例如：吸附前后的电荷转移）。这里必须再次强调一个**新手最容易犯的错误**：

> **❌ 错误认知**：认为 ABACUS 可以通过设置某个参数（如 `calculate_diff = 1`）直接输出差分电荷密度文件。

> **✅ 正确流程**：ABACUS **不直接输出**差分文件。所有差分分析（无论是总电荷还是能带分解电荷）都必须遵循**“三步走 + 后处理”**流程。

### 标准操作流程（以吸附体系 AB 为例）：

1.  **计算整体 AB**：得到 `rho_AB.cube`。
2.  **计算碎片 A**：
    *   **关键**：移除 B 原子，但**必须保持晶胞尺寸（Cell）和 FFT 网格（Grid）与 AB 完全一致**。
    *   得到 `rho_A.cube`。
3.  **计算碎片 B**：
    *   同理，移除 A 原子，保持晶胞和网格不变。
    *   得到 `rho_B.cube`。
4.  **脚本相减**：
    *   使用 Python 脚本或 `chg_diff.py` 工具执行：$\Delta \rho = \rho_{AB} - \rho_{A} - \rho_{B}$。

**为什么这很重要？**
如果在计算碎片 A 和 B 时，程序自动重新优化了 FFT 网格（例如因为原子变少了，程序觉得不需要那么密的网格），那么 `rho_AB` 和 `rho_A` 的数据点数量将不匹配，导致无法进行点对点相减。**这是导致差分分析失败的头号原因。**

---

## 附录：常见问题与进阶建议

### 1. 致命的“网格不匹配” (Grid Mismatch)
如上所述，进行差分分析时，必须强制固定 FFT 网格。
*   **如何做**：
    1.  先运行 AB 的 SCF 初始化。
    2.  在输出日志（log）中查找 `FFT grid` 关键词，找到 `nx, ny, nz` 的数值（例如 `120 120 120`）。
    3.  在计算碎片 A 和 B 的 `INPUT` 文件中，显式写入：
        ```bash
        nx  120
        ny  120
        nz  120
        ```
    这将强制 ABACUS 使用指定的网格，确保所有 cube 文件尺寸一致。

### 2. 对称性陷阱 (Symmetry Trap)
在输出实空间数据（Cube 文件）用于可视化时，强烈建议关闭对称性。
*   **参数**：`symmetry -1` (或 `0`，视版本而定，`-1` 意为完全关闭对称性分析)。
*   **原因**：开启对称性（`symmetry 1`）时，程序可能会利用对称操作减少存储量或计算量（IBZ k-points）。但在还原回实空间 Cube 文件时，如果处理不当，可能会导致电荷密度在空间上出现“缺块”或坐标映射错误。关闭对称性虽然会略微增加计算量，但能保证输出数据的几何完整性。

### 3. Ghost Atom（鬼原子）与 LCAO
在 LCAO 基组下计算吸附能或差分电荷时，为了消除基组重叠误差（BSSE），在计算碎片（如单独的表面）时，通常建议保留吸附分子的“基函数”但不保留“原子核”和“电子”。
*   **ABACUS 实现**：这通常通过将原子类型标记为 Ghost 来实现（具体需查阅 `STRU` 文件的高级设置或使用 `ghost_atom` 相关参数）。这对于高精度的 LCAO 差分分析是必须的，否则 $\rho_{AB}$ 和 $\rho_{A} + \rho_{B}$ 的希尔伯特空间不完备性差异会掩盖真实的物理效应。

### 4. 收敛困难处理
对于表面或带电体系的能带分解计算，如果 SCF 难以收敛：
*   尝试更改 `mixing_type` 为 `pulay` 或 `broyden`。
*   减小 `mixing_beta`（例如从默认的 0.7 降至 0.2）。
*   对于金属体系，适当增加 `smearing_sigma`。