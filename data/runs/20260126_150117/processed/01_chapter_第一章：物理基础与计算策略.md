# 第一章：物理基础与计算策略

在正式开始操作 ABACUS 进行计算之前，我们必须先构建清晰的物理图像和计算策略。很多初学者容易陷入“拿到软件就跑任务”的误区，最后发现算出的数据无法进行物理分析。

对于**差分电荷密度（Charge Density Difference）** 这一课题，核心难点不在于如何写 INPUT 文件，而在于如何设计一套严格的**“扣除流程”**，以确保相减的物理量在空间上是严格对齐的。

本章将为你建立这一理论框架。

---

## 1.1 差分电荷密度的物理图景

### 什么是电荷重排？
当两个独立的原子或分子片段结合成一个整体时，它们的电子云并不会简单地叠加，而是会发生**重排（Redistribution）**。电子会从高势能区域流向低势能区域，或者在原子核之间聚集形成化学键。

差分电荷密度 $\Delta \rho(\mathbf{r})$ 正是用来描述这种**“变化量”**的物理量。其定义公式如下：

$$
\Delta \rho(\mathbf{r}) = \rho_{AB}(\mathbf{r}) - \rho_A(\mathbf{r}) - \rho_B(\mathbf{r})
$$

其中：
- $\rho_{AB}(\mathbf{r})$：相互作用后的整体体系（AB）的电荷密度。
- $\rho_A(\mathbf{r})$：保持在 AB 中几何构型的孤立片段 A 的电荷密度。
- $\rho_B(\mathbf{r})$：保持在 AB 中几何构型的孤立片段 B 的电荷密度。

### 物理意义解读
通过分析 $\Delta \rho(\mathbf{r})$ 的空间分布，我们可以直观地看到：
- **正值区域（$\Delta \rho > 0$）**：电子**积聚**区。通常出现在成键区域（共价键）或电负性较强的原子附近。
- **负值区域（$\Delta \rho < 0$）**：电子**耗损**区。通常出现在被极化的原子核附近。

这为我们理解界面电荷转移、化学键的强弱以及吸附机理提供了最直接的证据。

---

## 1.2 ABACUS 中的“三步走”构建策略

### 核心原则：ABACUS 不直接输出差分结果
作为开发者，我必须向大家强调一个关键点：**ABACUS 内核（以及绝大多数 DFT 软件）在单次 SCF 计算中，只负责输出当前体系的总电荷密度（Total Charge Density），不会自动计算差分值。**

因此，我们需要人为设计一个**“三步走”**的计算流程，分别得到三个独立的电荷密度文件（通常为 `.cube` 格式），最后在后处理阶段进行数学相减。

### 策略详解
为了保证 $\rho_{AB}$、$\rho_A$ 和 $\rho_B$ 能够在空间网格上点对点相减，必须严格遵守以下操作规范：

#### 第一步：计算整体体系 AB
- **目标**：获得 $\rho_{AB}$。
- **操作**：进行标准的自洽场（SCF）计算。
- **关键输出**：开启电荷密度输出参数（`out_chg 1`），获得 `SPIN1_CHG.cube`（或类似命名）。

#### 第二步：计算孤立部分 A
- **目标**：获得 $\rho_A$。
- **操作**：
    1.  **继承晶胞**：必须使用与 AB 完全相同的晶胞参数（Lattice Vectors）。**严禁进行晶胞弛豫（vc-relax）。**
    2.  **继承坐标**：保留 A 部分的原子坐标，**且必须保持其在 AB 中的绝对位置不变**。直接删除 B 部分的原子。
    3.  **冻结原子**：严禁进行离子步弛豫（relax），必须进行静态计算（scf）。
- **物理含义**：这代表了“如果 B 不存在，A 在这个位置原本的电子分布”。

#### 第三步：计算孤立部分 B
- **目标**：获得 $\rho_B$。
- **操作**：同上，保留 B 部分原子，删除 A 部分原子。保持晶胞和坐标严格冻结。

---

## 1.3 避坑指南：对称性与网格陷阱（Critical）

在执行上述“三步走”时，有两个极易被忽视的技术细节，一旦出错，会导致差分结果完全变成“噪音”。

### 1. 强制关闭对称性 (`symmetry -1`)
在计算孤立体系 A 或 B 时，由于原子数量减少，体系的对称性可能会发生变化（通常会升高或改变点群）。
- **风险**：如果开启对称性分析，ABACUS 可能会根据 A 的新对称性自动约化 k 点或调整实空间 FFT 网格的取向。这将导致 $\rho_A$ 的网格点与 $\rho_{AB}$ **无法一一对应**。
- **解决方案**：在所有三步计算的 `INPUT` 文件中，必须显式设置：
  ```bash
  INPUT_PARAMETERS
  # ... 其他参数 ...
  symmetry    -1    # 强制关闭对称性分析，确保不进行空间群操作
  ```
  *注：虽然部分版本 `symmetry 0` 亦可，但 `-1` 是更为彻底的开发者建议，确保完全禁用对称性操作，保证 Grid 数据与原子坐标的原始映射。*

### 2. 锁定 FFT 网格 (FFT Grid Consistency)
差分的前提是矩阵相减，这意味着三个 `.cube` 文件的网格尺寸（Nx, Ny, Nz）必须完全一致。
- **风险**：虽然 `ecutwfc`（波函数截断能）决定了网格密度，但在不同体系（AB vs A）中，自动算法可能因微小的数值差异导致 FFT 网格点数出现 $\pm 1$ 的偏差。
- **解决方案**：
    1.  先运行 AB 体系的计算。
    2.  检查输出日志（如 `running_scf.log` 或 `OUT.ABACUS/` 下的文件），找到类似 `FFT grid` 或 `fft_nx`, `fft_ny`, `fft_nz` 的数值。
    3.  **（强烈建议）** 如果 ABACUS 版本支持手动固定 FFT 网格，请在 A 和 B 的计算中显式指定这些参数（请查阅对应版本的官方文档确认参数名）。
    4.  **（通用做法）** 只要严格保持 `ecutwfc` 和晶胞参数（Cell）完全一致，并配合 `symmetry -1`，通常可以保证网格一致。**但在进行减法前，务必检查三个 cube 文件的头部信息，确认网格维数完全相同！**

### 3. LCAO 基组下的特殊说明
如果你使用的是原子轨道基组（`basis_type lcao`）：
- 上述“直接删除原子”的方法计算的是**原子形变密度（Deformation Density）**，即相对于孤立原子的电荷转移，这是最常用的分析方法。
- 如果需要计算涉及基组重叠误差（BSSE）的相互作用能，或者需要更精细的轨道分析，可能需要引入 **Ghost Atom**（鬼原子：有基函数但无核电荷和电子的原子）。但在标准的差分电荷密度图绘制中，通常采用上述物理定义的“三步走”即可。

---

**本章小结**：
我们已经明确了目标：通过三次独立的、固定晶胞和坐标的、关闭对称性的 SCF 计算，分别获取 $\rho_{AB}$、$\rho_A$ 和 $\rho_B$。下一章，我们将进入实战环节，手把手教你编写输入文件。