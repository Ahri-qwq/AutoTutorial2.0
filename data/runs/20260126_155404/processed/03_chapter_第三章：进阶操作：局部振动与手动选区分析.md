# 第三章：进阶操作：局部振动与手动选区分析

在表面催化、缺陷物理或大分子吸附的研究中，我们往往只关注体系中**一小部分原子的振动属性**（例如吸附分子的伸缩振动、缺陷位点的局部声子模）。对包含数百个原子的整个板层（Slab）进行全自由度的声子计算不仅极其昂贵，而且往往是不必要的。

在 VASP 等软件中，我们可以通过 `Selective Dynamics` 轻松实现这一点。然而，目前的 **ABACUS + Phonopy** 接口尚未完全支持自动化的“部分原子微扰”功能。

本章将教授你一套**世界级开发者常用**的高阶“手动替代方案”。这套方案虽然需要一定的手动操作技巧，但它能让你在处理几百个原子的体系时，仅针对关键的几个原子进行计算，从而节省 90% 以上的计算资源。

---

## 3.1 接口限制与手动方案设计

### 3.1.1 为什么不能直接“固定”？
通常，Phonopy 生成位移（Displacement）时，会读取结构文件并对超胞内的原子进行对称性分析和微扰。如果直接对整个大体系使用 Phonopy，它会默认计算所有原子的 3N 个自由度。

虽然 ABACUS 的 `STRU` 文件支持 `m_x, m_y, m_z` (0/1) 来固定原子弛豫，但这仅针对几何优化（Relaxation）和分子动力学（MD）。在声子计算中，我们需要人为地**仅对目标原子施加微扰**，并**仅提取目标原子的受力**。

### 3.1.2 “剪切-微扰-拼接”工作流
为了绕过接口限制，我们采用以下逻辑：

1.  **剪切 (Cut)**: 从优化好的完整 `STRU` 中，将“目标原子（Active Atoms）”和“背景原子（Frozen Atoms）”在逻辑上分离。
2.  **微扰 (Perturb)**: 仅将“目标原子”作为独立结构输入给 Phonopy，生成微扰后的坐标文件。
3.  **拼接 (Paste)**: 将微扰后的“目标原子”坐标，填回“背景原子”的空缺中，生成一系列完整的 ABACUS `STRU` 文件。
4.  **计算 (Calc)**: 运行 ABACUS 计算受力。
5.  **清洗 (Clean)**: 从输出中提取受力，剔除背景原子的噪音，生成 `FORCE_SETS`。

---

## 3.2 结构重组与索引一致性实战

这是本章最核心、风险最高的部分。**原子索引（Index）的一致性是成败的关键**。

### 3.2.1 准备工作：原子排序
在开始之前，建议重新整理你的 `STRU` 文件，将**需要振动的原子放在最后**（或最前），并保持元素类型连续。

**示例场景**：
Pt(111) 表面吸附一个 CO 分子。
- 总原子数：48 Pt + 1 C + 1 O = 50 原子。
- 目标：只计算 C 和 O 的振动。

**推荐的 `STRU` 结构顺序**：
```
ATOMIC_POSITIONS
Direct
Pt
0.0 0.0 0.0 0 0 0
... (47个 Pt 原子) ...
C
0.5 0.5 0.6 1 1 1  <-- 目标原子 1 (Index 49)
O
0.5 0.5 0.7 1 1 1  <-- 目标原子 2 (Index 50)
```

### 3.2.2 生成微扰 (Phonopy 侧)
我们需要欺骗 Phonopy，让它以为体系只有 C 和 O 两个原子。

1.  创建一个名为 `POSCAR_part` 的文件，**只包含 C 和 O 的坐标**（保持晶格大小与原体系一致，或者设为足够大的盒子）。
2.  运行 Phonopy 生成微扰：
    ```bash
    # 这里的 1 1 1 表示不扩胞，因为我们是在原胞内做局部振动
    phonopy -d --dim="1 1 1" -c POSCAR_part
    ```
3.  这将生成 `POSCAR-001`, `POSCAR-002` ... 等文件。这些文件里只有 2 个原子，且发生了微小的位移。

### 3.2.3 拼接结构 (ABACUS 侧)
现在我们需要将 `POSCAR-00X` 中的坐标，替换回完整 `STRU` 文件中的最后两行。

**手动操作逻辑**：
- 复制原始的 `STRU` 为 `STRU-001`。
- 打开 `POSCAR-001`，复制 C 和 O 的新坐标。
- 打开 `STRU-001`，找到最后的 C 和 O，用新坐标覆盖（注意单位：Phonopy 默认可能是 Direct 或 Cartesian，需与 `STRU` 保持一致）。

**脚本辅助 (Python 伪代码思路)**：
```python
# 这是一个概念演示，实际操作请根据文件格式编写
background_lines = read_file("STRU_original")[:-2] # 读取除最后两行外的所有内容
displacement_lines = read_poscar("POSCAR-001")     # 读取微扰后的坐标

with open("STRU-001", "w") as f:
    f.writelines(background_lines)
    f.writelines(displacement_lines) # 拼回去
```

> **Warning**: 务必检查拼接后的 `STRU` 文件中，原子种类的标签（Label）和坐标是否一一对应。如果 C 的坐标贴到了 O 的位置上，计算结果将完全错误。

---

## 3.3 运行计算与数据清洗

### 3.3.1 ABACUS 输入参数
对生成的每一个 `STRU-00X` 运行单点自洽计算。

**INPUT 文件关键参数**：
```bash
INPUT_PARAMETERS
# 必须开启力计算
cal_force        1
cal_stress       0   # 局部振动通常不需要应力
calculation      scf # 自洽计算即可，不需要 relax

# 精度控制（振动频率对力很敏感，需高精度）
scf_thr          1e-8
force_thr_ev     1e-4 # 虽然不做弛豫，但设置此值有助于检查收敛性
```

### 3.3.2 结果解析与力数据清洗
计算完成后，每个文件夹下会有 `running_scf.log` 或 `FORCE_001` (取决于版本和设置)。

**关键步骤：提取力**
Phonopy 生成微扰时是基于 `POSCAR_part` (2个原子) 的。因此，在生成 `FORCE_SETS` 时，它也只期待读到 2 个原子的受力。

但是，ABACUS 计算的是完整体系（50个原子）。你**不能**直接用 `phonopy -f disp-*/running_scf.log`，因为原子数量不匹配，Phonopy 会报错。

**手动构造 `FORCE_SETS`**：
你需要编写脚本或手动提取，从 ABACUS 的输出中，**只抓取最后 2 个原子（C 和 O）的受力数据**。

假设你有 6 个位移文件，你需要构造一个符合 Phonopy 格式的 `FORCE_SETS` 文件：
```text
6           <-- 位移文件总数
1           <-- 第1个位移文件的原子索引 (Phonopy内部索引，通常是1)
0.01 0.0 0.0 <-- 位移量 (从 phonopy_disp.yaml 查)
Fx1 Fy1 Fz1 <-- 原子1 (C) 在第1次计算中的受力
Fx2 Fy2 Fz2 <-- 原子2 (O) 在第1次计算中的受力
2           <-- 第2个位移文件的原子索引
...
```
*注：手动构造 `FORCE_SETS` 格式较为繁琐。更推荐的方法是使用 Phonopy 的 API 或使用 `phonopy-force-architecture` 工具，但这超出了本教程范围。*

**最简易的“欺骗”法**：
1. 编写脚本，从每个 `running_scf.log` 中提取最后两行受力。
2. 将这提取出的受力保存为一个新的文本文件，伪装成一个“小体系”的计算输出。
3. 或者，直接按照 Phonopy 官方文档中 `FORCE_SETS` 的格式，将提取出的数据填入。

---

## 3.4 结果计算与物理意义解读

一旦你拥有了基于 `POSCAR_part` 和清洗后的力数据生成的 `FORCE_SETS`，就可以进行后处理了。

```bash
phonopy -p -t -c POSCAR_part mesh.conf
```

### 3.4.1 文件解读：thermal_properties.yaml
运行后生成的 `thermal_properties.yaml` 包含热力学量。请务必注意单位和定义：

*   **Temperature (K)**: 温度。
*   **Free energy (kJ/mol)**: 振动亥姆霍兹自由能 ($F_{vib}$)。
    *   **注意**: $F_{vib} = E_{ZPE} + \int C_v dT - TS$。
    *   它**不包含**电子总能量 ($E_{DFT}$)。如果你要计算反应自由能变 $\Delta G$，公式应为：
        $$ \Delta G \approx \Delta E_{DFT} + \Delta F_{vib} + \Delta (PV) $$
        (固相反应通常忽略 $\Delta (PV)$)。
*   **Entropy (J/K/mol)**: 振动熵 ($S_{vib}$)。
*   **Heat capacity (J/K/mol)**: 等容热容 ($C_v$)。

### 3.4.2 虚频分析
在局部振动分析中，如果出现虚频（Imaginary Frequency，显示为负数）：
1.  **大虚频 (> 50 cm⁻¹)**: 通常意味着结构未在该局部达到稳态（例如 CO 吸附位置不对，它是过渡态而非极小值点）。需要重新弛豫结构。
2.  **微小虚频 (< 10 cm⁻¹)**: 可能是数值噪音或平移/旋转模。在局部振动分析中，由于我们人为固定了背景原子，这种平移模通常会被抑制，但如果出现，通常可以忽略。

## 3.5 风险提示与总结

1.  **索引灾难**: 再次强调，ABACUS 输出力的顺序与 `STRU` 中原子顺序严格一致。如果在拼接过程中打乱了顺序，你得到的声子谱将是杂乱无章的噪音。
2.  **力场污染**: 如果背景原子（Slab）没有充分弛豫，它们受到的残余力会叠加到目标原子上（通过力常数矩阵的耦合），导致结果不准。**务必保证背景原子是严格弛豫过的（Force < 0.01 eV/Å）**。
3.  **自洽收敛**: 确保 `running_scf.log` 显示 "Convergence Achieved"。未收敛的步输出的力是物理上无意义的。

通过掌握这一章的“手动选区分析”，你已经具备了处理复杂表面反应热力学修正的能力，这是通向高阶计算材料学研究的重要一步。