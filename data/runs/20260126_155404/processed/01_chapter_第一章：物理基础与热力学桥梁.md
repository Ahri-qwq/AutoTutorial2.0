# 第一章：物理基础与热力学桥梁

在真正开始编写 `INPUT` 文件和提交任务之前，我们需要建立一个清晰的物理图像。很多初学者容易陷入“为了算而算”的误区，导致面对 `thermal_properties.yaml` 中的数据时感到迷茫。

本章不堆砌繁杂的公式，旨在为你厘清从**静态的 DFT 能量**到**动态的热力学性质**之间的桥梁。理解这些，你才能明白为什么我们需要计算声子，以及后续的参数设置（如超胞大小、收敛精度）背后的物理依据。

---

## 1.1 从微观振动到宏观热力学

当我们使用 ABACUS 进行一次标准的自洽计算（SCF）或结构弛豫（Relaxation）时，我们得到的能量通常对应于 **0 K 下、原子核固定不动** 时的势能面极小值。但在真实世界中，材料处于有限温度下，原子时刻都在平衡位置附近振动。

为了得到有限温度下的吉布斯自由能 $G(T, P)$，我们需要将总能量拆解：

$$ G(T, P) = E_{\text{static}} + E_{\text{ZPE}} + F_{\text{vib}}(T) + PV + \dots $$

### 各项物理含义详解

1.  **$E_{\text{static}}$ (DFT 静态能)**
    *   **来源**: ABACUS `scf` 或 `relax` 计算输出的最终能量（`Final Etot`）。
    *   **物理意义**: 电子基态能量 + 原子核之间的库仑排斥能。这是晶格的“骨架”能量。
    *   **注意**: 这是负值，且绝对值很大。

2.  **$E_{\text{ZPE}}$ (零点能, Zero Point Energy)**
    *   **来源**: 量子力学效应。即使在 0 K，原子也不会静止，而是处于最低振动能级 $\frac{1}{2}\hbar\omega$。
    *   **计算方式**: 对所有声子模式求和 $\sum \frac{1}{2}\hbar\omega_i$。
    *   **重要性**: 对于含轻元素（如 H、Li）的体系，ZPE 贡献巨大，不可忽略。

3.  **$F_{\text{vib}}(T)$ (振动自由能)**
    *   **来源**: 温度升高导致声子被激发（玻色-爱因斯坦统计）。包含振动内能项和振动熵项（$-TS_{\text{vib}}$）。
    *   **计算方式**: 通过声子态密度（Phonon DOS）积分得到。
    *   **关键点**: 这是温度 $T$ 的函数，是我们计算热膨胀、热容、相变温度的核心来源。

4.  **$PV$ 项**
    *   **说明**: 在固相计算中，通常假设 $P=0$ 或体积变化引起的 $PV$ 项相对于内能很小，因此在标准声子计算流程中常被忽略（除非研究高压相变）。

> **教授视角的总结**：
> ABACUS 负责算准 $E_{\text{static}}$ 和原子受力；Phonopy 负责利用这些力常数，通过统计力学推导出 $E_{\text{ZPE}}$ 和 $F_{\text{vib}}(T)$。两者相加，才是真实的热力学能量。

---

## 1.2 准谐近似与有限位移法

要得到振动频率 $\omega$，我们需要知道原子偏离平衡位置时受到的回复力。在 ABACUS 实战中，最主流的方法是 **有限位移法 (Finite Displacement Method)**。

### 核心逻辑：胡克定律的矩阵版
在简谐近似下，力 $F$ 与位移 $u$ 的关系由力常数矩阵 $\Phi$ 决定：
$$ F = -\Phi \cdot u $$

为了求出 $\Phi$，我们采取“笨办法”：
1.  **扩胞 (Supercell)**: 建立一个足够大的超胞，保证原子振动不会与其周期性镜像发生虚假相互作用。
2.  **微扰 (Displacement)**: 人为地将某个原子 $A$ 移动一个微小距离 $\Delta$（通常为 0.01 Å）。
3.  **算力 (Force Calculation)**: 运行 ABACUS，计算此时超胞内所有原子的受力。
4.  **反推**: 根据 $F$ 和 $\Delta$，反推出力常数，进而构建动力学矩阵，对角化得到声子谱。

### ABACUS 中的关键设置
在进行有限位移法计算时，ABACUS 的 `INPUT` 文件必须确保计算出力，并且精度足够高：

```bash
INPUT_PARAMETERS
# ... 基础参数 ...
calculation     scf        # 或者是 relax，但在微扰步骤通常只做 scf
cal_force       1          # 必须开启！输出原子受力
force_thr_ev    1.0e-4     # 力的收敛标准建议设严，虽然 scf 模式下主要看 scf_thr
scf_thr         1.0e-8     # 电子步收敛精度必须高，否则微小的力会被噪声淹没
```

---

## 1.3 进阶操作：手动 Selective Dynamics (高风险)

**⚠️ 警告：本节内容涉及高阶手动操作，仅适用于特定需求（如仅计算表面吸附分子的振动，固定基底）。**

在 VASP 等软件中，我们可以通过 `Selective Dynamics` 方便地固定部分原子。然而，**ABACUS + Phonopy 的标准接口目前尚不支持自动识别并处理部分固定的微扰生成**。如果你直接使用 Phonopy 生成位移，它会默认对超胞内所有对称性不等价的原子进行位移。

若必须只计算特定原子的声子（例如为了节省计算量或研究局部振动），你需要执行以下**手动替代方案**。请务必保持清醒，**原子索引（Index）的错位是导致计算失败的头号原因**。

### 手动操作流程

#### Step 1: 准备超胞与索引确认
假设你有一个表面体系超胞 `STRU_supercell`，包含 50 个原子。
*   原子 1-40：基底（需要固定）。
*   原子 41-50：吸附分子（需要计算声子）。

#### Step 2: 手动提取与微扰生成
你需要欺骗 Phonopy，让它以为你的系统只有 10 个原子。
1.  创建一个临时结构文件，**仅包含原子 41-50**。
2.  使用 Phonopy 对这个 10 原子的结构生成微扰文件（`POSCAR-001`, `POSCAR-002`...）。

#### Step 3: “移花接木” (Grafting)
这是最容易出错的一步。你需要将 Phonopy 生成的微扰后的原子坐标，放回原超胞中。
*   打开 `POSCAR-001`（Phonopy 生成的）。
*   提取其中的坐标数据。
*   新建 ABACUS 的 `STRU-001` 文件：
    *   先写入原子 1-40 的**原始固定坐标**。
    *   接着写入从 `POSCAR-001` 提取的、**带有微扰的**原子 41-50 的坐标。
*   **关键检查**: 确保 `STRU` 文件中的原子种类（`ATOMIC_SPECIES`）和位置顺序与你的逻辑完全一致。

#### Step 4: 运行 ABACUS 计算
对所有拼接好的 `STRU-xxx` 运行 ABACUS `scf` 计算，并开启 `cal_force = 1`。

#### Step 5: 结果解析与力文件重构
Phonopy 计算力常数时，需要读取 `FORCE_SETS`。由于你在 Step 2 中只对 10 个原子生成了位移，Phonopy 期望读入的力也应该是针对这 10 个原子体系的格式（或者你需要非常精通 Phonopy 的 `--pm` 等高级参数，但在手动流中，我们通常处理数据文件）。

**推荐做法**：
1.  读取 ABACUS 输出的 `FORCE_STRESS` 或 `running_scf.log`。
2.  **手动提取**原子 41-50 的受力数据。
3.  按照 Phonopy 的格式要求（通常是 `FORCE_SETS` 或 `vasprun.xml` 的模拟结构），构建输入给 Phonopy 的力文件。

> **专家建议**: 除非计算资源极度受限，否则建议**对整个体系进行完整的声子计算**。手动处理 Selective Dynamics 极易引入人为错误，且忽略了基底与吸附物之间的振动耦合，可能导致低频模式（如受阻平动/转动）计算不准。

---

## 1.4 结果文件解读与风险提示

当你历经千辛万苦运行完 `phonopy -p mesh.conf` 后，会得到一个 `thermal_properties.yaml` 文件。正确解读它是发表数据的关键。

### 1. 单位速查表 (Critical)

| 物理量 | 标签 (YAML) | 单位 | 说明 |
| :--- | :--- | :--- | :--- |
| **温度** | `temperature` | **K** | 绝对温标 |
| **自由能** | `free_energy` | **kJ/mol** | **注意不是 eV！** 包含 ZPE 和 $-TS$ |
| **熵** | `entropy` | **J/K/mol** | 振动熵 |
| **热容** | `heat_capacity` | **J/K/mol** | 等容热容 $C_v$ |

### 2. 常见陷阱
*   **自由能的零点**: 这里的 `free_energy` 是 $F_{\text{vib}}(T) + E_{\text{ZPE}}$。它**不包含** $E_{\text{static}}$（DFT 总能）。
    *   如果你要计算反应自由能变 $\Delta G$，公式应为：
        $$ \Delta G = \Delta E_{\text{static}} + \Delta \text{Free\_Energy}_{\text{phonopy}} $$
    *   **切记单位换算**: $E_{\text{static}}$ 通常是 eV，而 Phonopy 输出是 kJ/mol。($1 \text{ eV} \approx 96.485 \text{ kJ/mol}$)。

### 3. 风险提示：运行日志检查
在执行 `phonopy -f disp-{001..XXX}/OUT.ABACUS/running_scf.log` 生成力常数前，务必检查每个 ABACUS 任务的日志：
*   **是否正常结束**: 检查文件末尾是否有 `JOB DONE` 或运行时间统计。
*   **力数据是否存在**: 搜索关键字 `FORCE`。如果 `INPUT` 中忘了写 `cal_force = 1`，计算会正常结束但没有力数据，Phonopy 会报错。
*   **收敛性**: 检查 `Total  Energy` 是否收敛。如果 SCF 不收敛，计算出的力是错误的，会导致声子谱出现大量虚频。