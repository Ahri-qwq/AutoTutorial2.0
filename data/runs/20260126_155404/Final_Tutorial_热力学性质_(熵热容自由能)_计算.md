# ABACUS 第一性原理计算实战：声子谱与热力学性质分析

## 前言

欢迎开启 ABACUS 与 Phonopy 的深度学习之旅。在凝聚态物理与材料科学的研究中，理解材料在有限温度下的行为——如热容、熵以及吉布斯自由能——是连接微观电子结构与宏观热力学现象的核心环节。

**关于 ABACUS**
ABACUS 作为一款由中国科学家主导开发的优秀国产第一性原理计算软件，凭借其高效的数值原子轨道（LCAO）基组和优异的并行性能，在处理大规模体系时表现出色。虽然目前在某些自动化接口（如局部振动分析）上仍处于迭代完善阶段，但其开放的架构和与 Phonopy 等主流后处理工具的深度兼容，为科研工作者提供了极大的灵活性和可操控空间。

**学习路线图**
本教程旨在通过四个维度带你跨越从“运行程序”到“物理分析”的鸿沟：
1.  **物理基础（第一章）**：建立从 DFT 静态能量到晶格动力学振动的物理图像，明确“为什么要算声子”。
2.  **标准流程（第二章）**：以工业级标准拆解“结构优化-位移生成-受力计算-热力学提取”的全过程。
3.  **高阶技巧（第三章）**：针对表面催化或缺陷物理中的复杂需求，传授“手动选区”等开发者级别的进阶操作方案。
4.  **数据解读（第四章）**：深入解析 `thermal_properties.yaml` 等核心输出文件，教你如何辨别动力学稳定性并规避单位陷阱。

**知识体系定位**
本教程属于 ABACUS 高阶应用模块。它建立在基础自洽计算（SCF）和结构弛豫（Relaxation）之上，是深入开展相变研究、反应动力学分析及热电材料设计的必经之路。通过本教程，你不仅能掌握工具的使用，更能理解热力学性质计算背后的全景图。

**前置要求**
在开始之前，我们假设你已经：
- 掌握了基础的 Linux 命令行操作。
- 能够独立完成 ABACUS 的基础 SCF 计算。
- 环境中已安装好 ABACUS（推荐 3.10 LTS 及以上版本）与 Phonopy。

让我们开始这段从微观振动通往热力学真理的探索吧！

---

# 第一章：物理基础与热力学桥梁

在真正开始编写 `INPUT` 文件和提交任务之前，我们需要建立一个清晰的物理图像。很多初学者容易陷入“为了算而算”的误区，导致面对 `thermal_properties.yaml` 中的数据时感到迷茫。

本章不堆砌繁杂的公式，旨在为你厘清从**静态的 DFT 能量**到**动态的热力学性质**之间的桥梁。理解这些，你才能明白为什么我们需要计算声子，以及后续的参数设置（如超胞大小、收敛精度）背后的物理依据。

---

## 1.1 从微观振动到宏观热力学

当我们使用 ABACUS 进行一次标准的自洽计算（SCF）或结构弛豫（Relaxation）时，我们得到的能量通常对应于 **0 K 下、原子核固定不动** 时的势能面极小值。但在真实世界中，材料处于有限温度下，原子时刻都在平衡位置附近振动。

为了得到有限温度下的吉布斯自由能 $G(T, P)$，我们需要将总能量拆解：

$$ G(T, P) = E_{\text{static}} + E_{\text{ZPE}} + F_{\text{vib}}(T) + PV + \dots $$

### 各项物理含义详解

1.  **$E_{\text{static}}$ (DFT 静态能)**
    *   **来源**: ABACUS `scf` 或 `relax` 计算输出的最终能量（`Final Etot`）。
    *   **物理意义**: 电子基态能量 + 原子核之间的库仑排斥能。这是晶格的“骨架”能量。
    *   **注意**: 这是负值，且绝对值很大。

2.  **$E_{\text{ZPE}}$ (零点能, Zero Point Energy)**
    *   **来源**: 量子力学效应。即使在 0 K，原子也不会静止，而是处于最低振动能级 $\frac{1}{2}\hbar\omega$。
    *   **计算方式**: 对所有声子模式求和 $\sum \frac{1}{2}\hbar\omega_i$。
    *   **重要性**: 对于含轻元素（如 H、Li）的体系，ZPE 贡献巨大，不可忽略。

3.  **$F_{\text{vib}}(T)$ (振动自由能)**
    *   **来源**: 温度升高导致声子被激发（玻色-爱因斯坦统计）。包含振动内能项和振动熵项（$-TS_{\text{vib}}$）。
    *   **计算方式**: 通过声子态密度（Phonon DOS）积分得到。
    *   **关键点**: 这是温度 $T$ 的函数，是我们计算热膨胀、热容、相变温度的核心来源。

4.  **$PV$ 项**
    *   **说明**: 在固相计算中，通常假设 $P=0$ 或体积变化引起的 $PV$ 项相对于内能很小，因此在标准声子计算流程中常被忽略（除非研究高压相变）。

> **教授视角的总结**：
> ABACUS 负责算准 $E_{\text{static}}$ 和原子受力；Phonopy 负责利用这些力常数，通过统计力学推导出 $E_{\text{ZPE}}$ 和 $F_{\text{vib}}(T)$。两者相加，才是真实的热力学能量。

---

## 1.2 准谐近似与有限位移法

要得到振动频率 $\omega$，我们需要知道原子偏离平衡位置时受到的回复力。在 ABACUS 实战中，最主流的方法是 **有限位移法 (Finite Displacement Method)**。

### 核心逻辑：胡克定律的矩阵版
在简谐近似下，力 $F$ 与位移 $u$ 的关系由力常数矩阵 $\Phi$ 决定：
$$ F = -\Phi \cdot u $$

为了求出 $\Phi$，我们采取“笨办法”：
1.  **扩胞 (Supercell)**: 建立一个足够大的超胞，保证原子振动不会与其周期性镜像发生虚假相互作用。
2.  **微扰 (Displacement)**: 人为地将某个原子 $A$ 移动一个微小距离 $\Delta$（通常为 0.01 Å）。
3.  **算力 (Force Calculation)**: 运行 ABACUS，计算此时超胞内所有原子的受力。
4.  **反推**: 根据 $F$ 和 $\Delta$，反推出力常数，进而构建动力学矩阵，对角化得到声子谱。

### ABACUS 中的关键设置
在进行有限位移法计算时，ABACUS 的 `INPUT` 文件必须确保计算出力，并且精度足够高：

```bash
INPUT_PARAMETERS
# ... 基础参数 ...
calculation     scf        # 或者是 relax，但在微扰步骤通常只做 scf
cal_force       1          # 必须开启！输出原子受力
force_thr_ev    1.0e-4     # 力的收敛标准建议设严，虽然 scf 模式下主要看 scf_thr
scf_thr         1.0e-8     # 电子步收敛精度必须高，否则微小的力会被噪声淹没
```

---

## 1.3 进阶操作：手动 Selective Dynamics (高风险)

**⚠️ 警告：本节内容涉及高阶手动操作，仅适用于特定需求（如仅计算表面吸附分子的振动，固定基底）。**

在 VASP 等软件中，我们可以通过 `Selective Dynamics` 方便地固定部分原子。然而，**ABACUS + Phonopy 的标准接口目前尚不支持自动识别并处理部分固定的微扰生成**。如果你直接使用 Phonopy 生成位移，它会默认对超胞内所有对称性不等价的原子进行位移。

若必须只计算特定原子的声子（例如为了节省计算量或研究局部振动），你需要执行以下**手动替代方案**。请务必保持清醒，**原子索引（Index）的错位是导致计算失败的头号原因**。

### 手动操作流程

#### Step 1: 准备超胞与索引确认
假设你有一个表面体系超胞 `STRU_supercell`，包含 50 个原子。
*   原子 1-40：基底（需要固定）。
*   原子 41-50：吸附分子（需要计算声子）。

#### Step 2: 手动提取与微扰生成
你需要欺骗 Phonopy，让它以为你的系统只有 10 个原子。
1.  创建一个临时结构文件，**仅包含原子 41-50**。
2.  使用 Phonopy 对这个 10 原子的结构生成微扰文件（`POSCAR-001`, `POSCAR-002`...）。

#### Step 3: “移花接木” (Grafting)
这是最容易出错的一步。你需要将 Phonopy 生成的微扰后的原子坐标，放回原超胞中。
*   打开 `POSCAR-001`（Phonopy 生成的）。
*   提取其中的坐标数据。
*   新建 ABACUS 的 `STRU-001` 文件：
    *   先写入原子 1-40 的**原始固定坐标**。
    *   接着写入从 `POSCAR-001` 提取的、**带有微扰的**原子 41-50 的坐标。
*   **关键检查**: 确保 `STRU` 文件中的原子种类（`ATOMIC_SPECIES`）和位置顺序与你的逻辑完全一致。

#### Step 4: 运行 ABACUS 计算
对所有拼接好的 `STRU-xxx` 运行 ABACUS `scf` 计算，并开启 `cal_force = 1`。

#### Step 5: 结果解析与力文件重构
Phonopy 计算力常数时，需要读取 `FORCE_SETS`。由于你在 Step 2 中只对 10 个原子生成了位移，Phonopy 期望读入的力也应该是针对这 10 个原子体系的格式（或者你需要非常精通 Phonopy 的 `--pm` 等高级参数，但在手动流中，我们通常处理数据文件）。

**推荐做法**：
1.  读取 ABACUS 输出的 `FORCE_STRESS` 或 `running_scf.log`。
2.  **手动提取**原子 41-50 的受力数据。
3.  按照 Phonopy 的格式要求（通常是 `FORCE_SETS` 或 `vasprun.xml` 的模拟结构），构建输入给 Phonopy 的力文件。

> **专家建议**: 除非计算资源极度受限，否则建议**对整个体系进行完整的声子计算**。手动处理 Selective Dynamics 极易引入人为错误，且忽略了基底与吸附物之间的振动耦合，可能导致低频模式（如受阻平动/转动）计算不准。

---

## 1.4 结果文件解读与风险提示

当你历经千辛万苦运行完 `phonopy -p mesh.conf` 后，会得到一个 `thermal_properties.yaml` 文件。正确解读它是发表数据的关键。

### 1. 单位速查表 (Critical)

| 物理量 | 标签 (YAML) | 单位 | 说明 |
| :--- | :--- | :--- | :--- |
| **温度** | `temperature` | **K** | 绝对温标 |
| **自由能** | `free_energy` | **kJ/mol** | **注意不是 eV！** 包含 ZPE 和 $-TS$ |
| **熵** | `entropy` | **J/K/mol** | 振动熵 |
| **热容** | `heat_capacity` | **J/K/mol** | 等容热容 $C_v$ |

### 2. 常见陷阱
*   **自由能的零点**: 这里的 `free_energy` 是 $F_{\text{vib}}(T) + E_{\text{ZPE}}$。它**不包含** $E_{\text{static}}$（DFT 总能）。
    *   如果你要计算反应自由能变 $\Delta G$，公式应为：
        $$ \Delta G = \Delta E_{\text{static}} + \Delta \text{Free\_Energy}_{\text{phonopy}} $$
    *   **切记单位换算**: $E_{\text{static}}$ 通常是 eV，而 Phonopy 输出是 kJ/mol。($1 \text{ eV} \approx 96.485 \text{ kJ/mol}$)。

### 3. 风险提示：运行日志检查
在执行 `phonopy -f disp-{001..XXX}/OUT.ABACUS/running_scf.log` 生成力常数前，务必检查每个 ABACUS 任务的日志：
*   **是否正常结束**: 检查文件末尾是否有 `JOB DONE` 或运行时间统计。
*   **力数据是否存在**: 搜索关键字 `FORCE`。如果 `INPUT` 中忘了写 `cal_force = 1`，计算会正常结束但没有力数据，Phonopy 会报错。
*   **收敛性**: 检查 `Total  Energy` 是否收敛。如果 SCF 不收敛，计算出的力是错误的，会导致声子谱出现大量虚频。

# 第二章：标准计算流程 (ABACUS + Phonopy)

本章将深入 ABACUS 与 Phonopy 联合使用的核心实战环节。我们将按照工业标准的“前处理 -> 自洽计算 -> 后处理”逻辑，详细拆解如何获取材料的声子谱及热力学性质。

**本章核心逻辑：**
1.  **前处理**：基于高精度弛豫结构，使用 Phonopy 生成一系列微扰后的超胞（Supercells）。
2.  **力场计算**：配置 ABACUS 计算这些超胞的原子受力（Forces）。
3.  **后处理**：收集力数据，构建力常数矩阵，计算热容、熵等热力学函数。

---

## 2.1 结构优化与前处理

在进行声子计算之前，**必须**确保晶胞处于受力极小的基态。任何残留的内应力都会导致声子谱出现虚频（软模），尤其是在 $\Gamma$ 点附近。

### 2.1.1 高精度结构弛豫
在上一章的结构优化中，我们通常使用默认收敛标准。但在声子计算前，建议使用更严格的标准：
*   **`force_thr_ev`**: 建议设为 `1.0e-4` eV/Å 或更小。
*   **`stress_thr`**: 建议设为 `1.0e-2` GPa（如果是变胞优化）。

### 2.1.2 生成超胞与微扰文件
我们将使用 Phonopy 的有限位移法（Finite Displacement Method）来生成输入结构。

**步骤 1：准备单位原胞**
准备好优化后的结构文件 `STRU`。

**步骤 2：执行 Phonopy 命令**
在终端运行以下命令生成超胞和微扰文件：

```bash
# 假设扩胞倍数为 2x2x2
phonopy --abacus -d --dim="2 2 2" -c STRU
```

**参数详解：**
*   `--abacus`: 指定输入输出格式为 ABACUS 接口。
*   `-d`: 生成位移（Displacement）。
*   `--dim="2 2 2"`: 指定超胞在 x, y, z 方向的扩胞倍数。
*   `-c STRU`: 指定输入的初始结构文件名为 `STRU`。

**输出产物：**
执行成功后，目录下会生成以下关键文件：
1.  `SPOSCAR`: 完美的超胞结构（未微扰），用于检查扩胞是否正确。
2.  `STRU-001`, `STRU-002`, ... : 包含微扰的 ABACUS 结构文件。
3.  `phonopy_disp.yaml`: 记录了原子位移与文件对应关系的映射表（**千万不要删除**）。

---

## 2.2 ABACUS 力场计算配置

这一步是计算量最大的环节。我们需要对每一个生成的 `STRU-xxx` 文件运行一次 ABACUS 的 SCF（自洽场）计算，以获取精确的原子受力。

### 2.2.1 目录管理建议
为了避免文件混乱，建议采用如下目录结构：

```text
.
├── disp-001/
│   ├── STRU      <-- (原 STRU-001 重命名而来)
│   ├── INPUT
│   └── KPT
├── disp-002/
│   ├── STRU      <-- (原 STRU-002 重命名而来)
│   ├── INPUT
│   └── KPT
...
```

### 2.2.2 INPUT 文件核心配置
在计算声子时，我们只需要“力”的信息，不需要进行结构优化或分子动力学模拟。

**关键参数清单 (INPUT):**

```bash
INPUT_PARAMETERS
# 1. 基础计算模式
calculation     scf        # 进行自洽计算
basis_type      lcao       # 或 pw，需与赝势匹配
symmetry        0          # 【重要】关闭对称性分析，防止ABACUS对微扰结构进行错误的对称性约化

# 2. 力与应力输出 (Phonopy 接口核心)
cal_force       1          # 【必须】开启力计算，输出到 running_scf.log
cal_stress      1          # 推荐开启，用于辅助判断收敛性

# 3. 精度控制 (需与结构优化时保持一致或更高)
ecutwfc         60         # 平面波截断能 (Ry)
scf_thr         1.0e-8     # 自洽收敛阈值
scf_nmax        100        # 最大迭代步数

# 4. 涂抹设置 (金属体系必填)
smearing_method gaussian
smearing_sigma  0.01
```

**风险提示：**
*   **`symmetry 0`**: 微扰后的结构对称性已被破坏，强制关闭对称性分析可以避免潜在的坐标系旋转问题，确保输出的力与 Phonopy 预期的原子索引一一对应。
*   **`cal_force 1`**: 如果遗漏此参数，日志中将不会包含 `FORCE` 字段，导致后续步骤失败。

### 2.2.3 批量提交任务
对于包含数十个微扰结构的任务，建议编写 Shell 脚本批量提交：

```bash
#!/bin/bash
# 假设生成的文件夹名为 disp-001, disp-002 ...
for dir in disp-*; do
    cd $dir
    # 提交任务命令，例如使用 slurm:
    # sbatch submit.sh
    # 或者直接运行 (仅供测试):
    # OMP_NUM_THREADS=1 mpirun -np 8 abacus > output.log &
    cd ..
done
```

---

## 2.3 后处理与热力学性质计算

当所有 SCF 任务完成后，我们需要从 ABACUS 的日志文件 `running_scf.log` 中提取力数据，并计算热力学性质。

### 2.3.1 提取力常数 (FORCE_SETS)
Phonopy 需要读取每个微扰结构的受力情况。

**命令：**
```bash
phonopy --abacus -f disp-001/running_scf.log disp-002/running_scf.log ...
```
*注意：可以使用通配符 `disp-*/running_scf.log`，但必须确保文件顺序与 `phonopy_disp.yaml` 中的顺序一致（通常 shell 的默认排序即可，但需小心 1 和 10 的排序问题）。*

**检查点：**
*   命令执行后，当前目录下应生成 `FORCE_SETS` 文件。
*   **常见报错**：如果报错提示找不到力数据，请检查 `running_scf.log` 结尾是否显示 `JOB DONE`，以及文件中是否包含 `FORCE (eV/Angstrom)` 数据块。

### 2.3.2 计算热力学性质
我们需要编写一个配置文件 `mesh.conf` 来指定计算参数。

**配置文件示例 (`mesh.conf`):**
```ini
DIM = 2 2 2           # 必须与前处理时的扩胞倍数一致
MP = 31 31 31         # Q点网格密度 (Mesh Sampling)，越大越精确
TMIN = 0              # 起始温度 (K)
TMAX = 1000           # 结束温度 (K)
TSTEP = 10            # 温度步长 (K)
```

**执行计算：**
```bash
phonopy --abacus -p mesh.conf
```
*   `-p`: Plot，直接画图并输出数据。

### 2.3.3 结果文件深度解读
运行结束后，重点关注 `thermal_properties.yaml` 文件。

**关键物理量与单位：**

| 字段 (Field) | 物理意义 | 单位 (Unit) | 备注 |
| :--- | :--- | :--- | :--- |
| **temperature** | 温度 | **K** | |
| **free_energy** | 亥姆霍兹自由能 ($F$) | **kJ/mol** | 注意：包含零点能 (ZPE) 和振动熵贡献 ($F = E_{ZPE} - TS_{vib}$)。<br>**不包含** DFT 基态能量 $E_{el}$。 |
| **entropy** | 振动熵 ($S$) | **J/K/mol** | |
| **heat_capacity** | 等容热容 ($C_v$) | **J/K/mol** | 在固体物理近似下，$C_v \approx C_p$ (低温时)。 |

**专家提示：**
这里的 Free Energy **不包含** $PV$ 项。在固相计算中，通常假设 $P \approx 0$，因此吉布斯自由能 $G \approx F$。如果你需要计算相图，记得手动加上 DFT 计算得到的基态能量 $E_{el}$。

---

## 特别专题：处理 Selective Dynamics (手动方案)

**警告：高风险操作**
目前的 ABACUS+Phonopy 接口**不支持**像 VASP 那样通过 `selective dynamics` 标签自动固定特定原子。如果你只需要计算表面吸附分子或特定局域原子的振动模式，必须采用以下**手动替代方案**。此过程极易出错，请务必核对原子索引。

### 操作流程

1.  **手动提取子结构**：
    从你的超胞结构中，手动提取出你**关心**的原子（例如吸附分子 A），记为集合 $S_A$。其余固定不动的原子记为 $S_B$。

2.  **生成微扰 (针对 $S_A$)**：
    创建一个只包含 $S_A$ 原子的临时结构文件 `STRU_A`。使用 Phonopy 对 `STRU_A` 生成微扰文件。
    *注意：此时 `DIM` 通常设为 `1 1 1`，因为你是在操作子集。*

3.  **重组结构 (Re-embedding)**：
    这是最繁琐的一步。对于生成的每一个 `STRU_A-xxx`：
    *   读取其坐标。
    *   将 $S_B$ 原子的坐标（保持基态位置）**手动追加**回文件中。
    *   **关键**：必须保证原子在文件中的顺序与原始超胞完全一致！如果 $S_A$ 原本在 $S_B$ 之后，重组时也要保持这个顺序。

4.  **运行 ABACUS**：
    对重组后的所有结构运行 SCF 计算。

5.  **过滤力数据 (Filtering)**：
    ABACUS 会输出所有原子的力。但 Phonopy 基于 `STRU_A` 生成的 `phonopy_disp.yaml` 只期待看到 $S_A$ 原子的力。
    *   你需要编写脚本，读取 `running_scf.log`。
    *   **只保留** $S_A$ 对应原子的力数据。
    *   构造一个新的符合 Phonopy 格式的力文件（或手动修改 `FORCE_SETS`）。

6.  **生成 FORCE_SETS**：
    使用修改后的数据让 Phonopy 计算力常数。

**建议**：除非计算资源极其受限，否则建议对整个体系进行完整的声子计算，然后在后处理阶段通过分析本征矢（Eigenvectors）来提取局部振动模式，这比上述手动方案更安全。

# 第三章：进阶操作：局部振动与手动选区分析

在表面催化、缺陷物理或大分子吸附的研究中，我们往往只关注体系中**一小部分原子的振动属性**（例如吸附分子的伸缩振动、缺陷位点的局部声子模）。对包含数百个原子的整个板层（Slab）进行全自由度的声子计算不仅极其昂贵，而且往往是不必要的。

在 VASP 等软件中，我们可以通过 `Selective Dynamics` 轻松实现这一点。然而，目前的 **ABACUS + Phonopy** 接口尚未完全支持自动化的“部分原子微扰”功能。

本章将教授你一套**世界级开发者常用**的高阶“手动替代方案”。这套方案虽然需要一定的手动操作技巧，但它能让你在处理几百个原子的体系时，仅针对关键的几个原子进行计算，从而节省 90% 以上的计算资源。

---

## 3.1 接口限制与手动方案设计

### 3.1.1 为什么不能直接“固定”？
通常，Phonopy 生成位移（Displacement）时，会读取结构文件并对超胞内的原子进行对称性分析和微扰。如果直接对整个大体系使用 Phonopy，它会默认计算所有原子的 3N 个自由度。

虽然 ABACUS 的 `STRU` 文件支持 `m_x, m_y, m_z` (0/1) 来固定原子弛豫，但这仅针对几何优化（Relaxation）和分子动力学（MD）。在声子计算中，我们需要人为地**仅对目标原子施加微扰**，并**仅提取目标原子的受力**。

### 3.1.2 “剪切-微扰-拼接”工作流
为了绕过接口限制，我们采用以下逻辑：

1.  **剪切 (Cut)**: 从优化好的完整 `STRU` 中，将“目标原子（Active Atoms）”和“背景原子（Frozen Atoms）”在逻辑上分离。
2.  **微扰 (Perturb)**: 仅将“目标原子”作为独立结构输入给 Phonopy，生成微扰后的坐标文件。
3.  **拼接 (Paste)**: 将微扰后的“目标原子”坐标，填回“背景原子”的空缺中，生成一系列完整的 ABACUS `STRU` 文件。
4.  **计算 (Calc)**: 运行 ABACUS 计算受力。
5.  **清洗 (Clean)**: 从输出中提取受力，剔除背景原子的噪音，生成 `FORCE_SETS`。

---

## 3.2 结构重组与索引一致性实战

这是本章最核心、风险最高的部分。**原子索引（Index）的一致性是成败的关键**。

### 3.2.1 准备工作：原子排序
在开始之前，建议重新整理你的 `STRU` 文件，将**需要振动的原子放在最后**（或最前），并保持元素类型连续。

**示例场景**：
Pt(111) 表面吸附一个 CO 分子。
- 总原子数：48 Pt + 1 C + 1 O = 50 原子。
- 目标：只计算 C 和 O 的振动。

**推荐的 `STRU` 结构顺序**：
```
ATOMIC_POSITIONS
Direct
Pt
0.0 0.0 0.0 0 0 0
... (47个 Pt 原子) ...
C
0.5 0.5 0.6 1 1 1  <-- 目标原子 1 (Index 49)
O
0.5 0.5 0.7 1 1 1  <-- 目标原子 2 (Index 50)
```

### 3.2.2 生成微扰 (Phonopy 侧)
我们需要欺骗 Phonopy，让它以为体系只有 C 和 O 两个原子。

1.  创建一个名为 `POSCAR_part` 的文件，**只包含 C 和 O 的坐标**（保持晶格大小与原体系一致，或者设为足够大的盒子）。
2.  运行 Phonopy 生成微扰：
    ```bash
    # 这里的 1 1 1 表示不扩胞，因为我们是在原胞内做局部振动
    phonopy -d --dim="1 1 1" -c POSCAR_part
    ```
3.  这将生成 `POSCAR-001`, `POSCAR-002` ... 等文件。这些文件里只有 2 个原子，且发生了微小的位移。

### 3.2.3 拼接结构 (ABACUS 侧)
现在我们需要将 `POSCAR-00X` 中的坐标，替换回完整 `STRU` 文件中的最后两行。

**手动操作逻辑**：
- 复制原始的 `STRU` 为 `STRU-001`。
- 打开 `POSCAR-001`，复制 C 和 O 的新坐标。
- 打开 `STRU-001`，找到最后的 C 和 O，用新坐标覆盖（注意单位：Phonopy 默认可能是 Direct 或 Cartesian，需与 `STRU` 保持一致）。

**脚本辅助 (Python 伪代码思路)**：
```python
# 这是一个概念演示，实际操作请根据文件格式编写
background_lines = read_file("STRU_original")[:-2] # 读取除最后两行外的所有内容
displacement_lines = read_poscar("POSCAR-001")     # 读取微扰后的坐标

with open("STRU-001", "w") as f:
    f.writelines(background_lines)
    f.writelines(displacement_lines) # 拼回去
```

> **Warning**: 务必检查拼接后的 `STRU` 文件中，原子种类的标签（Label）和坐标是否一一对应。如果 C 的坐标贴到了 O 的位置上，计算结果将完全错误。

---

## 3.3 运行计算与数据清洗

### 3.3.1 ABACUS 输入参数
对生成的每一个 `STRU-00X` 运行单点自洽计算。

**INPUT 文件关键参数**：
```bash
INPUT_PARAMETERS
# 必须开启力计算
cal_force        1
cal_stress       0   # 局部振动通常不需要应力
calculation      scf # 自洽计算即可，不需要 relax

# 精度控制（振动频率对力很敏感，需高精度）
scf_thr          1e-8
force_thr_ev     1e-4 # 虽然不做弛豫，但设置此值有助于检查收敛性
```

### 3.3.2 结果解析与力数据清洗
计算完成后，每个文件夹下会有 `running_scf.log` 或 `FORCE_001` (取决于版本和设置)。

**关键步骤：提取力**
Phonopy 生成微扰时是基于 `POSCAR_part` (2个原子) 的。因此，在生成 `FORCE_SETS` 时，它也只期待读到 2 个原子的受力。

但是，ABACUS 计算的是完整体系（50个原子）。你**不能**直接用 `phonopy -f disp-*/running_scf.log`，因为原子数量不匹配，Phonopy 会报错。

**手动构造 `FORCE_SETS`**：
你需要编写脚本或手动提取，从 ABACUS 的输出中，**只抓取最后 2 个原子（C 和 O）的受力数据**。

假设你有 6 个位移文件，你需要构造一个符合 Phonopy 格式的 `FORCE_SETS` 文件：
```text
6           <-- 位移文件总数
1           <-- 第1个位移文件的原子索引 (Phonopy内部索引，通常是1)
0.01 0.0 0.0 <-- 位移量 (从 phonopy_disp.yaml 查)
Fx1 Fy1 Fz1 <-- 原子1 (C) 在第1次计算中的受力
Fx2 Fy2 Fz2 <-- 原子2 (O) 在第1次计算中的受力
2           <-- 第2个位移文件的原子索引
...
```
*注：手动构造 `FORCE_SETS` 格式较为繁琐。更推荐的方法是使用 Phonopy 的 API 或使用 `phonopy-force-architecture` 工具，但这超出了本教程范围。*

**最简易的“欺骗”法**：
1. 编写脚本，从每个 `running_scf.log` 中提取最后两行受力。
2. 将这提取出的受力保存为一个新的文本文件，伪装成一个“小体系”的计算输出。
3. 或者，直接按照 Phonopy 官方文档中 `FORCE_SETS` 的格式，将提取出的数据填入。

---

## 3.4 结果计算与物理意义解读

一旦你拥有了基于 `POSCAR_part` 和清洗后的力数据生成的 `FORCE_SETS`，就可以进行后处理了。

```bash
phonopy -p -t -c POSCAR_part mesh.conf
```

### 3.4.1 文件解读：thermal_properties.yaml
运行后生成的 `thermal_properties.yaml` 包含热力学量。请务必注意单位和定义：

*   **Temperature (K)**: 温度。
*   **Free energy (kJ/mol)**: 振动亥姆霍兹自由能 ($F_{vib}$)。
    *   **注意**: $F_{vib} = E_{ZPE} + \int C_v dT - TS$。
    *   它**不包含**电子总能量 ($E_{DFT}$)。如果你要计算反应自由能变 $\Delta G$，公式应为：
        $$ \Delta G \approx \Delta E_{DFT} + \Delta F_{vib} + \Delta (PV) $$
        (固相反应通常忽略 $\Delta (PV)$)。
*   **Entropy (J/K/mol)**: 振动熵 ($S_{vib}$)。
*   **Heat capacity (J/K/mol)**: 等容热容 ($C_v$)。

### 3.4.2 虚频分析
在局部振动分析中，如果出现虚频（Imaginary Frequency，显示为负数）：
1.  **大虚频 (> 50 cm⁻¹)**: 通常意味着结构未在该局部达到稳态（例如 CO 吸附位置不对，它是过渡态而非极小值点）。需要重新弛豫结构。
2.  **微小虚频 (< 10 cm⁻¹)**: 可能是数值噪音或平移/旋转模。在局部振动分析中，由于我们人为固定了背景原子，这种平移模通常会被抑制，但如果出现，通常可以忽略。

## 3.5 风险提示与总结

1.  **索引灾难**: 再次强调，ABACUS 输出力的顺序与 `STRU` 中原子顺序严格一致。如果在拼接过程中打乱了顺序，你得到的声子谱将是杂乱无章的噪音。
2.  **力场污染**: 如果背景原子（Slab）没有充分弛豫，它们受到的残余力会叠加到目标原子上（通过力常数矩阵的耦合），导致结果不准。**务必保证背景原子是严格弛豫过的（Force < 0.01 eV/Å）**。
3.  **自洽收敛**: 确保 `running_scf.log` 显示 "Convergence Achieved"。未收敛的步输出的力是物理上无意义的。

通过掌握这一章的“手动选区分析”，你已经具备了处理复杂表面反应热力学修正的能力，这是通向高阶计算材料学研究的重要一步。

# 第四章：数据解读与结果分析

算出数据只是第一步，读懂数据才算完成。很多初学者容易陷入“跑完程序即结束”的误区，却忽略了输出文件中蕴含的物理图像。本章我们将聚焦于如何从冰冷的数字中提取热力学性质，如何判断材料的动力学稳定性，以及在 ABACUS 现有功能限制下，如何完成高难度的“部分原子微扰”计算。

---

## 4.1 解读 thermal_properties.yaml

当你运行完 `phonopy -t` 后，生成的 `thermal_properties.yaml` 是热力学分析的核心文件。我们需要逐行解析其物理意义，并警惕单位换算中的陷阱。

### 4.1.1 文件结构与物理量定义

以下是一个典型的 `thermal_properties.yaml` 文件片段：

```yaml
# thermal_properties.yaml
temperature:
  - temperature:   0.0000000
    free_energy:   12.4567890
    entropy:       0.0000000
    heat_capacity: 0.0000000
  - temperature:   10.0000000
    free_energy:   12.4521000
    entropy:       0.1234567
    heat_capacity: 0.5678901
```

**关键参数解析：**

1.  **temperature ($T$)**:
    *   **单位**: K (开尔文)
    *   **意义**: 系统的绝对温度。
2.  **free_energy ($F_{phonon}$)**:
    *   **单位**: **kJ/mol** (注意：不是 eV，也不是 Ry)
    *   **物理意义**: 亥姆霍兹自由能的振动部分（Vibrational Helmholtz Free Energy）。
    *   **公式**: $F_{phonon}(T) = E_{ZPE} + F_{vib}(T)$
        *   此处包含了 **零点能 (ZPE)** 和 **温度相关的振动熵贡献** ($-TS_{vib}$)。
        *   **注意**: 这**不包含** DFT 计算得到的电子基态能量 ($E_{DFT}$)。
3.  **entropy ($S$)**:
    *   **单位**: **J/K/mol**
    *   **物理意义**: 振动熵。
4.  **heat_capacity ($C_v$)**:
    *   **单位**: **J/K/mol**
    *   **物理意义**: 等容热容。

### 4.1.2 自由能的完整构建

在实际研究相变或化学反应时，我们需要的是总自由能。对于固体材料，通常忽略 $PV$ 项（因为固体体积变化极小且常压下 $PV$ 贡献微乎其微），此时吉布斯自由能 $G$ 近似等于亥姆霍兹自由能 $F$。

**总自由能计算公式：**
$$ G(T) \approx E_{DFT} + F_{phonon}(T) $$

*   **$E_{DFT}$**: 从 ABACUS 的 `running_scf.log` 或 `OUT.suffix/running_scf.log` 最后一步获取的 `ETOT` (需注意单位通常为 eV，需转换为 kJ/mol 以便相加)。
*   **$F_{phonon}(T)$**: 直接读取 `thermal_properties.yaml` 中的 `free_energy` 列。

> **教授提示**：单位换算是最容易出错的环节。
> $1 \text{ eV/atom} \approx 96.485 \text{ kJ/mol}$。
> 务必确保 $E_{DFT}$ 和 $F_{phonon}$ 单位统一后再相加。

---

## 4.2 稳定性判据与相变分析

### 4.2.1 动力学稳定性：虚频的物理图景

在声子谱（Band Structure）或态密度（DOS）图中，如果出现频率小于 0 的模式（Phonopy 通常将其显示为负数），我们称之为“虚频”（Imaginary Frequency）。

*   **判据**: $\nu < 0$ (或显示为负实数)。
*   **物理意义**: 
    *   结构处于势能面的“鞍点”而非极小值点。
    *   原子受到微扰后，不会回复原位，而是会向能量更低的方向“滑落”。
*   **例外情况**: 
    *   **声学支在 $\Gamma$ 点附近的微小虚频**: 通常是由于计算精度（如 K 点网格、扩胞大小、积分格点）不足引起的数值误差，如果数值很小（如 > -0.5 THz），通常可以忽略。
    *   **相变软模**: 在特定温度或压力下出现的虚频可能预示着电荷密度波（CDW）或结构相变。

### 4.2.2 热力学稳定性：相图构建

利用 4.1 节计算出的 $G(T)$，我们可以绘制不同相的自由能曲线。

*   **相变温度**: 两个相的 $G(T)$ 曲线交点对应的温度。
*   **自发反应**: 若 $\Delta G = G_{product} - G_{reactant} < 0$，则反应在热力学上自发。

---

## 特别专题：ABACUS 中的“手动” Selective Dynamics

> **CRITICAL WARNING**: 
> 目前 ABACUS + Phonopy 的官方接口**不支持**类似 VASP 的 `selective dynamics` 自动化功能。即你无法直接在生成微扰文件时，通过简单的标签来固定某些原子（如固定基底，只计算表面吸附分子的振动）。
>
> 如果你强行需要计算部分原子的声子（例如为了节省算力或分析局部振动模式），必须采用以下**高风险、需极度细致**的手动替代方案。

### 手动操作流程

这是一个“移花接木”的过程，核心思想是：利用 Phonopy 对“子系统”生成微扰，然后将微扰后的坐标“嫁接”回整个大体系中进行计算。

#### 步骤 1: 拆分结构
从你的超胞结构（假设为 `STRU_supercell`）中，**手动提取**你关心的、需要振动的原子（记为集合 A），剩余固定的原子记为集合 B。
*   创建一个只包含原子 A 的临时结构文件 `POSCAR_A`（格式需转换为 VASP 格式以便 Phonopy 处理，或者手动构建对应的结构对象）。

#### 步骤 2: 对子系统生成微扰
使用 Phonopy 对 `POSCAR_A` 生成微扰文件。
```bash
phonopy -d --dim="1 1 1" -c POSCAR_A
# 注意：这里dim设为1 1 1，因为我们是在超胞基础上提取的原子，
# 不要再次扩胞，除非你是在原胞上操作。
```
这将生成一系列 `POSCAR-001`, `POSCAR-002`... 这些文件只包含原子 A 的微扰坐标。

#### 步骤 3: 嫁接回原体系 (最易出错的一步)
编写脚本，将 `POSCAR-00N` 中的原子 A 的坐标读取出来，与固定的原子 B 的坐标合并，生成完整的 ABACUS 结构文件 `STRU-00N`。

*   **关键点**: 必须保证原子 A 和原子 B 在 `STRU` 文件中的**顺序与索引**与原始 `STRU_supercell` 严格一致！
*   如果原子 A 在原文件中是第 10-12 号原子，合并时它们必须依然是第 10-12 号。

#### 步骤 4: 运行 ABACUS 计算
对每一个拼接好的 `STRU-00N` 运行 SCF 计算，得到受力。

#### 步骤 5: 提取力并过滤
ABACUS 会输出所有原子的受力。但 Phonopy 在处理 `POSCAR_A` 的数据时，只期待看到原子 A 的受力。
*   你需要编写脚本，从 ABACUS 的输出中**只提取原子 A 的受力**。
*   将这些力按照 Phonopy 的 `FORCE_SETS` 格式要求进行整理（或者使用 `phonopy -f` 处理由 `POSCAR_A` 对应生成的计算结果，前提是你把计算结果伪装成 Phonopy 能识别的格式）。

> **建议**: 对于绝大多数用户，除非体系极大且算力极度受限，否则**不推荐**使用此方法。直接计算整个体系的声子谱，然后在后处理时分析特定原子的态密度（Projected DOS），是更安全、更科学的做法。

---

## 附录：常见问题与避坑指南

### 1. 虚频处理 (Imaginary Frequencies)
如果你在 $\Gamma$ 点以外看到了巨大的虚频，通常是以下原因：
*   **结构未优化彻底**: 这是最常见原因。ABACUS 的 `force_thr_ev` 建议设置在 `1.0e-3` eV/Angstrom 或更小。
*   **超胞不够大**: 导致原子间微扰发生自相互作用。
*   **对称性破缺**: 检查 `STRU` 文件中的晶格常数和原子坐标是否保持了应有的对称性。

### 2. `phonopy -f` 读取力失败
报错提示找不到力或格式错误，请按以下清单排查：
*   **ABACUS 是否正常结束**: 检查 `running_scf.log` 结尾是否有 `JOB DONE` 或类似的结束标志。如果计算因超时或报错中断，力数据是不完整的。
*   **日志完整性**: 确保 `OUT.suffix/` 目录下的日志文件没有被截断。
*   **文件名匹配**: 确保你运行 `phonopy -f` 时指向的目录结构与 `disp.yaml` 中记录的一致。

### 3. 单位陷阱
*   **能量**: ABACUS 输出 `eV`, Phonopy `thermal_properties.yaml` 输出 `kJ/mol`.
*   **频率**: Phonopy 默认输出 `THz`. 若需 `cm-1`，需查阅 Phonopy 文档使用 `--factor` 参数或后处理转换 ($1 \text{ THz} \approx 33.356 \text{ cm}^{-1}$).

### 4. MD 方法与声子法的辨析
本教程聚焦于**声子法（Phonon Method）**，它基于简谐近似（Harmonic Approximation），适用于低温至中温固相。
*   如果你研究的是**高温液体**、**扩散行为**或**强非谐性体系**（如软声子模式导致的相变），声子法可能失效。此时应考虑使用 **分子动力学（MD）** 方法计算热力学性质。

---

## 附录：进阶学习指南

完成本书的学习只是你科研之路的一个起点。声子物理与热力学计算领域广阔，以下是为你准备的进一步探索建议。

### 1. 进阶主题推荐
- **非谐性效应（Anharmonicity）**：本教程主要基于简谐近似（Harmonic Approximation）。对于高温下的材料行为，建议进一步学习如何利用 ABACUS 结合 TDEP 或 Phono3py 计算声子寿命及晶格热导率。
- **DFPT 方法应用**：除了本教程重点介绍的有限位移法（Finite Displacement Method），ABACUS 也支持密度泛函微扰理论（DFPT）。对于某些特定体系，DFPT 能够提供更精细的响应性质描述，值得深入研究。
- **自由能修正与相图构建**：基于本书计算的吉布斯自由能，你可以尝试结合不同相的能量曲线，绘制材料的压力-温度（P-T）相图。

### 2. 通用调试建议（Troubleshooting）
- **虚频问题**：如果在声子谱中发现明显的虚频（负频率），请首先检查结构是否已充分弛豫（Force 收敛标准通常需达到 10^-4 eV/A 或更高），其次检查超胞（Supercell）是否足够大以消除长程相互作用的影响。
- **受力检查**：在执行 `phonopy -f` 前，务必确认所有 `running_scf.log` 中均包含 `FORCE` 关键字，且计算已正常结束。任何一个微扰构型的失败都会导致力常数矩阵的错误。
- **收敛性验证**：热力学性质对 K 点密度和截断能（Ecut）的敏感度往往高于总能计算，建议针对声子频率进行专门的收敛性测试。

### 3. 官方资源与社区
- **ABACUS 官方文档**：[http://abacus.deepmodeling.com/](http://abacus.deepmodeling.com/) —— 获取最新的输入参数说明与接口更新。
- **Phonopy 官方手册**：[http://phonopy.github.io/phonopy/](http://phonopy.github.io/phonopy/) —— 深入理解后处理参数（如 `MESH`, `TMAX` 等）的物理含义。
- **社区讨论**：积极参与 DeepModeling 社区或 ABACUS 用户群，许多你遇到的“坑”，前辈们可能已经填平。

**结语**：科学计算是一门实验科学。不要害怕手动修改文件或尝试不同的参数组合，最深刻的物理直觉往往源于对原始数据的反复推敲。祝你在材料探索的征途中取得突破！
