<!-- META_START -->
# ABACUS 实战教程：线性光学性质与介电函数计算

## 前言
- **本书逻辑**: 本教程遵循“理论基础 -> 电子结构准备 -> 介电函数计算 -> 光学常数后处理”的物理认知逻辑。不同于常规的单步计算，光学性质计算是一个跨软件（ABACUS + pyatb）、多步骤的流程。我们将重点讲解如何通过 ABACUS 生成紧束缚模型所需的稀疏矩阵，利用 pyatb 基于 Kubo-Greenwood 公式计算介电函数，最后通过 Python 脚本推导折射率、吸收系数等实验可观测物理量。
- **核心知识点**: 
    - 线性响应理论与 Kubo-Greenwood 公式
    - ABACUS 稀疏矩阵输出 (`out_mat_hs2`, `out_mat_r`)
    - pyatb 接口配置与参数传递 (`fermi_energy`, `occ_band`)
    - Kramers-Kronig 变换与光学常数推导
    - 物理单位换算 (eV/s 到 cm⁻¹)

<!-- CHAPTER_START -->
## 第一章：线性光学性质计算原理
**本章逻辑**: 在动手操作前，必须理解光学性质与电子结构之间的微观联系。本章将简要介绍如何利用原子轨道基组（LCAO）构建紧束缚模型，以及如何通过介电函数的虚部推导其他所有线性光学性质。

### Section 1.1: 介电函数与宏观光学常数
- **内容**: 介绍介电函数 $\epsilon(\omega) = \epsilon_1(\omega) + i\epsilon_2(\omega)$ 的物理意义。解释虚部 $\epsilon_2$ 如何对应电子跃迁（吸收），实部 $\epsilon_1$ 如何对应折射。梳理折射率 ($n$)、消光系数 ($\kappa$)、吸收系数 ($\alpha$)、反射率 ($R$) 与介电函数的关系。
- **关键参数**: 无

### Section 1.2: 基于 LCAO 的紧束缚模型与 Kubo-Greenwood 公式
- **内容**: 阐述在周期性体系中，如何利用 Kohn-Sham 方程的本征值和波函数计算光导率。重点解释 ABACUS 计算得到的哈密顿矩阵 ($H$)、重叠矩阵 ($S$) 和偶极矩阵 ($r$) 是如何作为输入传递给 pyatb 进行跃迁矩阵元计算的。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第二章：电子结构计算与矩阵生成 (ABACUS)
**本章逻辑**: 光学性质计算依赖于高质量的基态电子波函数。本章的核心目标不仅仅是完成 SCF 自洽计算，更重要的是“生产数据”——正确输出 pyatb 所需的稀疏矩阵文件。

### Section 2.1: 输入文件准备与关键参数设置
- **内容**: 以晶态二氧化硅 ($\text{SiO}_2$) 为例，构建 ABACUS 的 `INPUT` 文件。重点讲解 LCAO 基组下的矩阵输出设置，确保哈密顿量、重叠矩阵和位置算符矩阵被正确写入磁盘。
- **关键参数**: 
    - `calculation`: `scf`
    - `basis_type`: `lcao`
    - `out_mat_hs2`: `1` (输出二中心 H 和 S 稀疏矩阵)
    - `out_mat_r`: `1` (输出位置/偶极矩阵)
    - `out_chg`: `1`

### Section 2.2: 运行 SCF 与关键信息提取
- **内容**: 运行 ABACUS 自洽计算。教会读者从输出日志 (`running_scf.log` 或 `OUT` 文件夹) 中准确提取后续步骤必须的物理量：费米能级和占据能带数。检查生成的 `.csr` 文件是否完整。
- **关键参数**: 
    - 需提取: `E_Fermi` (费米能级)
    - 需提取: `occupied bands` (占据带数)

<!-- CHAPTER_START -->
## 第三章：介电函数计算 (pyatb)
**本章逻辑**: 这是本教程的核心操作部分。我们将使用 pyatb 读取上一步生成的矩阵，计算介电函数的虚部，并利用 Kramers-Kronig 关系得到实部。本章侧重于接口的正确配置。

### Section 3.1: 目录结构与数据迁移
- **内容**: 建立 pyatb 计算的工作目录。演示如何将 ABACUS 生成的 `data-HR-sparse_*.csr`, `data-SR-sparse_*.csr`, `data-rR-sparse.csr` 等文件正确复制或链接到当前目录，这是最容易出错的步骤之一。
- **关键参数**: 无

### Section 3.2: pyatb 输入文件编写
- **内容**: 编写 pyatb 的 `Input` 文件。详细讲解如何填入从 ABACUS 日志中提取的费米能级和占据带数，如何手动定义晶格信息（LATTICE），以及如何设置能量网格和展宽因子以获得平滑的光谱。
- **关键参数**: 
    - `fermi_energy`: (需与 SCF 结果一致)
    - `occ_band`: (需与 SCF 结果一致)
    - `HR_route`, `SR_route`, `rR_route`: (指定矩阵文件路径)
    - `omega`, `domega`: (能量范围与步长)
    - `eta`: (展宽因子)
    - `grid`: (K 点网格密度)

### Section 3.3: 运行计算与原始数据解析
- **内容**: 提交 pyatb 任务并监控运行状态。初步查看输出文件 `dielectric_function_imag_part.dat` 和 `dielectric_function_real_part.dat` 的格式与内容，理解张量分量 ($xx, yy, zz$ 等) 的含义。
- **关键参数**: 无

<!-- CHAPTER_START -->
## 第四章：后处理与光谱分析
**本章逻辑**: 原始的介电函数数据往往不能直接与实验光谱对比。本章将通过 Python 脚本，演示如何进行单位换算和物理公式应用，计算出吸收系数、反射率等实验可观测的物理量，并进行可视化。

### Section 4.1: 数据读取与张量平均
- **内容**: 使用 Python (`numpy`) 读取介电函数的实部和虚部数据。对于多晶或无序体系，演示如何对介电张量的对角元 ($xx, yy, zz$) 进行平均处理，以获得各向同性的介电函数。
- **关键参数**: 无

### Section 4.2: 吸收系数计算与单位换算 (难点)
- **内容**: 详细推导从介电函数到吸收系数 $\alpha(\omega)$ 的计算公式。**重点讲解单位换算逻辑**：如何将原子单位或 eV 单位下的计算结果，结合光速 $c$ 和普朗克常数 $\hbar$，转换为实验常用的 $\text{cm}^{-1}$ 单位。
- **关键参数**: 
    - 物理常数: `c` (光速), `hbar` (普朗克常数)
    - 转换因子: (eV 到 $s^{-1}$, m 到 cm)

### Section 4.3: 多物理量可视化与分析
- **内容**: 使用 `matplotlib` 绘制折射率、消光系数、吸收系数和能量损失函数随能量变化的曲线。引导读者分析光谱特征（如吸收峰位置）与能带结构（如带隙宽度）的对应关系。
- **关键参数**: 无

<!-- APPENDIX_START -->
## 附录：常见问题与进阶建议
- **K 点收敛性**: 为什么光学性质计算通常需要比 SCF 更密的 K 点网格 (`grid` 参数)？
- **空带数量**: 高能区光谱计算时，如何确定需要的空带数量 (`nbands`)？
- **费米能级陷阱**: 为什么 `fermi_energy` 填错会导致光谱完全错误（占据态跃迁问题）？