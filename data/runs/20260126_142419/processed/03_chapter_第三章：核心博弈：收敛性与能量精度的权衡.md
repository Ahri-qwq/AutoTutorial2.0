# 第三章：核心博弈：收敛性与能量精度的权衡

在上一章中，我们成功让 ABACUS 跑起来了。但在实际科研中，你很快会遇到一个棘手的问题：**SCF（自洽场）迭代不收敛**，或者收敛了但能量看起来很奇怪。

很多初学者会本能地去调整 `mixing_beta`（电荷混合参数），这固然有效，但往往忽略了另一个更本质的物理参数——**Smearing（能级展宽）**。

本章我们将深入探讨 `smearing_sigma` 和 `smearing_method` 这两个参数。它们是计算材料学中的“双刃剑”：用得好，能让金属性体系瞬间收敛；用不好，你的总能量计算结果将毫无物理意义。

---

## 3.1 Sigma 对 SCF 收敛性的影响：为什么我们需要“模糊”？

### 3.1.1 物理本质：费米面的困境
在绝对零度（DFT 的默认假设）下，金属的电子占据数在费米能级（Fermi Level）处是阶跃函数（Step Function）：能量低于 $E_F$ 的轨道完全占据（1），高于 $E_F$ 的完全空置（0）。

在 SCF 迭代过程中，如果费米能级附近的能级发生微小波动，电子可能会在“占据”和“空置”之间剧烈跳变。这种**电荷震荡（Charge Sloshing）**会导致电荷密度无法稳定，SCF 迟迟不能收敛。

**Smearing（展宽）** 的作用就是引入一个数学上的“模糊化”，将阶跃函数变成平滑函数（如高斯函数或费米-狄拉克函数）。这样，费米面附近的电子可以部分占据（如 0.5, 0.3），从而抑制震荡。

### 3.1.2 ABACUS 关键参数设置

在 `INPUT` 文件中，控制这一行为的核心参数如下：

```bash
INPUT_PARAMETERS
# ... 其他参数 ...
smearing_method  mp      # 展宽方法
smearing_sigma   0.01    # 展宽宽度 (单位：Ry)
```

#### **A. `smearing_method` 的选择策略**

| 体系类型 | 推荐方法 | 说明 |
| :--- | :--- | :--- |
| **宽带隙绝缘体/半导体** | `fixed` 或 `gauss` | 绝缘体有带隙，不需要 Smearing 也能收敛。`fixed` 表示固定占据数（整数）。若需用 Smearing，请配合极小的 Sigma。 |
| **金属/窄带隙半导体** | `mp` (推荐) | Methfessel-Paxton (MP) 方法。它在数学上构造得更好，使得总能量对 Sigma 的依赖性更小（二阶近似）。 |
| **高温模拟/随机波函数** | `fd` | Fermi-Dirac 分布。这具有真实的物理意义（电子温度），通常用于模拟高温环境。 |

#### **B. `smearing_sigma` 的调节**
- **值越大**：电子分布越平滑，SCF **越容易收敛**，但物理结果越“失真”。
- **值越小**：结果越接近 0K 的真实基态，但 SCF **越难收敛**。

---

## 3.2 Sigma 对总能量的影响与外推：精度陷阱

增大 Sigma 虽然能加速收敛，但它引入了非物理的“电子熵”贡献。我们需要警惕由此带来的能量误差。

### 3.2.1 ⚠️ 核心警告：单位陷阱（The Unit Trap）

这是 ABACUS 新手最容易犯的**致命错误**：

> **ABACUS 的 `smearing_sigma` 单位是 Rydberg (Ry)，不是 eV！**

*   **1 Ry $\approx$ 13.605 eV**
*   **常规推荐值**：`0.01` Ry ($\approx$ 0.136 eV) 到 `0.02` Ry ($\approx$ 0.272 eV)。

**错误案例**：
如果你习惯了 VASP（单位是 eV），在 ABACUS 中直接填入 `0.05`（以为是 0.05 eV），实际上你设置的是 **0.05 Ry $\approx$ 0.68 eV**。
这相当于给电子施加了数千度的高温！你的晶格常数、体模量、磁性结果将完全不可信。

### 3.2.2 能量精度的权衡策略

由于 Smearing 引入了误差，我们通常采用以下策略来平衡收敛性与精度：

1.  **粗糙收敛 (Coarse Run)**：
    *   设置 `smearing_sigma 0.02` (Ry)。
    *   目的：快速获得初步的电荷密度和波函数。
2.  **精确计算 (Fine Run)**：
    *   读取上一步的电荷密度（`init_chg file`）。
    *   减小 `smearing_sigma` 至 `0.01` 或 `0.005` (Ry)。
    *   目的：获得精确的总能量。

### 3.2.3 能量外推测试
对于高精度计算（如相变边界），建议测试 3-4 个 Sigma 值（例如 0.02, 0.015, 0.01），观察总能量的变化趋势。理想情况下，`mp` 方法计算出的能量随 Sigma 的变化较小，且可以通过线性外推估算 Sigma=0 时的能量。

---

## 3.3 能量对比的一致性原则

在计算**形成能 (Formation Energy)**、**吸附能 (Adsorption Energy)** 或 **反应能垒 (Barrier)** 时，你是在做减法：
$$ \Delta E = E_{\text{sys}} - E_{\text{part1}} - E_{\text{part2}} $$

### 3.3.1 绝对禁止的操作
**严禁**为了某个难收敛的结构单独修改 Smearing 参数！

*   **错误示范**：
    *   金属表面（难收敛）：使用 `smearing_sigma 0.02`
    *   气体分子（易收敛）：使用 `smearing_sigma 0.001` 或 `fixed`
    *   **后果**：这两个能量处于不同的“热力学参考态”，直接相减得到的吸附能包含巨大的系统误差。

### 3.3.2 正确的操作原则
参与对比的所有结构（反应物、产物、过渡态、孤立原子），必须使用**完全一致**的 `smearing_method` 和 `smearing_sigma`。

*   **特例处理**：如果体系中包含气相分子（通常是绝缘的）和金属表面。为了保持一致性，通常建议**气相分子也使用与金属表面相同的 Smearing 设置**（例如 `mp`, `0.01 Ry`）。虽然分子不需要 Smearing，但 MP 方法在 Sigma 较小时对绝缘体能量的影响极小，这样可以保证能量零点的一致性。

---

## 3.4 实战演练：金属铝的收敛性测试

让我们通过一个简单的例子，体验 Sigma 对收敛步数和能量的影响。

### 3.4.1 准备 INPUT 文件
创建一个文件夹 `tests/Al_smearing`，编写 `INPUT` 文件：

```bash
INPUT_PARAMETERS
# 系统定义
suffix          Al_test
ntype           1
ecutwfc         50
# 核心参数
basis_type      pw
calculation     scf
# 收敛相关
scf_thr         1e-6
mixing_type     broyden
mixing_beta     0.7
# Smearing 测试变量 (我们将手动修改这里)
smearing_method mp
smearing_sigma  0.01 
```

### 3.4.2 实验步骤
1.  **测试组 A**: 设置 `smearing_sigma 0.001` (过小)。
    *   *预期结果*：SCF 震荡严重，可能达到 100 步仍不收敛，或者收敛极慢。
2.  **测试组 B**: 设置 `smearing_sigma 0.01` (标准)。
    *   *预期结果*：SCF 在 15-25 步左右收敛。
3.  **测试组 C**: 设置 `smearing_sigma 0.05` (过大)。
    *   *预期结果*：SCF 收敛极快（<15 步），但总能量与组 B 相比有显著差异（可能差几十 meV/atom）。

### 3.4.3 结果分析
在输出文件（或屏幕输出）中，关注 `Total Energy`。你会发现：
*   Sigma 越大，收敛越快。
*   但是，我们需要寻找一个 Sigma 值，使得能量收敛（即继续减小 Sigma，能量几乎不变）。对于大多数金属体系，`0.01 Ry` 是一个极佳的平衡点。

---

## 本章总结

1.  **Smearing 是为了解决金属体系费米面附近的电荷震荡问题。**
2.  **牢记单位**：`smearing_sigma` 的单位是 **Ry**。`0.01 Ry` 是黄金标准。
3.  **一致性原则**：计算能量差时，所有相关计算必须使用相同的 Smearing 参数。
4.  **分类讨论**：
    *   金属：用 `mp`。
    *   半导体/绝缘体：用 `fixed` 或 `gauss` (极小 sigma)。

在掌握了能量收敛的技巧后，下一章我们将进入材料计算中最常见的任务：**结构优化（Relaxation）**，让原子找到它们最舒适的位置。