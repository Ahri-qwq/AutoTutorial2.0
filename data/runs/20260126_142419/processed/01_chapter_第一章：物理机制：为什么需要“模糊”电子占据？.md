# 第一章：物理机制：为什么需要“模糊”电子占据？

在开始编写 `INPUT` 文件之前，我们必须先解决一个在计算材料学中最容易被误解，同时也是导致金属体系计算失败（SCF 不收敛）的头号元凶——**Smearing（展宽）**。

很多初学者认为 DFT 计算就是求解 0K 下的薛定谔方程，因此电子的占据应当是严格的“非此即彼”（即费米能级以下全满，以上全空）。然而，在实际的数值计算中，这种“严格”却往往是灾难的开始。本章将带你理解为什么我们需要在数学上引入“模糊”的电子占据，以及它背后的物理代价。

---

## 1.1 费米面处的数值困境：从阶梯到斜坡

### 0K 下的阶梯函数（Step Function）
在绝对零度（0K）下，金属内的电子遵循费米-狄拉克分布的极限形式：阶梯函数。
- 能量 $E < E_f$ 的能带：占据数 $f = 1$（全满）。
- 能量 $E > E_f$ 的能带：占据数 $f = 0$（全空）。

### 电荷震荡（Charge Sloshing）
在 DFT 的自洽场（SCF）迭代过程中，我们不断更新电荷密度和势场。对于金属体系，费米能级 $E_f$ 往往穿过某条能带。
如果采用严格的阶梯函数：
1.  **迭代 N**：某条能带的能量略低于 $E_f$，被判定为“全满”，贡献大量电荷。
2.  **势场更新**：由于电荷增加，库仑排斥导致该区域势能上升，能带能量略微升高，超过了 $E_f$。
3.  **迭代 N+1**：该能带瞬间变为“全空”，电荷密度剧烈下降。
4.  **结果**：电荷在费米面附近“大幅度吞吐”，导致 SCF 能量在两个数值间剧烈跳动，永远无法收敛。这就是著名的 **Charge Sloshing** 现象。

### 解决方案：引入 Smearing
为了解决这个问题，我们在数学上引入一个平滑函数（如高斯函数或费米-狄拉克函数），将费米面附近的阶梯“磨平”成一个斜坡。
- 电子不再是“全有或全无”，而是允许出现分数占据（如 0.8, 0.5, 0.2）。
- 当能带在 $E_f$ 附近微小波动时，电荷密度的变化是连续且平滑的，从而抑制了震荡，帮助 SCF 快速收敛。

---

## 1.2 电子熵与自由能修正

引入 Smearing 等效于引入了一个非零的“电子温度”（尽管我们通常仍在模拟 0K 的晶格结构）。根据热力学定律，系统的能量不再是单纯的基态内能 $E$，而是自由能 $F$：

$$ F = E - TS_e $$

其中：
- $T$：由 Smearing 宽度（`smearing_sigma`）决定的虚构温度。
- $S_e$：电子熵（Electronic Entropy）。

### 物理意义与修正
ABACUS 在输出文件中给出的 `Total Energy` 通常指的是自由能 $F$。
- **当 Sigma 很大时**：收敛非常快，但 $TS_e$ 项很大，计算出的能量 $F$ 偏离真实的物理基态能量 $E$ 较远。
- **当 Sigma 趋于 0 时**：$F \to E$，回归真实物理图像。

因此，我们的目标是：**在保证 SCF 收敛的前提下，尽可能使用小的 Sigma，或者使用对自由能不敏感的 Smearing 方法（如 Methfessel-Paxton）。**

---

## 1.3 ABACUS 实战核心原则（必读）

作为开发者，我必须严肃提醒以下四个在 ABACUS 中使用 Smearing 的关键原则。这不仅关乎收敛，更关乎结果的物理正确性。

### ⚠️ 核心原则 1：单位陷阱（Ry vs eV）
这是 VASP 用户转 ABACUS 最容易“翻车”的地方。
- **ABACUS 的 `smearing_sigma` 单位是 Rydberg (Ry)！**
- **1 Ry $\approx$ 13.6 eV**

如果你习惯了 VASP 中 `ISMEAR` 的 `0.05` (eV)，直接在 ABACUS 中设置 `smearing_sigma 0.05`，你实际上设置了 $0.05 \times 13.6 = 0.68 \text{ eV}$ 的巨大展宽！这会导致严重的物理误差。

**推荐转换表：**

| 目标展宽 (eV) | ABACUS 设置 (Ry) | 适用场景 |
| :--- | :--- | :--- |
| ~ 0.05 eV | **0.004 Ry** | 高精度金属计算 |
| ~ 0.13 eV | **0.01 Ry** | **标准金属计算（推荐起点）** |
| ~ 0.27 eV | **0.02 Ry** | 难收敛体系/粗略优化 |
| > 0.50 eV | > 0.04 Ry | **慎用**（除非做高温模拟） |

### ⚠️ 核心原则 2：能量对比的一致性
当你计算 **形成能、吸附能、反应势垒** 等需要能量相减的物理量时：
> **必须保证所有参与计算的结构（表面、分子、体相）使用完全相同的 `smearing_method` 和 `smearing_sigma`。**

严禁为了某个难收敛的结构单独增大 Sigma。如果 Sigma 不一致，两个系统的参考自由能基准不同，相减得到的结果没有物理意义。

### ⚠️ 核心原则 3：收敛与精度的 Trade-off 策略
- **Sigma 越大** $\rightarrow$ SCF 收敛越快 $\rightarrow$ 能量误差越大。
- **Sigma 越小** $\rightarrow$ SCF 收敛越慢 $\rightarrow$ 能量越接近真实基态。

**实战策略**：
对于极难收敛的金属体系（如磁性过渡金属板），可以采用“两步走”策略：
1.  先用较大的 `smearing_sigma 0.02` (Ry) 进行结构弛豫（Relaxation），快速获得合理的几何结构。
2.  读取优化后的结构，将 `smearing_sigma` 调小至 `0.01` (Ry) 或更小，进行最终的静态计算（SCF），获取精确能量。

### ⚠️ 核心原则 4：半导体 vs 金属的参数选择

在 `INPUT` 文件中，根据材料导电性选择方法：

#### A. 绝缘体 / 宽带隙半导体
理论上不需要 Smearing，但在 ABACUS 中通常保持开启以增加数值稳定性，但需极小的 Sigma。
```bash
# INPUT 片段
smearing_method  fixed    # 或者 gauss
smearing_sigma   0.001    # 非常小的值，仅用于数值稳定
```
*注：对于有带隙体系，`fixed` 对应固定占据数，是物理上最严谨的描述。*

#### B. 金属 / 窄带隙体系 / 表面体系
必须开启 Smearing。
```bash
# INPUT 片段
smearing_method  mp      # 推荐 Methfessel-Paxton (一阶)
smearing_sigma   0.01    # 约 0.136 eV，标准推荐值
```
*注：`mp` (Methfessel-Paxton) 方法的优点是它构造了一个特殊的函数，使得在展宽较大时，计算出的自由能 $F$ 依然非常接近真实的 $E$。它是金属计算的首选。*

---

### 总结
理解了“模糊”占据的物理本质和 ABACUS 的单位特性后，你已经避开了 50% 的常见错误。下一章，我们将正式进入 `INPUT` 文件的核心参数配置。