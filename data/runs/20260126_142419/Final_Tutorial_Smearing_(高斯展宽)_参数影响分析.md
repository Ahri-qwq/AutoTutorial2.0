# ABACUS 实战进阶：展宽技术与电子占据的物理艺术

## 前言

欢迎来到《ABACUS 实战进阶》系列教程。作为国产开源第一性原理计算软件的佼佼者，ABACUS 在处理大规模体系和非局部赝势方面展现了卓越的性能。然而，对于许多初学者而言，从基础的原子建模跨越到复杂的金属体系计算时，往往会遭遇一个隐形且致命的屏障——自洽场（SCF）不收敛。本教程的核心任务，就是带你攻克这一屏障背后的核心技术：展宽（Smearing）。

**学习路线图**
为了帮助读者构建系统化的知识体系，本书设计了循序渐进的四个章节：
1. **物理机制**：从 0K 下费米面的数值困境出发，理解为什么“模糊”占据是数值计算的必然选择。
2. **参数详解**：深度剖析 ABACUS 中 `smearing_method` 与 `smearing_sigma` 的设置，特别强调了令无数新手折戟的单位换算问题。
3. **核心博弈**：探讨收敛速度与能量精度之间的“双刃剑”平衡，揭示物理参数如何影响计算的可信度。
4. **场景实战**：针对绝缘体、半导体及金属体系，给出差异化的配置策略与避坑指南。

**知识体系定位**
在 ABACUS 的整个 DFT 知识体系中，展宽技术位于“自洽场迭代优化”这一核心模块。它不仅与布里渊区积分（K点采样）紧密相连，更与电荷密度混合（Mixing）共同决定了计算的稳定性。掌握了展宽，就意味着你掌握了处理复杂金属性体系的“金钥匙”。

**前置知识**
在开始本教程之前，我们建议读者已经具备以下基础：
- 密度泛函理论（DFT）的基本概念。
- 能够独立完成简单的 ABACUS 算例（如硅的结构优化）。
- 对能带结构和费米面有初步的物理直觉。

---

# 第一章：物理机制：为什么需要“模糊”电子占据？

在开始编写 `INPUT` 文件之前，我们必须先解决一个在计算材料学中最容易被误解，同时也是导致金属体系计算失败（SCF 不收敛）的头号元凶——**Smearing（展宽）**。

很多初学者认为 DFT 计算就是求解 0K 下的薛定谔方程，因此电子的占据应当是严格的“非此即彼”（即费米能级以下全满，以上全空）。然而，在实际的数值计算中，这种“严格”却往往是灾难的开始。本章将带你理解为什么我们需要在数学上引入“模糊”的电子占据，以及它背后的物理代价。

---

## 1.1 费米面处的数值困境：从阶梯到斜坡

### 0K 下的阶梯函数（Step Function）
在绝对零度（0K）下，金属内的电子遵循费米-狄拉克分布的极限形式：阶梯函数。
- 能量 $E < E_f$ 的能带：占据数 $f = 1$（全满）。
- 能量 $E > E_f$ 的能带：占据数 $f = 0$（全空）。

### 电荷震荡（Charge Sloshing）
在 DFT 的自洽场（SCF）迭代过程中，我们不断更新电荷密度和势场。对于金属体系，费米能级 $E_f$ 往往穿过某条能带。
如果采用严格的阶梯函数：
1.  **迭代 N**：某条能带的能量略低于 $E_f$，被判定为“全满”，贡献大量电荷。
2.  **势场更新**：由于电荷增加，库仑排斥导致该区域势能上升，能带能量略微升高，超过了 $E_f$。
3.  **迭代 N+1**：该能带瞬间变为“全空”，电荷密度剧烈下降。
4.  **结果**：电荷在费米面附近“大幅度吞吐”，导致 SCF 能量在两个数值间剧烈跳动，永远无法收敛。这就是著名的 **Charge Sloshing** 现象。

### 解决方案：引入 Smearing
为了解决这个问题，我们在数学上引入一个平滑函数（如高斯函数或费米-狄拉克函数），将费米面附近的阶梯“磨平”成一个斜坡。
- 电子不再是“全有或全无”，而是允许出现分数占据（如 0.8, 0.5, 0.2）。
- 当能带在 $E_f$ 附近微小波动时，电荷密度的变化是连续且平滑的，从而抑制了震荡，帮助 SCF 快速收敛。

---

## 1.2 电子熵与自由能修正

引入 Smearing 等效于引入了一个非零的“电子温度”（尽管我们通常仍在模拟 0K 的晶格结构）。根据热力学定律，系统的能量不再是单纯的基态内能 $E$，而是自由能 $F$：

$$ F = E - TS_e $$

其中：
- $T$：由 Smearing 宽度（`smearing_sigma`）决定的虚构温度。
- $S_e$：电子熵（Electronic Entropy）。

### 物理意义与修正
ABACUS 在输出文件中给出的 `Total Energy` 通常指的是自由能 $F$。
- **当 Sigma 很大时**：收敛非常快，但 $TS_e$ 项很大，计算出的能量 $F$ 偏离真实的物理基态能量 $E$ 较远。
- **当 Sigma 趋于 0 时**：$F \to E$，回归真实物理图像。

因此，我们的目标是：**在保证 SCF 收敛的前提下，尽可能使用小的 Sigma，或者使用对自由能不敏感的 Smearing 方法（如 Methfessel-Paxton）。**

---

## 1.3 ABACUS 实战核心原则（必读）

作为开发者，我必须严肃提醒以下四个在 ABACUS 中使用 Smearing 的关键原则。这不仅关乎收敛，更关乎结果的物理正确性。

### ⚠️ 核心原则 1：单位陷阱（Ry vs eV）
这是 VASP 用户转 ABACUS 最容易“翻车”的地方。
- **ABACUS 的 `smearing_sigma` 单位是 Rydberg (Ry)！**
- **1 Ry $\approx$ 13.6 eV**

如果你习惯了 VASP 中 `ISMEAR` 的 `0.05` (eV)，直接在 ABACUS 中设置 `smearing_sigma 0.05`，你实际上设置了 $0.05 \times 13.6 = 0.68 \text{ eV}$ 的巨大展宽！这会导致严重的物理误差。

**推荐转换表：**

| 目标展宽 (eV) | ABACUS 设置 (Ry) | 适用场景 |
| :--- | :--- | :--- |
| ~ 0.05 eV | **0.004 Ry** | 高精度金属计算 |
| ~ 0.13 eV | **0.01 Ry** | **标准金属计算（推荐起点）** |
| ~ 0.27 eV | **0.02 Ry** | 难收敛体系/粗略优化 |
| > 0.50 eV | > 0.04 Ry | **慎用**（除非做高温模拟） |

### ⚠️ 核心原则 2：能量对比的一致性
当你计算 **形成能、吸附能、反应势垒** 等需要能量相减的物理量时：
> **必须保证所有参与计算的结构（表面、分子、体相）使用完全相同的 `smearing_method` 和 `smearing_sigma`。**

严禁为了某个难收敛的结构单独增大 Sigma。如果 Sigma 不一致，两个系统的参考自由能基准不同，相减得到的结果没有物理意义。

### ⚠️ 核心原则 3：收敛与精度的 Trade-off 策略
- **Sigma 越大** $\rightarrow$ SCF 收敛越快 $\rightarrow$ 能量误差越大。
- **Sigma 越小** $\rightarrow$ SCF 收敛越慢 $\rightarrow$ 能量越接近真实基态。

**实战策略**：
对于极难收敛的金属体系（如磁性过渡金属板），可以采用“两步走”策略：
1.  先用较大的 `smearing_sigma 0.02` (Ry) 进行结构弛豫（Relaxation），快速获得合理的几何结构。
2.  读取优化后的结构，将 `smearing_sigma` 调小至 `0.01` (Ry) 或更小，进行最终的静态计算（SCF），获取精确能量。

### ⚠️ 核心原则 4：半导体 vs 金属的参数选择

在 `INPUT` 文件中，根据材料导电性选择方法：

#### A. 绝缘体 / 宽带隙半导体
理论上不需要 Smearing，但在 ABACUS 中通常保持开启以增加数值稳定性，但需极小的 Sigma。
```bash
# INPUT 片段
smearing_method  fixed    # 或者 gauss
smearing_sigma   0.001    # 非常小的值，仅用于数值稳定
```
*注：对于有带隙体系，`fixed` 对应固定占据数，是物理上最严谨的描述。*

#### B. 金属 / 窄带隙体系 / 表面体系
必须开启 Smearing。
```bash
# INPUT 片段
smearing_method  mp      # 推荐 Methfessel-Paxton (一阶)
smearing_sigma   0.01    # 约 0.136 eV，标准推荐值
```
*注：`mp` (Methfessel-Paxton) 方法的优点是它构造了一个特殊的函数，使得在展宽较大时，计算出的自由能 $F$ 依然非常接近真实的 $E$。它是金属计算的首选。*

---

### 总结
理解了“模糊”占据的物理本质和 ABACUS 的单位特性后，你已经避开了 50% 的常见错误。下一章，我们将正式进入 `INPUT` 文件的核心参数配置。

# 第二章：参数详解：ABACUS 中的 Smearing 设置

在第一章完成了环境搭建与基本运行后，我们现在进入实战核心——`INPUT` 参数文件的深度解析。

在 DFT 计算中，**Smearing（展宽）** 是一个看似不起眼，实则对**收敛性（Convergence）**和**能量精度（Accuracy）**有着决定性影响的参数。特别是在处理金属体系或复杂磁性体系时，错误的 Smearing 设置往往是 SCF（自洽场）不收敛或结果荒谬的罪魁祸首。

本章将带你深入理解 ABACUS 中的展宽机制，并重点解决一个困扰了无数新手的“隐形杀手”——**单位问题**。

---

## 2.1 展宽方法的选择 (Method)

在 ABACUS 的 `INPUT` 文件中，`smearing_method` 参数决定了电子在费米能级附近的占据方式。简单来说，它决定了我们如何处理布里渊区积分中的不连续性。

### 核心参数：`smearing_method`

#### 1. `fixed`：绝缘体与半导体的首选
- **适用场景**：具有清晰带隙（Band Gap）的绝缘体、半导体、孤立分子。
- **原理**：使用固定的整数占据数。此时电子数必须严格匹配能带数，不进行任何展宽处理。
- **注意**：如果你计算的是金属，或者带隙非常小的体系，使用 `fixed` 会导致 SCF 极难收敛，甚至震荡发散。

#### 2. `gauss` (Gaussian)：通用且安全的“万金油”
- **适用场景**：任何体系，但主要用于**难以确定带隙的绝缘体**或**初步测试**。
- **原理**：使用高斯函数对费米能级附近的电子态密度进行平滑处理。
- **优缺点**：
    - **优点**：非常稳健，几乎不会导致负的占据数，收敛性较好。
    - **缺点**：为了获得精确的总能量，需要将展宽宽度（Sigma）设得非常小，或者进行 Sigma $\to$ 0 的能量外推。否则，计算出的能量会包含较大的“非物理”熵贡献。

#### 3. `mp` (Methfessel-Paxton)：金属体系的标准配置
- **适用场景**：**金属**、合金、表面吸附体系（涉及金属基底）。
- **原理**：在 Gaussian 基础上引入高阶厄米多项式修正。
- **核心优势**：它能比 Gaussian 方法更好地近似 T=0K 时的阶梯函数。这意味着，即使使用稍大的 Sigma（为了好收敛），算出来的总能量依然非常接近真实的基态能量。
- **警告**：MP 方法可能会产生非物理的**负占据数**或大于1的占据数。这在数学上是为了能量收敛，但在做态密度（DOS）分析时需留意。对于宽带隙绝缘体，**严禁**使用 `mp`，否则可能错误地预测出金属性。

#### 4. `fd` (Fermi-Dirac)：有限温度模拟
- **适用场景**：**高温分子动力学（AIMD）**、需要考虑电子温度效应的体系。
- **原理**：使用真实的费米-狄拉克分布函数。此时 Sigma 具有明确的物理意义——电子温度 ($k_B T$)。

---

## 2.2 展宽宽度的设定与单位陷阱 (Sigma)

这是本章最关键的部分。请务必打起十二分精神，因为这里有一个**极易踩中的陷阱**。

### 核心参数：`smearing_sigma`

该参数定义了展宽的能量范围（即高斯函数的宽度或电子温度）。

### ⚠️ 红色警报：单位是 Rydberg (Ry) 不是 eV！

许多从 VASP 或其他软件转到 ABACUS 的用户，习惯了 eV 单位。在 VASP 中，`SIGMA = 0.05` 意味着 0.05 eV。

**但是，在 ABACUS 中，`smearing_sigma` 的默认单位是 Ry (Rydberg)！**

让我们算一笔账：
- $1 \text{ Ry} \approx 13.605 \text{ eV}$
- 如果你在 ABACUS 中填入 `smearing_sigma 0.05`（误以为是 0.05 eV）：
    - 实际效果 $= 0.05 \times 13.605 \approx \mathbf{0.68 \text{ eV}}$
- **后果**：0.68 eV 的展宽对于大多数金属体系来说**太大了**！这相当于给电子加热到了几千度，会导致总能量严重偏离基态，原子受力计算错误，甚至导致结构优化得到错误的晶格常数。

#### 推荐设置值 (Reference Values)

| 体系类型 | 推荐方法 (`smearing_method`) | 推荐宽度 (`smearing_sigma`) | 对应 eV 值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **绝缘体/半导体** | `fixed` | (忽略) | - | 最准确 |
| **绝缘体 (难收敛)**| `gauss` | `0.001` ~ `0.005` | ~0.01 - 0.07 eV | 尽量小 |
| **金属 (常规)** | `mp` | `0.01` ~ `0.02` | ~0.13 - 0.27 eV | 兼顾收敛与精度 |
| **金属 (难收敛)** | `mp` | `0.02` ~ `0.03` | ~0.27 - 0.40 eV | 需测试能量对 Sigma 的收敛性 |
| **高温 MD** | `fd` | `0.002` ~ `0.01` | 取决于物理温度 | 对应真实温度 |

### 替代参数：`smearing_sigma_temp` (Kelvin)

如果你不想进行 Ry 和 eV 的换算，ABACUS 提供了一个更直观的参数：`smearing_sigma_temp`，单位是 **Kelvin (K)**。

*   **互斥规则**：`smearing_sigma` 和 `smearing_sigma_temp` **不能同时出现**在 INPUT 文件中。
*   **换算关系**：$1 \text{ Ry} \approx 157887 \text{ K}$。
    *   例如：设置 `smearing_sigma 0.01` (Ry) 等效于 `smearing_sigma_temp 1579` (K)。

---

## 2.3 实战策略：收敛性与精度的权衡

在实际计算中，我们经常面临一个 Trade-off（权衡）：
- **Sigma 越大**：电荷密度混合越平滑，SCF 迭代**越容易收敛**，但总能量**越不准确**。
- **Sigma 越小**：结果越接近真实的基态物理，但 SCF 容易在费米面附近发生**电荷震荡**（Charge Sloshing），导致不收敛。

### 策略一：分步收敛法 (Step-down Strategy)
对于极难收敛的磁性金属或团簇体系，建议采用“先粗后细”的策略：

1.  **第一步**：设置较大的 Sigma（如 `0.02` Ry 或 `0.03` Ry），先让 SCF 跑通，得到一个收敛的电荷密度（`SPIN1_CHG`）。
2.  **第二步**：读取上一步的电荷密度，减小 Sigma（如 `0.01` Ry），继续进行 SCF 计算。

### 策略二：能量对比的一致性原则
**这是科研红线**：当你计算形成能、吸附能或反应势垒时，涉及相减的两个体系（例如：`表面+分子` 与 `洁净表面`），**必须使用完全相同的 Smearing 设置**。

*   **错误示范**：
    *   洁净表面用 `smearing_sigma 0.01`。
    *   吸附体系因为难收敛，改用了 `smearing_sigma 0.02`。
    *   **结果**：计算出的吸附能包含了两者的“熵贡献差”，结果无效。

---

## 2.4 输入文件示例

### 场景 A：常规金属计算 (如 Cu, Al, Pt)
这是最常见的金属计算设置，兼顾效率与准确性。

```bash
# INPUT file snippet
calculation        scf
basis_type         lcao

# Smearing settings
smearing_method    mp      # Methfessel-Paxton for metals
smearing_sigma     0.01    # 0.01 Ry ~= 0.136 eV. DO NOT use 0.1!
```

### 场景 B：宽带隙半导体 (如 Si, TiO2)
如果结构合理，首选 `fixed`。如果遇到收敛困难，退化为 `gauss`。

```bash
# INPUT file snippet
calculation        scf

# Smearing settings
smearing_method    fixed   # Strict occupation
# smearing_sigma is ignored here
```

### 场景 C：高温分子动力学 (3000K)
模拟极端条件下的物质状态。

```bash
# INPUT file snippet
calculation        md

# Smearing settings
smearing_method    fd      # Fermi-Dirac
smearing_sigma_temp 3000   # Temperature in Kelvin
# Do NOT set smearing_sigma
```

---

## 本章总结

1.  **选对方法**：绝缘体用 `fixed`，金属用 `mp`，高温/MD 用 `fd`。
2.  **盯紧单位**：`smearing_sigma` 的单位是 **Ry**。**0.01 Ry** 是一个好的起点，千万别填成 0.1 或 0.05（除非你真的知道自己在做什么）。
3.  **保持一致**：对比能量时，Smearing 参数必须“神圣不可侵犯”，严禁随意更改。

下一章，我们将讨论决定计算速度与精度的另一个核心参数：**基组与截断能 (Basis Set & Ecut)**。

# 第三章：核心博弈：收敛性与能量精度的权衡

在上一章中，我们成功让 ABACUS 跑起来了。但在实际科研中，你很快会遇到一个棘手的问题：**SCF（自洽场）迭代不收敛**，或者收敛了但能量看起来很奇怪。

很多初学者会本能地去调整 `mixing_beta`（电荷混合参数），这固然有效，但往往忽略了另一个更本质的物理参数——**Smearing（能级展宽）**。

本章我们将深入探讨 `smearing_sigma` 和 `smearing_method` 这两个参数。它们是计算材料学中的“双刃剑”：用得好，能让金属性体系瞬间收敛；用不好，你的总能量计算结果将毫无物理意义。

---

## 3.1 Sigma 对 SCF 收敛性的影响：为什么我们需要“模糊”？

### 3.1.1 物理本质：费米面的困境
在绝对零度（DFT 的默认假设）下，金属的电子占据数在费米能级（Fermi Level）处是阶跃函数（Step Function）：能量低于 $E_F$ 的轨道完全占据（1），高于 $E_F$ 的完全空置（0）。

在 SCF 迭代过程中，如果费米能级附近的能级发生微小波动，电子可能会在“占据”和“空置”之间剧烈跳变。这种**电荷震荡（Charge Sloshing）**会导致电荷密度无法稳定，SCF 迟迟不能收敛。

**Smearing（展宽）** 的作用就是引入一个数学上的“模糊化”，将阶跃函数变成平滑函数（如高斯函数或费米-狄拉克函数）。这样，费米面附近的电子可以部分占据（如 0.5, 0.3），从而抑制震荡。

### 3.1.2 ABACUS 关键参数设置

在 `INPUT` 文件中，控制这一行为的核心参数如下：

```bash
INPUT_PARAMETERS
# ... 其他参数 ...
smearing_method  mp      # 展宽方法
smearing_sigma   0.01    # 展宽宽度 (单位：Ry)
```

#### **A. `smearing_method` 的选择策略**

| 体系类型 | 推荐方法 | 说明 |
| :--- | :--- | :--- |
| **宽带隙绝缘体/半导体** | `fixed` 或 `gauss` | 绝缘体有带隙，不需要 Smearing 也能收敛。`fixed` 表示固定占据数（整数）。若需用 Smearing，请配合极小的 Sigma。 |
| **金属/窄带隙半导体** | `mp` (推荐) | Methfessel-Paxton (MP) 方法。它在数学上构造得更好，使得总能量对 Sigma 的依赖性更小（二阶近似）。 |
| **高温模拟/随机波函数** | `fd` | Fermi-Dirac 分布。这具有真实的物理意义（电子温度），通常用于模拟高温环境。 |

#### **B. `smearing_sigma` 的调节**
- **值越大**：电子分布越平滑，SCF **越容易收敛**，但物理结果越“失真”。
- **值越小**：结果越接近 0K 的真实基态，但 SCF **越难收敛**。

---

## 3.2 Sigma 对总能量的影响与外推：精度陷阱

增大 Sigma 虽然能加速收敛，但它引入了非物理的“电子熵”贡献。我们需要警惕由此带来的能量误差。

### 3.2.1 ⚠️ 核心警告：单位陷阱（The Unit Trap）

这是 ABACUS 新手最容易犯的**致命错误**：

> **ABACUS 的 `smearing_sigma` 单位是 Rydberg (Ry)，不是 eV！**

*   **1 Ry $\approx$ 13.605 eV**
*   **常规推荐值**：`0.01` Ry ($\approx$ 0.136 eV) 到 `0.02` Ry ($\approx$ 0.272 eV)。

**错误案例**：
如果你习惯了 VASP（单位是 eV），在 ABACUS 中直接填入 `0.05`（以为是 0.05 eV），实际上你设置的是 **0.05 Ry $\approx$ 0.68 eV**。
这相当于给电子施加了数千度的高温！你的晶格常数、体模量、磁性结果将完全不可信。

### 3.2.2 能量精度的权衡策略

由于 Smearing 引入了误差，我们通常采用以下策略来平衡收敛性与精度：

1.  **粗糙收敛 (Coarse Run)**：
    *   设置 `smearing_sigma 0.02` (Ry)。
    *   目的：快速获得初步的电荷密度和波函数。
2.  **精确计算 (Fine Run)**：
    *   读取上一步的电荷密度（`init_chg file`）。
    *   减小 `smearing_sigma` 至 `0.01` 或 `0.005` (Ry)。
    *   目的：获得精确的总能量。

### 3.2.3 能量外推测试
对于高精度计算（如相变边界），建议测试 3-4 个 Sigma 值（例如 0.02, 0.015, 0.01），观察总能量的变化趋势。理想情况下，`mp` 方法计算出的能量随 Sigma 的变化较小，且可以通过线性外推估算 Sigma=0 时的能量。

---

## 3.3 能量对比的一致性原则

在计算**形成能 (Formation Energy)**、**吸附能 (Adsorption Energy)** 或 **反应能垒 (Barrier)** 时，你是在做减法：
$$ \Delta E = E_{\text{sys}} - E_{\text{part1}} - E_{\text{part2}} $$

### 3.3.1 绝对禁止的操作
**严禁**为了某个难收敛的结构单独修改 Smearing 参数！

*   **错误示范**：
    *   金属表面（难收敛）：使用 `smearing_sigma 0.02`
    *   气体分子（易收敛）：使用 `smearing_sigma 0.001` 或 `fixed`
    *   **后果**：这两个能量处于不同的“热力学参考态”，直接相减得到的吸附能包含巨大的系统误差。

### 3.3.2 正确的操作原则
参与对比的所有结构（反应物、产物、过渡态、孤立原子），必须使用**完全一致**的 `smearing_method` 和 `smearing_sigma`。

*   **特例处理**：如果体系中包含气相分子（通常是绝缘的）和金属表面。为了保持一致性，通常建议**气相分子也使用与金属表面相同的 Smearing 设置**（例如 `mp`, `0.01 Ry`）。虽然分子不需要 Smearing，但 MP 方法在 Sigma 较小时对绝缘体能量的影响极小，这样可以保证能量零点的一致性。

---

## 3.4 实战演练：金属铝的收敛性测试

让我们通过一个简单的例子，体验 Sigma 对收敛步数和能量的影响。

### 3.4.1 准备 INPUT 文件
创建一个文件夹 `tests/Al_smearing`，编写 `INPUT` 文件：

```bash
INPUT_PARAMETERS
# 系统定义
suffix          Al_test
ntype           1
ecutwfc         50
# 核心参数
basis_type      pw
calculation     scf
# 收敛相关
scf_thr         1e-6
mixing_type     broyden
mixing_beta     0.7
# Smearing 测试变量 (我们将手动修改这里)
smearing_method mp
smearing_sigma  0.01 
```

### 3.4.2 实验步骤
1.  **测试组 A**: 设置 `smearing_sigma 0.001` (过小)。
    *   *预期结果*：SCF 震荡严重，可能达到 100 步仍不收敛，或者收敛极慢。
2.  **测试组 B**: 设置 `smearing_sigma 0.01` (标准)。
    *   *预期结果*：SCF 在 15-25 步左右收敛。
3.  **测试组 C**: 设置 `smearing_sigma 0.05` (过大)。
    *   *预期结果*：SCF 收敛极快（<15 步），但总能量与组 B 相比有显著差异（可能差几十 meV/atom）。

### 3.4.3 结果分析
在输出文件（或屏幕输出）中，关注 `Total Energy`。你会发现：
*   Sigma 越大，收敛越快。
*   但是，我们需要寻找一个 Sigma 值，使得能量收敛（即继续减小 Sigma，能量几乎不变）。对于大多数金属体系，`0.01 Ry` 是一个极佳的平衡点。

---

## 本章总结

1.  **Smearing 是为了解决金属体系费米面附近的电荷震荡问题。**
2.  **牢记单位**：`smearing_sigma` 的单位是 **Ry**。`0.01 Ry` 是黄金标准。
3.  **一致性原则**：计算能量差时，所有相关计算必须使用相同的 Smearing 参数。
4.  **分类讨论**：
    *   金属：用 `mp`。
    *   半导体/绝缘体：用 `fixed` 或 `gauss` (极小 sigma)。

在掌握了能量收敛的技巧后，下一章我们将进入材料计算中最常见的任务：**结构优化（Relaxation）**，让原子找到它们最舒适的位置。

# 第四章：场景实战：不同体系的配置策略

这是一个非常关键的章节。在计算材料学中，电子占据数的展宽（Smearing）处理不仅影响自洽迭代（SCF）的收敛性，更直接决定了总能量的物理意义。

作为开发者，我经常看到用户（尤其是从 VASP 迁移过来的用户）因为单位混淆或策略错误导致计算结果偏差巨大。本章将手把手教你如何针对不同体系“对症下药”。

---

# 第四章：场景实战：不同体系的配置策略

在 DFT 计算中，我们通过数值积分来计算布里渊区内的电子密度。对于绝缘体，费米能级位于带隙中，积分相对简单；但对于金属，费米面穿过能带，导致被积函数发生阶跃，数值积分极难收敛。

为此，我们引入了 **Smearing（展宽）** 技术。本章将指导你如何在 ABACUS 中针对绝缘体、半导体和金属选择最正确的配置。

## 4.0 核心原则与单位陷阱（必读）

在开始具体场景前，请务必铭记以下两条“铁律”，它们是 ABACUS 用户最容易犯错的地方：

### 1. 单位是 Ry，不是 eV！
这是 ABACUS 与 VASP 等软件最大的区别之一。
- **参数**: `smearing_sigma`
- **单位**: **Rydberg (Ry)**
- **换算**: 1 Ry $\approx$ 13.605 eV

> **警示**：如果你习惯了 VASP 中的 `SIGMA = 0.05` (eV)，直接在 ABACUS 中设置 `smearing_sigma 0.05`，你实际上设置了 $0.05 \times 13.605 \approx 0.68$ eV 的巨大展宽！这会导致物理结果完全失真。
> **推荐**: ABACUS 中常用的 Sigma 范围通常在 **0.01 Ry (约 0.136 eV)** 到 **0.02 Ry (约 0.27 eV)** 之间。

### 2. 能量对比一致性原则
当你计算形成能、吸附能或反应势垒时，参与加减运算的所有体系（如：吸附物、基底、吸附体系）**必须使用完全相同的 Smearing 方法和 Sigma 值**。严禁为了让某个结构好收敛而单独增大它的 Sigma，这会导致能量基准面不一致，计算出的 $\Delta E$ 毫无意义。

---

## 4.1 绝缘体与半导体体系

对于有带隙的体系，我们的目标是尽量减少人为引入的电子分数占据，还原其绝缘/半导体本征特性。

### 场景 A：宽带隙绝缘体 (Wide Bandgap Insulators)
**典型体系**: SiO$_2$, NaCl, MgO
**物理特征**: 费米能级深深位于带隙之中，价带全满，导带全空。

**推荐配置**:
使用 `fixed` 方法。这对应于绝对零度下的阶跃函数，不引入任何展宽，物理上最严谨。

```bash
# INPUT file snippet
smearing_method  fixed  # 固定占据数
# smearing_sigma  # fixed 模式下该参数无效，可不写
```

### 场景 B：小带隙半导体 (Small Bandgap Semiconductors)
**典型体系**: Si, Ge, GaAs, TiO$_2$
**物理特征**: 虽然有带隙，但在 SCF 迭代初期，电荷密度波动可能导致能隙闭合或误判。

**推荐配置**:
推荐使用 `gauss` (高斯展宽) 配合极小的 Sigma。这样既能提供一定的数值稳定性，帮助 SCF 收敛，又因为 Sigma 很小，对总能量的修正（Entropy term）微乎其微。

```bash
# INPUT file snippet
smearing_method  gauss  # 高斯展宽
smearing_sigma   0.01   # 0.01 Ry ≈ 0.136 eV，足够小以保证精度
```

---

## 4.2 金属体系的标准配置

**典型体系**: Al, Cu, Fe, Pt, 石墨烯
**物理特征**: 费米面穿过能带，电子在费米面附近存在部分占据。

### 为什么不推荐 Gauss？
对于金属，如果使用 Gauss 方法，为了收敛通常需要较大的 Sigma。但 Gauss 方法引入的能量误差与 $\sigma^2$ 成正比，会导致总能量严重偏离基态。

### 推荐方案：Methfessel-Paxton (MP)
ABACUS 提供了 `mp` (一阶) 和 `mp2` (二阶) 方法。MP 方法通过构造特殊的数学函数（允许出现非物理的负占据数作为数学修正），使得总能量对 Sigma 的依赖关系变为 $\sigma^3$ 或更高阶。这意味着即使使用稍大的 Sigma 换取收敛性，计算出的能量依然非常接近真实的基态能量。

**推荐配置**:

```bash
# INPUT file snippet
smearing_method  mp     # 推荐用于金属弛豫
smearing_sigma   0.015  # 约 0.2 eV，兼顾收敛与精度
```

*   **常规金属**: `smearing_sigma` 建议在 0.01 ~ 0.02 Ry 之间。
*   **磁性金属**: 往往需要稍大的 Sigma (如 0.02 Ry) 来抑制磁矩翻转带来的电荷震荡。

---

## 4.3 难收敛体系的“两步走”策略

在处理复杂的磁性界面、大表面积的金属 Slab 或缺陷体系时，经常遇到 SCF 不收敛（Charge Sloshing）的情况。此时，“增大 Sigma”是有效的救急手段，但会牺牲精度。

为了平衡收敛性与精度，建议采用 **“两步走” (Two-Step)** 策略：

### 第一步：粗略收敛 (Coarse SCF)
使用较大的 Sigma 快速获得一个大致正确的电荷密度分布。

*   **INPUT 设置**:
    ```bash
    calculation     scf
    smearing_method mp
    smearing_sigma  0.03   # 较大展宽 (约 0.4 eV) 助收敛
    out_chg         1      # 必须输出电荷密度
    ```
*   **结果**: 运行结束后，目录下会生成 `SPIN1_CHG.cube` (或 `SPIN*_CHG`) 等文件。

### 第二步：高精度计算 (Fine SCF)
读取上一步的电荷密度作为初猜，减小 Sigma 进行最终计算。

*   **INPUT 设置**:
    ```bash
    calculation     scf
    init_chg        file   # 关键：从文件读取电荷密度
    smearing_method mp
    smearing_sigma  0.01   # 调回标准精度
    ```

> **专家提示**: 如果 Smearing 策略失效，请检查 `mixing_beta`。对于难收敛体系，通常需要同时降低 `mixing_beta` (例如从默认值降至 0.2 或 0.1)。

---

## 附录：常见问题与避坑指南

### 1. DOS 计算与 SCF 计算的区别
很多用户混淆了 SCF 过程中的展宽和画态密度（DOS）时的展宽。
*   **`smearing_sigma` (Ry)**: 用于 SCF 自洽迭代，改变电子占据数，**直接影响总能量和受力**。
*   **`dos_sigma` (eV)**: 仅用于 `calculation nscf` 或 `calculation dos` 后处理阶段。它只是为了让画出来的 DOS 曲线更平滑，**不改变系统的物理状态**。
*   **注意**: `dos_sigma` 的单位通常是 **eV**（请以具体版本文档为准，ABACUS 部分后处理工具使用 eV），而 INPUT 中的 `smearing_sigma` 永远是 **Ry**。

### 2. 结构弛豫中的“受力滞后”
当你使用较大的 `smearing_sigma` (如 > 0.02 Ry) 进行结构弛豫时，可能会发现能量已经收敛，但原子受力很难降到极低（如 0.01 eV/Ang）。
*   **原因**: 高温（大 Sigma）引入了电子熵效应，原子感受到的是“自由能面”上的力，而非单纯的势能面。
*   **对策**: 在结构弛豫的最后阶段，务必减小 Sigma 再次优化，以获得准确的基态结构。

### 3. 报错排查：Parameter Conflict
如果你在 INPUT 中同时设置了：
```bash
smearing_method  fixed
smearing_sigma   0.01
```
ABACUS 可能会在日志中给出警告或忽略 `smearing_sigma`。请养成良好的习惯：**只有在 `gauss`, `mp`, `mp2`, `fd` 模式下才设置 sigma 值**。

### 4. 关于 Fermi-Dirac (`fd`)
你可能会在文档中看到 `smearing_method fd`。这是费米-狄拉克分布。
*   **用途**: 主要用于**有限温度 DFT** (Finite Temperature DFT) 模拟，例如温稠密物质（Warm Dense Matter）。
*   **常规计算**: 对于常规的材料基态计算（模拟 0K 性质），**不推荐**使用 `fd`，因为它的能量拖尾效应比 `mp` 严重得多，需要极小的 Sigma 才能准确，但这又会导致收敛困难。金属计算请首选 `mp`。

---

## 附录：进阶学习指南

恭喜你完成了关于展宽技术的深度学习！在计算材料学的世界里，展宽只是揭开复杂电子结构计算面纱的第一步。为了进一步提升你的计算功力，我们建议在以下方向持续探索：

### 1. 深度扩展阅读
- **电子熵的贡献**：在阅读本教程后，你应意识到 Smearing 会引入额外的电子熵项（T*S）。进阶学习者应研究如何通过外推法（Extrapolation）获得更精确的 0K 总能量。
- **电荷混合算法**：展宽通常与电荷混合（`mixing_type`）协同作用。建议进一步研究 `broyden` 与 `pulay` 混合方法的差异，以及如何通过调整 `mixing_beta` 来辅助极端体系的收敛。
- **自洽场求解器**：除了展宽，`ks_solver`（如 `cg` 或 `genelpa`）的选择同样影响计算效率。了解不同求解器在处理大规模金属体系时的表现是通往专家之路的必经环节。

### 2. 通用调试建议（Troubleshooting）
- **单位警示**：再次强调，ABACUS 中的 `smearing_sigma` 单位为 Ry。若你习惯了 VASP 的 eV，请务必进行 1 Ry ≈ 13.6 eV 的换算。
- **一致性原则**：在对比一系列体系的能量（如计算形成能或反应能）时，必须确保所有体系使用完全相同的 `smearing_method` 和 `smearing_sigma`，否则能量差将失去物理意义。
- **收敛测试**：对于关键的物理量，务必进行 `sigma` 值的收敛性测试，观察物理量随展宽变小是否趋于稳定。

### 3. 推荐资源
- **官方文档**：始终将 [ABACUS 在线用户手册](https://abacus.deepmodeling.com/) 作为你的第一参考资料。
- **社区讨论**：积极参与 DeepModeling 社区交流，那里有许多关于复杂体系收敛技巧的实战经验分享。

科学计算是一场精度与效率的博弈，愿你能在这场博弈中游刃有余，探索物质微观世界的奥秘！
