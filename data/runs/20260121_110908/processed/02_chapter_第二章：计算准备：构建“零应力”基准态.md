# 第二章：计算准备：构建“零应力”基准态

> **教授寄语**：
> 欢迎来到弹性力学计算最关键的一步。很多初学者在计算弹性常数（Elastic Constants, $C_{ij}$）时，往往急于施加应变，却忽略了初始结构的质量。
> 请记住：**弹性常数是能量对晶格变形的二阶导数**。如果你的初始结构本身就带有残余应力（Residual Stress），那么你实际上是在一个倾斜的坡面上通过曲率来估算平地的性质，结果必然产生严重偏差（尤其是出现虚假的负值或非物理的各向异性）。
> 本章的目标只有一个：获得一个完美的、应力张量接近全零的“基准态”结构。

---

## 2.1 晶胞选取策略：原胞还是惯用胞？

在开始计算之前，我们面临的第一个选择是：使用**原胞 (Primitive Cell)** 还是**惯用胞 (Conventional Cell)**？

### 2.1.1 物理图像与计算便利性的权衡
在电子结构计算（如能带）中，为了节省算力，我们通常首选原子数最少的原胞。然而，在弹性力学计算中，**惯用胞往往是更好的选择**，特别是对于高对称性晶系（如立方晶系）。

*   **原胞 (Primitive Cell)**：体积最小，计算最快。但其晶格矢量通常不与笛卡尔坐标系（x, y, z）重合。
*   **惯用胞 (Conventional Cell)**：体积较大，计算较慢。但其晶格矢量通常沿笛卡尔轴对齐（例如立方晶系的 $a, b, c$ 轴分别对应 $x, y, z$ 方向）。

### 2.1.2 为什么推荐惯用胞？
弹性刚度矩阵 $C_{ij}$ 的形式高度依赖于坐标系的定义。
*   如果你使用**惯用胞**（如 Si 的立方胞）：计算出的 $C_{ij}$ 矩阵将直接符合标准教科书的形式（例如立方晶系仅 $C_{11}, C_{12}, C_{44}$ 非零）。
*   如果你使用**原胞**（如 Si 的菱形胞）：你需要处理复杂的张量旋转才能将结果转换回标准形式。

**教授建议**：
对于 **Si, Cu, Al** 等立方晶系材料，请务必使用 **惯用胞 (Conventional Cell)** 进行建模。虽然这会增加一定的计算量（原子数更多），但能避免后续极其繁琐且容易出错的张量坐标变换。

> **风险提示：Materials Project 的陷阱**
> 很多同学习惯从 Materials Project (MP) 数据库直接下载 CIF 文件。请注意，MP 数据库为了标准化，通常会将晶体旋转到符合 IEEE 标准的特定取向（Standard Orientation）。
> **自检步骤**：下载结构后，务必检查晶格矢量矩阵。对于立方晶系，确保晶格矢量矩阵是对角化的（或接近对角化）。如果发现晶格矢量与坐标轴有复杂夹角，请使用 ASE 或 pymatgen 将其重新对齐到笛卡尔坐标系。

---

## 2.2 初始结构的深度优化

获得正确的晶胞形式后，必须对其进行“深度弛豫”。这里的标准远高于普通的 SCF 计算，我们需要将原子受力和晶胞应力同时降至极低水平。

我们将采用 **Workflow A (推荐)**，即使用 `abacustest` 自动化工具，这是目前 ABACUS 生态中最规范的做法。

### 2.2.1 核心逻辑：两阶段优化策略
在进入实战前，必须清晰区分两个阶段。混淆这两个阶段是导致计算失败的常见原因。

| 阶段 | 任务目标 | `calculation` 参数 | 晶胞行为 | 原子行为 |
| :--- | :--- | :--- | :--- | :--- |
| **阶段一 (本章)** | **构建基准态** | **`cell-relax`** | **可变 (Variable)** | **移动** |
| 阶段二 (下一章) | 施加应变计算 | `relax` / `scf` | 固定 (Fixed)* | 移动 / 固定 |

*   **阶段一（本章重点）**：我们需要让晶胞“呼吸”，找到能量最低的体积和形状。此时晶格矢量会发生变化。
*   *阶段二（预告）*：在计算 $C_{ij}$ 时，我们会人为施加一个微小形变（如 1%），此时**必须锁死晶胞**（不能用 `cell-relax`），否则晶胞会试图“弹”回平衡态，导致应力松弛，无法测出应力响应。

### 2.2.2 实战操作：使用 `abacustest` 进行优化
假设你已经准备好了初始结构文件 `Si.cif`（惯用胞）。

#### 步骤 1: 生成优化任务
使用 `abacustest` 的 `lib-model` 子命令可以自动生成符合 ABACUS 规范的输入文件。

```bash
# 命令行操作
abacustest lib-model \
    -f Si.cif \
    --ftype cif \
    --jtype cell-relax \
    --lcao \
    --folder-syntax "Si_opt"
```

*   `-f Si.cif`: 指定输入结构。
*   `--jtype cell-relax`: **关键参数**。指定任务类型为变胞弛豫。
*   `--lcao`: 使用 LCAO 基组（效率更高，适合大超胞）。如果不加则默认可能使用平面波（PW）。
*   `--folder-syntax`: 指定生成的文件夹名称。

#### 步骤 2: 检查并微调 INPUT 文件
执行上述命令后，会生成一个 `Si_opt` 文件夹。请务必打开其中的 `INPUT` 文件进行核对。以下是优化任务的**黄金参数组合**：

```bash
INPUT_PARAMETERS
# ... (省略部分基础参数)

# 核心计算模式
calculation     cell-relax  # 必须：允许晶胞变形和原子移动
esolver_type    ks          # 使用 Kohn-Sham 求解器

# 力与应力计算 (弹性计算的基石)
cal_force       1           # 必须：计算原子受力
cal_stress      1           # 必须：计算晶胞应力 tensor

# 弛豫控制
relax_nmax      100         # 最大离子步数，防止不收敛死循环
force_thr_ev    0.001       # 力收敛标准 (eV/Angstrom)。建议比默认值更严
# press_thr       0.1       # (可选) 压强收敛标准 (Kbar)。

# 基组与精度
basis_type      lcao
ecutwfc         100         # 根据赝势推荐值设置，保证应力计算准确
```

> **专家点拨**：
> `cal_stress 1` 是绝对不可省略的。如果没有这一行，ABACUS 将不会计算应力张量，`cell-relax` 也就失去了依据，程序可能会报错或退化为普通弛豫。

#### 步骤 3: 提交计算与结果验证
提交任务（参考集群作业提交方式）。计算结束后，我们需要验证结构是否真的达到了“零应力”状态。

查看输出文件（通常在 `OUT.Si_opt/` 目录下）：
1.  **检查收敛性**：确保任务正常结束，而不是达到 `relax_nmax` 强行停止。
2.  **检查最终应力**：
    在日志或输出文件中查找最终的应力张量（Stress Tensor）。
    *   对于立方晶系，对角项（xx, yy, zz）应该非常接近（例如差异小于 0.1 kbar），且数值接近 0。
    *   非对角项（xy, yz, zx）应在数值噪音范围内接近 0。

### 2.2.3 常见误区：关于 `--norelax`
在 `abacustest` 的文档中，你可能会看到 `--norelax` 参数。
*   **在本章阶段（初始优化）**：**绝对不要**使用 `--norelax` 概念。我们需要充分的弛豫。
*   **在下一章阶段（施加应变）**：`abacustest` 在生成变形结构任务时，`--norelax` 参数决定了是进行“离子固定计算 (Clamped-ion)”还是“离子弛豫计算 (Relaxed-ion)”。
    *   **Clamped-ion**: 仅电子云响应，原子位置冻结。对应高频弹性性质。
    *   **Relaxed-ion (默认推荐)**: 允许原子在变形后的晶胞内移动到新的平衡位置。这对应准静态测量，**更符合大多数实验测量的物理场景**。

### 2.2.4 结果输出：作为新的起点
优化完成后，你会得到一个 `STRU_ION_D` (或类似名称的最终结构文件)。
**请务必使用这个优化后的结构**作为下一章施加应变的起点。切勿使用原始的 `Si.cif`，否则你的弹性常数计算将包含由初始残余应力带来的巨大误差。

---

**下章预告**：
拥有了完美的“零应力”基准结构后，下一章我们将化身为“虚拟实验员”，使用 `abacustest` 对晶体进行拉伸和剪切，并提取应力响应来求解 $C_{ij}$ 矩阵。我们将详细讲解如何通过 Workflow A 自动化生成数十个变形任务。