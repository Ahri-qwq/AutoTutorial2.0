# 第二章：AIMD 轨迹生产 (ABACUS)

在第一章完成了结构弛豫与静态计算的准备后，本章我们将正式进入从头算分子动力学（Ab Initio Molecular Dynamics, AIMD）的实战环节。

**本章核心逻辑**：高质量的分析始于正确的模拟。AIMD 计算极其昂贵，错误的参数设置不仅浪费机时，更会导致产生的轨迹无法用于后续的扩散系数（Diffusivity）或径向分布函数（RDF）分析。本章将聚焦于如何在 ABACUS 中设置 MD 参数，特别是如何平衡“采样精度”与“存储开销”。

---

## 2.1 基础 MD 参数设置

在 ABACUS 的 `INPUT` 文件中，通过修改 `calculation` 参数即可将任务模式从自洽场计算（scf）或结构优化（relax）切换为分子动力学（md）。

### 2.1.1 核心参数概览

以下是一个标准的 NVT 系综 AIMD `INPUT` 参数块示例：

```bash
INPUT_PARAMETERS
# -------------------------------------------
# 1. 基础计算模式
# -------------------------------------------
calculation     md          # 开启分子动力学模式
esolver_type    ksdft       # 使用 Kohn-Sham DFT 求解器

# -------------------------------------------
# 2. MD 系综与热浴设置
# -------------------------------------------
md_type         nvt         # 系综类型: nvt (恒温), nve (恒能量)
md_thermostat   nhc         # 热浴算法: nhc (Nose-Hoover Chain), andersen 等
md_tfirst       300         # 初始温度 (K)
md_tlast        300         # 目标温度 (K)

# -------------------------------------------
# 3. 时间步长与总步数
# -------------------------------------------
md_dt           1.0         # 时间步长 (fs)，推荐 0.5-2.0
md_nstep        10000       # 总模拟步数
```

### 2.1.2 参数详解与实战建议

1.  **`md_dt` (时间步长)**：
    *   **物理含义**：积分运动方程的时间间隔。
    *   **推荐值**：通常设为 **1.0 fs** 或 **2.0 fs**。
    *   **教授建议**：如果体系中包含轻元素（如氢 H, 锂 Li），原子振动频率高，建议使用较小的步长（如 0.5 - 1.0 fs）以保证能量守恒；对于重原子体系，可适当放宽至 2.0 fs。过大的步长会导致积分误差，使系统能量漂移（Energy Drift）。

2.  **`md_nstep` (总步数)**：
    *   **物理含义**：模拟的总时长 = `md_nstep` $\times$ `md_dt`。
    *   **实战策略**：
        *   **平衡期 (Equilibration)**：通常需要 1000~3000 步让体系从初始结构达到设定温度并稳定。
        *   **生产期 (Production)**：用于统计分析的轨迹。对于扩散系数计算，通常需要至少 5 ps ~ 20 ps（即 5000 ~ 20000 步）以上的有效数据，具体取决于扩散速率。

---

## 2.2 关键采样策略：输出频率控制

这是新手最容易忽视，却对后续分析至关重要的部分。我们不能保存每一步的波函数和电荷密度（太慢且太占空间），甚至不需要保存每一步的原子坐标。

### 2.2.1 轨迹输出频率 (`md_dumpfreq`)

*   **参数名**：`md_dumpfreq`
*   **默认值**：1 (即每步都输出)
*   **推荐设置**：**5 ~ 10**

**物理权衡**：
*   **过稀疏采样 (如 > 50)**：虽然节省了硬盘空间，但丢失了原子运动的高频信息。在计算均方位移（MSD）时，如果数据点太少，拟合出的扩散系数误差极大。
*   **过密集采样 (如 1)**：对于数万步的 AIMD，会生成巨大的 `MD_dump` 文件，导致后续分析工具（如 Candela 或 Ovito）读取缓慢甚至内存溢出。

### 2.2.2 断点续算频率 (`md_restartfreq`)

*   **参数名**：`md_restartfreq`
*   **推荐设置**：**1000**
*   **作用**：每隔多少步输出一次重启文件（包含波函数和电荷密度）。AIMD 计算周期长，极易因断电或超时中断。设置合理的 `md_restartfreq` 可以让你从最近的断点继续计算，而不是从头开始。

### 2.2.3 完整的 INPUT 推荐配置

针对一个需要运行 20 ps 的生产任务，建议配置如下：

```bash
# INPUT 文件片段
md_dt           2.0         # 2 fs 步长
md_nstep        10000       # 总时长 20 ps
md_dumpfreq     10          # 每 20 fs (2.0 * 10) 记录一次坐标
md_restartfreq  1000        # 每 2 ps 备份一次波函数
```

---

## 2.3 分析前的关键检查与准备

在将 ABACUS 产生的轨迹（通常位于 `OUT.suffix/MD_dump` 或 `MOVEMENT` 文件中）导入分析工具（如 Candela）之前，必须进行以下检查。

### 2.3.1 检查平衡性 (Equilibrium Check)

**切勿直接分析全段轨迹！**
AIMD 的初始阶段，体系温度会剧烈震荡，能量在通过恒温器调整。这段“平衡期”的数据**必须**在分析时剔除，否则会严重污染统计结果。

*   **操作**：绘制 `OUT.suffix/running_md.log` 中的温度（Temperature）和势能（Potential Energy）随步数变化的曲线。
*   **判据**：当温度在设定值附近波动且无明显漂移，势能也趋于收敛时，体系才算达到平衡。

### 2.3.2 衔接分析工具：Candela 参数预设

在后续使用 Candela 进行分析时，我们需要根据 ABACUS 的 `INPUT` 设置来调整分析参数。这里有一个极易出错的换算关系。

#### 锦囊妙计：MSD 时间步长换算

在 Candela 或其他分析软件中计算 MSD 时，软件通常需要知道“两帧轨迹之间的时间间隔”（我们记为 `msd_dt`）。

> **公式**：
> $$ \text{Analysis\_dt (ps)} = \frac{\text{md\_dt (fs)} \times \text{md\_dumpfreq}}{1000} $$

**实战示例**：
如果你在 ABACUS `INPUT` 中设置了：
*   `md_dt = 2.0` (fs)
*   `md_dumpfreq = 10`

那么，你的轨迹文件中，每两帧之间实际跨越了 20 fs。
在 Candela 的配置文件中，你必须设置：
*   `msd_dt = 0.02` (ps)

**警告**：如果这里填错（例如填成了 2.0），计算出的扩散系数将产生 100 倍的错误！

#### 风险提示：关于轨迹去除 (`geo_ignore`)

在分析阶段，我们通常使用 `geo_ignore` 参数来去除平衡期的数据。

*   **ABACUS 生产阶段**：我们倾向于连续跑完平衡和生产过程（或者分段续算）。
*   **Candela 分析阶段**：
    *   `geo_ignore`: 设置为忽略前 N 帧。例如，如果前 2000 步是平衡期，且 `md_dumpfreq=10`，则前 200 帧数据应被忽略，设置 `geo_ignore = 200`。
    *   **易混淆点**：注意区分 `geo_ignore`（跳过帧数）与 `geo_1`/`geo_2`（指定读取的文件索引范围）。通常对于单次完整的 MD 任务，使用 `geo_ignore` 剔除未平衡轨迹是最标准的做法。

---

**本章小结**：
本章我们完成了 AIMD 的核心参数配置。你已经学会了如何开启 MD 模式，设置合理的时间步长，并利用 `md_dumpfreq` 平衡数据精度与存储压力。下一章，我们将进入**分析阶段**，使用 Candela 读取这些轨迹并计算扩散性质。