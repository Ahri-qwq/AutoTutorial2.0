# 第五章：动力学分析实战 (Candela MSD)

在计算材料学中，均方位移（Mean Square Displacement, MSD）是评估原子扩散能力、离子电导率的核心指标，尤其在固态电池电解质和超离子导体的研究中至关重要。

本章将带你完成从 ABACUS 分子动力学（MD）模拟到使用 Candela 进行 MSD 分析的全流程。我们将重点解决新手最容易“翻车”的痛点：**时间单位换算**与**平衡态截取**。

---

## 5.1 第一阶段：生产运行 (Production Run)

在使用 Candela 分析之前，必须先使用 ABACUS 产生高质量的 MD 轨迹。很多初学者在这一步设置不当，导致后续分析时数据点过少或文件过大。

### 5.1.1 关键 INPUT 参数设置

在 ABACUS 的 `INPUT` 文件中，除了常规的 DFT 参数外，以下 MD 参数直接决定了后续 MSD 分析的有效性：

```bash
INPUT_PARAMETERS
# ... (常规电子步参数) ...

# --- MD 核心参数 ---
calculation     md              # 计算类型：分子动力学
md_type         nvt             # 系综：通常先 NPT 平衡晶格，再 NVT 采样
md_nstep        20000           # 总步数：需保证总时长足够覆盖扩散事件
md_dt           2.0             # [关键] 时间步长，单位：fs (飞秒)

# --- 轨迹输出控制 ---
md_dumpfreq     10              # [关键] 采样频率：每 10 步输出一次结构
out_stru        1               # 必须开启，否则没有 STRU_MD 文件夹
cal_force       1               # 动力学计算必须算力
cal_stress      1               # 建议开启，用于监控压强平衡
```

### 5.1.2 避坑指南：采样频率 (`md_dumpfreq`)
*   **误区**：设置 `md_dumpfreq = 1`。
    *   **后果**：输出文件极其庞大，I/O 成为瓶颈，且相邻两帧原子位移极小，全是热振动噪声，对长时扩散分析无益。
*   **建议**：通常设置 `md_dumpfreq` 使得每帧间隔为 10~100 fs。
    *   例如：`md_dt = 2.0` fs，`md_dumpfreq = 10`，则每 20 fs 记录一帧。

---

## 5.2 第二阶段：平衡性检查 (Pre-Analysis Check)

**这是最容易被忽略的一步。** 在运行 Candela 之前，必须确认系统已经达到热力学平衡。

### 5.2.1 能量与温度诊断
检查 ABACUS 输出目录（如 `OUT.suffix/`）下的日志文件或能量文件。绘制 **温度 (Temperature)** 和 **势能 (Potential Energy)** 随时间的变化曲线。

*   **判据**：曲线应在某个平均值附近波动，无明显的漂移（Drift）。
*   **操作**：如果前 5000 步温度还在剧烈震荡或能量在持续下降，说明系统处于**弛豫期**。这段轨迹**绝对不能**用于计算扩散系数，否则结果会严重偏大。

---

## 5.3 第三阶段：Candela 参数配置与单位陷阱

Candela 是一个独立的后处理工具。我们需要编写一个 `INPUT.txt` (文件名可自定义) 来告诉 Candela 如何读取 ABACUS 的轨迹。

### 5.3.1 核心配置文件示例

假设 ABACUS 的输出目录为 `OUT.ABACUS/`，我们需要计算 MSD：

```bash
# Candela INPUT.txt 示例
calculation     msd             # 计算任务：均方位移
geo_in_type     ABACUS          # 轨迹来源格式

# --- 路径设置 ---
geo_directory   ./OUT.ABACUS    # ABACUS 输出文件夹路径

# --- [难点] 时间单位换算 ---
msd_dt          0.02            # 轨迹帧间隔时间，单位：ps (皮秒)

# --- [重点] 平衡态截取 ---
geo_ignore      500             # 忽略轨迹开头的前 500 帧 (非步数!)

# --- 原子选择 ---
msd_n_type      1               # 需要分析的元素种类数量
msd_type        Li              # 分析锂离子的扩散
msd_natom       16              # 该元素在系统中的原子总数
```

### 5.3.2 锦囊妙计：MSD 时间步长换算公式

这是本章的核心难点。ABACUS 使用 **fs**，而 Candela 的 `msd_dt` 通常需要 **ps**（用于后续计算扩散系数 $D$ 的单位）。

**计算公式：**
$$ \text{msd\_dt (ps)} = \frac{\text{md\_dt (fs)} \times \text{md\_dumpfreq}}{1000} $$

**实战演练：**
> 如果你在 ABACUS `INPUT` 中设置：
> *   `md_dt = 2.0` (fs)
> *   `md_dumpfreq = 10`
>
> 那么，你的轨迹文件中，两帧之间的时间间隔是 20 fs。
> 在 Candela 中，你应该设置：
> *   `msd_dt = 2.0 * 10 / 1000 = 0.02` (ps)

**风险提示**：如果此处填错，算出的扩散系数将会有数量级的错误！

### 5.3.3 参数辨析：`geo_ignore` vs `geo_1/2`

在查阅资料时，你可能会看到 `geo_1` 和 `geo_2` 参数。请务必区分它们的用途：

*   **`geo_ignore` (推荐)**: **跳过帧数**。用于去除 MD 轨迹前段未平衡的“预热”数据。例如 `geo_ignore 500` 表示跳过前 500 帧，从第 501 帧开始分析。这是处理单一长轨迹的标准操作。
*   **`geo_1` / `geo_2`**: **文件索引范围**。当 ABACUS 运行时间极长，输出被分割为多个文件（如 `STRU_MD_DIR/1/`, `STRU_MD_DIR/2/`...）时，这两个参数用于指定读取哪几个文件夹。对于大多数单次运行的任务，通常不需要设置。

---

## 5.4 第四阶段：结果解读与扩散系数计算

运行 Candela 后（通常命令为 `./candela INPUT.txt`），会生成 `MSD_total.txt` 等文件。

### 5.4.1 识别 MSD 曲线的三大区域

将 `MSD_total.txt` 的第一列（时间，ps）和第二列（MSD，$\AA^2$）作图，通常会看到以下趋势：

1.  **弹道输运区 (Ballistic Regime)**:
    *   **特征**：时间极短（< 0.1 ps），MSD $\propto t^2$。
    *   **物理意义**：原子在局部势阱内自由运动，尚未发生碰撞。
    *   **处理**：**排除**。不要用这段拟合。

2.  **扩散区 (Diffusive Regime)**:
    *   **特征**：中间时段，MSD 随时间呈**线性增长** (MSD $\propto t$)。
    *   **物理意义**：原子发生随机行走（Random Walk）。
    *   **处理**：**这是我们需要的区域**。对此区域进行线性拟合。

3.  **统计噪声区 (Statistical Noise)**:
    *   **特征**：时间很长时，曲线末端出现剧烈抖动或非线性弯曲。
    *   **物理意义**：用于统计平均的时间窗口变少（Lag time 变大），统计误差激增。
    *   **处理**：**排除**。

### 5.4.2 计算扩散系数 (D)

根据爱因斯坦关系式（Einstein Relation），在三维体系中：

$$ \text{MSD}(t) = 6Dt + C $$

其中 $D$ 为自扩散系数。

**计算步骤**：
1.  截取 MSD 曲线中线性的**扩散区**。
2.  进行线性拟合，得到斜率 $k$。
3.  计算 $D = k / 6$。

**单位换算**：
Candela 输出的 MSD 单位是 $\AA^2$，时间是 ps。
*   直接计算出的 $D$ 单位：$\AA^2/\text{ps}$
*   转换为常用单位 ($\text{cm}^2/\text{s}$):
    $$ 1 \text{ \AA}^2/\text{ps} = 10^{-16} \text{ cm}^2 / 10^{-12} \text{ s} = 10^{-4} \text{ cm}^2/\text{s} $$
    即：将 $\AA^2/\text{ps}$ 的数值乘以 $10^{-4}$。

### 5.4.3 常见问题排查
*   **MSD 曲线一直是水平的**：说明原子被束缚在晶格位点附近，没有发生扩散。可能是温度太低，或者模拟时间太短。
*   **MSD 曲线呈现抛物线状**：可能系统未平衡（体积在膨胀/收缩），或者存在定向漂移（Drift），需检查是否去除了质心运动。