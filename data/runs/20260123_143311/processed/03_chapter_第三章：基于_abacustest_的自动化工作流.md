# 第三章：基于 abacustest 的自动化工作流

> **教授寄语**：
> 在计算材料学的早期，研究人员往往需要手动编写脚本来生成几十个形变结构，这不仅耗时，而且极易引入人为错误（如文件命名混乱、漏掉某个应变分量）。
>
> 今天，我们将使用 **`abacustest`** —— 这是一个专为 ABACUS 设计的强大的测试与工作流管理工具。它封装了复杂的晶体学形变逻辑，使我们能够专注于物理本质而非繁琐的文件操作。本章将带你掌握如何通过一条命令构建完整的弹性常数计算工作流。

---

## 3.1 自动化生成形变结构

计算弹性常数的核心在于：**对晶胞施加微小的应变（Strain），并测量由此产生的应力（Stress）**。为了得到准确的弹性张量，我们需要遍历多种不同的应变模式（正应变与剪切应变）以及不同的应变大小。

对于一个标准的弹性常数计算任务，通常需要生成 20-30 个独立的计算任务。手动管理这些文件夹是不可接受的。我们将使用 `abacustest` 的 `lib-elastic` 模块来自动化这一过程。

### 3.1.1 准备工作
在开始之前，请确保你已经完成了上一章的步骤，即获得了一个**充分弛豫（结构优化）**的晶体结构文件（例如 `STRU_relaxed`）。

**风险提示**：
> `abacustest` 在生成任务时，如果目标目录已存在同名文件夹，**会直接覆盖且不予警告**。请务必在执行前备份重要数据，或在一个干净的目录中操作。

### 3.1.2 执行生成命令
假设你的优化结构文件名为 `STRU`，并且你希望计算硅（Si）的弹性常数。使用以下命令生成所有形变任务：

```bash
abacustest lib-elastic \
    -f STRU \
    --norm 0.01 \
    --shear 0.01 \
    --dft_param INPUT_template \
    --kpt KPT_template
```

### 3.1.3 参数详解
*   **`-f STRU`**: 指定基准结构文件。这是所有形变的起点，必须是受力平衡的结构（Force < 0.01 eV/Å）。
*   **`--norm 0.01`**: 设置**正应变（Normal Strain）**的最大幅度。
    *   `0.01` 代表 1%。工具会自动生成 $\pm 0.5\%$ 和 $\pm 1.0\%$ 的形变点。
    *   **教授建议**: 对于大多数硬脆材料（如半导体、金属），1% 是线性响应区的“黄金标准”。过大可能超出胡克定律范围，过小则会被数值噪声淹没。
*   **`--shear 0.01`**: 设置**剪切应变（Shear Strain）**的最大幅度，建议值同上。
*   **`--dft_param` & `--kpt`**: 指定模板文件。`abacustest` 会将这些模板复制到每个生成的子任务文件夹中。

### 3.1.4 产物目录结构
命令执行成功后，你会在当前目录下看到一系列文件夹，典型的命名逻辑如下：

```text
.
├── run_elastic/           # 主工作目录
│   ├── deform-000/        # 原始结构（参照组）
│   ├── deform-001/        # 第1种应变模式（例如 xx 分量 +0.5%）
│   ├── deform-002/        # 第1种应变模式（例如 xx 分量 -0.5%）
│   ├── ...
│   └── deform-024/        # 最后一种剪切应变模式
```

每个 `deform-xxx` 文件夹内都包含了一套完整的 ABACUS 输入文件（`INPUT`, `STRU`, `KPT`, 以及赝势/轨道文件链接）。

---

## 3.2 关键物理设置：内部弛豫 (Internal Relaxation)

这是本章**最核心、也最容易出错**的物理概念。请务必仔细阅读。

### 3.2.1 物理原理：Clamped-ion vs. Relaxed-ion
当你人为地拉伸晶胞（改变 Lattice）时，原本处于平衡位置的原子受力不再为零。此时有两种处理方式：

1.  **Clamped-ion (无弛豫)**: 强行固定原子分数坐标不变。这对应于高频极限（原子来不及响应），计算出的弹性常数通常**偏大**。
2.  **Relaxed-ion (内部弛豫)**: 固定拉伸后的晶胞形状，但允许原子在晶胞内部移动，直到受力再次为零。这对应于静态或低频极限，**符合大多数实验测量的物理场景**。

**结论**：除非你明确在研究高频声学性质，否则**必须进行内部弛豫**。

### 3.2.2 ABACUS 参数配置
为了实现“固定晶胞、优化原子”的计算，我们需要在模板 `INPUT` 文件中进行特定设置。

**关键参数设置 (INPUT)**：

```bash
INPUT_PARAMETERS
# 任务类型：relax
# 注意：不要使用 cell-relax！
# relax = 固定晶胞，优化原子位置
# cell-relax = 优化晶胞和原子（这会把我们施加的应变优化回去，导致计算失败）
calculation     relax

# 必须计算应力
# 弹性常数是应力对应变的响应，因此必须开启应力计算
cal_stress      1

# 弛豫收敛标准
# 建议比常规计算更严格，以保证应力张量的精度
force_thr_ev    0.001
relax_nmax      100
```

### 3.2.3 abacustest 的默认行为
`abacustest lib-elastic` 默认生成的流程就是 **Relaxed-ion** 模式。
*   如果你确实需要计算 Clamped-ion 弹性常数，需要在生成命令中添加 `--norelax` 参数。
*   **但在本教程的标准流程中，请不要使用 `--norelax`。**

---

## 3.3 任务提交与管理

生成了几十个文件夹后，我们需要批量提交计算并确保它们正确运行。

### 3.3.1 检查一致性
在批量提交前，请随机抽查一个 `deform-xxx` 文件夹内的 `INPUT` 文件，确认以下关键点：
1.  **`calculation` 是否为 `relax`**？（绝对不能是 `scf` 或 `cell-relax`，除非你使用了 `--norelax` 模式则应为 `scf`）。
2.  **`cal_stress` 是否为 `1`**？（没有应力输出无法拟合）。
3.  **K 点密度**：弹性常数对应力收敛极其敏感，K 点密度通常需要比能带计算更高（例如 Si 晶体建议使用 8x8x8 或更高）。

### 3.3.2 批量提交
`abacustest` 提供了基于 `submit` 接口的批量提交功能，或者你可以使用简单的 Shell 循环在集群上提交作业。

**Shell 脚本示例 (Slurm)**:
```bash
#!/bin/bash
# 遍历所有 deform 开头的文件夹
for dir in deform-*; do
    if [ -d "$dir" ]; then
        cd "$dir"
        echo "Submitting job in $dir"
        # 假设你有一个名为 sub.slurm 的提交脚本
        # 这里的 sub.slurm 应包含运行 ABACUS 的命令，如 mpirun -np 16 abacus
        sbatch sub.slurm
        cd ..
    fi
done
```

### 3.3.3 监控与验证
计算完成后，每个文件夹内应生成 `OUT.${suffix}` 目录。你需要确保所有任务都**正常结束**（即日志文件末尾有 `Job is finished` 字样）。

*   **常见错误**：某个大应变任务（如 +1% Shear）因为原子重叠导致 SCF 不收敛。
*   **对策**：如果个别任务失败，可尝试减小该任务的混合参数（`mixing_beta`）重新计算，或者在拟合时剔除该坏点（下一章将介绍）。

---

> **下一章预告**：
> 所有的计算任务完成后，我们将面对成百上千个应力数据。第四章将介绍如何使用 `abacustest` 的后处理功能，一键提取数据，拟合胡克定律，并最终获得符合 Voigt 记号的弹性常数矩阵（$C_{11}, C_{12}, C_{44}$ 等）。