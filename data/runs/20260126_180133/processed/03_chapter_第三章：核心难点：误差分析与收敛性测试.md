# 第三章：核心难点：误差分析与收敛性测试

在上一章中，我们已经成功跑通了第一个 sDFT 计算。但在你直接使用输出的能量或力进行物理分析之前，请务必停下来阅读本章。

**sDFT 与传统 KSDFT 最大的区别在于：结果带有随机性。**

在 KSDFT 中，给定一套参数，能量是唯一的。而在 sDFT 中，由于引入了随机波函数（Stochastic Orbitals），单次计算得到的能量只是真实值附近的一个采样。如果你只运行一次计算，你无法判断这个结果是“正中靶心”还是“脱靶”。

本章将教你如何像实验物理学家处理测量误差一样，处理 sDFT 的计算误差，确保你的结果经得起推敲。

---

## 3.1 理解随机误差与大数定律

sDFT 的核心思想是用一组随机生成的轨道来近似希尔伯特空间的迹（Trace）。根据统计学原理，这种近似带来的**随机误差（Stochastic Error）**与随机轨道数量（$N_{sto}$）的平方根成反比：

$$ \text{Error} \propto \frac{1}{\sqrt{N_{sto}}} $$

这意味着：
1.  **能量不是定值**：对于同一个体系，固定所有物理参数，仅改变随机数种子（`seed_sto`），计算出的总能量会在真实值附近波动（服从高斯分布）。
2.  **收敛的代价**：要将误差减小 10 倍，你需要增加 100 倍的随机轨道数量。因此，盲目增加 `nbands_sto` 极其昂贵，我们需要找到“够用就好”的平衡点。

### 关键参数：`seed_sto`
在 `INPUT` 文件中，`seed_sto` 控制随机数生成器的起始点：
- **默认值 (0)**：使用系统时间作为种子。每次运行结果都不同，适合生产环境的大规模统计。
- **正整数 (>0)**：固定种子。用于调试，确保每次运行结果完全一致。

**实战原则**：在进行收敛性测试时，我们需要手动修改 `seed_sto` 来产生多组独立样本。

---

## 3.2 实战演练：随机轨道数目 (nbands_sto) 的收敛测试

这是 sDFT 计算中最关键的一步。我们必须确定需要多少个随机轨道（`nbands_sto`）才能使能量波动落在可接受范围内（通常建议标准差 $\sigma < 10^{-4}$ Ry/atom）。

### 标准测试流程

请按照以下步骤操作：

1.  **准备基准 INPUT**：设置一个初始的 `nbands_sto`（例如 64 或 128），固定 `ecutwfc` 和 `nche_sto`。
2.  **多样本计算**：选取 10 个不同的正整数作为 `seed_sto`（如 1001, 1002, ..., 1010），分别运行 10 次 SCF 计算。
3.  **统计分析**：收集这 10 次计算的最终能量（`Final Etot`），计算其**平均值**和**标准差**。

#### 示例脚本逻辑
虽然你可以手动修改运行，但在实际科研中，建议使用 Shell 或 Python 脚本自动化：

```bash
#!/bin/bash
# 伪代码示例：循环测试不同的随机种子
for seed in {1001..1010}; do
    # 修改 INPUT 中的 seed_sto
    sed -i "s/seed_sto .*/seed_sto $seed/g" INPUT
    
    # 运行 ABACUS (假设可执行文件为 abacus)
    mpirun -np 4 abacus > log_seed_${seed}.txt
    
    # 提取能量
    grep "Final Etot" log_seed_${seed}.txt >> energy_stats.dat
done
```

### 判据与调整
- **如果标准差 $\sigma > 10^{-4}$ Ry**：说明随机误差过大。你需要增加 `nbands_sto`（例如翻倍），重复上述测试，直到误差满足要求。
- **如果标准差 $\sigma \ll 10^{-4}$ Ry**：说明精度过剩，可以适当减少 `nbands_sto` 以节省计算资源。

### 进阶技巧：何时使用 MDFT？
如果你的体系温度很高，但仍有部分深层能级被完全占据（Occupancy $\approx$ 1），纯 sDFT 的收敛会非常慢，因为随机轨道很难描述这些定域性很强的深层态。

此时，应启用 **MDFT (Mixed DFT)**：
- **原理**：用少量的确定性 KS 轨道（`nbands`）处理深层态，用随机轨道（`nbands_sto`）处理高能态。
- **INPUT 设置**：
  ```
  INPUT_PARAMETERS
  esolver_type  sdft
  nbands        12    # 设置少量 KS 轨道覆盖深能级
  nbands_sto    128   # 随机轨道处理剩余部分
  ```
- **效果**：MDFT 能显著降低对 `nbands_sto` 的需求，大幅提高收敛速度。

---

## 3.3 平面波截断能 (ecutwfc) 的统计测试

在 KSDFT 中，我们习惯画一条“能量 vs ecut”的平滑曲线。但在 sDFT 中，由于随机噪声的存在，这条曲线会呈现锯齿状的“抖动”。

**切记：不能用单次计算的结果来判断 ecut 收敛！**

### 正确的测试方法
1.  **固定 `nbands_sto`**：使用上一步测试确定的数值。
2.  **选取测试点**：例如 `ecutwfc` 取 30, 40, 50, 60, 70 Ry。
3.  **统计平均**：对于**每一个** `ecutwfc` 测试点，都必须使用多个 `seed_sto`（建议 5-10 个）进行计算，并取**能量平均值**。
4.  **判断收敛**：比较相邻 `ecutwfc` 点的**平均能量差**。
    - 判据：$|E_{avg}(E_{cut}) - E_{avg}(E_{cut}+10)| < \text{Tolerance}$
    - 温稠密物质通常能量绝对值很大，相对误差控制在 $10^{-4}$ 量级即可。

---

## 3.4 关键参数依赖关系：nche_sto

在 sDFT 中，`nche_sto`（切比雪夫展开阶数）直接决定了哈密顿量算符 $\hat{H}$ 应用在随机波函数上的精度。它与其他参数有着强烈的依赖关系，设置不当会导致计算发散或极其缓慢。

### 选取逻辑
- **与温度的关系**：**反比**。
  - 温度越高 ($T \uparrow$)，费米-狄拉克分布越平缓，需要的展开阶数越低，计算越快。
  - 温度越低，需要的 `nche_sto` 越高。
- **与截断能的关系**：**正比**。
  - `ecutwfc` 越大，哈密顿量的谱宽度越大，需要更大的 `nche_sto` 才能覆盖。

### 检查方法
每次计算后，检查输出文件 `running_scf.log` 中的 `Chebyshev Precision`。
- **目标**：该值应小于 $10^{-8}$。
- **调整**：如果精度不够，需在 `INPUT` 中增大 `nche_sto`。

---

## 3.5 风险提示与常见误区

1.  **应力 (Stress) 计算的特殊性**：
    - 在 KSDFT 中，我们常开启 `cal_stress` (或 `calculate_stress`) 来优化晶胞。
    - **注意**：sDFT 主要用于高温高压下的 NVT 模拟（固定体积）。虽然 ABACUS 的 sDFT 模块在不断更新，但应力计算对随机噪声非常敏感。在涉及晶胞优化（`calculation cell-relax`）前，请务必查阅最新的官方文档，确认当前版本 sDFT 是否支持应力计算以及其精度是否满足要求。

2.  **赝势的选择**：
    - 在极高温（> 100 eV）条件下，内层电子可能会电离。标准的赝势（通常只把最外层当价电子）可能不再适用。此时可能需要生成包含更多内层电子的“硬”赝势，这会导致需要极高的 `ecutwfc`。

3.  **不要混淆 `nbands` 和 `nbands_sto`**：
    - `nbands` = 确定性轨道（KS轨道），对角化求解，贵但准。
    - `nbands_sto` = 随机轨道，投影求解，便宜但有噪。
    - `nbands = 0` 且 `nbands_sto > 0` $\rightarrow$ 纯 sDFT。
    - `nbands > 0` 且 `nbands_sto > 0` $\rightarrow$ MDFT。

通过本章的测试，你应该已经获得了一组可靠的参数（`nbands_sto`, `nche_sto`, `ecutwfc`）。在下一章中，我们将利用这些参数，正式开展温稠密物质的分子动力学模拟。