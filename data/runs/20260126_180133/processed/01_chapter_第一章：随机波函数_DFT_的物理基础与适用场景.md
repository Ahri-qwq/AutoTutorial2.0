# 第一章：随机波函数 DFT 的物理基础与适用场景

在踏入 ABACUS 的随机波函数密度泛函理论（Stochastic DFT, sDFT）实战之前，我们需要先建立正确的物理直觉。sDFT 并非万能钥匙，它是一把专门为解决“高温计算墙”而设计的精密手术刀。

本章将带你理解 sDFT 究竟解决了什么痛点，引入了什么代价，以及如何通过参数配置在“精度”与“效率”之间找到平衡点。

## 1.1 温稠密物质与 KSDFT 的瓶颈

在材料模拟领域，我们常遇到一类被称为**温稠密物质（Warm Dense Matter, WDM）**的极端状态。这类物质通常处于高温（数千至数百万开尔文）和高压条件下，广泛存在于行星内核、激光核聚变实验以及恒星演化过程中。

### 传统 KSDFT 的“正交化之墙”
对于常规材料（如室温下的半导体），Kohn-Sham DFT (KSDFT) 是标准工具。但在高温下，电子遵循费米-狄拉克（Fermi-Dirac）分布：

$$ f(\epsilon) = \frac{1}{e^{(\epsilon - \mu)/k_B T} + 1} $$

随着温度 $T$ 的升高，费米分布的“拖尾”会延伸到极高的能量范围。这意味着为了获得准确的电子密度，我们必须计算极大数量的部分占据态。
*   **数量爆炸**：所需的能带数量 $N_{bands}$ 随温度呈 $T^{3/2}$ 甚至更剧烈的增长。
*   **计算复杂度**：KSDFT 算法中，波函数正交化（Orthogonalization）和子空间对角化的计算复杂度是 $O(N_{bands}^3)$。

当温度达到 10 eV（约 11.6 万开尔文）甚至更高时，计算成千上万条能带的正交化耗时将变得不可接受。这就是 KSDFT 的“正交化之墙”。

## 1.2 sDFT 的核心思想：以随机换效率

为了打破上述瓶颈，ABACUS 引入了 sDFT。其核心哲学非常直接：**放弃对每个具体本征态的精确求解，转而统计性地获取系统的宏观性质（如电子密度、总能量）。**

### 物理机制
1.  **随机轨道 (Stochastic Orbitals)**：
    sDFT 不再寻找确定的 Kohn-Sham 轨道 $\psi_i$，而是使用一组随机轨道 $\chi$。这些轨道由随机相位填充，并不对应特定的能级。
2.  **切比雪夫展开 (Chebyshev Expansion)**：
    利用切比雪夫多项式展开费米-狄拉克算符。通过计算随机轨道在哈密顿量作用下的演化，直接逼近密度矩阵的迹（Trace），从而**完全避免了哈密顿矩阵的对角化**。
3.  **线性标度**：
    sDFT 的计算复杂度主要取决于随机轨道的数量 $N_{sto}$ 和基组大小，与体系电子总数的关系接近线性 $O(N)$。

### 关键参数设置
在 `INPUT` 文件中，开启 sDFT 模式的核心参数如下：

```bash
INPUT_PARAMETERS
# ... 其他参数 ...
calculation     scf
esolver_type    sdft    # 核心：指定使用随机波函数求解器
smearing_method fd      # 限制：sDFT 目前仅支持 Fermi-Dirac smearing
# ... ...
```

## 1.3 纯 sDFT 与 混合 MDFT 的抉择

ABACUS 提供了两种随机计算模式：**纯 sDFT** 和 **混合 MDFT (Mixed DFT)**。选择哪一种，取决于你的体系温度和电子结构特征。

### 模式一：纯 sDFT (Pure sDFT)
*   **适用场景**：极高温体系（通常 $T > 10$ eV）。此时电子高度离域，几乎所有能级都被热效应抹平，深层能级与高能级界限模糊。
*   **参数特征**：不计算任何确定性轨道。
*   **设置方法**：
    ```bash
    nbands      0       # 不使用确定性 KS 轨道
    nbands_sto  64      # 设定随机轨道数量（需测试收敛性）
    ```

### 模式二：混合 MDFT (Mixed DFT)
*   **适用场景**：中高温体系（例如 1 eV < $T$ < 10 eV）。此时虽然温度很高，但低能级（深能级）仍然被完全占据，且对总能量贡献巨大。如果完全用随机轨道描述这些深能级，会引入较大的随机噪声（Stochastic Noise），导致收敛困难。
*   **解决方案**：用少量的确定性 KS 轨道（`nbands`）处理低能级，用随机轨道（`nbands_sto`）处理高能部分占据态。
*   **设置方法**：
    ```bash
    nbands      12      # 少量确定性轨道，建议覆盖费米能级以下的态
    nbands_sto  64      # 随机轨道处理高能部分
    ```
    > **专家建议**：当发现纯 sDFT 计算收敛很慢，或者能量波动较大时，尝试开启 MDFT（设置 `nbands > 0`）通常能显著改善结果。

## 1.4 误差控制与参数依赖（实战必读）

sDFT 的代价是引入了**随机误差**。作为用户，你必须学会如何控制这种误差。这与传统 DFT 的收敛测试不同，我们需要进行统计分析。

### 1. 随机轨道数量 (`nbands_sto`) 的收敛测试
随机误差 $\sigma$ 与随机轨道数量 $N_{sto}$ 的关系近似为 $\sigma \propto 1/\sqrt{N_{sto}}$。
**标准测试流程**：
1.  固定 `nbands_sto`（例如 64）。
2.  选取约 10 个不同的随机种子 `seed_sto`（例如 1, 2, ..., 10）。
3.  运行 10 次 SCF 计算，收集总能量。
4.  计算能量的**平均值**和**标准差**。
5.  如果标准差（误差）大于目标精度（通常建议 $< 10^{-4}$ Ry/atom），则增加 `nbands_sto` 并重复测试。

### 2. 切比雪夫展开阶数 (`nche_sto`)
该参数决定了对费米算符逼近的精度。它的选取遵循以下物理规律：
*   **温度 ($T$) 越高，`nche_sto` 越小**：高温下费米分布函数变得平滑，更容易用低阶多项式拟合。这是 sDFT 在高温下效率极高的原因之一。
*   **截断能 (`ecut`) 越大，`nche_sto` 越大**：`ecut` 决定了哈密顿量的谱宽度。谱越宽，需要越多的切比雪夫多项式来覆盖。

> **推荐做法**：查看输出文件 `running_scf.log` 中的 `Chebyshev Precision`。调整 `nche_sto` 使得该精度优于 $10^{-8}$。

### 3. 截断能 (`ecutwfc`) 的测试
由于随机噪声的存在，测试 `ecutwfc` 时不能只看单次计算的能量变化。
**正确做法**：在每个 `ecutwfc` 测试点，都应使用多组随机种子取平均能量，比较**平均能量**随 `ecutwfc` 的收敛情况。

### 4. 风险提示：应力与晶胞优化
虽然 sDFT 支持计算力（Force）从而进行分子动力学（MD）模拟，但涉及晶胞尺寸变化（Cell Relaxation / VC-relax）时需格外小心。
*   **注意**：sDFT 的应力（Stress）计算可能不如 KSDFT 成熟或受到特定限制。
*   **指令**：若你的任务涉及 `calculation cell-relax` 或 `vc-relax`，请务必先查阅最新的 ABACUS 官方文档，确认当前版本 sDFT 是否完全支持应力张量的计算及精度要求。

---

**本章小结**：
sDFT 是通过牺牲绝对确定性来换取高温计算可行性的策略。理解 `nbands` (确定性) 与 `nbands_sto` (随机性) 的互补关系，以及掌握基于统计学的误差控制流程，是使用 ABACUS 进行温稠密物质模拟的前提。下一章，我们将动手配置第一个 sDFT 计算。