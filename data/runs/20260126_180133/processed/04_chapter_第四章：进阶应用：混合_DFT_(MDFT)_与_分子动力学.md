# 第四章：进阶应用：混合 DFT (MDFT) 与 分子动力学

在上一章中，我们掌握了随机波函数 DFT (sDFT) 的基本原理和单点能计算。然而，在实际的温稠密物质（WDM）或高温材料研究中，我们往往面临两个挑战：
1.  **精度与效率的平衡**：在某些“中等高温”下，费米面深处的电子仍然保持较强的量子相干性，纯随机方法可能会引入不必要的噪声。
2.  **动态演化**：我们需要模拟原子在高温下的运动轨迹（分子动力学），而不仅仅是静态结构。

本章将深入探讨如何利用 **混合 DFT (Mixed DFT, MDFT)** 技术解决精度问题，并演示如何驱动 **高温分子动力学 (MD)** 模拟。

---

## 4.1 启用混合随机-确定性 DFT (MDFT)

### 4.1.1 为什么要使用 MDFT？

在纯 sDFT (`nbands = 0`) 中，所有的电子态都由随机波函数描述。根据中心极限定理，随机误差随采样数 $N$ 的增加以 $1/\sqrt{N}$ 的速度衰减。

然而，当系统温度不是极高（例如 < 10 eV），或者系统存在深层束缚态时，这些低能级电子对总能量贡献巨大且占据数接近 1。如果用随机轨道描述这些“硬”电子，会产生较大的噪声，导致收敛缓慢。

**MDFT 的核心思想**是“分而治之”：
- **深层能级（低能态）**：使用传统的 Kohn-Sham 轨道（确定性轨道）进行精确对角化求解。
- **浅层/激发能级（高能态）**：使用随机轨道处理海量的部分占据态。

这种方法在保持 sDFT 高效性的同时，显著降低了随机噪声。

### 4.1.2 INPUT 参数设置

要启用 MDFT，关键在于同时设置 `nbands`（KS 轨道数）和 `nbands_sto`（随机轨道数）。

以下是一个典型的 MDFT 输入文件示例（基于硅的改写）：

```bash
INPUT_PARAMETERS
#Parameters (General)
calculation     scf
esolver_type    sdft        # 必须设置为 sdft
pseudo_dir      ../../PP_ORB

# --- MDFT 核心设置 ---
nbands          4           # 确定性 KS 轨道数 (覆盖深层全占据态)
nbands_sto      64          # 随机轨道数 (覆盖费米面附近及高能态)
nche_sto        100         # 切比雪夫展开阶数
method_sto      2           # 推荐算法：2 (速度快但内存消耗略大)
# --------------------

#Parameters (Accuracy)
ecutwfc         50
scf_nmax        20
symmetry        1

#Parameters (Smearing)
smearing_method fd          # MDFT 目前仅支持 Fermi-Dirac (fd)
smearing_sigma  0.6         # 电子温度 (Ry), 0.6 Ry ≈ 8.16 eV
```

**参数详解：**
*   **`nbands`**: 设置为覆盖费米能级以下的深层能带数。设置得越多，精度越接近传统 KSDFT，但计算量也会增加。
*   **`nbands_sto`**: 随机轨道的数量。原则上越多误差越小。
*   **`nche_sto`**: 哈密顿量切比雪夫展开的阶数。
    *   **依赖关系 1 (温度)**: 温度越高，需要的阶数越**小**（计算越快）。
    *   **依赖关系 2 (截断能)**: `ecutwfc` 越大，需要的阶数越**大**。
    *   **调试标准**: 查看输出文件 `running_scf.log`，确保 "Chebyshev Precision" 小于 `1e-8`。

### 4.1.3 关键步骤：误差控制流程 (Error Control Protocol)

**这是本教程最关键的实战技巧。** 由于引入了随机性，单次计算的结果包含随机误差。在发表数据前，**必须**进行误差测试。

**操作流程：**

1.  **准备测试脚本**：编写一个简单的 Shell 脚本，循环修改 `seed_sto`（随机数种子）。
2.  **执行多次计算**：使用相同的 `nbands_sto` 和 `ecut`，运行约 10 次计算，每次使用不同的 `seed_sto`（例如从 1 到 10）。
    *   *提示*：`seed_sto` 默认为 0（随时间生成），为了复现性，建议显式设置整数。
3.  **统计分析**：
    *   收集 10 次计算的总能量（Total Energy）。
    *   计算平均值 $\bar{E}$ 和标准差 $\sigma_E$。
4.  **判断收敛**：
    *   **目标**：通常要求 $\sigma_E < 10^{-4}$ Ry/atom（具体视科研需求而定）。
    *   **调整**：如果 $\sigma_E$ 过大，需要增加 `nbands_sto` 并重新测试。

> **注意**：`ecutwfc` 的收敛性测试也应遵循此流程。在确定好 `nbands_sto` 后，对不同的 `ecut` 分别进行 10 次随机种子测试，比较平均能量 $\bar{E}$ 的差值。

---

## 4.2 高温分子动力学模拟 (MD)

在温稠密物质研究中，我们通常关注离子在电子热库中的运动。ABACUS 的 sDFT/MDFT 模块可以无缝驱动分子动力学。

### 4.2.1 案例：铝的高温 MD (`pw_md_Al`)

本案例模拟 16 个铝原子在电子温度 ~100 eV 下的动力学行为。

**INPUT 文件配置：**

```bash
INPUT_PARAMETERS
#Parameters (General)
calculation     md          # 开启分子动力学
esolver_type    sdft        # 使用 sDFT 求解器
pseudo_dir      ../../PP_ORB

# --- 电子结构参数 ---
nbands          0           # 100 eV 极高温下，深层态也被部分激发，可使用纯 sDFT
nbands_sto      64
nche_sto        20          # 高温下展开阶数可显著降低 (相比低温的 100+)
method_sto      2
ecutwfc         50
scf_nmax        20
scf_thr         1e-6        # MD 中对 SCF 收敛要求通常较高

# --- 温度设置 ---
smearing_method fd
smearing_sigma  7.34986072  # ~100 eV (1 Ry ≈ 13.605 eV)

# --- MD 核心参数 ---
md_tfirst       1160400     # 离子初始温度 (Kelvin), 此处对应 100 eV
md_dt           0.2         # 时间步长 (fs)
md_nstep        10          # MD 总步数
md_type         nvt         # 系综类型 (如 nvt, nve)
```

### 4.2.2 关键参数解析

1.  **`calculation md`**: 告诉 ABACUS 进行离子运动更新。
2.  **`md_tfirst`**: 离子的初始温度，单位是 **Kelvin (K)**。
    *   *换算提示*：1 eV ≈ 11604.5 K。如果电子温度是 100 eV，通常离子温度也设为该量级（假设局部热平衡），即约 $1.16 \times 10^6$ K。
3.  **`md_dt`**: 时间步长，单位 **飞秒 (fs)**。
    *   高温下离子运动剧烈，为了保证积分稳定性，步长通常比常温 MD 小（例如 0.1 - 0.5 fs）。
4.  **`nche_sto` 的优势**: 注意到这里 `nche_sto` 仅设为 20。这是 sDFT 在高温下的巨大优势——温度越高，费米-狄拉克分布越平滑，所需的切比雪夫展开项越少，计算速度越快。

### 4.2.3 风险提示：应力与晶胞优化

在进行 MD 或结构优化时，请务必注意：

*   **力 (Force)**: sDFT/MDFT 对原子受力的计算是成熟的，支持 NVE/NVT 系综的 MD。
*   **应力 (Stress)**: 虽然 ABACUS 的 KSDFT 支持应力计算（用于 NPT 系综或 `cell-relax`），但在 sDFT 模式下，应力计算的精度和支持度可能受限。
    *   **建议**：在进行涉及晶胞尺寸变化（如 `cell-relax` 或 NPT MD）的计算前，请先在小体系上进行测试，检查 `running_scf.log` 或 `running_md.log` 中输出的 Pressure/Stress 是否合理。如果发现数值异常或不支持，请固定晶胞体积（使用 NVT 或 NVE）进行模拟。

---

## 4.3 本章小结

通过本章的学习，您已经掌握了 ABACUS 在极端条件下的两个核心武器：
1.  **MDFT**: 通过 `nbands` 和 `nbands_sto` 的混合使用，在非极高温条件下压制随机噪声。
2.  **高温 MD**: 利用 `calculation md` 结合 sDFT 高效处理高温离子动力学。

**实战清单**：
- [ ] 在使用 MDFT 前，是否根据温度判断了 `nbands` 的必要性？
- [ ] 是否执行了“10 个随机种子”的误差分析流程？
- [ ] 在高温 MD 中，是否根据 $T$ 和 `ecut` 调整了 `nche_sto` 以优化速度？

下一章，我们将探讨如何处理计算结果，包括态密度（DOS）的输出与数据后处理。