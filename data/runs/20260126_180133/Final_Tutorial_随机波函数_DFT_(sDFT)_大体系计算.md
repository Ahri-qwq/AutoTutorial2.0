# ABACUS 随机波函数密度泛函理论实战：从温稠密物质到高温分子动力学

## 前言

欢迎来到《ABACUS 随机波函数密度泛函理论实战》教程。在计算物质科学的版图中，温稠密物质（Warm Dense Matter, WDM）和极端高温体系的模拟始终是一块难啃的“硬骨头”。传统的 Kohn-Sham 密度泛函理论（KSDFT）在处理此类问题时，往往受困于对角化哈密顿矩阵带来的巨大计算开销。国产开源第一性原理计算软件 ABACUS 凭借其内置的随机波函数密度泛函理论（Stochastic DFT, sDFT）功能，为突破这一“高温计算墙”提供了精密且高效的解决方案。

**学习路线图**
本教程旨在引导读者由浅入深地掌握 sDFT 的核心技能：
1. **物理基础（第一章）**：建立物理直觉，理解 sDFT 如何解决 WDM 模拟中的瓶颈。
2. **实战起步（第二章）**：以硅体系为例，掌握单点能（SCF）计算的基本流程与参数逻辑。
3. **质量控制（第三章）**：深入探讨 sDFT 特有的统计误差分析与收敛性测试方法。
4. **进阶演化（第四章）**：学习混合 DFT（MDFT）技术，并驱动高温下的分子动力学模拟。
5. **性质表征（第五章）**：掌握利用切比雪夫展开技术重构态密度（DOS）的高级技巧。

**知识体系定位**
在 ABACUS 的知识图谱中，sDFT 是独立于传统 LCAO 和 PW 轨道展开的高级模块。它不仅是对 KSDFT 的补充，更是处理大规模高温体系、跨越量子力学与统计力学边界的关键工具。本教程将带你从单纯的“能量计算者”转变为能够掌控统计噪声、模拟极端环境的“数值实验家”。

**前置要求**
在开始本教程前，我们建议读者已具备以下基础：
- 熟悉 Linux 环境操作及 ABACUS 的基本安装与运行。
- 掌握密度泛函理论（DFT）的基本概念（如泛函、自洽迭代、平面波基组等）。
- 具备基本的统计学常识，能够理解标准差与采样误差的含义。

---

# 第一章：随机波函数 DFT 的物理基础与适用场景

在踏入 ABACUS 的随机波函数密度泛函理论（Stochastic DFT, sDFT）实战之前，我们需要先建立正确的物理直觉。sDFT 并非万能钥匙，它是一把专门为解决“高温计算墙”而设计的精密手术刀。

本章将带你理解 sDFT 究竟解决了什么痛点，引入了什么代价，以及如何通过参数配置在“精度”与“效率”之间找到平衡点。

## 1.1 温稠密物质与 KSDFT 的瓶颈

在材料模拟领域，我们常遇到一类被称为**温稠密物质（Warm Dense Matter, WDM）**的极端状态。这类物质通常处于高温（数千至数百万开尔文）和高压条件下，广泛存在于行星内核、激光核聚变实验以及恒星演化过程中。

### 传统 KSDFT 的“正交化之墙”
对于常规材料（如室温下的半导体），Kohn-Sham DFT (KSDFT) 是标准工具。但在高温下，电子遵循费米-狄拉克（Fermi-Dirac）分布：

$$ f(\epsilon) = \frac{1}{e^{(\epsilon - \mu)/k_B T} + 1} $$

随着温度 $T$ 的升高，费米分布的“拖尾”会延伸到极高的能量范围。这意味着为了获得准确的电子密度，我们必须计算极大数量的部分占据态。
*   **数量爆炸**：所需的能带数量 $N_{bands}$ 随温度呈 $T^{3/2}$ 甚至更剧烈的增长。
*   **计算复杂度**：KSDFT 算法中，波函数正交化（Orthogonalization）和子空间对角化的计算复杂度是 $O(N_{bands}^3)$。

当温度达到 10 eV（约 11.6 万开尔文）甚至更高时，计算成千上万条能带的正交化耗时将变得不可接受。这就是 KSDFT 的“正交化之墙”。

## 1.2 sDFT 的核心思想：以随机换效率

为了打破上述瓶颈，ABACUS 引入了 sDFT。其核心哲学非常直接：**放弃对每个具体本征态的精确求解，转而统计性地获取系统的宏观性质（如电子密度、总能量）。**

### 物理机制
1.  **随机轨道 (Stochastic Orbitals)**：
    sDFT 不再寻找确定的 Kohn-Sham 轨道 $\psi_i$，而是使用一组随机轨道 $\chi$。这些轨道由随机相位填充，并不对应特定的能级。
2.  **切比雪夫展开 (Chebyshev Expansion)**：
    利用切比雪夫多项式展开费米-狄拉克算符。通过计算随机轨道在哈密顿量作用下的演化，直接逼近密度矩阵的迹（Trace），从而**完全避免了哈密顿矩阵的对角化**。
3.  **线性标度**：
    sDFT 的计算复杂度主要取决于随机轨道的数量 $N_{sto}$ 和基组大小，与体系电子总数的关系接近线性 $O(N)$。

### 关键参数设置
在 `INPUT` 文件中，开启 sDFT 模式的核心参数如下：

```bash
INPUT_PARAMETERS
# ... 其他参数 ...
calculation     scf
esolver_type    sdft    # 核心：指定使用随机波函数求解器
smearing_method fd      # 限制：sDFT 目前仅支持 Fermi-Dirac smearing
# ... ...
```

## 1.3 纯 sDFT 与 混合 MDFT 的抉择

ABACUS 提供了两种随机计算模式：**纯 sDFT** 和 **混合 MDFT (Mixed DFT)**。选择哪一种，取决于你的体系温度和电子结构特征。

### 模式一：纯 sDFT (Pure sDFT)
*   **适用场景**：极高温体系（通常 $T > 10$ eV）。此时电子高度离域，几乎所有能级都被热效应抹平，深层能级与高能级界限模糊。
*   **参数特征**：不计算任何确定性轨道。
*   **设置方法**：
    ```bash
    nbands      0       # 不使用确定性 KS 轨道
    nbands_sto  64      # 设定随机轨道数量（需测试收敛性）
    ```

### 模式二：混合 MDFT (Mixed DFT)
*   **适用场景**：中高温体系（例如 1 eV < $T$ < 10 eV）。此时虽然温度很高，但低能级（深能级）仍然被完全占据，且对总能量贡献巨大。如果完全用随机轨道描述这些深能级，会引入较大的随机噪声（Stochastic Noise），导致收敛困难。
*   **解决方案**：用少量的确定性 KS 轨道（`nbands`）处理低能级，用随机轨道（`nbands_sto`）处理高能部分占据态。
*   **设置方法**：
    ```bash
    nbands      12      # 少量确定性轨道，建议覆盖费米能级以下的态
    nbands_sto  64      # 随机轨道处理高能部分
    ```
    > **专家建议**：当发现纯 sDFT 计算收敛很慢，或者能量波动较大时，尝试开启 MDFT（设置 `nbands > 0`）通常能显著改善结果。

## 1.4 误差控制与参数依赖（实战必读）

sDFT 的代价是引入了**随机误差**。作为用户，你必须学会如何控制这种误差。这与传统 DFT 的收敛测试不同，我们需要进行统计分析。

### 1. 随机轨道数量 (`nbands_sto`) 的收敛测试
随机误差 $\sigma$ 与随机轨道数量 $N_{sto}$ 的关系近似为 $\sigma \propto 1/\sqrt{N_{sto}}$。
**标准测试流程**：
1.  固定 `nbands_sto`（例如 64）。
2.  选取约 10 个不同的随机种子 `seed_sto`（例如 1, 2, ..., 10）。
3.  运行 10 次 SCF 计算，收集总能量。
4.  计算能量的**平均值**和**标准差**。
5.  如果标准差（误差）大于目标精度（通常建议 $< 10^{-4}$ Ry/atom），则增加 `nbands_sto` 并重复测试。

### 2. 切比雪夫展开阶数 (`nche_sto`)
该参数决定了对费米算符逼近的精度。它的选取遵循以下物理规律：
*   **温度 ($T$) 越高，`nche_sto` 越小**：高温下费米分布函数变得平滑，更容易用低阶多项式拟合。这是 sDFT 在高温下效率极高的原因之一。
*   **截断能 (`ecut`) 越大，`nche_sto` 越大**：`ecut` 决定了哈密顿量的谱宽度。谱越宽，需要越多的切比雪夫多项式来覆盖。

> **推荐做法**：查看输出文件 `running_scf.log` 中的 `Chebyshev Precision`。调整 `nche_sto` 使得该精度优于 $10^{-8}$。

### 3. 截断能 (`ecutwfc`) 的测试
由于随机噪声的存在，测试 `ecutwfc` 时不能只看单次计算的能量变化。
**正确做法**：在每个 `ecutwfc` 测试点，都应使用多组随机种子取平均能量，比较**平均能量**随 `ecutwfc` 的收敛情况。

### 4. 风险提示：应力与晶胞优化
虽然 sDFT 支持计算力（Force）从而进行分子动力学（MD）模拟，但涉及晶胞尺寸变化（Cell Relaxation / VC-relax）时需格外小心。
*   **注意**：sDFT 的应力（Stress）计算可能不如 KSDFT 成熟或受到特定限制。
*   **指令**：若你的任务涉及 `calculation cell-relax` 或 `vc-relax`，请务必先查阅最新的 ABACUS 官方文档，确认当前版本 sDFT 是否完全支持应力张量的计算及精度要求。

---

**本章小结**：
sDFT 是通过牺牲绝对确定性来换取高温计算可行性的策略。理解 `nbands` (确定性) 与 `nbands_sto` (随机性) 的互补关系，以及掌握基于统计学的误差控制流程，是使用 ABACUS 进行温稠密物质模拟的前提。下一章，我们将动手配置第一个 sDFT 计算。

# 第二章：sDFT 基础流程：单点能计算 (SCF)

在第一章中，我们已经熟悉了 ABACUS 的基本安装与运行。本章我们将进入随机波函数密度泛函理论（Stochastic DFT, sDFT）的核心实战环节。

sDFT 是 ABACUS 处理温稠密物质（Warm Dense Matter, WDM）和超大体系的“杀手锏”。与传统的 Kohn-Sham DFT (KSDFT) 不同，sDFT 不依赖于哈密顿矩阵的对角化，而是通过随机向量在希尔伯特空间中的演化来获取物理量。这种算法特性的改变，意味着我们需要一套全新的参数设置逻辑。

本章将以最简单的 **硅双原子（Si2）** 体系为例，带你跑通 sDFT 的标准流程，并掌握控制随机误差的核心技巧。

---

## 2.1 输入文件概览与核心开关

首先，我们需要明确告诉 ABACUS：“请放弃传统的对角化方法，启动随机求解器。”

我们以 `pw_Si2` 案例为基础。与 KSDFT 一样，你需要准备 `STRU`（结构文件）、`KPT`（K点文件）和赝势文件。唯一的剧变发生在 `INPUT` 文件中。

### 2.1.1 标准 sDFT INPUT 模板

以下是一个标准的 sDFT 计算输入文件示例：

```bash
INPUT_PARAMETERS
#Parameters (1. General)
suffix          Si2_sdft
calculation     scf             # 计算类型：自洽场计算
esolver_type    sdft            # 核心开关：指定求解器为 sdft
pseudo_dir      ../../PP_ORB    # 赝势路径
symmetry        1               # 开启对称性分析

#Parameters (2. Stochastic & Basis)
nbands          0               # KS轨道数：设为0表示纯sDFT
nbands_sto      64              # 随机轨道数：sDFT精度的关键
nche_sto        100             # 切比雪夫展开阶数
method_sto      2               # 算法模式：2为速度优先

#Parameters (3. Iteration & Accuracy)
ecutwfc         50              # 平面波截断能 (Ry)
scf_nmax        20              # 最大电子迭代步数
scf_thr         1e-6            # 收敛阈值

#Parameters (4. Smearing - CRITICAL)
smearing_method fd              # 必须设为 fd (Fermi-Dirac)
smearing_sigma  0.6             # 电子温度 (Ry)，0.6 Ry ≈ 8.16 eV
```

### 2.1.2 核心参数解析

1.  **`esolver_type` (必须为 sdft)**
    *   这是 sDFT 的总开关。默认值为 `ksdft`。一旦设置为 `sdft`，ABACUS 将不再进行波函数对角化，而是启用切比雪夫（Chebyshev）多项式展开求解器。

2.  **`calculation` (scf)**
    *   sDFT 同样支持 `scf`（自洽计算）和 `md`（分子动力学）。但在进行 MD 之前，必须先通过 SCF 确定合适的参数设置。

3.  **`smearing_method` (必须为 fd)**
    *   **原理**：sDFT 天然基于费米-狄拉克（Fermi-Dirac）分布算符的展开。
    *   **限制**：在 sDFT 模式下，`smearing_method` **必须** 设置为 `fd`。不支持 `gaussian` 或 `mp` 等其他展宽方法。
    *   **`smearing_sigma`**：这里的物理意义直接对应**电子温度**。注意单位是 Ry（1 Ry $\approx$ 13.6 eV）。例如温稠密物质模拟中常用的 10 eV 温度，此处应设为 $\approx 0.735$。

---

## 2.2 随机空间与切比雪夫展开设置

sDFT 的计算不再是“精确”的，而是伴随着**随机误差**。作为用户，你的核心任务就是在“计算精度”和“计算成本”之间通过以下两个参数找到平衡点。

### 2.2.1 随机轨道数量 (`nbands_sto`) 与误差控制

`nbands_sto` 定义了用于采样希尔伯特空间的随机向量个数。
*   **规律**：`nbands_sto` 越大，随机噪声越小，结果越精确，但计算耗时线性增加。
*   **经验值**：对于小体系，通常从 64 或 128 开始测试。

#### ⚠️ 关键流程：误差测试 (Error Test)
由于 sDFT 的结果随随机数种子（`seed_sto`）波动，你**不能**仅凭一次计算就断定结果。必须执行以下标准测试流程来确定合适的 `nbands_sto` 和 `ecutwfc`：

1.  **固定参数**：设定一个待测的 `nbands_sto`（如 64）。
2.  **多种子运行**：修改 `seed_sto` 参数（默认为 0，即随机），手动设置 10 个不同的整数（如 1001, 1002, ..., 1010），运行 10 次 SCF 计算。
3.  **统计分析**：收集这 10 次计算的总能量（Total Energy）。
    *   计算**平均值** $\bar{E}$。
    *   计算**标准差** $\sigma_E$。
4.  **判据**：如果标准差 $\sigma_E$ 小于你的目标精度（通常建议 $< 10^{-4}$ Ry/atom），则该 `nbands_sto` 足够；否则需增加轨道数重测。

> **提示**：`ecutwfc` 的收敛性测试也需遵循此流程，比较不同 `ecut` 下的**平均能量**差值。

### 2.2.2 切比雪夫展开阶数 (`nche_sto`)

sDFT 不计算本征值，而是直接计算密度矩阵。这一过程依赖于将费米-狄拉克函数展开为切比雪夫多项式，`nche_sto` 即为展开的阶数。

*   **物理依赖关系（至关重要）**：
    1.  **温度 ($T$)**：温度**越高**，费米分布函数越平滑，需要的 `nche_sto` **越小**（计算越快）。
    2.  **截断能 (`ecut`)**：截断能越大，哈密顿量的谱范围越宽，需要的 `nche_sto` **越大**。

*   **如何检查是否足够？**
    查看输出文件 `running_scf.log`，搜索 `Chebyshev Precision`。
    ```text
    Chebyshev Precision: 1.23e-09
    ```
    推荐该值小于 $10^{-8}$。如果精度不够，请增加 `nche_sto`。

### 2.2.3 进阶技巧：MDFT (混合 DFT)

**何时使用？**
当模拟温度较高，但体系中仍有部分深能级或半核心态（Semi-core states）被完全占据且对化学键有重要贡献时，纯 sDFT 需要极大的 `nbands_sto` 才能准确描述这些定域态。

**如何设置？**
此时应使用 **MDFT**。
*   **设置方法**：在 INPUT 中设置 `nbands > 0`（例如 `nbands 4`）。
*   **效果**：ABACUS 会先用 KSDFT 精确计算最低的 4 条能带（处理深能级），然后用 sDFT 处理剩余的高能级部分。这能显著降低对 `nbands_sto` 的需求，加速收敛。

---

## 2.3 算法选择与并行策略

sDFT 的计算量主要集中在哈密顿量对随机向量的作用上。合理的算法选择和并行设置能带来数倍的性能提升。

### 2.3.1 算法模式 (`method_sto`)

*   **`method_sto 1` (省内存模式)**：
    *   适用于内存受限的大体系。
    *   计算速度相对较慢。
*   **`method_sto 2` (速度优先模式)**：
    *   **默认推荐**。
    *   通过空间换时间，速度较快，但内存消耗较大。

### 2.3.2 并行策略

sDFT 支持多级并行，优先级如下：

1.  **K 点并行 (`kpar`)**：
    *   **优先级：最高**。
    *   如果体系包含多个 K 点，优先设置 `kpar` 等于 K 点总数（或其约数）。这是效率最高的并行方式。

2.  **能带并行 (`bndpar`)**：
    *   **优先级：次高**。
    *   将 `nbands_sto` 个随机轨道分配到不同的进程组中计算。
    *   **设置建议**：默认为 1。在 K 点并行用满后，若还有空闲核数，可尝试增加 `bndpar`。注意 `bndpar` 并非越大越好，需进行简单的 benchmark。

### 2.3.3 风险提示：应力计算 (Stress)

虽然 sDFT 在计算力（Force）和进行 MD 模拟方面已经非常成熟，但涉及晶胞尺寸优化（`calculation cell-relax`）时需要计算应力张量（Stress Tensor）。

*   **注意**：sDFT 的应力计算对随机误差非常敏感。若必须进行晶胞优化，建议：
    1.  务必使用更严格的 `nbands_sto`（通过误差测试确定）。
    2.  查阅最新的官方文档，确认当前版本 sDFT 对应力计算的支持状态及限制。

---

**本章小结**
通过本章，你已经掌握了 sDFT 的核心输入逻辑：
1.  开启 `esolver_type sdft` 和 `smearing_method fd`。
2.  利用“10种子测试法”确定 `nbands_sto`。
3.  根据温度和截断能调整 `nche_sto`。
4.  在深能级主导时启用 MDFT (`nbands > 0`)。

下一章，我们将利用这些知识，实战运行一个温稠密物质的分子动力学（MD）模拟。

# 第三章：核心难点：误差分析与收敛性测试

在上一章中，我们已经成功跑通了第一个 sDFT 计算。但在你直接使用输出的能量或力进行物理分析之前，请务必停下来阅读本章。

**sDFT 与传统 KSDFT 最大的区别在于：结果带有随机性。**

在 KSDFT 中，给定一套参数，能量是唯一的。而在 sDFT 中，由于引入了随机波函数（Stochastic Orbitals），单次计算得到的能量只是真实值附近的一个采样。如果你只运行一次计算，你无法判断这个结果是“正中靶心”还是“脱靶”。

本章将教你如何像实验物理学家处理测量误差一样，处理 sDFT 的计算误差，确保你的结果经得起推敲。

---

## 3.1 理解随机误差与大数定律

sDFT 的核心思想是用一组随机生成的轨道来近似希尔伯特空间的迹（Trace）。根据统计学原理，这种近似带来的**随机误差（Stochastic Error）**与随机轨道数量（$N_{sto}$）的平方根成反比：

$$ \text{Error} \propto \frac{1}{\sqrt{N_{sto}}} $$

这意味着：
1.  **能量不是定值**：对于同一个体系，固定所有物理参数，仅改变随机数种子（`seed_sto`），计算出的总能量会在真实值附近波动（服从高斯分布）。
2.  **收敛的代价**：要将误差减小 10 倍，你需要增加 100 倍的随机轨道数量。因此，盲目增加 `nbands_sto` 极其昂贵，我们需要找到“够用就好”的平衡点。

### 关键参数：`seed_sto`
在 `INPUT` 文件中，`seed_sto` 控制随机数生成器的起始点：
- **默认值 (0)**：使用系统时间作为种子。每次运行结果都不同，适合生产环境的大规模统计。
- **正整数 (>0)**：固定种子。用于调试，确保每次运行结果完全一致。

**实战原则**：在进行收敛性测试时，我们需要手动修改 `seed_sto` 来产生多组独立样本。

---

## 3.2 实战演练：随机轨道数目 (nbands_sto) 的收敛测试

这是 sDFT 计算中最关键的一步。我们必须确定需要多少个随机轨道（`nbands_sto`）才能使能量波动落在可接受范围内（通常建议标准差 $\sigma < 10^{-4}$ Ry/atom）。

### 标准测试流程

请按照以下步骤操作：

1.  **准备基准 INPUT**：设置一个初始的 `nbands_sto`（例如 64 或 128），固定 `ecutwfc` 和 `nche_sto`。
2.  **多样本计算**：选取 10 个不同的正整数作为 `seed_sto`（如 1001, 1002, ..., 1010），分别运行 10 次 SCF 计算。
3.  **统计分析**：收集这 10 次计算的最终能量（`Final Etot`），计算其**平均值**和**标准差**。

#### 示例脚本逻辑
虽然你可以手动修改运行，但在实际科研中，建议使用 Shell 或 Python 脚本自动化：

```bash
#!/bin/bash
# 伪代码示例：循环测试不同的随机种子
for seed in {1001..1010}; do
    # 修改 INPUT 中的 seed_sto
    sed -i "s/seed_sto .*/seed_sto $seed/g" INPUT
    
    # 运行 ABACUS (假设可执行文件为 abacus)
    mpirun -np 4 abacus > log_seed_${seed}.txt
    
    # 提取能量
    grep "Final Etot" log_seed_${seed}.txt >> energy_stats.dat
done
```

### 判据与调整
- **如果标准差 $\sigma > 10^{-4}$ Ry**：说明随机误差过大。你需要增加 `nbands_sto`（例如翻倍），重复上述测试，直到误差满足要求。
- **如果标准差 $\sigma \ll 10^{-4}$ Ry**：说明精度过剩，可以适当减少 `nbands_sto` 以节省计算资源。

### 进阶技巧：何时使用 MDFT？
如果你的体系温度很高，但仍有部分深层能级被完全占据（Occupancy $\approx$ 1），纯 sDFT 的收敛会非常慢，因为随机轨道很难描述这些定域性很强的深层态。

此时，应启用 **MDFT (Mixed DFT)**：
- **原理**：用少量的确定性 KS 轨道（`nbands`）处理深层态，用随机轨道（`nbands_sto`）处理高能态。
- **INPUT 设置**：
  ```
  INPUT_PARAMETERS
  esolver_type  sdft
  nbands        12    # 设置少量 KS 轨道覆盖深能级
  nbands_sto    128   # 随机轨道处理剩余部分
  ```
- **效果**：MDFT 能显著降低对 `nbands_sto` 的需求，大幅提高收敛速度。

---

## 3.3 平面波截断能 (ecutwfc) 的统计测试

在 KSDFT 中，我们习惯画一条“能量 vs ecut”的平滑曲线。但在 sDFT 中，由于随机噪声的存在，这条曲线会呈现锯齿状的“抖动”。

**切记：不能用单次计算的结果来判断 ecut 收敛！**

### 正确的测试方法
1.  **固定 `nbands_sto`**：使用上一步测试确定的数值。
2.  **选取测试点**：例如 `ecutwfc` 取 30, 40, 50, 60, 70 Ry。
3.  **统计平均**：对于**每一个** `ecutwfc` 测试点，都必须使用多个 `seed_sto`（建议 5-10 个）进行计算，并取**能量平均值**。
4.  **判断收敛**：比较相邻 `ecutwfc` 点的**平均能量差**。
    - 判据：$|E_{avg}(E_{cut}) - E_{avg}(E_{cut}+10)| < \text{Tolerance}$
    - 温稠密物质通常能量绝对值很大，相对误差控制在 $10^{-4}$ 量级即可。

---

## 3.4 关键参数依赖关系：nche_sto

在 sDFT 中，`nche_sto`（切比雪夫展开阶数）直接决定了哈密顿量算符 $\hat{H}$ 应用在随机波函数上的精度。它与其他参数有着强烈的依赖关系，设置不当会导致计算发散或极其缓慢。

### 选取逻辑
- **与温度的关系**：**反比**。
  - 温度越高 ($T \uparrow$)，费米-狄拉克分布越平缓，需要的展开阶数越低，计算越快。
  - 温度越低，需要的 `nche_sto` 越高。
- **与截断能的关系**：**正比**。
  - `ecutwfc` 越大，哈密顿量的谱宽度越大，需要更大的 `nche_sto` 才能覆盖。

### 检查方法
每次计算后，检查输出文件 `running_scf.log` 中的 `Chebyshev Precision`。
- **目标**：该值应小于 $10^{-8}$。
- **调整**：如果精度不够，需在 `INPUT` 中增大 `nche_sto`。

---

## 3.5 风险提示与常见误区

1.  **应力 (Stress) 计算的特殊性**：
    - 在 KSDFT 中，我们常开启 `cal_stress` (或 `calculate_stress`) 来优化晶胞。
    - **注意**：sDFT 主要用于高温高压下的 NVT 模拟（固定体积）。虽然 ABACUS 的 sDFT 模块在不断更新，但应力计算对随机噪声非常敏感。在涉及晶胞优化（`calculation cell-relax`）前，请务必查阅最新的官方文档，确认当前版本 sDFT 是否支持应力计算以及其精度是否满足要求。

2.  **赝势的选择**：
    - 在极高温（> 100 eV）条件下，内层电子可能会电离。标准的赝势（通常只把最外层当价电子）可能不再适用。此时可能需要生成包含更多内层电子的“硬”赝势，这会导致需要极高的 `ecutwfc`。

3.  **不要混淆 `nbands` 和 `nbands_sto`**：
    - `nbands` = 确定性轨道（KS轨道），对角化求解，贵但准。
    - `nbands_sto` = 随机轨道，投影求解，便宜但有噪。
    - `nbands = 0` 且 `nbands_sto > 0` $\rightarrow$ 纯 sDFT。
    - `nbands > 0` 且 `nbands_sto > 0` $\rightarrow$ MDFT。

通过本章的测试，你应该已经获得了一组可靠的参数（`nbands_sto`, `nche_sto`, `ecutwfc`）。在下一章中，我们将利用这些参数，正式开展温稠密物质的分子动力学模拟。

# 第四章：进阶应用：混合 DFT (MDFT) 与 分子动力学

在上一章中，我们掌握了随机波函数 DFT (sDFT) 的基本原理和单点能计算。然而，在实际的温稠密物质（WDM）或高温材料研究中，我们往往面临两个挑战：
1.  **精度与效率的平衡**：在某些“中等高温”下，费米面深处的电子仍然保持较强的量子相干性，纯随机方法可能会引入不必要的噪声。
2.  **动态演化**：我们需要模拟原子在高温下的运动轨迹（分子动力学），而不仅仅是静态结构。

本章将深入探讨如何利用 **混合 DFT (Mixed DFT, MDFT)** 技术解决精度问题，并演示如何驱动 **高温分子动力学 (MD)** 模拟。

---

## 4.1 启用混合随机-确定性 DFT (MDFT)

### 4.1.1 为什么要使用 MDFT？

在纯 sDFT (`nbands = 0`) 中，所有的电子态都由随机波函数描述。根据中心极限定理，随机误差随采样数 $N$ 的增加以 $1/\sqrt{N}$ 的速度衰减。

然而，当系统温度不是极高（例如 < 10 eV），或者系统存在深层束缚态时，这些低能级电子对总能量贡献巨大且占据数接近 1。如果用随机轨道描述这些“硬”电子，会产生较大的噪声，导致收敛缓慢。

**MDFT 的核心思想**是“分而治之”：
- **深层能级（低能态）**：使用传统的 Kohn-Sham 轨道（确定性轨道）进行精确对角化求解。
- **浅层/激发能级（高能态）**：使用随机轨道处理海量的部分占据态。

这种方法在保持 sDFT 高效性的同时，显著降低了随机噪声。

### 4.1.2 INPUT 参数设置

要启用 MDFT，关键在于同时设置 `nbands`（KS 轨道数）和 `nbands_sto`（随机轨道数）。

以下是一个典型的 MDFT 输入文件示例（基于硅的改写）：

```bash
INPUT_PARAMETERS
#Parameters (General)
calculation     scf
esolver_type    sdft        # 必须设置为 sdft
pseudo_dir      ../../PP_ORB

# --- MDFT 核心设置 ---
nbands          4           # 确定性 KS 轨道数 (覆盖深层全占据态)
nbands_sto      64          # 随机轨道数 (覆盖费米面附近及高能态)
nche_sto        100         # 切比雪夫展开阶数
method_sto      2           # 推荐算法：2 (速度快但内存消耗略大)
# --------------------

#Parameters (Accuracy)
ecutwfc         50
scf_nmax        20
symmetry        1

#Parameters (Smearing)
smearing_method fd          # MDFT 目前仅支持 Fermi-Dirac (fd)
smearing_sigma  0.6         # 电子温度 (Ry), 0.6 Ry ≈ 8.16 eV
```

**参数详解：**
*   **`nbands`**: 设置为覆盖费米能级以下的深层能带数。设置得越多，精度越接近传统 KSDFT，但计算量也会增加。
*   **`nbands_sto`**: 随机轨道的数量。原则上越多误差越小。
*   **`nche_sto`**: 哈密顿量切比雪夫展开的阶数。
    *   **依赖关系 1 (温度)**: 温度越高，需要的阶数越**小**（计算越快）。
    *   **依赖关系 2 (截断能)**: `ecutwfc` 越大，需要的阶数越**大**。
    *   **调试标准**: 查看输出文件 `running_scf.log`，确保 "Chebyshev Precision" 小于 `1e-8`。

### 4.1.3 关键步骤：误差控制流程 (Error Control Protocol)

**这是本教程最关键的实战技巧。** 由于引入了随机性，单次计算的结果包含随机误差。在发表数据前，**必须**进行误差测试。

**操作流程：**

1.  **准备测试脚本**：编写一个简单的 Shell 脚本，循环修改 `seed_sto`（随机数种子）。
2.  **执行多次计算**：使用相同的 `nbands_sto` 和 `ecut`，运行约 10 次计算，每次使用不同的 `seed_sto`（例如从 1 到 10）。
    *   *提示*：`seed_sto` 默认为 0（随时间生成），为了复现性，建议显式设置整数。
3.  **统计分析**：
    *   收集 10 次计算的总能量（Total Energy）。
    *   计算平均值 $\bar{E}$ 和标准差 $\sigma_E$。
4.  **判断收敛**：
    *   **目标**：通常要求 $\sigma_E < 10^{-4}$ Ry/atom（具体视科研需求而定）。
    *   **调整**：如果 $\sigma_E$ 过大，需要增加 `nbands_sto` 并重新测试。

> **注意**：`ecutwfc` 的收敛性测试也应遵循此流程。在确定好 `nbands_sto` 后，对不同的 `ecut` 分别进行 10 次随机种子测试，比较平均能量 $\bar{E}$ 的差值。

---

## 4.2 高温分子动力学模拟 (MD)

在温稠密物质研究中，我们通常关注离子在电子热库中的运动。ABACUS 的 sDFT/MDFT 模块可以无缝驱动分子动力学。

### 4.2.1 案例：铝的高温 MD (`pw_md_Al`)

本案例模拟 16 个铝原子在电子温度 ~100 eV 下的动力学行为。

**INPUT 文件配置：**

```bash
INPUT_PARAMETERS
#Parameters (General)
calculation     md          # 开启分子动力学
esolver_type    sdft        # 使用 sDFT 求解器
pseudo_dir      ../../PP_ORB

# --- 电子结构参数 ---
nbands          0           # 100 eV 极高温下，深层态也被部分激发，可使用纯 sDFT
nbands_sto      64
nche_sto        20          # 高温下展开阶数可显著降低 (相比低温的 100+)
method_sto      2
ecutwfc         50
scf_nmax        20
scf_thr         1e-6        # MD 中对 SCF 收敛要求通常较高

# --- 温度设置 ---
smearing_method fd
smearing_sigma  7.34986072  # ~100 eV (1 Ry ≈ 13.605 eV)

# --- MD 核心参数 ---
md_tfirst       1160400     # 离子初始温度 (Kelvin), 此处对应 100 eV
md_dt           0.2         # 时间步长 (fs)
md_nstep        10          # MD 总步数
md_type         nvt         # 系综类型 (如 nvt, nve)
```

### 4.2.2 关键参数解析

1.  **`calculation md`**: 告诉 ABACUS 进行离子运动更新。
2.  **`md_tfirst`**: 离子的初始温度，单位是 **Kelvin (K)**。
    *   *换算提示*：1 eV ≈ 11604.5 K。如果电子温度是 100 eV，通常离子温度也设为该量级（假设局部热平衡），即约 $1.16 \times 10^6$ K。
3.  **`md_dt`**: 时间步长，单位 **飞秒 (fs)**。
    *   高温下离子运动剧烈，为了保证积分稳定性，步长通常比常温 MD 小（例如 0.1 - 0.5 fs）。
4.  **`nche_sto` 的优势**: 注意到这里 `nche_sto` 仅设为 20。这是 sDFT 在高温下的巨大优势——温度越高，费米-狄拉克分布越平滑，所需的切比雪夫展开项越少，计算速度越快。

### 4.2.3 风险提示：应力与晶胞优化

在进行 MD 或结构优化时，请务必注意：

*   **力 (Force)**: sDFT/MDFT 对原子受力的计算是成熟的，支持 NVE/NVT 系综的 MD。
*   **应力 (Stress)**: 虽然 ABACUS 的 KSDFT 支持应力计算（用于 NPT 系综或 `cell-relax`），但在 sDFT 模式下，应力计算的精度和支持度可能受限。
    *   **建议**：在进行涉及晶胞尺寸变化（如 `cell-relax` 或 NPT MD）的计算前，请先在小体系上进行测试，检查 `running_scf.log` 或 `running_md.log` 中输出的 Pressure/Stress 是否合理。如果发现数值异常或不支持，请固定晶胞体积（使用 NVT 或 NVE）进行模拟。

---

## 4.3 本章小结

通过本章的学习，您已经掌握了 ABACUS 在极端条件下的两个核心武器：
1.  **MDFT**: 通过 `nbands` 和 `nbands_sto` 的混合使用，在非极高温条件下压制随机噪声。
2.  **高温 MD**: 利用 `calculation md` 结合 sDFT 高效处理高温离子动力学。

**实战清单**：
- [ ] 在使用 MDFT 前，是否根据温度判断了 `nbands` 的必要性？
- [ ] 是否执行了“10 个随机种子”的误差分析流程？
- [ ] 在高温 MD 中，是否根据 $T$ 和 `ecut` 调整了 `nche_sto` 以优化速度？

下一章，我们将探讨如何处理计算结果，包括态密度（DOS）的输出与数据后处理。

# 第五章：电子性质分析：态密度 (DOS) 计算

在完成了体系的能量收敛和结构确定后，深入理解材料物理性质的关键一步是分析电子结构。对于温稠密物质（WDM）或高温体系，态密度（Density of States, DOS）是揭示电子在不同能量区间分布情况的核心指标。

在 sDFT（随机密度泛函理论）框架下，DOS 的计算与传统 KSDFT 略有不同。由于我们使用随机轨道（Stochastic Orbitals）而非确定的本征态，DOS 的获取需要依赖切比雪夫（Chebyshev）展开技术进行重构。本章将基于 `186_PW_SDOS_10D10S` 案例，详细讲解如何在 ABACUS 中通过 sDFT/MDFT 方法计算 DOS，并着重讨论误差控制与大体系的内存优化。

---

## 5.1 DOS 计算流程与参数配置

sDFT 的 DOS 计算通常作为 SCF（自洽场）计算的一部分或紧随其后的后处理步骤进行。与传统方法不同，sDFT 不需要非自洽（NSCF）步骤来加密 K 点，因为随机波函数本身覆盖了整个希尔伯特空间。

### 5.1.1 核心输入文件配置

以案例 `186_PW_SDOS_10D10S` 为例，我们需要在 `INPUT` 文件中添加特定的 DOS 参数。以下是一个典型的用于计算 DOS 的输入文件示例：

```bash
INPUT_PARAMETERS
# 1. General Parameters
suffix         autotest
calculation    scf          # 进行自洽计算
esolver_type   sdft         # 核心：指定求解器为 sDFT
method_sto     2            # 推荐：速度较快且支持内存分块的方法
nbands         10           # 若 >0 则为 MDFT，若 =0 则为纯 sDFT
nbands_sto     10           # 随机轨道数量
nche_sto       120          # SCF 过程中的切比雪夫展开阶数
seed_sto       20000        # 固定随机数种子以复现结果

# 2. Basis & Accuracy
basis_type     pw
ecutwfc        20
scf_thr        1e-6
scf_nmax       20

# 3. Smearing (Critical for sDFT)
smearing_method fd          # 必须使用 Fermi-Dirac
smearing_sigma  0.6         # 电子温度 (Ry)

# 4. DOS Parameters (Key Section)
out_dos         1           # 开启 DOS 输出
dos_emin_ev     -20         # DOS 能量窗口下限 (eV)
dos_emax_ev     100         # DOS 能量窗口上限 (eV)
dos_edelta_ev   0.1         # DOS 能量间隔/分辨率 (eV)
dos_sigma       4           # DOS 重构的高斯展宽因子 (eV)
dos_nche        240         # DOS 计算专用的切比雪夫展开阶数
npart_sto       2           # 内存分块参数 (见 5.2 节)
```

### 5.1.2 关键参数详解

1.  **`out_dos`**:
    *   设置为 `1` 时，程序在 SCF 收敛后会自动调用随机切比雪夫方法计算 DOS。
    *   **输出文件**: 结果将保存在输出目录下的 `DOS1_smearing.dat` 文件中。

2.  **`dos_nche` vs `nche_sto`**:
    *   **`nche_sto`**: 用于 SCF 迭代中计算电荷密度。由于只需要积分性质，通常较低的阶数（如 100-120）即可满足能量收敛要求。
    *   **`dos_nche`**: 用于重构 DOS 曲线。为了获得平滑且细节丰富的 DOS 曲线，**通常需要比 SCF 过程更高的展开阶数**（如本例中的 240）。如果该值过小，输出的 DOS 曲线可能会出现非物理的震荡。

3.  **`dos_sigma`**:
    *   这是在重构 DOS 时引入的高斯展宽因子。注意这与电子温度 `smearing_sigma` 不同。`dos_sigma` 用于平滑随机噪声，通常取值在几 eV 量级（取决于 `dos_edelta_ev` 和切比雪夫展开的收敛性）。

### 5.1.3 误差控制流程（**Critical**）

sDFT 的本质决定了结果带有随机误差。**在进行任何物理分析之前，必须验证随机轨道数量（`nbands_sto`）和截断能（`ecutwfc`）的可靠性。**

**标准测试步骤**：
1.  **固定参数**：设定一组 `nbands_sto` 和 `ecutwfc`。
2.  **多种子测试**：使用约 **10 个不同的 `seed_sto`**（如 100, 200, ..., 1000）分别运行 SCF 计算。
3.  **统计分析**：
    *   收集所有计算的总能量。
    *   计算平均值 $\bar{E}$ 和标准差 $\sigma_E$。
4.  **判据**：
    *   如果 $\sigma_E / N_{atom} < 10^{-4}$ Ry（或根据具体精度需求），则认为 `nbands_sto` 足够。
    *   如果误差过大，需增加 `nbands_sto`。注意：误差随 $\frac{1}{\sqrt{N_{sto}}}$ 衰减。

---

## 5.2 大体系 DOS 计算的内存优化

在处理包含数百甚至上千原子的高温体系时，存储巨大的随机波函数矩阵可能会导致内存溢出（OOM）。ABACUS 提供了分块计算策略来解决这一问题。

### 5.2.1 内存分块参数

*   **`method_sto`**: 建议设置为 `2`。这是启用内存优化和更高效算法的前提。
*   **`npart_sto`**: 内存分块数（默认为 1）。
    *   **作用**: 当 `method_sto=2` 时，程序会将 DOS 计算所需的内存需求降为原来的 $1/\text{npart\_sto}$。
    *   **代价**: 计算时间会随着 `npart_sto` 的增加而线性增加。这是一个典型的“时间换空间”策略。

### 5.2.2 配置建议

如果您的计算节点内存为 256 GB，而标准计算预估需要 400 GB 内存：
1.  设置 `method_sto 2`。
2.  设置 `npart_sto 2`（理论内存需求降至 ~200 GB）。
3.  运行计算并监控内存峰值。

---

## 附录：常见问题与专家建议

### 1. MDFT 与 sDFT 的选择策略 (**Critical**)
很多用户困惑何时使用混合方法（MDFT，即 `nbands > 0`）。
*   **纯 sDFT (`nbands=0`)**: 适用于极高温度（如 > 50 eV），此时几乎所有电子都处于高度离域状态，费米狄拉克分布极其平缓。
*   **MDFT (`nbands > 0`)**: 适用于“温稠密”区间（如 1 eV - 20 eV）。在此温度下，虽然价电子被激发，但深层能级（Deep states）或部分价带底的电子仍然具有较强的束缚性质。
    *   **专家建议**: 将低能的束缚态用确定的 Kohn-Sham 轨道（`nbands`）处理，而将高能的连续态用随机轨道（`nbands_sto`）处理。这能显著降低随机误差，加速收敛。

### 2. 切比雪夫阶数 (`nche_sto`) 的依赖关系 (**Critical**)
`nche_sto` 的选取并非任意，它遵循以下物理规律：
*   **与温度成反比**: 温度越高，费米分布越平滑，需要的切比雪夫展开阶数越**小**（计算越快）。
*   **与 Ecut 成正比**: 截断能 `ecutwfc` 越大，哈密顿量的谱范围越宽，需要的展开阶数越**大**。
*   **监控指标**: 检查输出文件 `running_scf.log` 中的 `Chebyshev Precision`，目标是使其小于 `1e-8`。

### 3. 高温赝势的陷阱
*   **内壳层电离**: 在高温下（如 > 50 eV），常温下被视为“冻结”的内壳层电子可能会发生电离。
*   **警告**: 使用标准赝势库（如 SG15, ONCVPSP）进行极高温计算是危险的。务必检查赝势的截断半径和价电子设置，必要时需生成专门的高温赝势（包含更多内层电子作为价电子）。

### 4. Smearing 方法的限制
*   **严格限制**: sDFT 目前**仅支持** `smearing_method fd` (Fermi-Dirac)。
*   **禁止操作**: 切勿使用 `gauss` 或 `mp` (Methfessel-Paxton) 方法，这些方法在随机波函数框架下未被适配，会导致计算错误或崩溃。

### 5. 风险提示：应力与晶胞优化
*   虽然 sDFT 支持计算力（Force）并进行分子动力学（MD）模拟，但**应力（Stress）张量**的计算在 sDFT 中可能存在精度或实现上的限制。
*   **建议**: 若需进行变胞优化（Cell Relaxation, `calculation cell-relax`），请务必先查阅最新的 ABACUS 官方文档确认当前版本 sDFT 是否完全支持应力计算。如果不支持，请仅固定晶胞体积进行离子步弛豫。

---

## 附录：进阶学习指南

恭喜你完成了本教程的学习！掌握 sDFT 只是探索极端条件物理的第一步。为了进一步提升研究深度，我们建议你在以下方向继续探索：

### 1. 深度扩展阅读
- **输运性质计算**：本教程重点讲解了能量与态密度。基于 sDFT 的电子电导率与热导率计算（Kubo-Greenwood 公式）是 WDM 研究的另一大核心，建议查阅 ABACUS 官方关于 `abacus-sdft_cond` 的进阶教程。
- **理论背景加深**：深入研读 Qianrui Liu 和 Mohan Chen 老师在 *Phys. Rev. B* (2022) 上发表的关于平面波 sDFT 算法实现的论文，理解切比雪夫展开与随机采样的数学本质。

### 2. 调试建议（Troubleshooting）
- **噪声控制**：如果发现能量波动过大，优先增加随机轨道数（`nbands_sto`），而非单纯增加迭代步数。
- **内存管理**：在超大体系计算中，注意监控内存占用。合理配置 `kpar` 和 `bnd_par` 等并行参数，可以有效平衡计算速度与内存负载。
- **MDFT 切换点**：在 MDFT 计算中，确定“确定性轨道”与“随机轨道”的切换能量阈值是精度平衡的关键，建议针对具体体系进行梯度测试。

### 3. 官方资源与社区
- **官方文档**：请随时关注 [ABACUS User Guide](https://mcresearch.github.io/abacus-user-guide/) 以获取最新的参数说明与功能更新。
- **开发者互动**：若在计算中遇到程序报错或物理结果异常，欢迎通过 GitHub Issue 或邮件列表与开发者团队（如陈默涵老师课题组）联系。

科学探索永无止境，愿 ABACUS 成为你研究道路上的得力助手！
