# 第三章：基于 abacustest 的弹性常数计算工作流

在上一章节中，我们已经获得了经过充分优化的晶体结构（`cell-relax`）。这是计算高精度弹性常数的基石。本章将进入实战的核心环节：如何利用 `abacustest` 这一强大的辅助工具，自动化地完成“施加应变-构建任务-批量计算”的完整工作流。

我们将摒弃繁琐的手动建模，采用标准化的“黑盒”操作流程，确保计算的一致性和可重复性。

---

## 3.1 自动生成形变任务

计算弹性常数的核心思想是**应力-应变法（Stress-Strain Method）**。我们需要人为地对晶胞施加一系列微小的正应变（Normal Strain）和剪切应变（Shear Strain），然后计算这些形变结构下的应力响应。

手动创建这些形变结构不仅耗时，而且极易出错。`abacustest` 提供了基于 `lib-model` 的一键生成功能。

### 3.1.1 准备工作
请确保你已经拥有优化好的结构文件（例如 `STRU_ION_D`，即优化后的原子坐标和晶胞）。
*   **关键检查点**：在进行形变之前，请务必确认你的初始结构晶格矢量（Lattice Vectors）是否与笛卡尔坐标轴对齐。
    *   对于立方晶系，建议晶格矢量 $\vec{a}, \vec{b}, \vec{c}$ 分别沿 $x, y, z$ 轴方向。
    *   **警告**：如果晶体被随意旋转，计算出的 $C_{ij}$ 矩阵也将是旋转后的结果，无法直接与标准数据库（如 Materials Project）中的值进行对比。

### 3.1.2 执行生成命令
假设优化后的结构文件位于 `Si/OUT.ABACUS/STRU_ION_D`，我们可以使用以下命令生成弹性常数计算任务：

```bash
abacustest lib-model \
    -f Si/OUT.ABACUS/STRU_ION_D \
    --ftype stru \
    --jtype relax \
    --lcao \
    --folder-syntax Si-elastic \
    --model elastic \
    --norm 0.01 \
    --shear 0.01
```

### 3.1.3 参数详解
*   **`-f`**: 指定输入结构文件路径。
*   **`--model elastic`**: **核心参数**。告诉 `abacustest` 启用弹性常数计算工作流。
*   **`--folder-syntax`**: 指定生成的任务总目录名称（例如 `Si-elastic`）。
*   **`--norm`** (默认 0.01): 指定最大**正应变**幅度。
    *   *物理意义*: 0.01 代表 1% 的形变。程序会自动生成 $\pm 0.005$ (0.5%) 和 $\pm 0.01$ (1%) 的形变点。
    *   *建议*: 保持默认值。过小（<0.001）会被数值噪声淹没；过大（>0.02）可能超出胡克定律的线性响应范围。
*   **`--shear`** (默认 0.01): 指定最大**剪切应变**幅度。原则同上。
*   **`--norelax`** (可选):
    *   若**不加**此参数（默认情况）：生成的任务将进行**原子位置优化**（`calculation = relax`）。这对应于**松弛离子（Relaxed-ion）**弹性常数，包含原子内部弛豫对应力的贡献，**这是符合物理实测值的推荐设置**。
    *   若**加上**此参数：生成的任务仅进行电子步自洽（`calculation = scf`）。这对应于**固定离子（Clamped-ion）**弹性常数，通常偏大，不建议用于对比实验值。

> **⚠️ 严重警告**
>
> 请务必注意：**重复执行上述生成命令会直接删除并覆盖已有的 `Si-elastic` 目录！**
> 如果你已经计算了一半，切勿再次运行该命令，否则所有计算数据将丢失。

---

## 3.2 理解变形计算的参数设置

执行上述命令后，进入 `Si-elastic` 目录，你会看到一系列以 `deform-` 开头的子文件夹（如 `deform-001`, `deform-002`...）以及一个 `org`（原始结构）文件夹。

每个文件夹中都包含了一套完整的 ABACUS 输入文件。作为高阶用户，我们需要打开其中的 `INPUT` 文件，理解关键参数的设置逻辑。

### 3.2.1 核心参数剖析

```bash
# 示例：Si-elastic/deform-001/INPUT 文件片段

calculation     relax   # 计算类型：固定晶胞，优化原子位置
cal_stress      1       # 核心开关：计算应力张量
cal_force       1       # 辅助开关：计算原子受力（relax 必需）
esolver_type    ks      # 求解器：Kohn-Sham 密度泛函理论
...
```

1.  **`calculation`**: 设置为 **`relax`** (而非 `cell-relax` 或 `scf`)
    *   **原理**: 在弹性常数计算中，我们人为施加了应变（改变了晶胞形状），此时晶胞必须保持固定（Fixed Cell），不能让 ABACUS 自动优化晶胞，否则应变会被“优化”掉。
    *   **为何不是 `scf`?**: 当晶胞发生形变时，原子内部受力不再平衡。为了获得宏观上正确的应力响应，必须允许原子移动到新的平衡位置（Internal Relaxation）。因此需要进行固定晶胞的原子弛豫。

2.  **`cal_stress`**: 设置为 **`1`**
    *   **物理意义**: 开启应力张量（Stress Tensor）的计算。这是拟合弹性常数 $C_{ij}$ 的直接数据来源。若此项为 0，后续处理将无法进行。

3.  **`cal_force`**: 设置为 **`1`**
    *   这是进行原子弛豫（`relax`）的前提条件。

### 3.2.2 目录结构说明
生成的目录结构通常如下所示：
*   `Si-elastic/`
    *   `org/`: 0 应变原始结构的计算任务（基准点）。
    *   `deform-000` ~ `deform-00N`: 施加了不同模式（正应变/剪切应变）和不同幅度（±0.5%, ±1%）的计算任务。
    *   `stru_file/`: 存放所有生成的形变结构文件（备份）。

---

## 3.3 批量提交与任务管理

生成完几十个形变任务文件夹后，我们需要批量提交这些任务。`abacustest` 自身提供了提交功能，或者你也可以使用 Shell 脚本结合作业调度系统（如 Slurm/PBS）进行提交。

### 3.3.1 提交策略

**方法一：使用 abacustest 提交（推荐）**
`abacustest` 可以读取目录结构并自动生成提交脚本或直接运行。具体命令取决于你的集群配置，通常涉及 `abacustest submit` 模块。

**方法二：使用 Shell 脚本批量提交（通用）**
如果你习惯手动控制，可以使用如下的 Shell 脚本逻辑遍历所有文件夹并提交任务：

```bash
#!/bin/bash

# 进入总目录
cd Si-elastic

# 遍历所有 deform 开头的文件夹以及 org 文件夹
for dir in deform-* org; do
    if [ -d "$dir" ]; then
        cd "$dir"
        echo "Submitting task in $dir..."
        
        # 根据你的集群环境修改提交命令
        # 例如 Slurm: sbatch sub.slurm
        # 或者直接运行（仅限单机测试）: mpirun -np 8 abacus > output.log &
        
        # 假设这里有一个提交脚本 sub.sh
        sbatch sub.sh
        
        cd ..
    fi
done
```

### 3.3.2 监控计算进度
弹性常数计算的每个子任务（`relax`）通常收敛较快，因为初始结构已经经过优化，且施加的应变很小（$\le 1\%$）。
*   **检查方法**: 观察每个文件夹下的 `OUT.ABACUS/running_relax.log` 或标准输出文件。
*   **成功标志**: 任务应当正常结束，且在输出文件中包含 `STRESS TENSOR` 数据块。

### 3.3.3 下一步预告
当所有 `deform-xxx` 和 `org` 文件夹中的计算全部完成后，我们就可以进入最后一步：**后处理与数据拟合**。在下一章中，我们将讲解如何使用 `abacustest` 一键提取所有应力数据，拟合出完整的 $6\times6$ 弹性矩阵，并导出体模量、剪切模量等关键力学性质。