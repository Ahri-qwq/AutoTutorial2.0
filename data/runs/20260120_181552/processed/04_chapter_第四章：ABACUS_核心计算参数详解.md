# 第四章：ABACUS 核心计算参数详解

你好！我是你的 ABACUS 导师。在上一章我们搭建了计算环境，现在我们将进入最核心的技术环节——**编写 INPUT 文件**。

计算弹性常数（Elastic Constants）是对 DFT 软件精度和参数设置的“试金石”。它本质上是在计算能量或应力对晶格形变的二阶响应。任何微小的参数设置不当（如应力未收敛、晶胞意外变形、基组精度不足）都会被放大，导致结果完全不可用。

本章我将带你逐行解析 `INPUT` 文件，特别是那些决定成败的“隐形开关”。

---

# 第四章：ABACUS 核心计算参数详解

在弹性常数计算的工作流中，我们实际上涉及两个截然不同的计算阶段，它们的 `INPUT` 设置逻辑完全相反：
1.  **零应力基态优化（Pre-optimization）**：确保初始结构处于完美的力学平衡态。
2.  **变形结构响应计算（Deformation & Response）**：对施加了微小应变的结构进行电子步和离子步弛豫，提取应力张量。

本章重点讲解**第二阶段**（变形结构）的参数设置，这是最容易出错的地方。

## 4.1 离子弛豫与应力计算设置 (The Golden Rules)

这是本教程最重要的部分。如果你记不住所有参数，请至少记住下面这条**铁律**：

> **核心警示 (Critical Warning)**
>
> 在计算施加了应变（Strain）的结构时，`calculation` 参数必须设置为 `relax`，**绝对不能**设置为 `cell-relax`。

### 4.1.1 为什么不能用 `cell-relax`？
*   **`cell-relax` (变胞弛豫)**：允许晶格矢量（Lattice Vectors）和原子位置同时变化，目标是消除晶胞上的应力。如果你对一个施加了 +1% 应变的晶胞使用 `cell-relax`，ABACUS 会认为这个应力是“不稳定的”，并自动把晶胞优化回原本的无应变状态。结果是：应变被释放，应力归零，你算了个寂寞。
*   **`relax` (定胞弛豫)**：固定晶格矢量（保持我们施加的 $\pm 0.01$ 应变），仅移动原子位置以消除内部原子受力（Internal atomic force）。这才是我们需要的——**在固定形变下的平衡应力响应**。

### 4.1.2 关键参数详解

以下是一个标准的用于弹性常数计算的 `INPUT` 核心模块：

```bash
INPUT_PARAMETERS
# --- 任务类型与弛豫策略 ---
calculation     relax       # 关键！固定晶胞，仅优化原子位置
cal_force       1           # 开启力计算，用于指导原子移动
cal_stress      1           # 关键！开启应力张量计算，这是弹性常数的来源

# --- 离子步收敛标准 ---
force_thr_ev    0.001       # 力的收敛阈值 (eV/Ang)，建议比常规优化更严
esolver_type    kg          # (可选) 某些体系下 kg 求解器效率较高，默认 cg 亦可
```

*   **`cal_stress`**: 必须设为 `1`。虽然 `relax` 任务主要看力，但我们需要输出 `TOTAL-STRESS` 张量来拟合胡克定律。
*   **`force_thr_ev`**: 弹性常数计算对残余力非常敏感。如果原子没有弛豫到真正的受力平衡位置，内部应力会污染宏观应力张量。建议设置为 `0.001` 甚至 `0.0005`。

---

## 4.2 精度控制与电子结构参数

弹性常数是“硬”性质，对基组截断能（Cutoff）和 K 点密度的收敛要求远高于简单的能量计算。

### 4.2.1 能量截断与基组 (Basis Set)
对于平面波（PW）或 LCAO 基组，截断能必须足够高以消除“普尔艾应力”（Pulay Stress）。

```bash
# --- 电子结构精度 ---
ecutwfc         80          # (Ry) 平面波截断能。
                            # 经验法则：比赝势建议值高 20-30% 以上。
                            # 必须通过收敛性测试确定！
```

### 4.2.2 展宽与混合 (Smearing & Mixing)
对于金属体系或小带隙半导体，Smearing 的选择至关重要。

```bash
# --- 电子步迭代设置 ---
scf_thr         1.0e-8      # (Ry) 自洽收敛阈值。弹性计算需高精度，推荐 1e-8
mixing_type     broyden     # 电荷密度混合方法，Broyden 通常最稳健

# --- Smearing 设置 (针对金属/窄带隙) ---
smearing_method gaussian    # 推荐 Gaussian 或 mp (Methfessel-Paxton)
smearing_sigma  0.002       # (Ry) 展宽宽度。
```

*   **教授建议**:
    *   **绝缘体**: 可以不设置 `smearing_method` (默认为 fixed)，或者使用极小的 sigma。
    *   **金属**: 推荐使用 `gaussian`。注意 `smearing_sigma` 的单位是 Rydberg。`0.002 Ry` (约 27 meV) 是一个比较安全的起点，既能辅助收敛，又不会引入过多的电子熵误差。如果体系极难收敛，可适当增大至 `0.01`，但需验证结果对 sigma 的依赖性。

### 4.2.3 对称性设置 (Symmetry)

这是一个高级且充满风险的参数。

```bash
# --- 对称性 ---
symmetry        1           # 默认值。通常保持开启。
# symmetry      0           # 风险提示：见下文
```

**风险提示**:
当我们对晶胞施加剪切应变（如 triclinic 变形）时，体系的对称性会显著降低。
*   通常 ABACUS 能自动识别降级后的对称性。
*   **Debug 技巧**: 如果你发现计算在某些特定的剪切变形下报错，或者弛豫后的原子结构非常奇怪，请尝试在 `INPUT` 中显式设置 `symmetry 0`（关闭对称性分析）。这会增加计算量（不再利用不可约 K 点），但能保证物理上的正确性，防止软件强行施加错误的对称性约束。

---

## 4.3 完整工作流与实战锦囊 (Workflow Tips)

为了让你对整个流程胸有成竹，我们梳理一下从准备到分析的全貌。

### 4.3.1 第一步：零应力基态优化 (The Pre-requisite)
在进行任何变形之前，你必须拥有一个完美的、无应力的原始结构。
*   **INPUT 设置**: `calculation cell-relax`, `cal_stress 1`.
*   **标准**: `stress_thr` (应力阈值) 应低于 0.5 kbar (甚至 0.1 kbar)。
*   **后果**: 如果原始结构即使有 5 kbar 的残余应力，计算出的弹性常数也会出现显著误差（尤其是 $C_{11}$ 和 $C_{12}$）。

### 4.3.2 第二步：生成 24 种构型
为什么是 24 种？
*   **6 种独立应变模式**: 对应 Voigt 记号下的 $\epsilon_{1} \dots \epsilon_{6}$ (即 xx, yy, zz, yz, xz, xy)。
*   **4 种应变大小**: 为了进行线性拟合，通常对每种模式施加 $\pm \delta_1$ 和 $\pm \delta_2$ 的应变。
    *   推荐值：$\pm 0.005$ (0.5%) 和 $\pm 0.01$ (1.0%)。
    *   应变过大（>2%）可能超出弹性线性响应区；应变过小（<0.1%）则会被 DFT 的数值噪声淹没。

### 4.3.3 第三步：批量计算与单位换算
当你运行完所有 `relax` 任务后，你需要提取 `OUT.${suffix}/running_relax.log` 或 `OUT.${suffix}/AM_STRESS` 中的应力数据。

*   **ABACUS 输出单位**: **kbar** (千巴)。
*   **文献常用单位**: **GPa** (吉帕)。
*   **换算关系**: $1 \text{ GPa} = 10 \text{ kbar}$。

> **脚本提示**: 大多数自动处理脚本（如基于 ASE 或 pymatgen 的脚本）会自动读取 ABACUS 输出并进行单位转换，但作为研究者，请务必在拿到最终数据时，人肉检查一下数量级是否合理（例如金刚石的 $C_{11}$ 约为 1000 GPa，铝约为 100 GPa）。

---

## 本章小结：INPUT 文件速查表

针对弹性常数计算的变形结构，请核对你的 `INPUT` 文件是否符合以下规范：

| 参数名 | 推荐值 | 物理意义 | 备注 |
| :--- | :--- | :--- | :--- |
| `calculation` | **`relax`** | 仅优化原子位置 | **切勿使用 cell-relax** |
| `cal_stress` | `1` | 计算应力张量 | 必须开启 |
| `cal_force` | `1` | 计算原子受力 | `relax` 必须开启 |
| `ecutwfc` | (High) | 波函数截断能 | 需严格测试收敛性 |
| `scf_thr` | `1.0e-8` | 电子自洽精度 | 需高精度 |
| `force_thr_ev`| `0.001` | 离子力收敛精度 | 越小越好，防止内部应力残留 |
| `symmetry` | `1` (或 `0`) | 晶体对称性 | 遇剪切变形报错时设为 0 |

下一章，我们将编写 Python 脚本来自动化生成这 24 个变形结构，并批量生成作业文件，正式开启“大规模”计算。