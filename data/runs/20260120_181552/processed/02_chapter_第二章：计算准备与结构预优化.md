# 第二章：计算准备与结构预优化

> **本章核心逻辑**：弹性常数（Elastic Constants）是能量对晶格应变的二阶导数，或者是应力对应变的一阶导数。这意味着它们对应力状态极其敏感。如果你的初始结构中存在微小的“残余应力”（Residual Stress），它们将在后续的拟合过程中被错误地放大为材料的弹性响应。因此，**完美的零应力初始结构**是计算弹性常数的绝对前提。

---

## Section 2.1: 辅助工具与环境配置

弹性常数的计算本质上是一个“高通量”任务。为了获得完整的刚度矩阵，我们需要对晶胞施加多组不同的微小形变，并计算每种形变下的能量或应力响应。手动修改 `STRU` 文件不仅效率低下，而且极易出错。

在本教程中，我们将采用 **Python 脚本自动化工作流**。

### 2.1.1 外部依赖库：pymatgen
我们需要依赖 `pymatgen` (Python Materials Genomics) 库来处理晶体结构的张量变换。它能精确地将数学上的应变矩阵应用到 ABACUS 的 `STRU` 文件中。

**安装命令**：
```bash
pip install pymatgen numpy
```

### 2.1.2 配套脚本体系
为了实现自动化，我们通常构建以下三个核心脚本（在后续章节的实战演练中会提供具体代码，此处先明确其功能定位）：

1.  **生成器 (`gene_dfm.py`)**：
    *   **功能**：读取优化后的 `STRU`，施加应变。
    *   **工作原理（锦囊妙计）**：为了保证拟合精度，我们通常采用“**6x4 策略**”，即生成 **24种构型**。
        *   **6种应变模式**：对应各向异性材料的6个独立应变分量 ($\varepsilon_{xx}, \varepsilon_{yy}, \varepsilon_{zz}, \varepsilon_{yz}, \varepsilon_{xz}, \varepsilon_{xy}$)。
        *   **4种应变幅值**：通常取 $\pm 0.01$ (1%) 和 $\pm 0.005$ (0.5%)。这既保证了处于线性弹性区间，又避免了数值噪声的影响。
2.  **执行器 (`run_task.sh`)**：
    *   **功能**：批量提交 ABACUS 计算任务，管理文件夹结构。
3.  **分析器 (`compute_dfm.py`)**：
    *   **功能**：提取 DFT 计算得到的能量（Energy）和应力（Stress），进行多项式拟合求解弹性常数矩阵。
    *   **单位警示**：ABACUS 输出的应力单位通常为 **kBar**，而文献中弹性常数常用 **GPa**。该脚本必须包含自动单位转换逻辑 ($1 \text{ GPa} = 10 \text{ kBar}$)。

---

## Section 2.2: 初始结构的零应力优化

这是新手最容易“翻车”的环节。在施加任何人为应变之前，你手中的原始结构（无论是从 Materials Project 下载，还是实验测得）通常都包含非零的内部应力。

**目标**：获得一个处于势能面极小值、且晶胞应力张量近乎为零的基态结构。

### 2.2.1 关键 INPUT 参数设置
此步骤必须进行**变胞优化**。请创建一个专门的文件夹（如 `00_pre_relax`）进行此步计算。

**`INPUT` 文件示例**：
```bash
INPUT_PARAMETERS
# --- 基础设置 ---
suffix          Si_pre_relax
ntype           1
basis_type      pw              # 推荐使用平面波(pw)以获得更精确的应力张量，lcao亦可但需测试
ecutwfc         80              # 【关键】计算应力时，截断能通常需要比仅计算能量时更高

# --- 核心优化参数 ---
calculation     cell-relax      # 【关键】变胞优化：同时优化原子位置和晶格矢量
relax_nmax      100             # 最大离子步数
cal_stress      1               # 【必须】显式开启应力计算
cal_force       1               # 计算原子力

# --- 收敛标准（极高精度） ---
scf_thr         1.0e-8          # 电子步收敛标准
force_thr_ev    1.0e-4          # 力收敛标准 (eV/Ang)，建议比常规优化严一个数量级
stress_thr      0.1             # 【关键】应力收敛标准 (kBar)。0.1 kBar 意味着残余应力极小

# --- 其他 ---
out_stru        1               # 输出优化后的结构文件
```

### 2.2.2 教授的“避坑”指南

#### 1. 收敛精度的重要性
普通的结构优化可能只需要 `force_thr_ev 0.01` 和 `stress_thr 10`。但这对于弹性常数计算是**完全不够的**。
*   **原理**：弹性常数计算依赖于应力对应变的微小响应。如果背景噪音（残余应力）是 5 kBar，而施加 1% 应变产生的物理应力只有 20 kBar，你的信噪比将极低，导致结果完全不可信。
*   **建议**：务必将 `stress_thr` 压低至 **0.1 kBar** 或更低。

#### 2. ecutwfc (截断能) 的选择
*   **现象**：你可能会发现应力很难收敛，或者对应力结果不敏感。
*   **原因**：根据 Pulay Stress 原理，平面波基组计算应力时对截断能非常敏感。
*   **对策**：在计算弹性常数前，建议进行 `ecutwfc` 收敛性测试。通常使用的截断能应比赝势建议值高出 **30%~50%**。

#### 3. 对称性的陷阱 (Risk Warning)
在预优化阶段，ABACUS 默认开启对称性分析 (`symmetry 1`) 以加速计算，这通常没问题。
*   **风险提示**：在后续施加**剪切应变**（Shear Strain，如 $\varepsilon_{xy}$）时，晶格对称性会被破坏。如果后续计算报错或结果异常，请尝试在 INPUT 中显式设置 `symmetry 0` 以关闭对称性分析。但在本节的 `cell-relax` 阶段，保持默认即可。

### 2.2.3 结果检查与下一步
计算结束后，检查输出文件（通常在 `OUT.suffix/` 目录下）。
1.  **查看收敛情况**：确认任务正常结束，且最后一步的 Stress 和 Force 均低于阈值。
2.  **获取新结构**：找到 `STRU_ION_D`（优化后的结构文件）。
3.  **重命名**：将其复制并重命名为 `STRU_0`，这将是后续所有形变任务的**唯一种子结构**。

---

### 🔥 核心强调：计算类型的生死红线

在结束本章前，我必须强调一个在后续章节（批量计算）中**绝对不能犯**的错误，请现在就刻在脑子里：

| 计算阶段 | 任务目标 | INPUT 参数 `calculation` | 物理含义 |
| :--- | :--- | :--- | :--- |
| **本章阶段** | 消除残余应力 | **`cell-relax`** | **变胞优化**：晶格常数和原子位置**都**可以动。 |
| **下一章阶段** | 计算应变响应 | **`relax`** | **定胞优化**：**锁死晶格**（保持施加的应变），仅优化原子位置。 |

> **警告**：如果在下一章施加应变后，你错误地将 `calculation` 设为了 `cell-relax`，ABACUS 会认为施加的应变是“不稳定的高能状态”，并自动把晶格优化回本章得到的零应力平衡态。
> **结果**：你算出的所有应力都接近于零，弹性常数计算彻底失败。

---

**下一章预告**：我们将使用 `pymatgen` 脚本基于 `STRU_0` 生成 24 个形变结构，并编写 Shell 脚本批量提交计算任务。