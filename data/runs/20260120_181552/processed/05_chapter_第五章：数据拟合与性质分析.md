# 第五章：数据拟合与性质分析

在前一章中，我们通过高通量流程成功提交了 24 个独立的计算任务。现在，面对生成的 24 个 `OUT` 文件夹，我们的目标是从海量的日志文件中提取应力张量（Stress Tensor），并通过线性拟合求解出材料的刚度矩阵（Stiffness Matrix, $C_{ij}$），最终推导出杨氏模量、剪切模量等宏观力学性质。

本章将带你完成从“原始数据”到“物理结论”的关键一步。

---

## 5.1 应力提取与线性拟合

弹性常数的计算基于胡克定律（Hooke's Law）的线性近似：
$$ \sigma_i = \sum_{j=1}^{6} C_{ij} \epsilon_j $$
其中 $\sigma_i$ 是应力，$\epsilon_j$ 是我们在上一章施加的微小应变。

### 5.1.1 理解数据集：为什么是 24 个任务？

在处理数据前，必须理解数据的物理来源。为了求解完整的 $C_{ij}$ 矩阵，我们通常采用以下策略：
*   **6 种独立应变模式**：分别对应晶胞的拉伸（xx, yy, zz）和剪切（yz, xz, xy）变形。
*   **4 种应变幅值**：为了验证线性和消除奇函数高阶项误差，通常对每种模式施加 $\pm \delta$ 和 $\pm 2\delta$ 的应变（例如 $\pm 0.005, \pm 0.01$）。
*   **总量**：$6 \times 4 = 24$ 个构型。

### 5.1.2 使用 Python 脚本提取数据

我们使用社区常用的后处理脚本 `compute_dfm.py`（假设脚本名，实际操作中可能是 `elastic_post.py` 或用户自写脚本）来自动化这一过程。该脚本的核心逻辑是读取每个任务目录下 `OUT.*/running_scf.log` 中的应力数据。

**操作示例**：
```bash
# 在包含 001/, 002/ ... 024/ 任务文件夹的根目录下运行
python3 compute_dfm.py --path ./ --strain 0.005
```

**脚本输出解读**：
脚本运行后，通常会输出每个分支的拟合详情。请重点关注以下 Log 信息：

```text
Processing strain mode 1 (xx deformation)...
  Strain points: [-0.01, -0.005, 0.005, 0.01]
  Stress (kbar): [-15.2, -7.6, 7.7, 15.3]
  Linear fit R-squared: 0.9998  <-- 关键指标！
  Slope (C11 estimate): 1530.5 kbar
...
```

### 5.1.3 拟合优度自检 (R-squared)

**R-squared ($R^2$)** 是判断计算是否成功的“金标准”：
*   **$R^2 > 0.999$**：完美。应变处于弹性线性区，计算精度极高。
*   **$0.99 < R^2 < 0.999$**：可接受。可能存在轻微的数值噪声或应变稍大。
*   **$R^2 < 0.95$**：**警报**。数据不可用。原因通常是：
    1.  应变幅值过大（如 > 0.02），进入了非线性（塑性）区域。
    2.  基态结构优化不彻底（存在残余应力）。
    3.  电子步未收敛（检查 `scf_thr`）。

---

## 5.2 宏观力学性质计算

得到刚度矩阵 $C_{ij}$ 后，我们利用 Voigt-Reuss-Hill (VRH) 近似来计算多晶材料的平均力学性质。

### 5.2.1 刚度矩阵 $C_{ij}$ 与 柔度矩阵 $S_{ij}$

脚本首先会输出 $6 \times 6$ 的 $C_{ij}$ 矩阵（单位通常为 GPa 或 kbar）。
$$ [C] = \begin{pmatrix} C_{11} & C_{12} & \cdots \\ C_{12} & C_{22} & \cdots \\ \vdots & \vdots & \ddots \end{pmatrix} $$
同时，脚本会计算其逆矩阵 $S = C^{-1}$，即柔度矩阵。

### 5.2.2 VRH 近似计算

晶体材料通常具有各向异性，而工程上常用的多晶材料是各向同性的。我们使用以下三种模型进行平均：

1.  **Voigt 界限 ($M_V$)**：假设多晶各晶粒**应变**相同（上限）。
    *   $B_V = \frac{1}{9}(C_{11} + C_{22} + C_{33} + 2(C_{12} + C_{13} + C_{23}))$
    *   $G_V = \frac{1}{15}(C_{11} + C_{22} + C_{33} - (C_{12} + C_{13} + C_{23}) + 3(C_{44} + C_{55} + C_{66}))$
2.  **Reuss 界限 ($M_R$)**：假设多晶各晶粒**应力**相同（下限，使用 $S_{ij}$ 计算）。
    *   $B_R = [(S_{11} + S_{22} + S_{33}) + 2(S_{12} + S_{13} + S_{23})]^{-1}$
    *   $G_R = 15 [4(S_{11} + S_{22} + S_{33}) - 4(S_{12} + S_{13} + S_{23}) + 3(S_{44} + S_{55} + S_{66})]^{-1}$
3.  **Hill 平均 ($M_H$)**：Voigt 和 Reuss 的算术平均值，最接近实验值。
    *   $B_H = \frac{B_V + B_R}{2}$
    *   $G_H = \frac{G_V + G_R}{2}$

### 5.2.3 最终物理量导出

基于 Hill 平均的体积模量 $B$ 和剪切模量 $G$，我们可以计算：

*   **杨氏模量 (Young's Modulus, $E$)**: 衡量材料抵抗拉伸变形的能力。
    $$ E = \frac{9BG}{3B + G} $$
*   **泊松比 (Poisson's ratio, $\nu$)**: 衡量横向变形与轴向变形的比率。
    $$ \nu = \frac{3B - 2G}{2(3B + G)} $$

### 5.2.4 Born 稳定性判据

在报告结果前，必须检查晶格动力学稳定性。对于立方晶系，必须同时满足：
1.  $C_{11} - C_{12} > 0$
2.  $C_{11} + 2C_{12} > 0$
3.  $C_{44} > 0$

如果上述条件不满足，说明该晶体结构在力学上是不稳定的（可能会自发发生相变），此时计算出的模量没有物理意义。

---

## 附录：常见问题与进阶建议

### 1. 核心避坑指南：`calculation` 参数的生死抉择

在上一章的 INPUT 设置中，有一个最容易犯的致命错误，此处必须再次强调：

*   **正确设置**: `calculation relax`
*   **绝对禁止**: `calculation cell-relax`

**原理分析**：
*   **relax**: 仅优化原子位置，保持晶胞形状（即保持我们施加的应变）。原子移动是为了适应应变，消除内部不合理的原子间作用力。这是**正确**的。
*   **cell-relax**: 优化原子位置**和晶胞形状**。ABACUS 会发现晶胞处于“受力”状态，于是自动改变晶格常数以消除应力。结果是：所有任务最终都回到了无应变的平衡态，计算出的应力全为零（或接近零），导致 $C_{ij}$ 计算失败。

### 2. 单位换算 (Units)

ABACUS 的输出日志 (`running_scf.log`) 中，应力单位通常为 **kbar**。而文献中常用单位是 **GPa**。

*   **换算关系**: $1 \text{ GPa} = 10 \text{ kbar}$
*   **检查方法**:
    如果你的 Python 脚本输出的 $C_{11}$ 是几千甚至上万（如 3000），单位很可能是 kbar。如果是几百（如 300），单位可能是 GPa。务必检查脚本源码或输出头文件中的单位说明。

### 3. Symmetry 陷阱：剪切变形报错

在施加剪切应变（如 triclinic 变形）时，晶胞的对称性会被破坏。
*   **现象**: ABACUS 可能会在初始化阶段报错，提示对称性识别错误，或者在运行过程中强行施加不兼容的对称性操作。
*   **解决方案**: 在 `INPUT` 文件中显式关闭对称性。
    ```text
    symmetry 0  # 0=关闭, 1=开启(默认)
    ```
    *建议*：为了保证所有变形任务的一致性，在计算弹性常数时，推荐对所有 24 个任务统一设置 `symmetry 0`，虽然会略微增加计算时间，但能确保结果的数值稳定性。

### 4. 结果可靠性自检 (Quality Control)

如果你得到的模量与实验值相差巨大（>20%），请按以下顺序排查：

1.  **残余应力检查**: 回头检查未加应变的原始结构（Ground State）。其应力张量是否接近 0？
    *   标准：对角项应小于 0.1 kbar。
    *   如果原始结构就有 5 kbar 的应力，后续拟合出的 $C_{ij}$ 将完全错误。**必须提高精度重新进行 `vc-relax`（Variable Cell Relax）。**
2.  **拟合直线检查**: 绘制 Stress-Strain 曲线。如果 4 个点不在一条直线上，说明应变幅值太大，超出了线弹性范围。尝试将应变从 $\pm 0.01$ 减小到 $\pm 0.005$。
3.  **K点与截断能**: 弹性常数是能量的二阶导数，对应力/能量的收敛精度要求极高。通常需要比常规 SCF 计算更高的 `ecutwfc` 和更密的 K 点网格。