# ABACUS 实战教程：晶体弹性常数的第一性原理计算

## 前言

欢迎来到《ABACUS 实战教程：晶体弹性常数的第一性原理计算》。

作为国产密度泛函理论（DFT）软件的佼佼者，ABACUS 凭借其独特的数值原子轨道（NAO）基组与平面波（PW）基组的双重优势，在材料科学研究中展现出极高的计算效率与精度。在材料力学性质的研究中，弹性常数不仅是表征材料抵抗形变能力的核心物理量，更是评估晶体结构动力学稳定性的关键判据。本教程旨在通过手把手的教学，带你攻克这一对计算精度要求极高的任务。

### 学习路线图 (Roadmap)
本教程通过五个章节，构建了从理论到实战的完整闭环：
1.  **物理直觉校准**（第一章）：深入浅出地讲解弹性力学基础、胡克定律与 Voigt 标记法，为你打下坚实的理论基石。
2.  **起手式：结构预优化**（第二章）：强调“零应力”初始结构的重要性，并指导你完成环境配置与高通量计算准备。
3.  **核心流程：变形与分发**（第三章）：详解应力-应变法的实操，指导你如何生成标准变形构型并构建高效的批量任务流。
4.  **参数精控：INPUT 详解**（第四章）：逐行解析 ABACUS 核心计算参数，揭示决定计算成败的精度“开关”。
5.  **收官：数据拟合与分析**（第五章）：演示如何从海量日志中提取应力张量，通过线性拟合获得刚度矩阵及杨氏模量等宏观性质。

### 知识体系定位 (Knowledge Graph)
在 ABACUS/DFT 的知识版图中，弹性常数计算处于“进阶物性表征”的核心位置。它上承基础的结构优化（Relaxation）与自洽场计算（SCF），下接声子谱稳定性分析、热力学性质预测以及高通量材料筛选。掌握这一环节，意味着你已具备了进行复杂材料力学行为模拟的专业能力。

### 前置要求 (Prerequisites)
在开始学习前，我们建议你已具备以下基础：
- 了解密度泛函理论（DFT）的基本概念。
- 熟悉 Linux 命令行操作及基础的 Shell/Python 脚本编写。
- 已在计算平台上成功安装并能运行 ABACUS 软件。

---

# 第一章：弹性力学基础与计算原理

在开始编写输入文件之前，我们必须先“校准”我们的物理直觉。

很多初学者容易陷入一个误区：拿到脚本就运行，算出数字就填表。但在计算材料学中，**弹性常数（Elastic Constants）** 的计算是对软件精度和操作流程要求最为严苛的任务之一。它不仅要求极高的电子结构收敛度，还要求你对“应力”与“应变”在微观模拟中的实现方式有深刻理解。

本章我们将剥离复杂的数学推导，直击 ABACUS 计算弹性常数的核心逻辑。

---

## 1.1 广义胡克定律与 Voigt 标记法

在宏观世界，弹簧被拉长遵循 $F=k\Delta x$。在晶体材料的微观世界，这一关系被推广为**广义胡克定律**。

### 1.1.1 物理图景：从张量到矩阵
当晶体受到微小形变（应变 $\epsilon$）时，晶格内部会产生抵抗这种形变的力（应力 $\sigma$）。在弹性极限内，它们呈线性关系：

$$ \sigma_{ij} = \sum_{k,l} C_{ijkl} \epsilon_{kl} $$

这里的 $C_{ijkl}$ 就是我们要计算的**弹性刚度张量（Stiffness Tensor）**。
- **挑战**：这是一个四阶张量，包含 $3 \times 3 \times 3 \times 3 = 81$ 个分量。直接计算这 81 个数是不切实际的。
- **降维**：由于应力张量和应变张量的对称性（$\sigma_{ij}=\sigma_{ji}$），以及热力学势的存在，我们可以使用 **Voigt 标记法** 将下标简化，把四阶张量压缩为 $6 \times 6$ 的矩阵。

**Voigt 映射规则**：
$$ xx \to 1, \quad yy \to 2, \quad zz \to 3, \quad yz \to 4, \quad xz \to 5, \quad xy \to 6 $$

于是，胡克定律变成了矩阵形式（ABACUS 最终求解的目标）：

$$
\begin{bmatrix}
\sigma_{1} \\ \sigma_{2} \\ \sigma_{3} \\ \sigma_{4} \\ \sigma_{5} \\ \sigma_{6}
\end{bmatrix}
=
\begin{bmatrix}
C_{11} & C_{12} & C_{13} & C_{14} & C_{15} & C_{16} \\
C_{12} & C_{22} & C_{23} & C_{24} & C_{25} & C_{26} \\
\vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
C_{16} & C_{26} & C_{36} & C_{46} & C_{56} & C_{66}
\end{bmatrix}
\begin{bmatrix}
\epsilon_{1} \\ \epsilon_{2} \\ \epsilon_{3} \\ \epsilon_{4} \\ \epsilon_{5} \\ \epsilon_{6}
\end{bmatrix}
$$

### 1.1.2 晶体对称性的力量
虽然矩阵有 36 个分量，但大多数晶体具有对称性，这使得独立分量大大减少。
- **三斜晶系 (Triclinic)**：对称性最低，需计算 **21** 个独立分量。
- **立方晶系 (Cubic)**：对称性极高，仅需计算 **3** 个独立分量（$C_{11}, C_{12}, C_{44}$）。

> **教授提示**：ABACUS 结合 Python 脚本（如 `pymatgen` 或 `ASE`）工作时，会自动识别晶体对称性，只施加必要的应变模式。你不需要手动推导这些矩阵，但你必须知道：**对称性越高，需要的计算量越少。**

---

## 1.2 应变-应力法 (Strain-Stress Method) 工作流

在 DFT 计算中，获取弹性常数主要有两种流派：“能量-应变法”和“应力-应变法”。**ABACUS 推荐并主要采用的是“应力-应变法”**。

### 1.2.1 为什么选择“应力-应变法”？
- **能量-应变法**：对晶体施加应变，计算总能量，通过拟合能量曲线的二阶导数（曲率）求 $C_{ij}$。这需要大量的采样点来消除数值噪音。
- **应力-应变法**：利用 **Hellmann-Feynman 定理**，DFT 代码可以直接解析计算出原子受力和晶胞应力张量。我们只需施加应变，读取计算出的应力，通过线性拟合 $\sigma = C \epsilon$ 的斜率即可得到 $C_{ij}$。
    - **优势**：效率更高，对计算点数要求更少，且线性拟合通常比二次拟合更稳健。

### 1.2.2 核心工作流详解

一个标准的 ABACUS 弹性常数计算流程包含以下三个关键步骤：

#### 第一步：极高精度的前置优化 (Pre-relaxation)
这是所有步骤中最关键的一步。在施加任何应变之前，原始晶胞必须处于完美的力学平衡状态。
- **原理**：如果原始结构中存在残余应力（Residual Stress），它会作为系统误差叠加到后续的线性拟合中，导致结果严重偏离。
- **ABACUS 设置**：
    - `calculation`: `cell-relax` (同时优化原子位置和晶胞形状)。
    - 收敛标准：必须比常规计算更严格。建议力收敛标准设为 $10^{-3}$ eV/Å 量级，应力收敛标准设为 0.1 kbar 以下。

#### 第二步：施加应变与构型生成 (Deformation)
这一步通常由辅助脚本（如 `gene_dfm.py`）完成。脚本会根据晶体对称性生成一系列变形后的结构文件（`STRU`）。
- **“24种构型”的由来**：
    为了保证结果的统计学可靠性，通常采用：
    $$ 6 \text{ (独立应变模式)} \times 4 \text{ (应变幅值)} = 24 \text{ 个计算任务} $$
    应变幅值通常取微小量，如 $\pm 0.01$ (1%) 和 $\pm 0.005$ (0.5%)，以确保处于线性弹性区间。

#### 第三步：固定晶胞的原子弛豫 (Internal Relaxation)
**这是新手最容易出错的地方！**
我们将变形后的 `STRU` 文件输入 ABACUS 进行计算。此时，晶格矢量（Lattice Vectors）已经被人为拉伸或剪切，我们需要计算在这个固定形变下，原子重新向平衡位置移动后的应力。

- **Critical Configuration (核心配置)**:
    在 `INPUT` 文件中，必须设置：
    ```bash
    calculation  relax   # 仅优化原子位置，固定晶胞形状
    cal_stress   1       # 开启应力张量计算
    cal_force    1       # 开启原子受力计算
    ```

> **⚠️ 致命错误警示**：
> 绝对**不要**在这一步将 `calculation` 设为 `cell-relax`！
> 如果你设为 `cell-relax`，ABACUS 会认为你施加的应变是不稳定的，会自动把晶胞优化回原来的平衡形状（应变被释放），导致你计算的应力全部归零或无意义。

### 1.2.3 风险提示与锦囊妙计

在实战中，你可能会遇到以下棘手情况，请提前记录：

1.  **剪切不稳定性与 Symmetry 设置**：
    当施加剪切应变（如 $\epsilon_{xy}$）时，晶体的对称性会被破坏。有时 ABACUS 的对称性分析功能可能会因为数值精度问题报错，或者强制施加了错误的对称性约束。
    - **解决方案**：如果在计算剪切变形结构时遇到报错或结果诡异，请在 `INPUT` 中显式添加：
      ```bash
      symmetry  0  # 关闭对称性分析，直接计算
      ```

2.  **单位陷阱**：
    ABACUS 的输出文件中，应力单位通常是 **kbar**。而发表文章时常用的弹性常数单位是 **GPa**。
    - **换算关系**：$1 \text{ kbar} = 0.1 \text{ GPa}$。
    - **注意**：通常配套的 Python 后处理脚本（如 `compute_dfm.py`）会自动处理这个转换，但你必须检查脚本的输出日志确认单位，切勿张冠李戴。

---

**本章总结**：
我们确立了通过计算应力张量反推弹性常数的物理路径。最核心的操作原则是：**先做完美的 `cell-relax`，再做固定的 `relax`**。

下一章，我们将进入实战环节，手把手教你准备输入文件并运行计算。

# 第二章：计算准备与结构预优化

> **本章核心逻辑**：弹性常数（Elastic Constants）是能量对晶格应变的二阶导数，或者是应力对应变的一阶导数。这意味着它们对应力状态极其敏感。如果你的初始结构中存在微小的“残余应力”（Residual Stress），它们将在后续的拟合过程中被错误地放大为材料的弹性响应。因此，**完美的零应力初始结构**是计算弹性常数的绝对前提。

---

## Section 2.1: 辅助工具与环境配置

弹性常数的计算本质上是一个“高通量”任务。为了获得完整的刚度矩阵，我们需要对晶胞施加多组不同的微小形变，并计算每种形变下的能量或应力响应。手动修改 `STRU` 文件不仅效率低下，而且极易出错。

在本教程中，我们将采用 **Python 脚本自动化工作流**。

### 2.1.1 外部依赖库：pymatgen
我们需要依赖 `pymatgen` (Python Materials Genomics) 库来处理晶体结构的张量变换。它能精确地将数学上的应变矩阵应用到 ABACUS 的 `STRU` 文件中。

**安装命令**：
```bash
pip install pymatgen numpy
```

### 2.1.2 配套脚本体系
为了实现自动化，我们通常构建以下三个核心脚本（在后续章节的实战演练中会提供具体代码，此处先明确其功能定位）：

1.  **生成器 (`gene_dfm.py`)**：
    *   **功能**：读取优化后的 `STRU`，施加应变。
    *   **工作原理（锦囊妙计）**：为了保证拟合精度，我们通常采用“**6x4 策略**”，即生成 **24种构型**。
        *   **6种应变模式**：对应各向异性材料的6个独立应变分量 ($\varepsilon_{xx}, \varepsilon_{yy}, \varepsilon_{zz}, \varepsilon_{yz}, \varepsilon_{xz}, \varepsilon_{xy}$)。
        *   **4种应变幅值**：通常取 $\pm 0.01$ (1%) 和 $\pm 0.005$ (0.5%)。这既保证了处于线性弹性区间，又避免了数值噪声的影响。
2.  **执行器 (`run_task.sh`)**：
    *   **功能**：批量提交 ABACUS 计算任务，管理文件夹结构。
3.  **分析器 (`compute_dfm.py`)**：
    *   **功能**：提取 DFT 计算得到的能量（Energy）和应力（Stress），进行多项式拟合求解弹性常数矩阵。
    *   **单位警示**：ABACUS 输出的应力单位通常为 **kBar**，而文献中弹性常数常用 **GPa**。该脚本必须包含自动单位转换逻辑 ($1 \text{ GPa} = 10 \text{ kBar}$)。

---

## Section 2.2: 初始结构的零应力优化

这是新手最容易“翻车”的环节。在施加任何人为应变之前，你手中的原始结构（无论是从 Materials Project 下载，还是实验测得）通常都包含非零的内部应力。

**目标**：获得一个处于势能面极小值、且晶胞应力张量近乎为零的基态结构。

### 2.2.1 关键 INPUT 参数设置
此步骤必须进行**变胞优化**。请创建一个专门的文件夹（如 `00_pre_relax`）进行此步计算。

**`INPUT` 文件示例**：
```bash
INPUT_PARAMETERS
# --- 基础设置 ---
suffix          Si_pre_relax
ntype           1
basis_type      pw              # 推荐使用平面波(pw)以获得更精确的应力张量，lcao亦可但需测试
ecutwfc         80              # 【关键】计算应力时，截断能通常需要比仅计算能量时更高

# --- 核心优化参数 ---
calculation     cell-relax      # 【关键】变胞优化：同时优化原子位置和晶格矢量
relax_nmax      100             # 最大离子步数
cal_stress      1               # 【必须】显式开启应力计算
cal_force       1               # 计算原子力

# --- 收敛标准（极高精度） ---
scf_thr         1.0e-8          # 电子步收敛标准
force_thr_ev    1.0e-4          # 力收敛标准 (eV/Ang)，建议比常规优化严一个数量级
stress_thr      0.1             # 【关键】应力收敛标准 (kBar)。0.1 kBar 意味着残余应力极小

# --- 其他 ---
out_stru        1               # 输出优化后的结构文件
```

### 2.2.2 教授的“避坑”指南

#### 1. 收敛精度的重要性
普通的结构优化可能只需要 `force_thr_ev 0.01` 和 `stress_thr 10`。但这对于弹性常数计算是**完全不够的**。
*   **原理**：弹性常数计算依赖于应力对应变的微小响应。如果背景噪音（残余应力）是 5 kBar，而施加 1% 应变产生的物理应力只有 20 kBar，你的信噪比将极低，导致结果完全不可信。
*   **建议**：务必将 `stress_thr` 压低至 **0.1 kBar** 或更低。

#### 2. ecutwfc (截断能) 的选择
*   **现象**：你可能会发现应力很难收敛，或者对应力结果不敏感。
*   **原因**：根据 Pulay Stress 原理，平面波基组计算应力时对截断能非常敏感。
*   **对策**：在计算弹性常数前，建议进行 `ecutwfc` 收敛性测试。通常使用的截断能应比赝势建议值高出 **30%~50%**。

#### 3. 对称性的陷阱 (Risk Warning)
在预优化阶段，ABACUS 默认开启对称性分析 (`symmetry 1`) 以加速计算，这通常没问题。
*   **风险提示**：在后续施加**剪切应变**（Shear Strain，如 $\varepsilon_{xy}$）时，晶格对称性会被破坏。如果后续计算报错或结果异常，请尝试在 INPUT 中显式设置 `symmetry 0` 以关闭对称性分析。但在本节的 `cell-relax` 阶段，保持默认即可。

### 2.2.3 结果检查与下一步
计算结束后，检查输出文件（通常在 `OUT.suffix/` 目录下）。
1.  **查看收敛情况**：确认任务正常结束，且最后一步的 Stress 和 Force 均低于阈值。
2.  **获取新结构**：找到 `STRU_ION_D`（优化后的结构文件）。
3.  **重命名**：将其复制并重命名为 `STRU_0`，这将是后续所有形变任务的**唯一种子结构**。

---

### 🔥 核心强调：计算类型的生死红线

在结束本章前，我必须强调一个在后续章节（批量计算）中**绝对不能犯**的错误，请现在就刻在脑子里：

| 计算阶段 | 任务目标 | INPUT 参数 `calculation` | 物理含义 |
| :--- | :--- | :--- | :--- |
| **本章阶段** | 消除残余应力 | **`cell-relax`** | **变胞优化**：晶格常数和原子位置**都**可以动。 |
| **下一章阶段** | 计算应变响应 | **`relax`** | **定胞优化**：**锁死晶格**（保持施加的应变），仅优化原子位置。 |

> **警告**：如果在下一章施加应变后，你错误地将 `calculation` 设为了 `cell-relax`，ABACUS 会认为施加的应变是“不稳定的高能状态”，并自动把晶格优化回本章得到的零应力平衡态。
> **结果**：你算出的所有应力都接近于零，弹性常数计算彻底失败。

---

**下一章中**：我们将使用 `pymatgen` 脚本基于 `STRU_0` 生成 24 个形变结构，并编写 Shell 脚本批量提交计算任务。

# 第三章：变形结构生成与任务分发

上一章我们完成了弹性常数计算的理论准备和环境配置。从本章开始，我们将进入核心实战环节。

计算弹性常数的本质，是观测晶体在受到微小形变（Strain）时，其能量或应力（Stress）的响应。为了获得完整的刚度矩阵，我们需要人为地构造一系列“变形晶胞”，算出它们的应力状态，最后通过拟合得到弹性常数。

本章将指导你如何生成这套标准的变形结构，并设计高效的批量计算工作流。

---

## 3.1 变形构型生成 (Pre-processing)

在 ABACUS 的弹性常数计算工作流中，我们通常采用 **“应力-应变法”（Stress-Strain Method）**。这要求我们对晶胞施加特定的拉伸或剪切应变，并计算对应的柯西应力（Cauchy Stress）。

### 3.1.1 核心逻辑：为什么是 24 种构型？

在自动化脚本（如 `gene_dfm.py`）的背后，遵循着一套严格的物理逻辑。为了求解完整的弹性张量，我们通常会生成 **24 个变形结构**。这个数字并非随机选择，而是基于以下考量：

1.  **6 种独立应变模式**：
    根据 Voigt 记号，三维晶体的应变张量有 6 个独立分量（$\varepsilon_{xx}, \varepsilon_{yy}, \varepsilon_{zz}, \varepsilon_{yz}, \varepsilon_{xz}, \varepsilon_{xy}$）。为了解出刚度矩阵的所有分量，我们需要分别激活这 6 种变形模式。

2.  **4 种应变幅值（Amplitudes）**：
    对于每种变形模式，我们通常取 4 个不同的应变点，例如：
    $$ \delta = \{ +0.01, -0.01, +0.005, -0.005 \} $$
    即 $\pm 1\%$ 和 $\pm 0.5\%$ 的形变。

    > **教授视点 (Professor's Insight)**：
    > **为什么要取 4 个点而不是 1 个点？**
    > 理论上，胡克定律（$ \sigma = C \varepsilon $）是线性的，一个点似乎就够了。但在 DFT 计算中，我们需要验证结果是否处于“线性响应区”。通过 4 个点进行线性拟合，可以有效消除数值噪声，并检测是否意外进入了非线性区（Anharmonicity）。

### 3.1.2 使用脚本生成结构

假设你已经有了一个经过**极高精度弛豫**的原始结构文件 `STRU_original`。我们将使用 Python 脚本（这里以通用的 `gene_dfm.py` 为例）来生成变形结构。

脚本的核心操作是将应变矩阵 $\boldsymbol{\varepsilon}$ 作用于原始晶格矢量 $\mathbf{R}$：
$$ \mathbf{R}' = \mathbf{R} (\mathbf{I} + \boldsymbol{\varepsilon}) $$

执行生成命令通常如下（示意）：
```bash
python gene_dfm.py --input STRU_original --max_strain 0.01 --points 4
```

执行后，你将获得如下目录结构：

```text
/work_dir/
├── STRU_original
├── gene_dfm.py
└── relax/                  <-- 生成的任务目录
    ├── 00_strain_mode1_p0.01/
    │   └── STRU            <-- 施加了 +1% xx应变的结构
    ├── 01_strain_mode1_m0.01/
    │   └── STRU            <-- 施加了 -1% xx应变的结构
    ├── ...
    └── 23_strain_mode6_m0.005/
        └── STRU
```

### 3.1.3 关键权衡：应变幅值的选择

在生成结构时，最大应变幅值（Maximum Strain Amplitude）的选择是一门艺术：

*   **太小（< 0.001）**：DFT 计算存在数值噪声（Numerical Noise）。如果应变引起的能量/应力变化小于计算误差，结果将完全不可信。
*   **太大（> 0.02）**：晶体将超出胡克定律的线性弹性区，高阶非线性项（三阶弹性常数）开始占主导，导致拟合出的二阶弹性常数不准确。
*   **推荐值**：对于大多数硬度正常的无机晶体，**0.005 (0.5%) 到 0.01 (1.0%)** 是最佳的“甜点区”。对于极软材料（如范德华晶体），可能需要适当增大；对于极硬材料，可适当减小。

---

## 3.2 批量任务管理与 INPUT 设置

结构生成后，我们需要为这 24 个任务准备 `INPUT` 文件并提交计算。

### 3.2.1 目录结构设计

为了便于后期数据处理，建议保持整洁的目录结构。一个标准的实战目录如下：

```text
elastic_calc/
├── 1_generation/
│   ├── STRU_original
│   └── gene_dfm.py
├── 2_running/          <-- 所有的计算在这里运行
│   ├── run_task.sh     <-- 批量提交脚本
│   ├── INPUT_template  <-- INPUT 模板文件
│   ├── KPT             <-- K点文件（所有任务共用）
│   ├── pseudo/         <-- 赝势目录
│   ├── task_00/
│   ├── task_01/
│   └── ...
└── 3_postprocessing/
```

### 3.2.2 核心配置文件：INPUT (Critical)

这是本章**最关键**的部分。在计算变形结构的应力时，`INPUT` 文件的设置有极高的排他性要求。

以下是一个标准的 `INPUT` 模板：

```bash
INPUT_PARAMETERS
# 1. 核心计算参数
suffix              elastic_task
calculation         relax       # <--- 极其重要！！见下文解释
cal_stress          1           # <--- 必须开启，否则无法计算应力张量

# 2. 精度控制 (必须与原始结构优化时保持一致或更高)
ecutwfc             80          # 推荐：根据赝势建议值设置
scf_thr             1.0e-8      # 电子自洽收敛精度
force_thr_ev        0.001       # 离子弛豫力的收敛精度

# 3. 涂抹与基组
smearing_method     gauss
smearing_sigma      0.05
basis_type          lcao        # 或 pw

# 4. 对称性设置 (风险控制)
symmetry            0           # <--- 建议关闭，见下文“风险提示”
```

#### 🚨 核心强调：calculation 参数
**绝对禁止**将 `calculation` 设置为 `cell-relax`。

*   **错误做法 (`cell-relax`)**：ABACUS 会优化晶胞矢量。这意味着程序会发现你施加的应变增加了系统能量，于是它会通过优化晶胞把应变“释放”掉，让晶格回到未变形的平衡态。结果：你计算的是平衡态的应力（接近0），得不到弹性常数。
*   **正确做法 (`relax`)**：固定晶胞形状（Fixed Cell），只优化原子位置（Relax Atoms）。这允许原子在变形后的晶胞内寻找新的平衡位置（Internal Relaxation），这是计算“内弹性常数”所必需的，同时保持了我们施加的外部应变。

### 3.2.3 批量提交脚本 (`run_task.sh`)

不要手动去 24 个文件夹里提交任务。编写一个简单的 Shell 脚本来分发任务。

```bash
#!/bin/bash

# 定义 ABACUS 可执行程序路径
ABACUS_EXEC="mpirun -np 32 abacus"
CURRENT_DIR=$(pwd)

# 循环遍历所有任务目录
for task_dir in task_*; do
    if [ -d "$task_dir" ]; then
        cd "$task_dir"
        echo "Processing $task_dir ..."

        # 1. 准备文件 (如果生成脚本未处理，需在此处复制)
        # cp ../INPUT_template INPUT
        # cp ../KPT KPT
        # ln -sf ../pseudo .

        # 2. 提交任务
        # 注意：实际生产环境中，这里通常是 sbatch submit.slurm
        # 下面是直接运行的示例：
        $ABACUS_EXEC > output.log 2>&1
        
        # 3. 简单检查是否正常结束
        if grep -q "Job is finished" output.log; then
            echo "  -> Done."
        else
            echo "  -> FAILED!"
        fi

        cd "$CURRENT_DIR"
    fi
done
```

---

## 3.3 专家锦囊与避坑指南

作为一名资深开发者，在此特别提醒几个容易导致全盘返工的细节：

### 1. 前置优化的精度陷阱
在执行 `gene_dfm.py` 之前，你的 `STRU_original` 必须处于**完美的零应力状态**。
*   **要求**：剩余应力（Residual Stress）应小于 0.1 kbar（甚至更低）。
*   **后果**：如果原始结构带有 2 kbar 的剩余应力，这个背景噪声会直接叠加到所有变形结构中，导致最终拟合的弹性常数出现严重偏差（尤其是 $C_{11}, C_{22}$ 等对角项）。

### 2. 对称性破缺的风险 (`symmetry 0`)
当对高对称性晶体（如立方晶系）施加剪切应变（如 $\varepsilon_{xy}$）时，晶体的对称性会显著降低（变成三斜晶系）。
*   **现象**：有时 ABACUS 的对称性分析模块在处理这些轻微变形的低对称结构时，可能会因为容差（tolerance）问题报错，或者强制施加了错误的对称性约束。
*   **对策**：为了安全起见，建议在计算变形结构时，在 `INPUT` 中显式设置 **`symmetry 0`**（关闭对称性分析）。虽然这会略微增加计算量（不再利用不可约 k 点），但能确保物理结果的绝对正确性。

### 3. 单位与后处理
ABACUS 的输出文件（如 `OUT.${suffix}/running_cell-relax.log` 或 `running_relax.log`）中，应力单位通常是 **Ry/Bohr³** 或 **kbar**（取决于版本和设置）。
*   **提示**：虽然本章只涉及计算，但请留意，最终的 Python 后处理脚本需要正确识别这些单位并转换为 **GPa**。通常脚本会自动处理，但如果你手动提取数据，请务必检查单位换算：
    $$ 1 \text{ Ry/Bohr}^3 \approx 14710.5 \text{ GPa} $$
    $$ 1 \text{ kbar} = 0.1 \text{ GPa} $$

---
**下一章**：
计算任务完成后，我们将进入第四章《数据提取与弹性张量拟合》，届时我们将学习如何从这 24 个复杂的输出文件中提取应力数据，并利用最小二乘法解出刚度矩阵。

# 第四章：ABACUS 核心计算参数详解

在上一章我们搭建了计算环境，现在我们将进入最核心的技术环节——**编写 INPUT 文件**。

计算弹性常数（Elastic Constants）是对 DFT 软件精度和参数设置的“试金石”。它本质上是在计算能量或应力对晶格形变的二阶响应。任何微小的参数设置不当（如应力未收敛、晶胞意外变形、基组精度不足）都会被放大，导致结果完全不可用。

本章我将带你逐行解析 `INPUT` 文件，特别是那些决定成败的“隐形开关”。

---

在弹性常数计算的工作流中，我们实际上涉及两个截然不同的计算阶段，它们的 `INPUT` 设置逻辑完全相反：
1.  **零应力基态优化（Pre-optimization）**：确保初始结构处于完美的力学平衡态。
2.  **变形结构响应计算（Deformation & Response）**：对施加了微小应变的结构进行电子步和离子步弛豫，提取应力张量。

本章重点讲解**第二阶段**（变形结构）的参数设置，这是最容易出错的地方。

## 4.1 离子弛豫与应力计算设置 (The Golden Rules)

这是本教程最重要的部分。如果你记不住所有参数，请至少记住下面这条**铁律**：

> **核心警示 (Critical Warning)**
>
> 在计算施加了应变（Strain）的结构时，`calculation` 参数必须设置为 `relax`，**绝对不能**设置为 `cell-relax`。

### 4.1.1 为什么不能用 `cell-relax`？
*   **`cell-relax` (变胞弛豫)**：允许晶格矢量（Lattice Vectors）和原子位置同时变化，目标是消除晶胞上的应力。如果你对一个施加了 +1% 应变的晶胞使用 `cell-relax`，ABACUS 会认为这个应力是“不稳定的”，并自动把晶胞优化回原本的无应变状态。结果是：应变被释放，应力归零，你算了个寂寞。
*   **`relax` (定胞弛豫)**：固定晶格矢量（保持我们施加的 $\pm 0.01$ 应变），仅移动原子位置以消除内部原子受力（Internal atomic force）。这才是我们需要的——**在固定形变下的平衡应力响应**。

### 4.1.2 关键参数详解

以下是一个标准的用于弹性常数计算的 `INPUT` 核心模块：

```bash
INPUT_PARAMETERS
# --- 任务类型与弛豫策略 ---
calculation     relax       # 关键！固定晶胞，仅优化原子位置
cal_force       1           # 开启力计算，用于指导原子移动
cal_stress      1           # 关键！开启应力张量计算，这是弹性常数的来源

# --- 离子步收敛标准 ---
force_thr_ev    0.001       # 力的收敛阈值 (eV/Ang)，建议比常规优化更严
esolver_type    kg          # (可选) 某些体系下 kg 求解器效率较高，默认 cg 亦可
```

*   **`cal_stress`**: 必须设为 `1`。虽然 `relax` 任务主要看力，但我们需要输出 `TOTAL-STRESS` 张量来拟合胡克定律。
*   **`force_thr_ev`**: 弹性常数计算对残余力非常敏感。如果原子没有弛豫到真正的受力平衡位置，内部应力会污染宏观应力张量。建议设置为 `0.001` 甚至 `0.0005`。

---

## 4.2 精度控制与电子结构参数

弹性常数是“硬”性质，对基组截断能（Cutoff）和 K 点密度的收敛要求远高于简单的能量计算。

### 4.2.1 能量截断与基组 (Basis Set)
对于平面波（PW）或 LCAO 基组，截断能必须足够高以消除“普尔艾应力”（Pulay Stress）。

```bash
# --- 电子结构精度 ---
ecutwfc         80          # (Ry) 平面波截断能。
                            # 经验法则：比赝势建议值高 20-30% 以上。
                            # 必须通过收敛性测试确定！
```

### 4.2.2 展宽与混合 (Smearing & Mixing)
对于金属体系或小带隙半导体，Smearing 的选择至关重要。

```bash
# --- 电子步迭代设置 ---
scf_thr         1.0e-8      # (Ry) 自洽收敛阈值。弹性计算需高精度，推荐 1e-8
mixing_type     broyden     # 电荷密度混合方法，Broyden 通常最稳健

# --- Smearing 设置 (针对金属/窄带隙) ---
smearing_method gaussian    # 推荐 Gaussian 或 mp (Methfessel-Paxton)
smearing_sigma  0.002       # (Ry) 展宽宽度。
```

*   **教授建议**:
    *   **绝缘体**: 可以不设置 `smearing_method` (默认为 fixed)，或者使用极小的 sigma。
    *   **金属**: 推荐使用 `gaussian`。注意 `smearing_sigma` 的单位是 Rydberg。`0.002 Ry` (约 27 meV) 是一个比较安全的起点，既能辅助收敛，又不会引入过多的电子熵误差。如果体系极难收敛，可适当增大至 `0.01`，但需验证结果对 sigma 的依赖性。

### 4.2.3 对称性设置 (Symmetry)

这是一个高级且充满风险的参数。

```bash
# --- 对称性 ---
symmetry        1           # 默认值。通常保持开启。
# symmetry      0           # 风险提示：见下文
```

**风险提示**:
当我们对晶胞施加剪切应变（如 triclinic 变形）时，体系的对称性会显著降低。
*   通常 ABACUS 能自动识别降级后的对称性。
*   **Debug 技巧**: 如果你发现计算在某些特定的剪切变形下报错，或者弛豫后的原子结构非常奇怪，请尝试在 `INPUT` 中显式设置 `symmetry 0`（关闭对称性分析）。这会增加计算量（不再利用不可约 K 点），但能保证物理上的正确性，防止软件强行施加错误的对称性约束。

---

## 4.3 完整工作流与实战锦囊 (Workflow Tips)

为了让你对整个流程胸有成竹，我们梳理一下从准备到分析的全貌。

### 4.3.1 第一步：零应力基态优化 (The Pre-requisite)
在进行任何变形之前，你必须拥有一个完美的、无应力的原始结构。
*   **INPUT 设置**: `calculation cell-relax`, `cal_stress 1`.
*   **标准**: `stress_thr` (应力阈值) 应低于 0.5 kbar (甚至 0.1 kbar)。
*   **后果**: 如果原始结构即使有 5 kbar 的残余应力，计算出的弹性常数也会出现显著误差（尤其是 $C_{11}$ 和 $C_{12}$）。

### 4.3.2 第二步：生成 24 种构型
为什么是 24 种？
*   **6 种独立应变模式**: 对应 Voigt 记号下的 $\epsilon_{1} \dots \epsilon_{6}$ (即 xx, yy, zz, yz, xz, xy)。
*   **4 种应变大小**: 为了进行线性拟合，通常对每种模式施加 $\pm \delta_1$ 和 $\pm \delta_2$ 的应变。
    *   推荐值：$\pm 0.005$ (0.5%) 和 $\pm 0.01$ (1.0%)。
    *   应变过大（>2%）可能超出弹性线性响应区；应变过小（<0.1%）则会被 DFT 的数值噪声淹没。

### 4.3.3 第三步：批量计算与单位换算
当你运行完所有 `relax` 任务后，你需要提取 `OUT.${suffix}/running_relax.log` 或 `OUT.${suffix}/AM_STRESS` 中的应力数据。

*   **ABACUS 输出单位**: **kbar** (千巴)。
*   **文献常用单位**: **GPa** (吉帕)。
*   **换算关系**: $1 \text{ GPa} = 10 \text{ kbar}$。

> **脚本提示**: 大多数自动处理脚本（如基于 ASE 或 pymatgen 的脚本）会自动读取 ABACUS 输出并进行单位转换，但作为研究者，请务必在拿到最终数据时，人肉检查一下数量级是否合理（例如金刚石的 $C_{11}$ 约为 1000 GPa，铝约为 100 GPa）。

---

## 本章小结：INPUT 文件速查表

针对弹性常数计算的变形结构，请核对你的 `INPUT` 文件是否符合以下规范：

| 参数名 | 推荐值 | 物理意义 | 备注 |
| :--- | :--- | :--- | :--- |
| `calculation` | **`relax`** | 仅优化原子位置 | **切勿使用 cell-relax** |
| `cal_stress` | `1` | 计算应力张量 | 必须开启 |
| `cal_force` | `1` | 计算原子受力 | `relax` 必须开启 |
| `ecutwfc` | (High) | 波函数截断能 | 需严格测试收敛性 |
| `scf_thr` | `1.0e-8` | 电子自洽精度 | 需高精度 |
| `force_thr_ev`| `0.001` | 离子力收敛精度 | 越小越好，防止内部应力残留 |
| `symmetry` | `1` (或 `0`) | 晶体对称性 | 遇剪切变形报错时设为 0 |

下一章，我们将编写 Python 脚本来自动化生成这 24 个变形结构，并批量生成作业文件，正式开启“大规模”计算。

# 第五章：数据拟合与性质分析

在前一章中，我们通过高通量流程成功提交了 24 个独立的计算任务。现在，面对生成的 24 个 `OUT` 文件夹，我们的目标是从海量的日志文件中提取应力张量（Stress Tensor），并通过线性拟合求解出材料的刚度矩阵（Stiffness Matrix, $C_{ij}$），最终推导出杨氏模量、剪切模量等宏观力学性质。

本章将带你完成从“原始数据”到“物理结论”的关键一步。

---

## 5.1 应力提取与线性拟合

弹性常数的计算基于胡克定律（Hooke's Law）的线性近似：
$$ \sigma_i = \sum_{j=1}^{6} C_{ij} \epsilon_j $$
其中 $\sigma_i$ 是应力，$\epsilon_j$ 是我们在上一章施加的微小应变。

### 5.1.1 理解数据集：为什么是 24 个任务？

在处理数据前，必须理解数据的物理来源。为了求解完整的 $C_{ij}$ 矩阵，我们通常采用以下策略：
*   **6 种独立应变模式**：分别对应晶胞的拉伸（xx, yy, zz）和剪切（yz, xz, xy）变形。
*   **4 种应变幅值**：为了验证线性和消除奇函数高阶项误差，通常对每种模式施加 $\pm \delta$ 和 $\pm 2\delta$ 的应变（例如 $\pm 0.005, \pm 0.01$）。
*   **总量**：$6 \times 4 = 24$ 个构型。

### 5.1.2 使用 Python 脚本提取数据

我们使用社区常用的后处理脚本 `compute_dfm.py`（假设脚本名，实际操作中可能是 `elastic_post.py` 或用户自写脚本）来自动化这一过程。该脚本的核心逻辑是读取每个任务目录下 `OUT.*/running_scf.log` 中的应力数据。

**操作示例**：
```bash
# 在包含 001/, 002/ ... 024/ 任务文件夹的根目录下运行
python3 compute_dfm.py --path ./ --strain 0.005
```

**脚本输出解读**：
脚本运行后，通常会输出每个分支的拟合详情。请重点关注以下 Log 信息：

```text
Processing strain mode 1 (xx deformation)...
  Strain points: [-0.01, -0.005, 0.005, 0.01]
  Stress (kbar): [-15.2, -7.6, 7.7, 15.3]
  Linear fit R-squared: 0.9998  <-- 关键指标！
  Slope (C11 estimate): 1530.5 kbar
...
```

### 5.1.3 拟合优度自检 (R-squared)

**R-squared ($R^2$)** 是判断计算是否成功的“金标准”：
*   **$R^2 > 0.999$**：完美。应变处于弹性线性区，计算精度极高。
*   **$0.99 < R^2 < 0.999$**：可接受。可能存在轻微的数值噪声或应变稍大。
*   **$R^2 < 0.95$**：**警报**。数据不可用。原因通常是：
    1.  应变幅值过大（如 > 0.02），进入了非线性（塑性）区域。
    2.  基态结构优化不彻底（存在残余应力）。
    3.  电子步未收敛（检查 `scf_thr`）。

---

## 5.2 宏观力学性质计算

得到刚度矩阵 $C_{ij}$ 后，我们利用 Voigt-Reuss-Hill (VRH) 近似来计算多晶材料的平均力学性质。

### 5.2.1 刚度矩阵 $C_{ij}$ 与 柔度矩阵 $S_{ij}$

脚本首先会输出 $6 \times 6$ 的 $C_{ij}$ 矩阵（单位通常为 GPa 或 kbar）。
$$ [C] = \begin{pmatrix} C_{11} & C_{12} & \cdots \\ C_{12} & C_{22} & \cdots \\ \vdots & \vdots & \ddots \end{pmatrix} $$
同时，脚本会计算其逆矩阵 $S = C^{-1}$，即柔度矩阵。

### 5.2.2 VRH 近似计算

晶体材料通常具有各向异性，而工程上常用的多晶材料是各向同性的。我们使用以下三种模型进行平均：

1.  **Voigt 界限 ($M_V$)**：假设多晶各晶粒**应变**相同（上限）。
    *   $B_V = \frac{1}{9}(C_{11} + C_{22} + C_{33} + 2(C_{12} + C_{13} + C_{23}))$
    *   $G_V = \frac{1}{15}(C_{11} + C_{22} + C_{33} - (C_{12} + C_{13} + C_{23}) + 3(C_{44} + C_{55} + C_{66}))$
2.  **Reuss 界限 ($M_R$)**：假设多晶各晶粒**应力**相同（下限，使用 $S_{ij}$ 计算）。
    *   $B_R = [(S_{11} + S_{22} + S_{33}) + 2(S_{12} + S_{13} + S_{23})]^{-1}$
    *   $G_R = 15 [4(S_{11} + S_{22} + S_{33}) - 4(S_{12} + S_{13} + S_{23}) + 3(S_{44} + S_{55} + S_{66})]^{-1}$
3.  **Hill 平均 ($M_H$)**：Voigt 和 Reuss 的算术平均值，最接近实验值。
    *   $B_H = \frac{B_V + B_R}{2}$
    *   $G_H = \frac{G_V + G_R}{2}$

### 5.2.3 最终物理量导出

基于 Hill 平均的体积模量 $B$ 和剪切模量 $G$，我们可以计算：

*   **杨氏模量 (Young's Modulus, $E$)**: 衡量材料抵抗拉伸变形的能力。
    $$ E = \frac{9BG}{3B + G} $$
*   **泊松比 (Poisson's ratio, $\nu$)**: 衡量横向变形与轴向变形的比率。
    $$ \nu = \frac{3B - 2G}{2(3B + G)} $$

### 5.2.4 Born 稳定性判据

在报告结果前，必须检查晶格动力学稳定性。对于立方晶系，必须同时满足：
1.  $C_{11} - C_{12} > 0$
2.  $C_{11} + 2C_{12} > 0$
3.  $C_{44} > 0$

如果上述条件不满足，说明该晶体结构在力学上是不稳定的（可能会自发发生相变），此时计算出的模量没有物理意义。

---

## 附录：常见问题与进阶建议

### 1. 核心避坑指南：`calculation` 参数的生死抉择

在上一章的 INPUT 设置中，有一个最容易犯的致命错误，此处必须再次强调：

*   **正确设置**: `calculation relax`
*   **绝对禁止**: `calculation cell-relax`

**原理分析**：
*   **relax**: 仅优化原子位置，保持晶胞形状（即保持我们施加的应变）。原子移动是为了适应应变，消除内部不合理的原子间作用力。这是**正确**的。
*   **cell-relax**: 优化原子位置**和晶胞形状**。ABACUS 会发现晶胞处于“受力”状态，于是自动改变晶格常数以消除应力。结果是：所有任务最终都回到了无应变的平衡态，计算出的应力全为零（或接近零），导致 $C_{ij}$ 计算失败。

### 2. 单位换算 (Units)

ABACUS 的输出日志 (`running_scf.log`) 中，应力单位通常为 **kbar**。而文献中常用单位是 **GPa**。

*   **换算关系**: $1 \text{ GPa} = 10 \text{ kbar}$
*   **检查方法**:
    如果你的 Python 脚本输出的 $C_{11}$ 是几千甚至上万（如 3000），单位很可能是 kbar。如果是几百（如 300），单位可能是 GPa。务必检查脚本源码或输出头文件中的单位说明。

### 3. Symmetry 陷阱：剪切变形报错

在施加剪切应变（如 triclinic 变形）时，晶胞的对称性会被破坏。
*   **现象**: ABACUS 可能会在初始化阶段报错，提示对称性识别错误，或者在运行过程中强行施加不兼容的对称性操作。
*   **解决方案**: 在 `INPUT` 文件中显式关闭对称性。
    ```text
    symmetry 0  # 0=关闭, 1=开启(默认)
    ```
    *建议*：为了保证所有变形任务的一致性，在计算弹性常数时，推荐对所有 24 个任务统一设置 `symmetry 0`，虽然会略微增加计算时间，但能确保结果的数值稳定性。

### 4. 结果可靠性自检 (Quality Control)

如果你得到的模量与实验值相差巨大（>20%），请按以下顺序排查：

1.  **残余应力检查**: 回头检查未加应变的原始结构（Ground State）。其应力张量是否接近 0？
    *   标准：对角项应小于 0.1 kbar。
    *   如果原始结构就有 5 kbar 的应力，后续拟合出的 $C_{ij}$ 将完全错误。**必须提高精度重新进行 `vc-relax`（Variable Cell Relax）。**
2.  **拟合直线检查**: 绘制 Stress-Strain 曲线。如果 4 个点不在一条直线上，说明应变幅值太大，超出了线弹性范围。尝试将应变从 $\pm 0.01$ 减小到 $\pm 0.005$。
3.  **K点与截断能**: 弹性常数是能量的二阶导数，对应力/能量的收敛精度要求极高。通常需要比常规 SCF 计算更高的 `ecutwfc` 和更密的 K 点网格。

---

## 附录：进阶学习指南

完成本教程的练习只是你探索材料力学世界的第一步。为了进一步提升研究深度，我们建议你在以下方向继续深造：

### 1. 扩展阅读与进阶主题
- **Born 稳定性准则**：弹性常数不仅能告诉我们材料有多硬，还能判断结构是否稳定。建议深入研究不同晶系对应的 Born 稳定性判据，用于新材料的预测与筛选。
- **非线性弹性与三阶弹性常数**：当形变超出线性范围时，需要引入更高阶的弹性常数。这对于研究材料在极端压力下的行为至关重要。
- **温度效应**：本教程基于 0K 下的 DFT 计算。若要研究有限温度下的弹性模量，可关注准谐振近似（QHA）或从头算分子动力学（AIMD）方法。
- **自动化工作流**：探索利用 `pymatgen` 或 `DP-GEN` 等工具与 ABACUS 对接，实现数千种材料弹性常数的自动化高通量计算。

### 2. 通用调试建议 (Troubleshooting)
- **收敛性检查**：如果拟合出的 $C_{ij}$ 矩阵严重偏离物理常识，请首先检查 `KPT` 采样密度和 `ecutwfc`（截断能）是否足够高。弹性常数对能量梯度极其敏感。
- **线性区间验证**：应变大小（Strain Magnitude）通常取 $\pm 0.005$ 到 $\pm 0.02$ 之间。若应变太小，数值噪声会淹没信号；若应变太大，则会脱离线性胡克定律区间。建议绘制应力-应变曲线观察线性度。
- **对称性破缺**：确保在施加形变后，计算过程中不要意外触发了过度的原子弛豫导致晶体对称性发生改变。

### 3. 参考资源
- **ABACUS 官方文档**：[https://abacus.deepmodeling.com/](https://abacus.deepmodeling.com/) 查阅最新的参数手册。
- **Gitee 算例库**：访问 `mcresearch/abacus-user-guide` 获取本教程对应的配套脚本与示例输入文件。
- **Materials Project 理论文档**：参考其关于 Elasticity 的方法论部分，了解工业界标准的计算协议。

科学探索永无止境，愿你能利用 ABACUS 这一利器，在材料设计的征途中发现更多可能！
